<!doctype html><html lang=en dir=ltr><head><meta property="og:title" content="三、Handler 原理分析"><meta property="og:description" content="看完这篇还不明白 Handler 你砍我 - 掘金
基本使用 #  Android 应用层通常使用 Handler 实现线程之间的消息通讯，Handler 是 Android 消息机制中非常重要的一员。以下分析通过剖析 Handler 的工作原理来深入了解 Android 应用开发过程中最常见也是最实用的消息收发机制。
在分析之前，先回顾一下 Handler 的使用方式：首先，最常用的是子线程往主线程发送消息：
Handler handler = new Handler() {  @Override  public void handleMessage(final Message msg) {  Log.e(&#34;gpj&#34;, &#34;Main thread handler received msg:&#34; + msg.what);  } };  //发送Message消息对象 Message message = handler.obtainMessage(); message.what = 0; message.obj = &#34;Hello&#34;; handler.sendMessage(message);  //发送Runnable对象 handler.post(new Runnable() {  @Override  public void run() {  Log."><meta property="og:type" content="article"><meta property="og:url" content="https://guanpj.github.io/amethyst/Knowledge/Android/Framework/%E4%B8%89Handler-%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/"><meta property="article:section" content="Knowledge"><meta property="og:site_name" content="guanpj's blog"><title>三、Handler 原理分析 | guanpj's blog</title><link rel=manifest href=/amethyst/manifest.json><link rel=icon href=/amethyst/favicon.png type=image/x-icon><link rel=stylesheet href=/amethyst/book.min.c27ff4755c78daab11627953d5a6dd7e2698690e086398032995aae74d6397b6.css integrity="sha256-wn/0dVx42qsRYnlT1abdfiaYaQ4IY5gDKZWq501jl7Y=" crossorigin=anonymous><meta charset=utf-8><meta name=description content="看完这篇还不明白 Handler 你砍我 - 掘金
基本使用 #  Android 应用层通常使用 Handler 实现线程之间的消息通讯，Handler 是 Android 消息机制中非常重要的一员。以下分析通过剖析 Handler 的工作原理来深入了解 Android 应用开发过程中最常见也是最实用的消息收发机制。
在分析之前，先回顾一下 Handler 的使用方式：首先，最常用的是子线程往主线程发送消息：
Handler handler = new Handler() {  @Override  public void handleMessage(final Message msg) {  Log.e(&#34;gpj&#34;, &#34;Main thread handler received msg:&#34; + msg.what);  } };  //发送Message消息对象 Message message = handler.obtainMessage(); message.what = 0; message.obj = &#34;Hello&#34;; handler.sendMessage(message);  //发送Runnable对象 handler.post(new Runnable() {  @Override  public void run() {  Log."><title>三、Handler 原理分析</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://guanpj.github.io/amethyst//favicon.png><link href=https://guanpj.github.io/amethyst/styles.e08ceb33360cec132feb69cfb982e2a4.min.css rel=stylesheet><link href=https://guanpj.github.io/amethyst/quartz/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://guanpj.github.io/amethyst/quartz/js/darkmode.1bc498b60ed24d8858f74f99e480db82.min.js></script>
<script src=https://guanpj.github.io/amethyst/quartz/js/util.c69e233dc1cc331a30b0f670e657b425.min.js></script>
<script async src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script async src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://guanpj.github.io/amethyst/quartz/js/popover.f03552ccb84d99ca615d1cfb9abde59e.min.js></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://guanpj.github.io/amethyst/",fetchData=Promise.all([fetch("https://guanpj.github.io/amethyst/indices/linkIndex.f13ba8f7c67305f3500d259bdfb72f53.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://guanpj.github.io/amethyst/indices/contentIndex.1a908c783dc71dfdcce2d7bedf40efc5.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addCollapsibleCallouts(),initPopover("https://guanpj.github.io/amethyst",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!0;drawGraph("https://guanpj.github.io/amethyst",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script>window.Million={navigate:e=>window.location.href=e,prefetch:()=>{}},window.addEventListener("DOMContentLoaded",()=>{init(),render()})</script></head><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><header class=book-header><label for=menu-control><img src=/amethyst/svg/menu.svg class=book-icon alt=Menu></label><h1 id=page-title><a href=https://guanpj.github.io/amethyst/>guanpj's blog</a></h1><div class=spacer></div><div id=search-icon class=quartz-search><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control><main class=flex><aside class=book-menu><div class=book-menu-content><nav><div class=menu-search><div id=search-icon class=quartz-search><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div></div><ul><li><span class=book-menu-title>Atlas</span><ul><li><a href=/amethyst/Atlas/About-Atlas/>About Atlas</a></li><li><a href=/amethyst/Atlas/Index-for-Atlases/>Index for Atlases</a></li></ul></li><li><span class=book-menu-title>Dashborads</span><ul><li><a href=/amethyst/Dashborad/Buttons/>Buttons</a></li><li><a href=/amethyst/Dashborad/ControlPanel/>Control Panel</a></li></ul></li><li><span class=book-menu-title>Excalidraws</span><ul><li><a href=/amethyst/Excalidraw/MyDraw/>My Draw</a></li></ul></li><li><span class=book-menu-title>Extras</span><ul><li><a href=/amethyst/Extras/Linter/>Linter</a></li><li><a href=/amethyst/Extras/Index-for-Extras/>Index for Extras</a></li></ul></li><li><span class=book-menu-title>Knowledges</span><ul><li><a href=/amethyst/Knowledge/Kotlin/%E5%A7%94%E6%89%98/>委托</a></li><li><a href=/amethyst/Knowledge/Kotlin/%E6%89%A9%E5%B1%95%E5%87%BD%E6%95%B0/>扩展函数</a></li><li><a href=/amethyst/Knowledge/Python/%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%96%87%E6%9C%AC%E6%9B%BF%E6%8D%A2/>文件读取、文本替换</a></li><li><a href=/amethyst/Knowledge/Python/%E7%B1%BB%E7%9A%84%E5%AE%9A%E4%B9%89%E4%BD%BF%E7%94%A8/>类的定义、使用</a></li><li><a href=/amethyst/Knowledge/Python/%E9%81%8D%E5%8E%86%E6%96%87%E4%BB%B6%E9%87%8D%E5%91%BD%E5%90%8D/>遍历文件、重命名</a></li><li><a href=/amethyst/Knowledge/%E7%AE%97%E6%B3%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E5%BC%95%E7%94%A8/>引用</a></li><li><a href=/amethyst/Knowledge/%E7%AE%97%E6%B3%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%8C%87%E9%92%88/>指针</a></li><li><a href=/amethyst/Knowledge/Android/Android-%E5%9F%BA%E7%A1%80/ADB-%E5%91%BD%E4%BB%A4/>ADB 命令</a></li><li><a href=/amethyst/Knowledge/Android/%E7%83%AD%E4%BF%AE%E5%A4%8D%E6%8F%92%E4%BB%B6%E5%8C%96/Java-%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/>ADB 命令</a></li><li><a href=/amethyst/Knowledge/Android/Android-%E5%9F%BA%E7%A1%80/Android-%E5%AF%B9%E5%AE%B9%E5%99%A8%E7%B1%BB%E7%9A%84%E4%BC%98%E5%8C%96/>Android 对容器类的优化</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/CAS-%E5%92%8C-AQS-%E5%8E%9F%E7%90%86/>CAS 和 AQS 原理</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/EventBus-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>EventBus 使用及源码解析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/Glide-%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E5%92%8C%E7%BC%93%E5%AD%98%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/>Glide 加载流程和缓存原理分析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/Glide-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/>Glide 基本使用</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/Glide-%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95/>Glide 高级用法</a></li><li><a href=/amethyst/Knowledge/Java/%E5%9F%BA%E7%A1%80/HashMap-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>HashMap 源码解析</a></li><li><a href=/amethyst/Knowledge/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9B%B8%E5%85%B3/HTTP-%E5%9F%BA%E7%A1%80/>HTTP 基础</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/Java-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/>Java 内存模型</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E4%B8%AD%E7%9A%84%E5%AF%B9%E8%B1%A1%E5%92%8C%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/>JVM 中的对象和垃圾回收</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F/>JVM 内存区域</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E5%AD%97%E8%8A%82%E7%A0%81%E6%8C%87%E4%BB%A4%E7%AE%80%E4%BB%8B/>JVM 字节码指令简介</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E5%AD%97%E8%8A%82%E7%A0%81%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/>JVM 字节码结构分析</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/>JVM 类加载机制</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/LeakCanary-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>LeakCanary 使用及源码解析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/OkHttp-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>OkHttp 使用及源码分析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/Retrofit-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>Retrofit 使用及源码分析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/RxJava-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>RxJava 使用及源码分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%B8%80Binder-%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90%E6%A6%82%E5%BF%B5%E7%AF%87/>一、Binder 机制分析——概念篇</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%B8%83View-%E4%BA%8B%E4%BB%B6%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/>七、View 事件机制分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%B8%89Handler-%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/ class=active>三、Handler 原理分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%BA%8CBinder-%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90%E5%BA%94%E7%94%A8%E7%AF%87/>二、Binder 机制分析——应用篇</a></li><li><a href=/amethyst/Knowledge/%E7%AE%97%E6%B3%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E4%BA%8C%E5%8F%89%E6%A0%91%E9%81%8D%E5%8E%86/>二叉树遍历</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%BA%94App-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/>五、App 启动流程分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E5%85%ADView-%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/>六、View 绘制流程分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E5%9B%9B%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/>四、系统启动流程分析</a></li><li><a href=/amethyst/Knowledge/Java/%E5%9F%BA%E7%A1%80/%E5%AE%B9%E5%99%A8%E7%B1%BB/>容器类</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/>并发容器</a></li><li><a href=/amethyst/Knowledge/Java/%E5%9F%BA%E7%A1%80/%E6%B3%9B%E5%9E%8B/>泛型</a></li><li><a href=/amethyst/Knowledge/Java/%E5%9F%BA%E7%A1%80/%E6%B3%A8%E8%A7%A3%E5%92%8C%E5%8F%8D%E5%B0%84/>注解和反射</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E7%AD%89%E5%BE%85-%E9%80%9A%E7%9F%A5%E6%9C%BA%E5%88%B6/>等待-通知机制</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E7%BA%BF%E7%A8%8B%E5%8D%8F%E4%BD%9C/>线程协作</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80/>线程基础</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%92%8C-BlockingQueue/>线程池和 BlockingQueue</a></li><li><a href=/amethyst/Knowledge/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9B%B8%E5%85%B3/%E7%BC%96%E7%A0%81%E5%8A%A0%E5%AF%86Hash%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%AD%97%E7%AC%A6%E9%9B%86/>编码、加密、Hash、序列化和字符集</a></li><li><a href=/amethyst/Knowledge/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9B%B8%E5%85%B3/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84TCPIP-%E5%92%8C-HTTPS/>计算机网络体系结构、TCP&IP 和 HTTPS</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E9%94%81/>锁</a></li></ul></li><li><span class=book-menu-title>Notes</span><ul><li><a href=/amethyst/Notes/2023-03-15/>2023 03 15</a></li><li><a href=/amethyst/Notes/2023-03-18/>2023 03 18</a></li><li><a href=/amethyst/Notes/2023-03-19/>2023 03 19</a></li><li><a href=/amethyst/Notes/2023-03-20/>2023 03 20</a></li><li><a href=/amethyst/Notes/2023-03-22/>Troubleshooting and FAQ</a></li></ul></li><li><span class=book-menu-title>Templates</span><ul><li><a href=/amethyst/Templates/%E5%85%B6%E4%BB%96%E6%A8%A1%E7%89%88/>其他模版</a></li></ul></li><li><span class=book-menu-title>Temps</span><ul><li><a href=/amethyst/Temp/MyIdeas/>MyIdeas</a></li></ul></li></ul><ul><li><a href=https://github.com/64bitpandas/amethyst target=_blank rel=noopener>Github</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class="book-page container"><article class=markdown><h1 class=title>三、Handler 原理分析</h1><p><a href=https://juejin.cn/post/6866015512192876557 rel=noopener>看完这篇还不明白 Handler 你砍我 - 掘金</a></p><h1 id=基本使用>基本使用
<a class=anchor href=#%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8>#</a></h1><p>Android 应用层通常使用 Handler 实现线程之间的消息通讯，Handler 是 Android 消息机制中非常重要的一员。以下分析通过剖析 Handler 的工作原理来深入了解 Android 应用开发过程中最常见也是最实用的消息收发机制。</p><p>在分析之前，先回顾一下 Handler 的使用方式：首先，最常用的是子线程往主线程发送消息：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Handler handler <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Handler<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handleMessage</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> Message msg<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Log<span style=color:#f92672>.</span><span style=color:#a6e22e>e</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;gpj&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Main thread handler received msg:&#34;</span> <span style=color:#f92672>+</span> msg<span style=color:#f92672>.</span><span style=color:#a6e22e>what</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//发送Message消息对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>Message message <span style=color:#f92672>=</span> handler<span style=color:#f92672>.</span><span style=color:#a6e22e>obtainMessage</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>message<span style=color:#f92672>.</span><span style=color:#a6e22e>what</span> <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>message<span style=color:#f92672>.</span><span style=color:#a6e22e>obj</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Hello&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>handler<span style=color:#f92672>.</span><span style=color:#a6e22e>sendMessage</span><span style=color:#f92672>(</span>message<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//发送Runnable对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>handler<span style=color:#f92672>.</span><span style=color:#a6e22e>post</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Runnable<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Log<span style=color:#f92672>.</span><span style=color:#a6e22e>e</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;gpj&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Runnable has been called&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Log输出<span style=color:#960050;background-color:#1e0010>：</span>
</span></span><span style=display:flex><span>Main thread handler received msg<span style=color:#f92672>:</span>0
</span></span><span style=display:flex><span>Runnable has been called
</span></span></code></pre></div><p>如果需要反过来在主线程中往某个子线程发送消息，可以使用如下方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>WorkThread</span> <span style=color:#66d9ef>extends</span> Thread <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Handler mHandler<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Looper mLooper<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Looper<span style=color:#f92672>.</span><span style=color:#a6e22e>prepare</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            mLooper <span style=color:#f92672>=</span> Looper<span style=color:#f92672>.</span><span style=color:#a6e22e>myLooper</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            Log<span style=color:#f92672>.</span><span style=color:#a6e22e>e</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;gpj&#34;</span><span style=color:#f92672>,</span> Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                 <span style=color:#e6db74>&#34;:Looper prepared&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//通知等待Looper的线程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            notifyAll<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Looper<span style=color:#f92672>.</span><span style=color:#a6e22e>loop</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Handler <span style=color:#a6e22e>getWorkHandler</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mHandler <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            mHandler <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Handler<span style=color:#f92672>(</span>getLooper<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handleMessage</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Message msg<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    Log<span style=color:#f92672>.</span><span style=color:#a6e22e>e</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;gpj&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;WorkThread received msg:&#34;</span> <span style=color:#f92672>+</span> msg<span style=color:#f92672>.</span><span style=color:#a6e22e>what</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> mHandler<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Looper <span style=color:#a6e22e>getLooper</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>isAlive<span style=color:#f92672>()</span> <span style=color:#f92672>&amp;&amp;</span> mLooper <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>//等待Looper
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    Log<span style=color:#f92672>.</span><span style=color:#a6e22e>e</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;gpj&#34;</span><span style=color:#f92672>,</span> Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> 
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;:Wait for looper&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    wait<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> mLooper<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//创建WorkThread线程并运行
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>WorkThread workThread <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> WorkThread<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>workThread<span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//获取WorkThread线程中的Handler
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>Handler handler <span style=color:#f92672>=</span> workThread<span style=color:#f92672>.</span><span style=color:#a6e22e>getWorkHandler</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//向WorkThread线程发送消息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>Message msg <span style=color:#f92672>=</span> handler<span style=color:#f92672>.</span><span style=color:#a6e22e>obtainMessage</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>what</span> <span style=color:#f92672>=</span> 1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>handler<span style=color:#f92672>.</span><span style=color:#a6e22e>sendMessage</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Log输出<span style=color:#960050;background-color:#1e0010>：</span>
</span></span><span style=display:flex><span>main:Wait <span style=color:#66d9ef>for</span> looper
</span></span><span style=display:flex><span>Thread<span style=color:#f92672>-</span>3<span style=color:#f92672>:</span>Looper prepared
</span></span><span style=display:flex><span>WorkThread received msg<span style=color:#f92672>:</span>1
</span></span></code></pre></div><p>需要注意的是，虽然 WorkThread 线程启动方法 start() 先执行，但是由于线程调度的原因，通过 getWorkHandler() 获取 WorkThread 中的 Handler 时，里面的 getLooper() 方法往往会被更早地执行，因此这里需要加入 wait/notifiy 操作，以确保 Looper 先被创建。</p><p>这里会涉及到 Looper、MessageQueue、Message、ThreadLocal 等概念，下面就围绕这几个概念深度分析 Handler 的工作原理。</p><h1 id=threadlocal-原理分析>ThreadLocal 原理分析
<a class=anchor href=#threadlocal-%e5%8e%9f%e7%90%86%e5%88%86%e6%9e%90>#</a></h1><h2 id=threadlocal-概念和使用方式>ThreadLocal 概念和使用方式
<a class=anchor href=#threadlocal-%e6%a6%82%e5%bf%b5%e5%92%8c%e4%bd%bf%e7%94%a8%e6%96%b9%e5%bc%8f>#</a></h2><p>ThreadLocal——顾名思义，即用于存储线程本地变量的类。通常情况下，普通变量是可以被任何一个线程访问的，而使用 ThreadLocal 创建的变量只能被当前线程访问，其它线程不能访问也不能够对它进行修改。</p><p>在实现上，每个使用 ThreadLocal 变量的线程都会初始化一个完全独立的实例副本，当一个线程结束时，它所使用的所有 ThreadLocal 相对的实例副本都可被回收。</p><p>总的来说，ThreadLocal 适用于每个线程需要自己独立的实例且该实例需要在多个方法中被使用，也即变量在线程间隔离而在方法或类间共享的场景。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    ThreadLocal<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> threadLocal <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ThreadLocal<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>    threadLocal<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;a&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Thread:&#34;</span> <span style=color:#f92672>+</span> Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> 
</span></span><span style=display:flex><span>        <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;:&#34;</span> <span style=color:#f92672>+</span> threadLocal<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>new</span> Thread<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Runnable<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            threadLocal<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;b&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Thread:&#34;</span> <span style=color:#f92672>+</span> Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;:&#34;</span> <span style=color:#f92672>+</span> threadLocal<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}).</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>new</span> Thread<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Runnable<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            threadLocal<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;c&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Thread:&#34;</span> <span style=color:#f92672>+</span> Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> 
</span></span><span style=display:flex><span>                <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;:&#34;</span> <span style=color:#f92672>+</span> threadLocal<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}).</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>sleep</span><span style=color:#f92672>(</span>1000<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=threadlocal-的-set-和-get-方法>ThreadLocal 的 set 和 get 方法
<a class=anchor href=#threadlocal-%e7%9a%84-set-%e5%92%8c-get-%e6%96%b9%e6%b3%95>#</a></h2><p>首先，查看它的 set 方法源码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Sets the current thread&#39;s copy of this thread-local variable
</span></span></span><span style=display:flex><span><span style=color:#75715e> * to the specified value.  Most subclasses will have no need to
</span></span></span><span style=display:flex><span><span style=color:#75715e> * override this method, relying solely on the {@link #initialValue}
</span></span></span><span style=display:flex><span><span style=color:#75715e> * method to set the values of thread-locals.
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param value the value to be stored in the current thread&#39;s copy of
</span></span></span><span style=display:flex><span><span style=color:#75715e> *        this thread-local.
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set</span><span style=color:#f92672>(</span>T value<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Thread t <span style=color:#f92672>=</span> Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    ThreadLocalMap map <span style=color:#f92672>=</span> getMap<span style=color:#f92672>(</span>t<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>map <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        map<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> value<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        createMap<span style=color:#f92672>(</span>t<span style=color:#f92672>,</span> value<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Set 方法可分为三个步骤：</p><ul><li>首先获取当前线程实例；</li><li>利用当前线程作为参数获取一个 ThreadLocalMap 的对象；</li><li>如果上述 ThreadLocalMap 对象不为空，则设置值，否则创建这个 ThreadLocalMap 对象并设置值。</li></ul><p>获取 ThreadLocalMap 的 getMap 方法如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Get the map associated with a ThreadLocal. Overridden in
</span></span></span><span style=display:flex><span><span style=color:#75715e> * InheritableThreadLocal.
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param  t the current thread
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return the map
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span>ThreadLocalMap <span style=color:#a6e22e>getMap</span><span style=color:#f92672>(</span>Thread t<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> t<span style=color:#f92672>.</span><span style=color:#a6e22e>threadLocals</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>threadLocals 是 Thread 类的一个成员变量：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>pulbic <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Thread</span> <span style=color:#66d9ef>implements</span> Runnable <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* ThreadLocal values pertaining to this thread. This map is maintained
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * by the ThreadLocal class. */</span>
</span></span><span style=display:flex><span>    ThreadLocal<span style=color:#f92672>.</span><span style=color:#a6e22e>ThreadLocalMap</span> threadLocals <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>前面的 set 方法中，如果 ThreadLocalMap 对象未创建，则新建 ThreadLocalMap 对象，并设置初始值。createMap 方法如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Create the map associated with a ThreadLocal. Overridden in
</span></span></span><span style=display:flex><span><span style=color:#75715e> * InheritableThreadLocal.
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param t the current thread
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param firstValue value for the initial entry of the map
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>createMap</span><span style=color:#f92672>(</span>Thread t<span style=color:#f92672>,</span> T firstValue<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    t<span style=color:#f92672>.</span><span style=color:#a6e22e>threadLocals</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ThreadLocalMap<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> firstValue<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>相应地，它的 get 方法就是获取当前线程的 ThreadLocalMap 对象，并根据 Key 获取对应的 Value：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Returns the value in the current thread&#39;s copy of this
</span></span></span><span style=display:flex><span><span style=color:#75715e> * thread-local variable.  If the variable has no value for the
</span></span></span><span style=display:flex><span><span style=color:#75715e> * current thread, it is first initialized to the value returned
</span></span></span><span style=display:flex><span><span style=color:#75715e> * by an invocation of the {@link #initialValue} method.
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return the current thread&#39;s value of this thread-local
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> T <span style=color:#a6e22e>get</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Thread t <span style=color:#f92672>=</span> Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    ThreadLocalMap map <span style=color:#f92672>=</span> getMap<span style=color:#f92672>(</span>t<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>map <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        ThreadLocalMap<span style=color:#f92672>.</span><span style=color:#a6e22e>Entry</span> e <span style=color:#f92672>=</span> map<span style=color:#f92672>.</span><span style=color:#a6e22e>getEntry</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>e <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;unchecked&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            T result <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>T<span style=color:#f92672>)</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> setInitialValue<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=关于内存泄漏>关于内存泄漏
<a class=anchor href=#%e5%85%b3%e4%ba%8e%e5%86%85%e5%ad%98%e6%b3%84%e6%bc%8f>#</a></h2><p>有人分析 ThreadLocal 将会导致内存泄漏，理由如下：</p><ul><li>首先 ThreadLocal 实例被线程的 ThreadLocalMap 实例持有，也可以看成被线程持有</li><li>如果应用使用了线程池，那么之前的线程实例处理完之后出于复用的目的依然存活</li><li>所以，ThreadLocal 设定的值被持有，会导致内存泄露</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * ThreadLocalMap is a customized hash map suitable only for
</span></span></span><span style=display:flex><span><span style=color:#75715e> * maintaining thread local values. No operations are exported
</span></span></span><span style=display:flex><span><span style=color:#75715e> * outside of the ThreadLocal class. The class is package private to
</span></span></span><span style=display:flex><span><span style=color:#75715e> * allow declaration of fields in class Thread.  To help deal with
</span></span></span><span style=display:flex><span><span style=color:#75715e> * very large and long-lived usages, the hash table entries use
</span></span></span><span style=display:flex><span><span style=color:#75715e> * WeakReferences for keys. However, since reference queues are not
</span></span></span><span style=display:flex><span><span style=color:#75715e> * used, stale entries are guaranteed to be removed only when
</span></span></span><span style=display:flex><span><span style=color:#75715e> * the table starts running out of space.
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ThreadLocalMap</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * The entries in this hash map extend WeakReference, using
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * its main ref field as the key (which is always a
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * ThreadLocal object).  Note that null keys (i.e. entry.get()
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * == null) mean that the key is no longer referenced, so the
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * entry can be expunged from table.  Such entries are referred to
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * as &#34;stale entries&#34; in the code that follows.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Entry</span> <span style=color:#66d9ef>extends</span> WeakReference<span style=color:#f92672>&lt;</span>ThreadLocal<span style=color:#f92672>&lt;?&gt;&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>/** The value associated with this ThreadLocal. */</span>
</span></span><span style=display:flex><span>        Object value<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Entry<span style=color:#f92672>(</span>ThreadLocal<span style=color:#f92672>&lt;?&gt;</span> k<span style=color:#f92672>,</span> Object v<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>k<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            value <span style=color:#f92672>=</span> v<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>ThreadLocalMap 的 Key 并不是直接使用 ThreadLocal 实例，而是 ThreadLocal 实例的弱引用。弱引用的特点是，如果这个对象只存在弱引用，那么在下一次垃圾回收的时候必然会被清理掉。</p><p>但是这里仅仅回收作为 Key 的 ThreadLocal 对象，Entry 对象和 Value 并没有回收，ThreadLocalMap 里就可能存在很多 Key 为 null 的 Entry。ThreadLocalMap 实现中已经考虑了这种情况，在调用 set()、get()、remove() 方法的时候，会清理掉 key 为 null 的记录。以 get 方法为例，源码如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> T <span style=color:#a6e22e>get</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Thread t <span style=color:#f92672>=</span> Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    ThreadLocalMap map <span style=color:#f92672>=</span> getMap<span style=color:#f92672>(</span>t<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>map <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        ThreadLocalMap<span style=color:#f92672>.</span><span style=color:#a6e22e>Entry</span> e <span style=color:#f92672>=</span> map<span style=color:#f92672>.</span><span style=color:#a6e22e>getEntry</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>e <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;unchecked&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            T result <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>T<span style=color:#f92672>)</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> setInitialValue<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> Entry <span style=color:#a6e22e>getEntry</span><span style=color:#f92672>(</span>ThreadLocal<span style=color:#f92672>&lt;?&gt;</span> key<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> key<span style=color:#f92672>.</span><span style=color:#a6e22e>threadLocalHashCode</span> <span style=color:#f92672>&amp;</span> <span style=color:#f92672>(</span>table<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> 1<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    Entry e <span style=color:#f92672>=</span> table<span style=color:#f92672>[</span>i<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>e <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> key<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//当前位置没有找到,可能Hash碰撞了
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> getEntryAfterMiss<span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> i<span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> Entry <span style=color:#a6e22e>getEntryAfterMiss</span><span style=color:#f92672>(</span>ThreadLocal<span style=color:#f92672>&lt;?&gt;</span> key<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> i<span style=color:#f92672>,</span> Entry e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Entry<span style=color:#f92672>[]</span> tab <span style=color:#f92672>=</span> table<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> len <span style=color:#f92672>=</span> tab<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>e <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        ThreadLocal<span style=color:#f92672>&lt;?&gt;</span> k <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>k <span style=color:#f92672>==</span> key<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//找到了直接返回
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>return</span> e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>k <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//检测到有个ThreadLocal对象被回收了,这个时候去清理后面所有Key为null的Entry
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            expungeStaleEntry<span style=color:#f92672>(</span>i<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>            i <span style=color:#f92672>=</span> nextIndex<span style=color:#f92672>(</span>i<span style=color:#f92672>,</span> len<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        e <span style=color:#f92672>=</span> tab<span style=color:#f92672>[</span>i<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>从源码中可以看到，ThreadLocalMap 清理掉 Key 为 null 的 Entry 的时机是根据 ThreadLocal 对象的 hashCode 去获取 Entry 时发生了 hash 碰撞的情况下，并且下一个 Entry 的 Key 为 null 的时候。因为 ThreadLocalMap 的 Entry 和普通 Map 的不太一样，一般的 Map 是一个链表数组，而它的数组每个元素就是一个 Entry，如果出现 Hash 碰撞了就放到数组的下一个位置，因此如果 get 的时候发现没有碰撞可以认为当前 Map 中的元素还不多，一旦检测到碰撞了并且下一个 Entry 的 Key 被回收了，就调用 expungeStaleEntry 方法来释放 ThreadLocal 为 null 的那些 Entry，进一步避免了内存泄露。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>expungeStaleEntry</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> staleSlot<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Entry<span style=color:#f92672>[]</span> tab <span style=color:#f92672>=</span> table<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> len <span style=color:#f92672>=</span> tab<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// expunge entry at staleSlot
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    tab<span style=color:#f92672>[</span>staleSlot<span style=color:#f92672>].</span><span style=color:#a6e22e>value</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    tab<span style=color:#f92672>[</span>staleSlot<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    size<span style=color:#f92672>--;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Rehash until we encounter null
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Entry e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> i<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>i <span style=color:#f92672>=</span> nextIndex<span style=color:#f92672>(</span>staleSlot<span style=color:#f92672>,</span> len<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>         <span style=color:#f92672>(</span>e <span style=color:#f92672>=</span> tab<span style=color:#f92672>[</span>i<span style=color:#f92672>])</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>         i <span style=color:#f92672>=</span> nextIndex<span style=color:#f92672>(</span>i<span style=color:#f92672>,</span> len<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        ThreadLocal<span style=color:#f92672>&lt;?&gt;</span> k <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>k <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//清理key为null的entry
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            e<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            tab<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            size<span style=color:#f92672>--;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> h <span style=color:#f92672>=</span> k<span style=color:#f92672>.</span><span style=color:#a6e22e>threadLocalHashCode</span> <span style=color:#f92672>&amp;</span> <span style=color:#f92672>(</span>len <span style=color:#f92672>-</span> 1<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//hashCode发生了变化,重新放置entry
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>h <span style=color:#f92672>!=</span> i<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                tab<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>tab<span style=color:#f92672>[</span>h<span style=color:#f92672>]</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                    h <span style=color:#f92672>=</span> nextIndex<span style=color:#f92672>(</span>h<span style=color:#f92672>,</span> len<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                tab<span style=color:#f92672>[</span>h<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> i<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>那只如果在出现了 key 为 null 的记录后，没有手动调用 remove() 方法，并且之后也不再调用 get()、set()、remove() 方法的情况下，还是有可能会出现内存泄漏的情况。因此，强烈建议回收自定义的 ThreadLocal 变量，尤其在线程池场景下，因为线程经常会被复用，如果不清理自定义的 ThreadLocal 变量，可能会影响后续业务逻辑和造成内存泄露等问题。 并且尽量在代理中使用 try-finally 块进行回收：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>objectThreadLocal<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span>userInfo<span style=color:#f92672>);</span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    objectThreadLocal<span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>();</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=strong使用场景strong><strong>使用场景</strong>
<a class=anchor href=#strong%e4%bd%bf%e7%94%a8%e5%9c%ba%e6%99%afstrong>#</a></h2><p>根据以上分析，ThreadLocal 适用于如下两种场景</p><ul><li>每个线程需要有自己单独的实例</li><li>实例需要在多个方法中共享，但不希望被多线程共享</li></ul><p>对于第一点，每个线程拥有自己实例，实现它的方式很多。例如可以在线程内部构建一个单独的实例。ThreadLocal 可以以非常方便的形式满足该需求。</p><p>对于第二点，可以在满足第一点（每个线程有自己的实例）的条件下，通过方法间引用传递的形式实现。ThreadLocal 使得代码耦合度更低，且实现更优雅。</p><h2 id=小结>小结
<a class=anchor href=#%e5%b0%8f%e7%bb%93>#</a></h2><p>ThreadLocal 可以保证每个线程拥有一个变量的副本，实现了线程隔离。在实现上，每个 Thread 类持有有一个 ThreadLocalMap 对象，ThreadLocalMap 保存了该线程拥有的所有 ThreadLocal 对象，并利用弱引用机制避免了 Map 无限增大并避免了内存泄露的问题。</p><h1 id=message>Message
<a class=anchor href=#message>#</a></h1><h2 id=消息对象>消息对象
<a class=anchor href=#%e6%b6%88%e6%81%af%e5%af%b9%e8%b1%a1>#</a></h2><p>Message 类是应用层消息的载体，是消息机制中的流通对象。它的结构如下：</p><h2 id=消息池>消息池
<a class=anchor href=#%e6%b6%88%e6%81%af%e6%b1%a0>#</a></h2><p>由于 Handler 消息机制在 framework 层和应用层充当了非常广泛的作用，这也意味着它的使用会非常频繁，因此对于 Message 的创建和回收的优化就显得非常必要。当消息池不为空时，可以直接从消息池中获取 Message 对象，而不是直接创建，提高效率。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> Message sPool<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> sPoolSize <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> MAX_POOL_SIZE <span style=color:#f92672>=</span> 50<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>boolean</span> gCheckRecycle <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span></code></pre></div><p>静态变量 sPool 的 Message，可以认为是消息池的头部，每个 Message 通过 next 成员变量引用下一个 Message 对象；sPoolSize 代表当前消息池的长度；静态变量 MAX_POOL_SIZE 代表消息池的可用大小；消息池的默认大小为 50。</p><h3 id=messageobtain>Message.obtain()
<a class=anchor href=#messageobtain>#</a></h3><p>静态方法 obtain() 可用来获取一个消息：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> Message <span style=color:#a6e22e>obtain</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span>sPoolSync<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>sPool <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Message m <span style=color:#f92672>=</span> sPool<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            sPool <span style=color:#f92672>=</span> m<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            m<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span> <span style=color:#75715e>//从sPool中取出一个Message对象，并消息链表断开
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            m<span style=color:#f92672>.</span><span style=color:#a6e22e>flags</span> <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> <span style=color:#75715e>// 清除in-use flag
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            sPoolSize<span style=color:#f92672>--;</span> <span style=color:#75715e>//消息池的可用大小进行减1操作
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>return</span> m<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Message<span style=color:#f92672>();</span> <span style=color:#75715e>// 当消息池为空时，直接创建Message对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>从消息池获取 Message 操作就是把消息池的头部 Message 取走，再将头部指向它的 next。</p><h3 id=recycler>recycler()
<a class=anchor href=#recycler>#</a></h3><p>通过 recycler() 方法可以把不再使用的消息加入消息池：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>recycle</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isInUse<span style=color:#f92672>())</span> <span style=color:#f92672>{</span> <span style=color:#75715e>//判断消息是否正在使用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>gCheckRecycle<span style=color:#f92672>)</span> <span style=color:#f92672>{</span> <span style=color:#75715e>//Android 5.0以后的版本默认为true,之前的版本默认为false.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;This message cannot be recycled because it is still in use.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    recycleUnchecked<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//对于不再使用的消息，加入到消息池
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>recycleUnchecked</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//将消息标示位置为IN_USE，并清空消息所有的参数。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    flags <span style=color:#f92672>=</span> FLAG_IN_USE<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    what <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    arg1 <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    arg2 <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    obj <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    replyTo <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    sendingUid <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    when <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    target <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    callback <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    data <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span>sPoolSync<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>sPoolSize <span style=color:#f92672>&lt;</span> MAX_POOL_SIZE<span style=color:#f92672>)</span> <span style=color:#f92672>{</span> <span style=color:#75715e>//当消息池没有满时，将Message对象加入消息池
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            next <span style=color:#f92672>=</span> sPool<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            sPool <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            sPoolSize<span style=color:#f92672>++;</span> <span style=color:#75715e>//消息池的可用大小进行加1操作
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>recycle() 操作将 Message 加入到消息池的过程，其实就是把 Message 加到消息池的头部。</p><h2 id=setasynchronousboolean-async>setAsynchronous(boolean async)
<a class=anchor href=#setasynchronousboolean-async>#</a></h2><p>设置消息类型为同步或者异步：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Sets whether the message is asynchronous, meaning that it is not
</span></span></span><span style=display:flex><span><span style=color:#75715e> * subject to {@link Looper} synchronization barriers.
</span></span></span><span style=display:flex><span><span style=color:#75715e> * &lt;p&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Certain operations, such as view invalidation, may introduce synchronization
</span></span></span><span style=display:flex><span><span style=color:#75715e> * barriers into the {@link Looper}&#39;s message queue to prevent subsequent messages
</span></span></span><span style=display:flex><span><span style=color:#75715e> * from being delivered until some condition is met.  In the case of view invalidation,
</span></span></span><span style=display:flex><span><span style=color:#75715e> * messages which are posted after a call to {@link android.view.View#invalidate}
</span></span></span><span style=display:flex><span><span style=color:#75715e> * are suspended by means of a synchronization barrier until the next frame is
</span></span></span><span style=display:flex><span><span style=color:#75715e> * ready to be drawn.  The synchronization barrier ensures that the invalidation
</span></span></span><span style=display:flex><span><span style=color:#75715e> * request is completely handled before resuming.
</span></span></span><span style=display:flex><span><span style=color:#75715e> * &lt;/p&gt;&lt;p&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Asynchronous messages are exempt from synchronization barriers.  They typically
</span></span></span><span style=display:flex><span><span style=color:#75715e> * represent interrupts, input events, and other signals that must be handled independently
</span></span></span><span style=display:flex><span><span style=color:#75715e> * even while other work has been suspended.
</span></span></span><span style=display:flex><span><span style=color:#75715e> * &lt;/p&gt;&lt;p&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Note that asynchronous messages may be delivered out of order with respect to
</span></span></span><span style=display:flex><span><span style=color:#75715e> * synchronous messages although they are always delivered in order among themselves.
</span></span></span><span style=display:flex><span><span style=color:#75715e> * If the relative order of these messages matters then they probably should not be
</span></span></span><span style=display:flex><span><span style=color:#75715e> * asynchronous in the first place.  Use with caution.
</span></span></span><span style=display:flex><span><span style=color:#75715e> * &lt;/p&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param async True if the message is asynchronous.
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @see #isAsynchronous()
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setAsynchronous</span><span style=color:#f92672>(</span><span style=color:#66d9ef>boolean</span> async<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>async<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        flags <span style=color:#f92672>|=</span> FLAG_ASYNCHRONOUS<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        flags <span style=color:#f92672>&amp;=</span> <span style=color:#f92672>~</span>FLAG_ASYNCHRONOUS<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h1 id=looper-工作原理分析>Looper 工作原理分析
<a class=anchor href=#looper-%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86%e5%88%86%e6%9e%90>#</a></h1><h2 id=looper-与-handler-的关联>Looper 与 Handler 的关联
<a class=anchor href=#looper-%e4%b8%8e-handler-%e7%9a%84%e5%85%b3%e8%81%94>#</a></h2><p>通常我们会通过以下构造方法创建 Handler 对象：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Deprecated</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Handler</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>(</span><span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Deprecated</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Handler</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@Nullable</span> Callback callback<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>(</span>callback<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Handler</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@Nullable</span> Callback callback<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> async<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>FIND_POTENTIAL_LEAKS<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> Class<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> Handler<span style=color:#f92672>&gt;</span> klass <span style=color:#f92672>=</span> getClass<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>klass<span style=color:#f92672>.</span><span style=color:#a6e22e>isAnonymousClass</span><span style=color:#f92672>()</span> <span style=color:#f92672>||</span> klass<span style=color:#f92672>.</span><span style=color:#a6e22e>isMemberClass</span><span style=color:#f92672>()</span> <span style=color:#f92672>||</span> klass<span style=color:#f92672>.</span><span style=color:#a6e22e>isLocalClass</span><span style=color:#f92672>())</span> <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>(</span>klass<span style=color:#f92672>.</span><span style=color:#a6e22e>getModifiers</span><span style=color:#f92672>()</span> <span style=color:#f92672>&amp;</span> Modifier<span style=color:#f92672>.</span><span style=color:#a6e22e>STATIC</span><span style=color:#f92672>)</span> <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Log<span style=color:#f92672>.</span><span style=color:#a6e22e>w</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;The following Handler class should be static or leaks might occur: &#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                klass<span style=color:#f92672>.</span><span style=color:#a6e22e>getCanonicalName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    mLooper <span style=color:#f92672>=</span> Looper<span style=color:#f92672>.</span><span style=color:#a6e22e>myLooper</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mLooper <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Can&#39;t create handler inside thread &#34;</span> <span style=color:#f92672>+</span> Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; that has not called Looper.prepare()&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    mQueue <span style=color:#f92672>=</span> mLooper<span style=color:#f92672>.</span><span style=color:#a6e22e>mQueue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    mCallback <span style=color:#f92672>=</span> callback<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    mAsynchronous <span style=color:#f92672>=</span> async<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Handler</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Looper looper<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>(</span>looper<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Handler</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Looper looper<span style=color:#f92672>,</span> <span style=color:#a6e22e>@Nullable</span> Callback callback<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>(</span>looper<span style=color:#f92672>,</span> callback<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@UnsupportedAppUsage</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Handler</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Looper looper<span style=color:#f92672>,</span> <span style=color:#a6e22e>@Nullable</span> Callback callback<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> async<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    mLooper <span style=color:#f92672>=</span> looper<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    mQueue <span style=color:#f92672>=</span> looper<span style=color:#f92672>.</span><span style=color:#a6e22e>mQueue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    mCallback <span style=color:#f92672>=</span> callback<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    mAsynchronous <span style=color:#f92672>=</span> async<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到，前面两个 Handler 已被标记为废弃，因为的创建必需依赖与 Looper，如果 Handler 被创建于没有 Looper 的线程中将会抛出异常，因此推荐使用后面两种构造方法。</p><p>在构造方法中，成员变量 mQueue 将被赋值为 Looper 中的 MessageQueue 示例；mCallback 则被赋值为调用者传入的对象；mAsynchronous 默认为 false（@UnsupportedAppUsage 标记的构造方法不能直接被外面调用）。</p><h2 id=looper-的创建与获取>Looper 的创建与获取
<a class=anchor href=#looper-%e7%9a%84%e5%88%9b%e5%bb%ba%e4%b8%8e%e8%8e%b7%e5%8f%96>#</a></h2><p>那么 Looper 怎么获取呢？如果要在主线程或者当前线程中接收消息，可以这样创建：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Handler handler <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Handler<span style=color:#f92672>(</span>Looper<span style=color:#f92672>.</span><span style=color:#a6e22e>getMainLooper</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handleMessage</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> Message msg<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Handler handler <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Handler<span style=color:#f92672>(</span>Looper<span style=color:#f92672>.</span><span style=color:#a6e22e>myLooper</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handleMessage</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> Message msg<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>};</span>
</span></span></code></pre></div><p>当然，也可以像本文开头部分示例的方式一样，传入一个在其它线程中创建的 Looper，表示该 Handler 将在对应的线程中处理消息。那么如何为一个线程创建 Looper 呢？只需要调用 Looper.prepare() 方法即可：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>WorkThread</span> <span style=color:#66d9ef>extends</span> Thread <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Handler mHandler<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Looper<span style=color:#f92672>.</span><span style=color:#a6e22e>prepare</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        mHandler <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Handler<span style=color:#f92672>(</span>Looper<span style=color:#f92672>.</span><span style=color:#a6e22e>myLooper</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Looper<span style=color:#f92672>.</span><span style=color:#a6e22e>loop</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>prepare() 是 Looper 类的一个静态方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>prepare</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    prepare<span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>prepare</span><span style=color:#f92672>(</span><span style=color:#66d9ef>boolean</span> quitAllowed<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>sThreadLocal<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Only one Looper may be created per thread&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    sThreadLocal<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Looper<span style=color:#f92672>(</span>quitAllowed<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#a6e22e>Looper</span><span style=color:#f92672>(</span><span style=color:#66d9ef>boolean</span> quitAllowed<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    mQueue <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> MessageQueue<span style=color:#f92672>(</span>quitAllowed<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    mThread <span style=color:#f92672>=</span> Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到，这里的 Looper 来自于 ThreadLocal 中，并且每个线程最多只能拥有一个 Looper 对象。结合前面的分析可知，这个 Looper 对象只属于当前线程。在创建 Looper 的同时，mQueue 也将被初始化，quitAllowed 表示是否可以退出，意味着每个线程也最多拥有一个 MessageQueue。</p><h2 id=looperloop>Looper.loop()
<a class=anchor href=#looperloop>#</a></h2><p>接着看 Looper 的 loop() 方法，提取关键部分后的代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>loop</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> Looper me <span style=color:#f92672>=</span> myLooper<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>me <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;No Looper; Looper.prepare() wasn&#39;t called on this thread.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> MessageQueue queue <span style=color:#f92672>=</span> me<span style=color:#f92672>.</span><span style=color:#a6e22e>mQueue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(;;)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 不断获取Message消息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Message msg <span style=color:#f92672>=</span> queue<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>();</span> <span style=color:#75715e>// might block
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>msg <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// No message indicates that the message queue is quitting.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            msg<span style=color:#f92672>.</span><span style=color:#a6e22e>target</span><span style=color:#f92672>.</span><span style=color:#a6e22e>dispatchMessage</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        msg<span style=color:#f92672>.</span><span style=color:#a6e22e>recycleUnchecked</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到，loop() 方法是一个死循环，这个死循环唯一的退出途径就是 queue.next() 方法返回 null 的时候。循环里面会不断调用 MessageQueue.next() 方法来获取 Message 对象，next() 方法在没有返回 Message 时方法将被阻塞。Looper 处理 Message 的方式是调用它的 target 对象的 dispatchMessage 方法，并把 Message 对象作为参数传进去。</p><h2 id=messagequeue-原理分析>MessageQueue 原理分析
<a class=anchor href=#messagequeue-%e5%8e%9f%e7%90%86%e5%88%86%e6%9e%90>#</a></h2><p>MessageQueue 字面意义为消息队列，但其实它的结构是一个单向链表。它的 next() 和 enqueueMessage() 方法分别对应该链表的获取和添加元素操作。为了方便理解，下面仍然称之为消息队列。</p><h3 id=messagequeue-的创建>MessageQueue 的创建
<a class=anchor href=#messagequeue-%e7%9a%84%e5%88%9b%e5%bb%ba>#</a></h3><p>MessageQueue 只有一个构造方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>long</span> mPtr<span style=color:#f92672>;</span> <span style=color:#75715e>// used by native code
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>MessageQueue<span style=color:#f92672>(</span><span style=color:#66d9ef>boolean</span> quitAllowed<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    mQuitAllowed <span style=color:#f92672>=</span> quitAllowed<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 初始化消息队列，mPtr是供native代码调用的一个变量    
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    mPtr <span style=color:#f92672>=</span> nativeInit<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=next-方法分析>next() 方法分析
<a class=anchor href=#next-%e6%96%b9%e6%b3%95%e5%88%86%e6%9e%90>#</a></h3><p>MessageQueue 的 next() 方法如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@UnsupportedAppUsage</span>
</span></span><span style=display:flex><span>Message <span style=color:#a6e22e>next</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Return here if the message loop has already quit and been disposed.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// This can happen if the application tries to restart a looper after quit
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// which is not supported.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> ptr <span style=color:#f92672>=</span> mPtr<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>ptr <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span><span style=color:#75715e>//表示当MessageQueue已经退出，则直接返回
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> pendingIdleHandlerCount <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>;</span> <span style=color:#75715e>// -1 only during first iteration
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> nextPollTimeoutMillis <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(;;)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>nextPollTimeoutMillis <span style=color:#f92672>!=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Binder<span style=color:#f92672>.</span><span style=color:#a6e22e>flushPendingCommands</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//阻塞操作，等待时长nextPollTimeoutMillis后，或者消息队列被唤醒，都会返回
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        nativePollOnce<span style=color:#f92672>(</span>ptr<span style=color:#f92672>,</span> nextPollTimeoutMillis<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Try to retrieve the next message.  Return if found.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> now <span style=color:#f92672>=</span> SystemClock<span style=color:#f92672>.</span><span style=color:#a6e22e>uptimeMillis</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            Message prevMsg <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            Message msg <span style=color:#f92672>=</span> mMessages<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>msg <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> msg<span style=color:#f92672>.</span><span style=color:#a6e22e>target</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 碰到同步屏障，则跳过同步消息，只取出异步消息，并且不会移除屏障
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>do</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    prevMsg <span style=color:#f92672>=</span> msg<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    msg <span style=color:#f92672>=</span> msg<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span> <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>msg <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>isAsynchronous</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>msg <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>now <span style=color:#f92672>&lt;</span> msg<span style=color:#f92672>.</span><span style=color:#a6e22e>when</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 当前Message的触发事件在当前时间时间之后，则继续等待
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    nextPollTimeoutMillis <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span><span style=color:#f92672>)</span> Math<span style=color:#f92672>.</span><span style=color:#a6e22e>min</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>when</span> <span style=color:#f92672>-</span> now<span style=color:#f92672>,</span> Integer<span style=color:#f92672>.</span><span style=color:#a6e22e>MAX_VALUE</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 将目标Message对象从队列中移除，并返回
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    mBlocked <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>prevMsg <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        prevMsg<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span> <span style=color:#f92672>=</span> msg<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        mMessages <span style=color:#f92672>=</span> msg<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    msg<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>DEBUG<span style=color:#f92672>)</span> Log<span style=color:#f92672>.</span><span style=color:#a6e22e>v</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Returning message: &#34;</span> <span style=color:#f92672>+</span> msg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 设置消息的使用状态：flags |= FLAG_IN_USE
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    msg<span style=color:#f92672>.</span><span style=color:#a6e22e>markInUse</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> msg<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// No more messages.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                nextPollTimeoutMillis <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Process the quit message now that all pending messages have been handled.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mQuitting<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                dispose<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// If first time idle, then get the number of idlers to run.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// Idle handles only run if the queue is empty or if the first message
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// in the queue (possibly a barrier) is due to be handled in the future.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>pendingIdleHandlerCount <span style=color:#f92672>&lt;</span> 0
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>(</span>mMessages <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> now <span style=color:#f92672>&lt;</span> mMessages<span style=color:#f92672>.</span><span style=color:#a6e22e>when</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                pendingIdleHandlerCount <span style=color:#f92672>=</span> mIdleHandlers<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>pendingIdleHandlerCount <span style=color:#f92672>&lt;=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// No idle handlers to run.  Loop and wait some more.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                mBlocked <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mPendingIdleHandlers <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                mPendingIdleHandlers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> IdleHandler<span style=color:#f92672>[</span>Math<span style=color:#f92672>.</span><span style=color:#a6e22e>max</span><span style=color:#f92672>(</span>pendingIdleHandlerCount<span style=color:#f92672>,</span> 4<span style=color:#f92672>)];</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            mPendingIdleHandlers <span style=color:#f92672>=</span> mIdleHandlers<span style=color:#f92672>.</span><span style=color:#a6e22e>toArray</span><span style=color:#f92672>(</span>mPendingIdleHandlers<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Run the idle handlers.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// We only ever reach this code block during the first iteration.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> pendingIdleHandlerCount<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>final</span> IdleHandler idler <span style=color:#f92672>=</span> mPendingIdleHandlers<span style=color:#f92672>[</span>i<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>            mPendingIdleHandlers<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span> <span style=color:#75715e>// release the reference to the handler
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>boolean</span> keep <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                keep <span style=color:#f92672>=</span> idler<span style=color:#f92672>.</span><span style=color:#a6e22e>queueIdle</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Throwable t<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                Log<span style=color:#f92672>.</span><span style=color:#a6e22e>wtf</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;IdleHandler threw exception&#34;</span><span style=color:#f92672>,</span> t<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>keep<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    mIdleHandlers<span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>(</span>idler<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Reset the idle handler count to 0 so we do not run them again.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        pendingIdleHandlerCount <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// While calling an idle handler, a new message could have been delivered
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// so go back and look again for a pending message without waiting.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        nextPollTimeoutMillis <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这里也同样创建了一个死循环，nativePollOnce() 方法在 JNI 层会调用到内核中的 epoll_wait() 方法，这是阻塞方法（阻塞时线程休眠，释放 CPU 资源），用于等待事件发生或者超时，当被事件到来或者等待 nextPollTimeoutMillis（时间） 后会被唤醒。因此，这里的 <code>for(;;)</code> 并不会造成无限循环。</p><blockquote><p>当 nextPollTimeoutMillis = -1 时，表示消息队列中无消息，会一直等待；当 nextPollTimeoutMillis = 0 时会直接返回。</p></blockquote><p>msg.target == null 表示队列头部的消息是一个同步屏障，此时只会处理异步消息，直到同步屏障被移除。文章后面会补充更详细的关于同步屏障的理解。</p><p>这里后半部分代码中，当处于空闲时，往往会执行 IdleHandler 中的方法。当 nativePollOnce() 返回后， next() 从 mMessages 中提取一个消息。</p><h3 id=enqueuemessage-方法分析>enqueueMessage() 方法分析
<a class=anchor href=#enqueuemessage-%e6%96%b9%e6%b3%95%e5%88%86%e6%9e%90>#</a></h3><p>再来看 enqueueMessage() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>enqueueMessage</span><span style=color:#f92672>(</span>Message msg<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> when<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 普通Message必须设置target
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>target</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Message must have a target.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 如果Message具有FLAG_IN_USE标记，则不允许再使用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>isInUse</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span>msg <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; This message is already in use.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// MessageQueue正在退出时，需要回收该Message并加入到消息池，返回false
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mQuitting<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            IllegalStateException e <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                    msg<span style=color:#f92672>.</span><span style=color:#a6e22e>target</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; sending message to a Handler on a dead thread&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            Log<span style=color:#f92672>.</span><span style=color:#a6e22e>w</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessage</span><span style=color:#f92672>(),</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            msg<span style=color:#f92672>.</span><span style=color:#a6e22e>recycle</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        msg<span style=color:#f92672>.</span><span style=color:#a6e22e>markInUse</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        msg<span style=color:#f92672>.</span><span style=color:#a6e22e>when</span> <span style=color:#f92672>=</span> when<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        Message p <span style=color:#f92672>=</span> mMessages<span style=color:#f92672>;</span><span style=color:#75715e>// 头节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>boolean</span> needWake<span style=color:#f92672>;</span> <span style=color:#75715e>// 需要唤醒MessageQueue
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>p <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> when <span style=color:#f92672>==</span> 0 <span style=color:#f92672>||</span> when <span style=color:#f92672>&lt;</span> p<span style=color:#f92672>.</span><span style=color:#a6e22e>when</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// p <mark> null表示MessageQueue为空；when </mark> 0表示msg为插队消息；
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// when &lt; p.when表示该消息触发时间是最早的（mMessages为链表头结点）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// 这三种情况都把msg加入到队列头部
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            msg<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span> <span style=color:#f92672>=</span> p<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            mMessages <span style=color:#f92672>=</span> msg<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            needWake <span style=color:#f92672>=</span> mBlocked<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 将消息按时间顺序插入到MessageQueue。一般不需要唤醒MessageQueue，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// 除非最头部存在barrier，并且同时Message是队列中最早的异步消息。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            needWake <span style=color:#f92672>=</span> mBlocked <span style=color:#f92672>&amp;&amp;</span> p<span style=color:#f92672>.</span><span style=color:#a6e22e>target</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> msg<span style=color:#f92672>.</span><span style=color:#a6e22e>isAsynchronous</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            Message prev<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 遍历队列，对比when，找到合适的位置并插入
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>for</span> <span style=color:#f92672>(;;)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                prev <span style=color:#f92672>=</span> p<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                p <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 如果到达队尾或者when在当前结点之前，表示找到插入位置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>p <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> when <span style=color:#f92672>&lt;</span> p<span style=color:#f92672>.</span><span style=color:#a6e22e>when</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 当前结点也是异步消息，则不需要唤醒了
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>needWake <span style=color:#f92672>&amp;&amp;</span> p<span style=color:#f92672>.</span><span style=color:#a6e22e>isAsynchronous</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    needWake <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//插入链表
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            msg<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span> <span style=color:#f92672>=</span> p<span style=color:#f92672>;</span> <span style=color:#75715e>// invariant: p == prev.next
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            prev<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span> <span style=color:#f92672>=</span> msg<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// We can assume mPtr != 0 because mQuitting is false.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>needWake<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            nativeWake<span style=color:#f92672>(</span>mPtr<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>根据以上分析可知，MessageQueue 是按照 Message 触发时间的先后顺序排列的，队列头部的消息是将要最早触发的消息。当有消息需要加入消息队列时，会从队列头部开始遍历，直到找到消息应该插入的合适位置，以保证所有消息的时间顺序。</p><p>消息插入一般不需要唤醒 MessageQueue，但是在 MessageQueue 当前处于阻塞状态的大前提下，消息的插入位置为 MessageQueue 头部，或者最头部存在同步障碍时 Message 是队列中最早的异步消息，意味着当前消息需要马上处理，插入后就需要唤醒阻塞中的 MessageQueue。</p><p>当需要唤醒时，通过 nativeWake() 方法在 JNI 层会最终调用到内核中的调用 Looper::wake() 方法向管道 mWakeEventfd 写入字符，此时会唤醒 MessageQueue.next() 方法 nativePollOnce() 处的代码继续向下执行。</p><h3 id=removemessage-方法分析>removeMessage() 方法分析
<a class=anchor href=#removemessage-%e6%96%b9%e6%b3%95%e5%88%86%e6%9e%90>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>removeMessages</span><span style=color:#f92672>(</span>Handler h<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> what<span style=color:#f92672>,</span> Object object<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>h <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Message p <span style=color:#f92672>=</span> mMessages<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Remove all messages at front.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>p <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> p<span style=color:#f92672>.</span><span style=color:#a6e22e>target</span> <span style=color:#f92672>==</span> h <span style=color:#f92672>&amp;&amp;</span> p<span style=color:#f92672>.</span><span style=color:#a6e22e>what</span> <span style=color:#f92672>==</span> what
</span></span><span style=display:flex><span>               <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>(</span>object <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> p<span style=color:#f92672>.</span><span style=color:#a6e22e>obj</span> <span style=color:#f92672>==</span> object<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Message n <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            mMessages <span style=color:#f92672>=</span> n<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            p<span style=color:#f92672>.</span><span style=color:#a6e22e>recycleUnchecked</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            p <span style=color:#f92672>=</span> n<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Remove all messages after front.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>p <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Message n <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>n <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>n<span style=color:#f92672>.</span><span style=color:#a6e22e>target</span> <span style=color:#f92672>==</span> h <span style=color:#f92672>&amp;&amp;</span> n<span style=color:#f92672>.</span><span style=color:#a6e22e>what</span> <span style=color:#f92672>==</span> what
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>(</span>object <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> n<span style=color:#f92672>.</span><span style=color:#a6e22e>obj</span> <span style=color:#f92672>==</span> object<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    Message nn <span style=color:#f92672>=</span> n<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    n<span style=color:#f92672>.</span><span style=color:#a6e22e>recycleUnchecked</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    p<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span> <span style=color:#f92672>=</span> nn<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>continue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            p <span style=color:#f92672>=</span> n<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这个移除消息的方法，采用了两个 while 循环，第一个循环是从队头开始，移除符合条件的消息，第二个循环是从头部移除完连续的满足条件的消息之后，再从队列后面继续查询是否有满足条件的消息需要被移除。</p><h3 id=同步屏障-syncbarrier同步消息和异步消息>同步屏障 SyncBarrier、同步消息和异步消息
<a class=anchor href=#%e5%90%8c%e6%ad%a5%e5%b1%8f%e9%9a%9c-syncbarrier%e5%90%8c%e6%ad%a5%e6%b6%88%e6%81%af%e5%92%8c%e5%bc%82%e6%ad%a5%e6%b6%88%e6%81%af>#</a></h3><p>默认情况下，我们向某个 Handler 发送的消息默认都是异步消息。试想一下，如果某些时候想要让消息快速地发送到指定线程，但是如果该线程的 MessageQueue 中积累了大量未处理消息，则达不到预期的效果。</p><p>因此 Handler 体系提供了一套同步屏障机制，通过区分同步消息和异步消息，让某些特殊的消息得以更快被执行的机制。这也从前面 next() 方法分析中得到验证。</p><p>那么如何设置和取消一个同步屏障呢？方法就是调用它的 postSyncBarrier() 和 removeSyncBarrier () 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@UnsupportedAppUsage</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@TestApi</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>postSyncBarrier</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> postSyncBarrier<span style=color:#f92672>(</span>SystemClock<span style=color:#f92672>.</span><span style=color:#a6e22e>uptimeMillis</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>postSyncBarrier</span><span style=color:#f92672>(</span><span style=color:#66d9ef>long</span> when<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Enqueue a new sync barrier token.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// We don&#39;t need to wake the queue because the purpose of a barrier is to stall it.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> token <span style=color:#f92672>=</span> mNextBarrierToken<span style=color:#f92672>++;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> Message msg <span style=color:#f92672>=</span> Message<span style=color:#f92672>.</span><span style=color:#a6e22e>obtain</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        msg<span style=color:#f92672>.</span><span style=color:#a6e22e>markInUse</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        msg<span style=color:#f92672>.</span><span style=color:#a6e22e>when</span> <span style=color:#f92672>=</span> when<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        msg<span style=color:#f92672>.</span><span style=color:#a6e22e>arg1</span> <span style=color:#f92672>=</span> token<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Message prev <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        Message p <span style=color:#f92672>=</span> mMessages<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>when <span style=color:#f92672>!=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>p <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> p<span style=color:#f92672>.</span><span style=color:#a6e22e>when</span> <span style=color:#f92672>&lt;=</span> when<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                prev <span style=color:#f92672>=</span> p<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                p <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>prev <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span> <span style=color:#75715e>// invariant: p == prev.next
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            msg<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span> <span style=color:#f92672>=</span> p<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            prev<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span> <span style=color:#f92672>=</span> msg<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            msg<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span> <span style=color:#f92672>=</span> p<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            mMessages <span style=color:#f92672>=</span> msg<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> token<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>removeSyncBarrier</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> token<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Remove a sync barrier token from the queue.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// If the queue is no longer stalled by a barrier then wake it.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Message prev <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        Message p <span style=color:#f92672>=</span> mMessages<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>p <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>(</span>p<span style=color:#f92672>.</span><span style=color:#a6e22e>target</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> p<span style=color:#f92672>.</span><span style=color:#a6e22e>arg1</span> <span style=color:#f92672>!=</span> token<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            prev <span style=color:#f92672>=</span> p<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            p <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>p <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;The specified message queue synchronization &#34;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; barrier token has not been posted or has already been removed.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> needWake<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>prev <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            prev<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span> <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            needWake <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            mMessages <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            needWake <span style=color:#f92672>=</span> mMessages <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> mMessages<span style=color:#f92672>.</span><span style=color:#a6e22e>target</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        p<span style=color:#f92672>.</span><span style=color:#a6e22e>recycleUnchecked</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// If the loop is quitting then it is already awake.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// We can assume mPtr != 0 when mQuitting is false.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>needWake <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>mQuitting<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            nativeWake<span style=color:#f92672>(</span>mPtr<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>前面提到过，普通 Message 必须设置一个 target，对于特殊的 Message 是没有 target 的。 这个消息的价值就是用于拦截同步消息，所以并不会唤醒 Looper。</p><p>postSyncBarrier 方法会返回一个 int 类型的 token，调用 removeSyncBarrier 并传入这个 token 则可以移除同步屏障。</p><p>这两个方法都被标记了 @UnsupportedAppUsage 注解，因此普通开发者无法直接调用。那么它在什么时候会被调用呢？Android 应用框架中为了更快的响应 UI 刷新事件，在 ViewRootImpl.scheduleTraversals 中使用了同步屏障：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>scheduleTraversals</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>mTraversalScheduled<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        mTraversalScheduled <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 设置同步障碍，暂停处理后面的同步消息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        mTraversalBarrier <span style=color:#f92672>=</span> mHandler<span style=color:#f92672>.</span><span style=color:#a6e22e>getLooper</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getQueue</span><span style=color:#f92672>().</span><span style=color:#a6e22e>postSyncBarrier</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 在下一帧到来的时候执行 mTraversalRunnable
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        mChoreographer<span style=color:#f92672>.</span><span style=color:#a6e22e>postCallback</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                Choreographer<span style=color:#f92672>.</span><span style=color:#a6e22e>CALLBACK_TRAVERSAL</span><span style=color:#f92672>,</span> mTraversalRunnable<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>final</span> TraversalRunnable mTraversalRunnable <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TraversalRunnable<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TraversalRunnable</span> <span style=color:#66d9ef>implements</span> Runnable <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        doTraversal<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>doTraversal</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mTraversalScheduled<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        mTraversalScheduled <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 移除同步障碍
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        mHandler<span style=color:#f92672>.</span><span style=color:#a6e22e>getLooper</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getQueue</span><span style=color:#f92672>().</span><span style=color:#a6e22e>removeSyncBarrier</span><span style=color:#f92672>(</span>mTraversalBarrier<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 正式进入 View 绘制流程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        performTraversals<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>         <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>postCallback 方法跟踪：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@UnsupportedAppUsage</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@TestApi</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>postCallback</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> callbackType<span style=color:#f92672>,</span> Runnable action<span style=color:#f92672>,</span> Object token<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    postCallbackDelayed<span style=color:#f92672>(</span>callbackType<span style=color:#f92672>,</span> action<span style=color:#f92672>,</span> token<span style=color:#f92672>,</span> 0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@UnsupportedAppUsage</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@TestApi</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>postCallbackDelayed</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> callbackType<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        Runnable action<span style=color:#f92672>,</span> Object token<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> delayMillis<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>action <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;action must not be null&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>callbackType <span style=color:#f92672>&lt;</span> 0 <span style=color:#f92672>||</span> callbackType <span style=color:#f92672>&gt;</span> CALLBACK_LAST<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;callbackType is invalid&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    postCallbackDelayedInternal<span style=color:#f92672>(</span>callbackType<span style=color:#f92672>,</span> action<span style=color:#f92672>,</span> token<span style=color:#f92672>,</span> delayMillis<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>postCallbackDelayedInternal</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> callbackType<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        Object action<span style=color:#f92672>,</span> Object token<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> delayMillis<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>DEBUG_FRAMES<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Log<span style=color:#f92672>.</span><span style=color:#a6e22e>d</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;PostCallback: type=&#34;</span> <span style=color:#f92672>+</span> callbackType
</span></span><span style=display:flex><span>                <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;, action=&#34;</span> <span style=color:#f92672>+</span> action <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;, token=&#34;</span> <span style=color:#f92672>+</span> token
</span></span><span style=display:flex><span>                <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;, delayMillis=&#34;</span> <span style=color:#f92672>+</span> delayMillis<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span>mLock<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> now <span style=color:#f92672>=</span> SystemClock<span style=color:#f92672>.</span><span style=color:#a6e22e>uptimeMillis</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> dueTime <span style=color:#f92672>=</span> now <span style=color:#f92672>+</span> delayMillis<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        mCallbackQueues<span style=color:#f92672>[</span>callbackType<span style=color:#f92672>].</span><span style=color:#a6e22e>addCallbackLocked</span><span style=color:#f92672>(</span>dueTime<span style=color:#f92672>,</span> action<span style=color:#f92672>,</span> token<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>dueTime <span style=color:#f92672>&lt;=</span> now<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            scheduleFrameLocked<span style=color:#f92672>(</span>now<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Message msg <span style=color:#f92672>=</span> mHandler<span style=color:#f92672>.</span><span style=color:#a6e22e>obtainMessage</span><span style=color:#f92672>(</span>MSG_DO_SCHEDULE_CALLBACK<span style=color:#f92672>,</span> action<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            msg<span style=color:#f92672>.</span><span style=color:#a6e22e>arg1</span> <span style=color:#f92672>=</span> callbackType<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 将消息类型设置为异步
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            msg<span style=color:#f92672>.</span><span style=color:#a6e22e>setAsynchronous</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            mHandler<span style=color:#f92672>.</span><span style=color:#a6e22e>sendMessageAtTime</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>,</span> dueTime<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到，最后通过 setAsynchronous() 方法可以将消息设置成异步消息。</p><p>通过设置同步障碍，并且发送异步消息，就可以确保 mTraversalRunnable 优先被执行，mTraversalRunnable 最终会调用 performTraversals 方法触发 View 树的 measure、layout 和 draw 等操作，因此使用同步屏障可以防止 UI 显示出现卡顿。</p><p>这里也可以看到，调用 performTraversals 方法之前会将同步障碍移除掉。</p><p>综合以上分析可知，同步消息必须配合同步障碍才能达到屏蔽异步消息的作用，也就是说，如果没有设置同步屏障，同步消息与异步消息在 Handler 体系中没有任何区别。</p><h1 id=handler-发送和接收消息>Handler 发送和接收消息
<a class=anchor href=#handler-%e5%8f%91%e9%80%81%e5%92%8c%e6%8e%a5%e6%94%b6%e6%b6%88%e6%81%af>#</a></h1><p>前面的分析中，Looper 在 loop() 方法中获取到每一个 Message 对象后，会调用它的 target 对象的 dispatchMessage() 方法，并把 Message 本身作为参数传入。那么 这个 target 对象又是何方神圣？</p><h2 id=发送-message>发送 Message
<a class=anchor href=#%e5%8f%91%e9%80%81-message>#</a></h2><p>再来看 Handler 发送消息的过程：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Message message <span style=color:#f92672>=</span> handler<span style=color:#f92672>.</span><span style=color:#a6e22e>obtainMessage</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>message<span style=color:#f92672>.</span><span style=color:#a6e22e>what</span> <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>message<span style=color:#f92672>.</span><span style=color:#a6e22e>obj</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Hello&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>handler<span style=color:#f92672>.</span><span style=color:#a6e22e>sendMessage</span><span style=color:#f92672>(</span>message<span style=color:#f92672>);</span>
</span></span></code></pre></div><p>这里会将包装好的 Message 对象传入 sendMessage 方法中：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>sendMessage</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Message msg<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> sendMessageDelayed<span style=color:#f92672>(</span>msg<span style=color:#f92672>,</span> 0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>sendMessageDelayed</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Message msg<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> delayMillis<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>delayMillis <span style=color:#f92672>&lt;</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        delayMillis <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> sendMessageAtTime<span style=color:#f92672>(</span>msg<span style=color:#f92672>,</span> SystemClock<span style=color:#f92672>.</span><span style=color:#a6e22e>uptimeMillis</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> delayMillis<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>sendMessageAtTime</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Message msg<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> uptimeMillis<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    MessageQueue queue <span style=color:#f92672>=</span> mQueue<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>queue <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        RuntimeException e <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; sendMessageAtTime() called with no mQueue&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        Log<span style=color:#f92672>.</span><span style=color:#a6e22e>w</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Looper&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessage</span><span style=color:#f92672>(),</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> enqueueMessage<span style=color:#f92672>(</span>queue<span style=color:#f92672>,</span> msg<span style=color:#f92672>,</span> uptimeMillis<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>sendEmptyMessage</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> what<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> sendEmptyMessageDelayed<span style=color:#f92672>(</span>what<span style=color:#f92672>,</span> 0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>sendEmptyMessageDelayed</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> what<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> delayMillis<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Message msg <span style=color:#f92672>=</span> Message<span style=color:#f92672>.</span><span style=color:#a6e22e>obtain</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    msg<span style=color:#f92672>.</span><span style=color:#a6e22e>what</span> <span style=color:#f92672>=</span> what<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> sendMessageDelayed<span style=color:#f92672>(</span>msg<span style=color:#f92672>,</span> delayMillis<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>sendEmptyMessageAtTime</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> what<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> uptimeMillis<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Message msg <span style=color:#f92672>=</span> Message<span style=color:#f92672>.</span><span style=color:#a6e22e>obtain</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    msg<span style=color:#f92672>.</span><span style=color:#a6e22e>what</span> <span style=color:#f92672>=</span> what<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> sendMessageAtTime<span style=color:#f92672>(</span>msg<span style=color:#f92672>,</span> uptimeMillis<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到，无论是发送普通消息还是延时消息，最终都会调用到 enqueueMessage() 方法。它们之间的关系如下：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Handler/clipboard_20230323_044956.png width=auto alt></p><p>enqueueMessage() 方法源码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>enqueueMessage</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> MessageQueue queue<span style=color:#f92672>,</span> 
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@NonNull</span> Message msg<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> uptimeMillis<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    msg<span style=color:#f92672>.</span><span style=color:#a6e22e>target</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    msg<span style=color:#f92672>.</span><span style=color:#a6e22e>workSourceUid</span> <span style=color:#f92672>=</span> ThreadLocalWorkSource<span style=color:#f92672>.</span><span style=color:#a6e22e>getUid</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mAsynchronous<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        msg<span style=color:#f92672>.</span><span style=color:#a6e22e>setAsynchronous</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> queue<span style=color:#f92672>.</span><span style=color:#a6e22e>enqueueMessage</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>,</span> uptimeMillis<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到，每个消息的 target 都被赋值为 Handler 本身了。这里传进来的 MessageQueue 就是 Handler 中的 mQueue 成员变量，它来自 Looper.mQueue。enqueueMessage() 方法就是将封装好的消息加入到 MessageQueue 中。</p><h2 id=接收-message>接收 Message
<a class=anchor href=#%e6%8e%a5%e6%94%b6-message>#</a></h2><p>回过头来看 Handler 的 dispatchMessage() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>dispatchMessage</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Message msg<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>callback</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        handleCallback<span style=color:#f92672>(</span>msg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mCallback <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mCallback<span style=color:#f92672>.</span><span style=color:#a6e22e>handleMessage</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        handleMessage<span style=color:#f92672>(</span>msg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到，这里一共有三种不同的途径处理 Message。</p><h3 id=msgcallbackrun>msg.callback.run()
<a class=anchor href=#msgcallbackrun>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>callback</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    handleCallback<span style=color:#f92672>(</span>msg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handleCallback</span><span style=color:#f92672>(</span>Message message<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    message<span style=color:#f92672>.</span><span style=color:#a6e22e>callback</span><span style=color:#f92672>.</span><span style=color:#a6e22e>run</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>首先，会判断 Message 的 callback 是否为空，如果不为空则会调用它的 run 方法。那什么时候这个 callback 会被赋值呢？原来 Handler 还有另外一种打开方式：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>post</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Runnable r<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>return</span>  sendMessageDelayed<span style=color:#f92672>(</span>getPostMessage<span style=color:#f92672>(</span>r<span style=color:#f92672>),</span> 0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>postAtTime</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Runnable r<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> uptimeMillis<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> sendMessageAtTime<span style=color:#f92672>(</span>getPostMessage<span style=color:#f92672>(</span>r<span style=color:#f92672>),</span> uptimeMillis<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>postAtTime</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@NonNull</span> Runnable r<span style=color:#f92672>,</span> <span style=color:#a6e22e>@Nullable</span> Object token<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> uptimeMillis<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> sendMessageAtTime<span style=color:#f92672>(</span>getPostMessage<span style=color:#f92672>(</span>r<span style=color:#f92672>,</span> token<span style=color:#f92672>),</span> uptimeMillis<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>postDelayed</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Runnable r<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> delayMillis<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> sendMessageDelayed<span style=color:#f92672>(</span>getPostMessage<span style=color:#f92672>(</span>r<span style=color:#f92672>),</span> delayMillis<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>postDelayed</span><span style=color:#f92672>(</span>Runnable r<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> what<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> delayMillis<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> sendMessageDelayed<span style=color:#f92672>(</span>getPostMessage<span style=color:#f92672>(</span>r<span style=color:#f92672>).</span><span style=color:#a6e22e>setWhat</span><span style=color:#f92672>(</span>what<span style=color:#f92672>),</span> delayMillis<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>postDelayed</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@NonNull</span> Runnable r<span style=color:#f92672>,</span> <span style=color:#a6e22e>@Nullable</span> Object token<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> delayMillis<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> sendMessageDelayed<span style=color:#f92672>(</span>getPostMessage<span style=color:#f92672>(</span>r<span style=color:#f92672>,</span> token<span style=color:#f92672>),</span> delayMillis<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> Message <span style=color:#a6e22e>getPostMessage</span><span style=color:#f92672>(</span>Runnable r<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Message m <span style=color:#f92672>=</span> Message<span style=color:#f92672>.</span><span style=color:#a6e22e>obtain</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    m<span style=color:#f92672>.</span><span style=color:#a6e22e>callback</span> <span style=color:#f92672>=</span> r<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> m<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>通过传入一个 Runnable 对象，最终也会被封装成一个 Message 对象，而这个 Message 对象的 callback 就是传入的 Runnable。</p><h3 id=mcallbackhandlemessagemsg>mCallback.handleMessage(msg)
<a class=anchor href=#mcallbackhandlemessagemsg>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mCallback <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mCallback<span style=color:#f92672>.</span><span style=color:#a6e22e>handleMessage</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>在 msg.callback == null 的情况下，如果 mCallback != null 则调用 mCallback.handleMessage(msg)。这个 mCallback 对象又是从何而来？答案在 Handler 的创建过程：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Handler</span>(<span style=color:#66d9ef>@NonNull</span> <span style=color:#a6e22e>Looper</span> <span style=color:#a6e22e>looper</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>(<span style=color:#a6e22e>looper</span>, <span style=color:#66d9ef>null</span>, <span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Handler</span>(<span style=color:#66d9ef>@NonNull</span> <span style=color:#a6e22e>Looper</span> <span style=color:#a6e22e>looper</span>, <span style=color:#66d9ef>@Nullable</span> <span style=color:#a6e22e>Callback</span> <span style=color:#a6e22e>callback</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>(<span style=color:#a6e22e>looper</span>, <span style=color:#a6e22e>callback</span>, <span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@UnsupportedAppUsage</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Handler</span>(<span style=color:#66d9ef>@NonNull</span> <span style=color:#a6e22e>Looper</span> <span style=color:#a6e22e>looper</span>, <span style=color:#66d9ef>@Nullable</span> <span style=color:#a6e22e>Callback</span> <span style=color:#a6e22e>callback</span>, <span style=color:#66d9ef>boolean</span> <span style=color:#66d9ef>async</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mLooper</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>looper</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mQueue</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>looper</span>.<span style=color:#a6e22e>mQueue</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mCallback</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>callback</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mAsynchronous</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>Callback</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param msg A {@link android.os.Message Message} object
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return True if no further handling is desired
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>handleMessage</span>(<span style=color:#66d9ef>@NonNull</span> <span style=color:#a6e22e>Message</span> <span style=color:#a6e22e>msg</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>需要注意的是，如果 mCallback.handleMessage(msg) 返回了 true，那么代表消息处理完成，直接返回；如果返回 false，则会继续调用 handleMessage(msg) 方法。</p><h3 id=handlemessagemsg>handleMessage(msg)
<a class=anchor href=#handlemessagemsg>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Subclasses must implement this to receive messages.
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handleMessage</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Message msg<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>从注释中可以看出，Handler 的子类必须实现这个方法才能接收 Message，因此这种方式是提供给它的子类接收并处理消息的。</p><h1 id=总结>总结
<a class=anchor href=#%e6%80%bb%e7%bb%93>#</a></h1><p><strong>Message:</strong> 消息载体，用于携带消息参数、消息目标等。可以通过它的 obtain() 和 recycle() 方法进行复用和回收消息。</p><p><strong>MessageQueue:</strong> 消息队列，用来存放 Handler 发送过来的 Message，按照 when 字段进行优先级排序，其本身是一个以 Message 串联起来的一个单链表。enqueueMessage() 和 next() 方法是生产、消费关系，next() 在队列中没有消息或者消息处理时间未到时会进行阻塞；enqueueMessage() 方法会将消息插入到队列指定位置，并且如果当前消息需要马上处理的时候会唤醒阻塞中的队列。</p><p><strong>Handler:</strong> 调用目标线程的 MessageQueue 的 enqueueMessage() 方法发送消息，并且处理接收到的消息。</p><p><strong>Looper:</strong> 轮询调用 MessageQueue 的 next() 方法获取 Message，并调用目标 Handler 进行处理。</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Handler/clipboard_20230323_045002.png width=auto alt></p><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://guanpj.github.io/amethyst/quartz/js/graph.cbd78cfa87df7d3e230d16fc24f06548.js></script></div></div><div id=contact_buttons><footer><p>Made with <a href=https://github.com/64bitpandas/amethyst>Amethyst</a>, © 2023 guanpj</p><ul><li><a href=https://guanpj.github.io/amethyst/>Home</a></li><li><a href=https://bencuan.me>Website</a></li><li><a href=https://blog.bencuan.me>Blog</a></li></ul></footer></div></article><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#基本使用>基本使用</a></li><li><a href=#threadlocal-原理分析>ThreadLocal 原理分析</a><ul><li><a href=#threadlocal-概念和使用方式>ThreadLocal 概念和使用方式</a></li><li><a href=#threadlocal-的-set-和-get-方法>ThreadLocal 的 set 和 get 方法</a></li><li><a href=#关于内存泄漏>关于内存泄漏</a></li><li><a href=#strong使用场景strong><strong>使用场景</strong></a></li><li><a href=#小结>小结</a></li></ul></li><li><a href=#message>Message</a><ul><li><a href=#消息对象>消息对象</a></li><li><a href=#消息池>消息池</a><ul><li><a href=#messageobtain>Message.obtain()</a></li><li><a href=#recycler>recycler()</a></li></ul></li><li><a href=#setasynchronousboolean-async>setAsynchronous(boolean async)</a></li></ul></li><li><a href=#looper-工作原理分析>Looper 工作原理分析</a><ul><li><a href=#looper-与-handler-的关联>Looper 与 Handler 的关联</a></li><li><a href=#looper-的创建与获取>Looper 的创建与获取</a></li><li><a href=#looperloop>Looper.loop()</a></li><li><a href=#messagequeue-原理分析>MessageQueue 原理分析</a><ul><li><a href=#messagequeue-的创建>MessageQueue 的创建</a></li><li><a href=#next-方法分析>next() 方法分析</a></li><li><a href=#enqueuemessage-方法分析>enqueueMessage() 方法分析</a></li><li><a href=#removemessage-方法分析>removeMessage() 方法分析</a></li><li><a href=#同步屏障-syncbarrier同步消息和异步消息>同步屏障 SyncBarrier、同步消息和异步消息</a></li></ul></li></ul></li><li><a href=#handler-发送和接收消息>Handler 发送和接收消息</a><ul><li><a href=#发送-message>发送 Message</a></li><li><a href=#接收-message>接收 Message</a><ul><li><a href=#msgcallbackrun>msg.callback.run()</a></li><li><a href=#mcallbackhandlemessagemsg>mCallback.handleMessage(msg)</a></li><li><a href=#handlemessagemsg>handleMessage(msg)</a></li></ul></li></ul></li><li><a href=#总结>总结</a></li></ul></nav></div></aside></main></body></html>