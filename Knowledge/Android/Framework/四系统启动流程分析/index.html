<!doctype html><html lang=en dir=ltr><head><meta property="og:title" content="四、系统启动流程分析"><meta property="og:description" content="作为一名 Android 程序员，你有没有想过：那么复杂的 Android 系统，它是怎样运行起来的，我们的 App 又是怎样被 Android 系统加载后呈现在屏幕上的呢？Android 系统的启动是一个比较复杂的过程，涉及到了一些我们没有接触过的知识，本文将基于 Android Nougat 最新的代码上讲述 Android 系统的启动流程。
Bootloader —— 第一个程序 #  当按下电源键（加电）或者系统重启（复位）的时候，引导芯片会从 ROM（这里一般指 Flash ROM，即闪存）中预定义的位置将 Bootloader 载入到 RAM 中，接着，Bootloader 将会把 Linux 内核载入到 RAM 中并启动。
 Bootloader 是在系统内核运行之前运行的一段小程序，也是系统运行的第一个程序，它的主要作用是：
 初始化 RAM（一般指内存） 初始化硬件设备 加载内核和内存空间影像图 跳转到内核  init 进程 —— 1 号进程 #  Linux 内核启动过程中会创建 init 进程，init 进程是用户空间的第一个进程（pid=1），对应的可执行程序的源文件文件为 [/system/core/init/Init.cpp]( https://android.googlesource.com/platform/system/core/ /nougat-release/init/init.cpp)，它的 main 方法如下：
int main(int argc, char** argv) {  if (!strcmp(basename(argv[0]), &#34;ueventd&#34;)) {  return ueventd_main(argc, argv);  }  if (!"><meta property="og:type" content="article"><meta property="og:url" content="https://guanpj.github.io/amethyst/Knowledge/Android/Framework/%E5%9B%9B%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/"><meta property="article:section" content="Knowledge"><meta property="og:site_name" content="guanpj's blog"><title>四、系统启动流程分析 | guanpj's blog</title><link rel=manifest href=/amethyst/manifest.json><link rel=icon href=/amethyst/favicon.png type=image/x-icon><link rel=stylesheet href=/amethyst/book.min.c27ff4755c78daab11627953d5a6dd7e2698690e086398032995aae74d6397b6.css integrity="sha256-wn/0dVx42qsRYnlT1abdfiaYaQ4IY5gDKZWq501jl7Y=" crossorigin=anonymous><meta charset=utf-8><meta name=description content="作为一名 Android 程序员，你有没有想过：那么复杂的 Android 系统，它是怎样运行起来的，我们的 App 又是怎样被 Android 系统加载后呈现在屏幕上的呢？Android 系统的启动是一个比较复杂的过程，涉及到了一些我们没有接触过的知识，本文将基于 Android Nougat 最新的代码上讲述 Android 系统的启动流程。
Bootloader —— 第一个程序 #  当按下电源键（加电）或者系统重启（复位）的时候，引导芯片会从 ROM（这里一般指 Flash ROM，即闪存）中预定义的位置将 Bootloader 载入到 RAM 中，接着，Bootloader 将会把 Linux 内核载入到 RAM 中并启动。
 Bootloader 是在系统内核运行之前运行的一段小程序，也是系统运行的第一个程序，它的主要作用是：
 初始化 RAM（一般指内存） 初始化硬件设备 加载内核和内存空间影像图 跳转到内核  init 进程 —— 1 号进程 #  Linux 内核启动过程中会创建 init 进程，init 进程是用户空间的第一个进程（pid=1），对应的可执行程序的源文件文件为 [/system/core/init/Init.cpp]( https://android.googlesource.com/platform/system/core/ /nougat-release/init/init.cpp)，它的 main 方法如下：
int main(int argc, char** argv) {  if (!strcmp(basename(argv[0]), &#34;ueventd&#34;)) {  return ueventd_main(argc, argv);  }  if (!"><title>四、系统启动流程分析</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://guanpj.github.io/amethyst//favicon.png><link href=https://guanpj.github.io/amethyst/styles.e08ceb33360cec132feb69cfb982e2a4.min.css rel=stylesheet><link href=https://guanpj.github.io/amethyst/quartz/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://guanpj.github.io/amethyst/quartz/js/darkmode.1bc498b60ed24d8858f74f99e480db82.min.js></script>
<script src=https://guanpj.github.io/amethyst/quartz/js/util.c69e233dc1cc331a30b0f670e657b425.min.js></script>
<script async src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script async src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://guanpj.github.io/amethyst/quartz/js/popover.f03552ccb84d99ca615d1cfb9abde59e.min.js></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://guanpj.github.io/amethyst/",fetchData=Promise.all([fetch("https://guanpj.github.io/amethyst/indices/linkIndex.f13ba8f7c67305f3500d259bdfb72f53.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://guanpj.github.io/amethyst/indices/contentIndex.1d36e1d8fc5979d61a65084cf1563896.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addCollapsibleCallouts(),initPopover("https://guanpj.github.io/amethyst",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!0;drawGraph("https://guanpj.github.io/amethyst",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script>window.Million={navigate:e=>window.location.href=e,prefetch:()=>{}},window.addEventListener("DOMContentLoaded",()=>{init(),render()})</script></head><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><header class=book-header><label for=menu-control><img src=/amethyst/svg/menu.svg class=book-icon alt=Menu></label><h1 id=page-title><a href=https://guanpj.github.io/amethyst/>guanpj's blog</a></h1><div class=spacer></div><div id=search-icon class=quartz-search><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control><main class=flex><aside class=book-menu><div class=book-menu-content><nav><div class=menu-search><div id=search-icon class=quartz-search><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div></div><ul><li><span class=book-menu-title>Atlas</span><ul><li><a href=/amethyst/Atlas/About-Atlas/>About Atlas</a></li><li><a href=/amethyst/Atlas/Index-for-Atlases/>Index for Atlases</a></li></ul></li><li><span class=book-menu-title>Dashborads</span><ul><li><a href=/amethyst/Dashborad/Buttons/>Buttons</a></li><li><a href=/amethyst/Dashborad/ControlPanel/>Control Panel</a></li></ul></li><li><span class=book-menu-title>Excalidraws</span><ul><li><a href=/amethyst/Excalidraw/MyDraw/>My Draw</a></li></ul></li><li><span class=book-menu-title>Extras</span><ul><li><a href=/amethyst/Extras/Linter/>Linter</a></li><li><a href=/amethyst/Extras/Index-for-Extras/>Index for Extras</a></li></ul></li><li><span class=book-menu-title>Knowledges</span><ul><li><a href=/amethyst/Knowledge/Kotlin/%E5%A7%94%E6%89%98/>委托</a></li><li><a href=/amethyst/Knowledge/Kotlin/%E6%89%A9%E5%B1%95%E5%87%BD%E6%95%B0/>扩展函数</a></li><li><a href=/amethyst/Knowledge/Python/%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%96%87%E6%9C%AC%E6%9B%BF%E6%8D%A2/>文件读取、文本替换</a></li><li><a href=/amethyst/Knowledge/Python/%E7%B1%BB%E7%9A%84%E5%AE%9A%E4%B9%89%E4%BD%BF%E7%94%A8/>类的定义、使用</a></li><li><a href=/amethyst/Knowledge/Python/%E9%81%8D%E5%8E%86%E6%96%87%E4%BB%B6%E9%87%8D%E5%91%BD%E5%90%8D/>遍历文件、重命名</a></li><li><a href=/amethyst/Knowledge/%E7%AE%97%E6%B3%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E5%BC%95%E7%94%A8/>引用</a></li><li><a href=/amethyst/Knowledge/%E7%AE%97%E6%B3%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%8C%87%E9%92%88/>指针</a></li><li><a href=/amethyst/Knowledge/Android/Android-%E5%9F%BA%E7%A1%80/ADB-%E5%91%BD%E4%BB%A4/>ADB 命令</a></li><li><a href=/amethyst/Knowledge/Android/%E7%83%AD%E4%BF%AE%E5%A4%8D%E6%8F%92%E4%BB%B6%E5%8C%96/Java-%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/>ADB 命令</a></li><li><a href=/amethyst/Knowledge/Android/Android-%E5%9F%BA%E7%A1%80/Android-%E5%AF%B9%E5%AE%B9%E5%99%A8%E7%B1%BB%E7%9A%84%E4%BC%98%E5%8C%96/>Android 对容器类的优化</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/CAS-%E5%92%8C-AQS-%E5%8E%9F%E7%90%86/>CAS 和 AQS 原理</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/EventBus-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>EventBus 使用及源码解析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/Glide-%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E5%92%8C%E7%BC%93%E5%AD%98%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/>Glide 加载流程和缓存原理分析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/Glide-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/>Glide 基本使用</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/Glide-%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95/>Glide 高级用法</a></li><li><a href=/amethyst/Knowledge/Java/%E5%9F%BA%E7%A1%80/HashMap-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>HashMap 源码解析</a></li><li><a href=/amethyst/Knowledge/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9B%B8%E5%85%B3/HTTP-%E5%9F%BA%E7%A1%80/>HTTP 基础</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/Java-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/>Java 内存模型</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E4%B8%AD%E7%9A%84%E5%AF%B9%E8%B1%A1%E5%92%8C%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/>JVM 中的对象和垃圾回收</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F/>JVM 内存区域</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E5%AD%97%E8%8A%82%E7%A0%81%E6%8C%87%E4%BB%A4%E7%AE%80%E4%BB%8B/>JVM 字节码指令简介</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E5%AD%97%E8%8A%82%E7%A0%81%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/>JVM 字节码结构分析</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/>JVM 类加载机制</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/LeakCanary-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>LeakCanary 使用及源码解析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/OkHttp-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>OkHttp 使用及源码分析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/Retrofit-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>Retrofit 使用及源码分析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/RxJava-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>RxJava 使用及源码分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%B8%80Binder-%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90%E6%A6%82%E5%BF%B5%E7%AF%87/>一、Binder 机制分析——概念篇</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%B8%83View-%E4%BA%8B%E4%BB%B6%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/>七、View 事件机制分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%B8%89Handler-%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/>三、Handler 原理分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%BA%8CBinder-%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90%E5%BA%94%E7%94%A8%E7%AF%87/>二、Binder 机制分析——应用篇</a></li><li><a href=/amethyst/Knowledge/%E7%AE%97%E6%B3%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E4%BA%8C%E5%8F%89%E6%A0%91%E9%81%8D%E5%8E%86/>二叉树遍历</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%BA%94App-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/>五、App 启动流程分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E5%85%ADView-%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/>六、View 绘制流程分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E5%9B%9B%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/ class=active>四、系统启动流程分析</a></li><li><a href=/amethyst/Knowledge/Java/%E5%9F%BA%E7%A1%80/%E5%AE%B9%E5%99%A8%E7%B1%BB/>容器类</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/>并发容器</a></li><li><a href=/amethyst/Knowledge/Java/%E5%9F%BA%E7%A1%80/%E6%B3%9B%E5%9E%8B/>泛型</a></li><li><a href=/amethyst/Knowledge/Java/%E5%9F%BA%E7%A1%80/%E6%B3%A8%E8%A7%A3%E5%92%8C%E5%8F%8D%E5%B0%84/>注解和反射</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E7%AD%89%E5%BE%85-%E9%80%9A%E7%9F%A5%E6%9C%BA%E5%88%B6/>等待-通知机制</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E7%BA%BF%E7%A8%8B%E5%8D%8F%E4%BD%9C/>线程协作</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80/>线程基础</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%92%8C-BlockingQueue/>线程池和 BlockingQueue</a></li><li><a href=/amethyst/Knowledge/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9B%B8%E5%85%B3/%E7%BC%96%E7%A0%81%E5%8A%A0%E5%AF%86Hash%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%AD%97%E7%AC%A6%E9%9B%86/>编码、加密、Hash、序列化和字符集</a></li><li><a href=/amethyst/Knowledge/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9B%B8%E5%85%B3/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84TCPIP-%E5%92%8C-HTTPS/>计算机网络体系结构、TCP&IP 和 HTTPS</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E9%94%81/>锁</a></li></ul></li><li><span class=book-menu-title>Notes</span><ul><li><a href=/amethyst/Notes/2023-03-15/>2023 03 15</a></li><li><a href=/amethyst/Notes/2023-03-18/>2023 03 18</a></li><li><a href=/amethyst/Notes/2023-03-19/>2023 03 19</a></li><li><a href=/amethyst/Notes/2023-03-20/>2023 03 20</a></li><li><a href=/amethyst/Notes/2023-03-22/>Troubleshooting and FAQ</a></li></ul></li></ul><ul><li><a href=https://github.com/64bitpandas/amethyst target=_blank rel=noopener>Github</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class="book-page container"><article class=markdown><h1 class=title>四、系统启动流程分析</h1><p>作为一名 Android 程序员，你有没有想过：那么复杂的 Android 系统，它是怎样运行起来的，我们的 App 又是怎样被 Android 系统加载后呈现在屏幕上的呢？Android 系统的启动是一个比较复杂的过程，涉及到了一些我们没有接触过的知识，本文将基于 Android Nougat 最新的代码上讲述 Android 系统的启动流程。</p><h1 id=bootloader--第一个程序>Bootloader —— 第一个程序
<a class=anchor href=#bootloader--%e7%ac%ac%e4%b8%80%e4%b8%aa%e7%a8%8b%e5%ba%8f>#</a></h1><p>当按下电源键（加电）或者系统重启（复位）的时候，引导芯片会从
<a href=https://zh.wikipedia.org/wiki/%E5%94%AF%E8%AE%80%E8%A8%98%E6%86%B6%E9%AB%94 rel=noopener>ROM</a>（这里一般指 Flash ROM，即闪存）中预定义的位置将 Bootloader 载入到 RAM 中，接着，Bootloader 将会把 Linux 内核载入到 RAM 中并启动。</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/System-Boot/clipboard_20230323_045201.png width=auto alt></p><p>Bootloader 是在系统内核运行之前运行的一段小程序，也是系统运行的第一个程序，它的主要作用是：</p><ol><li>初始化
<a href=https://zh.wikipedia.org/wiki/%E9%9A%8F%E6%9C%BA%E5%AD%98%E5%8F%96%E5%AD%98%E5%82%A8%E5%99%A8 rel=noopener>RAM</a>（一般指内存）</li><li>初始化硬件设备</li><li>加载内核和内存空间影像图</li><li>跳转到内核</li></ol><h1 id=init-进程--1-号进程>init 进程 —— 1 号进程
<a class=anchor href=#init-%e8%bf%9b%e7%a8%8b--1-%e5%8f%b7%e8%bf%9b%e7%a8%8b>#</a></h1><p>Linux 内核启动过程中会创建 init 进程，init 进程是用户空间的第一个进程（pid=1），对应的可执行程序的源文件文件为 [/system/core/init/Init.cpp](
<a href=https://android.googlesource.com/platform/system/core/ rel=noopener>https://android.googlesource.com/platform/system/core/</a> /nougat-release/init/init.cpp)，它的 main 方法如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span><span style=color:#f92672>**</span> argv) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>strcmp(basename(argv[<span style=color:#ae81ff>0</span>]), <span style=color:#e6db74>&#34;ueventd&#34;</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> ueventd_main(argc, argv);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>strcmp(basename(argv[<span style=color:#ae81ff>0</span>]), <span style=color:#e6db74>&#34;watchdogd&#34;</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> watchdogd_main(argc, argv);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    umask(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>    add_environment(<span style=color:#e6db74>&#34;PATH&#34;</span>, _PATH_DEFPATH);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>bool</span> is_first_stage <span style=color:#f92672>=</span> (argc <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>||</span> (strcmp(argv[<span style=color:#ae81ff>1</span>], <span style=color:#e6db74>&#34;--second-stage&#34;</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 创建文件并挂载
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (is_first_stage) {
</span></span><span style=display:flex><span>        mount(<span style=color:#e6db74>&#34;tmpfs&#34;</span>, <span style=color:#e6db74>&#34;/dev&#34;</span>, <span style=color:#e6db74>&#34;tmpfs&#34;</span>, MS_NOSUID, <span style=color:#e6db74>&#34;mode=0755&#34;</span>);
</span></span><span style=display:flex><span>        mkdir(<span style=color:#e6db74>&#34;/dev/pts&#34;</span>, <span style=color:#ae81ff>0755</span>);
</span></span><span style=display:flex><span>        mkdir(<span style=color:#e6db74>&#34;/dev/socket&#34;</span>, <span style=color:#ae81ff>0755</span>);
</span></span><span style=display:flex><span>        mount(<span style=color:#e6db74>&#34;devpts&#34;</span>, <span style=color:#e6db74>&#34;/dev/pts&#34;</span>, <span style=color:#e6db74>&#34;devpts&#34;</span>, <span style=color:#ae81ff>0</span>, NULL);
</span></span><span style=display:flex><span>        <span style=color:#75715e>#define MAKE_STR(x) __STRING(x)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        mount(<span style=color:#e6db74>&#34;proc&#34;</span>, <span style=color:#e6db74>&#34;/proc&#34;</span>, <span style=color:#e6db74>&#34;proc&#34;</span>, <span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#34;hidepid=2,gid=&#34;</span> MAKE_STR(AID_READPROC));
</span></span><span style=display:flex><span>        mount(<span style=color:#e6db74>&#34;sysfs&#34;</span>, <span style=color:#e6db74>&#34;/sys&#34;</span>, <span style=color:#e6db74>&#34;sysfs&#34;</span>, <span style=color:#ae81ff>0</span>, NULL);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    open_devnull_stdio();
</span></span><span style=display:flex><span>    klog_init();
</span></span><span style=display:flex><span>    klog_set_level(KLOG_NOTICE_LEVEL);
</span></span><span style=display:flex><span>    NOTICE(<span style=color:#e6db74>&#34;init %s started!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, is_first_stage <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;first stage&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;second stage&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>is_first_stage) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Indicate that booting is in progress to background fw loaders, etc.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        close(open(<span style=color:#e6db74>&#34;/dev/.booting&#34;</span>, O_WRONLY <span style=color:#f92672>|</span> O_CREAT <span style=color:#f92672>|</span> O_CLOEXEC, <span style=color:#ae81ff>0000</span>));
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 初始化属性相关资源
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        property_init();
</span></span><span style=display:flex><span>        process_kernel_dt();
</span></span><span style=display:flex><span>        process_kernel_cmdline();
</span></span><span style=display:flex><span>        export_kernel_boot_props();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 启动属性服务
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    start_property_service();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> BuiltinFunctionMap function_map;
</span></span><span style=display:flex><span>    Action<span style=color:#f92672>::</span>set_function_map(<span style=color:#f92672>&amp;</span>function_map);
</span></span><span style=display:flex><span>    Parser<span style=color:#f92672>&amp;</span> parser <span style=color:#f92672>=</span> Parser<span style=color:#f92672>::</span>GetInstance();
</span></span><span style=display:flex><span>    parser.AddSectionParser(<span style=color:#e6db74>&#34;service&#34;</span>,std<span style=color:#f92672>::</span>make_unique<span style=color:#f92672>&lt;</span>ServiceParser<span style=color:#f92672>&gt;</span>());
</span></span><span style=display:flex><span>    parser.AddSectionParser(<span style=color:#e6db74>&#34;on&#34;</span>, std<span style=color:#f92672>::</span>make_unique<span style=color:#f92672>&lt;</span>ActionParser<span style=color:#f92672>&gt;</span>());
</span></span><span style=display:flex><span>    parser.AddSectionParser(<span style=color:#e6db74>&#34;import&#34;</span>, std<span style=color:#f92672>::</span>make_unique<span style=color:#f92672>&lt;</span>ImportParser<span style=color:#f92672>&gt;</span>());
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 解析init.rc配置文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    parser.ParseConfig(<span style=color:#e6db74>&#34;/init.rc&#34;</span>);
</span></span><span style=display:flex><span>    ...   
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (true) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>waiting_for_exec) {
</span></span><span style=display:flex><span>            am.ExecuteOneCommand();
</span></span><span style=display:flex><span>            restart_processes();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> timeout <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (process_needs_restart) {
</span></span><span style=display:flex><span>            timeout <span style=color:#f92672>=</span> (process_needs_restart <span style=color:#f92672>-</span> gettime()) <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (timeout <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>                timeout <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (am.HasMoreCommands()) {
</span></span><span style=display:flex><span>            timeout <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        bootchart_sample(<span style=color:#f92672>&amp;</span>timeout);
</span></span><span style=display:flex><span>        epoll_event ev;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> nr <span style=color:#f92672>=</span> TEMP_FAILURE_RETRY(epoll_wait(epoll_fd, <span style=color:#f92672>&amp;</span>ev, <span style=color:#ae81ff>1</span>, timeout));
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (nr <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>            ERROR(<span style=color:#e6db74>&#34;epoll_wait failed: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, strerror(errno));
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (nr <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>            ((<span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>)()) ev.data.ptr)();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>init 进程的职责主要有四个：</p><ol><li>解析和运行所有 init.rc 文件</li><li>生成设备驱动节点</li><li>处理子进程的终结</li><li>提供属性服务</li></ol><p>这里重点看第一点，[init.rc](
<a href=https://android.googlesource.com/platform/system/core/ rel=noopener>https://android.googlesource.com/platform/system/core/</a> /nougat-release/rootdir/init.rc) 是一个配置文件，它由 Android 初始化语言编写，zygote 进程和 servicemanager 进程都是由 init 进程解析 init.rc 中特定的语句启动的，比如，启动 zygote 进程的代码格式如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>service zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server
</span></span><span style=display:flex><span>    class main
</span></span><span style=display:flex><span>    socket zygote stream 660 root system
</span></span><span style=display:flex><span>    onrestart write /sys/android_power/request_state wake
</span></span><span style=display:flex><span>    onrestart write /sys/power/state on
</span></span><span style=display:flex><span>    onrestart restart audioserver
</span></span><span style=display:flex><span>    onrestart restart cameraserver
</span></span><span style=display:flex><span>    onrestart restart media
</span></span><span style=display:flex><span>    onrestart restart netd
</span></span><span style=display:flex><span>    writepid /dev/cpuset/foreground/tasks /dev/stune/foreground/tasks
</span></span></code></pre></div><p>事实上，在 [system/core/rootdir](
<a href=https://android.googlesource.com/platform/system/core/ rel=noopener>https://android.googlesource.com/platform/system/core/</a> /nougat-release/rootdir) 目录下，有多个 init.rc 文件，在不同的硬件环境下，相应的 init.rc 文件会被导入，比如在 64 位操作系统中，上面启动 zygote 进程的代码是从 [init.zygote64.rc](
<a href=https://android.googlesource.com/platform/system/core/ rel=noopener>https://android.googlesource.com/platform/system/core/</a> /nougat-release/rootdir/init.zygote64.rc) 文件中导入的。它的含义主要为：</p><ol><li>service zygote 表示启动一个名为 zygote 的服务</li><li>/system/bin/app_process64 表示服务对应执行文件的路径</li><li>-Xzygote /system/bin &ndash;zygote &ndash;start-system-server 表示启动服务的参数</li></ol><h1 id=servicemanager-进程--binder-服务的总管>servicemanager 进程 —— Binder 服务的总管
<a class=anchor href=#servicemanager-%e8%bf%9b%e7%a8%8b--binder-%e6%9c%8d%e5%8a%a1%e7%9a%84%e6%80%bb%e7%ae%a1>#</a></h1><p>我在文章
<a href=https://ywue4d2ujm.feishu.cn/docs/doccnnNIKMdICh9atjwTbBRYxpf# rel=noopener>Binder 机制分析</a>中讲到“Binder 通信模型和通信过程”的时候提到过 ServerManager，它是 Binder IPC 的核心，是上下文的管理者，Binder 服务端必须先向 ServerManager 注册才能够为客户端提供服务，Binder 客户端在与服务端通信之前需要从 ServerManager 中查找并获取 Binder 服务端的引用。然而 ServerManager 在向 Binder 驱动申请成为上下文管理者的时候又涉及到了 Binder IPC 过程，这时候应该怎么处理呢？</p><p>servicemanager 进程是由 init 进程通过解析 init.rc 文件来启动的，对应的代码如下：</p><pre tabindex=0><code>service servicemanager /system/bin/servicemanager
    class core
    user system
    group system
    critical
    onrestart restart healthd
    onrestart restart zygote
    onrestart restart media
    onrestart restart surfaceflinger
    onrestart restart drm
</code></pre><p>servicemanager 进程对应可执行程序的源文件为 [framework/native/cmds/servicemanager/service_manager.c](
<a href=https://android.googlesource.com/platform/frameworks/native/ rel=noopener>https://android.googlesource.com/platform/frameworks/native/</a> /nougat-release/cmds/servicemanager/service_manager.c)，简化后的代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span>argv) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> binder_state <span style=color:#f92672>*</span>bs;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 打开binder驱动，申请 128k 字节大小的内存空间
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    bs <span style=color:#f92672>=</span> binder_open(<span style=color:#ae81ff>128</span><span style=color:#f92672>*</span><span style=color:#ae81ff>1024</span>);
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 成为上下文管理者
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (binder_become_context_manager(bs)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 验证 selinux 权限，判断进程是否有权注册或查看指定服务
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    selinux_enabled <span style=color:#f92672>=</span> is_selinux_enabled();
</span></span><span style=display:flex><span>    sehandle <span style=color:#f92672>=</span> selinux_android_service_context_handle();
</span></span><span style=display:flex><span>    selinux_status_open(true);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (selinux_enabled <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (sehandle <span style=color:#f92672>==</span> NULL) {  
</span></span><span style=display:flex><span>            abort();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (getcon(<span style=color:#f92672>&amp;</span>service_manager_context) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>            abort();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 进入无限循环，处理 client 端发来的请求 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    binder_loop(bs, svcmgr_handler);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这里重点关注两点，首先，在申请了一块大小为 128k 的内存空间并验证 selinux 权限后，接着调用 [framework/native/cmds/servicemanager/binder.c](
<a href=https://android.googlesource.com/platform/frameworks/native/ rel=noopener>https://android.googlesource.com/platform/frameworks/native/</a> /nougat-release/cmds/servicemanager/binder.c) 中的 binder_become_context_manager 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>binder_become_context_manager</span>(<span style=color:#66d9ef>struct</span> binder_state <span style=color:#f92672>*</span>bs) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 通过ioctl，发送 BINDER_SET_CONTEXT_MGR 指令
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> ioctl(bs<span style=color:#f92672>-&gt;</span>fd, BINDER_SET_CONTEXT_MGR, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>然后，调用 binder_loop 方法进入循环来处理 client 发来的请求，注意第二个参数是一个方法体，用于处理各种状态回调：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>svcmgr_handler</span>(<span style=color:#66d9ef>struct</span> binder_state <span style=color:#f92672>*</span>bs,
</span></span><span style=display:flex><span>                   <span style=color:#66d9ef>struct</span> binder_transaction_data <span style=color:#f92672>*</span>txn,
</span></span><span style=display:flex><span>                   <span style=color:#66d9ef>struct</span> binder_io <span style=color:#f92672>*</span>msg,
</span></span><span style=display:flex><span>                   <span style=color:#66d9ef>struct</span> binder_io <span style=color:#f92672>*</span>reply)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> svcinfo <span style=color:#f92672>*</span>si;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint16_t</span> <span style=color:#f92672>*</span>s;
</span></span><span style=display:flex><span>    size_t len;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint32_t</span> handle;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint32_t</span> strict_policy;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> allow_isolated;
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    strict_policy <span style=color:#f92672>=</span> bio_get_uint32(msg);
</span></span><span style=display:flex><span>    s <span style=color:#f92672>=</span> bio_get_string16(msg, <span style=color:#f92672>&amp;</span>len);
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span>(txn<span style=color:#f92672>-&gt;</span>code) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> SVC_MGR_GET_SERVICE:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> SVC_MGR_CHECK_SERVICE: 
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 获取服务名
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        s <span style=color:#f92672>=</span> bio_get_string16(msg, <span style=color:#f92672>&amp;</span>len); 
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 根据名称查找相应服务
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        handle <span style=color:#f92672>=</span> do_find_service(bs, s, len, txn<span style=color:#f92672>-&gt;</span>sender_euid, txn<span style=color:#f92672>-&gt;</span>sender_pid);
</span></span><span style=display:flex><span>        bio_put_ref(reply, handle);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> SVC_MGR_ADD_SERVICE: 
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 获取服务名
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        s <span style=color:#f92672>=</span> bio_get_string16(msg, <span style=color:#f92672>&amp;</span>len);
</span></span><span style=display:flex><span>        handle <span style=color:#f92672>=</span> bio_get_ref(msg);
</span></span><span style=display:flex><span>        allow_isolated <span style=color:#f92672>=</span> bio_get_uint32(msg) <span style=color:#f92672>?</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>         <span style=color:#75715e>// 注册指定服务
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (do_add_service(bs, s, len, handle, txn<span style=color:#f92672>-&gt;</span>sender_euid,
</span></span><span style=display:flex><span>            allow_isolated, txn<span style=color:#f92672>-&gt;</span>sender_pid))
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>servicemanager 进程在启动过程的工作内容如下：</p><ol><li>调用 binder_open 方法打开 Binder 驱动，并申请分配一块 128k 的内存空间</li><li>调用 binder_become_context_manager 方法发送 BINDER_SET_CONTEXT_MGR 给 Binder 驱动，使自己成为上下文管理者</li><li>验证 selinux 权限，判断进程是否有注册或查看指定服务的权限</li><li>调用 binder_loop 方法进入循环状态，等待 Client 请求</li><li>根据服务名称注册服务·</li><li>接收 Binder 死亡通知</li></ol><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/System-Boot/clipboard_20230323_045211.png width=auto alt></p><h1 id=zygote-进程--java-进程的始祖>zygote 进程 —— Java 进程的始祖
<a class=anchor href=#zygote-%e8%bf%9b%e7%a8%8b--java-%e8%bf%9b%e7%a8%8b%e7%9a%84%e5%a7%8b%e7%a5%96>#</a></h1><h2 id=1启动-java-虚拟机>1.启动 Java 虚拟机
<a class=anchor href=#1%e5%90%af%e5%8a%a8-java-%e8%99%9a%e6%8b%9f%e6%9c%ba>#</a></h2><p>通过解析 init.rc 文件，zygote 进程对应的可执行程序的源文件为 [frameworks/base/cmds/app_process/app_main.cpp](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/cmds/app_process/app_main.cpp)，它的 main 方法如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> <span style=color:#66d9ef>const</span> argv[])
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    AppRuntime runtime(argv[<span style=color:#ae81ff>0</span>], computeArgBlockSize(argc, argv));
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Parse runtime arguments.  Stop at first unrecognized option.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>bool</span> zygote <span style=color:#f92672>=</span> false;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>bool</span> startSystemServer <span style=color:#f92672>=</span> false;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>bool</span> application <span style=color:#f92672>=</span> false;
</span></span><span style=display:flex><span>    String8 niceName;
</span></span><span style=display:flex><span>    String8 className;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>++</span>i;  <span style=color:#75715e>// Skip unused &#34;parent dir&#34; argument.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>while</span> (i <span style=color:#f92672>&lt;</span> argc) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> arg <span style=color:#f92672>=</span> argv[i<span style=color:#f92672>++</span>];
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (strcmp(arg, <span style=color:#e6db74>&#34;--zygote&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 当前进程是否用于承载 zygote
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            zygote <span style=color:#f92672>=</span> true;
</span></span><span style=display:flex><span>            niceName <span style=color:#f92672>=</span> ZYGOTE_NICE_NAME;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (strcmp(arg, <span style=color:#e6db74>&#34;--start-system-server&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) { 
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 是否需要启动 system_server 进程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            startSystemServer <span style=color:#f92672>=</span> true;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (strcmp(arg, <span style=color:#e6db74>&#34;--application&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 启动进入独立的程序模式
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            application <span style=color:#f92672>=</span> true;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (strncmp(arg, <span style=color:#e6db74>&#34;--nice-name=&#34;</span>, <span style=color:#ae81ff>12</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 此进程的别名
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            niceName.setTo(arg <span style=color:#f92672>+</span> <span style=color:#ae81ff>12</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (strncmp(arg, <span style=color:#e6db74>&#34;--&#34;</span>, <span style=color:#ae81ff>2</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>            className.setTo(arg);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#f92672>--</span>i;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (zygote) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 调用 AppRuntime 父类 AndroidRuntime 的 start 方法创建 zygote 进程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        runtime.start(<span style=color:#e6db74>&#34;com.android.internal.os.ZygoteInit&#34;</span>, args, zygote);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (className) {
</span></span><span style=display:flex><span>        runtime.start(<span style=color:#e6db74>&#34;com.android.internal.os.RuntimeInit&#34;</span>, args, zygote);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        fprintf(stderr, <span style=color:#e6db74>&#34;Error: no class name or --zygote supplied.</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>        app_usage();
</span></span><span style=display:flex><span>        LOG_ALWAYS_FATAL(<span style=color:#e6db74>&#34;app_process: no class name or --zygote supplied.&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>10</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在我们的场景中， init.rc 指定了 &ndash;zygote 选项，结合以上代码的注释可知，app_process64 接下来将启动 “ZygoteInit” 并传入 “start-system-server” 作为参数。</p><p>之后 ZygoteInit 将会运行于 Java 虚拟机上——因为 runtime 变量实际上就是一个 AndroidRuntime 对象， [frameworks/base/core/jni/AndroidRuntime.cpp](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/jni/AndroidRuntime.cpp) 的 start 方法如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>void</span> AndroidRuntime<span style=color:#f92672>::</span>start(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> className, <span style=color:#66d9ef>const</span> Vector<span style=color:#f92672>&lt;</span>String8<span style=color:#f92672>&gt;&amp;</span> options, <span style=color:#66d9ef>bool</span> zygote)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* start the virtual machine */</span>
</span></span><span style=display:flex><span>    JniInvocation jni_invocation;
</span></span><span style=display:flex><span>    jni_invocation.Init(NULL);
</span></span><span style=display:flex><span>    JNIEnv<span style=color:#f92672>*</span> env;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 启动 DVM
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (startVm(<span style=color:#f92672>&amp;</span>mJavaVM, <span style=color:#f92672>&amp;</span>env, zygote) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 虚拟机启动后的回调
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    onVmCreated(env);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 注册 JNI 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (startReg(env) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        ALOGE(<span style=color:#e6db74>&#34;Unable to register all android natives</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    jclass stringClass;
</span></span><span style=display:flex><span>    jobjectArray strArray;
</span></span><span style=display:flex><span>    jstring classNameStr;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    stringClass <span style=color:#f92672>=</span> env<span style=color:#f92672>-&gt;</span>FindClass(<span style=color:#e6db74>&#34;java/lang/String&#34;</span>);
</span></span><span style=display:flex><span>    assert(stringClass <span style=color:#f92672>!=</span> NULL);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 创建数组
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    strArray <span style=color:#f92672>=</span> env<span style=color:#f92672>-&gt;</span>NewObjectArray(options.size() <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, stringClass, NULL);
</span></span><span style=display:flex><span>    assert(strArray <span style=color:#f92672>!=</span> NULL);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 从 app_main 的 main 函数得知 className 为 com.android.internal.os.ZygoteInit
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    classNameStr <span style=color:#f92672>=</span> env<span style=color:#f92672>-&gt;</span>NewStringUTF(className);
</span></span><span style=display:flex><span>    assert(classNameStr <span style=color:#f92672>!=</span> NULL);
</span></span><span style=display:flex><span>    env<span style=color:#f92672>-&gt;</span>SetObjectArrayElement(strArray, <span style=color:#ae81ff>0</span>, classNameStr);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (size_t i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> options.size(); <span style=color:#f92672>++</span>i) {
</span></span><span style=display:flex><span>        jstring optionsStr <span style=color:#f92672>=</span> env<span style=color:#f92672>-&gt;</span>NewStringUTF(options.itemAt(i).string());
</span></span><span style=display:flex><span>        assert(optionsStr <span style=color:#f92672>!=</span> NULL);
</span></span><span style=display:flex><span>        env<span style=color:#f92672>-&gt;</span>SetObjectArrayElement(strArray, i <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, optionsStr);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> slashClassName <span style=color:#f92672>=</span> toSlashClassName(className);
</span></span><span style=display:flex><span>    jclass startClass <span style=color:#f92672>=</span> env<span style=color:#f92672>-&gt;</span>FindClass(slashClassName);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (startClass <span style=color:#f92672>==</span> NULL) {
</span></span><span style=display:flex><span>        ALOGE(<span style=color:#e6db74>&#34;JavaVM unable to locate class &#39;%s&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, slashClassName);
</span></span><span style=display:flex><span>        <span style=color:#75715e>/* keep going */</span>
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 找到 ZygoteInit 的 main 函数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        jmethodID startMeth <span style=color:#f92672>=</span> env<span style=color:#f92672>-&gt;</span>GetStaticMethodID(startClass, <span style=color:#e6db74>&#34;main&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;([Ljava/lang/String;)V&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (startMeth <span style=color:#f92672>==</span> NULL) {
</span></span><span style=display:flex><span>            ALOGE(<span style=color:#e6db74>&#34;JavaVM unable to find main() in &#39;%s&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, className);
</span></span><span style=display:flex><span>            <span style=color:#75715e>/* keep going */</span>
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 通过 JNI 调用 ZygoteInit 的 main 函数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            env<span style=color:#f92672>-&gt;</span>CallStaticVoidMethod(startClass, startMeth, strArray);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (env<span style=color:#f92672>-&gt;</span>ExceptionCheck())
</span></span><span style=display:flex><span>                threadExitUncaughtException(env);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=2加载-zygoteinit>2.加载 ZygoteInit
<a class=anchor href=#2%e5%8a%a0%e8%bd%bd-zygoteinit>#</a></h2><p>通过 JNI 的方式进入 [frameworks/base/core/java/com/android/internal/os/ZygoteInit.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/com/android/internal/os/ZygoteInit.java)：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String argv<span style=color:#f92672>[])</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>       
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 注册Zygote用的Socket
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        registerZygoteSocket<span style=color:#f92672>(</span>socketName<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 预加载类和资源
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        preload<span style=color:#f92672>();</span><span style=color:#75715e>//2
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>startSystemServer<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 启动SystemServer进程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            startSystemServer<span style=color:#f92672>(</span>abiList<span style=color:#f92672>,</span> socketName<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        Log<span style=color:#f92672>.</span><span style=color:#a6e22e>i</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Accepting command socket connections&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 等待客户端请求
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        runSelectLoop<span style=color:#f92672>(</span>abiList<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        closeServerSocket<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>MethodAndArgsCaller caller<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        caller<span style=color:#f92672>.</span><span style=color:#a6e22e>run</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>RuntimeException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Log<span style=color:#f92672>.</span><span style=color:#a6e22e>e</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Zygote died with exception&#34;</span><span style=color:#f92672>,</span> ex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        closeServerSocket<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> ex<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=1注册一个-socket>1.注册一个 Socket
<a class=anchor href=#1%e6%b3%a8%e5%86%8c%e4%b8%80%e4%b8%aa-socket>#</a></h3><p>registerZygoteSocket 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>registerZygoteSocket</span><span style=color:#f92672>(</span>String socketName<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>sServerSocket <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> fileDesc<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> String fullSocketName <span style=color:#f92672>=</span> ANDROID_SOCKET_PREFIX <span style=color:#f92672>+</span> socketName<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            String env <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>getenv</span><span style=color:#f92672>(</span>fullSocketName<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            fileDesc <span style=color:#f92672>=</span> Integer<span style=color:#f92672>.</span><span style=color:#a6e22e>parseInt</span><span style=color:#f92672>(</span>env<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>RuntimeException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span>fullSocketName <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; unset or invalid&#34;</span><span style=color:#f92672>,</span> ex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            FileDescriptor fd <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FileDescriptor<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            fd<span style=color:#f92672>.</span><span style=color:#a6e22e>setInt$</span><span style=color:#f92672>(</span>fileDesc<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 创建 Socket 客户端
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            sServerSocket <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LocalServerSocket<span style=color:#f92672>(</span>fd<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;Error binding to local socket &#39;&#34;</span> <span style=color:#f92672>+</span> fileDesc <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39;&#34;</span><span style=color:#f92672>,</span> ex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=2预加载各类资源>2.预加载各类资源
<a class=anchor href=#2%e9%a2%84%e5%8a%a0%e8%bd%bd%e5%90%84%e7%b1%bb%e8%b5%84%e6%ba%90>#</a></h3><p>Preload 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>preload</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Log<span style=color:#f92672>.</span><span style=color:#a6e22e>d</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;begin preload&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>traceBegin</span><span style=color:#f92672>(</span>Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>TRACE_TAG_DALVIK</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;BeginIcuCachePinning&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    beginIcuCachePinning<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>traceEnd</span><span style=color:#f92672>(</span>Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>TRACE_TAG_DALVIK</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>traceBegin</span><span style=color:#f92672>(</span>Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>TRACE_TAG_DALVIK</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;PreloadClasses&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    preloadClasses<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>traceEnd</span><span style=color:#f92672>(</span>Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>TRACE_TAG_DALVIK</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>traceBegin</span><span style=color:#f92672>(</span>Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>TRACE_TAG_DALVIK</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;PreloadResources&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    preloadResources<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>traceEnd</span><span style=color:#f92672>(</span>Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>TRACE_TAG_DALVIK</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>traceBegin</span><span style=color:#f92672>(</span>Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>TRACE_TAG_DALVIK</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;PreloadOpenGL&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    preloadOpenGL<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>traceEnd</span><span style=color:#f92672>(</span>Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>TRACE_TAG_DALVIK</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    preloadSharedLibraries<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    preloadTextResources<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Ask the WebViewFactory to do any initialization that must run in the zygote process,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// for memory sharing purposes.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    WebViewFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>prepareWebViewInZygote</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    endIcuCachePinning<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    warmUpJcaProviders<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    Log<span style=color:#f92672>.</span><span style=color:#a6e22e>d</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;end preload&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=3启动-system_server-进程>3.启动 system_server 进程
<a class=anchor href=#3%e5%90%af%e5%8a%a8-system_server-%e8%bf%9b%e7%a8%8b>#</a></h3><p>startSystemServer 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>startSystemServer</span><span style=color:#f92672>(</span>String abiList<span style=color:#f92672>,</span> String socketName<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throws</span> MethodAndArgsCaller<span style=color:#f92672>,</span> RuntimeException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* Hardcoded command line to start the system server */</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// SystemServer 启动参数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    String args<span style=color:#f92672>[]</span> <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;--setuid=1000&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;--setgid=1000&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1032,3001,3002,3003,3006,3007,3009,3010&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;--capabilities=&#34;</span> <span style=color:#f92672>+</span> capabilities <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;,&#34;</span> <span style=color:#f92672>+</span> capabilities<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;--nice-name=system_server&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;--runtime-args&#34;</span><span style=color:#f92672>,</span> 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;com.android.server.SystemServer&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>    ZygoteConnection<span style=color:#f92672>.</span><span style=color:#a6e22e>Arguments</span> parsedArgs <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> pid<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        parsedArgs <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ZygoteConnection<span style=color:#f92672>.</span><span style=color:#a6e22e>Arguments</span><span style=color:#f92672>(</span>args<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        ZygoteConnection<span style=color:#f92672>.</span><span style=color:#a6e22e>applyDebuggerSystemProperty</span><span style=color:#f92672>(</span>parsedArgs<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        ZygoteConnection<span style=color:#f92672>.</span><span style=color:#a6e22e>applyInvokeWithSystemProperty</span><span style=color:#f92672>(</span>parsedArgs<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 调用 Zygote.java fock 出新线程，名字叫 system_server
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        pid <span style=color:#f92672>=</span> Zygote<span style=color:#f92672>.</span><span style=color:#a6e22e>forkSystemServer</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>uid</span><span style=color:#f92672>,</span> parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>gid</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>gids</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>debugFlags</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>permittedCapabilities</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>effectiveCapabilities</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IllegalArgumentException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span>ex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// pid 为 0 则为 fock 出来的子线程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>pid <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>hasSecondZygote<span style=color:#f92672>(</span>abiList<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            waitForSecondaryZygote<span style=color:#f92672>(</span>socketName<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 启动 SystemServer 进程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        handleSystemServerProcess<span style=color:#f92672>(</span>parsedArgs<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>首先，拼装启动参数——注意，最后一个选现 &ndash;runtime-args 的参数为 <strong>&ldquo;com.android.server.SystemServer&rdquo;</strong>，接着会调用 [frameworks/base/core/java/com/android/internal/os/Zygote.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/com/android/internal/os/Zygote.java) 的 forkSystemServer 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>forkSystemServer</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> uid<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> gid<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span><span style=color:#f92672>[]</span> gids<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> debugFlags<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span><span style=color:#f92672>[][]</span> rlimits<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> permittedCapabilities<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> effectiveCapabilities<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    VM_HOOKS<span style=color:#f92672>.</span><span style=color:#a6e22e>preFork</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 调用 Native 层的方法 fock 出子线程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> pid <span style=color:#f92672>=</span> nativeForkSystemServer<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            uid<span style=color:#f92672>,</span> gid<span style=color:#f92672>,</span> gids<span style=color:#f92672>,</span> debugFlags<span style=color:#f92672>,</span> rlimits<span style=color:#f92672>,</span> permittedCapabilities<span style=color:#f92672>,</span> effectiveCapabilities<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Enable tracing as soon as we enter the system_server.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>pid <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span><span style=color:#75715e>// fock 出来的子线程中执行
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>setTracingEnabled</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    VM_HOOKS<span style=color:#f92672>.</span><span style=color:#a6e22e>postForkCommon</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> pid<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>通过 nativeForkSystemServer 方法内部调用 nativeForkSystemServer 这个 Native 方法在当前进程中 fork 出一个子进程，随后这个进程会通过 handleSystemServerProcess() 方法来启动各种支撑系统运行的 system_server 进程。</p><h3 id=4开启循环循环等待-fork-进程请求>4.开启循环循环等待 fork 进程请求
<a class=anchor href=#4%e5%bc%80%e5%90%af%e5%be%aa%e7%8e%af%e5%be%aa%e7%8e%af%e7%ad%89%e5%be%85-fork-%e8%bf%9b%e7%a8%8b%e8%af%b7%e6%b1%82>#</a></h3><p>回头接着看 ZygoteInit.java 流程中的 runSelectLoop 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>runSelectLoop</span><span style=color:#f92672>(</span>String abiList<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> MethodAndArgsCaller <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    ArrayList<span style=color:#f92672>&lt;</span>FileDescriptor<span style=color:#f92672>&gt;</span> fds <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;</span>FileDescriptor<span style=color:#f92672>&gt;();</span>
</span></span><span style=display:flex><span>    ArrayList<span style=color:#f92672>&lt;</span>ZygoteConnection<span style=color:#f92672>&gt;</span> peers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;</span>ZygoteConnection<span style=color:#f92672>&gt;();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// sServerSocket 对象就是刚才在 registerZygoteSocket 方法中创建的服务端 Socket
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    fds<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>sServerSocket<span style=color:#f92672>.</span><span style=color:#a6e22e>getFileDescriptor</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    peers<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 循环读取状态
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        StructPollfd<span style=color:#f92672>[]</span> pollFds <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> StructPollfd<span style=color:#f92672>[</span>fds<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>()];</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> pollFds<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span> <span style=color:#f92672>++</span>i<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            pollFds<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> StructPollfd<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            pollFds<span style=color:#f92672>[</span>i<span style=color:#f92672>].</span><span style=color:#a6e22e>fd</span> <span style=color:#f92672>=</span> fds<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>i<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            pollFds<span style=color:#f92672>[</span>i<span style=color:#f92672>].</span><span style=color:#a6e22e>events</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>short</span><span style=color:#f92672>)</span> POLLIN<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Os<span style=color:#f92672>.</span><span style=color:#a6e22e>poll</span><span style=color:#f92672>(</span>pollFds<span style=color:#f92672>,</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>ErrnoException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;poll failed&#34;</span><span style=color:#f92672>,</span> ex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> pollFds<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> 1<span style=color:#f92672>;</span> i <span style=color:#f92672>&gt;=</span> 0<span style=color:#f92672>;</span> <span style=color:#f92672>--</span>i<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 读取的状态不是客户端连接或者数据请求时，进入下一次循环
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>pollFds<span style=color:#f92672>[</span>i<span style=color:#f92672>].</span><span style=color:#a6e22e>revents</span> <span style=color:#f92672>&amp;</span> POLLIN<span style=color:#f92672>)</span> <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>i <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span><span style=color:#75715e>// i = 0 表示跟客户端 Socket 连接上了
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                ZygoteConnection newPeer <span style=color:#f92672>=</span> acceptCommandPeer<span style=color:#f92672>(</span>abiList<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                peers<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>newPeer<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                fds<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>newPeer<span style=color:#f92672>.</span><span style=color:#a6e22e>getFileDesciptor</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span><span style=color:#75715e>// i &gt; 0 表示接收到客户端 Socket 发送过来的请求
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// runOnce 方法创建一个新的应用程序进程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>boolean</span> done <span style=color:#f92672>=</span> peers<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>i<span style=color:#f92672>).</span><span style=color:#a6e22e>runOnce</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>done<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    peers<span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>(</span>i<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    fds<span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>(</span>i<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>runSelectLoop 方法的主体是一个 while 死循环，这决定了它作为 zygote 的守护体存在。</p><p>[frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/com/android/internal/os/ZygoteConnection.java) 的 runOnce 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>runOnce</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> ZygoteInit<span style=color:#f92672>.</span><span style=color:#a6e22e>MethodAndArgsCaller</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    String args<span style=color:#f92672>[];</span>
</span></span><span style=display:flex><span>    Arguments parsedArgs <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    FileDescriptor<span style=color:#f92672>[]</span> descriptors<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 读取 socket 客户端发送过来的参数列表
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        args <span style=color:#f92672>=</span> readArgumentList<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        descriptors <span style=color:#f92672>=</span> mSocket<span style=color:#f92672>.</span><span style=color:#a6e22e>getAncillaryFileDescriptors</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// EOF reached.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        closeSocket<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 将 socket 客户端传递过来的参数，解析成 Arguments 对象格式
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        parsedArgs <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Arguments<span style=color:#f92672>(</span>args<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 调用 forkAndSpecialize 方法 fock 出子进程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        pid <span style=color:#f92672>=</span> Zygote<span style=color:#f92672>.</span><span style=color:#a6e22e>forkAndSpecialize</span><span style=color:#f92672>(</span>parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>uid</span><span style=color:#f92672>,</span> parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>gid</span><span style=color:#f92672>,</span> parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>gids</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>debugFlags</span><span style=color:#f92672>,</span> rlimits<span style=color:#f92672>,</span> parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>mountExternal</span><span style=color:#f92672>,</span> parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>seInfo</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>niceName</span><span style=color:#f92672>,</span> fdsToClose<span style=color:#f92672>,</span> parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>instructionSet</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>appDataDir</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>pid <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 子进程执行
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            IoUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>closeQuietly</span><span style=color:#f92672>(</span>serverPipeFd<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            serverPipeFd <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 进入子进程流程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            handleChildProc<span style=color:#f92672>(</span>parsedArgs<span style=color:#f92672>,</span> descriptors<span style=color:#f92672>,</span> childPipeFd<span style=color:#f92672>,</span> newStderr<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 父进程执行
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            IoUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>closeQuietly</span><span style=color:#f92672>(</span>childPipeFd<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            childPipeFd <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> handleParentProc<span style=color:#f92672>(</span>pid<span style=color:#f92672>,</span> descriptors<span style=color:#f92672>,</span> serverPipeFd<span style=color:#f92672>,</span> parsedArgs<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        IoUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>closeQuietly</span><span style=color:#f92672>(</span>childPipeFd<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        IoUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>closeQuietly</span><span style=color:#f92672>(</span>serverPipeFd<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>当收到 fork 请求时，首先获取从 socket 客户端传入的参数并存入 parsedArgs 变量，接着在代码块 25 行调用的是
<a href=https://android.googlesource.com/platform/frameworks/base/+/nougat-release/core/java/com/android/internal/os/Zygote.java rel=noopener>Zygote.java</a> 的 forkAndSpecialize() 方法来 fork 出子进程，从这里开始一分为二，父进程和子进程继续往下执行。</p><h3 id=5子进程执行入口函数>5.子进程执行入口函数
<a class=anchor href=#5%e5%ad%90%e8%bf%9b%e7%a8%8b%e6%89%a7%e8%a1%8c%e5%85%a5%e5%8f%a3%e5%87%bd%e6%95%b0>#</a></h3><p>pid==0 表示为子进程这个分支，接着会执行 handleChildProc() 方法并将 parsedArgs 传入：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handleChildProc</span><span style=color:#f92672>(</span>Arguments parsedArgs<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        FileDescriptor<span style=color:#f92672>[]</span> descriptors<span style=color:#f92672>,</span> FileDescriptor pipeFd<span style=color:#f92672>,</span> PrintStream newStderr<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throws</span> ZygoteInit<span style=color:#f92672>.</span><span style=color:#a6e22e>MethodAndArgsCaller</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>     <span style=color:#75715e>// 关闭 socket
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>     closeSocket<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>     ZygoteInit<span style=color:#f92672>.</span><span style=color:#a6e22e>closeServerSocket</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>     
</span></span><span style=display:flex><span>     <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>     
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>niceName</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Process<span style=color:#f92672>.</span><span style=color:#a6e22e>setArgV0</span><span style=color:#f92672>(</span>parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>niceName</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// End of the postFork event.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>traceEnd</span><span style=color:#f92672>(</span>Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>TRACE_TAG_ACTIVITY_MANAGER</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>invokeWith</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        WrapperInit<span style=color:#f92672>.</span><span style=color:#a6e22e>execApplication</span><span style=color:#f92672>(</span>parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>invokeWith</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>niceName</span><span style=color:#f92672>,</span> parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>targetSdkVersion</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                VMRuntime<span style=color:#f92672>.</span><span style=color:#a6e22e>getCurrentInstructionSet</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>                pipeFd<span style=color:#f92672>,</span> parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>remainingArgs</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        RuntimeInit<span style=color:#f92672>.</span><span style=color:#a6e22e>zygoteInit</span><span style=color:#f92672>(</span>parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>targetSdkVersion</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>remainingArgs</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span> <span style=color:#75715e>/* classLoader */</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>由于子进程 fork 自 zygote，因此也复制了 zygote 进程的地址空间，因此也会得到 zygote 进程创建的 socket，而这个 socket 对于子进程是无用的，因此需要关闭该 socket。</p><p>接着在最后会调用 RuntimeInit 的 zygoteInit 方法并传入 parsedArgs.remainingArgs。这里先不看 zygoteInit 的内容，但是可以剧透一下：后面的一系列流程概括起来就是找到并执行目标进程的入口函数，并执行它的 main 函数。</p><h3 id=6番外socket-客户端发送创建进程请求>6.番外：Socket 客户端发送创建进程请求
<a class=anchor href=#6%e7%95%aa%e5%a4%96socket-%e5%ae%a2%e6%88%b7%e7%ab%af%e5%8f%91%e9%80%81%e5%88%9b%e5%bb%ba%e8%bf%9b%e7%a8%8b%e8%af%b7%e6%b1%82>#</a></h3><p>应用程序启动时，必须要启动一个进程用于承载这个应用，而向 zygote 进程发送 fork 进程请求的则是 ActivityManagerService，简称 AMS：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>startProcessLocked</span><span style=color:#f92672>(</span>ProcessRecord app<span style=color:#f92672>,</span> String hostingType<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            String hostingNameStr<span style=color:#f92672>,</span> String abiOverride<span style=color:#f92672>,</span> String entryPoint<span style=color:#f92672>,</span> String<span style=color:#f92672>[]</span> entryPointArgs<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Start the process.  It will either succeed and return a result containing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// the PID of the new process, or else throw a RuntimeException.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>boolean</span> isActivityProcess <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>entryPoint <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>entryPoint <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> entryPoint <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;android.app.ActivityThread&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>traceBegin</span><span style=color:#f92672>(</span>Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>TRACE_TAG_ACTIVITY_MANAGER</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Start proc: &#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                app<span style=color:#f92672>.</span><span style=color:#a6e22e>processName</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        checkTime<span style=color:#f92672>(</span>startTime<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;startProcess: asking zygote to start proc&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        Process<span style=color:#f92672>.</span><span style=color:#a6e22e>ProcessStartResult</span> startResult <span style=color:#f92672>=</span> Process<span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>(</span>entryPoint<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                app<span style=color:#f92672>.</span><span style=color:#a6e22e>processName</span><span style=color:#f92672>,</span> uid<span style=color:#f92672>,</span> uid<span style=color:#f92672>,</span> gids<span style=color:#f92672>,</span> debugFlags<span style=color:#f92672>,</span> mountExternal<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                app<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>.</span><span style=color:#a6e22e>targetSdkVersion</span><span style=color:#f92672>,</span> app<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>.</span><span style=color:#a6e22e>seinfo</span><span style=color:#f92672>,</span> requiredAbi<span style=color:#f92672>,</span> instructionSet<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                app<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>.</span><span style=color:#a6e22e>dataDir</span><span style=color:#f92672>,</span> entryPointArgs<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        checkTime<span style=color:#f92672>(</span>startTime<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;startProcess: returned from zygote!&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>traceEnd</span><span style=color:#f92672>(</span>Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>TRACE_TAG_ACTIVITY_MANAGER</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>RuntimeException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到，Process.start 方法显示就是去启动一个新的进程以承载业务，而第一个参数 entryPoint 经过兜兜转转最终就是 invokeStaticMain() 方法的 className 参数，entryPoint 的默认值为 &ldquo;android.app.ActivityThread&rdquo;。</p><p>也就是说，zygote 进程在接到 AMS 请求的时候，会 fork 出一个子进程并且将 ActivityThread 作为入口，而 ActivityThread 就是我们熟知的 Android 应用程序的“主线程”：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>traceBegin</span><span style=color:#f92672>(</span>Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>TRACE_TAG_ACTIVITY_MANAGER</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;ActivityThreadMain&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    Looper<span style=color:#f92672>.</span><span style=color:#a6e22e>prepareMainLooper</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    ActivityThread thread <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ActivityThread<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    thread<span style=color:#f92672>.</span><span style=color:#a6e22e>attach</span><span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>sMainThreadHandler <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        sMainThreadHandler <span style=color:#f92672>=</span> thread<span style=color:#f92672>.</span><span style=color:#a6e22e>getHandler</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Looper<span style=color:#f92672>.</span><span style=color:#a6e22e>myLooper</span><span style=color:#f92672>().</span><span style=color:#a6e22e>setMessageLogging</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span>
</span></span><span style=display:flex><span>                LogPrinter<span style=color:#f92672>(</span>Log<span style=color:#f92672>.</span><span style=color:#a6e22e>DEBUG</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;ActivityThread&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// End of event ActivityThreadMain.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>traceEnd</span><span style=color:#f92672>(</span>Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>TRACE_TAG_ACTIVITY_MANAGER</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    Looper<span style=color:#f92672>.</span><span style=color:#a6e22e>loop</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Main thread loop unexpectedly exited&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=小结>小结
<a class=anchor href=#%e5%b0%8f%e7%bb%93>#</a></h2><p>从 App_main 开始，zygote 启动过程的时序图如下：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/System-Boot/clipboard_20230323_045226.png width=auto alt></p><p>可以看到，这个过程中 zygote 首先启动了 AndroidRuntime 并通过它反射调用了 ZygoteInit.main() 方法，由此进入了 Java 的世界，因此 zygote 是 Java 层的第一个进程，也是其他 Java 进程的始祖，其他 Java 进程的创建必须依赖 zygote。</p><p>zygote 进程的任务分别是：</p><ol><li>创建 AppRuntime（继承自 AndroidRuntime）， 并调用它的 <strong>start</strong> 方法</li><li>调用 AndroidRuntime 的 <strong>startVM()</strong> 方法创建 DVM（Dalvik Virtual Machine），并调用 <strong>startReg()</strong> 方法为 DVM 注册 JNI</li><li>通过 JNI 调用 <strong>ZygoteInit.main()</strong> 方法，第一次进入 Java 的世界</li><li>调用 <strong>registerZygoteSocket()</strong> 函数建立 Socket 通道，使 zygote 进程成为 Socket 服务端</li><li>调用 <strong>preload()</strong> 方法预加载各种资源</li><li>调用 <strong>startSystemServer()</strong> 函数 fock 出 system_server 进程</li><li>通过 <strong>runSelectLoop()</strong> 函数等待 ActivityManagerService 发送请求创建新的应用程序进程</li></ol><h1 id=system_server-进程--承载-framework-层核心业务>system_server 进程 —— 承载 framework 层核心业务
<a class=anchor href=#system_server-%e8%bf%9b%e7%a8%8b--%e6%89%bf%e8%bd%bd-framework-%e5%b1%82%e6%a0%b8%e5%bf%83%e4%b8%9a%e5%8a%a1>#</a></h1><p>system_server 进程主要用户创建系统服务，framework 层的 AMS、WMS 和 PMS 等关键服务都是由它创建出来的。</p><p>在上一小节中我们已经知道，zygote 进程在启动的过程中会通过 startSystemServer 方法 fock 出了一个叫 system_server 的进程，然后在该方法内执行了 handleSystemServerProcess 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handleSystemServerProcess</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>          ZygoteConnection<span style=color:#f92672>.</span><span style=color:#a6e22e>Arguments</span> parsedArgs<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>throws</span> ZygoteInit<span style=color:#f92672>.</span><span style=color:#a6e22e>MethodAndArgsCaller</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 这个 Socket 对 system_server 来说同样无用处，这里将其关闭 **/</span>
</span></span><span style=display:flex><span>    closeServerSocket<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>invokeWith</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        ClassLoader cl <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>systemServerClasspath <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            cl <span style=color:#f92672>=</span> createSystemServerClassLoader<span style=color:#f92672>(</span>systemServerClasspath<span style=color:#f92672>,</span> parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>targetSdkVersion</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>setContextClassLoader</span><span style=color:#f92672>(</span>cl<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 又是调用了它的 zygoteInit 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        RuntimeInit<span style=color:#f92672>.</span><span style=color:#a6e22e>zygoteInit</span><span style=color:#f92672>(</span>parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>targetSdkVersion</span><span style=color:#f92672>,</span> parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>remainingArgs</span><span style=color:#f92672>,</span> cl<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这里再次出现了
<a href=https://android.googlesource.com/platform/frameworks/base/+/nougat-release/core/java/com/android/internal/os/RuntimeInit.java rel=noopener>RuntimeInit</a>.zygoteInit() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>zygoteInit</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> targetSdkVersion<span style=color:#f92672>,</span> String<span style=color:#f92672>[]</span> argv<span style=color:#f92672>,</span> ClassLoader classLoader<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throws</span> ZygoteInit<span style=color:#f92672>.</span><span style=color:#a6e22e>MethodAndArgsCaller</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>DEBUG<span style=color:#f92672>)</span> Slog<span style=color:#f92672>.</span><span style=color:#a6e22e>d</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;RuntimeInit: Starting application from zygote&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>traceBegin</span><span style=color:#f92672>(</span>Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>TRACE_TAG_ACTIVITY_MANAGER</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;RuntimeInit&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    redirectLogStreams<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    commonInit<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 通过 Native 层中 AndroidRuntime.cpp 的 JNI 方法最终调用 app_main.cpp 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 的 onZygoteInit 方法启动 Binder 线程池， 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 使 system_server 进程可以使用 Binder 与其他进程通信 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    nativeZygoteInit<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 继续往下调用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    applicationInit<span style=color:#f92672>(</span>targetSdkVersion<span style=color:#f92672>,</span> argv<span style=color:#f92672>,</span> classLoader<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>顾名思义，这是一个初始化方法，它将通过三个方面来完成初始化。</p><p>首先是 commonInit，通用部分的初始化，包括设置默认的 uncaught exception handler、为 HttpURLConnection 准备好默认的 HTTP User-Agent 等；接着，nativeZygoteInit() 这个是一个 Native 层的初始化方法；最后是 applicatInit()，它是程序运行的起点。</p><p>经过这两个过程的初始化后，程序现在会出现两个分支：nativeZygoteInit 主导的 Native 层系统服务启动，以及 applicationInit 负责的 Java 层系统服务的启动。</p><h2 id=1启动-native-层系统服务>1.启动 Native 层系统服务
<a class=anchor href=#1%e5%90%af%e5%8a%a8-native-%e5%b1%82%e7%b3%bb%e7%bb%9f%e6%9c%8d%e5%8a%a1>#</a></h2><p>nativeZygoteInit() 是一个 Native 方法，它对应的文件为 [frameworks/base/core/jni/AndroidRuntime.cpp](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/jni/AndroidRuntime.cpp)，与该方法对应的函数为：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>com_android_internal_os_RuntimeInit_nativeZygoteInit</span>(JNIEnv<span style=color:#f92672>*</span> env, jobject clazz)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    gCurRuntime<span style=color:#f92672>-&gt;</span>onZygoteInit();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>gCurRuntime 是一个 AndroidRuntime 对象全局变量，结合之前的分析可以猜测，AndroidRuntime 是一个父类，真正的实现则在 [frameworks/base/cmds/app_process/app_main.cpp](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/cmds/app_process/app_main.cpp) 中的 AppRuntime 。当新建 AppRuntime 实例时，它的父类构造函数就会被调用并为 gCurRuntime 赋值。上述的 onZygoteInit() 方法也在 app_main 中：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>virtual</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onZygoteInit</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    sp<span style=color:#f92672>&lt;</span>ProcessState<span style=color:#f92672>&gt;</span> proc <span style=color:#f92672>=</span> ProcessState<span style=color:#f92672>::</span>self();
</span></span><span style=display:flex><span>    ALOGV(<span style=color:#e6db74>&#34;App process: starting thread pool.</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    proc<span style=color:#f92672>-&gt;</span>startThreadPool();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这段代码是 Binder 机制中的重要组成部分，其中 startThreadPool() 方法将开启 Binder 线程池以保证其它线程可以正确访问到 Zygote 启动的服务。Zygote 通过 JNI 和回调的方式非常巧妙地把 Native 层和 Java 层、SystemServe 和 app_process 关联起来了。</p><h2 id=2启动-java-层系统服务>2.启动 Java 层系统服务
<a class=anchor href=#2%e5%90%af%e5%8a%a8-java-%e5%b1%82%e7%b3%bb%e7%bb%9f%e6%9c%8d%e5%8a%a1>#</a></h2><p>接着看 RuntimeInit 的 applicationInit() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>applicationInit</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> targetSdkVersion<span style=color:#f92672>,</span> String<span style=color:#f92672>[]</span> argv<span style=color:#f92672>,</span> ClassLoader classLoader<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throws</span> ZygoteInit<span style=color:#f92672>.</span><span style=color:#a6e22e>MethodAndArgsCaller</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    invokeStaticMain<span style=color:#f92672>(</span>args<span style=color:#f92672>.</span><span style=color:#a6e22e>startClass</span><span style=color:#f92672>,</span> args<span style=color:#f92672>.</span><span style=color:#a6e22e>startArgs</span><span style=color:#f92672>,</span> classLoader<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>RuntimeInit 的 invokeStaticMain 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>invokeStaticMain</span><span style=color:#f92672>(</span>String className<span style=color:#f92672>,</span> String<span style=color:#f92672>[]</span> argv<span style=color:#f92672>,</span> ClassLoader classLoader<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>throws</span> ZygoteInit<span style=color:#f92672>.</span><span style=color:#a6e22e>MethodAndArgsCaller</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Class<span style=color:#f92672>&lt;?&gt;</span> cl<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>/** className 为 ZygoteInit.java 中 startSystemServer 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e>        传递过来的 &#34;com.android.server.SystemServer&#34;，这里通过反射得到 SystemServer 类 **/</span>
</span></span><span style=display:flex><span>        cl <span style=color:#f92672>=</span> Class<span style=color:#f92672>.</span><span style=color:#a6e22e>forName</span><span style=color:#f92672>(</span>className<span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> classLoader<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>ClassNotFoundException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Missing class when invoking static main &#34;</span> <span style=color:#f92672>+</span> className<span style=color:#f92672>,</span> ex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    Method m<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 找到 SystemServer 类的 main 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        m <span style=color:#f92672>=</span> cl<span style=color:#f92672>.</span><span style=color:#a6e22e>getMethod</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;main&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Class<span style=color:#f92672>[]</span> <span style=color:#f92672>{</span> String<span style=color:#f92672>[].</span><span style=color:#a6e22e>class</span> <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>NoSuchMethodException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Missing static main on &#34;</span> <span style=color:#f92672>+</span> className<span style=color:#f92672>,</span> ex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>SecurityException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Problem getting static main on &#34;</span> <span style=color:#f92672>+</span> className<span style=color:#f92672>,</span> ex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> modifiers <span style=color:#f92672>=</span> m<span style=color:#f92672>.</span><span style=color:#a6e22e>getModifiers</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span> <span style=color:#f92672>(</span>Modifier<span style=color:#f92672>.</span><span style=color:#a6e22e>isStatic</span><span style=color:#f92672>(</span>modifiers<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span> Modifier<span style=color:#f92672>.</span><span style=color:#a6e22e>isPublic</span><span style=color:#f92672>(</span>modifiers<span style=color:#f92672>)))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Main method is not public and static on &#34;</span> <span style=color:#f92672>+</span> className<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 将 main 方法包装在 ZygoteInit.MethodAndArgsCaller 类中并作为异常抛出
</span></span></span><span style=display:flex><span><span style=color:#75715e>    捕获异常的地方在上一小节中 ZygoteInit.java 的 main 方法 **/</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ZygoteInit<span style=color:#f92672>.</span><span style=color:#a6e22e>MethodAndArgsCaller</span><span style=color:#f92672>(</span>m<span style=color:#f92672>,</span> argv<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>结合注释内容来看捕获这个异常的 [frameworks/base/core/java/com/android/internal/os/ZygoteInit.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/com/android/internal/os/ZygoteInit.java) 的 main 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String argv<span style=color:#f92672>[])</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    closeServerSocket<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>MethodAndArgsCaller caller<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 接收到 caller 对象后调用它的 run 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        caller<span style=color:#f92672>.</span><span style=color:#a6e22e>run</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>RuntimeException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Log<span style=color:#f92672>.</span><span style=color:#a6e22e>e</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Zygote died with exception&#34;</span><span style=color:#f92672>,</span> ex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        closeServerSocket<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> ex<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>ZygoteInit 的 MethodAndArgsCaller 类是一个 Exception 类，同时也实现了 Runnable 接口：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MethodAndArgsCaller</span> <span style=color:#66d9ef>extends</span> Exception
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>implements</span> Runnable <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Method mMethod<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> String<span style=color:#f92672>[]</span> mArgs<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>MethodAndArgsCaller</span><span style=color:#f92672>(</span>Method method<span style=color:#f92672>,</span> String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        mMethod <span style=color:#f92672>=</span> method<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        mArgs <span style=color:#f92672>=</span> args<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 调用传递过来的 mMethod
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            mMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>invoke</span><span style=color:#f92672>(</span><span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Object<span style=color:#f92672>[]</span> <span style=color:#f92672>{</span> mArgs <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IllegalAccessException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span>ex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InvocationTargetException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这样，system_server 进程便启动起来并进入了 SystemServer.java 的 main 方法。</p><p>这里需要思考一下，为什么需要抛出异常到 ZygoteInit 中执行？官方解释就是抛出异常的时候 Android 虚拟机会清空该进程堆内存中的栈帧，因此前面一系列启动 system_server 进程的过程中方法调用过程就被清除了，节省了堆栈的空间，使 ZygoteInit.java 的 main 方法处于所有 Java 进程的方法栈中的栈顶。</p><p>同样地，zygote 进程接收到 AMS 请求并创建进程后，也会执行 ActivityThread 的 main 方法并将其作为 app 进程方法栈中的栈顶。</p><blockquote><p>从最新 Android Pie 的代码中看，[ZygoteInit](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /pie-release/core/java/com/android/internal/os/ZygoteInit.java) 中的这个过程从 forkSystemServer() 方法开始，以及 runSelectLoop() 方法，已经变成在每一步中将包装好的 MethodAndArgsCaller 对象作为返回值返回，最后再执行这个对象的 call 方法，这样每个方法都在返回过程被弹出栈帧了，同样达到了以上的效果。</p></blockquote><p>查看 [frameworks/base/services/java/com/android/server/SystemServer.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/services/java/com/android/server/SystemServer.java) 的源码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * The main entry point from zygote.
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 调用 run 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>new</span> SystemServer<span style=color:#f92672>().</span><span style=color:#a6e22e>run</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 加载 libandroid_servers.so
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    System<span style=color:#f92672>.</span><span style=color:#a6e22e>loadLibrary</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;android_servers&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 创建 SystemServiceManager
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    mSystemServiceManager <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SystemServiceManager<span style=color:#f92672>(</span>mSystemContext<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    LocalServices<span style=color:#f92672>.</span><span style=color:#a6e22e>addService</span><span style=color:#f92672>(</span>SystemServiceManager<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> mSystemServiceManager<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>traceBegin</span><span style=color:#f92672>(</span>Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>TRACE_TAG_SYSTEM_SERVER</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;StartServices&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 启动引导服务
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        startBootstrapServices<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 启动核心服务
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        startCoreServices<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 启动其他服务
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        startOtherServices<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Throwable ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>traceEnd</span><span style=color:#f92672>(</span>Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>TRACE_TAG_SYSTEM_SERVER</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到，在 run 方法中，主要执行了启动引导服务、核心服务和其他服务的任务，这些服务加起来一共有 80 多个，它们对应这个各种不同的功能，部分服务如下：</p><table><thead><tr><th>引导服务</th><th>作用</th></tr></thead><tbody><tr><td>Installer</td><td>系统安装 apk 时的一个服务类，启动完成 Installer 服务之后才能启动其他的系统服务</td></tr><tr><td>ActivityManagerService</td><td>负责四大组件的启动、切换、调度。</td></tr><tr><td>PowerManagerService</td><td>计算系统中和 Power 相关的计算，然后决策系统应该如何反应</td></tr><tr><td>LightsService</td><td>管理和显示背光 LED</td></tr><tr><td>DisplayManagerService</td><td>用来管理所有显示设备</td></tr><tr><td>UserManagerService</td><td>多用户模式管理</td></tr><tr><td>SensorService</td><td>为系统提供各种感应器服务</td></tr><tr><td>PackageManagerService</td><td>用来对 apk 进行安装、解析、删除、卸载等等操作</td></tr></tbody></table><table><thead><tr><th>核心服务</th><th>作用</th></tr></thead><tbody><tr><td>BatteryService</td><td>管理电池相关的服务</td></tr><tr><td>UsageStatsService</td><td>收集用户使用每一个 APP 的频率、使用时常</td></tr><tr><td>WebViewUpdateService</td><td>WebView 更新服务</td></tr></tbody></table><table><thead><tr><th>其他服务</th><th>作用</th></tr></thead><tbody><tr><td>CameraService</td><td>摄像头相关服务</td></tr><tr><td>AlarmManagerService</td><td>全局定时器管理服务</td></tr><tr><td>InputManagerService</td><td>管理输入事件</td></tr><tr><td>WindowManagerService</td><td>窗口管理服务</td></tr><tr><td>VrManagerService</td><td>VR 模式管理服务</td></tr><tr><td>BluetoothService</td><td>蓝牙管理服务</td></tr><tr><td>NotificationManagerService</td><td>通知管理服务</td></tr><tr><td>DeviceStorageMonitorService</td><td>存储相关管理服务</td></tr><tr><td>LocationManagerService</td><td>定位管理服务</td></tr><tr><td>AudioService</td><td>音频相关管理服务</td></tr><tr><td>&mldr;</td><td>&mldr;</td></tr></tbody></table><h2 id=小结-1>小结
<a class=anchor href=#%e5%b0%8f%e7%bb%93-1>#</a></h2><p>system_server 进程在启动过程中完成的工作分别是:</p><ol><li>通用部分的初始化</li><li>启动 Binder 线程池，使进程可以通过 Binder 与其他进程进程通信</li><li>创建 SystemServiceManager</li><li>使用 SystemServiceManager 对各种系统服务进行创建、启动和生命周期管理</li></ol><h1 id=launcher--android-系统的桌面>Launcher —— Android 系统的“桌面”
<a class=anchor href=#launcher--android-%e7%b3%bb%e7%bb%9f%e7%9a%84%e6%a1%8c%e9%9d%a2>#</a></h1><p>在上一节 [frameworks/base/services/java/com/android/server/SystemServer.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/services/java/com/android/server/SystemServer.java) 的 main 方法中，有一句：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>startOtherServices</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 调用 AMS 的 systemReady 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    mActivityManagerService<span style=color:#f92672>.</span><span style=color:#a6e22e>systemReady</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Runnable<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>继续跟踪：</p><p>[frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/services/core/java/com/android/server/am/ActivityManagerService.java)：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>systemReady</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> Runnable goingCallback<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 调用 ActivityStackSupervisor 的 resumeFocusedStackTopActivityLocked 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        mStackSupervisor<span style=color:#f92672>.</span><span style=color:#a6e22e>resumeFocusedStackTopActivityLocked</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        mUserController<span style=color:#f92672>.</span><span style=color:#a6e22e>sendUserSwitchBroadcastsLocked</span><span style=color:#f92672>(-</span>1<span style=color:#f92672>,</span> currentUserId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>[frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/services/core/java/com/android/server/am/ActivityStackSupervisor.java)：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>resumeFocusedStackTopActivityLocked</span><span style=color:#f92672>(</span>ActivityStack targetStack<span style=color:#f92672>,</span> ActivityRecord target<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        ActivityOptions targetOptions<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>targetStack <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> isFocusedStack<span style=color:#f92672>(</span>targetStack<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 调用 ActivityStack 的 resumeTopActivityUncheckedLocked 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> targetStack<span style=color:#f92672>.</span><span style=color:#a6e22e>resumeTopActivityUncheckedLocked</span><span style=color:#f92672>(</span>target<span style=color:#f92672>,</span> targetOptions<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> ActivityRecord r <span style=color:#f92672>=</span> mFocusedStack<span style=color:#f92672>.</span><span style=color:#a6e22e>topRunningActivityLocked</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>r <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>state</span> <span style=color:#f92672>!=</span> RESUMED<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        mFocusedStack<span style=color:#f92672>.</span><span style=color:#a6e22e>resumeTopActivityUncheckedLocked</span><span style=color:#f92672>(</span><span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>[ActivityStack](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/services/core/java/com/android/server/am/ActivityStack.java)：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>resumeTopActivityUncheckedLocked</span><span style=color:#f92672>(</span>ActivityRecord prev<span style=color:#f92672>,</span> ActivityOptions options<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mStackSupervisor<span style=color:#f92672>.</span><span style=color:#a6e22e>inResumeTopActivity</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> result <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Protect against recursion.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        mStackSupervisor<span style=color:#f92672>.</span><span style=color:#a6e22e>inResumeTopActivity</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mService<span style=color:#f92672>.</span><span style=color:#a6e22e>mLockScreenShown</span> <span style=color:#f92672>==</span> ActivityManagerService<span style=color:#f92672>.</span><span style=color:#a6e22e>LOCK_SCREEN_LEAVING</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            mService<span style=color:#f92672>.</span><span style=color:#a6e22e>mLockScreenShown</span> <span style=color:#f92672>=</span> ActivityManagerService<span style=color:#f92672>.</span><span style=color:#a6e22e>LOCK_SCREEN_HIDDEN</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            mService<span style=color:#f92672>.</span><span style=color:#a6e22e>updateSleepIfNeededLocked</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 调用 resumeTopActivityInnerLocked 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        result <span style=color:#f92672>=</span> resumeTopActivityInnerLocked<span style=color:#f92672>(</span>prev<span style=color:#f92672>,</span> options<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        mStackSupervisor<span style=color:#f92672>.</span><span style=color:#a6e22e>inResumeTopActivity</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>resumeTopActivityInnerLocked</span><span style=color:#f92672>(</span>ActivityRecord prev<span style=color:#f92672>,</span> ActivityOptions options<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>   <span style=color:#75715e>// 回到 ActivityStackSupervisor 的 resumeHomeStackTask 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#66d9ef>return</span> isOnHomeDisplay<span style=color:#f92672>()</span> <span style=color:#f92672>&amp;&amp;</span> mStackSupervisor<span style=color:#f92672>.</span><span style=color:#a6e22e>resumeHomeStackTask</span><span style=color:#f92672>(</span>returnTaskType<span style=color:#f92672>,</span> prev<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;prevFinished&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>...</span>                 
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>[frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/services/core/java/com/android/server/am/ActivityStackSupervisor.java)：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>resumeHomeStackTask</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> homeStackTaskType<span style=color:#f92672>,</span> ActivityRecord prev<span style=color:#f92672>,</span> String reason<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>r <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>r<span style=color:#f92672>.</span><span style=color:#a6e22e>finishing</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        mService<span style=color:#f92672>.</span><span style=color:#a6e22e>setFocusedActivityLocked</span><span style=color:#f92672>(</span>r<span style=color:#f92672>,</span> myReason<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> resumeFocusedStackTopActivityLocked<span style=color:#f92672>(</span>mHomeStack<span style=color:#f92672>,</span> prev<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 再次回到 AMS 的 startHomeActivityLocked 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> mService<span style=color:#f92672>.</span><span style=color:#a6e22e>startHomeActivityLocked</span><span style=color:#f92672>(</span>mCurrentUser<span style=color:#f92672>,</span> myReason<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>startHomeActivityLocked</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> userId<span style=color:#f92672>,</span> String reason<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mFactoryTest <span style=color:#f92672>==</span> FactoryTest<span style=color:#f92672>.</span><span style=color:#a6e22e>FACTORY_TEST_LOW_LEVEL</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&amp;&amp;</span> mTopAction <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取 Intent
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Intent intent <span style=color:#f92672>=</span> getHomeIntent<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    ActivityInfo aInfo <span style=color:#f92672>=</span> resolveActivityInfo<span style=color:#f92672>(</span>intent<span style=color:#f92672>,</span> STOCK_PM_FLAGS<span style=color:#f92672>,</span> userId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>aInfo <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        intent<span style=color:#f92672>.</span><span style=color:#a6e22e>setComponent</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> ComponentName<span style=color:#f92672>(</span>aInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>applicationInfo</span><span style=color:#f92672>.</span><span style=color:#a6e22e>packageName</span><span style=color:#f92672>,</span> aInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>name</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        aInfo <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ActivityInfo<span style=color:#f92672>(</span>aInfo<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        aInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>applicationInfo</span> <span style=color:#f92672>=</span> getAppInfoForUser<span style=color:#f92672>(</span>aInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>applicationInfo</span><span style=color:#f92672>,</span> userId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        ProcessRecord app <span style=color:#f92672>=</span> getProcessRecordLocked<span style=color:#f92672>(</span>aInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>processName</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                aInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>applicationInfo</span><span style=color:#f92672>.</span><span style=color:#a6e22e>uid</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>app <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> app<span style=color:#f92672>.</span><span style=color:#a6e22e>instrumentationClass</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            intent<span style=color:#f92672>.</span><span style=color:#a6e22e>setFlags</span><span style=color:#f92672>(</span>intent<span style=color:#f92672>.</span><span style=color:#a6e22e>getFlags</span><span style=color:#f92672>()</span> <span style=color:#f92672>|</span> Intent<span style=color:#f92672>.</span><span style=color:#a6e22e>FLAG_ACTIVITY_NEW_TASK</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 使用 mActivityStarter 启动 app，这里不再详细跟踪
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            mActivityStarter<span style=color:#f92672>.</span><span style=color:#a6e22e>startHomeActivityLocked</span><span style=color:#f92672>(</span>intent<span style=color:#f92672>,</span> aInfo<span style=color:#f92672>,</span> reason<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Slog<span style=color:#f92672>.</span><span style=color:#a6e22e>wtf</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;No home screen found for &#34;</span> <span style=color:#f92672>+</span> intent<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Throwable<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>getHomeIntent 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Intent <span style=color:#a6e22e>getHomeIntent</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Intent intent <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Intent<span style=color:#f92672>(</span>mTopAction<span style=color:#f92672>,</span> mTopData <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> Uri<span style=color:#f92672>.</span><span style=color:#a6e22e>parse</span><span style=color:#f92672>(</span>mTopData<span style=color:#f92672>)</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    intent<span style=color:#f92672>.</span><span style=color:#a6e22e>setComponent</span><span style=color:#f92672>(</span>mTopComponent<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    intent<span style=color:#f92672>.</span><span style=color:#a6e22e>addFlags</span><span style=color:#f92672>(</span>Intent<span style=color:#f92672>.</span><span style=color:#a6e22e>FLAG_DEBUG_TRIAGED_MISSING</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mFactoryTest <span style=color:#f92672>!=</span> FactoryTest<span style=color:#f92672>.</span><span style=color:#a6e22e>FACTORY_TEST_LOW_LEVEL</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 添加 android.intent.category.HOME
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        intent<span style=color:#f92672>.</span><span style=color:#a6e22e>addCategory</span><span style=color:#f92672>(</span>Intent<span style=color:#f92672>.</span><span style=color:#a6e22e>CATEGORY_HOME</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> intent<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到，最后通过一个隐式 Intent 使用 Intent.FLAG_ACTIVITY_NEW_TASK 模式启动了一个带 Intent.CATEGORY_HOME 标签的 Activity，而带有 Intent.CATEGORY_HOME 标签的 Activity 正是 Launcher App，它的 [AndroidManifest](
<a href=https://android.googlesource.com/platform/packages/apps/Launcher3/ rel=noopener>https://android.googlesource.com/platform/packages/apps/Launcher3/</a> /nougat-release/AndroidManifest.xml?autodive=0) 文件如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;manifest</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>xmlns:android=</span><span style=color:#e6db74>&#34;http://schemas.android.com/apk/res/android&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>package=</span><span style=color:#e6db74>&#34;com.android.launcher3&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;uses-sdk</span> <span style=color:#a6e22e>android:targetSdkVersion=</span><span style=color:#e6db74>&#34;23&#34;</span> <span style=color:#a6e22e>android:minSdkVersion=</span><span style=color:#e6db74>&#34;16&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;application</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:allowBackup=</span><span style=color:#e6db74>&#34;@bool/enable_backup&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:backupAgent=</span><span style=color:#e6db74>&#34;com.android.launcher3.LauncherBackupAgentHelper&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:hardwareAccelerated=</span><span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:icon=</span><span style=color:#e6db74>&#34;@mipmap/ic_launcher_home&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:label=</span><span style=color:#e6db74>&#34;@string/app_name&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:largeHeap=</span><span style=color:#e6db74>&#34;@bool/config_largeHeap&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:restoreAnyVersion=</span><span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:supportsRtl=</span><span style=color:#e6db74>&#34;true&#34;</span> <span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;activity</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>android:name=</span><span style=color:#e6db74>&#34;com.android.launcher3.Launcher&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>android:launchMode=</span><span style=color:#e6db74>&#34;singleTask&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>android:clearTaskOnLaunch=</span><span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>android:stateNotNeeded=</span><span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>android:theme=</span><span style=color:#e6db74>&#34;@style/Theme&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>android:windowSoftInputMode=</span><span style=color:#e6db74>&#34;adjustPan&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>android:screenOrientation=</span><span style=color:#e6db74>&#34;nosensor&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>android:configChanges=</span><span style=color:#e6db74>&#34;keyboard|keyboardHidden|navigation&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>android:resumeWhilePausing=</span><span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>android:taskAffinity=</span><span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>android:enabled=</span><span style=color:#e6db74>&#34;true&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;intent-filter&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;action</span> <span style=color:#a6e22e>android:name=</span><span style=color:#e6db74>&#34;android.intent.action.MAIN&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;category</span> <span style=color:#a6e22e>android:name=</span><span style=color:#e6db74>&#34;android.intent.category.HOME&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;category</span> <span style=color:#a6e22e>android:name=</span><span style=color:#e6db74>&#34;android.intent.category.DEFAULT&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;category</span> <span style=color:#a6e22e>android:name=</span><span style=color:#e6db74>&#34;android.intent.category.MONKEY&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;/intent-filter&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;/activity&gt;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        ...
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/application&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/manifest&gt;</span>
</span></span></code></pre></div><p>Launcher 启动后会将所有已安装的应用图标展示在一个网格布局的 RecyclerView 里面，这时候用户就可以通过点击这些图标来启动相应的 app 了。</p><p>这个过程的时序图如下：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/System-Boot/clipboard_20230323_045238.png width=auto alt></p><p>关于 Launcher 如何将 App 图标显示出来等更多工作细节，可以参考
<a href=https://blog.csdn.net/yanbober/article/details/50525559 rel=noopener>Android M Launcher3 主流程源码浅析</a> 和
<a href=http://liuwangshu.cn/framework/booting/4-launcher.html rel=noopener>Android 系统启动流程（四）Launcher 启动过程与系统启动流程</a>这两篇文章。</p><h1 id=总结>总结
<a class=anchor href=#%e6%80%bb%e7%bb%93>#</a></h1><p>最后，从整体上来看 Android 系统的启动流程：</p><ol><li>按下电源，固化在 ROM 中预定位置的 Bootloader 将会被加载到内存中</li><li>Bootloader 初始化完软硬件环境后将 Linux 内核启动起来</li><li>Linux 内核启动时会做设置缓存、被保护存储器、计划列表和加载驱动等一些列操作，内核启动完成后会启动 init 进程</li><li>init 进程会初始化并启动属性服务，并且解析并执行所有 init.rc 文件</li><li>init 通过执行特定的 init.rc 文件启动 servermanager 进程，servermanager 被启动后会向 Binder 驱动发送命令让自己成为守护进程并管理所有上下文</li><li>init 通过解析 init.rc 文件启动 zygote 进程</li><li>zygote 进程启动的过程会创建 DVM 并为其注册 JNI 函数，然后创建服务端 Socket、启动 system_server 进程</li><li>启动 system_server 进程的过程会创建 Binder 线程池使其具有 IPC 能力，然后启动 AMS 等各种系统服务</li><li>AMS 启动 Launcher，Launcher 被启动后会将已安装应用的图标显示在界面上</li></ol><p>原来，一个复杂的 Android 系统就这么被运行起来了，碍于本人有限的水平，描述这个过程其实也还简化了很多操作，下面这个图比较全面地总结了这个流程：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/System-Boot/clipboard_20230323_045241.png width=auto alt></p><p><strong>系列文章</strong></p><p><a href=https://guanpj.cn/2017/09/17/Android-System-Startup-Flow-Analyze/ rel=noopener>按下电源键后竟然发生了这一幕 —— Android 系统启动流程分析</a>（本文）</p><p><a href=https://guanpj.cn/2017/10/23/Android-App-Startup-Flow-Analyze/ rel=noopener>App 竟然是这样跑起来的 —— Android App/Activity 启动流程分析</a></p><p><a href=https://guanpj.cn/2017/11/09/Android-View-Workflow/ rel=noopener>屏幕上内容究竟是怎样画出来的 —— Android View 工作原理详解</a></p><p><strong>参考文章</strong></p><p><a href=http://gityuan.com/android/ rel=noopener>Gityuan 大神的系列文章</a></p><p><a href=http://liuwangshu.cn/tags/Android%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8/ rel=noopener>刘望舒老师的系列文章</a></p><p><a href=https://www.ibm.com/developerworks/cn/linux/l-btloader/index.html rel=noopener>嵌入式系统 Boot Loader 技术内幕</a></p><blockquote><p>如果你对文章内容有疑问或者有不同的意见，欢迎留言，我们一同探讨。</p></blockquote><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://guanpj.github.io/amethyst/quartz/js/graph.cbd78cfa87df7d3e230d16fc24f06548.js></script></div></div><div id=contact_buttons><footer><p>Made with <a href=https://github.com/64bitpandas/amethyst>Amethyst</a>, © 2023 guanpj</p><ul><li><a href=https://guanpj.github.io/amethyst/>Home</a></li><li><a href=https://bencuan.me>Website</a></li><li><a href=https://blog.bencuan.me>Blog</a></li></ul></footer></div></article><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#bootloader--第一个程序>Bootloader —— 第一个程序</a></li><li><a href=#init-进程--1-号进程>init 进程 —— 1 号进程</a></li><li><a href=#servicemanager-进程--binder-服务的总管>servicemanager 进程 —— Binder 服务的总管</a></li><li><a href=#zygote-进程--java-进程的始祖>zygote 进程 —— Java 进程的始祖</a><ul><li><a href=#1启动-java-虚拟机>1.启动 Java 虚拟机</a></li><li><a href=#2加载-zygoteinit>2.加载 ZygoteInit</a><ul><li><a href=#1注册一个-socket>1.注册一个 Socket</a></li><li><a href=#2预加载各类资源>2.预加载各类资源</a></li><li><a href=#3启动-system_server-进程>3.启动 system_server 进程</a></li><li><a href=#4开启循环循环等待-fork-进程请求>4.开启循环循环等待 fork 进程请求</a></li><li><a href=#5子进程执行入口函数>5.子进程执行入口函数</a></li><li><a href=#6番外socket-客户端发送创建进程请求>6.番外：Socket 客户端发送创建进程请求</a></li></ul></li><li><a href=#小结>小结</a></li></ul></li><li><a href=#system_server-进程--承载-framework-层核心业务>system_server 进程 —— 承载 framework 层核心业务</a><ul><li><a href=#1启动-native-层系统服务>1.启动 Native 层系统服务</a></li><li><a href=#2启动-java-层系统服务>2.启动 Java 层系统服务</a></li><li><a href=#小结-1>小结</a></li></ul></li><li><a href=#launcher--android-系统的桌面>Launcher —— Android 系统的“桌面”</a></li><li><a href=#总结>总结</a></li></ul></nav></div></aside></main></body></html>