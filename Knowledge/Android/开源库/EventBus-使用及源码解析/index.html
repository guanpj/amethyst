<!doctype html><html lang=en dir=ltr><head><meta property="og:title" content="EventBus 使用及源码解析"><meta property="og:description" content="使用 #   首先引入依赖  apply plugin: 'kotlin-kapt'  dependencies {  implementation 'org.greenrobot:eventbus:3.2.0'  kapt 'org.greenrobot:eventbus-annotation-processor:3.2.0' }  kapt {  arguments {  arg('eventBusIndex', 'com.me.guanpj.myapplication.MyEventBusIndex')  } } 从在 3.0 版本开始，EventBus 提供了一个 EventBusAnnotationProcessor 注解处理器来在编译期通过读取 @Subscribe 注解，并解析和处理其中所包含的信息，然后生成 Java 类索引来保存订阅者中所有的事件响应函数，这样就比在运行时使用反射来获得订阅者中所有事件响应函数的速度要快。
以下是来自官方对 EventBus 各个版本性能的对比图，可以看到，EventBus 3.x 如果没有使用索引的话性能相较于之前的版本是倒退的。使用索引能让 EventBus 的性能大大增加。
 添加混淆规则：  -keepattributes *Annotation* -keepclassmembers class * {  @org.greenrobot.eventbus.Subscribe <methods>; } -keep enum org.greenrobot.eventbus.ThreadMode { *; }  # And if you use AsyncExecutor: -keepclassmembers class * extends org."><meta property="og:type" content="article"><meta property="og:url" content="https://guanpj.github.io/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/EventBus-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"><meta property="article:section" content="Knowledge"><meta property="og:site_name" content="guanpj's blog"><title>EventBus 使用及源码解析 | guanpj's blog</title><link rel=manifest href=/amethyst/manifest.json><link rel=icon href=/amethyst/favicon.png type=image/x-icon><link rel=stylesheet href=/amethyst/book.min.c27ff4755c78daab11627953d5a6dd7e2698690e086398032995aae74d6397b6.css integrity="sha256-wn/0dVx42qsRYnlT1abdfiaYaQ4IY5gDKZWq501jl7Y=" crossorigin=anonymous><meta charset=utf-8><meta name=description content="使用 #   首先引入依赖  apply plugin: 'kotlin-kapt'  dependencies {  implementation 'org.greenrobot:eventbus:3.2.0'  kapt 'org.greenrobot:eventbus-annotation-processor:3.2.0' }  kapt {  arguments {  arg('eventBusIndex', 'com.me.guanpj.myapplication.MyEventBusIndex')  } } 从在 3.0 版本开始，EventBus 提供了一个 EventBusAnnotationProcessor 注解处理器来在编译期通过读取 @Subscribe 注解，并解析和处理其中所包含的信息，然后生成 Java 类索引来保存订阅者中所有的事件响应函数，这样就比在运行时使用反射来获得订阅者中所有事件响应函数的速度要快。
以下是来自官方对 EventBus 各个版本性能的对比图，可以看到，EventBus 3.x 如果没有使用索引的话性能相较于之前的版本是倒退的。使用索引能让 EventBus 的性能大大增加。
 添加混淆规则：  -keepattributes *Annotation* -keepclassmembers class * {  @org.greenrobot.eventbus.Subscribe <methods>; } -keep enum org.greenrobot.eventbus.ThreadMode { *; }  # And if you use AsyncExecutor: -keepclassmembers class * extends org."><title>EventBus 使用及源码解析</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://guanpj.github.io/amethyst//favicon.png><link href=https://guanpj.github.io/amethyst/styles.e08ceb33360cec132feb69cfb982e2a4.min.css rel=stylesheet><link href=https://guanpj.github.io/amethyst/quartz/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://guanpj.github.io/amethyst/quartz/js/darkmode.1bc498b60ed24d8858f74f99e480db82.min.js></script>
<script src=https://guanpj.github.io/amethyst/quartz/js/util.c69e233dc1cc331a30b0f670e657b425.min.js></script>
<script async src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script async src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://guanpj.github.io/amethyst/quartz/js/popover.f03552ccb84d99ca615d1cfb9abde59e.min.js></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://guanpj.github.io/amethyst/",fetchData=Promise.all([fetch("https://guanpj.github.io/amethyst/indices/linkIndex.f13ba8f7c67305f3500d259bdfb72f53.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://guanpj.github.io/amethyst/indices/contentIndex.1a908c783dc71dfdcce2d7bedf40efc5.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addCollapsibleCallouts(),initPopover("https://guanpj.github.io/amethyst",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!0;drawGraph("https://guanpj.github.io/amethyst",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script>window.Million={navigate:e=>window.location.href=e,prefetch:()=>{}},window.addEventListener("DOMContentLoaded",()=>{init(),render()})</script></head><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><header class=book-header><label for=menu-control><img src=/amethyst/svg/menu.svg class=book-icon alt=Menu></label><h1 id=page-title><a href=https://guanpj.github.io/amethyst/>guanpj's blog</a></h1><div class=spacer></div><div id=search-icon class=quartz-search><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control><main class=flex><aside class=book-menu><div class=book-menu-content><nav><div class=menu-search><div id=search-icon class=quartz-search><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div></div><ul><li><span class=book-menu-title>Atlas</span><ul><li><a href=/amethyst/Atlas/About-Atlas/>About Atlas</a></li><li><a href=/amethyst/Atlas/Index-for-Atlases/>Index for Atlases</a></li></ul></li><li><span class=book-menu-title>Dashborads</span><ul><li><a href=/amethyst/Dashborad/Buttons/>Buttons</a></li><li><a href=/amethyst/Dashborad/ControlPanel/>Control Panel</a></li></ul></li><li><span class=book-menu-title>Excalidraws</span><ul><li><a href=/amethyst/Excalidraw/MyDraw/>My Draw</a></li></ul></li><li><span class=book-menu-title>Extras</span><ul><li><a href=/amethyst/Extras/Linter/>Linter</a></li><li><a href=/amethyst/Extras/Index-for-Extras/>Index for Extras</a></li></ul></li><li><span class=book-menu-title>Knowledges</span><ul><li><a href=/amethyst/Knowledge/Kotlin/%E5%A7%94%E6%89%98/>委托</a></li><li><a href=/amethyst/Knowledge/Kotlin/%E6%89%A9%E5%B1%95%E5%87%BD%E6%95%B0/>扩展函数</a></li><li><a href=/amethyst/Knowledge/Python/%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%96%87%E6%9C%AC%E6%9B%BF%E6%8D%A2/>文件读取、文本替换</a></li><li><a href=/amethyst/Knowledge/Python/%E7%B1%BB%E7%9A%84%E5%AE%9A%E4%B9%89%E4%BD%BF%E7%94%A8/>类的定义、使用</a></li><li><a href=/amethyst/Knowledge/Python/%E9%81%8D%E5%8E%86%E6%96%87%E4%BB%B6%E9%87%8D%E5%91%BD%E5%90%8D/>遍历文件、重命名</a></li><li><a href=/amethyst/Knowledge/%E7%AE%97%E6%B3%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E5%BC%95%E7%94%A8/>引用</a></li><li><a href=/amethyst/Knowledge/%E7%AE%97%E6%B3%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%8C%87%E9%92%88/>指针</a></li><li><a href=/amethyst/Knowledge/Android/Android-%E5%9F%BA%E7%A1%80/ADB-%E5%91%BD%E4%BB%A4/>ADB 命令</a></li><li><a href=/amethyst/Knowledge/Android/%E7%83%AD%E4%BF%AE%E5%A4%8D%E6%8F%92%E4%BB%B6%E5%8C%96/Java-%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/>ADB 命令</a></li><li><a href=/amethyst/Knowledge/Android/Android-%E5%9F%BA%E7%A1%80/Android-%E5%AF%B9%E5%AE%B9%E5%99%A8%E7%B1%BB%E7%9A%84%E4%BC%98%E5%8C%96/>Android 对容器类的优化</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/CAS-%E5%92%8C-AQS-%E5%8E%9F%E7%90%86/>CAS 和 AQS 原理</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/EventBus-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/ class=active>EventBus 使用及源码解析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/Glide-%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E5%92%8C%E7%BC%93%E5%AD%98%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/>Glide 加载流程和缓存原理分析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/Glide-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/>Glide 基本使用</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/Glide-%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95/>Glide 高级用法</a></li><li><a href=/amethyst/Knowledge/Java/%E5%9F%BA%E7%A1%80/HashMap-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>HashMap 源码解析</a></li><li><a href=/amethyst/Knowledge/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9B%B8%E5%85%B3/HTTP-%E5%9F%BA%E7%A1%80/>HTTP 基础</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/Java-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/>Java 内存模型</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E4%B8%AD%E7%9A%84%E5%AF%B9%E8%B1%A1%E5%92%8C%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/>JVM 中的对象和垃圾回收</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F/>JVM 内存区域</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E5%AD%97%E8%8A%82%E7%A0%81%E6%8C%87%E4%BB%A4%E7%AE%80%E4%BB%8B/>JVM 字节码指令简介</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E5%AD%97%E8%8A%82%E7%A0%81%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/>JVM 字节码结构分析</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/>JVM 类加载机制</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/LeakCanary-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>LeakCanary 使用及源码解析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/OkHttp-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>OkHttp 使用及源码分析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/Retrofit-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>Retrofit 使用及源码分析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/RxJava-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>RxJava 使用及源码分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%B8%80Binder-%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90%E6%A6%82%E5%BF%B5%E7%AF%87/>一、Binder 机制分析——概念篇</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%B8%83View-%E4%BA%8B%E4%BB%B6%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/>七、View 事件机制分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%B8%89Handler-%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/>三、Handler 原理分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%BA%8CBinder-%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90%E5%BA%94%E7%94%A8%E7%AF%87/>二、Binder 机制分析——应用篇</a></li><li><a href=/amethyst/Knowledge/%E7%AE%97%E6%B3%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E4%BA%8C%E5%8F%89%E6%A0%91%E9%81%8D%E5%8E%86/>二叉树遍历</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%BA%94App-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/>五、App 启动流程分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E5%85%ADView-%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/>六、View 绘制流程分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E5%9B%9B%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/>四、系统启动流程分析</a></li><li><a href=/amethyst/Knowledge/Java/%E5%9F%BA%E7%A1%80/%E5%AE%B9%E5%99%A8%E7%B1%BB/>容器类</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/>并发容器</a></li><li><a href=/amethyst/Knowledge/Java/%E5%9F%BA%E7%A1%80/%E6%B3%9B%E5%9E%8B/>泛型</a></li><li><a href=/amethyst/Knowledge/Java/%E5%9F%BA%E7%A1%80/%E6%B3%A8%E8%A7%A3%E5%92%8C%E5%8F%8D%E5%B0%84/>注解和反射</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E7%AD%89%E5%BE%85-%E9%80%9A%E7%9F%A5%E6%9C%BA%E5%88%B6/>等待-通知机制</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E7%BA%BF%E7%A8%8B%E5%8D%8F%E4%BD%9C/>线程协作</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80/>线程基础</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%92%8C-BlockingQueue/>线程池和 BlockingQueue</a></li><li><a href=/amethyst/Knowledge/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9B%B8%E5%85%B3/%E7%BC%96%E7%A0%81%E5%8A%A0%E5%AF%86Hash%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%AD%97%E7%AC%A6%E9%9B%86/>编码、加密、Hash、序列化和字符集</a></li><li><a href=/amethyst/Knowledge/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9B%B8%E5%85%B3/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84TCPIP-%E5%92%8C-HTTPS/>计算机网络体系结构、TCP&IP 和 HTTPS</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E9%94%81/>锁</a></li></ul></li><li><span class=book-menu-title>Notes</span><ul><li><a href=/amethyst/Notes/2023-03-15/>2023 03 15</a></li><li><a href=/amethyst/Notes/2023-03-18/>2023 03 18</a></li><li><a href=/amethyst/Notes/2023-03-19/>2023 03 19</a></li><li><a href=/amethyst/Notes/2023-03-20/>2023 03 20</a></li><li><a href=/amethyst/Notes/2023-03-22/>Troubleshooting and FAQ</a></li></ul></li><li><span class=book-menu-title>Templates</span><ul><li><a href=/amethyst/Templates/%E5%85%B6%E4%BB%96%E6%A8%A1%E7%89%88/>其他模版</a></li></ul></li><li><span class=book-menu-title>Temps</span><ul><li><a href=/amethyst/Temp/MyIdeas/>MyIdeas</a></li></ul></li></ul><ul><li><a href=https://github.com/64bitpandas/amethyst target=_blank rel=noopener>Github</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class="book-page container"><article class=markdown><h1 class=title>EventBus 使用及源码解析</h1><h1 id=使用>使用
<a class=anchor href=#%e4%bd%bf%e7%94%a8>#</a></h1><ol><li>首先引入依赖</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>apply plugin: <span style=color:#e6db74>&#39;kotlin-kapt&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dependencies <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    implementation <span style=color:#e6db74>&#39;org.greenrobot:eventbus:3.2.0&#39;</span>
</span></span><span style=display:flex><span>    kapt <span style=color:#e6db74>&#39;org.greenrobot:eventbus-annotation-processor:3.2.0&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kapt <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    arguments <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        arg<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;eventBusIndex&#39;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#39;com.me.guanpj.myapplication.MyEventBusIndex&#39;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>从在 3.0 版本开始，EventBus 提供了一个 EventBusAnnotationProcessor 注解处理器来在编译期通过读取 @Subscribe 注解，并解析和处理其中所包含的信息，然后生成 Java 类索引来保存订阅者中所有的事件响应函数，这样就比在运行时使用反射来获得订阅者中所有事件响应函数的速度要快。</p><p>以下是来自官方对 EventBus 各个版本性能的对比图，可以看到，EventBus 3.x 如果没有使用索引的话性能相较于之前的版本是倒退的。使用索引能让 EventBus 的性能大大增加。</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/EventBus/clipboard_20230323_031615.png width=auto alt></p><ol start=2><li>添加混淆规则：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>-keepattributes *Annotation*
</span></span><span style=display:flex><span>-keepclassmembers class * {
</span></span><span style=display:flex><span>    @org.greenrobot.eventbus.Subscribe &lt;methods&gt;;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>-keep enum org.greenrobot.eventbus.ThreadMode { *; }
</span></span><span style=display:flex><span> # And if you use AsyncExecutor:
</span></span><span style=display:flex><span>-keepclassmembers class * extends org.greenrobot.eventbus.util.ThrowableFailureEvent {
</span></span><span style=display:flex><span>    &lt;init&gt;(java.lang.Throwable);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>使用索引文件创建全局 EventBus 实例</li></ol><p>经过以上配置，就可以使用生成的 <code>com.me.guanpj.myapplication.MyEventBusIndex</code> 创建 EventBus 了。</p><blockquote><p>注意：如果项目中没有被 @Subscribe 标记的事件接收方法， 则不会生成索引类。</p></blockquote><p>推荐在 Application 中使用生成的索引创建全局 EventBus 实例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyApplication</span> : Application() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onCreate</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span>.onCreate()
</span></span><span style=display:flex><span>        EventBus.builder().addIndex(MyEventBusIndex()).installDefaultEventBus()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这样后面通过 <code>EventBus.getDefault()</code> 获取的 EventBus 实例都是刚才通过索引创建的。</p><p>如果既有 Library 的索引，也有 App 的索引，可以在 EventBus 设置过程中一起添加：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>EventBus.builder().addIndex(MyEventBusAppIndex())
</span></span><span style=display:flex><span>    .addIndex(MyEventBusLibIndex()).build()
</span></span><span style=display:flex><span>    .installDefaultEventBus()
</span></span></code></pre></div><p>当然，如果在某些情况下不想使用全局实例，也可以单独生成一个实例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> eventBus = EventBus.builder()
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 事件接收对象是否有层次结构（默认为 true，超类也将被通知）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    .eventInheritance(<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 忽略索引文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    .ignoreGeneratedIndex(<span style=color:#66d9ef>false</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 打印没有订阅消息，默认为 true
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    .logNoSubscriberMessages(<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 打印订阅异常的消息，默认为 true
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    .logSubscriberExceptions(<span style=color:#66d9ef>false</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 设置发送的的事件在没有订阅者的情况时，EventBus是否保持静默，默认为 true
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    .sendNoSubscriberEvent(<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 发送分发事件的异常，默认为 true
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    .sendSubscriberExceptionEvent(<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>//如果 onEvent*** 方法出现异常，是否将此异常分发给订阅者，默认为 false
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    .throwSubscriberException(BuildConfig.DEBUG)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 定义一个线程池用于处理后台线程和异步线程分发事件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    .executorService(Executors.newSingleThreadExecutor())
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 启用严格的方法验证（在 3.0 以前，接收处理事件的方法名必须以 onEvent 开头）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 默认为 false
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    .strictMethodVerification(<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 为特定时间跳过方法验证，包括方法名、限定符
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    .skipMethodVerificationFor(ButtonEvent<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java)
</span></span><span style=display:flex><span>    .build()
</span></span><span style=display:flex><span>eventBus.register(<span style=color:#66d9ef>this</span>)
</span></span></code></pre></div><ol start=4><li>定义事件</li></ol><p>新建一个实体类用于事件的传递：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>package</span> com.me.guanpj.myapplication.event
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>data</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MessageEvent</span>(<span style=color:#66d9ef>val</span> message: String)
</span></span></code></pre></div><ol start=5><li>发送和接收事件</li></ol><p>在需要接收事件的 Activity、Fragment 或者其它地方调用一次 <code>EventBus.getDefault().register(this)</code> 进行注册，然后使用 <code>@Subscribe</code> 注解标记接收事件的方法，方法参数为一个实体类，或者基本数据类型。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EventBusActivity</span> : AppCompatActivity() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onCreate</span>(savedInstanceState: Bundle?) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span>.onCreate(savedInstanceState)
</span></span><span style=display:flex><span>        setContentView(R.layout.activity_event)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        EventBus.getDefault().register(<span style=color:#66d9ef>this</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>buttonClick</span>(view: android.view.View) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>//EventBus.getDefault().post(MessageEvent(&#34;click&#34;))
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        EventBus.getDefault().postSticky(MessageEvent(<span style=color:#e6db74>&#34;click&#34;</span>))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>jump</span>(view: View) {
</span></span><span style=display:flex><span>        startActivity(Intent(<span style=color:#66d9ef>this</span>, AnotherActivity<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Subscribe</span>(threadMode = ThreadMode.MAIN, priority = <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onEvent</span>(event : MessageEvent) {
</span></span><span style=display:flex><span>        Log.e(<span style=color:#e6db74>&#34;gpj&#34;</span>, <span style=color:#e6db74>&#34;EventBusActivity onEvent receive msg: </span><span style=color:#e6db74>${event.message}</span><span style=color:#e6db74> in thread: </span><span style=color:#e6db74>${Thread.currentThread().name}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Subscribe</span>(threadMode = ThreadMode.BACKGROUND, priority = <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onEvent1</span>(event : MessageEvent) {
</span></span><span style=display:flex><span>        Log.e(<span style=color:#e6db74>&#34;gpj&#34;</span>, <span style=color:#e6db74>&#34;EventBusActivity onEvent1 receive msg: </span><span style=color:#e6db74>${event.message}</span><span style=color:#e6db74> in thread: </span><span style=color:#e6db74>${Thread.currentThread().name}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Subscribe</span>(threadMode = ThreadMode.BACKGROUND, priority = <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onEvent2</span>(event : MessageEvent) {
</span></span><span style=display:flex><span>        Log.e(<span style=color:#e6db74>&#34;gpj&#34;</span>, <span style=color:#e6db74>&#34;EventBusActivity onEvent2 receive msg: </span><span style=color:#e6db74>${event.message}</span><span style=color:#e6db74> in thread: </span><span style=color:#e6db74>${Thread.currentThread().name}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onDestroy</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span>.onDestroy()
</span></span><span style=display:flex><span>        EventBus.getDefault().unregister(<span style=color:#66d9ef>this</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AnotherActivity</span> : AppCompatActivity() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onCreate</span>(savedInstanceState: Bundle?) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span>.onCreate(savedInstanceState)
</span></span><span style=display:flex><span>        setContentView(R.layout.activity_another)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        EventBus.getDefault().register(<span style=color:#66d9ef>this</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Subscribe</span>(threadMode = ThreadMode.MAIN)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onEvent</span>(event : MessageEvent) {
</span></span><span style=display:flex><span>        Log.e(<span style=color:#e6db74>&#34;gpj&#34;</span>, <span style=color:#e6db74>&#34;AnotherActivity onEvent receive msg: </span><span style=color:#e6db74>${event.message}</span><span style=color:#e6db74> in thread: </span><span style=color:#e6db74>${Thread.currentThread().name}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 粘性事件不会被消耗，除非手动移除
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        EventBus.getDefault().removeStickyEvent(MessageEvent<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onDestroy</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span>.onDestroy()
</span></span><span style=display:flex><span>        EventBus.getDefault().unregister(<span style=color:#66d9ef>this</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>每次输出的日志都是一样的：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>EventBusActivity onEvent receive msg: click in thread: main
</span></span><span style=display:flex><span>EventBusActivity onEvent2 receive msg: click in thread: pool-2-thread-1
</span></span><span style=display:flex><span>EventBusActivity onEvent1 receive msg: click in thread: pool-2-thread-1
</span></span><span style=display:flex><span>//打开 MainActivity 后
</span></span><span style=display:flex><span>AnotherActivity receive msg: click in thread: main
</span></span></code></pre></div><h1 id=分析>分析
<a class=anchor href=#%e5%88%86%e6%9e%90>#</a></h1><h2 id=获取-eventbus-实例>获取 EventBus 实例
<a class=anchor href=#%e8%8e%b7%e5%8f%96-eventbus-%e5%ae%9e%e4%be%8b>#</a></h2><p>不管是用 <code>EventBus.getDefault()</code> 还是 <code>EventBus.builder()</code> 都能够获取到 EventBus 对象，只不过前者是获取一个全局的单例，后者是使用 builder() 配置出一个新的对象。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EventBus</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> EventBusBuilder DEFAULT_BUILDER <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> EventBusBuilder<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Map<span style=color:#f92672>&lt;</span>Class<span style=color:#f92672>&lt;?&gt;,</span> CopyOnWriteArrayList<span style=color:#f92672>&lt;</span>Subscription<span style=color:#f92672>&gt;&gt;</span> subscriptionsByEventType<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Map<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>,</span> List<span style=color:#f92672>&lt;</span>Class<span style=color:#f92672>&lt;?&gt;&gt;&gt;</span> typesBySubscriber<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Map<span style=color:#f92672>&lt;</span>Class<span style=color:#f92672>&lt;?&gt;,</span> Object<span style=color:#f92672>&gt;</span> stickyEvents<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> EventBus <span style=color:#a6e22e>getDefault</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        EventBus instance <span style=color:#f92672>=</span> defaultInstance<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>instance <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span>EventBus<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                instance <span style=color:#f92672>=</span> EventBus<span style=color:#f92672>.</span><span style=color:#a6e22e>defaultInstance</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>instance <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    instance <span style=color:#f92672>=</span> EventBus<span style=color:#f92672>.</span><span style=color:#a6e22e>defaultInstance</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> EventBus<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> instance<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> EventBusBuilder <span style=color:#a6e22e>builder</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> EventBusBuilder<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>EventBus</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>(</span>DEFAULT_BUILDER<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    EventBus<span style=color:#f92672>(</span>EventBusBuilder builder<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        logger <span style=color:#f92672>=</span> builder<span style=color:#f92672>.</span><span style=color:#a6e22e>getLogger</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        subscriptionsByEventType <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 2
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        typesBySubscriber <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 3
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        stickyEvents <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ConcurrentHashMap<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 4
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        mainThreadSupport <span style=color:#f92672>=</span> builder<span style=color:#f92672>.</span><span style=color:#a6e22e>getMainThreadSupport</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        mainThreadPoster <span style=color:#f92672>=</span> mainThreadSupport <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> mainThreadSupport<span style=color:#f92672>.</span><span style=color:#a6e22e>createPoster</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        backgroundPoster <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> BackgroundPoster<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        asyncPoster <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AsyncPoster<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        indexCount <span style=color:#f92672>=</span> builder<span style=color:#f92672>.</span><span style=color:#a6e22e>subscriberInfoIndexes</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> builder<span style=color:#f92672>.</span><span style=color:#a6e22e>subscriberInfoIndexes</span><span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>()</span> <span style=color:#f92672>:</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 5
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        subscriberMethodFinder <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SubscriberMethodFinder<span style=color:#f92672>(</span>builder<span style=color:#f92672>.</span><span style=color:#a6e22e>subscriberInfoIndexes</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            builder<span style=color:#f92672>.</span><span style=color:#a6e22e>strictMethodVerification</span><span style=color:#f92672>,</span> builder<span style=color:#f92672>.</span><span style=color:#a6e22e>ignoreGeneratedIndex</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        logSubscriberExceptions <span style=color:#f92672>=</span> builder<span style=color:#f92672>.</span><span style=color:#a6e22e>logSubscriberExceptions</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        logNoSubscriberMessages <span style=color:#f92672>=</span> builder<span style=color:#f92672>.</span><span style=color:#a6e22e>logNoSubscriberMessages</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        sendSubscriberExceptionEvent <span style=color:#f92672>=</span> builder<span style=color:#f92672>.</span><span style=color:#a6e22e>sendSubscriberExceptionEvent</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        sendNoSubscriberEvent <span style=color:#f92672>=</span> builder<span style=color:#f92672>.</span><span style=color:#a6e22e>sendNoSubscriberEvent</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        throwSubscriberException <span style=color:#f92672>=</span> builder<span style=color:#f92672>.</span><span style=color:#a6e22e>throwSubscriberException</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        eventInheritance <span style=color:#f92672>=</span> builder<span style=color:#f92672>.</span><span style=color:#a6e22e>eventInheritance</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 6
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        executorService <span style=color:#f92672>=</span> builder<span style=color:#f92672>.</span><span style=color:#a6e22e>executorService</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看出，两种获取对象的方式都会调用到 <code>EventBus(EventBusBuilder builder)</code> 这个构造方法，<code>getDefault()</code> 只是最终传入了一个空的 <code>EventBusBuilder</code> 对象而已。</p><p>在 <code>EventBus(EventBusBuilder builder)</code> 构造方法中：</p><p>在注释 1 处，创建了一个 subscriptionsByEventType 对象，可以看到它是一个 HashMap，并且其 key 表示 Event 的类型，value 为 <code>CopyOnWriteArrayList&lt;Subscription></code>。这里的 Subscription 是一个订阅信息对象，它里面保存了两个重要的字段，一个是类型为 Object 的 subscriber，该字段即为注册的对象（在 Android 中时通常是 Activity 或着 Fragment 对象）；另一个是类型为 SubscriberMethod 的实例，它就是被 @Subscribe 注解的那个订阅方法，里面保存了一个重要的字段：eventType，它的类型为 <code>Class&lt;?></code>，表示 Event 的类型。</p><p>在注释 2 处，新建了一个类型为 HashMap 的 typesBySubscriber 对象，它的 key 为 subscriber 对象， value 为 subscriber 对象中所有的 Event 类型 List，日常使用中仅用于判断某个对象是否注册过。</p><p>在注释 3 处新建了一个类型为 ConcurrentHashMap 的 stickyEvents 对象，专用于粘性事件处理的，key 同样为 Event 的类型，value 为当前的事件。</p><blockquote><p>普通事件是先注册，然后发送事件才能收到；而粘性事件在发送事件之后再订阅也能收到。并且，粘性事件会保存在内存中，每次进入都会去内存中查找获取最新的粘性事件，除非手动移除事件。</p></blockquote><p>在注释 4 处，新建了三个不同类型的事件发送器：</p><ul><li>mainThreadPoster：主线程事件发送器，通过它的 <code>mainThreadPoster.enqueue(subscription, event)</code> 方法可以将订阅信息和对应的事件进行入队，然后通过 handler 去发送一个消息，在 handler 的 <code>handleMessage()</code> 中去执行方法。</li><li>backgroundPoster：后台事件发送器，通过它的 <code>enqueue()</code> 将方法加入到后台的一个队列，最后通过线程池去执行，同时它保证任一时间只且仅能有一个任务会被线程池执行。</li><li>asyncPoster：实现逻辑类似于 backgroundPoster，不同于 backgroundPoster 的保证任一时间只且仅能有一个任务会被线程池执行的特性，asyncPoster 则是异步运行的，可以同时接收多个任务。</li></ul><p>再看注释 5 这行代码，这里新建了一个 SubscriberMethodFinder 对象，这是从 EventBus 中抽离出的订阅方法查询的一个对象，在优秀的源码中，我们经常能看到<strong>组合优于继承</strong>的这种实现思想。</p><p>在注释 6 处，从 builder 中取出了一个默认的线程池对象，它由 <strong>Executors 的 newCachedThreadPool() 方法创建，它是一个有则用、无则创建、无数量上限</strong>的线程池。</p><h2 id=index-文件分析>Index 文件分析
<a class=anchor href=#index-%e6%96%87%e4%bb%b6%e5%88%86%e6%9e%90>#</a></h2><h3 id=index-文件概览>Index 文件概览
<a class=anchor href=#index-%e6%96%87%e4%bb%b6%e6%a6%82%e8%a7%88>#</a></h3><p>生成的索引类如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyEventBusIndex</span> <span style=color:#66d9ef>implements</span> SubscriberInfoIndex <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Map<span style=color:#f92672>&lt;</span>Class<span style=color:#f92672>&lt;?&gt;,</span> SubscriberInfo<span style=color:#f92672>&gt;</span> SUBSCRIBER_INDEX<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        SUBSCRIBER_INDEX <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;</span>Class<span style=color:#f92672>&lt;?&gt;,</span> SubscriberInfo<span style=color:#f92672>&gt;();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        putIndex<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> SimpleSubscriberInfo<span style=color:#f92672>(</span>com<span style=color:#f92672>.</span><span style=color:#a6e22e>me</span><span style=color:#f92672>.</span><span style=color:#a6e22e>guanpj</span><span style=color:#f92672>.</span><span style=color:#a6e22e>myapplication</span><span style=color:#f92672>.</span><span style=color:#a6e22e>event</span><span style=color:#f92672>.</span><span style=color:#a6e22e>EventBusActivity</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>new</span> SubscriberMethodInfo<span style=color:#f92672>[]</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> SubscriberMethodInfo<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;onEvent&#34;</span><span style=color:#f92672>,</span> com<span style=color:#f92672>.</span><span style=color:#a6e22e>me</span><span style=color:#f92672>.</span><span style=color:#a6e22e>guanpj</span><span style=color:#f92672>.</span><span style=color:#a6e22e>myapplication</span><span style=color:#f92672>.</span><span style=color:#a6e22e>event</span><span style=color:#f92672>.</span><span style=color:#a6e22e>MessageEvent</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> ThreadMode<span style=color:#f92672>.</span><span style=color:#a6e22e>MAIN</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> SubscriberMethodInfo<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;onEvent1&#34;</span><span style=color:#f92672>,</span> com<span style=color:#f92672>.</span><span style=color:#a6e22e>me</span><span style=color:#f92672>.</span><span style=color:#a6e22e>guanpj</span><span style=color:#f92672>.</span><span style=color:#a6e22e>myapplication</span><span style=color:#f92672>.</span><span style=color:#a6e22e>event</span><span style=color:#f92672>.</span><span style=color:#a6e22e>MessageEvent</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                    ThreadMode<span style=color:#f92672>.</span><span style=color:#a6e22e>BACKGROUND</span><span style=color:#f92672>,</span> 1<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> SubscriberMethodInfo<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;onEvent2&#34;</span><span style=color:#f92672>,</span> com<span style=color:#f92672>.</span><span style=color:#a6e22e>me</span><span style=color:#f92672>.</span><span style=color:#a6e22e>guanpj</span><span style=color:#f92672>.</span><span style=color:#a6e22e>myapplication</span><span style=color:#f92672>.</span><span style=color:#a6e22e>event</span><span style=color:#f92672>.</span><span style=color:#a6e22e>MessageEvent</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                    ThreadMode<span style=color:#f92672>.</span><span style=color:#a6e22e>BACKGROUND</span><span style=color:#f92672>,</span> 2<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        putIndex<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> SimpleSubscriberInfo<span style=color:#f92672>(</span>MainActivity<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> SubscriberMethodInfo<span style=color:#f92672>[]</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> SubscriberMethodInfo<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;onEvent3&#34;</span><span style=color:#f92672>,</span> com<span style=color:#f92672>.</span><span style=color:#a6e22e>me</span><span style=color:#f92672>.</span><span style=color:#a6e22e>guanpj</span><span style=color:#f92672>.</span><span style=color:#a6e22e>myapplication</span><span style=color:#f92672>.</span><span style=color:#a6e22e>event</span><span style=color:#f92672>.</span><span style=color:#a6e22e>MessageEvent</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> ThreadMode<span style=color:#f92672>.</span><span style=color:#a6e22e>MAIN</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                    3<span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>putIndex</span><span style=color:#f92672>(</span>SubscriberInfo info<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        SUBSCRIBER_INDEX<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>info<span style=color:#f92672>.</span><span style=color:#a6e22e>getSubscriberClass</span><span style=color:#f92672>(),</span> info<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> SubscriberInfo <span style=color:#a6e22e>getSubscriberInfo</span><span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;?&gt;</span> subscriberClass<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        SubscriberInfo info <span style=color:#f92672>=</span> SUBSCRIBER_INDEX<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>subscriberClass<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>info <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> info<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=类介绍>类介绍
<a class=anchor href=#%e7%b1%bb%e4%bb%8b%e7%bb%8d>#</a></h3><h4 id=subscriberinfo-继承关系>SubscriberInfo 继承关系
<a class=anchor href=#subscriberinfo-%e7%bb%a7%e6%89%bf%e5%85%b3%e7%b3%bb>#</a></h4><p>可以看到，这里新建了一个 Map 集合，用于存放事件订阅类和它们的订阅方法</p><p><code>SubscriberInfo</code> 之间的映射。<code>SubscriberInfo</code> 的定义如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>SubscriberInfo</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Class<span style=color:#f92672>&lt;?&gt;</span> getSubscriberClass<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    SubscriberMethod<span style=color:#f92672>[]</span> <span style=color:#a6e22e>getSubscriberMethods</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    SubscriberInfo <span style=color:#a6e22e>getSuperSubscriberInfo</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>shouldCheckSuperclass</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这里 <code>SubscriberInfo</code> 的实现类为 <code>SimpleSubscriberInfo</code>，而中间还有一个 <code>AbstractSubscriberInfo</code>，它们的定义如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AbstractSubscriberInfo</span> <span style=color:#66d9ef>implements</span> SubscriberInfo <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Class subscriberClass<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Class<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> SubscriberInfo<span style=color:#f92672>&gt;</span> superSubscriberInfoClass<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> shouldCheckSuperclass<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#a6e22e>AbstractSubscriberInfo</span><span style=color:#f92672>(</span>Class subscriberClass<span style=color:#f92672>,</span> Class<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> SubscriberInfo<span style=color:#f92672>&gt;</span> superSubscriberInfoClass<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                     <span style=color:#66d9ef>boolean</span> shouldCheckSuperclass<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>subscriberClass</span> <span style=color:#f92672>=</span> subscriberClass<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>superSubscriberInfoClass</span> <span style=color:#f92672>=</span> superSubscriberInfoClass<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>shouldCheckSuperclass</span> <span style=color:#f92672>=</span> shouldCheckSuperclass<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Class <span style=color:#a6e22e>getSubscriberClass</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> subscriberClass<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> SubscriberInfo <span style=color:#a6e22e>getSuperSubscriberInfo</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>superSubscriberInfoClass <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> superSubscriberInfoClass<span style=color:#f92672>.</span><span style=color:#a6e22e>newInstance</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InstantiationException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IllegalAccessException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>shouldCheckSuperclass</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> shouldCheckSuperclass<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> SubscriberMethod <span style=color:#a6e22e>createSubscriberMethod</span><span style=color:#f92672>(</span>String methodName<span style=color:#f92672>,</span> Class<span style=color:#f92672>&lt;?&gt;</span> eventType<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> createSubscriberMethod<span style=color:#f92672>(</span>methodName<span style=color:#f92672>,</span> eventType<span style=color:#f92672>,</span> ThreadMode<span style=color:#f92672>.</span><span style=color:#a6e22e>POSTING</span><span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> SubscriberMethod <span style=color:#a6e22e>createSubscriberMethod</span><span style=color:#f92672>(</span>String methodName<span style=color:#f92672>,</span> Class<span style=color:#f92672>&lt;?&gt;</span> eventType<span style=color:#f92672>,</span> 
</span></span><span style=display:flex><span>            ThreadMode threadMode<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> createSubscriberMethod<span style=color:#f92672>(</span>methodName<span style=color:#f92672>,</span> eventType<span style=color:#f92672>,</span> threadMode<span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> SubscriberMethod <span style=color:#a6e22e>createSubscriberMethod</span><span style=color:#f92672>(</span>String methodName<span style=color:#f92672>,</span> Class<span style=color:#f92672>&lt;?&gt;</span> eventType<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            ThreadMode threadMode<span style=color:#f92672>,</span><span style=color:#66d9ef>int</span> priority<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> sticky<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Method method <span style=color:#f92672>=</span> subscriberClass<span style=color:#f92672>.</span><span style=color:#a6e22e>getDeclaredMethod</span><span style=color:#f92672>(</span>methodName<span style=color:#f92672>,</span> eventType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> SubscriberMethod<span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> eventType<span style=color:#f92672>,</span> threadMode<span style=color:#f92672>,</span> priority<span style=color:#f92672>,</span> sticky<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>NoSuchMethodException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> EventBusException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Could not find subscriber method in &#34;</span> <span style=color:#f92672>+</span> subscriberClass <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;. Maybe a missing ProGuard rule?&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SimpleSubscriberInfo</span> <span style=color:#66d9ef>extends</span> AbstractSubscriberInfo <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> SubscriberMethodInfo<span style=color:#f92672>[]</span> methodInfos<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>SimpleSubscriberInfo</span><span style=color:#f92672>(</span>Class subscriberClass<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> shouldCheckSuperclass<span style=color:#f92672>,</span> SubscriberMethodInfo<span style=color:#f92672>[]</span> methodInfos<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>subscriberClass<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> shouldCheckSuperclass<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>methodInfos</span> <span style=color:#f92672>=</span> methodInfos<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>synchronized</span> SubscriberMethod<span style=color:#f92672>[]</span> <span style=color:#a6e22e>getSubscriberMethods</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> length <span style=color:#f92672>=</span> methodInfos<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        SubscriberMethod<span style=color:#f92672>[]</span> methods <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SubscriberMethod<span style=color:#f92672>[</span>length<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> length<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            SubscriberMethodInfo info <span style=color:#f92672>=</span> methodInfos<span style=color:#f92672>[</span>i<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>            methods<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> createSubscriberMethod<span style=color:#f92672>(</span>info<span style=color:#f92672>.</span><span style=color:#a6e22e>methodName</span><span style=color:#f92672>,</span> info<span style=color:#f92672>.</span><span style=color:#a6e22e>eventType</span><span style=color:#f92672>,</span> info<span style=color:#f92672>.</span><span style=color:#a6e22e>threadMode</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                    info<span style=color:#f92672>.</span><span style=color:#a6e22e>priority</span><span style=color:#f92672>,</span> info<span style=color:#f92672>.</span><span style=color:#a6e22e>sticky</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> methods<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=subscribermethod>SubscriberMethod
<a class=anchor href=#subscribermethod>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SubscriberMethod</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> Method method<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> ThreadMode threadMode<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> Class<span style=color:#f92672>&lt;?&gt;</span> eventType<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> priority<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> sticky<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** Used for efficient comparison */</span>
</span></span><span style=display:flex><span>    String methodString<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>SubscriberMethod</span><span style=color:#f92672>(</span>Method method<span style=color:#f92672>,</span> Class<span style=color:#f92672>&lt;?&gt;</span> eventType<span style=color:#f92672>,</span> 
</span></span><span style=display:flex><span>            ThreadMode threadMode<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> priority<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> sticky<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>method</span> <span style=color:#f92672>=</span> method<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>threadMode</span> <span style=color:#f92672>=</span> threadMode<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>eventType</span> <span style=color:#f92672>=</span> eventType<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>priority</span> <span style=color:#f92672>=</span> priority<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sticky</span> <span style=color:#f92672>=</span> sticky<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>Object other<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>other <span style=color:#f92672>==</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>other <span style=color:#66d9ef>instanceof</span> SubscriberMethod<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            checkMethodString<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            SubscriberMethod otherSubscriberMethod <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>SubscriberMethod<span style=color:#f92672>)</span>other<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            otherSubscriberMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>checkMethodString</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Don&#39;t use method.equals because of http://code.google.com/p/android/issues/detail?id=7811#c6
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>return</span> methodString<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>otherSubscriberMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>methodString</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>checkMethodString</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>methodString <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Method.toString has more overhead, just take relevant parts of the method
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            StringBuilder builder <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> StringBuilder<span style=color:#f92672>(</span>64<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            builder<span style=color:#f92672>.</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span>method<span style=color:#f92672>.</span><span style=color:#a6e22e>getDeclaringClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            builder<span style=color:#f92672>.</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#39;#&#39;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span>method<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            builder<span style=color:#f92672>.</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#39;(&#39;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span>eventType<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            methodString <span style=color:#f92672>=</span> builder<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>hashCode</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>hashCode</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=subscribermethodinfo>SubscriberMethodInfo
<a class=anchor href=#subscribermethodinfo>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SubscriberMethodInfo</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> String methodName<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> ThreadMode threadMode<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> Class<span style=color:#f92672>&lt;?&gt;</span> eventType<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> priority<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> sticky<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>SubscriberMethodInfo</span><span style=color:#f92672>(</span>String methodName<span style=color:#f92672>,</span> Class<span style=color:#f92672>&lt;?&gt;</span> eventType<span style=color:#f92672>,</span> 
</span></span><span style=display:flex><span>            ThreadMode threadMode<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> priority<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> sticky<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>methodName</span> <span style=color:#f92672>=</span> methodName<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>threadMode</span> <span style=color:#f92672>=</span> threadMode<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>eventType</span> <span style=color:#f92672>=</span> eventType<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>priority</span> <span style=color:#f92672>=</span> priority<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sticky</span> <span style=color:#f92672>=</span> sticky<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>SubscriberMethodInfo</span><span style=color:#f92672>(</span>String methodName<span style=color:#f92672>,</span> Class<span style=color:#f92672>&lt;?&gt;</span> eventType<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>(</span>methodName<span style=color:#f92672>,</span> eventType<span style=color:#f92672>,</span> ThreadMode<span style=color:#f92672>.</span><span style=color:#a6e22e>POSTING</span><span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>SubscriberMethodInfo</span><span style=color:#f92672>(</span>String methodName<span style=color:#f92672>,</span> Class<span style=color:#f92672>&lt;?&gt;</span> eventType<span style=color:#f92672>,</span> ThreadMode threadMode<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>(</span>methodName<span style=color:#f92672>,</span> eventType<span style=color:#f92672>,</span> threadMode<span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=subscriberinfo-映射>SubscriberInfo 映射
<a class=anchor href=#subscriberinfo-%e6%98%a0%e5%b0%84>#</a></h3><p>回到 <code>MyEventBusIndex</code> 的 static 代码块，对于每一个调用过 <code>EventBus.register()</code> 方法的类，APT（Annotation Processing Tool）都会为它生成一行 <code>putIndex(...)</code> 代码，并传入一个新建的 <code>SimpleSubscriberInfo</code> 对象。</p><p>在 <code>putIndex()</code> 方法中会调用传入的 <code>SimpleSubscriberInfo.getSubscriberClass()</code> 获取到订阅类的 Class 对象作为 key，同时把自身作为 value 存放进 Map 中。</p><h2 id=register-流程>register 流程
<a class=anchor href=#register-%e6%b5%81%e7%a8%8b>#</a></h2><p>先看 <code>EventBus.register</code> 方法，在分析过程中遇到的字段再回过头来分析。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>register</span><span style=color:#f92672>(</span>Object subscriber<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取 subscriber 的 Class 对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Class<span style=color:#f92672>&lt;?&gt;</span> subscriberClass <span style=color:#f92672>=</span> subscriber<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 根据 Class 信息获取到所有加了 @Subscribe 的事件回调方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    List<span style=color:#f92672>&lt;</span>SubscriberMethod<span style=color:#f92672>&gt;</span> subscriberMethods <span style=color:#f92672>=</span> subscriberMethodFinder<span style=color:#f92672>.</span><span style=color:#a6e22e>findSubscriberMethods</span><span style=color:#f92672>(</span>subscriberClass<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 遍历各个方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>SubscriberMethod subscriberMethod <span style=color:#f92672>:</span> subscriberMethods<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 执行订阅操作
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            subscribe<span style=color:#f92672>(</span>subscriber<span style=color:#f92672>,</span> subscriberMethod<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>上面的代码可以分为两个部分，2~3 行完成了获取注册对象中加了 <code>@Subscribe</code> 的事件回调方法，后面的代码真正完成了注册。</p><h3 id=subscribermethodfinderfindsubscribermethods>SubscriberMethodFinder.findSubscriberMethods()
<a class=anchor href=#subscribermethodfinderfindsubscribermethods>#</a></h3><p><code>subscriberMethodFinder</code> 在 EventBus 创建的时候就已经确定了，它的定义如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SubscriberMethodFinder</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> BRIDGE <span style=color:#f92672>=</span> 0x40<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> SYNTHETIC <span style=color:#f92672>=</span> 0x1000<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> MODIFIERS_IGNORE <span style=color:#f92672>=</span> Modifier<span style=color:#f92672>.</span><span style=color:#a6e22e>ABSTRACT</span> <span style=color:#f92672>|</span> Modifier<span style=color:#f92672>.</span><span style=color:#a6e22e>STATIC</span> <span style=color:#f92672>|</span> BRIDGE <span style=color:#f92672>|</span> SYNTHETIC<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Map<span style=color:#f92672>&lt;</span>Class<span style=color:#f92672>&lt;?&gt;,</span> List<span style=color:#f92672>&lt;</span>SubscriberMethod<span style=color:#f92672>&gt;&gt;</span> METHOD_CACHE <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ConcurrentHashMap<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>SubscriberInfoIndex<span style=color:#f92672>&gt;</span> subscriberInfoIndexes<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> strictMethodVerification<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> ignoreGeneratedIndex<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> POOL_SIZE <span style=color:#f92672>=</span> 4<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> FindState<span style=color:#f92672>[]</span> FIND_STATE_POOL <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FindState<span style=color:#f92672>[</span>POOL_SIZE<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    SubscriberMethodFinder<span style=color:#f92672>(</span>List<span style=color:#f92672>&lt;</span>SubscriberInfoIndex<span style=color:#f92672>&gt;</span> subscriberInfoIndexes<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> strictMethodVerification<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                           <span style=color:#66d9ef>boolean</span> ignoreGeneratedIndex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>subscriberInfoIndexes</span> <span style=color:#f92672>=</span> subscriberInfoIndexes<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>strictMethodVerification</span> <span style=color:#f92672>=</span> strictMethodVerification<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>ignoreGeneratedIndex</span> <span style=color:#f92672>=</span> ignoreGeneratedIndex<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>SubscriberMethod<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>findSubscriberMethods</span><span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;?&gt;</span> subscriberClass<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        List<span style=color:#f92672>&lt;</span>SubscriberMethod<span style=color:#f92672>&gt;</span> subscriberMethods <span style=color:#f92672>=</span> METHOD_CACHE<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>subscriberClass<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>subscriberMethods <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> subscriberMethods<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>ignoreGeneratedIndex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            subscriberMethods <span style=color:#f92672>=</span> findUsingReflection<span style=color:#f92672>(</span>subscriberClass<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            subscriberMethods <span style=color:#f92672>=</span> findUsingInfo<span style=color:#f92672>(</span>subscriberClass<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>subscriberMethods<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> EventBusException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Subscriber &#34;</span> <span style=color:#f92672>+</span> subscriberClass
</span></span><span style=display:flex><span>                    <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; and its super classes have no public methods with the @Subscribe annotation&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            METHOD_CACHE<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>subscriberClass<span style=color:#f92672>,</span> subscriberMethods<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> subscriberMethods<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>SubscriberMethod<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>findUsingInfo</span><span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;?&gt;</span> subscriberClass<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        FindState findState <span style=color:#f92672>=</span> prepareFindState<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        findState<span style=color:#f92672>.</span><span style=color:#a6e22e>initForSubscriber</span><span style=color:#f92672>(</span>subscriberClass<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>findState<span style=color:#f92672>.</span><span style=color:#a6e22e>clazz</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            findState<span style=color:#f92672>.</span><span style=color:#a6e22e>subscriberInfo</span> <span style=color:#f92672>=</span> getSubscriberInfo<span style=color:#f92672>(</span>findState<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>findState<span style=color:#f92672>.</span><span style=color:#a6e22e>subscriberInfo</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                SubscriberMethod<span style=color:#f92672>[]</span> array <span style=color:#f92672>=</span> findState<span style=color:#f92672>.</span><span style=color:#a6e22e>subscriberInfo</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getSubscriberMethods</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>SubscriberMethod subscriberMethod <span style=color:#f92672>:</span> array<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>findState<span style=color:#f92672>.</span><span style=color:#a6e22e>checkAdd</span><span style=color:#f92672>(</span>subscriberMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>method</span><span style=color:#f92672>,</span> subscriberMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>eventType</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        findState<span style=color:#f92672>.</span><span style=color:#a6e22e>subscriberMethods</span><span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>subscriberMethod<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                findUsingReflectionInSingleClass<span style=color:#f92672>(</span>findState<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            findState<span style=color:#f92672>.</span><span style=color:#a6e22e>moveToSuperclass</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> getMethodsAndRelease<span style=color:#f92672>(</span>findState<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>SubscriberMethod<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getMethodsAndRelease</span><span style=color:#f92672>(</span>FindState findState<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        List<span style=color:#f92672>&lt;</span>SubscriberMethod<span style=color:#f92672>&gt;</span> subscriberMethods <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;(</span>findState<span style=color:#f92672>.</span><span style=color:#a6e22e>subscriberMethods</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        findState<span style=color:#f92672>.</span><span style=color:#a6e22e>recycle</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span>FIND_STATE_POOL<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> POOL_SIZE<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>FIND_STATE_POOL<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    FIND_STATE_POOL<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> findState<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> subscriberMethods<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> FindState <span style=color:#a6e22e>prepareFindState</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span>FIND_STATE_POOL<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> POOL_SIZE<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                FindState state <span style=color:#f92672>=</span> FIND_STATE_POOL<span style=color:#f92672>[</span>i<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>state <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    FIND_STATE_POOL<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> state<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> FindState<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> SubscriberInfo <span style=color:#a6e22e>getSubscriberInfo</span><span style=color:#f92672>(</span>FindState findState<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>findState<span style=color:#f92672>.</span><span style=color:#a6e22e>subscriberInfo</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> findState<span style=color:#f92672>.</span><span style=color:#a6e22e>subscriberInfo</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getSuperSubscriberInfo</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            SubscriberInfo superclassInfo <span style=color:#f92672>=</span> findState<span style=color:#f92672>.</span><span style=color:#a6e22e>subscriberInfo</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getSuperSubscriberInfo</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>findState<span style=color:#f92672>.</span><span style=color:#a6e22e>clazz</span> <span style=color:#f92672>==</span> superclassInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>getSubscriberClass</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> superclassInfo<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>subscriberInfoIndexes <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>SubscriberInfoIndex index <span style=color:#f92672>:</span> subscriberInfoIndexes<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                SubscriberInfo info <span style=color:#f92672>=</span> index<span style=color:#f92672>.</span><span style=color:#a6e22e>getSubscriberInfo</span><span style=color:#f92672>(</span>findState<span style=color:#f92672>.</span><span style=color:#a6e22e>clazz</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>info <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> info<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>SubscriberMethod<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>findUsingReflection</span><span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;?&gt;</span> subscriberClass<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        FindState findState <span style=color:#f92672>=</span> prepareFindState<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        findState<span style=color:#f92672>.</span><span style=color:#a6e22e>initForSubscriber</span><span style=color:#f92672>(</span>subscriberClass<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>findState<span style=color:#f92672>.</span><span style=color:#a6e22e>clazz</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            findUsingReflectionInSingleClass<span style=color:#f92672>(</span>findState<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            findState<span style=color:#f92672>.</span><span style=color:#a6e22e>moveToSuperclass</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> getMethodsAndRelease<span style=color:#f92672>(</span>findState<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>findUsingReflectionInSingleClass</span><span style=color:#f92672>(</span>FindState findState<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Method<span style=color:#f92672>[]</span> methods<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// This is faster than getMethods, especially when subscribers are fat classes like Activities
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            methods <span style=color:#f92672>=</span> findState<span style=color:#f92672>.</span><span style=color:#a6e22e>clazz</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getDeclaredMethods</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Throwable th<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Workaround for java.lang.NoClassDefFoundError, see https://github.com/greenrobot/EventBus/issues/149
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                methods <span style=color:#f92672>=</span> findState<span style=color:#f92672>.</span><span style=color:#a6e22e>clazz</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getMethods</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>LinkageError error<span style=color:#f92672>)</span> <span style=color:#f92672>{</span> <span style=color:#75715e>// super class of NoClassDefFoundError to be a bit more broad...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                String msg <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Could not inspect methods of &#34;</span> <span style=color:#f92672>+</span> findState<span style=color:#f92672>.</span><span style=color:#a6e22e>clazz</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>ignoreGeneratedIndex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    msg <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;. Please consider using EventBus annotation processor to avoid reflection.&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    msg <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;. Please make this class visible to EventBus annotation processor to avoid reflection.&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> EventBusException<span style=color:#f92672>(</span>msg<span style=color:#f92672>,</span> error<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            findState<span style=color:#f92672>.</span><span style=color:#a6e22e>skipSuperClasses</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Method method <span style=color:#f92672>:</span> methods<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> modifiers <span style=color:#f92672>=</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getModifiers</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>modifiers <span style=color:#f92672>&amp;</span> Modifier<span style=color:#f92672>.</span><span style=color:#a6e22e>PUBLIC</span><span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> 0 <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>(</span>modifiers <span style=color:#f92672>&amp;</span> MODIFIERS_IGNORE<span style=color:#f92672>)</span> <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                Class<span style=color:#f92672>&lt;?&gt;[]</span> parameterTypes <span style=color:#f92672>=</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getParameterTypes</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>parameterTypes<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span> <span style=color:#f92672>==</span> 1<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    Subscribe subscribeAnnotation <span style=color:#f92672>=</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getAnnotation</span><span style=color:#f92672>(</span>Subscribe<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>subscribeAnnotation <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        Class<span style=color:#f92672>&lt;?&gt;</span> eventType <span style=color:#f92672>=</span> parameterTypes<span style=color:#f92672>[</span>0<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>findState<span style=color:#f92672>.</span><span style=color:#a6e22e>checkAdd</span><span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> eventType<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            ThreadMode threadMode <span style=color:#f92672>=</span> subscribeAnnotation<span style=color:#f92672>.</span><span style=color:#a6e22e>threadMode</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                            findState<span style=color:#f92672>.</span><span style=color:#a6e22e>subscriberMethods</span><span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> SubscriberMethod<span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> eventType<span style=color:#f92672>,</span> threadMode<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                    subscribeAnnotation<span style=color:#f92672>.</span><span style=color:#a6e22e>priority</span><span style=color:#f92672>(),</span> subscribeAnnotation<span style=color:#f92672>.</span><span style=color:#a6e22e>sticky</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>strictMethodVerification <span style=color:#f92672>&amp;&amp;</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>isAnnotationPresent</span><span style=color:#f92672>(</span>Subscribe<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    String methodName <span style=color:#f92672>=</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getDeclaringClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.&#34;</span> <span style=color:#f92672>+</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> EventBusException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;@Subscribe method &#34;</span> <span style=color:#f92672>+</span> methodName <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                            <span style=color:#e6db74>&#34;must have exactly 1 parameter but has &#34;</span> <span style=color:#f92672>+</span> parameterTypes<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>strictMethodVerification <span style=color:#f92672>&amp;&amp;</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>isAnnotationPresent</span><span style=color:#f92672>(</span>Subscribe<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                String methodName <span style=color:#f92672>=</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getDeclaringClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.&#34;</span> <span style=color:#f92672>+</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> EventBusException<span style=color:#f92672>(</span>methodName <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34; is a illegal @Subscribe method: must be public, non-static, and non-abstract&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>clearCaches</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        METHOD_CACHE<span style=color:#f92672>.</span><span style=color:#a6e22e>clear</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FindState</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> List<span style=color:#f92672>&lt;</span>SubscriberMethod<span style=color:#f92672>&gt;</span> subscriberMethods <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> Map<span style=color:#f92672>&lt;</span>Class<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> anyMethodByEventType <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Class<span style=color:#f92672>&gt;</span> subscriberClassByMethodKey <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> StringBuilder methodKeyBuilder <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> StringBuilder<span style=color:#f92672>(</span>128<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Class<span style=color:#f92672>&lt;?&gt;</span> subscriberClass<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        Class<span style=color:#f92672>&lt;?&gt;</span> clazz<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>boolean</span> skipSuperClasses<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        SubscriberInfo subscriberInfo<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>initForSubscriber</span><span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;?&gt;</span> subscriberClass<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>subscriberClass</span> <span style=color:#f92672>=</span> clazz <span style=color:#f92672>=</span> subscriberClass<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            skipSuperClasses <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            subscriberInfo <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>recycle</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            subscriberMethods<span style=color:#f92672>.</span><span style=color:#a6e22e>clear</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            anyMethodByEventType<span style=color:#f92672>.</span><span style=color:#a6e22e>clear</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            subscriberClassByMethodKey<span style=color:#f92672>.</span><span style=color:#a6e22e>clear</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            methodKeyBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>setLength</span><span style=color:#f92672>(</span>0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            subscriberClass <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            clazz <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            skipSuperClasses <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            subscriberInfo <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>checkAdd</span><span style=color:#f92672>(</span>Method method<span style=color:#f92672>,</span> Class<span style=color:#f92672>&lt;?&gt;</span> eventType<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 2 level check: 1st level with event type only (fast), 2nd level with complete signature when required.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// Usually a subscriber doesn&#39;t have methods listening to the same event type.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            Object existing <span style=color:#f92672>=</span> anyMethodByEventType<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>eventType<span style=color:#f92672>,</span> method<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>existing <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>existing <span style=color:#66d9ef>instanceof</span> Method<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>checkAddWithMethodSignature<span style=color:#f92672>((</span>Method<span style=color:#f92672>)</span> existing<span style=color:#f92672>,</span> eventType<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// Paranoia check
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// Put any non-Method object to &#34;consume&#34; the existing Method
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    anyMethodByEventType<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>eventType<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> checkAddWithMethodSignature<span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> eventType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>checkAddWithMethodSignature</span><span style=color:#f92672>(</span>Method method<span style=color:#f92672>,</span> Class<span style=color:#f92672>&lt;?&gt;</span> eventType<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            methodKeyBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>setLength</span><span style=color:#f92672>(</span>0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            methodKeyBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span>method<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            methodKeyBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#39;&gt;&#39;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span>eventType<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            String methodKey <span style=color:#f92672>=</span> methodKeyBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            Class<span style=color:#f92672>&lt;?&gt;</span> methodClass <span style=color:#f92672>=</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getDeclaringClass</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            Class<span style=color:#f92672>&lt;?&gt;</span> methodClassOld <span style=color:#f92672>=</span> subscriberClassByMethodKey<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>methodKey<span style=color:#f92672>,</span> methodClass<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>methodClassOld <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> methodClassOld<span style=color:#f92672>.</span><span style=color:#a6e22e>isAssignableFrom</span><span style=color:#f92672>(</span>methodClass<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Only add if not already found in a sub class
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Revert the put, old class is further down the class hierarchy
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                subscriberClassByMethodKey<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>methodKey<span style=color:#f92672>,</span> methodClassOld<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>moveToSuperclass</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>skipSuperClasses<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                clazz <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                clazz <span style=color:#f92672>=</span> clazz<span style=color:#f92672>.</span><span style=color:#a6e22e>getSuperclass</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                String clazzName <span style=color:#f92672>=</span> clazz<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Skip system classes, this degrades performance.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// Also we might avoid some ClassNotFoundException (see FAQ for background).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>clazzName<span style=color:#f92672>.</span><span style=color:#a6e22e>startsWith</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;java.&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>||</span> clazzName<span style=color:#f92672>.</span><span style=color:#a6e22e>startsWith</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;javax.&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>                        clazzName<span style=color:#f92672>.</span><span style=color:#a6e22e>startsWith</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;android.&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>||</span> clazzName<span style=color:#f92672>.</span><span style=color:#a6e22e>startsWith</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;androidx.&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    clazz <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>在它的构造方法里，<code>subscriberInfoIndexes</code> 里面只有注解解释器生成的 <code>MyEventBusIndex</code> 对象，其他两个参数都是默认值 false。</p><p>先看看 <code>findSubscriberMethods(subscriberClass)</code> 是如何完成 <code>@Subscribe</code> 方法的解析的：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>List<span style=color:#f92672>&lt;</span>SubscriberMethod<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>findSubscriberMethods</span><span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;?&gt;</span> subscriberClass<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 1、如果能获取缓存，直接返回
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    List<span style=color:#f92672>&lt;</span>SubscriberMethod<span style=color:#f92672>&gt;</span> subscriberMethods <span style=color:#f92672>=</span> METHOD_CACHE<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>subscriberClass<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>subscriberMethods <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> subscriberMethods<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 2、判断是否忽略索引
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>ignoreGeneratedIndex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 使用反射来获取事件回调方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        subscriberMethods <span style=color:#f92672>=</span> findUsingReflection<span style=color:#f92672>(</span>subscriberClass<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 尝试从索引文件获取事件回调方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        subscriberMethods <span style=color:#f92672>=</span> findUsingInfo<span style=color:#f92672>(</span>subscriberClass<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>subscriberMethods<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> EventBusException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Subscriber &#34;</span> <span style=color:#f92672>+</span> subscriberClass
</span></span><span style=display:flex><span>                <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; and its super classes have no public methods with the @Subscribe annotation&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 3、写入缓存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        METHOD_CACHE<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>subscriberClass<span style=color:#f92672>,</span> subscriberMethods<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> subscriberMethods<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>注释 1 处是取缓存的操作。页面的生命周期可能会频繁发生变化，因而就可能导致事件的频繁注册、注销，这时候缓存就非常有用了。</p><p>注释 2 处，由于 <code>ignoreGeneratedIndex</code> 默认为 false，所以这里会执行 <code>findUsingInfo</code> 方法来获取订阅类的回调方法。</p><p>注释 3 在方法最后返回之前，会进行缓存的更新。</p><p>先分析一下 <code>findUsingInfo</code> 方法。</p><h4 id=subscribermethodfinderfindusinginfo>SubscriberMethodFinder.findUsingInfo()
<a class=anchor href=#subscribermethodfinderfindusinginfo>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>SubscriberMethod<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>findUsingInfo</span><span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;?&gt;</span> subscriberClass<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    FindState findState <span style=color:#f92672>=</span> prepareFindState<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    findState<span style=color:#f92672>.</span><span style=color:#a6e22e>initForSubscriber</span><span style=color:#f92672>(</span>subscriberClass<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 开启循环
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>findState<span style=color:#f92672>.</span><span style=color:#a6e22e>clazz</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 获取目标方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        findState<span style=color:#f92672>.</span><span style=color:#a6e22e>subscriberInfo</span> <span style=color:#f92672>=</span> getSubscriberInfo<span style=color:#f92672>(</span>findState<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>findState<span style=color:#f92672>.</span><span style=color:#a6e22e>subscriberInfo</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            SubscriberMethod<span style=color:#f92672>[]</span> array <span style=color:#f92672>=</span> findState<span style=color:#f92672>.</span><span style=color:#a6e22e>subscriberInfo</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getSubscriberMethods</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>SubscriberMethod subscriberMethod <span style=color:#f92672>:</span> array<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>findState<span style=color:#f92672>.</span><span style=color:#a6e22e>checkAdd</span><span style=color:#f92672>(</span>subscriberMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>method</span><span style=color:#f92672>,</span> subscriberMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>eventType</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    findState<span style=color:#f92672>.</span><span style=color:#a6e22e>subscriberMethods</span><span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>subscriberMethod<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            findUsingReflectionInSingleClass<span style=color:#f92672>(</span>findState<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 在父类中查找目标方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        findState<span style=color:#f92672>.</span><span style=color:#a6e22e>moveToSuperclass</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> getMethodsAndRelease<span style=color:#f92672>(</span>findState<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h5 id=subscribermethodfinderpreparefindstate>SubscriberMethodFinder.prepareFindState()
<a class=anchor href=#subscribermethodfinderpreparefindstate>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> FindState <span style=color:#a6e22e>prepareFindState</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span>FIND_STATE_POOL<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> POOL_SIZE<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            FindState state <span style=color:#f92672>=</span> FIND_STATE_POOL<span style=color:#f92672>[</span>i<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>state <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                FIND_STATE_POOL<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> state<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> FindState<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>通过 <code>prepareFindState()</code> 方法尝试从对象池中获取一个 <code>FindState</code> 对象，若对象池中没有可用的对象，则新建一个。</p><h5 id=findstateinitforsubscriber>FindState.initForSubscriber()
<a class=anchor href=#findstateinitforsubscriber>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>initForSubscriber</span><span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;?&gt;</span> subscriberClass<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>subscriberClass</span> <span style=color:#f92672>=</span> clazz <span style=color:#f92672>=</span> subscriberClass<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    skipSuperClasses <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    subscriberInfo <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>初始化 <code>FindState</code> 对象，使其内部的 <code>subscriberClass</code>、<code>clazz</code> 都是订阅类，并且注意这时候 <code>subscriberInfo = null</code>、<code>skipSuperClasses = false</code>。</p><p>接着查看 <code>getSubscriberInfo()</code> 方法：</p><h5 id=subscribermethodfindergetsubscriberinfo>SubscriberMethodFinder.getSubscriberInfo()
<a class=anchor href=#subscribermethodfindergetsubscriberinfo>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> SubscriberInfo <span style=color:#a6e22e>getSubscriberInfo</span><span style=color:#f92672>(</span>FindState findState<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>findState<span style=color:#f92672>.</span><span style=color:#a6e22e>subscriberInfo</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> findState<span style=color:#f92672>.</span><span style=color:#a6e22e>subscriberInfo</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getSuperSubscriberInfo</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        SubscriberInfo superclassInfo <span style=color:#f92672>=</span> findState<span style=color:#f92672>.</span><span style=color:#a6e22e>subscriberInfo</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getSuperSubscriberInfo</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>findState<span style=color:#f92672>.</span><span style=color:#a6e22e>clazz</span> <span style=color:#f92672>==</span> superclassInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>getSubscriberClass</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> superclassInfo<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>subscriberInfoIndexes <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>SubscriberInfoIndex index <span style=color:#f92672>:</span> subscriberInfoIndexes<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            SubscriberInfo info <span style=color:#f92672>=</span> index<span style=color:#f92672>.</span><span style=color:#a6e22e>getSubscriberInfo</span><span style=color:#f92672>(</span>findState<span style=color:#f92672>.</span><span style=color:#a6e22e>clazz</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>info <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> info<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这里首先会通过 FindState 去父类中。。。</p><p>但是这里 <code>findState.subscriberInfo</code> 是为 null 的，因此不满足条件，接下来会判断 subscriberInfoIndexes（本例中只包含创建 EventBus 对象时传入的 MyEventBusIndex 对象）集合是否为空，如果不为空就会通过 Index 类去查找目标方法。</p><p>再次回到 <code>findUsingInfo()</code> 方法，可以看到，如果没有找到目标回调方法，也会调用 <code>findUsingReflectionInSingleClass()</code> 使用来获取回调方法。因此，<code>findUsingInfo()</code> 等于是 <code>findUsingReflection()</code> 方法的加强版本。</p><p>后面的 while 循环就是从当前的订阅类开始，一直向父类进行循环操作，也就是说，<strong>这里会解析当前订阅类的父类里面的方法</strong>。</p><p>如果找到目标回调方法，在通过 <code>findState.checkAdd()</code> 校验之后，事件回调方法都被加入到了 <code>findState.subscriberMethods</code> 中，然后由 <code>getMethodsAndRelease(findState)</code> 方法返回。<code>getMethodsAndRelease()</code> 方法就是将 <code>findState.subscriberMethods</code> 复制了出来，然后回收了 FindState 对象：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>SubscriberMethod<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getMethodsAndRelease</span><span style=color:#f92672>(</span>FindState findState<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    List<span style=color:#f92672>&lt;</span>SubscriberMethod<span style=color:#f92672>&gt;</span> subscriberMethods <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;(</span>findState<span style=color:#f92672>.</span><span style=color:#a6e22e>subscriberMethods</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 2
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    findState<span style=color:#f92672>.</span><span style=color:#a6e22e>recycle</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 3
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>synchronized</span><span style=color:#f92672>(</span>FIND_STATE_POOL<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> POOL_SIZE<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>FIND_STATE_POOL<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                FIND_STATE_POOL<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> findState<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> subscriberMethods<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>首先会从 findState 中取出了保存的 subscriberMethods；然后将 findState 里的保存的所有对象进行回收；接着会把把 findState 存储在 FindState 池中方便下一次使用，以提高性能。最后，返回 subscriberMethods。</p><h4 id=subscribermethodfinderfindusingreflection>SubscriberMethodFinder.findUsingReflection()
<a class=anchor href=#subscribermethodfinderfindusingreflection>#</a></h4><p>上面就是注解处理器生成的 Index 参与的时候的流程。在这里还是有必要说一下没有 Index 参与时的流程，也就是 <code>findUsingReflectionInSingleClass()</code> 方法是如何获取订阅类的回调方法的。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>SubscriberMethod<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>findUsingReflection</span><span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;?&gt;</span> subscriberClass<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    FindState findState <span style=color:#f92672>=</span> prepareFindState<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    findState<span style=color:#f92672>.</span><span style=color:#a6e22e>initForSubscriber</span><span style=color:#f92672>(</span>subscriberClass<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>findState<span style=color:#f92672>.</span><span style=color:#a6e22e>clazz</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        findUsingReflectionInSingleClass<span style=color:#f92672>(</span>findState<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        findState<span style=color:#f92672>.</span><span style=color:#a6e22e>moveToSuperclass</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> getMethodsAndRelease<span style=color:#f92672>(</span>findState<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这里同样走到了 <code>findUsingReflectionInSingleClass()</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>findUsingReflectionInSingleClass</span><span style=color:#f92672>(</span>FindState findState<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Method<span style=color:#f92672>[]</span> methods<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// This is faster than getMethods, especially when subscribers are fat classes like Activities
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 获取该类的所有方法，不包括父类
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        methods <span style=color:#f92672>=</span> findState<span style=color:#f92672>.</span><span style=color:#a6e22e>clazz</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getDeclaredMethods</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Throwable th<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Workaround for java.lang.NoClassDefFoundError, see https://github.com/greenrobot/EventBus/issues/149
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 获取该类以及父类的所有 public 方法，同时指定忽略父类
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            methods <span style=color:#f92672>=</span> findState<span style=color:#f92672>.</span><span style=color:#a6e22e>clazz</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getMethods</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>LinkageError error<span style=color:#f92672>)</span> <span style=color:#f92672>{</span> <span style=color:#75715e>// super class of NoClassDefFoundError to be a bit more broad...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            String msg <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Could not inspect methods of &#34;</span> <span style=color:#f92672>+</span> findState<span style=color:#f92672>.</span><span style=color:#a6e22e>clazz</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>ignoreGeneratedIndex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                msg <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;. Please consider using EventBus annotation processor to avoid reflection.&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                msg <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;. Please make this class visible to EventBus annotation processor to avoid reflection.&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> EventBusException<span style=color:#f92672>(</span>msg<span style=color:#f92672>,</span> error<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 标记为跳过父类方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        findState<span style=color:#f92672>.</span><span style=color:#a6e22e>skipSuperClasses</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Method method <span style=color:#f92672>:</span> methods<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> modifiers <span style=color:#f92672>=</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getModifiers</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 判断方法是否是 PUBLIC 且不是 ABSTRACT、STATIC、SYNTHETIC
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>modifiers <span style=color:#f92672>&amp;</span> Modifier<span style=color:#f92672>.</span><span style=color:#a6e22e>PUBLIC</span><span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> 0 <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>(</span>modifiers <span style=color:#f92672>&amp;</span> MODIFIERS_IGNORE<span style=color:#f92672>)</span> <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Class<span style=color:#f92672>&lt;?&gt;[]</span> parameterTypes <span style=color:#f92672>=</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getParameterTypes</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 判断该方法的参数是不是只有一个
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>parameterTypes<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span> <span style=color:#f92672>==</span> 1<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 判断方法是否有 Subscribe 注解
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                Subscribe subscribeAnnotation <span style=color:#f92672>=</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getAnnotation</span><span style=color:#f92672>(</span>Subscribe<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>subscribeAnnotation <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 以上条件都满足后，就进行最后的校验，然后添加到 findState.subscriberMethods 中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    Class<span style=color:#f92672>&lt;?&gt;</span> eventType <span style=color:#f92672>=</span> parameterTypes<span style=color:#f92672>[</span>0<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>findState<span style=color:#f92672>.</span><span style=color:#a6e22e>checkAdd</span><span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> eventType<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        ThreadMode threadMode <span style=color:#f92672>=</span> subscribeAnnotation<span style=color:#f92672>.</span><span style=color:#a6e22e>threadMode</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                        findState<span style=color:#f92672>.</span><span style=color:#a6e22e>subscriberMethods</span><span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> SubscriberMethod<span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> eventType<span style=color:#f92672>,</span> threadMode<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                subscribeAnnotation<span style=color:#f92672>.</span><span style=color:#a6e22e>priority</span><span style=color:#f92672>(),</span> subscribeAnnotation<span style=color:#f92672>.</span><span style=color:#a6e22e>sticky</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>strictMethodVerification <span style=color:#f92672>&amp;&amp;</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>isAnnotationPresent</span><span style=color:#f92672>(</span>Subscribe<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 方法参数 ！= 1,如果开启了严格验证则抛出异常
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                String methodName <span style=color:#f92672>=</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getDeclaringClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.&#34;</span> <span style=color:#f92672>+</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> EventBusException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;@Subscribe method &#34;</span> <span style=color:#f92672>+</span> methodName <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;must have exactly 1 parameter but has &#34;</span> <span style=color:#f92672>+</span> parameterTypes<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>strictMethodVerification <span style=color:#f92672>&amp;&amp;</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>isAnnotationPresent</span><span style=color:#f92672>(</span>Subscribe<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 方法修饰符不合要求，如果开启了严格验证，则抛出异常
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            String methodName <span style=color:#f92672>=</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getDeclaringClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.&#34;</span> <span style=color:#f92672>+</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> EventBusException<span style=color:#f92672>(</span>methodName <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34; is a illegal @Subscribe method: must be public, non-static, and non-abstract&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这个方法大概分为两部分：</p><ol><li>首先通过反射的方式获取订阅者类中的所有声明方法，然后在这些方法里面寻找以 <code>@Subscribe</code> 作为注解的方法进行处理。</li><li>再经过经过一轮检查，看看 <code>findState.subscriberMethods</code> 是否存在，如果没有，将方法名、threadMode、优先级、是否为 sticky 方法等信息封装到 SubscriberMethod 对象中，最后添加到 subscriberMethods 列表中。</li></ol><p>从上面方法的分析我们可以看出，订阅类的方法要满足以下条件，才能够顺利的进行注册：</p><ol><li>方法必须是 <code>public</code> 的，且不能是 <code>abstract</code>、<code>static</code>、<code>synthetic</code> 的</li><li>方法参数必须只有一个</li><li>方法必须带有 <code>@Subscribe</code> 注解</li></ol><h3 id=eventbussubscribe>EventBus.subscribe()
<a class=anchor href=#eventbussubscribe>#</a></h3><p>上面这些内容就是订阅类回调方法的获取过程了，下面说说回调方法是如何进行注册的。方法为 <code>EventBus.subscribe()</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Must be called in synchronized block
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>subscribe</span><span style=color:#f92672>(</span>Object subscriber<span style=color:#f92672>,</span> SubscriberMethod subscriberMethod<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// eventType 为回调方法的入参类型，Object 类型
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Class<span style=color:#f92672>&lt;?&gt;</span> eventType <span style=color:#f92672>=</span> subscriberMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>eventType</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 将订阅者以及订阅方法封装为一个 Subscription 类
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Subscription newSubscription <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Subscription<span style=color:#f92672>(</span>subscriber<span style=color:#f92672>,</span> subscriberMethod<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    CopyOnWriteArrayList<span style=color:#f92672>&lt;</span>Subscription<span style=color:#f92672>&gt;</span> subscriptions <span style=color:#f92672>=</span> subscriptionsByEventType<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>eventType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>subscriptions <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        subscriptions <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CopyOnWriteArrayList<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// subscriptionsByEventType：以订阅方法的参数为 key，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// Subscription 为 value 进行保存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        subscriptionsByEventType<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>eventType<span style=color:#f92672>,</span> subscriptions<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>subscriptions<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span>newSubscription<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> EventBusException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Subscriber &#34;</span> <span style=color:#f92672>+</span> subscriber<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; already registered to event &#34;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>+</span> eventType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 在订阅参数对应的 Subscription 列表中按照订阅方法的优先级进行排序
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// priority 的数值越高，越在列表的前面；相同 priority 的方法，后来的方法会在后面
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> size <span style=color:#f92672>=</span> subscriptions<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;=</span> size<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>i <span style=color:#f92672>==</span> size <span style=color:#f92672>||</span> subscriberMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>priority</span> <span style=color:#f92672>&gt;</span> subscriptions<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>i<span style=color:#f92672>).</span><span style=color:#a6e22e>subscriberMethod</span><span style=color:#f92672>.</span><span style=color:#a6e22e>priority</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            subscriptions<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>i<span style=color:#f92672>,</span> newSubscription<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 从 typesBySubscriber 中获取
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    List<span style=color:#f92672>&lt;</span>Class<span style=color:#f92672>&lt;?&gt;&gt;</span> subscribedEvents <span style=color:#f92672>=</span> typesBySubscriber<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>subscriber<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>subscribedEvents <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        subscribedEvents <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// typesBySubscriber：以订阅者为 key，订阅方法参数为 value 进行保存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        typesBySubscriber<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>subscriber<span style=color:#f92672>,</span> subscribedEvents<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    subscribedEvents<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>eventType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果订阅方法订阅的是粘性事件，则会在注册时接受到此粘性事件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>subscriberMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>sticky</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>eventInheritance<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Existing sticky events of all subclasses of eventType have to be considered.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// Note: Iterating over all events may be inefficient with lots of sticky events,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// thus data structure should be changed to allow a more efficient lookup
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// (e.g. an additional map storing sub classes of super classes: Class -&gt; List&lt;Class&gt;).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            Set<span style=color:#f92672>&lt;</span>Map<span style=color:#f92672>.</span><span style=color:#a6e22e>Entry</span><span style=color:#f92672>&lt;</span>Class<span style=color:#f92672>&lt;?&gt;,</span> Object<span style=color:#f92672>&gt;&gt;</span> entries <span style=color:#f92672>=</span> stickyEvents<span style=color:#f92672>.</span><span style=color:#a6e22e>entrySet</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Map<span style=color:#f92672>.</span><span style=color:#a6e22e>Entry</span><span style=color:#f92672>&lt;</span>Class<span style=color:#f92672>&lt;?&gt;,</span> Object<span style=color:#f92672>&gt;</span> entry <span style=color:#f92672>:</span> entries<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                Class<span style=color:#f92672>&lt;?&gt;</span> candidateEventType <span style=color:#f92672>=</span> entry<span style=color:#f92672>.</span><span style=color:#a6e22e>getKey</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>eventType<span style=color:#f92672>.</span><span style=color:#a6e22e>isAssignableFrom</span><span style=color:#f92672>(</span>candidateEventType<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    Object stickyEvent <span style=color:#f92672>=</span> entry<span style=color:#f92672>.</span><span style=color:#a6e22e>getValue</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    checkPostStickyEventToSubscription<span style=color:#f92672>(</span>newSubscription<span style=color:#f92672>,</span> stickyEvent<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Object stickyEvent <span style=color:#f92672>=</span> stickyEvents<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>eventType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            checkPostStickyEventToSubscription<span style=color:#f92672>(</span>newSubscription<span style=color:#f92672>,</span> stickyEvent<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>在上面的方法中，会先将订阅者以及订阅事件包装成为一个 <code>Subscription</code> 对象，然后与其他参数一起保存起来，具体为下面两个保存的地方：</p><ul><li><code>subscriptionsByEventType</code>：以订阅事件参数为 key，对应 <code>Subscription</code> 对象数组</li><li><code>typesBySubscriber</code>：以订阅者对象为 key，对应订阅事件参数数组。主要是在 EventBus 的 <code>isRegister()</code> 方法中去使用的，用来判断这个 Subscriber 对象 是否已被注册过。</li></ul><p>另外，Subscription 对象还会根据 priority 进行排序，具体来说：priority 的数值越高，越在列表的前面；相同 priority 的方法，后来的方法会在后面。</p><p>同时我们还可以看出粘性事件的触发机制：</p><ol><li>粘性事件发出时，会主动通知所有可以处理的方法，不管方法是否是粘性的</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>postSticky</span><span style=color:#f92672>(</span>Object event<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span>stickyEvents<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        stickyEvents<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>event<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>(),</span> event<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Should be posted after it is putted, in case the subscriber wants to remove immediately
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    post<span style=color:#f92672>(</span>event<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ol start=2><li>在订阅者进行注册时，如果有可以响应的粘性事件，粘性方法会被触发</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>subscriberMethod</span>.<span style=color:#a6e22e>sticky</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>eventInheritance</span>) {
</span></span><span style=display:flex><span>        ...
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (...) {
</span></span><span style=display:flex><span>             ...
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (...) {
</span></span><span style=display:flex><span>                Object <span style=color:#a6e22e>stickyEvent</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>entry</span>.<span style=color:#a6e22e>getValue</span>();
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>checkPostStickyEventToSubscription</span>(<span style=color:#a6e22e>newSubscription</span>, <span style=color:#a6e22e>stickyEvent</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        Object <span style=color:#a6e22e>stickyEvent</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>stickyEvents</span>.<span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>eventType</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>checkPostStickyEventToSubscription</span>(<span style=color:#a6e22e>newSubscription</span>, <span style=color:#a6e22e>stickyEvent</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=post-流程>post 流程
<a class=anchor href=#post-%e6%b5%81%e7%a8%8b>#</a></h2><p>我们可以调用 <code>EventBus.post()</code> 以及 <code>EventBus.postSticky()</code> 这两个方法来发送事件，前者是普通事件，后者是粘性事件。</p><p>粘性事件的发送比较简单，该方法除了保存了事件之外，还调用了 <code>post</code> 方法当做非粘性事件进行了分发。此时，会主动通知所有可以处理的方法，不管方法是否是粘性的：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>postSticky</span><span style=color:#f92672>(</span>Object event<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span>stickyEvents<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        stickyEvents<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>event<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>(),</span> event<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Should be posted after it is putted, in case the subscriber wants to remove immediately
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    post<span style=color:#f92672>(</span>event<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>另外，前面提到过，在订阅者进行注册时，如果有可以响应的粘性事件，粘性方法会被触发。</p><p>粘性事件不会被消耗掉，除非手动 remove 掉：</p><ul><li><code>removeStickyEvent(Class&lt;T>)</code></li><li><code>removeStickyEvent(Object)</code></li><li><code>removeAllStickyEvents()</code></li></ul><p>接下来，我们看看 <code>EventBus.post()</code> 是如何触发订阅者的回调事件的。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** For ThreadLocal, much faster to set (and get multiple values). */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PostingThreadState</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> List<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> eventQueue <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> isPosting<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> isMainThread<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    Subscription subscription<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    Object event<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> canceled<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ThreadLocal<span style=color:#f92672>&lt;</span>PostingThreadState<span style=color:#f92672>&gt;</span> currentPostingThreadState <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ThreadLocal<span style=color:#f92672>&lt;</span>PostingThreadState<span style=color:#f92672>&gt;()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> PostingThreadState <span style=color:#a6e22e>initialValue</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> PostingThreadState<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** Posts the given event to the event bus. */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>post</span><span style=color:#f92672>(</span>Object event<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    PostingThreadState postingState <span style=color:#f92672>=</span> currentPostingThreadState<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> eventQueue <span style=color:#f92672>=</span> postingState<span style=color:#f92672>.</span><span style=color:#a6e22e>eventQueue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    eventQueue<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>event<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>postingState<span style=color:#f92672>.</span><span style=color:#a6e22e>isPosting</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        postingState<span style=color:#f92672>.</span><span style=color:#a6e22e>isMainThread</span> <span style=color:#f92672>=</span> isMainThread<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        postingState<span style=color:#f92672>.</span><span style=color:#a6e22e>isPosting</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>postingState<span style=color:#f92672>.</span><span style=color:#a6e22e>canceled</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> EventBusException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Internal error. Abort state was not reset&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>while</span> <span style=color:#f92672>(!</span>eventQueue<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                postSingleEvent<span style=color:#f92672>(</span>eventQueue<span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>(</span>0<span style=color:#f92672>),</span> postingState<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            postingState<span style=color:#f92672>.</span><span style=color:#a6e22e>isPosting</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            postingState<span style=color:#f92672>.</span><span style=color:#a6e22e>isMainThread</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>首先会调用 <code>currentPostingThreadState.get()</code> 获取一个 PostingThreadState 对象， currentPostingThreadState 是一个 ThreadLocal 类型的对象，而 PostingThreadState 中包含了一个 eventQueue 和其他一些标志位。</p><p>接着把传入的 event，保存到了当前线程中的一个变量 PostingThreadState 的 eventQueue 事件队列里面，然后开始执行。当在极短时间内多次调用 <code>post</code> 方法时，只会将事件添加到队列里面，第 24 行的代码不成立。而在 31-33 行代码里面，会取时间队列的头进行事件分发。最后所有事件处理完成后，标志位复位。</p><p>下面我们看看 <code>postSingleEvent()</code> 方法，注释都在里面：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>postSingleEvent</span><span style=color:#f92672>(</span>Object event<span style=color:#f92672>,</span> PostingThreadState postingState<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Error <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Class<span style=color:#f92672>&lt;?&gt;</span> eventClass <span style=color:#f92672>=</span> event<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> subscriptionFound <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// eventInheritance 表示事件接收类是否有层次结构
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>eventInheritance<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// lookupAllEventTypes 方法的作用是查询 class 的父类以及接口
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 显然示例中就是一个 Object
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        List<span style=color:#f92672>&lt;</span>Class<span style=color:#f92672>&lt;?&gt;&gt;</span> eventTypes <span style=color:#f92672>=</span> lookupAllEventTypes<span style=color:#f92672>(</span>eventClass<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> countTypes <span style=color:#f92672>=</span> eventTypes<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> h <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> h <span style=color:#f92672>&lt;</span> countTypes<span style=color:#f92672>;</span> h<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Class<span style=color:#f92672>&lt;?&gt;</span> clazz <span style=color:#f92672>=</span> eventTypes<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>h<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 调用 postSingleEventForEventType 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            subscriptionFound <span style=color:#f92672>|=</span> postSingleEventForEventType<span style=color:#f92672>(</span>event<span style=color:#f92672>,</span> postingState<span style=color:#f92672>,</span> clazz<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 直接以当前的 eventClass 调用 postSingleEventForEventType 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        subscriptionFound <span style=color:#f92672>=</span> postSingleEventForEventType<span style=color:#f92672>(</span>event<span style=color:#f92672>,</span> postingState<span style=color:#f92672>,</span> eventClass<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 最后，当没有订阅者可以处理该事件时，EventBus 会抛出一个 NoSubscriberEvent 事件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>subscriptionFound<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>logNoSubscriberMessages<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span><span style=color:#a6e22e>log</span><span style=color:#f92672>(</span>Level<span style=color:#f92672>.</span><span style=color:#a6e22e>FINE</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;No subscribers registered for event &#34;</span> <span style=color:#f92672>+</span> eventClass<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>sendNoSubscriberEvent <span style=color:#f92672>&amp;&amp;</span> eventClass <span style=color:#f92672>!=</span> NoSubscriberEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span> <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>                eventClass <span style=color:#f92672>!=</span> SubscriberExceptionEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            post<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> NoSubscriberEvent<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> event<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>lookupAllEventTypes 方法的作用就是取出 Event 及其父类和接口的 class 列表，当然重复取的话会影响性能，所以它也做了一个 eventTypesCache 的缓存。</p><p>接着看看 <code>postSingleEventForEventType</code> 方法</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>postSingleEventForEventType</span><span style=color:#f92672>(</span>Object event<span style=color:#f92672>,</span> PostingThreadState postingState<span style=color:#f92672>,</span> Class<span style=color:#f92672>&lt;?&gt;</span> eventClass<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// subscriptions 就是示例中对应订阅方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    CopyOnWriteArrayList<span style=color:#f92672>&lt;</span>Subscription<span style=color:#f92672>&gt;</span> subscriptions<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        subscriptions <span style=color:#f92672>=</span> subscriptionsByEventType<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>eventClass<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>subscriptions <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>subscriptions<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Subscription subscription <span style=color:#f92672>:</span> subscriptions<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            postingState<span style=color:#f92672>.</span><span style=color:#a6e22e>event</span> <span style=color:#f92672>=</span> event<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            postingState<span style=color:#f92672>.</span><span style=color:#a6e22e>subscription</span> <span style=color:#f92672>=</span> subscription<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>boolean</span> aborted <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 调用 postToSubscription 进行真正的分发
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                postToSubscription<span style=color:#f92672>(</span>subscription<span style=color:#f92672>,</span> event<span style=color:#f92672>,</span> postingState<span style=color:#f92672>.</span><span style=color:#a6e22e>isMainThread</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                aborted <span style=color:#f92672>=</span> postingState<span style=color:#f92672>.</span><span style=color:#a6e22e>canceled</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                postingState<span style=color:#f92672>.</span><span style=color:#a6e22e>event</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                postingState<span style=color:#f92672>.</span><span style=color:#a6e22e>subscription</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                postingState<span style=color:#f92672>.</span><span style=color:#a6e22e>canceled</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>aborted<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>首先，根据 Event 类型从 subscriptionsByEventType 中取出对应的 subscriptions 对象，最后调用了 <code>postToSubscription()</code> 方法。这里需要注意一个细节，只要 eventClass 可以找到对应的 Subscription，那么该方法就会返回 true，也就是说已经发送给订阅者了。</p><p>最后看看 <code>postToSubscription()</code> 方法，该方法会根据方法的 threaMode 值，决定在哪如何触发回调方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>postToSubscription</span><span style=color:#f92672>(</span>Subscription subscription<span style=color:#f92672>,</span> Object event<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> isMainThread<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>subscription<span style=color:#f92672>.</span><span style=color:#a6e22e>subscriberMethod</span><span style=color:#f92672>.</span><span style=color:#a6e22e>threadMode</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> POSTING<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            invokeSubscriber<span style=color:#f92672>(</span>subscription<span style=color:#f92672>,</span> event<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> MAIN<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isMainThread<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                invokeSubscriber<span style=color:#f92672>(</span>subscription<span style=color:#f92672>,</span> event<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                mainThreadPoster<span style=color:#f92672>.</span><span style=color:#a6e22e>enqueue</span><span style=color:#f92672>(</span>subscription<span style=color:#f92672>,</span> event<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> MAIN_ORDERED<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mainThreadPoster <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                mainThreadPoster<span style=color:#f92672>.</span><span style=color:#a6e22e>enqueue</span><span style=color:#f92672>(</span>subscription<span style=color:#f92672>,</span> event<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// temporary: technically not correct as poster not decoupled from subscriber
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                invokeSubscriber<span style=color:#f92672>(</span>subscription<span style=color:#f92672>,</span> event<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> BACKGROUND<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isMainThread<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                backgroundPoster<span style=color:#f92672>.</span><span style=color:#a6e22e>enqueue</span><span style=color:#f92672>(</span>subscription<span style=color:#f92672>,</span> event<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                invokeSubscriber<span style=color:#f92672>(</span>subscription<span style=color:#f92672>,</span> event<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> ASYNC<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            asyncPoster<span style=color:#f92672>.</span><span style=color:#a6e22e>enqueue</span><span style=color:#f92672>(</span>subscription<span style=color:#f92672>,</span> event<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Unknown thread mode: &#34;</span> <span style=color:#f92672>+</span> subscription<span style=color:#f92672>.</span><span style=color:#a6e22e>subscriberMethod</span><span style=color:#f92672>.</span><span style=color:#a6e22e>threadMode</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这里面 5 种 ThreadMode，采取的手段也不一样。从该枚举值的定义可以看出，分为 5 种情况，下表就是每种情况的含义：</p><p>无论在哪个线程中执行，最后都会调用 <code>invokeSubscriber</code> 方法来触发回调任务：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>invokeSubscriber</span>(<span style=color:#a6e22e>Subscription</span> <span style=color:#a6e22e>subscription</span>, Object <span style=color:#a6e22e>event</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>subscription</span>.<span style=color:#a6e22e>subscriberMethod</span>.<span style=color:#a6e22e>method</span>.<span style=color:#a6e22e>invoke</span>(<span style=color:#a6e22e>subscription</span>.<span style=color:#a6e22e>subscriber</span>, <span style=color:#a6e22e>event</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>InvocationTargetException</span> <span style=color:#a6e22e>e</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>handleSubscriberException</span>(<span style=color:#a6e22e>subscription</span>, <span style=color:#a6e22e>event</span>, <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>getCause</span>());
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>IllegalAccessException</span> <span style=color:#a6e22e>e</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>IllegalStateException</span>(<span style=color:#e6db74>&#34;Unexpected exception&#34;</span>, <span style=color:#a6e22e>e</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这里通过反射调用了订阅者的回调方法。至此，事件的发送已经分析完毕。</p><h2 id=unregister-流程>unregister 流程
<a class=anchor href=#unregister-%e6%b5%81%e7%a8%8b>#</a></h2><p>注销过程原理比较简单，就是将注册时保存到 <code>subscriptionsByEventType</code>、<code>typesBySubscriber</code> 两个集合中的元素删除。</p><p>这两个集合在注册过程中分析过：</p><ul><li><code>subscriptionsByEventType</code> 以订阅事件参数为 key，对应 Subscription 对象数组</li><li><code>typesBySubscriber</code> 以订阅者对象为 key，对应订阅事件参数数组</li></ul><p><code>EventBus.unregister()</code> 代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** Unregisters the given subscriber from all event classes. */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>unregister</span><span style=color:#f92672>(</span>Object subscriber<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 先通过 subscriber 订阅者对象从`typesBySubscriber`中获取订阅事件参数数组
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    List<span style=color:#f92672>&lt;</span>Class<span style=color:#f92672>&lt;?&gt;&gt;</span> subscribedTypes <span style=color:#f92672>=</span> typesBySubscriber<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>subscriber<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>subscribedTypes <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 以订阅事件参数为 key，从`subscriptionsByEventType`中获取到对应的`Subscrition`对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;?&gt;</span> eventType <span style=color:#f92672>:</span> subscribedTypes<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            unsubscribeByEventType<span style=color:#f92672>(</span>subscriber<span style=color:#f92672>,</span> eventType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        typesBySubscriber<span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>(</span>subscriber<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span><span style=color:#a6e22e>log</span><span style=color:#f92672>(</span>Level<span style=color:#f92672>.</span><span style=color:#a6e22e>WARNING</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Subscriber to unregister was not registered before: &#34;</span> <span style=color:#f92672>+</span> subscriber<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** Only updates subscriptionsByEventType, not typesBySubscriber! Caller must update typesBySubscriber. */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>unsubscribeByEventType</span><span style=color:#f92672>(</span>Object subscriber<span style=color:#f92672>,</span> Class<span style=color:#f92672>&lt;?&gt;</span> eventType<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>Subscription<span style=color:#f92672>&gt;</span> subscriptions <span style=color:#f92672>=</span> subscriptionsByEventType<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>eventType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>subscriptions <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> size <span style=color:#f92672>=</span> subscriptions<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> size<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Subscription subscription <span style=color:#f92672>=</span> subscriptions<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>i<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>subscription<span style=color:#f92672>.</span><span style=color:#a6e22e>subscriber</span> <span style=color:#f92672>==</span> subscriber<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                subscription<span style=color:#f92672>.</span><span style=color:#a6e22e>active</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                subscriptions<span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>(</span>i<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                i<span style=color:#f92672>--;</span>
</span></span><span style=display:flex><span>                size<span style=color:#f92672>--;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>先通过 subscriber 订阅者对象从 <code>typesBySubscriber</code> 中获取订阅事件参数数组；然后以订阅事件参数为 key，从 <code>subscriptionsByEventType</code> 中获取到对应的 <code>Subscrition</code> 对象。</p><p>以上就是 EventBus 的注销过程了。</p><h2 id=跨进程-eventbus>跨进程 EventBus
<a class=anchor href=#%e8%b7%a8%e8%bf%9b%e7%a8%8b-eventbus>#</a></h2><p>跨进程 EventBus 的难点在于如何将一个进程中的事件传递到另一个进程中，技术点还是离不来 IPC 的几种常用方式，这里比较实用的是 AIDL 方式。</p><p>下面先简单的说一下原理： 1. 弄一个主进程的 Service 作为消息中心，用来向各个进程转发事件 2. 主进程和子进程在初始化的时候都绑定到该 Service 上面，这样就得到了各进程向消息中心 Service 发送消息的通道 3. 在绑定到 Service 后，各个进程向 Service 注册本进程的消息转发器，这样消息中心 Service 就可以对各进程发送消息了，至此 C/S 之间双向的联系通道已经打通</p><p>下面分别考虑一下消息的传递，可以分为三种情况讨论。 1. 主进程向子进程的通信：获取主进程 Service 中各个进程（包括主进程自己）的消息转发器，依次转发消息 2. 子进程和主进程的通信：通过初始化绑定到 Service 时获取到的 Service 代理对象，向 Service 发送消息。Service 收到消息后，会向各个进程的消息转发器依次转发消息，这样主进程以及所有子进程都会收到消息 3. 子进程和子进程的通信：先发送到主进程，主进程会进行转发。</p><p>注意这里，主进程 Service 持有主进程以及所有子进程的消息转发器，这里不对主进程进行特别处理。此外，所有的事件都会由 Service 进行分发，Service 分发时会对主进程和所有子进程进行分发。</p><p>也就是说，如果子进程内部调用了跨进程 EventBus 进行事件分发的话，会在两次 IPC 之后再由改子进程内部的 EventBus 进行触发。这两次 IPC 是：子进程向主进程 Service 发出消息，主进程 Service 接收到消息后向所有进程进行分发。</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/EventBus/clipboard_20230323_031638.png width=auto alt></p><h3 id=简单实现>简单实现
<a class=anchor href=#%e7%ae%80%e5%8d%95%e5%ae%9e%e7%8e%b0>#</a></h3><p>文件清单如下：</p><ol><li>服务端：IEventBusManager.aidl</li><li>客户端：IEventDispatcher.aidl</li><li>传输的事件：IPCEvent.java、IPCEvent.aidl</li><li>核心类：IPCEventBus.kt</li></ol><p><strong>src/main/aidl/xyz/yorek/eventbus/IEventBusManager.aidl</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// IEventBusManager.aidl
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>package</span> xyz.yorek.eventbus<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> xyz.yorek.eventbus.IEventDispatcher<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> xyz.yorek.eventbus.IPCEvent<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>IEventBusManager</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>register</span><span style=color:#f92672>(</span>IEventDispatcher dispatcher<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>unregister</span><span style=color:#f92672>(</span>IEventDispatcher dispatcher<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 向主进程发送Event */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>postToService</span><span style=color:#f92672>(</span>in IPCEvent event<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><strong>src/main/aidl/xyz/yorek/eventbus/IEventDispatcher.aidl</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// IEventDispatcher.aidl
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>package</span> xyz.yorek.eventbus<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> xyz.yorek.eventbus.IPCEvent<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>IEventDispatcher</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 接收其他进程发送过来的Event */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>dispatch</span><span style=color:#f92672>(</span>in IPCEvent event<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><strong>src/main/aidl/xyz/yorek/eventbus/IPCEvent.aidl</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-css data-lang=css><span style=display:flex><span><span style=color:#f92672>//</span> <span style=color:#f92672>IPCEvent</span>.<span style=color:#a6e22e>aidl</span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#f92672>xyz</span>.<span style=color:#a6e22e>yorek</span>.<span style=color:#a6e22e>eventbus</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>parcelable</span> <span style=color:#f92672>IPCEvent</span><span style=color:#f92672>;</span>
</span></span></code></pre></div><p><strong>src/main/java/xyz/yorek/eventbus/IPCEvent.java</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>IPCEvent</span> <span style=color:#66d9ef>implements</span> <span style=color:#a6e22e>Parcelable</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>int</span> <span style=color:#a6e22e>code</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>msg</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>IPCEvent() {</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>IPCEvent</span>(<span style=color:#a6e22e>int</span> <span style=color:#a6e22e>code</span>, String <span style=color:#a6e22e>msg</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>code</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>code</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>msg</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#a6e22e>IPCEvent</span>(<span style=color:#a6e22e>Parcel</span> <span style=color:#66d9ef>in</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>code</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>in</span>.<span style=color:#a6e22e>readInt</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>msg</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>in</span>.<span style=color:#a6e22e>readString</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>toString() {</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;IPCEvent{&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;code=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>code</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;, msg=&#39;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>msg</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;\&#39;&#39;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;}&#39;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>int</span> <span style=color:#a6e22e>describeContents() {</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>writeToParcel</span>(<span style=color:#a6e22e>Parcel</span> <span style=color:#a6e22e>dest</span>, <span style=color:#a6e22e>int</span> <span style=color:#a6e22e>flags</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>dest</span>.<span style=color:#a6e22e>writeInt</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>code</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>dest</span>.<span style=color:#a6e22e>writeString</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>msg</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#a6e22e>final</span> <span style=color:#a6e22e>Creator</span>&lt;<span style=color:#f92672>IPCEvent</span>&gt; <span style=color:#a6e22e>CREATOR</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Creator</span>&lt;<span style=color:#f92672>IPCEvent</span>&gt;() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>IPCEvent</span> <span style=color:#a6e22e>createFromParcel</span>(<span style=color:#a6e22e>Parcel</span> <span style=color:#a6e22e>source</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>IPCEvent</span>(<span style=color:#a6e22e>source</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>IPCEvent</span>[] <span style=color:#a6e22e>newArray</span>(<span style=color:#a6e22e>int</span> <span style=color:#a6e22e>size</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>IPCEvent</span>[<span style=color:#a6e22e>size</span>];
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>src/main/java/xyz/yorek/eventbus/IPCEventBus.kt</strong></p><p>内含一个内部类 <code>EventBusManagerService</code>，管理所有进程的事件转发器。</p><p>需要注意一下这里面的 <code>RemoteCallbackList</code> 的独特用法</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>object</span> <span style=color:#a6e22e>IPCEventBus</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 本进程的事件分发器，服务端向本进程客户端发送数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>val</span> mEventDispatcher = <span style=color:#66d9ef>object</span> <span style=color:#960050;background-color:#1e0010>: </span><span style=color:#a6e22e>IEventDispatcher</span>.Stub() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>dispatch</span>(event: IPCEvent?) {
</span></span><span style=display:flex><span>            EventBus.getDefault().post(event)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 本进程获取的服务端代理，可以向服务端注册事件分发器，还可以发送数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>var</span> mEventBusManagerService: IEventBusManager? = <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>val</span> mServiceConnection = <span style=color:#66d9ef>object</span> <span style=color:#960050;background-color:#1e0010>: </span><span style=color:#a6e22e>ServiceConnection</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onServiceDisconnected</span>(name: ComponentName?) {
</span></span><span style=display:flex><span>            mEventBusManagerService = <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onServiceConnected</span>(name: ComponentName?, service: IBinder?) {
</span></span><span style=display:flex><span>            service <span style=color:#f92672>?:</span> <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>            mEventBusManagerService = IEventBusManager.Stub.asInterface(service)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            mEventBusManagerService<span style=color:#f92672>?.</span>register(mEventDispatcher)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 初始化方法
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>init</span>(context: Application) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.app = context
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>val</span> intent = Intent(app, EventBusManagerService<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java)
</span></span><span style=display:flex><span>        app.bindService(intent, mServiceConnection, Context.BIND_AUTO_CREATE)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 销毁方法，进程不需要时调用
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>destory</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (mEventBusManagerService<span style=color:#f92672>?.</span>asBinder()<span style=color:#f92672>?.</span>isBinderAlive <span style=color:#f92672>==</span> <span style=color:#66d9ef>true</span>) {
</span></span><span style=display:flex><span>            mEventBusManagerService<span style=color:#f92672>?.</span>unregister(mEventDispatcher)
</span></span><span style=display:flex><span>            app.unbindService(mServiceConnection)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>register</span>(any: Any) {
</span></span><span style=display:flex><span>        EventBus.getDefault().register(any)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>unregister</span>(any: Any) {
</span></span><span style=display:flex><span>        EventBus.getDefault().unregister(any)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 向服务端发送数据，经过服务端转发到各个进程（包括主进程）
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>post</span>(event: IPCEvent?) {
</span></span><span style=display:flex><span>        mEventBusManagerService<span style=color:#f92672>?.</span>postToService(event)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>lateinit</span> <span style=color:#66d9ef>var</span> app: Application
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 服务端
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EventBusManagerService</span> : Service() {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 各个进程的事件分发器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>val</span> mDispatchers = RemoteCallbackList&lt;IEventDispatcher&gt;()
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 服务端实现
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>val</span> mEventBusManagerService = <span style=color:#66d9ef>object</span> <span style=color:#960050;background-color:#1e0010>: </span><span style=color:#a6e22e>IEventBusManager</span>.Stub() {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>register</span>(dispatcher: IEventDispatcher?) {
</span></span><span style=display:flex><span>                dispatcher <span style=color:#f92672>?:</span> <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>                mDispatchers.register(dispatcher)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>unregister</span>(dispatcher: IEventDispatcher?) {
</span></span><span style=display:flex><span>                dispatcher <span style=color:#f92672>?:</span> <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>                mDispatchers.unregister(dispatcher)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>postToService</span>(event: IPCEvent?) {
</span></span><span style=display:flex><span>                dispatchEvent(event)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onBind</span>(intent: Intent?) = mEventBusManagerService
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * 分发事件到各个进程
</span></span></span><span style=display:flex><span><span style=color:#75715e>         */</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>dispatchEvent</span>(event: IPCEvent?) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>val</span> n = mDispatchers.beginBroadcast()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> (i <span style=color:#66d9ef>in</span> <span style=color:#ae81ff>0</span> until n) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>val</span> dispatcher = mDispatchers.getBroadcastItem(i)
</span></span><span style=display:flex><span>                dispatcher.dispatch(event)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            mDispatchers.finishBroadcast()
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=使用示例>使用示例
<a class=anchor href=#%e4%bd%bf%e7%94%a8%e7%a4%ba%e4%be%8b>#</a></h3><p>我们首先在 AndroidMenifest 中注册一下 <code>IPCEventBus$EventBusManagerService</code>；顺便注册一下三个在不同进程的 Activity，方便我们测试：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#75715e>&lt;!-- 主进程的Activity --&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>activity</span> <span style=color:#a6e22e>android:name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;.MainActivity&#34;</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>intent-filter</span>&gt;
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>action</span> <span style=color:#a6e22e>android:name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;android.intent.action.VIEW&#34;</span> /&gt;
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>action</span> <span style=color:#a6e22e>android:name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;android.intent.action.MAIN&#34;</span> /&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>category</span> <span style=color:#a6e22e>android:name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;android.intent.category.LAUNCHER&#34;</span> /&gt;
</span></span><span style=display:flex><span>    &lt;/<span style=color:#f92672>intent-filter</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>activity</span>&gt;
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!-- 子进程1的Activity --&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>activity</span> <span style=color:#a6e22e>android:name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;.SecondActivity&#34;</span> <span style=color:#a6e22e>android:process</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;:second&#34;</span> /&gt;
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!-- 子进程2的Activity --&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>activity</span> <span style=color:#a6e22e>android:name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;.ThirdActivity&#34;</span> <span style=color:#a6e22e>android:process</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;:third&#34;</span> /&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>service</span> <span style=color:#a6e22e>android:name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;xyz.yorek.eventbus.IPCEventBus$EventBusManagerService&#34;</span> /&gt;
</span></span></code></pre></div><p>上面三个 Activity 引用了同样的布局文件，拥有同样的代码。唯一的区别就是三者的 TAG 不一样，用来区分发出的消息。</p><p>下面是 MainActivity 的布局以及代码：</p><p><strong>src/main/res/layout/activity_main.xml</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;androidx.constraintlayout.widget.ConstraintLayout</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>xmlns:android=</span><span style=color:#e6db74>&#34;http://schemas.android.com/apk/res/android&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>xmlns:app=</span><span style=color:#e6db74>&#34;http://schemas.android.com/apk/res-auto&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>xmlns:tools=</span><span style=color:#e6db74>&#34;http://schemas.android.com/tools&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>android:layout_width=</span><span style=color:#e6db74>&#34;match_parent&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>android:layout_height=</span><span style=color:#e6db74>&#34;match_parent&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>tools:context=</span><span style=color:#e6db74>&#34;.MainActivity&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;Button</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:id=</span><span style=color:#e6db74>&#34;@+id/btnPost&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:layout_width=</span><span style=color:#e6db74>&#34;wrap_content&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:layout_height=</span><span style=color:#e6db74>&#34;wrap_content&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:text=</span><span style=color:#e6db74>&#34;post&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:onClick=</span><span style=color:#e6db74>&#34;post&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:layout_constraintBottom_toBottomOf=</span><span style=color:#e6db74>&#34;parent&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:layout_constraintLeft_toLeftOf=</span><span style=color:#e6db74>&#34;parent&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:layout_constraintRight_toRightOf=</span><span style=color:#e6db74>&#34;parent&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:layout_constraintTop_toTopOf=</span><span style=color:#e6db74>&#34;parent&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;Button</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:id=</span><span style=color:#e6db74>&#34;@+id/btnFirst&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:layout_width=</span><span style=color:#e6db74>&#34;wrap_content&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:layout_height=</span><span style=color:#e6db74>&#34;wrap_content&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:text=</span><span style=color:#e6db74>&#34;first&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:onClick=</span><span style=color:#e6db74>&#34;first&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:layout_constraintTop_toBottomOf=</span><span style=color:#e6db74>&#34;@id/btnPost&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:layout_constraintStart_toStartOf=</span><span style=color:#e6db74>&#34;parent&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:layout_constraintEnd_toStartOf=</span><span style=color:#e6db74>&#34;@+id/btnSecond&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;Button</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:id=</span><span style=color:#e6db74>&#34;@+id/btnSecond&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:layout_width=</span><span style=color:#e6db74>&#34;wrap_content&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:layout_height=</span><span style=color:#e6db74>&#34;wrap_content&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:text=</span><span style=color:#e6db74>&#34;second&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:onClick=</span><span style=color:#e6db74>&#34;second&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:layout_constraintTop_toBottomOf=</span><span style=color:#e6db74>&#34;@id/btnPost&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:layout_constraintStart_toEndOf=</span><span style=color:#e6db74>&#34;@id/btnFirst&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:layout_constraintEnd_toStartOf=</span><span style=color:#e6db74>&#34;@+id/btnThird&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;Button</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:id=</span><span style=color:#e6db74>&#34;@+id/btnThird&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:layout_width=</span><span style=color:#e6db74>&#34;wrap_content&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:layout_height=</span><span style=color:#e6db74>&#34;wrap_content&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:text=</span><span style=color:#e6db74>&#34;third&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:onClick=</span><span style=color:#e6db74>&#34;third&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:layout_constraintTop_toBottomOf=</span><span style=color:#e6db74>&#34;@id/btnPost&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:layout_constraintStart_toEndOf=</span><span style=color:#e6db74>&#34;@id/btnSecond&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:layout_constraintEnd_toEndOf=</span><span style=color:#e6db74>&#34;parent&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</span>
</span></span></code></pre></div><p><strong>app/src/main/java/xyz/yorek/eventbus/MainActivity.kt</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>val</span> TAG = <span style=color:#e6db74>&#34;MainActivity&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MainActivity</span> : AppCompatActivity() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onCreate</span>(savedInstanceState: Bundle?) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span>.onCreate(savedInstanceState)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        IPCEventBus.<span style=color:#66d9ef>init</span>(application)
</span></span><span style=display:flex><span>        IPCEventBus.register(<span style=color:#66d9ef>this</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        setContentView(R.layout.activity_main)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onDestroy</span>() {
</span></span><span style=display:flex><span>        IPCEventBus.unregister(<span style=color:#66d9ef>this</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span>.onDestroy()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Subscribe</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onEventReceived</span>(any: Any?) {
</span></span><span style=display:flex><span>        Log.e(TAG, <span style=color:#e6db74>&#34;receive message : </span><span style=color:#e6db74>$any</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>post</span>(view: View) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>val</span> msg = <span style=color:#e6db74>&#34;Hello World, from </span><span style=color:#e6db74>$TAG</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        IPCEventBus.post(IPCEvent(<span style=color:#ae81ff>1</span>, msg))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>first</span>(view: View) {
</span></span><span style=display:flex><span>        startActivity(Intent(<span style=color:#66d9ef>this</span>, MainActivity<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>second</span>(view: View) {
</span></span><span style=display:flex><span>        startActivity(Intent(<span style=color:#66d9ef>this</span>, SecondActivity<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>third</span>(view: View) {
</span></span><span style=display:flex><span>        startActivity(Intent(<span style=color:#66d9ef>this</span>, ThirdActivity<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在 MainActivity 中我们 post 一下消息，然后进入 SecondActivity 再次 post，进入 ThirdActivity 后最后一次 post。</p><p>各个进程日志如下（按照日志时间顺序）：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-apache data-lang=apache><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1569683305</span>.<span style=color:#960050;background-color:#1e0010>912</span> <span style=color:#960050;background-color:#1e0010>31157-31157/xyz</span>.<span style=color:#960050;background-color:#1e0010>yorek</span>.eventbus E/MainActivity: receive message : IPCEvent{code=1, msg=&#39;Hello World, from MainActivity&#39;}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1569683307</span>.<span style=color:#960050;background-color:#1e0010>622</span> <span style=color:#960050;background-color:#1e0010>31157-31169/xyz</span>.<span style=color:#960050;background-color:#1e0010>yorek</span>.eventbus E/MainActivity: receive message : IPCEvent{code=2, msg=&#39;Hello World, from SecondActivity&#39;}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1569683307</span>.<span style=color:#960050;background-color:#1e0010>625</span> <span style=color:#960050;background-color:#1e0010>31093-31093/xyz</span>.<span style=color:#960050;background-color:#1e0010>yorek</span>.<span style=color:#960050;background-color:#1e0010>eventbus:</span>second E/SecondActivity: receive message : IPCEvent{code=2, msg=&#39;Hello World, from SecondActivity&#39;}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1569683309</span>.<span style=color:#960050;background-color:#1e0010>245</span> <span style=color:#960050;background-color:#1e0010>31157-31169/xyz</span>.<span style=color:#960050;background-color:#1e0010>yorek</span>.eventbus E/MainActivity: receive message : IPCEvent{code=3, msg=&#39;Hello World, from ThirdActivity&#39;}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1569683309</span>.<span style=color:#960050;background-color:#1e0010>245</span> <span style=color:#960050;background-color:#1e0010>31210-31210/xyz</span>.<span style=color:#960050;background-color:#1e0010>yorek</span>.<span style=color:#960050;background-color:#1e0010>eventbus:</span>third E/ThirdActivity: receive message : IPCEvent{code=3, msg=&#39;Hello World, from ThirdActivity&#39;}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1569683309</span>.<span style=color:#960050;background-color:#1e0010>246</span> <span style=color:#960050;background-color:#1e0010>31093-31246/xyz</span>.<span style=color:#960050;background-color:#1e0010>yorek</span>.<span style=color:#960050;background-color:#1e0010>eventbus:</span>second E/SecondActivity: receive message : IPCEvent{code=3, msg=&#39;Hello World, from ThirdActivity&#39;}
</span></span></code></pre></div><p>从上面的日志来看，我们已经完成了跨进程 EventBus 的功能。</p><p>下面的日志是一份详细记载了各个事件的日志。从日志的中可以看出：本进程的某线程发出的事件会由同一个线程来触发；其他进程发出的事件，会由本进程 Binder 线程池里面的线程触发。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-apache data-lang=apache><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1569683981</span>.<span style=color:#960050;background-color:#1e0010>405</span> <span style=color:#960050;background-color:#1e0010>31484-31484/xyz</span>.<span style=color:#960050;background-color:#1e0010>yorek</span>.eventbus E/EventBusManagerService: dispatch begin : main
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1569683981</span>.<span style=color:#960050;background-color:#1e0010>405</span> <span style=color:#960050;background-color:#1e0010>31484-31484/xyz</span>.<span style=color:#960050;background-color:#1e0010>yorek</span>.eventbus E/MainActivity: receive message : main IPCEvent{code=1, msg=&#39;Hello World, from MainActivity&#39;}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1569683981</span>.<span style=color:#960050;background-color:#1e0010>406</span> <span style=color:#960050;background-color:#1e0010>31484-31484/xyz</span>.<span style=color:#960050;background-color:#1e0010>yorek</span>.eventbus E/EventBusManagerService: dispatch end : main
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1569683981</span>.<span style=color:#960050;background-color:#1e0010>406</span> <span style=color:#960050;background-color:#1e0010>31484-31484/xyz</span>.<span style=color:#960050;background-color:#1e0010>yorek</span>.eventbus E/MainActivity: post message done : main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1569684013</span>.<span style=color:#960050;background-color:#1e0010>794</span> <span style=color:#960050;background-color:#1e0010>31484-31526/xyz</span>.<span style=color:#960050;background-color:#1e0010>yorek</span>.eventbus E/EventBusManagerService: dispatch begin : Binder:31484_1
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1569684013</span>.<span style=color:#960050;background-color:#1e0010>794</span> <span style=color:#960050;background-color:#1e0010>31484-31526/xyz</span>.<span style=color:#960050;background-color:#1e0010>yorek</span>.eventbus E/MainActivity: receive message : Binder:31484_1 IPCEvent{code=2, msg=&#39;Hello World, from SecondActivity&#39;}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1569684013</span>.<span style=color:#960050;background-color:#1e0010>799</span> <span style=color:#960050;background-color:#1e0010>32016-32016/xyz</span>.<span style=color:#960050;background-color:#1e0010>yorek</span>.<span style=color:#960050;background-color:#1e0010>eventbus:</span>second E/SecondActivity: receive message : main IPCEvent{code=2, msg=&#39;Hello World, from SecondActivity&#39;}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1569684013</span>.<span style=color:#960050;background-color:#1e0010>803</span> <span style=color:#960050;background-color:#1e0010>31484-31526/xyz</span>.<span style=color:#960050;background-color:#1e0010>yorek</span>.eventbus E/EventBusManagerService: dispatch end : Binder:31484_1
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1569684013</span>.<span style=color:#960050;background-color:#1e0010>804</span> <span style=color:#960050;background-color:#1e0010>32016-32016/xyz</span>.<span style=color:#960050;background-color:#1e0010>yorek</span>.<span style=color:#960050;background-color:#1e0010>eventbus:</span>second E/SecondActivity: post message done : main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1569684035</span>.<span style=color:#960050;background-color:#1e0010>762</span> <span style=color:#960050;background-color:#1e0010>31484-31526/xyz</span>.<span style=color:#960050;background-color:#1e0010>yorek</span>.eventbus E/EventBusManagerService: dispatch begin : Binder:31484_1
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1569684035</span>.<span style=color:#960050;background-color:#1e0010>762</span> <span style=color:#960050;background-color:#1e0010>31484-31526/xyz</span>.<span style=color:#960050;background-color:#1e0010>yorek</span>.eventbus E/MainActivity: receive message : Binder:31484_1 IPCEvent{code=3, msg=&#39;Hello World, from ThirdActivity&#39;}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1569684035</span>.<span style=color:#960050;background-color:#1e0010>764</span> <span style=color:#960050;background-color:#1e0010>32063-32063/xyz</span>.<span style=color:#960050;background-color:#1e0010>yorek</span>.<span style=color:#960050;background-color:#1e0010>eventbus:</span>third E/ThirdActivity: receive message : main IPCEvent{code=3, msg=&#39;Hello World, from ThirdActivity&#39;}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1569684035</span>.<span style=color:#960050;background-color:#1e0010>765</span> <span style=color:#960050;background-color:#1e0010>31484-31526/xyz</span>.<span style=color:#960050;background-color:#1e0010>yorek</span>.eventbus E/EventBusManagerService: dispatch end : Binder:31484_1
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1569684035</span>.<span style=color:#960050;background-color:#1e0010>765</span> <span style=color:#960050;background-color:#1e0010>32016-32089/xyz</span>.<span style=color:#960050;background-color:#1e0010>yorek</span>.<span style=color:#960050;background-color:#1e0010>eventbus:</span>second E/SecondActivity: receive message : Binder:32016_4 IPCEvent{code=3, msg=&#39;Hello World, from ThirdActivity&#39;}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1569684035</span>.<span style=color:#960050;background-color:#1e0010>766</span> <span style=color:#960050;background-color:#1e0010>32063-32063/xyz</span>.<span style=color:#960050;background-color:#1e0010>yorek</span>.<span style=color:#960050;background-color:#1e0010>eventbus:</span>third E/ThirdActivity: post message done : main
</span></span></code></pre></div><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://guanpj.github.io/amethyst/quartz/js/graph.cbd78cfa87df7d3e230d16fc24f06548.js></script></div></div><div id=contact_buttons><footer><p>Made with <a href=https://github.com/64bitpandas/amethyst>Amethyst</a>, © 2023 guanpj</p><ul><li><a href=https://guanpj.github.io/amethyst/>Home</a></li><li><a href=https://bencuan.me>Website</a></li><li><a href=https://blog.bencuan.me>Blog</a></li></ul></footer></div></article><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#使用>使用</a></li><li><a href=#分析>分析</a><ul><li><a href=#获取-eventbus-实例>获取 EventBus 实例</a></li><li><a href=#index-文件分析>Index 文件分析</a><ul><li><a href=#index-文件概览>Index 文件概览</a></li><li><a href=#类介绍>类介绍</a><ul><li><a href=#subscriberinfo-继承关系>SubscriberInfo 继承关系</a></li><li><a href=#subscribermethod>SubscriberMethod</a></li><li><a href=#subscribermethodinfo>SubscriberMethodInfo</a></li></ul></li><li><a href=#subscriberinfo-映射>SubscriberInfo 映射</a></li></ul></li><li><a href=#register-流程>register 流程</a><ul><li><a href=#subscribermethodfinderfindsubscribermethods>SubscriberMethodFinder.findSubscriberMethods()</a><ul><li><a href=#subscribermethodfinderfindusinginfo>SubscriberMethodFinder.findUsingInfo()</a><ul><li><a href=#subscribermethodfinderpreparefindstate>SubscriberMethodFinder.prepareFindState()</a></li><li><a href=#findstateinitforsubscriber>FindState.initForSubscriber()</a></li><li><a href=#subscribermethodfindergetsubscriberinfo>SubscriberMethodFinder.getSubscriberInfo()</a></li></ul></li><li><a href=#subscribermethodfinderfindusingreflection>SubscriberMethodFinder.findUsingReflection()</a></li></ul></li><li><a href=#eventbussubscribe>EventBus.subscribe()</a></li></ul></li><li><a href=#post-流程>post 流程</a></li><li><a href=#unregister-流程>unregister 流程</a></li><li><a href=#跨进程-eventbus>跨进程 EventBus</a><ul><li><a href=#简单实现>简单实现</a></li><li><a href=#使用示例>使用示例</a></li></ul></li></ul></li></ul></nav></div></aside></main></body></html>