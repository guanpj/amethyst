<!doctype html><html lang=en dir=ltr><head><meta property="og:title" content="Glide 加载流程和缓存原理分析"><meta property="og:description" content="加载流程 #  Glide 最普通的用法如下：
Glide.with(this).load(url).into(textView);
以首次加载 url 指向的资源到 textView 对象为例，由于代码实在太过冗长，下面用流程图的方式表示各个环节的执行顺序。
with #  with 流程的主要职责：
 创建 RequestManager 对象 初始化各式各样的配置信息（缓存、请求线程池、图片大小和格式等等）以及 Glide 单例对象。 将 Glide 请求和 application/Activity/SupportFragment/Fragment 的生命周期绑定在一起，从而实现自动执行请求，暂停操作。   public class Glide implements ComponentCallbacks2 {  ...  @NonNull  public static RequestManager with(@NonNull Context context) {  return getRetriever(context).get(context);  }   @NonNull  public static RequestManager with(@NonNull Activity activity) {  return getRetriever(activity).get(activity);  }   @NonNull  public static RequestManager with(@NonNull FragmentActivity activity) {  return getRetriever(activity)."><meta property="og:type" content="article"><meta property="og:url" content="https://guanpj.github.io/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/Glide-%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E5%92%8C%E7%BC%93%E5%AD%98%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/"><meta property="article:section" content="Knowledge"><meta property="og:site_name" content="guanpj's blog"><title>Glide 加载流程和缓存原理分析 | guanpj's blog</title><link rel=manifest href=/amethyst/manifest.json><link rel=icon href=/amethyst/favicon.png type=image/x-icon><link rel=stylesheet href=/amethyst/book.min.c27ff4755c78daab11627953d5a6dd7e2698690e086398032995aae74d6397b6.css integrity="sha256-wn/0dVx42qsRYnlT1abdfiaYaQ4IY5gDKZWq501jl7Y=" crossorigin=anonymous><meta charset=utf-8><meta name=description content="加载流程 #  Glide 最普通的用法如下：
Glide.with(this).load(url).into(textView);
以首次加载 url 指向的资源到 textView 对象为例，由于代码实在太过冗长，下面用流程图的方式表示各个环节的执行顺序。
with #  with 流程的主要职责：
 创建 RequestManager 对象 初始化各式各样的配置信息（缓存、请求线程池、图片大小和格式等等）以及 Glide 单例对象。 将 Glide 请求和 application/Activity/SupportFragment/Fragment 的生命周期绑定在一起，从而实现自动执行请求，暂停操作。   public class Glide implements ComponentCallbacks2 {  ...  @NonNull  public static RequestManager with(@NonNull Context context) {  return getRetriever(context).get(context);  }   @NonNull  public static RequestManager with(@NonNull Activity activity) {  return getRetriever(activity).get(activity);  }   @NonNull  public static RequestManager with(@NonNull FragmentActivity activity) {  return getRetriever(activity)."><title>Glide 加载流程和缓存原理分析</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://guanpj.github.io/amethyst//favicon.png><link href=https://guanpj.github.io/amethyst/styles.e08ceb33360cec132feb69cfb982e2a4.min.css rel=stylesheet><link href=https://guanpj.github.io/amethyst/quartz/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://guanpj.github.io/amethyst/quartz/js/darkmode.1bc498b60ed24d8858f74f99e480db82.min.js></script>
<script src=https://guanpj.github.io/amethyst/quartz/js/util.c69e233dc1cc331a30b0f670e657b425.min.js></script>
<script async src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script async src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://guanpj.github.io/amethyst/quartz/js/popover.f03552ccb84d99ca615d1cfb9abde59e.min.js></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://guanpj.github.io/amethyst/",fetchData=Promise.all([fetch("https://guanpj.github.io/amethyst/indices/linkIndex.f13ba8f7c67305f3500d259bdfb72f53.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://guanpj.github.io/amethyst/indices/contentIndex.1a908c783dc71dfdcce2d7bedf40efc5.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addCollapsibleCallouts(),initPopover("https://guanpj.github.io/amethyst",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!0;drawGraph("https://guanpj.github.io/amethyst",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script>window.Million={navigate:e=>window.location.href=e,prefetch:()=>{}},window.addEventListener("DOMContentLoaded",()=>{init(),render()})</script></head><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><header class=book-header><label for=menu-control><img src=/amethyst/svg/menu.svg class=book-icon alt=Menu></label><h1 id=page-title><a href=https://guanpj.github.io/amethyst/>guanpj's blog</a></h1><div class=spacer></div><div id=search-icon class=quartz-search><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control><main class=flex><aside class=book-menu><div class=book-menu-content><nav><div class=menu-search><div id=search-icon class=quartz-search><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div></div><ul><li><span class=book-menu-title>Atlas</span><ul><li><a href=/amethyst/Atlas/About-Atlas/>About Atlas</a></li><li><a href=/amethyst/Atlas/Index-for-Atlases/>Index for Atlases</a></li></ul></li><li><span class=book-menu-title>Dashborads</span><ul><li><a href=/amethyst/Dashborad/Buttons/>Buttons</a></li><li><a href=/amethyst/Dashborad/ControlPanel/>Control Panel</a></li></ul></li><li><span class=book-menu-title>Excalidraws</span><ul><li><a href=/amethyst/Excalidraw/MyDraw/>My Draw</a></li></ul></li><li><span class=book-menu-title>Extras</span><ul><li><a href=/amethyst/Extras/Linter/>Linter</a></li><li><a href=/amethyst/Extras/Index-for-Extras/>Index for Extras</a></li></ul></li><li><span class=book-menu-title>Knowledges</span><ul><li><a href=/amethyst/Knowledge/Kotlin/%E5%A7%94%E6%89%98/>委托</a></li><li><a href=/amethyst/Knowledge/Kotlin/%E6%89%A9%E5%B1%95%E5%87%BD%E6%95%B0/>扩展函数</a></li><li><a href=/amethyst/Knowledge/Python/%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%96%87%E6%9C%AC%E6%9B%BF%E6%8D%A2/>文件读取、文本替换</a></li><li><a href=/amethyst/Knowledge/Python/%E7%B1%BB%E7%9A%84%E5%AE%9A%E4%B9%89%E4%BD%BF%E7%94%A8/>类的定义、使用</a></li><li><a href=/amethyst/Knowledge/Python/%E9%81%8D%E5%8E%86%E6%96%87%E4%BB%B6%E9%87%8D%E5%91%BD%E5%90%8D/>遍历文件、重命名</a></li><li><a href=/amethyst/Knowledge/%E7%AE%97%E6%B3%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E5%BC%95%E7%94%A8/>引用</a></li><li><a href=/amethyst/Knowledge/%E7%AE%97%E6%B3%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%8C%87%E9%92%88/>指针</a></li><li><a href=/amethyst/Knowledge/Android/Android-%E5%9F%BA%E7%A1%80/ADB-%E5%91%BD%E4%BB%A4/>ADB 命令</a></li><li><a href=/amethyst/Knowledge/Android/%E7%83%AD%E4%BF%AE%E5%A4%8D%E6%8F%92%E4%BB%B6%E5%8C%96/Java-%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/>ADB 命令</a></li><li><a href=/amethyst/Knowledge/Android/Android-%E5%9F%BA%E7%A1%80/Android-%E5%AF%B9%E5%AE%B9%E5%99%A8%E7%B1%BB%E7%9A%84%E4%BC%98%E5%8C%96/>Android 对容器类的优化</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/CAS-%E5%92%8C-AQS-%E5%8E%9F%E7%90%86/>CAS 和 AQS 原理</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/EventBus-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>EventBus 使用及源码解析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/Glide-%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E5%92%8C%E7%BC%93%E5%AD%98%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/ class=active>Glide 加载流程和缓存原理分析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/Glide-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/>Glide 基本使用</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/Glide-%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95/>Glide 高级用法</a></li><li><a href=/amethyst/Knowledge/Java/%E5%9F%BA%E7%A1%80/HashMap-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>HashMap 源码解析</a></li><li><a href=/amethyst/Knowledge/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9B%B8%E5%85%B3/HTTP-%E5%9F%BA%E7%A1%80/>HTTP 基础</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/Java-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/>Java 内存模型</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E4%B8%AD%E7%9A%84%E5%AF%B9%E8%B1%A1%E5%92%8C%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/>JVM 中的对象和垃圾回收</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F/>JVM 内存区域</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E5%AD%97%E8%8A%82%E7%A0%81%E6%8C%87%E4%BB%A4%E7%AE%80%E4%BB%8B/>JVM 字节码指令简介</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E5%AD%97%E8%8A%82%E7%A0%81%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/>JVM 字节码结构分析</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/>JVM 类加载机制</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/LeakCanary-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>LeakCanary 使用及源码解析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/OkHttp-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>OkHttp 使用及源码分析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/Retrofit-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>Retrofit 使用及源码分析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/RxJava-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>RxJava 使用及源码分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%B8%80Binder-%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90%E6%A6%82%E5%BF%B5%E7%AF%87/>一、Binder 机制分析——概念篇</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%B8%83View-%E4%BA%8B%E4%BB%B6%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/>七、View 事件机制分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%B8%89Handler-%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/>三、Handler 原理分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%BA%8CBinder-%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90%E5%BA%94%E7%94%A8%E7%AF%87/>二、Binder 机制分析——应用篇</a></li><li><a href=/amethyst/Knowledge/%E7%AE%97%E6%B3%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E4%BA%8C%E5%8F%89%E6%A0%91%E9%81%8D%E5%8E%86/>二叉树遍历</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%BA%94App-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/>五、App 启动流程分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E5%85%ADView-%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/>六、View 绘制流程分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E5%9B%9B%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/>四、系统启动流程分析</a></li><li><a href=/amethyst/Knowledge/Java/%E5%9F%BA%E7%A1%80/%E5%AE%B9%E5%99%A8%E7%B1%BB/>容器类</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/>并发容器</a></li><li><a href=/amethyst/Knowledge/Java/%E5%9F%BA%E7%A1%80/%E6%B3%9B%E5%9E%8B/>泛型</a></li><li><a href=/amethyst/Knowledge/Java/%E5%9F%BA%E7%A1%80/%E6%B3%A8%E8%A7%A3%E5%92%8C%E5%8F%8D%E5%B0%84/>注解和反射</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E7%AD%89%E5%BE%85-%E9%80%9A%E7%9F%A5%E6%9C%BA%E5%88%B6/>等待-通知机制</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E7%BA%BF%E7%A8%8B%E5%8D%8F%E4%BD%9C/>线程协作</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80/>线程基础</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%92%8C-BlockingQueue/>线程池和 BlockingQueue</a></li><li><a href=/amethyst/Knowledge/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9B%B8%E5%85%B3/%E7%BC%96%E7%A0%81%E5%8A%A0%E5%AF%86Hash%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%AD%97%E7%AC%A6%E9%9B%86/>编码、加密、Hash、序列化和字符集</a></li><li><a href=/amethyst/Knowledge/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9B%B8%E5%85%B3/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84TCPIP-%E5%92%8C-HTTPS/>计算机网络体系结构、TCP&IP 和 HTTPS</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E9%94%81/>锁</a></li></ul></li><li><span class=book-menu-title>Notes</span><ul><li><a href=/amethyst/Notes/2023-03-15/>2023 03 15</a></li><li><a href=/amethyst/Notes/2023-03-18/>2023 03 18</a></li><li><a href=/amethyst/Notes/2023-03-19/>2023 03 19</a></li><li><a href=/amethyst/Notes/2023-03-20/>2023 03 20</a></li><li><a href=/amethyst/Notes/2023-03-22/>Troubleshooting and FAQ</a></li></ul></li><li><span class=book-menu-title>Templates</span><ul><li><a href=/amethyst/Templates/%E5%85%B6%E4%BB%96%E6%A8%A1%E7%89%88/>其他模版</a></li></ul></li><li><span class=book-menu-title>Temps</span><ul><li><a href=/amethyst/Temp/MyIdeas/>MyIdeas</a></li></ul></li></ul><ul><li><a href=https://github.com/64bitpandas/amethyst target=_blank rel=noopener>Github</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class="book-page container"><article class=markdown><h1 class=title>Glide 加载流程和缓存原理分析</h1><h1 id=strong加载流程strong><strong>加载流程</strong>
<a class=anchor href=#strong%e5%8a%a0%e8%bd%bd%e6%b5%81%e7%a8%8bstrong>#</a></h1><p>Glide 最普通的用法如下：</p><p>Glide.with(this).load(url).into(textView);</p><p>以首次加载 url 指向的资源到 textView 对象为例，由于代码实在太过冗长，下面用流程图的方式表示各个环节的执行顺序。</p><h2 id=with>with
<a class=anchor href=#with>#</a></h2><p>with 流程的主要职责：</p><ul><li>创建 RequestManager 对象</li><li>初始化各式各样的配置信息（缓存、请求线程池、图片大小和格式等等）以及 Glide 单例对象。</li><li>将 Glide 请求和 application/Activity/SupportFragment/Fragment 的生命周期绑定在一起<strong>，从而实现自动执行请求，暂停操作</strong>。</li></ul><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-2/clipboard_20230323_034132.png width=auto alt></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Glide</span> <span style=color:#66d9ef>implements</span> ComponentCallbacks2 <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> RequestManager <span style=color:#a6e22e>with</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Context context<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> getRetriever<span style=color:#f92672>(</span>context<span style=color:#f92672>).</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> RequestManager <span style=color:#a6e22e>with</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Activity activity<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> getRetriever<span style=color:#f92672>(</span>activity<span style=color:#f92672>).</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>activity<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> RequestManager <span style=color:#a6e22e>with</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> FragmentActivity activity<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> getRetriever<span style=color:#f92672>(</span>activity<span style=color:#f92672>).</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>activity<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> RequestManager <span style=color:#a6e22e>with</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Fragment fragment<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> getRetriever<span style=color:#f92672>(</span>fragment<span style=color:#f92672>.</span><span style=color:#a6e22e>getActivity</span><span style=color:#f92672>()).</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>fragment<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;deprecation&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Deprecated</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> RequestManager <span style=color:#a6e22e>with</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> android<span style=color:#f92672>.</span><span style=color:#a6e22e>app</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Fragment</span> fragment<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> getRetriever<span style=color:#f92672>(</span>fragment<span style=color:#f92672>.</span><span style=color:#a6e22e>getActivity</span><span style=color:#f92672>()).</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>fragment<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> RequestManager <span style=color:#a6e22e>with</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> View view<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> getRetriever<span style=color:#f92672>(</span>view<span style=color:#f92672>.</span><span style=color:#a6e22e>getContext</span><span style=color:#f92672>()).</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>view<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>每个重载方法内部都首先调用 getRetriever(@Nullable Context context) 方法获取一个 RequestManagerRetriever 对象，然后调用其 get 方法来返回 RequestManager。</p><p>传入 getRetriever 的参数都是 Context，而 RequestManagerRetriever.get 方法传入的参数各不相同，所以生命周期的绑定肯定发生在 get 方法中。把 Glide.with 方法里面的代码分成两部分来分析。</p><h3 id=getretrievercontext>getRetriever(Context)
<a class=anchor href=#getretrievercontext>#</a></h3><p>getRetriever(Context) 方法会根据 @GlideModule 注解的类以及 AndroidManifest.xml 文件中 meta-data 配置的 GlideModule 来创建一个 Glide 实例，然后返回该实例的 RequestManagerRetriever。</p><p>首先从 getRetriever(Context) 开始：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> RequestManagerRetriever <span style=color:#a6e22e>getRetriever</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@Nullable</span> Context context<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Context could be null for other reasons (ie the user passes in null), but in practice it will
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// only occur due to errors with the Fragment lifecycle.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Preconditions<span style=color:#f92672>.</span><span style=color:#a6e22e>checkNotNull</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>      context<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;You cannot start a load on a not yet attached View or a Fragment where getActivity() &#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;returns null (which usually occurs when getActivity() is called before the Fragment &#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;is attached or after the Fragment is destroyed).&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> Glide<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>context<span style=color:#f92672>).</span><span style=color:#a6e22e>getRequestManagerRetriever</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> Glide <span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Context context<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>glide <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果有配置 @GlideModule 注解的 Module
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 之类会反射构造 kapt 生成的 GeneratedAppGlideModuleImpl 类
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    GeneratedAppGlideModule annotationGeneratedModule <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        getAnnotationGeneratedGlideModules<span style=color:#f92672>(</span>context<span style=color:#f92672>.</span><span style=color:#a6e22e>getApplicationContext</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span>Glide<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>glide <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        checkAndInitializeGlide<span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> annotationGeneratedModule<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> glide<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>checkAndInitializeGlide</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Context context<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// In the thread running initGlide(), one or more classes may call Glide.get(context).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// Without this check, those calls could trigger infinite recursion.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isInitializing<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;You cannot call Glide.get() in registerComponents(),&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; use the provided Glide instance instead&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  isInitializing <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  initializeGlide<span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  isInitializing <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>initializeGlide</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Context context<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  initializeGlide<span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> GlideBuilder<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>initializeGlide</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NonNull</span> Context context<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NonNull</span> GlideBuilder builder<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Nullable</span> GeneratedAppGlideModule annotationGeneratedModule<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  Context applicationContext <span style=color:#f92672>=</span> context<span style=color:#f92672>.</span><span style=color:#a6e22e>getApplicationContext</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 如果 GeneratedAppGlideModuleImpl 存在，且允许解析 manifest 文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// 则遍历 manifest 中的 meta-data，解析出所有的 GlideModule 类
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  List<span style=color:#f92672>&lt;</span>com<span style=color:#f92672>.</span><span style=color:#a6e22e>bumptech</span><span style=color:#f92672>.</span><span style=color:#a6e22e>glide</span><span style=color:#f92672>.</span><span style=color:#a6e22e>module</span><span style=color:#f92672>.</span><span style=color:#a6e22e>GlideModule</span><span style=color:#f92672>&gt;</span> manifestModules <span style=color:#f92672>=</span> Collections<span style=color:#f92672>.</span><span style=color:#a6e22e>emptyList</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>annotationGeneratedModule <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> annotationGeneratedModule<span style=color:#f92672>.</span><span style=color:#a6e22e>isManifestParsingEnabled</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    manifestModules <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ManifestParser<span style=color:#f92672>(</span>applicationContext<span style=color:#f92672>).</span><span style=color:#a6e22e>parse</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 根据 Impl 的排除名单，剔除 manifest 中的 GlideModule 类
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>annotationGeneratedModule <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>annotationGeneratedModule<span style=color:#f92672>.</span><span style=color:#a6e22e>getExcludedModuleClasses</span><span style=color:#f92672>().</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Set<span style=color:#f92672>&lt;</span>Class<span style=color:#f92672>&lt;?&gt;&gt;</span> excludedModuleClasses <span style=color:#f92672>=</span> annotationGeneratedModule<span style=color:#f92672>.</span><span style=color:#a6e22e>getExcludedModuleClasses</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    Iterator<span style=color:#f92672>&lt;</span>com<span style=color:#f92672>.</span><span style=color:#a6e22e>bumptech</span><span style=color:#f92672>.</span><span style=color:#a6e22e>glide</span><span style=color:#f92672>.</span><span style=color:#a6e22e>module</span><span style=color:#f92672>.</span><span style=color:#a6e22e>GlideModule</span><span style=color:#f92672>&gt;</span> iterator <span style=color:#f92672>=</span> manifestModules<span style=color:#f92672>.</span><span style=color:#a6e22e>iterator</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>iterator<span style=color:#f92672>.</span><span style=color:#a6e22e>hasNext</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      com<span style=color:#f92672>.</span><span style=color:#a6e22e>bumptech</span><span style=color:#f92672>.</span><span style=color:#a6e22e>glide</span><span style=color:#f92672>.</span><span style=color:#a6e22e>module</span><span style=color:#f92672>.</span><span style=color:#a6e22e>GlideModule</span> current <span style=color:#f92672>=</span> iterator<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>excludedModuleClasses<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span>current<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>continue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Log<span style=color:#f92672>.</span><span style=color:#a6e22e>isLoggable</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> Log<span style=color:#f92672>.</span><span style=color:#a6e22e>DEBUG</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Log<span style=color:#f92672>.</span><span style=color:#a6e22e>d</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;AppGlideModule excludes manifest GlideModule: &#34;</span> <span style=color:#f92672>+</span> current<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      iterator<span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Log<span style=color:#f92672>.</span><span style=color:#a6e22e>isLoggable</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> Log<span style=color:#f92672>.</span><span style=color:#a6e22e>DEBUG</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>com<span style=color:#f92672>.</span><span style=color:#a6e22e>bumptech</span><span style=color:#f92672>.</span><span style=color:#a6e22e>glide</span><span style=color:#f92672>.</span><span style=color:#a6e22e>module</span><span style=color:#f92672>.</span><span style=color:#a6e22e>GlideModule</span> glideModule <span style=color:#f92672>:</span> manifestModules<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      Log<span style=color:#f92672>.</span><span style=color:#a6e22e>d</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Discovered GlideModule from manifest: &#34;</span> <span style=color:#f92672>+</span> glideModule<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 如果 Impl 存在，那么设置为该类的 RequestManagerFactory；否则设置为 null
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  RequestManagerRetriever<span style=color:#f92672>.</span><span style=color:#a6e22e>RequestManagerFactory</span> factory <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      annotationGeneratedModule <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>?</span> annotationGeneratedModule<span style=color:#f92672>.</span><span style=color:#a6e22e>getRequestManagerFactory</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  builder<span style=color:#f92672>.</span><span style=color:#a6e22e>setRequestManagerFactory</span><span style=color:#f92672>(</span>factory<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 依次调用 manifest 中 GlideModule 类的 applyOptions 方法，将配置写到 builder 里
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>com<span style=color:#f92672>.</span><span style=color:#a6e22e>bumptech</span><span style=color:#f92672>.</span><span style=color:#a6e22e>glide</span><span style=color:#f92672>.</span><span style=color:#a6e22e>module</span><span style=color:#f92672>.</span><span style=color:#a6e22e>GlideModule</span> module <span style=color:#f92672>:</span> manifestModules<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    module<span style=color:#f92672>.</span><span style=color:#a6e22e>applyOptions</span><span style=color:#f92672>(</span>applicationContext<span style=color:#f92672>,</span> builder<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 写入 Impl 的配置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// 也就是说 Impl 配置的优先级更高，如果有冲突的话
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>annotationGeneratedModule <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    annotationGeneratedModule<span style=color:#f92672>.</span><span style=color:#a6e22e>applyOptions</span><span style=color:#f92672>(</span>applicationContext<span style=color:#f92672>,</span> builder<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 调用GlideBuilder.build方法创建 Glide
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Glide glide <span style=color:#f92672>=</span> builder<span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>(</span>applicationContext<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 依次调用 manifest 中 GlideModule 类的 registerComponents 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// 来替换 Glide 的默认配置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>com<span style=color:#f92672>.</span><span style=color:#a6e22e>bumptech</span><span style=color:#f92672>.</span><span style=color:#a6e22e>glide</span><span style=color:#f92672>.</span><span style=color:#a6e22e>module</span><span style=color:#f92672>.</span><span style=color:#a6e22e>GlideModule</span> module <span style=color:#f92672>:</span> manifestModules<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      module<span style=color:#f92672>.</span><span style=color:#a6e22e>registerComponents</span><span style=color:#f92672>(</span>applicationContext<span style=color:#f92672>,</span> glide<span style=color:#f92672>,</span> glide<span style=color:#f92672>.</span><span style=color:#a6e22e>registry</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>AbstractMethodError e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;Attempting to register a Glide v3 module. If you see this, you or one of your&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; dependencies may be including Glide v3 even though you&#39;re using Glide v4.&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; You&#39;ll need to find and remove (or update) the offending dependency.&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; The v3 module name is: &#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>+</span> module<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>          e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 调用 Impl 中替换 Glide 配置的方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>annotationGeneratedModule <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    annotationGeneratedModule<span style=color:#f92672>.</span><span style=color:#a6e22e>registerComponents</span><span style=color:#f92672>(</span>applicationContext<span style=color:#f92672>,</span> glide<span style=color:#f92672>,</span> glide<span style=color:#f92672>.</span><span style=color:#a6e22e>registry</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 注册内存管理的回调，因为 Glide 实现了 ComponentCallbacks2 接口
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  applicationContext<span style=color:#f92672>.</span><span style=color:#a6e22e>registerComponentCallbacks</span><span style=color:#f92672>(</span>glide<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 保存 glide 实例到静态变量中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Glide<span style=color:#f92672>.</span><span style=color:#a6e22e>glide</span> <span style=color:#f92672>=</span> glide<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>如果没有在 AndroidManifest 和 @GlideModule 注解中进行过配置，上面的代码可以简化为：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;deprecation&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>initializeGlide</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Context context<span style=color:#f92672>,</span> <span style=color:#a6e22e>@NonNull</span> GlideBuilder builder<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  Context applicationContext <span style=color:#f92672>=</span> context<span style=color:#f92672>.</span><span style=color:#a6e22e>getApplicationContext</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 调用 GlideBuilder.build 方法创建 Glide
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Glide glide <span style=color:#f92672>=</span> builder<span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>(</span>applicationContext<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 注册内存管理的回调，因为 Glide 实现了 ComponentCallbacks2 接口
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  applicationContext<span style=color:#f92672>.</span><span style=color:#a6e22e>registerComponentCallbacks</span><span style=color:#f92672>(</span>glide<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 保存 glide 实例到静态变量中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Glide<span style=color:#f92672>.</span><span style=color:#a6e22e>glide</span> <span style=color:#f92672>=</span> glide<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>看一下 GlideBuilder.build 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>Glide <span style=color:#a6e22e>build</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Context context<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  GlideExperiments experiments <span style=color:#f92672>=</span> glideExperimentsBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  RequestManagerRetriever requestManagerRetriever <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>new</span> RequestManagerRetriever<span style=color:#f92672>(</span>requestManagerFactory<span style=color:#f92672>,</span> experiments<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Glide<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>      context<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      engine<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      memoryCache<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      bitmapPool<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      arrayPool<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      requestManagerRetriever<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      connectivityMonitorFactory<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      logLevel<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      defaultRequestOptionsFactory<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      defaultTransitionOptions<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      defaultRequestListeners<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      experiments<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这里直接调用了 RequestManagerRetriever 构造器，且传入参数实际上为 null，在 RequestManagerRetriever 的构造器方法中会为此创建一个默认的 DEFAULT_FACTORY：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RequestManagerRetriever</span> <span style=color:#66d9ef>implements</span> Handler<span style=color:#f92672>.</span><span style=color:#a6e22e>Callback</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Handler handler<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> RequestManagerFactory factory<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RequestManagerRetriever</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>@Nullable</span> RequestManagerFactory factory<span style=color:#f92672>,</span> GlideExperiments experiments<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>factory</span> <span style=color:#f92672>=</span> factory <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> factory <span style=color:#f92672>:</span> DEFAULT_FACTORY<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    handler <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Handler<span style=color:#f92672>(</span>Looper<span style=color:#f92672>.</span><span style=color:#a6e22e>getMainLooper</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>this</span> <span style=color:#75715e>/* Callback */</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    frameWaiter <span style=color:#f92672>=</span> buildFrameWaiter<span style=color:#f92672>(</span>experiments<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * Used internally to create {@link RequestManager}s.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>RequestManagerFactory</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>    RequestManager <span style=color:#a6e22e>build</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@NonNull</span> Glide glide<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@NonNull</span> Lifecycle lifecycle<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@NonNull</span> RequestManagerTreeNode requestManagerTreeNode<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@NonNull</span> Context context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> RequestManagerFactory DEFAULT_FACTORY <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RequestManagerFactory<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> RequestManager <span style=color:#a6e22e>build</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Glide glide<span style=color:#f92672>,</span> <span style=color:#a6e22e>@NonNull</span> Lifecycle lifecycle<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@NonNull</span> RequestManagerTreeNode requestManagerTreeNode<span style=color:#f92672>,</span> <span style=color:#a6e22e>@NonNull</span> Context context<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> RequestManager<span style=color:#f92672>(</span>glide<span style=color:#f92672>,</span> lifecycle<span style=color:#f92672>,</span> requestManagerTreeNode<span style=color:#f92672>,</span> context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>目前为止，Glide <strong>单例已经被创建出来了</strong>，其 RequestManagerRetriever 会作为 getRetriever(Context) 的返回值返回。</p><p>接下来回到 Glide.with 方法中，接着执行的是 RequestManagerRetriever.get 方法，该方法根据入参是对生命周期可感的。</p><h3 id=requestmanagerretrieverget>RequestManagerRetriever.get
<a class=anchor href=#requestmanagerretrieverget>#</a></h3><p>RequestManagerRetriever.get 方法与 Glide.with 一样，也有很多重载方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> RequestManager <span style=color:#a6e22e>getApplicationManager</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Context context<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Either an application context or we&#39;re on a background thread.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>applicationManager <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>applicationManager <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Normally pause/resume is taken care of by the fragment we add to the fragment or
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// activity. However, in this case since the manager attached to the application will not
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// receive lifecycle events, we must force the manager to start resumed using
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// ApplicationLifecycle.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// TODO(b/27524013): Factor out this Glide.get() call.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Glide glide <span style=color:#f92672>=</span> Glide<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>context<span style=color:#f92672>.</span><span style=color:#a6e22e>getApplicationContext</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        applicationManager <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>            factory<span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                glide<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>new</span> ApplicationLifecycle<span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>new</span> EmptyRequestManagerTreeNode<span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>                context<span style=color:#f92672>.</span><span style=color:#a6e22e>getApplicationContext</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> applicationManager<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> RequestManager <span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Context context<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>context <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;You cannot start a load on a null Context&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Util<span style=color:#f92672>.</span><span style=color:#a6e22e>isOnMainThread</span><span style=color:#f92672>()</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!(</span>context <span style=color:#66d9ef>instanceof</span> Application<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>context <span style=color:#66d9ef>instanceof</span> FragmentActivity<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> get<span style=color:#f92672>((</span>FragmentActivity<span style=color:#f92672>)</span> context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>context <span style=color:#66d9ef>instanceof</span> Activity<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> get<span style=color:#f92672>((</span>Activity<span style=color:#f92672>)</span> context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>context <span style=color:#66d9ef>instanceof</span> ContextWrapper
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Only unwrap a ContextWrapper if the baseContext has a non-null application context.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// Context#createPackageContext may return a Context without an Application instance,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// in which case a ContextWrapper may be used to attach one.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>((</span>ContextWrapper<span style=color:#f92672>)</span> context<span style=color:#f92672>).</span><span style=color:#a6e22e>getBaseContext</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getApplicationContext</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> get<span style=color:#f92672>(((</span>ContextWrapper<span style=color:#f92672>)</span> context<span style=color:#f92672>).</span><span style=color:#a6e22e>getBaseContext</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> getApplicationManager<span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> RequestManager <span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> FragmentActivity activity<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Util<span style=color:#f92672>.</span><span style=color:#a6e22e>isOnBackgroundThread</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> get<span style=color:#f92672>(</span>activity<span style=color:#f92672>.</span><span style=color:#a6e22e>getApplicationContext</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    assertNotDestroyed<span style=color:#f92672>(</span>activity<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    frameWaiter<span style=color:#f92672>.</span><span style=color:#a6e22e>registerSelf</span><span style=color:#f92672>(</span>activity<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    FragmentManager fm <span style=color:#f92672>=</span> activity<span style=color:#f92672>.</span><span style=color:#a6e22e>getSupportFragmentManager</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> supportFragmentGet<span style=color:#f92672>(</span>activity<span style=color:#f92672>,</span> fm<span style=color:#f92672>,</span> <span style=color:#75715e>/*parentHint=*/</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> isActivityVisible<span style=color:#f92672>(</span>activity<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> RequestManager <span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Fragment fragment<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  Preconditions<span style=color:#f92672>.</span><span style=color:#a6e22e>checkNotNull</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>      fragment<span style=color:#f92672>.</span><span style=color:#a6e22e>getContext</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;You cannot start a load on a fragment before it is attached or after it is destroyed&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Util<span style=color:#f92672>.</span><span style=color:#a6e22e>isOnBackgroundThread</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> get<span style=color:#f92672>(</span>fragment<span style=color:#f92672>.</span><span style=color:#a6e22e>getContext</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getApplicationContext</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// In some unusual cases, it&#39;s possible to have a Fragment not hosted by an activity. There&#39;s
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// not all that much we can do here. Most apps will be started with a standard activity. If
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// we manage not to register the first frame waiter for a while, the consequences are not
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// catastrophic, we&#39;ll just use some extra memory.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>fragment<span style=color:#f92672>.</span><span style=color:#a6e22e>getActivity</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      frameWaiter<span style=color:#f92672>.</span><span style=color:#a6e22e>registerSelf</span><span style=color:#f92672>(</span>fragment<span style=color:#f92672>.</span><span style=color:#a6e22e>getActivity</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    FragmentManager fm <span style=color:#f92672>=</span> fragment<span style=color:#f92672>.</span><span style=color:#a6e22e>getChildFragmentManager</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> supportFragmentGet<span style=color:#f92672>(</span>fragment<span style=color:#f92672>.</span><span style=color:#a6e22e>getContext</span><span style=color:#f92672>(),</span> fm<span style=color:#f92672>,</span> fragment<span style=color:#f92672>,</span> fragment<span style=color:#f92672>.</span><span style=color:#a6e22e>isVisible</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;deprecation&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> RequestManager <span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Activity activity<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Util<span style=color:#f92672>.</span><span style=color:#a6e22e>isOnBackgroundThread</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> get<span style=color:#f92672>(</span>activity<span style=color:#f92672>.</span><span style=color:#a6e22e>getApplicationContext</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>activity <span style=color:#66d9ef>instanceof</span> FragmentActivity<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> get<span style=color:#f92672>((</span>FragmentActivity<span style=color:#f92672>)</span> activity<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    assertNotDestroyed<span style=color:#f92672>(</span>activity<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    frameWaiter<span style=color:#f92672>.</span><span style=color:#a6e22e>registerSelf</span><span style=color:#f92672>(</span>activity<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    android<span style=color:#f92672>.</span><span style=color:#a6e22e>app</span><span style=color:#f92672>.</span><span style=color:#a6e22e>FragmentManager</span> fm <span style=color:#f92672>=</span> activity<span style=color:#f92672>.</span><span style=color:#a6e22e>getFragmentManager</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> fragmentGet<span style=color:#f92672>(</span>activity<span style=color:#f92672>,</span> fm<span style=color:#f92672>,</span> <span style=color:#75715e>/*parentHint=*/</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> isActivityVisible<span style=color:#f92672>(</span>activity<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;deprecation&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> RequestManager <span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> View view<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Util<span style=color:#f92672>.</span><span style=color:#a6e22e>isOnBackgroundThread</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> get<span style=color:#f92672>(</span>view<span style=color:#f92672>.</span><span style=color:#a6e22e>getContext</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getApplicationContext</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Preconditions<span style=color:#f92672>.</span><span style=color:#a6e22e>checkNotNull</span><span style=color:#f92672>(</span>view<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  Preconditions<span style=color:#f92672>.</span><span style=color:#a6e22e>checkNotNull</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>      view<span style=color:#f92672>.</span><span style=color:#a6e22e>getContext</span><span style=color:#f92672>(),</span> <span style=color:#e6db74>&#34;Unable to obtain a request manager for a view without a Context&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  Activity activity <span style=color:#f92672>=</span> findActivity<span style=color:#f92672>(</span>view<span style=color:#f92672>.</span><span style=color:#a6e22e>getContext</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// The view might be somewhere else, like a service.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>activity <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> get<span style=color:#f92672>(</span>view<span style=color:#f92672>.</span><span style=color:#a6e22e>getContext</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getApplicationContext</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Support Fragments.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// Although the user might have non-support Fragments attached to FragmentActivity, searching
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// for non-support Fragments is so expensive pre O and that should be rare enough that we
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// prefer to just fall back to the Activity directly.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>activity <span style=color:#66d9ef>instanceof</span> FragmentActivity<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Fragment fragment <span style=color:#f92672>=</span> findSupportFragment<span style=color:#f92672>(</span>view<span style=color:#f92672>,</span> <span style=color:#f92672>(</span>FragmentActivity<span style=color:#f92672>)</span> activity<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> fragment <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> get<span style=color:#f92672>(</span>fragment<span style=color:#f92672>)</span> <span style=color:#f92672>:</span> get<span style=color:#f92672>((</span>FragmentActivity<span style=color:#f92672>)</span> activity<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Standard Fragments.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  android<span style=color:#f92672>.</span><span style=color:#a6e22e>app</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Fragment</span> fragment <span style=color:#f92672>=</span> findFragment<span style=color:#f92672>(</span>view<span style=color:#f92672>,</span> activity<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>fragment <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> get<span style=color:#f92672>(</span>activity<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> get<span style=color:#f92672>(</span>fragment<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>在这些 get 方法中，<strong>首先判断当前线程是不是后台线程</strong>，如果是后台线程那么就会调用 getApplicationManager 方法返回一个 RequestManager：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Glide glide <span style=color:#f92672>=</span> Glide<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>context<span style=color:#f92672>.</span><span style=color:#a6e22e>getApplicationContext</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>applicationManager <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>    factory<span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        glide<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> ApplicationLifecycle<span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> EmptyRequestManagerTreeNode<span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>        context<span style=color:#f92672>.</span><span style=color:#a6e22e>getApplicationContext</span><span style=color:#f92672>());</span>
</span></span></code></pre></div><p>由于此处 factory 是 DEFAULT_FACTORY，所以 RequestManager 就是下面的值：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>RequestManager<span style=color:#f92672>(</span>glide<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> ApplicationLifecycle<span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> EmptyRequestManagerTreeNode<span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>        context<span style=color:#f92672>.</span><span style=color:#a6e22e>getApplicationContext</span><span style=color:#f92672>());</span>
</span></span></code></pre></div><p><strong>如果当前线程不是后台线程</strong>，get(View) 和 get(Context) 会根据情况调用 get(Fragment) 或 get(FragmentActivity)。其中 get(View) 为了找到一个合适的 Fragment 或 Fallback Activity，内部操作比较多，开销比较大，不要轻易使用。</p><p>get(Fragment) 和 get(FragmentActivity) 方法都会调用 supportFragmentGet 方法，只是传入参数不同：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// FragmentActivity activity
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>FragmentManager fm <span style=color:#f92672>=</span> activity<span style=color:#f92672>.</span><span style=color:#a6e22e>getSupportFragmentManager</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>supportFragmentGet<span style=color:#f92672>(</span>activity<span style=color:#f92672>,</span> fm<span style=color:#f92672>,</span> <span style=color:#75715e>/*parentHint=*/</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> isActivityVisible<span style=color:#f92672>(</span>activity<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Fragment fragment
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>FragmentManager fm <span style=color:#f92672>=</span> fragment<span style=color:#f92672>.</span><span style=color:#a6e22e>getChildFragmentManager</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>supportFragmentGet<span style=color:#f92672>(</span>fragment<span style=color:#f92672>.</span><span style=color:#a6e22e>getActivity</span><span style=color:#f92672>(),</span> fm<span style=color:#f92672>,</span> fragment<span style=color:#f92672>,</span> fragment<span style=color:#f92672>.</span><span style=color:#a6e22e>isVisible</span><span style=color:#f92672>());</span>
</span></span></code></pre></div><p>Glide 会使用一个加载目标所在的宿主 Activity 或 Fragment 的子 Fragment 来安全保存一个 RequestManager，而 RequestManager 被 Glide 用来开始、停止、管理 Glide 请求。</p><p>而 supportFragmentGet 就是创建 / 获取这个 SupportRequestManagerFragment，并返回其持有的 RequestManager 的方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> RequestManager <span style=color:#a6e22e>supportFragmentGet</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NonNull</span> Context context<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NonNull</span> FragmentManager fm<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Nullable</span> Fragment parentHint<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> isParentVisible<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 获取一个SupportRequestManagerFragment
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  SupportRequestManagerFragment current <span style=color:#f92672>=</span> getSupportRequestManagerFragment<span style=color:#f92672>(</span>fm<span style=color:#f92672>,</span> parentHint<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 获取里面的RequestManager对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  RequestManager requestManager <span style=color:#f92672>=</span> current<span style=color:#f92672>.</span><span style=color:#a6e22e>getRequestManager</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 若没有，则创建一个
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>requestManager <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// TODO(b/27524013): Factor out this Glide.get() call.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Glide glide <span style=color:#f92672>=</span> Glide<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    requestManager <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        factory<span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            glide<span style=color:#f92672>,</span> current<span style=color:#f92672>.</span><span style=color:#a6e22e>getGlideLifecycle</span><span style=color:#f92672>(),</span> current<span style=color:#f92672>.</span><span style=color:#a6e22e>getRequestManagerTreeNode</span><span style=color:#f92672>(),</span> context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// This is a bit of hack, we&#39;re going to start the RequestManager, but not the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// corresponding Lifecycle. It&#39;s safe to start the RequestManager, but starting the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Lifecycle might trigger memory leaks. See b/154405040
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isParentVisible<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      requestManager<span style=color:#f92672>.</span><span style=color:#a6e22e>onStart</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 设置到SupportRequestManagerFragment里面，下次就不需要创建了
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    current<span style=color:#f92672>.</span><span style=color:#a6e22e>setRequestManager</span><span style=color:#f92672>(</span>requestManager<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> requestManager<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 看看Fragment怎么才能高效
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> SupportRequestManagerFragment <span style=color:#a6e22e>getSupportRequestManagerFragment</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NonNull</span> <span style=color:#66d9ef>final</span> FragmentManager fm<span style=color:#f92672>,</span> <span style=color:#a6e22e>@Nullable</span> Fragment parentHint<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 已经添加过了，可以直接返回
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  SupportRequestManagerFragment current <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>(</span>SupportRequestManagerFragment<span style=color:#f92672>)</span> fm<span style=color:#f92672>.</span><span style=color:#a6e22e>findFragmentByTag</span><span style=color:#f92672>(</span>FRAGMENT_TAG<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>current <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 从map中获取，取到也可以返回了
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    current <span style=color:#f92672>=</span> pendingSupportRequestManagerFragments<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>fm<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>current <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 都没有，那么就创建一个，此时lifecycle默认为ActivityFragmentLifecycle
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      current <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SupportRequestManagerFragment<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 对于fragment来说，此方法会以Activity为host创建另外一个
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// SupportRequestManagerFragment作为rootRequestManagerFragment
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// 并会将current加入到rootRequestManagerFragment的
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// childRequestManagerFragments中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// 在RequestManager递归管理请求时会使用到
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      current<span style=color:#f92672>.</span><span style=color:#a6e22e>setParentFragmentHint</span><span style=color:#f92672>(</span>parentHint<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 将刚创建的fragment缓存进map起来
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      pendingSupportRequestManagerFragments<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>fm<span style=color:#f92672>,</span> current<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 将fragment添加到页面中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      fm<span style=color:#f92672>.</span><span style=color:#a6e22e>beginTransaction</span><span style=color:#f92672>().</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>current<span style=color:#f92672>,</span> FRAGMENT_TAG<span style=color:#f92672>).</span><span style=color:#a6e22e>commitAllowingStateLoss</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 以fm为key从pendingSupportRequestManagerFragments中删除
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      handler<span style=color:#f92672>.</span><span style=color:#a6e22e>obtainMessage</span><span style=color:#f92672>(</span>ID_REMOVE_SUPPORT_FRAGMENT_MANAGER<span style=color:#f92672>,</span> fm<span style=color:#f92672>).</span><span style=color:#a6e22e>sendToTarget</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> current<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>在上面的 supportFragmentGet 方法中，成功创建了一个 RequestManager 对象，由于 factory 是 DEFAULT_FACTORY，所以就是下面的值：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>RequestManager<span style=color:#f92672>(</span>glide<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  current<span style=color:#f92672>.</span><span style=color:#a6e22e>getGlideLifecycle</span><span style=color:#f92672>(),</span>          <span style=color:#75715e>// ActivityFragmentLifecycle()
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  current<span style=color:#f92672>.</span><span style=color:#a6e22e>getRequestManagerTreeNode</span><span style=color:#f92672>(),</span>  <span style=color:#75715e>// SupportFragmentRequestManagerTreeNode()
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  context<span style=color:#f92672>);</span>
</span></span></code></pre></div><p>在上一步中 Glide 单例完成了初始化，这一步中成功的创建并返回了一个 RequestManager。Glide.with 已经分析完毕。</p><h3 id=小结>小结
<a class=anchor href=#%e5%b0%8f%e7%bb%93>#</a></h3><p>with() 方法是为得到一个 RequestManager 对象，从而将 Glide 加载图片周期与 Activity 和 Fragment 进行绑定，进而管理 Glide 加载图片周期。</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-2/clipboard_20230323_034143.png width=auto alt></p><h2 id=strongloadstrong><strong>load</strong>
<a class=anchor href=#strongloadstrong>#</a></h2><p>由于 .with() 返回的是一个 RequestManager 对象，所以第 2 步中调用的是 RequestManager</p><p>类的 load() 方法。而 load() 方法返回的是 RequestBuilder 对象。RequestBuilder 和 RequestOptions 都派生自抽象类 BaseRequestOptions，它们的继承关系如下：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-2/clipboard_20230323_034149.png width=auto alt></p><p>看一下 RequestManager 的一些方法，首先看 load 的一些重载方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> RequestBuilder<span style=color:#f92672>&lt;</span>Drawable<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>load</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@Nullable</span> Bitmap bitmap<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> asDrawable<span style=color:#f92672>().</span><span style=color:#a6e22e>load</span><span style=color:#f92672>(</span>bitmap<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> RequestBuilder<span style=color:#f92672>&lt;</span>Drawable<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>load</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@Nullable</span> Drawable drawable<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> asDrawable<span style=color:#f92672>().</span><span style=color:#a6e22e>load</span><span style=color:#f92672>(</span>drawable<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> RequestBuilder<span style=color:#f92672>&lt;</span>Drawable<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>load</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@Nullable</span> String string<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> asDrawable<span style=color:#f92672>().</span><span style=color:#a6e22e>load</span><span style=color:#f92672>(</span>string<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> RequestBuilder<span style=color:#f92672>&lt;</span>Drawable<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>load</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@Nullable</span> Uri uri<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> asDrawable<span style=color:#f92672>().</span><span style=color:#a6e22e>load</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> RequestBuilder<span style=color:#f92672>&lt;</span>Drawable<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>load</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@Nullable</span> File file<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> asDrawable<span style=color:#f92672>().</span><span style=color:#a6e22e>load</span><span style=color:#f92672>(</span>file<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;deprecation&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> RequestBuilder<span style=color:#f92672>&lt;</span>Drawable<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>load</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RawRes</span> <span style=color:#a6e22e>@DrawableRes</span> <span style=color:#a6e22e>@Nullable</span> Integer resourceId<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> asDrawable<span style=color:#f92672>().</span><span style=color:#a6e22e>load</span><span style=color:#f92672>(</span>resourceId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;deprecation&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Deprecated</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> RequestBuilder<span style=color:#f92672>&lt;</span>Drawable<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>load</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@Nullable</span> URL url<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> asDrawable<span style=color:#f92672>().</span><span style=color:#a6e22e>load</span><span style=color:#f92672>(</span>url<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> RequestBuilder<span style=color:#f92672>&lt;</span>Drawable<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>load</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@Nullable</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> model<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> asDrawable<span style=color:#f92672>().</span><span style=color:#a6e22e>load</span><span style=color:#f92672>(</span>model<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> RequestBuilder<span style=color:#f92672>&lt;</span>Drawable<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>load</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@Nullable</span> Object model<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> asDrawable<span style=color:#f92672>().</span><span style=color:#a6e22e>load</span><span style=color:#f92672>(</span>model<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>在所有的 RequestManager.load 方法中都会先调用 asDrawable() 方法得到一个 RequestBuilder 对象，然后再调用 RequestBuilder.load 方法。</p><h3 id=requestmanagerasxx>RequestManager.asXx
<a class=anchor href=#requestmanagerasxx>#</a></h3><p>asDrawable 方法同其他 as 方法（asGif、asBitmap、asFile）一样，都会先调用 RequestManager.as 方法生成一个 <code>RequestBuilder&lt;ResourceType></code> 对象，然后各个 as 方法会附加一些不同的 options：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> RequestBuilder<span style=color:#f92672>&lt;</span>Bitmap<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>asBitmap</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> as<span style=color:#f92672>(</span>Bitmap<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>).</span><span style=color:#a6e22e>apply</span><span style=color:#f92672>(</span>DECODE_TYPE_BITMAP<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> RequestBuilder<span style=color:#f92672>&lt;</span>GifDrawable<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>asGif</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> as<span style=color:#f92672>(</span>GifDrawable<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>).</span><span style=color:#a6e22e>apply</span><span style=color:#f92672>(</span>DECODE_TYPE_GIF<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> RequestBuilder<span style=color:#f92672>&lt;</span>Drawable<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>asDrawable</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> as<span style=color:#f92672>(</span>Drawable<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> RequestBuilder<span style=color:#f92672>&lt;</span>File<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>asFile</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> as<span style=color:#f92672>(</span>File<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>).</span><span style=color:#a6e22e>apply</span><span style=color:#f92672>(</span>skipMemoryCacheOf<span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>ResourceType<span style=color:#f92672>&gt;</span> RequestBuilder<span style=color:#f92672>&lt;</span>ResourceType<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>as</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NonNull</span> Class<span style=color:#f92672>&lt;</span>ResourceType<span style=color:#f92672>&gt;</span> resourceClass<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> RequestBuilder<span style=color:#f92672>&lt;&gt;(</span>glide<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> resourceClass<span style=color:#f92672>,</span> context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>在 RequestBuilder 的构造器方法方法中将 Drawable.class 这样的入参保存到了 transcodeClass 变量中：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#a6e22e>@SuppressLint</span>(<span style=color:#e6db74>&#34;CheckResult&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SuppressWarnings</span>(<span style=color:#e6db74>&#34;PMD.ConstructorCallsOverridableMethod&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>protected</span> RequestBuilder(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NonNull</span> Glide glide,
</span></span><span style=display:flex><span>    RequestManager requestManager,
</span></span><span style=display:flex><span>    Class&lt;TranscodeType&gt; transcodeClass,
</span></span><span style=display:flex><span>    Context context) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>.glide = glide;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>.requestManager = requestManager;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>.transcodeClass = transcodeClass;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>.context = context;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>.transitionOptions = requestManager.getDefaultTransitionOptions(transcodeClass);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>.glideContext = glide.getGlideContext();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  initRequestListeners(requestManager.getDefaultRequestListeners());
</span></span><span style=display:flex><span>  apply(requestManager.getDefaultRequestOptions());
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>然后回到之前的 asGif 方法中，看看 apply(DECODE_TYPE_BITMAP) 干了些什么：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// RequestManager
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> RequestOptions DECODE_TYPE_GIF 
</span></span><span style=display:flex><span>        <span style=color:#f92672>=</span> RequestOptions<span style=color:#f92672>.</span><span style=color:#a6e22e>decodeTypeOf</span><span style=color:#f92672>(</span>GifDrawable<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>).</span><span style=color:#a6e22e>lock</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> RequestBuilder<span style=color:#f92672>&lt;</span>GifDrawable<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>asGif</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> as<span style=color:#f92672>(</span>GifDrawable<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>).</span><span style=color:#a6e22e>apply</span><span style=color:#f92672>(</span>DECODE_TYPE_GIF<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// RequestOptions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> RequestOptions <span style=color:#a6e22e>decodeTypeOf</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Class<span style=color:#f92672>&lt;?&gt;</span> resourceClass<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> RequestOptions<span style=color:#f92672>().</span><span style=color:#a6e22e>decode</span><span style=color:#f92672>(</span>resourceClass<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// BaseRequestOptions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> T <span style=color:#a6e22e>decode</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Class<span style=color:#f92672>&lt;?&gt;</span> resourceClass<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isAutoCloneEnabled<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> clone<span style=color:#f92672>().</span><span style=color:#a6e22e>decode</span><span style=color:#f92672>(</span>resourceClass<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>resourceClass</span> <span style=color:#f92672>=</span> Preconditions<span style=color:#f92672>.</span><span style=color:#a6e22e>checkNotNull</span><span style=color:#f92672>(</span>resourceClass<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  fields <span style=color:#f92672>|=</span> RESOURCE_CLASS<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> selfOrThrowIfLocked<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> T <span style=color:#a6e22e>apply</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> BaseRequestOptions<span style=color:#f92672>&lt;?&gt;</span> o<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isAutoCloneEnabled<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> clone<span style=color:#f92672>().</span><span style=color:#a6e22e>apply</span><span style=color:#f92672>(</span>o<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  BaseRequestOptions<span style=color:#f92672>&lt;?&gt;</span> other <span style=color:#f92672>=</span> o<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isSet<span style=color:#f92672>(</span>other<span style=color:#f92672>.</span><span style=color:#a6e22e>fields</span><span style=color:#f92672>,</span> RESOURCE_CLASS<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    resourceClass <span style=color:#f92672>=</span> other<span style=color:#f92672>.</span><span style=color:#a6e22e>resourceClass</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> selfOrThrowIfLocked<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// RequestBuilder
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> RequestBuilder<span style=color:#f92672>&lt;</span>TranscodeType<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>apply</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> BaseRequestOptions<span style=color:#f92672>&lt;?&gt;</span> requestOptions<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  Preconditions<span style=color:#f92672>.</span><span style=color:#a6e22e>checkNotNull</span><span style=color:#f92672>(</span>requestOptions<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>apply</span><span style=color:#f92672>(</span>requestOptions<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>不难发现，apply(DECODE_TYPE_BITMAP) 就是将 BaseRequestOptions.resourceClass 设置为了 GifDrawable.class；对于 asBitmap() 来说，resourceClass 为 Bitmap.class；而对于 asDrawable() 和 asFile() 来说，resourceClass 没有进行过设置，所以为默认值 Object.class。</p><p>现在 RequestBuilder 已经由 as 系列方法生成，现在接着会调用 RequestBuilder.load 方法</p><h3 id=requestbuilderload>RequestBuilder.load
<a class=anchor href=#requestbuilderload>#</a></h3><p>RequestManager.load 方法都会调用对应的 RequestBuilder.load 重载方法；RequestBuilder.load 的各个方法基本上都会直接转发给 loadGeneric 方法，只有少数的方法才会 apply 额外的 options。</p><p>loadGeneric 方法也只是保存一下参数而已：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@SuppressWarnings</span>(<span style=color:#e6db74>&#34;unchecked&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RequestBuilder</span>&lt;<span style=color:#f92672>TranscodeType</span>&gt; <span style=color:#a6e22e>load</span>(<span style=color:#66d9ef>@Nullable</span> Object <span style=color:#a6e22e>model</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>loadGeneric</span>(<span style=color:#a6e22e>model</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RequestBuilder</span>&lt;<span style=color:#f92672>TranscodeType</span>&gt; <span style=color:#a6e22e>load</span>(<span style=color:#66d9ef>@Nullable</span> <span style=color:#a6e22e>Bitmap</span> <span style=color:#a6e22e>bitmap</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>loadGeneric</span>(<span style=color:#a6e22e>bitmap</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>apply</span>(<span style=color:#a6e22e>diskCacheStrategyOf</span>(<span style=color:#a6e22e>DiskCacheStrategy</span>.<span style=color:#a6e22e>NONE</span>));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RequestBuilder</span>&lt;<span style=color:#f92672>TranscodeType</span>&gt; <span style=color:#a6e22e>load</span>(<span style=color:#66d9ef>@Nullable</span> <span style=color:#a6e22e>Drawable</span> <span style=color:#a6e22e>drawable</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>loadGeneric</span>(<span style=color:#a6e22e>drawable</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>apply</span>(<span style=color:#a6e22e>diskCacheStrategyOf</span>(<span style=color:#a6e22e>DiskCacheStrategy</span>.<span style=color:#a6e22e>NONE</span>));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RequestBuilder</span>&lt;<span style=color:#f92672>TranscodeType</span>&gt; <span style=color:#a6e22e>load</span>(<span style=color:#66d9ef>@Nullable</span> <span style=color:#a6e22e>Uri</span> <span style=color:#a6e22e>uri</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>loadGeneric</span>(<span style=color:#a6e22e>uri</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RequestBuilder</span>&lt;<span style=color:#f92672>TranscodeType</span>&gt; <span style=color:#a6e22e>load</span>(<span style=color:#66d9ef>@Nullable</span> <span style=color:#a6e22e>File</span> <span style=color:#a6e22e>file</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>loadGeneric</span>(<span style=color:#a6e22e>file</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RequestBuilder</span>&lt;<span style=color:#f92672>TranscodeType</span>&gt; <span style=color:#a6e22e>load</span>(<span style=color:#66d9ef>@RawRes</span> <span style=color:#66d9ef>@DrawableRes</span> <span style=color:#66d9ef>@Nullable</span> <span style=color:#a6e22e>Integer</span> <span style=color:#a6e22e>resourceId</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>loadGeneric</span>(<span style=color:#a6e22e>resourceId</span>).<span style=color:#a6e22e>apply</span>(<span style=color:#a6e22e>signatureOf</span>(<span style=color:#a6e22e>ApplicationVersionSignature</span>.<span style=color:#a6e22e>obtain</span>(<span style=color:#a6e22e>context</span>)));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@Deprecated</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RequestBuilder</span>&lt;<span style=color:#f92672>TranscodeType</span>&gt; <span style=color:#a6e22e>load</span>(<span style=color:#66d9ef>@Nullable</span> <span style=color:#a6e22e>URL</span> <span style=color:#a6e22e>url</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>loadGeneric</span>(<span style=color:#a6e22e>url</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RequestBuilder</span>&lt;<span style=color:#f92672>TranscodeType</span>&gt; <span style=color:#a6e22e>load</span>(<span style=color:#66d9ef>@Nullable</span> <span style=color:#a6e22e>byte</span>[] <span style=color:#a6e22e>model</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>RequestBuilder</span>&lt;<span style=color:#f92672>TranscodeType</span>&gt; <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>loadGeneric</span>(<span style=color:#a6e22e>model</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>isDiskCacheStrategySet</span>()) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>apply</span>(<span style=color:#a6e22e>diskCacheStrategyOf</span>(<span style=color:#a6e22e>DiskCacheStrategy</span>.<span style=color:#a6e22e>NONE</span>));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>isSkipMemoryCacheSet</span>()) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>apply</span>(<span style=color:#a6e22e>skipMemoryCacheOf</span>(<span style=color:#66d9ef>true</span> <span style=color:#75715e>/*skipMemoryCache*/</span>));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>result</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#a6e22e>RequestBuilder</span>&lt;<span style=color:#f92672>TranscodeType</span>&gt; <span style=color:#a6e22e>loadGeneric</span>(<span style=color:#66d9ef>@Nullable</span> Object <span style=color:#a6e22e>model</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>model</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>model</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>isModelSet</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>如上面最后的方法 loadGeneric，这里只是将参数保存在 model 中并设置 isModelSet=true 就完了，</p><h3 id=小结-1>小结
<a class=anchor href=#%e5%b0%8f%e7%bb%93-1>#</a></h3><p>load 流程主要给 GlideRequest（RequestManager）设置了要请求的 mode（url），并将 isModelSet 变量设置为 true，表示已设置的状态，最后返回 RequestBuilder。</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-2/clipboard_20230323_034156.png width=auto alt></p><h2 id=into>into
<a class=anchor href=#into>#</a></h2><p>RequestBuilder.into 有四个重载方法，最终都调用了参数最多的一个：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> &lt;<span style=color:#f92672>Y</span> <span style=color:#a6e22e>extends</span> <span style=color:#a6e22e>Target</span><span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#a6e22e>TranscodeType</span>&gt;<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>Y</span> <span style=color:#a6e22e>into</span>(<span style=color:#66d9ef>@NonNull</span> <span style=color:#a6e22e>Y</span> <span style=color:#a6e22e>target</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>into</span>(<span style=color:#a6e22e>target</span>, <span style=color:#75715e>/*targetListener=*/</span> <span style=color:#66d9ef>null</span>, <span style=color:#a6e22e>Executors</span>.<span style=color:#a6e22e>mainThreadExecutor</span>());
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@Synthetic</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>Y</span> <span style=color:#a6e22e>extends</span> <span style=color:#a6e22e>Target</span><span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#a6e22e>TranscodeType</span>&gt;<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>Y</span> <span style=color:#a6e22e>into</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>@NonNull</span> <span style=color:#a6e22e>Y</span> <span style=color:#a6e22e>target</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>@Nullable</span> <span style=color:#a6e22e>RequestListener</span>&lt;<span style=color:#f92672>TranscodeType</span>&gt; <span style=color:#a6e22e>targetListener</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Executor</span> <span style=color:#a6e22e>callbackExecutor</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>into</span>(<span style=color:#a6e22e>target</span>, <span style=color:#a6e22e>targetListener</span>, <span style=color:#75715e>/*options=*/</span> <span style=color:#66d9ef>this</span>, <span style=color:#a6e22e>callbackExecutor</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> &lt;<span style=color:#f92672>Y</span> <span style=color:#a6e22e>extends</span> <span style=color:#a6e22e>Target</span><span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#a6e22e>TranscodeType</span>&gt;<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>Y</span> <span style=color:#a6e22e>into</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>@NonNull</span> <span style=color:#a6e22e>Y</span> <span style=color:#a6e22e>target</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>@Nullable</span> <span style=color:#a6e22e>RequestListener</span>&lt;<span style=color:#f92672>TranscodeType</span>&gt; <span style=color:#a6e22e>targetListener</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>BaseRequestOptions</span><span style=color:#f92672>&lt;?&gt;</span> <span style=color:#a6e22e>options</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Executor</span> <span style=color:#a6e22e>callbackExecutor</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Preconditions</span>.<span style=color:#a6e22e>checkNotNull</span>(<span style=color:#a6e22e>target</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>isModelSet</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>IllegalArgumentException</span>(<span style=color:#e6db74>&#34;You must call #load() before calling #into()&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Request</span> <span style=color:#a6e22e>request</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>buildRequest</span>(<span style=color:#a6e22e>target</span>, <span style=color:#a6e22e>targetListener</span>, <span style=color:#a6e22e>options</span>, <span style=color:#a6e22e>callbackExecutor</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Request</span> <span style=color:#a6e22e>previous</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>getRequest</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>isEquivalentTo</span>(<span style=color:#a6e22e>previous</span>)
</span></span><span style=display:flex><span>      <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>isSkipMemoryCacheWithCompletePreviousRequest</span>(<span style=color:#a6e22e>options</span>, <span style=color:#a6e22e>previous</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// If the request is completed, beginning again will ensure the result is re-delivered,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// triggering RequestListeners and Targets. If the request is failed, beginning again will
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// restart the request, giving it another chance to complete. If the request is already
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// running, we can let it continue running without interruption.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>Preconditions</span>.<span style=color:#a6e22e>checkNotNull</span>(<span style=color:#a6e22e>previous</span>).<span style=color:#a6e22e>isRunning</span>()) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Use the previous request rather than the new one to allow for optimizations like skipping
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// setting placeholders, tracking and un-tracking Targets, and obtaining View dimensions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// that are done in the individual Request.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>previous</span>.<span style=color:#a6e22e>begin</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>target</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>requestManager</span>.<span style=color:#a6e22e>clear</span>(<span style=color:#a6e22e>target</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>setRequest</span>(<span style=color:#a6e22e>request</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>requestManager</span>.<span style=color:#a6e22e>track</span>(<span style=color:#a6e22e>target</span>, <span style=color:#a6e22e>request</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>target</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 最常用的一个重载
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>ViewTarget</span>&lt;<span style=color:#f92672>ImageView</span><span style=color:#960050;background-color:#1e0010>,</span> <span style=color:#a6e22e>TranscodeType</span>&gt; <span style=color:#a6e22e>into</span>(<span style=color:#66d9ef>@NonNull</span> <span style=color:#a6e22e>ImageView</span> <span style=color:#a6e22e>view</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Util</span>.<span style=color:#a6e22e>assertMainThread</span>();
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Preconditions</span>.<span style=color:#a6e22e>checkNotNull</span>(<span style=color:#a6e22e>view</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>BaseRequestOptions</span><span style=color:#f92672>&lt;?&gt;</span> <span style=color:#a6e22e>requestOptions</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>;
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 若没有指定transform，isTransformationSet()为false
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// isTransformationAllowed()一般为true，除非主动调用了dontTransform()方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>requestOptions</span>.<span style=color:#a6e22e>isTransformationSet</span>()
</span></span><span style=display:flex><span>      <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>requestOptions</span>.<span style=color:#a6e22e>isTransformationAllowed</span>()
</span></span><span style=display:flex><span>      <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>view</span>.<span style=color:#a6e22e>getScaleType</span>() <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Clone in this method so that if we use this RequestBuilder to load into a View and then
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// into a different target, we don&#39;t retain the transformation applied based on the previous
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// View&#39;s scale type.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 根据ImageView的ScaleType设置不同的down sample和transform选项
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>switch</span> (<span style=color:#a6e22e>view</span>.<span style=color:#a6e22e>getScaleType</span>()) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>CENTER_CROP</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>requestOptions</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>requestOptions</span>.<span style=color:#a6e22e>clone</span>().<span style=color:#a6e22e>optionalCenterCrop</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>CENTER_INSIDE</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>requestOptions</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>requestOptions</span>.<span style=color:#a6e22e>clone</span>().<span style=color:#a6e22e>optionalCenterInside</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>FIT_CENTER</span><span style=color:#f92672>:</span> <span style=color:#75715e>// 默认值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>FIT_START</span>:
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>FIT_END</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>requestOptions</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>requestOptions</span>.<span style=color:#a6e22e>clone</span>().<span style=color:#a6e22e>optionalFitCenter</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>FIT_XY</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>requestOptions</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>requestOptions</span>.<span style=color:#a6e22e>clone</span>().<span style=color:#a6e22e>optionalCenterInside</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>CENTER</span>:
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>MATRIX</span>:
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Do nothing.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 调用上面的重载方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>into</span>(
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>glideContext</span>.<span style=color:#a6e22e>buildImageViewTarget</span>(<span style=color:#a6e22e>view</span>, <span style=color:#a6e22e>transcodeClass</span>),
</span></span><span style=display:flex><span>      <span style=color:#75715e>/*targetListener=*/</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>requestOptions</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Executors</span>.<span style=color:#a6e22e>mainThreadExecutor</span>());
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-2/clipboard_20230323_034202.png width=auto alt></p><h2 id=strong整体流程strong><strong>整体流程</strong>
<a class=anchor href=#strong%e6%95%b4%e4%bd%93%e6%b5%81%e7%a8%8bstrong>#</a></h2><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-2/clipboard_20230323_034206.png width=auto alt></p><h1 id=strong缓存strong><strong>缓存</strong>
<a class=anchor href=#strong%e7%bc%93%e5%ad%98strong>#</a></h1><h2 id=glide-缓存机制>Glide 缓存机制
<a class=anchor href=#glide-%e7%bc%93%e5%ad%98%e6%9c%ba%e5%88%b6>#</a></h2><p>Glide 之所以被广泛使用的一个重要原因就是它强大的缓存机制。在 Glide 官方文档中，在
<a href=https://muyangmin.github.io/glide-docs-cn/doc/caching.html rel=noopener>缓存部分</a> 有如下描述：</p><p>默认情况下，Glide 会在开始一个新的图片请求之前检查以下多级的缓存：</p><p>1、活动资源 (Active Resources) - 现在是否有另一个 View 正在展示这张图片？</p><p>2、内存缓存 (Memory Cache) - 该图片是否最近被加载过并仍存在于内存中？</p><p>3、资源类型（Resource） - 该图片是否之前曾被解码、转换并写入过磁盘缓存？</p><p>4、数据来源 (Data) - 构建这个图片的资源是否之前曾被写入过文件缓存？</p><p>前两步检查图片是否在内存中，如果是则直接返回图片。后两步则检查图片是否在磁盘上，以便快速但异步地返回图片。</p><p>如果四个步骤都未能找到图片，则 Glide 会返回到原始资源以取回数据（原始文件，Uri, Url 等）。</p><p>Glide 缓存机制的流程图如下：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-2/clipboard_20230323_034424.png width=auto alt></p><p>Glide 的 memory cache 和 disk cache 在 Glide 创建的时候就确定了。代码在 GlideBuilder.build(Context) 方法里面：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>Glide <span style=color:#a6e22e>build</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Context context<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>memoryCache <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    memoryCache <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LruResourceCache<span style=color:#f92672>(</span>memorySizeCalculator<span style=color:#f92672>.</span><span style=color:#a6e22e>getMemoryCacheSize</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>diskCacheFactory <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    diskCacheFactory <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> InternalCacheDiskCacheFactory<span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>engine <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    engine <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Engine<span style=color:#f92672>(</span>memoryCache<span style=color:#f92672>,</span> diskCacheFactory<span style=color:#f92672>,</span> <span style=color:#f92672>...);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Glide<span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> engine<span style=color:#f92672>,</span> memoryCache<span style=color:#f92672>,</span> <span style=color:#f92672>...);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>如果没有在任何 GlideModule 中进行自定义的话，memoryCache 和 diskCacheFactory 会使用一个默认值，大部分情况下使用这个默认值去实现缓存就可以了。</p><h2 id=strong配置缓存strong><strong>配置缓存</strong>
<a class=anchor href=#strong%e9%85%8d%e7%bd%ae%e7%bc%93%e5%ad%98strong>#</a></h2><h3 id=磁盘缓存策略>磁盘缓存策略
<a class=anchor href=#%e7%a3%81%e7%9b%98%e7%bc%93%e5%ad%98%e7%ad%96%e7%95%a5>#</a></h3><p>DiskCacheStrategy 可被 diskCacheStrategy() 方法应用到每一个单独的请求。 目前支持的策略允许你阻止加载过程使用或写入磁盘缓存，选择性地仅缓存无修改的原生数据，或仅缓存变换过的缩略图，或是兼而有之。磁盘缓存一共有以下几种策略：</p><ul><li>DiskCacheStrategy.AUTOMATIC：尝试对本地和远程图片使用最佳的策略，它是默认使用的策略。当加载远程数据（比如从 URL 下载）时，仅会存储未被加载过程修改过（比如变换）的原始数据。对于本地数据，则会仅存储变换过的缩略图，因为即使需要再次生成另一个尺寸或类型的图片，取回原始数据也很容易。</li><li>DiskCacheStrategy.NONE： 表示不缓存任何内容。</li><li>DiskCacheStrategy.DATA： 表示只缓存原始图片。</li><li>DiskCacheStrategy.RESOURCE： 表示只缓存转换过后的图片。</li><li>DiskCacheStrategy.ALL ： 表示既缓存原始图片，也缓存转换过后的图片。</li></ul><p><strong>指定 DiskCacheStrategy :</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Glide<span style=color:#f92672>.</span><span style=color:#a6e22e>with</span><span style=color:#f92672>(</span>fragment<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>.</span><span style=color:#a6e22e>load</span><span style=color:#f92672>(</span>url<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>.</span><span style=color:#a6e22e>diskCacheStrategy</span><span style=color:#f92672>(</span>DiskCacheStrategy<span style=color:#f92672>.</span><span style=color:#a6e22e>ALL</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>.</span><span style=color:#a6e22e>into</span><span style=color:#f92672>(</span>imageView<span style=color:#f92672>);</span>
</span></span></code></pre></div><h3 id=仅从缓存加载图片>仅从缓存加载图片
<a class=anchor href=#%e4%bb%85%e4%bb%8e%e7%bc%93%e5%ad%98%e5%8a%a0%e8%bd%bd%e5%9b%be%e7%89%87>#</a></h3><p>某些情形下，可能希望只要图片不在缓存中则加载直接失败（比如省流量模式？）。如果要达到这种效果，可以在单个请求的基础上使用 onlyRetrieveFromCache 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Glide<span style=color:#f92672>.</span><span style=color:#a6e22e>with</span><span style=color:#f92672>(</span>fragment<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>.</span><span style=color:#a6e22e>load</span><span style=color:#f92672>(</span>url<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>.</span><span style=color:#a6e22e>onlyRetrieveFromCache</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>.</span><span style=color:#a6e22e>into</span><span style=color:#f92672>(</span>imageView<span style=color:#f92672>);</span>
</span></span></code></pre></div><p>这时如果图片在内存缓存或在磁盘缓存中，它会被展示出来。否则只要这个选项被设置为 true ，这次加载会视同失败。</p><h3 id=跳过缓存>跳过缓存
<a class=anchor href=#%e8%b7%b3%e8%bf%87%e7%bc%93%e5%ad%98>#</a></h3><p>如果你想确保一个特定的请求跳过磁盘和/或内存缓存（<em>比如，图片验证码</em>），Glide 也提供了一些替代方案。</p><p>仅跳过内存缓存，请使用 skipMemoryCache() :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Glide<span style=color:#f92672>.</span><span style=color:#a6e22e>with</span><span style=color:#f92672>(</span>fragment<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>.</span><span style=color:#a6e22e>load</span><span style=color:#f92672>(</span>url<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>.</span><span style=color:#a6e22e>skipMemoryCache</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>.</span><span style=color:#a6e22e>into</span><span style=color:#f92672>(</span>view<span style=color:#f92672>);</span>
</span></span></code></pre></div><p>仅跳过磁盘缓存，请使用 DiskCacheStrategy.NONE :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Glide<span style=color:#f92672>.</span><span style=color:#a6e22e>with</span><span style=color:#f92672>(</span>fragment<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>.</span><span style=color:#a6e22e>load</span><span style=color:#f92672>(</span>url<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>.</span><span style=color:#a6e22e>diskCacheStrategy</span><span style=color:#f92672>(</span>DiskCacheStrategy<span style=color:#f92672>.</span><span style=color:#a6e22e>NONE</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>.</span><span style=color:#a6e22e>into</span><span style=color:#f92672>(</span>view<span style=color:#f92672>);</span>
</span></span></code></pre></div><p>这两个选项可以同时使用:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Glide<span style=color:#f92672>.</span><span style=color:#a6e22e>with</span><span style=color:#f92672>(</span>fragment<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>.</span><span style=color:#a6e22e>load</span><span style=color:#f92672>(</span>url<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>.</span><span style=color:#a6e22e>diskCacheStrategy</span><span style=color:#f92672>(</span>DiskCacheStrategy<span style=color:#f92672>.</span><span style=color:#a6e22e>NONE</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>.</span><span style=color:#a6e22e>skipMemoryCache</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>.</span><span style=color:#a6e22e>into</span><span style=color:#f92672>(</span>view<span style=color:#f92672>);</span>
</span></span></code></pre></div><p>虽然提供了这些选项跳过缓存，但不建议这么做。因为从缓存中加载一个图片，要比拉取 - 解码 - 转换成一张新图片的完整流程快得多。</p><h2 id=活动资源-activeresource>活动资源 ActiveResource
<a class=anchor href=#%e6%b4%bb%e5%8a%a8%e8%b5%84%e6%ba%90-activeresource>#</a></h2><p>ActiveResources 在 Engine 的构造器中被创建，它的源码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ActiveResources</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> isActiveResourceRetentionAllowed<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Executor monitorClearedResourcesExecutor<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> Map<span style=color:#f92672>&lt;</span>Key<span style=color:#f92672>,</span> ResourceWeakReference<span style=color:#f92672>&gt;</span> activeEngineResources <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ReferenceQueue<span style=color:#f92672>&lt;</span>EngineResource<span style=color:#f92672>&lt;?&gt;&gt;</span> resourceReferenceQueue <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ReferenceQueue<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> ResourceListener listener<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>volatile</span> <span style=color:#66d9ef>boolean</span> isShutdown<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>volatile</span> DequeuedResourceCallback cb<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ActiveResources<span style=color:#f92672>(</span><span style=color:#66d9ef>boolean</span> isActiveResourceRetentionAllowed<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        isActiveResourceRetentionAllowed<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        java<span style=color:#f92672>.</span><span style=color:#a6e22e>util</span><span style=color:#f92672>.</span><span style=color:#a6e22e>concurrent</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Executors</span><span style=color:#f92672>.</span><span style=color:#a6e22e>newSingleThreadExecutor</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> ThreadFactory<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>public</span> Thread <span style=color:#a6e22e>newThread</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> <span style=color:#66d9ef>final</span> Runnable r<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Thread<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>new</span> Runnable<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                      <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>                      <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        Process<span style=color:#f92672>.</span><span style=color:#a6e22e>setThreadPriority</span><span style=color:#f92672>(</span>Process<span style=color:#f92672>.</span><span style=color:#a6e22e>THREAD_PRIORITY_BACKGROUND</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        r<span style=color:#f92672>.</span><span style=color:#a6e22e>run</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>},</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;glide-active-resources&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}));</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ActiveResources<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>boolean</span> isActiveResourceRetentionAllowed<span style=color:#f92672>,</span> Executor monitorClearedResourcesExecutor<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isActiveResourceRetentionAllowed</span> <span style=color:#f92672>=</span> isActiveResourceRetentionAllowed<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>monitorClearedResourcesExecutor</span> <span style=color:#f92672>=</span> monitorClearedResourcesExecutor<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    monitorClearedResourcesExecutor<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> Runnable<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            cleanReferenceQueue<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setListener</span><span style=color:#f92672>(</span>ResourceListener listener<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span>listener<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>listener</span> <span style=color:#f92672>=</span> listener<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>activate</span><span style=color:#f92672>(</span>Key key<span style=color:#f92672>,</span> EngineResource<span style=color:#f92672>&lt;?&gt;</span> resource<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    ResourceWeakReference toPut <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> ResourceWeakReference<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            key<span style=color:#f92672>,</span> resource<span style=color:#f92672>,</span> resourceReferenceQueue<span style=color:#f92672>,</span> isActiveResourceRetentionAllowed<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ResourceWeakReference removed <span style=color:#f92672>=</span> activeEngineResources<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> toPut<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>removed <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      removed<span style=color:#f92672>.</span><span style=color:#a6e22e>reset</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>deactivate</span><span style=color:#f92672>(</span>Key key<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    ResourceWeakReference removed <span style=color:#f92672>=</span> activeEngineResources<span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>removed <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      removed<span style=color:#f92672>.</span><span style=color:#a6e22e>reset</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>synchronized</span> EngineResource<span style=color:#f92672>&lt;?&gt;</span> get<span style=color:#f92672>(</span>Key key<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    ResourceWeakReference activeRef <span style=color:#f92672>=</span> activeEngineResources<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>activeRef <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    EngineResource<span style=color:#f92672>&lt;?&gt;</span> active <span style=color:#f92672>=</span> activeRef<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>active <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      cleanupActiveReference<span style=color:#f92672>(</span>activeRef<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> active<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>cleanupActiveReference</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> ResourceWeakReference ref<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      activeEngineResources<span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>(</span>ref<span style=color:#f92672>.</span><span style=color:#a6e22e>key</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>ref<span style=color:#f92672>.</span><span style=color:#a6e22e>isCacheable</span> <span style=color:#f92672>||</span> ref<span style=color:#f92672>.</span><span style=color:#a6e22e>resource</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    EngineResource<span style=color:#f92672>&lt;?&gt;</span> newResource <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> EngineResource<span style=color:#f92672>&lt;&gt;(</span>
</span></span><span style=display:flex><span>            ref<span style=color:#f92672>.</span><span style=color:#a6e22e>resource</span><span style=color:#f92672>,</span> <span style=color:#75715e>/*isMemoryCacheable=*/</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> <span style=color:#75715e>/*isRecyclable=*/</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>,</span> ref<span style=color:#f92672>.</span><span style=color:#a6e22e>key</span><span style=color:#f92672>,</span> listener<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    listener<span style=color:#f92672>.</span><span style=color:#a6e22e>onResourceReleased</span><span style=color:#f92672>(</span>ref<span style=color:#f92672>.</span><span style=color:#a6e22e>key</span><span style=color:#f92672>,</span> newResource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>cleanReferenceQueue</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#f92672>(!</span>isShutdown<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        ResourceWeakReference ref <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>ResourceWeakReference<span style=color:#f92672>)</span> resourceReferenceQueue<span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        cleanupActiveReference<span style=color:#f92672>(</span>ref<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        DequeuedResourceCallback current <span style=color:#f92672>=</span> cb<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>current <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          current<span style=color:#f92672>.</span><span style=color:#a6e22e>onResourceDequeued</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>interrupt</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setDequeuedResourceCallback</span><span style=color:#f92672>(</span>DequeuedResourceCallback cb<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>cb</span> <span style=color:#f92672>=</span> cb<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>DequeuedResourceCallback</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onResourceDequeued</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>shutdown</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    isShutdown <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>monitorClearedResourcesExecutor <span style=color:#66d9ef>instanceof</span> ExecutorService<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      ExecutorService service <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>ExecutorService<span style=color:#f92672>)</span> monitorClearedResourcesExecutor<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>shutdownAndAwaitTermination</span><span style=color:#f92672>(</span>service<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ResourceWeakReference</span> <span style=color:#66d9ef>extends</span> WeakReference<span style=color:#f92672>&lt;</span>EngineResource<span style=color:#f92672>&lt;?&gt;&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> Key key<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> isCacheable<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    Resource<span style=color:#f92672>&lt;?&gt;</span> resource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    ResourceWeakReference<span style=color:#f92672>(</span>Key key<span style=color:#f92672>,</span> EngineResource<span style=color:#f92672>&lt;?&gt;</span> referent<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        ReferenceQueue<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>super</span> EngineResource<span style=color:#f92672>&lt;?&gt;&gt;</span> queue<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>boolean</span> isActiveResourceRetentionAllowed<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>referent<span style=color:#f92672>,</span> queue<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>key</span> <span style=color:#f92672>=</span> Preconditions<span style=color:#f92672>.</span><span style=color:#a6e22e>checkNotNull</span><span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>resource</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>          referent<span style=color:#f92672>.</span><span style=color:#a6e22e>isMemoryCacheable</span><span style=color:#f92672>()</span> <span style=color:#f92672>&amp;&amp;</span> isActiveResourceRetentionAllowed
</span></span><span style=display:flex><span>              <span style=color:#f92672>?</span> Preconditions<span style=color:#f92672>.</span><span style=color:#a6e22e>checkNotNull</span><span style=color:#f92672>(</span>referent<span style=color:#f92672>.</span><span style=color:#a6e22e>getResource</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      isCacheable <span style=color:#f92672>=</span> referent<span style=color:#f92672>.</span><span style=color:#a6e22e>isMemoryCacheable</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>reset</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      resource <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      clear<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>先来看 ResourceWeakReference，<code>extends WeakReference&lt;EngineResource&lt;?>></code> 表示它继承自 WeakReference 并且用于保存 EngineResource 类型的引用，此外添加了一个 reset 方法用来清理资源。</p><p>构造方法中调用了 super(referent, queue)，这样如果 referent 指向的对象将要被 GC 的时候，referent 就会被放入 queue 中。</p><p>ActiveResources 初始化时，会启动一个名为“glide-active-resources”的 BACKGROUND 的线程，在该线程中会调用 cleanReferenceQueue() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>cleanReferenceQueue</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#f92672>(!</span>isShutdown<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//remove 方法会发生阻塞
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        ResourceWeakReference ref <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>ResourceWeakReference<span style=color:#f92672>)</span> 
</span></span><span style=display:flex><span>            resourceReferenceQueue<span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//清除资源
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        cleanupActiveReference<span style=color:#f92672>(</span>ref<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        DequeuedResourceCallback current <span style=color:#f92672>=</span> cb<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>current <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          current<span style=color:#f92672>.</span><span style=color:#a6e22e>onResourceDequeued</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>interrupt</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>而 resourceReferenceQueue.remove() 方法会一直尝试从 queue 中获取将要被 GC 的 EngineResource。当发生 GC 时，如果 EngineResource 只 ResourceWeakReference 对象持有，ResourceWeakReference 对象就会被插入到 queue 中，这时在 remove() 方法就能获取到一个 ResourceWeakReference 对象（这是一个典型的生产者 - 消费者模型）。</p><p>然后调用 cleanupActiveReference 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>cleanupActiveReference</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> ResourceWeakReference ref<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>//从集合中移除
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      activeEngineResources<span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>(</span>ref<span style=color:#f92672>.</span><span style=color:#a6e22e>key</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>ref<span style=color:#f92672>.</span><span style=color:#a6e22e>isCacheable</span> <span style=color:#f92672>||</span> ref<span style=color:#f92672>.</span><span style=color:#a6e22e>resource</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    EngineResource<span style=color:#f92672>&lt;?&gt;</span> newResource <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> EngineResource<span style=color:#f92672>&lt;&gt;(</span>
</span></span><span style=display:flex><span>            ref<span style=color:#f92672>.</span><span style=color:#a6e22e>resource</span><span style=color:#f92672>,</span> <span style=color:#75715e>/*isMemoryCacheable=*/</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> <span style=color:#75715e>/*isRecyclable=*/</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>,</span> ref<span style=color:#f92672>.</span><span style=color:#a6e22e>key</span><span style=color:#f92672>,</span> listener<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//将被 GC 的 EngineResource 回调给 listener
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    listener<span style=color:#f92672>.</span><span style=color:#a6e22e>onResourceReleased</span><span style=color:#f92672>(</span>ref<span style=color:#f92672>.</span><span style=color:#a6e22e>key</span><span style=color:#f92672>,</span> newResource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>首先会将该对象从集合中移除，然后再将 ResourceWeakReference 对象中的资源取出并回调给 listener，这个 listener 的唯一实现在 Engine 类中，后面还会有地方调用这个方法，这里暂时不进行分析。</p><p>该方法除了在此时被调用外，还在 ActiveResources.get(key) 方法中也可能会因为获取到的 resource 为 null 而被调用。</p><h2 id=内存缓存-memorycache>内存缓存 MemoryCache
<a class=anchor href=#%e5%86%85%e5%ad%98%e7%bc%93%e5%ad%98-memorycache>#</a></h2><p>MemoryCache 发生存取操作是在 Engine 中，但是我们看到 MemoryCache 还被放入了 Glide 实例中。这是因为 Glide 实现了 ComponentCallbacks2 接口，在 Glide 创建完成后，实例就注册了该接口。这样在内存紧张的时候，可以通过回调 onTrimMemory 方法通知释放内存。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onTrimMemory</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> level<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  trimMemory<span style=color:#f92672>(</span>level<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>trimMemory</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> level<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Engine asserts this anyway when removing resources, fail faster and consistently
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Util<span style=color:#f92672>.</span><span style=color:#a6e22e>assertMainThread</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Request managers need to be trimmed before the caches and pools, in order for the latter to
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// have the most benefit.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span>managers<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>RequestManager manager <span style=color:#f92672>:</span> managers<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      manager<span style=color:#f92672>.</span><span style=color:#a6e22e>onTrimMemory</span><span style=color:#f92672>(</span>level<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// memory cache needs to be trimmed before bitmap pool to trim re-pooled Bitmaps too. See #687.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  memoryCache<span style=color:#f92672>.</span><span style=color:#a6e22e>trimMemory</span><span style=color:#f92672>(</span>level<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  bitmapPool<span style=color:#f92672>.</span><span style=color:#a6e22e>trimMemory</span><span style=color:#f92672>(</span>level<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  arrayPool<span style=color:#f92672>.</span><span style=color:#a6e22e>trimMemory</span><span style=color:#f92672>(</span>level<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>前面提到过，Glide 初始化的时候如果没有设置过内存缓存方案，则会采用默认实现方案：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>memoryCache <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    memoryCache <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LruResourceCache<span style=color:#f92672>(</span>memorySizeCalculator<span style=color:#f92672>.</span><span style=color:#a6e22e>getMemoryCacheSize</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>LruResourceCache 继承自 LruCache 类并实现了 MemoryCache 接口，LruCache 使用 LRU（least recently used，即最近最少使用）算法实现的内存淘汰算法，它的核心思想是当缓存对象的数量达到阈值时，会优先删除那些近期最少使用的缓存对象。</p><p>LruCache 定义了 LRU 相关的操作，而 MemoryCache 定义的是内存缓存相关的操作。LruResourceCache 源码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LruResourceCache</span> <span style=color:#66d9ef>extends</span> LruCache<span style=color:#f92672>&lt;</span>Key<span style=color:#f92672>,</span> Resource<span style=color:#f92672>&lt;?&gt;&gt;</span> <span style=color:#66d9ef>implements</span> MemoryCache <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> ResourceRemovedListener listener<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * Constructor for LruResourceCache.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   *
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * @param size The maximum size in bytes the in memory cache can use.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>LruResourceCache</span><span style=color:#f92672>(</span><span style=color:#66d9ef>long</span> size<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>size<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setResourceRemovedListener</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> ResourceRemovedListener listener<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>listener</span> <span style=color:#f92672>=</span> listener<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onItemEvicted</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Key key<span style=color:#f92672>,</span> <span style=color:#a6e22e>@Nullable</span> Resource<span style=color:#f92672>&lt;?&gt;</span> item<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>listener <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> item <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      listener<span style=color:#f92672>.</span><span style=color:#a6e22e>onResourceRemoved</span><span style=color:#f92672>(</span>item<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getSize</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@Nullable</span> Resource<span style=color:#f92672>&lt;?&gt;</span> item<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>item <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getSize</span><span style=color:#f92672>(</span><span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> item<span style=color:#f92672>.</span><span style=color:#a6e22e>getSize</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>trimMemory</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> level<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>level <span style=color:#f92672>&gt;=</span> android<span style=color:#f92672>.</span><span style=color:#a6e22e>content</span><span style=color:#f92672>.</span><span style=color:#a6e22e>ComponentCallbacks2</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TRIM_MEMORY_BACKGROUND</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Entering list of cached background apps
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// Evict our entire bitmap cache
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      clearMemory<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>level <span style=color:#f92672>&gt;=</span> android<span style=color:#f92672>.</span><span style=color:#a6e22e>content</span><span style=color:#f92672>.</span><span style=color:#a6e22e>ComponentCallbacks2</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TRIM_MEMORY_UI_HIDDEN</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>||</span> level <span style=color:#f92672>==</span> android<span style=color:#f92672>.</span><span style=color:#a6e22e>content</span><span style=color:#f92672>.</span><span style=color:#a6e22e>ComponentCallbacks2</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TRIM_MEMORY_RUNNING_CRITICAL</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// The app&#39;s UI is no longer visible, or app is in the foreground but system is running
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// critically low on memory
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// Evict oldest half of our bitmap cache
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      trimToSize<span style=color:#f92672>(</span>getMaxSize<span style=color:#f92672>()</span> <span style=color:#f92672>/</span> 2<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>LruCache 的源码如下<span style=color:#960050;background-color:#1e0010>：</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LruCache</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>,</span> Y<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Map<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>,</span> Entry<span style=color:#f92672>&lt;</span>Y<span style=color:#f92672>&gt;&gt;</span> cache <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LinkedHashMap<span style=color:#f92672>&lt;&gt;(</span>100<span style=color:#f92672>,</span> 0<span style=color:#f92672>.</span><span style=color:#a6e22e>75f</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> initialMaxSize<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>long</span> maxSize<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>long</span> currentSize<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>LruCache</span><span style=color:#f92672>(</span><span style=color:#66d9ef>long</span> size<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>initialMaxSize</span> <span style=color:#f92672>=</span> size<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>maxSize</span> <span style=color:#f92672>=</span> size<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setSizeMultiplier</span><span style=color:#f92672>(</span><span style=color:#66d9ef>float</span> multiplier<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>multiplier <span style=color:#f92672>&lt;</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Multiplier must be &gt;= 0&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    maxSize <span style=color:#f92672>=</span> Math<span style=color:#f92672>.</span><span style=color:#a6e22e>round</span><span style=color:#f92672>(</span>initialMaxSize <span style=color:#f92672>*</span> multiplier<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    evict<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getSize</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@Nullable</span> Y item<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> 1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getCount</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> cache<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onItemEvicted</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> T key<span style=color:#f92672>,</span> <span style=color:#a6e22e>@Nullable</span> Y item<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// optional override
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>getMaxSize</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> maxSize<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>getCurrentSize</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> currentSize<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> T key<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> cache<span style=color:#f92672>.</span><span style=color:#a6e22e>containsKey</span><span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Nullable</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>synchronized</span> Y <span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> T key<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Entry<span style=color:#f92672>&lt;</span>Y<span style=color:#f92672>&gt;</span> entry <span style=color:#f92672>=</span> cache<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> entry <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> entry<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Nullable</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>synchronized</span> Y <span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> T key<span style=color:#f92672>,</span> <span style=color:#a6e22e>@Nullable</span> Y item<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> itemSize <span style=color:#f92672>=</span> getSize<span style=color:#f92672>(</span>item<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>itemSize <span style=color:#f92672>&gt;=</span> maxSize<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      onItemEvicted<span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> item<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>item <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      currentSize <span style=color:#f92672>+=</span> itemSize<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Nullable</span> Entry<span style=color:#f92672>&lt;</span>Y<span style=color:#f92672>&gt;</span> old <span style=color:#f92672>=</span> cache<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> item <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> Entry<span style=color:#f92672>&lt;&gt;(</span>item<span style=color:#f92672>,</span> itemSize<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>old <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      currentSize <span style=color:#f92672>-=</span> old<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>old<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>item<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        onItemEvicted<span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> old<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    evict<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> old <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> old<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Nullable</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>synchronized</span> Y <span style=color:#a6e22e>remove</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> T key<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Entry<span style=color:#f92672>&lt;</span>Y<span style=color:#f92672>&gt;</span> entry <span style=color:#f92672>=</span> cache<span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>entry <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    currentSize <span style=color:#f92672>-=</span> entry<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> entry<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>clearMemory</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    trimToSize<span style=color:#f92672>(</span>0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>trimToSize</span><span style=color:#f92672>(</span><span style=color:#66d9ef>long</span> size<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Map<span style=color:#f92672>.</span><span style=color:#a6e22e>Entry</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>,</span> Entry<span style=color:#f92672>&lt;</span>Y<span style=color:#f92672>&gt;&gt;</span> last<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    Iterator<span style=color:#f92672>&lt;</span>Map<span style=color:#f92672>.</span><span style=color:#a6e22e>Entry</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>,</span> Entry<span style=color:#f92672>&lt;</span>Y<span style=color:#f92672>&gt;&gt;&gt;</span> cacheIterator<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>currentSize <span style=color:#f92672>&gt;</span> size<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>//从头开始遍历
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      cacheIterator <span style=color:#f92672>=</span> cache<span style=color:#f92672>.</span><span style=color:#a6e22e>entrySet</span><span style=color:#f92672>().</span><span style=color:#a6e22e>iterator</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>//第一个元素
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      last <span style=color:#f92672>=</span> cacheIterator<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>final</span> Entry<span style=color:#f92672>&lt;</span>Y<span style=color:#f92672>&gt;</span> toRemove <span style=color:#f92672>=</span> last<span style=color:#f92672>.</span><span style=color:#a6e22e>getValue</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      currentSize <span style=color:#f92672>-=</span> toRemove<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>final</span> T key <span style=color:#f92672>=</span> last<span style=color:#f92672>.</span><span style=color:#a6e22e>getKey</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      cacheIterator<span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      onItemEvicted<span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> toRemove<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>evict</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    trimToSize<span style=color:#f92672>(</span>maxSize<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Synthetic</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Entry</span><span style=color:#f92672>&lt;</span>Y<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> Y value<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> size<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Synthetic</span>
</span></span><span style=display:flex><span>    Entry<span style=color:#f92672>(</span>Y value<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> size<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>value</span> <span style=color:#f92672>=</span> value<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>size</span> <span style=color:#f92672>=</span> size<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>LruCache 内部持有一个 LinkedHashMap 的变量 cache ：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Map<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>,</span> Entry<span style=color:#f92672>&lt;</span>Y<span style=color:#f92672>&gt;&gt;</span> cache <span style=color:#f92672>=</span> 
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>new</span> LinkedHashMap<span style=color:#f92672>&lt;&gt;(</span>100<span style=color:#f92672>,</span> 0<span style=color:#f92672>.</span><span style=color:#a6e22e>75f</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><p>当第三个参数 accessOrder 为 true 时，表示按照访问顺序排序，每次调用 LinkedHashMap 的 get(key) 或 getOrDefault(key, defaultValue) 方法都会触发 afterNodeAccess(Object) 方法，此方法会将对应的 node 移动到链表的末尾。也就是说 LinkedHashMap 末尾的数据是最近最多使用的。</p><p>而 LruCache 清除内存时都会调用 trimToSize(size) 方法时，会从头到尾进行清理，即清理掉最少使用的元素。</p><p>LinkedHashMap 主要代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LinkedHashMap</span><span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>extends</span> HashMap<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>implements</span> Map<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>LinkedHashMap</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> initialCapacity<span style=color:#f92672>,</span> 
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>float</span> loadFactor<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> accessOrder<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>initialCapacity<span style=color:#f92672>,</span> loadFactor<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>accessOrder</span> <span style=color:#f92672>=</span> accessOrder<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> V <span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>Object key<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Node<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>e <span style=color:#f92672>=</span> getNode<span style=color:#f92672>(</span>hash<span style=color:#f92672>(</span>key<span style=color:#f92672>),</span> key<span style=color:#f92672>))</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>accessOrder<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            afterNodeAccess<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> V <span style=color:#a6e22e>getOrDefault</span><span style=color:#f92672>(</span>Object key<span style=color:#f92672>,</span> V defaultValue<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>       Node<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>e <span style=color:#f92672>=</span> getNode<span style=color:#f92672>(</span>hash<span style=color:#f92672>(</span>key<span style=color:#f92672>),</span> key<span style=color:#f92672>))</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>           <span style=color:#66d9ef>return</span> defaultValue<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>accessOrder<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>           afterNodeAccess<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>afterNodeAccess</span><span style=color:#f92672>(</span>Node<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span> <span style=color:#75715e>// move node to last
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        LinkedHashMapEntry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> last<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>accessOrder <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>(</span>last <span style=color:#f92672>=</span> tail<span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            LinkedHashMapEntry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> p <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>(</span>LinkedHashMapEntry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;)</span>e<span style=color:#f92672>,</span> b <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span><span style=color:#a6e22e>before</span><span style=color:#f92672>,</span> a <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span><span style=color:#a6e22e>after</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            p<span style=color:#f92672>.</span><span style=color:#a6e22e>after</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>b <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                head <span style=color:#f92672>=</span> a<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>                b<span style=color:#f92672>.</span><span style=color:#a6e22e>after</span> <span style=color:#f92672>=</span> a<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>a <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                a<span style=color:#f92672>.</span><span style=color:#a6e22e>before</span> <span style=color:#f92672>=</span> b<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>                last <span style=color:#f92672>=</span> b<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>last <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                head <span style=color:#f92672>=</span> p<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                p<span style=color:#f92672>.</span><span style=color:#a6e22e>before</span> <span style=color:#f92672>=</span> last<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                last<span style=color:#f92672>.</span><span style=color:#a6e22e>after</span> <span style=color:#f92672>=</span> p<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            tail <span style=color:#f92672>=</span> p<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>++</span>modCount<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=strong磁盘缓存-diskcachestrong><strong>磁盘缓存 DiskCache</strong>
<a class=anchor href=#strong%e7%a3%81%e7%9b%98%e7%bc%93%e5%ad%98-diskcachestrong>#</a></h2><p>Glide 初始化时，如果 disCacheFactory 如果没有被指定，则会使用一个默认值，而这个 InternalCacheDiskCacheFactory 就是实现磁盘缓存的入口。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>diskCacheFactory <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    diskCacheFactory <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> InternalCacheDiskCacheFactory<span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>InternalCacheDiskCacheFactory 源码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>InternalCacheDiskCacheFactory</span> <span style=color:#66d9ef>extends</span> DiskLruCacheFactory <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>InternalCacheDiskCacheFactory</span><span style=color:#f92672>(</span>Context context<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        context<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        DiskCache<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span><span style=color:#f92672>.</span><span style=color:#a6e22e>DEFAULT_DISK_CACHE_DIR</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        DiskCache<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span><span style=color:#f92672>.</span><span style=color:#a6e22e>DEFAULT_DISK_CACHE_SIZE</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>InternalCacheDiskCacheFactory</span><span style=color:#f92672>(</span>Context context<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> diskCacheSize<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> DiskCache<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span><span style=color:#f92672>.</span><span style=color:#a6e22e>DEFAULT_DISK_CACHE_DIR</span><span style=color:#f92672>,</span> diskCacheSize<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>InternalCacheDiskCacheFactory</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>final</span> Context context<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> String diskCacheName<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> diskCacheSize<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> CacheDirectoryGetter<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>public</span> File <span style=color:#a6e22e>getCacheDirectory</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            File cacheDirectory <span style=color:#f92672>=</span> context<span style=color:#f92672>.</span><span style=color:#a6e22e>getCacheDir</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>cacheDirectory <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>diskCacheName <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> File<span style=color:#f92672>(</span>cacheDirectory<span style=color:#f92672>,</span> diskCacheName<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> cacheDirectory<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>},</span>
</span></span><span style=display:flex><span>        diskCacheSize<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>它的父类 DiskLruCacheFactory 和 DiskCache 类源码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DiskLruCacheFactory</span> <span style=color:#66d9ef>implements</span> DiskCache<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> diskCacheSize<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> CacheDirectoryGetter cacheDirectoryGetter<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/** Interface called out of UI thread to get the cache folder. */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>CacheDirectoryGetter</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    File <span style=color:#a6e22e>getCacheDirectory</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>DiskLruCacheFactory</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> String diskCacheFolder<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> diskCacheSize<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> CacheDirectoryGetter<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>public</span> File <span style=color:#a6e22e>getCacheDirectory</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> File<span style=color:#f92672>(</span>diskCacheFolder<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>},</span>
</span></span><span style=display:flex><span>        diskCacheSize<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>DiskLruCacheFactory</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>final</span> String diskCacheFolder<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> String diskCacheName<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> diskCacheSize<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> CacheDirectoryGetter<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>public</span> File <span style=color:#a6e22e>getCacheDirectory</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> File<span style=color:#f92672>(</span>diskCacheFolder<span style=color:#f92672>,</span> diskCacheName<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>},</span>
</span></span><span style=display:flex><span>        diskCacheSize<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;WeakerAccess&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>DiskLruCacheFactory</span><span style=color:#f92672>(</span>CacheDirectoryGetter cacheDirectoryGetter<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> diskCacheSize<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>diskCacheSize</span> <span style=color:#f92672>=</span> diskCacheSize<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>cacheDirectoryGetter</span> <span style=color:#f92672>=</span> cacheDirectoryGetter<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> DiskCache <span style=color:#a6e22e>build</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    File cacheDir <span style=color:#f92672>=</span> cacheDirectoryGetter<span style=color:#f92672>.</span><span style=color:#a6e22e>getCacheDirectory</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>cacheDir <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>cacheDir<span style=color:#f92672>.</span><span style=color:#a6e22e>isDirectory</span><span style=color:#f92672>()</span> <span style=color:#f92672>||</span> cacheDir<span style=color:#f92672>.</span><span style=color:#a6e22e>mkdirs</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> DiskLruCacheWrapper<span style=color:#f92672>.</span><span style=color:#a6e22e>create</span><span style=color:#f92672>(</span>cacheDir<span style=color:#f92672>,</span> diskCacheSize<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>DiskCache</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/** An interface for lazily creating a disk cache. */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>Factory</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 250 MB of cache. */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> DEFAULT_DISK_CACHE_SIZE <span style=color:#f92672>=</span> 250 <span style=color:#f92672>*</span> 1024 <span style=color:#f92672>*</span> 1024<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    String DEFAULT_DISK_CACHE_DIR <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;image_manager_disk_cache&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** Returns a new disk cache, or {@code null} if no disk cache could be created. */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Nullable</span>
</span></span><span style=display:flex><span>    DiskCache <span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/** An interface to actually write data to a key in the disk cache. */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>Writer</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>write</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> File file<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Nullable</span>
</span></span><span style=display:flex><span>  File <span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>Key key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>Key key<span style=color:#f92672>,</span> Writer writer<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>delete</span><span style=color:#f92672>(</span>Key key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>clear</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>DiskLruCacheFactory.build() 方法会返回一个 DiskLruCacheWrapper 类的实例。回溯到前面 InternalCacheDiskCacheFactory 的创建流程可知，默认创建的 DiskLruCacheWrapper 传入的 diskCacheSize 为 250M 并且 cacheDir 为 <em>/data/data/{package}/cache/image_manager_disk_cache/ </em>，分别对应缓存大小和目录。</p><p>接下来查看 DiskLruCacheWrapper 源码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DiskLruCacheWrapper</span> <span style=color:#66d9ef>implements</span> DiskCache <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String TAG <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;DiskLruCacheWrapper&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> APP_VERSION <span style=color:#f92672>=</span> 1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> VALUE_COUNT <span style=color:#f92672>=</span> 1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> DiskLruCacheWrapper wrapper<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> SafeKeyGenerator safeKeyGenerator<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> File directory<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> maxSize<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> DiskCacheWriteLocker writeLocker <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DiskCacheWriteLocker<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> DiskLruCache diskLruCache<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;deprecation&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> DiskCache <span style=color:#a6e22e>create</span><span style=color:#f92672>(</span>File directory<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> maxSize<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> DiskLruCacheWrapper<span style=color:#f92672>(</span>directory<span style=color:#f92672>,</span> maxSize<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>({</span><span style=color:#e6db74>&#34;WeakerAccess&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;DeprecatedIsStillUsed&#34;</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>protected</span> <span style=color:#a6e22e>DiskLruCacheWrapper</span><span style=color:#f92672>(</span>File directory<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> maxSize<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>directory</span> <span style=color:#f92672>=</span> directory<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>maxSize</span> <span style=color:#f92672>=</span> maxSize<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>safeKeyGenerator</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SafeKeyGenerator<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>synchronized</span> DiskLruCache <span style=color:#a6e22e>getDiskCache</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>diskLruCache <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      diskLruCache <span style=color:#f92672>=</span> DiskLruCache<span style=color:#f92672>.</span><span style=color:#a6e22e>open</span><span style=color:#f92672>(</span>directory<span style=color:#f92672>,</span> APP_VERSION<span style=color:#f92672>,</span> VALUE_COUNT<span style=color:#f92672>,</span> maxSize<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> diskLruCache<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> File <span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>Key key<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    String safeKey <span style=color:#f92672>=</span> safeKeyGenerator<span style=color:#f92672>.</span><span style=color:#a6e22e>getSafeKey</span><span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Log<span style=color:#f92672>.</span><span style=color:#a6e22e>isLoggable</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> Log<span style=color:#f92672>.</span><span style=color:#a6e22e>VERBOSE</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      Log<span style=color:#f92672>.</span><span style=color:#a6e22e>v</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Get: Obtained: &#34;</span> <span style=color:#f92672>+</span> safeKey <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; for for Key: &#34;</span> <span style=color:#f92672>+</span> key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    File result <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>final</span> DiskLruCache<span style=color:#f92672>.</span><span style=color:#a6e22e>Value</span> value <span style=color:#f92672>=</span> getDiskCache<span style=color:#f92672>().</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>safeKey<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>value <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> value<span style=color:#f92672>.</span><span style=color:#a6e22e>getFile</span><span style=color:#f92672>(</span>0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Log<span style=color:#f92672>.</span><span style=color:#a6e22e>isLoggable</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> Log<span style=color:#f92672>.</span><span style=color:#a6e22e>WARN</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Log<span style=color:#f92672>.</span><span style=color:#a6e22e>w</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Unable to get from disk cache&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>Key key<span style=color:#f92672>,</span> Writer writer<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    String safeKey <span style=color:#f92672>=</span> safeKeyGenerator<span style=color:#f92672>.</span><span style=color:#a6e22e>getSafeKey</span><span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    writeLocker<span style=color:#f92672>.</span><span style=color:#a6e22e>acquire</span><span style=color:#f92672>(</span>safeKey<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Log<span style=color:#f92672>.</span><span style=color:#a6e22e>isLoggable</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> Log<span style=color:#f92672>.</span><span style=color:#a6e22e>VERBOSE</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Log<span style=color:#f92672>.</span><span style=color:#a6e22e>v</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Put: Obtained: &#34;</span> <span style=color:#f92672>+</span> safeKey <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; for for Key: &#34;</span> <span style=color:#f92672>+</span> key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        DiskLruCache diskCache <span style=color:#f92672>=</span> getDiskCache<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        Value current <span style=color:#f92672>=</span> diskCache<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>safeKey<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>current <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        DiskLruCache<span style=color:#f92672>.</span><span style=color:#a6e22e>Editor</span> editor <span style=color:#f92672>=</span> diskCache<span style=color:#f92672>.</span><span style=color:#a6e22e>edit</span><span style=color:#f92672>(</span>safeKey<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>editor <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Had two simultaneous puts for: &#34;</span> <span style=color:#f92672>+</span> safeKey<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          File file <span style=color:#f92672>=</span> editor<span style=color:#f92672>.</span><span style=color:#a6e22e>getFile</span><span style=color:#f92672>(</span>0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>writer<span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>file<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            editor<span style=color:#f92672>.</span><span style=color:#a6e22e>commit</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          editor<span style=color:#f92672>.</span><span style=color:#a6e22e>abortUnlessCommitted</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Log<span style=color:#f92672>.</span><span style=color:#a6e22e>isLoggable</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> Log<span style=color:#f92672>.</span><span style=color:#a6e22e>WARN</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          Log<span style=color:#f92672>.</span><span style=color:#a6e22e>w</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Unable to put to disk cache&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      writeLocker<span style=color:#f92672>.</span><span style=color:#a6e22e>release</span><span style=color:#f92672>(</span>safeKey<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>delete</span><span style=color:#f92672>(</span>Key key<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    String safeKey <span style=color:#f92672>=</span> safeKeyGenerator<span style=color:#f92672>.</span><span style=color:#a6e22e>getSafeKey</span><span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      getDiskCache<span style=color:#f92672>().</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>(</span>safeKey<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Log<span style=color:#f92672>.</span><span style=color:#a6e22e>isLoggable</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> Log<span style=color:#f92672>.</span><span style=color:#a6e22e>WARN</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Log<span style=color:#f92672>.</span><span style=color:#a6e22e>w</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Unable to delete from disk cache&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>clear</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      getDiskCache<span style=color:#f92672>().</span><span style=color:#a6e22e>delete</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Log<span style=color:#f92672>.</span><span style=color:#a6e22e>isLoggable</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> Log<span style=color:#f92672>.</span><span style=color:#a6e22e>WARN</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Log<span style=color:#f92672>.</span><span style=color:#a6e22e>w</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Unable to clear disk cache or disk cache cleared externally&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      resetDiskCache<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>resetDiskCache</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    diskLruCache <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>该类主要提供了一个生成 Key 的 SafeKeyGenerator 对象以及写锁 DiskCacheWriteLocker。从类名来看这是一个包装类，在代码中也可以看到，它的 get 和 put 方法最终都是通过 DiskLruCache 对象去实现的。</p><p>前面提到过，disCacheFactory 对象会被作为参数参与 Engine 的构造，在 Engine 的构造方法中会被包装成为一个 LazyDiskCacheProvider：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Engine<span style=color:#f92672>(</span>MemoryCache cache<span style=color:#f92672>,</span> DiskCache<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span> diskCacheFactory<span style=color:#f92672>,</span> <span style=color:#f92672>...)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>cache</span> <span style=color:#f92672>=</span> cache<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>diskCacheProvider</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LazyDiskCacheProvider<span style=color:#f92672>(</span>diskCacheFactory<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>LazyDiskCacheProvider 源码如下<span style=color:#960050;background-color:#1e0010>：</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LazyDiskCacheProvider</span> <span style=color:#66d9ef>implements</span> DecodeJob<span style=color:#f92672>.</span><span style=color:#a6e22e>DiskCacheProvider</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> DiskCache<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span> factory<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>volatile</span> DiskCache diskCache<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  LazyDiskCacheProvider<span style=color:#f92672>(</span>DiskCache<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span> factory<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>factory</span> <span style=color:#f92672>=</span> factory<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@VisibleForTesting</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>clearDiskCacheIfCreated</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>diskCache <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    diskCache<span style=color:#f92672>.</span><span style=color:#a6e22e>clear</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> DiskCache <span style=color:#a6e22e>getDiskCache</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>diskCache <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>diskCache <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          diskCache <span style=color:#f92672>=</span> factory<span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>diskCache <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          diskCache <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DiskCacheAdapter<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> diskCache<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>getDiskCache() 方法被调用时，会通过 DCL 的方式进而调用 factory 的 build( ) 方法返回一个 DiskCache 作为单例。</p><p>以上就是 Glide 缓存的介绍，前面加载流程的分析只是在首次加载图片的时候的流程，并没有涉及到缓存的概念，因此接下来继续在以上 into 流程中重点分析缓存部分的源码。</p><h2 id=缓存流程>缓存流程
<a class=anchor href=#%e7%bc%93%e5%ad%98%e6%b5%81%e7%a8%8b>#</a></h2><h3 id=enginekey>EngineKey
<a class=anchor href=#enginekey>#</a></h3><p>从之前的分析中可知，整个加载的过程体现在 Engine.load 方法中，该方法注释和代码片段如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>R<span style=color:#f92672>&gt;</span> LoadStatus <span style=color:#a6e22e>load</span><span style=color:#f92672>(...)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>long</span> startTime <span style=color:#f92672>=</span> VERBOSE_IS_LOGGABLE <span style=color:#f92672>?</span> LogTime<span style=color:#f92672>.</span><span style=color:#a6e22e>getLogTime</span><span style=color:#f92672>()</span> <span style=color:#f92672>:</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  EngineKey key <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      keyFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>buildKey</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>          model<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>          signature<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>          width<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>          height<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>          transformations<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>          resourceClass<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>          transcodeClass<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>          options<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  EngineResource<span style=color:#f92672>&lt;?&gt;</span> memoryResource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    memoryResource <span style=color:#f92672>=</span> loadFromMemory<span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> isMemoryCacheable<span style=color:#f92672>,</span> startTime<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>memoryResource <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>//没有获取到活动资源和 MemoryCache，则启动 Job
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>return</span> waitForExistingOrStartNewJob<span style=color:#f92672>(...);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Avoid calling back while holding the engine lock, doing so makes it easier for callers to
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// deadlock.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  cb<span style=color:#f92672>.</span><span style=color:#a6e22e>onResourceReady</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>      memoryResource<span style=color:#f92672>,</span> DataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>MEMORY_CACHE</span><span style=color:#f92672>,</span> <span style=color:#75715e>/* isLoadedFromAlternateCacheKey= */</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Nullable</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> EngineResource<span style=color:#f92672>&lt;?&gt;</span> loadFromMemory<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    EngineKey key<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> isMemoryCacheable<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> startTime<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>isMemoryCacheable<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  EngineResource<span style=color:#f92672>&lt;?&gt;</span> active <span style=color:#f92672>=</span> loadFromActiveResources<span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>active <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>VERBOSE_IS_LOGGABLE<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      logWithTimeAndKey<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Loaded resource from active resources&#34;</span><span style=color:#f92672>,</span> startTime<span style=color:#f92672>,</span> key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> active<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  EngineResource<span style=color:#f92672>&lt;?&gt;</span> cached <span style=color:#f92672>=</span> loadFromCache<span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>cached <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>VERBOSE_IS_LOGGABLE<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      logWithTimeAndKey<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Loaded resource from cache&#34;</span><span style=color:#f92672>,</span> startTime<span style=color:#f92672>,</span> key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> cached<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Nullable</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> EngineResource<span style=color:#f92672>&lt;?&gt;</span> loadFromActiveResources<span style=color:#f92672>(</span>Key key<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  EngineResource<span style=color:#f92672>&lt;?&gt;</span> active <span style=color:#f92672>=</span> activeResources<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>active <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    active<span style=color:#f92672>.</span><span style=color:#a6e22e>acquire</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> active<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> EngineResource<span style=color:#f92672>&lt;?&gt;</span> loadFromCache<span style=color:#f92672>(</span>Key key<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  EngineResource<span style=color:#f92672>&lt;?&gt;</span> cached <span style=color:#f92672>=</span> getEngineResourceFromCache<span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>cached <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    cached<span style=color:#f92672>.</span><span style=color:#a6e22e>acquire</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    activeResources<span style=color:#f92672>.</span><span style=color:#a6e22e>activate</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> cached<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> cached<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> EngineResource<span style=color:#f92672>&lt;?&gt;</span> getEngineResourceFromCache<span style=color:#f92672>(</span>Key key<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  Resource<span style=color:#f92672>&lt;?&gt;</span> cached <span style=color:#f92672>=</span> cache<span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> EngineResource<span style=color:#f92672>&lt;?&gt;</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>cached <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>cached <span style=color:#66d9ef>instanceof</span> EngineResource<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Save an object allocation if we&#39;ve cached an EngineResource (the typical case).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    result <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>EngineResource<span style=color:#f92672>&lt;?&gt;)</span> cached<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> EngineResource<span style=color:#f92672>&lt;&gt;(</span>
</span></span><span style=display:flex><span>            cached<span style=color:#f92672>,</span> <span style=color:#75715e>/*isMemoryCacheable=*/</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> <span style=color:#75715e>/*isRecyclable=*/</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> key<span style=color:#f92672>,</span> <span style=color:#75715e>/*listener=*/</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>从注释和代码中可以看出，首先会根据 key 尝试从 loadFromActiveResources() 方法中获取 ActiveResource，如果能够获取到则直接返回；否则从 loadFromCache() 方法中获取 memory cache；如果仍然没有获取到，最后就交给了 Job 从网络中获取资源。没有意外的话，磁盘缓存也是由 Job 完成的。</p><p>只要是缓存，就有 get 和 put 操作，也就离不开 Key，所以先看看从 ActiveResource 和 MemoryCache 中取缓存时的 Key——EngineKey 的组成参数：</p><table><thead><tr><th>参数</th><th>含义</th></tr></thead><tbody><tr><td>model</td><td>load 的参数。如：File、Url、Url 等。如果使用自定义的 model, 它需要正确地实现 hashCode() 和 equals()</td></tr><tr><td>signature</td><td>BaseRequestOptions 的成员变量，默认会是 EmptySignature.obtain()<br>在加载本地 resource 资源时会变成 ApplicationVersionSignature.obtain(context)</td></tr><tr><td>width<br>height</td><td>如果没有指定 override(int size)，则为 view 的 size</td></tr><tr><td>transformations</td><td>默认会基于 ImageView 的 scaleType 设置对应的四个 Transformation；<br>如果指定了 transform，那么就基于该值进行设置；<br>详见 BaseRequestOptions.transform(Transformation, boolean)</td></tr><tr><td>resourceClass</td><td>解码后的资源，如果没有 asBitmap、asGif，一般会是 Object</td></tr><tr><td>transcodeClass</td><td>最终要转换成的数据类型，根据 as 方法确定，加载本地 res 或者网络 URL，都会调用 asDrawable，所以为 Drawable</td></tr><tr><td>options</td><td>如果没有设置过 transform，此处会根据 ImageView 的 scaleType 默认指定一个 KV</td></tr></tbody></table><p>再来看 EngineKey 的内部：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EngineKey</span> <span style=color:#66d9ef>implements</span> Key <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>Object o<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>o <span style=color:#66d9ef>instanceof</span> EngineKey<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      EngineKey other <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>EngineKey<span style=color:#f92672>)</span> o<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> model<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>other<span style=color:#f92672>.</span><span style=color:#a6e22e>model</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>&amp;&amp;</span> signature<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>other<span style=color:#f92672>.</span><span style=color:#a6e22e>signature</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>&amp;&amp;</span> height <span style=color:#f92672>==</span> other<span style=color:#f92672>.</span><span style=color:#a6e22e>height</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>&amp;&amp;</span> width <span style=color:#f92672>==</span> other<span style=color:#f92672>.</span><span style=color:#a6e22e>width</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>&amp;&amp;</span> transformations<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>other<span style=color:#f92672>.</span><span style=color:#a6e22e>transformations</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>&amp;&amp;</span> resourceClass<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>other<span style=color:#f92672>.</span><span style=color:#a6e22e>resourceClass</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>&amp;&amp;</span> transcodeClass<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>other<span style=color:#f92672>.</span><span style=color:#a6e22e>transcodeClass</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>&amp;&amp;</span> options<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>other<span style=color:#f92672>.</span><span style=color:#a6e22e>options</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>hashCode</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>hashCode <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      hashCode <span style=color:#f92672>=</span> model<span style=color:#f92672>.</span><span style=color:#a6e22e>hashCode</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      hashCode <span style=color:#f92672>=</span> 31 <span style=color:#f92672>*</span> hashCode <span style=color:#f92672>+</span> signature<span style=color:#f92672>.</span><span style=color:#a6e22e>hashCode</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      hashCode <span style=color:#f92672>=</span> 31 <span style=color:#f92672>*</span> hashCode <span style=color:#f92672>+</span> width<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      hashCode <span style=color:#f92672>=</span> 31 <span style=color:#f92672>*</span> hashCode <span style=color:#f92672>+</span> height<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      hashCode <span style=color:#f92672>=</span> 31 <span style=color:#f92672>*</span> hashCode <span style=color:#f92672>+</span> transformations<span style=color:#f92672>.</span><span style=color:#a6e22e>hashCode</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      hashCode <span style=color:#f92672>=</span> 31 <span style=color:#f92672>*</span> hashCode <span style=color:#f92672>+</span> resourceClass<span style=color:#f92672>.</span><span style=color:#a6e22e>hashCode</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      hashCode <span style=color:#f92672>=</span> 31 <span style=color:#f92672>*</span> hashCode <span style=color:#f92672>+</span> transcodeClass<span style=color:#f92672>.</span><span style=color:#a6e22e>hashCode</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      hashCode <span style=color:#f92672>=</span> 31 <span style=color:#f92672>*</span> hashCode <span style=color:#f92672>+</span> options<span style=color:#f92672>.</span><span style=color:#a6e22e>hashCode</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> hashCode<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到，它的 equals 和 hashCode 方法都是标准的写法，所有成员变量都参与了判断和运算。因此在多次加载同一个 model 的过程中，即使有稍许改动（比如 View 宽高、是否经过变换等），都会导致没有获取内存缓存失败。</p><h3 id=内存缓存>内存缓存
<a class=anchor href=#%e5%86%85%e5%ad%98%e7%bc%93%e5%ad%98>#</a></h3><h4 id=activeresource-和-memorycache>ActiveResource 和 MemoryCache
<a class=anchor href=#activeresource-%e5%92%8c-memorycache>#</a></h4><p>ActiveResource 的 Value 为 ResourceWeakReference，它是 EngineResource 的包装类； MemoryCache 则是直接保存 EngineResource 对象。看看 EngineResource 的内容：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EngineResource</span><span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>implements</span> Resource<span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> isMemoryCacheable<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> isRecyclable<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Resource<span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> resource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ResourceListener listener<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Key key<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> acquired<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> isRecycled<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ResourceListener</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onResourceReleased</span><span style=color:#f92672>(</span>Key key<span style=color:#f92672>,</span> EngineResource<span style=color:#f92672>&lt;?&gt;</span> resource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  EngineResource<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>      Resource<span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> toWrap<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>boolean</span> isMemoryCacheable<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>boolean</span> isRecyclable<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      Key key<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      ResourceListener listener<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    resource <span style=color:#f92672>=</span> Preconditions<span style=color:#f92672>.</span><span style=color:#a6e22e>checkNotNull</span><span style=color:#f92672>(</span>toWrap<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isMemoryCacheable</span> <span style=color:#f92672>=</span> isMemoryCacheable<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isRecyclable</span> <span style=color:#f92672>=</span> isRecyclable<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>key</span> <span style=color:#f92672>=</span> key<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>listener</span> <span style=color:#f92672>=</span> Preconditions<span style=color:#f92672>.</span><span style=color:#a6e22e>checkNotNull</span><span style=color:#f92672>(</span>listener<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Resource<span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getResource</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> resource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isMemoryCacheable</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> isMemoryCacheable<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> Class<span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getResourceClass</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> resource<span style=color:#f92672>.</span><span style=color:#a6e22e>getResourceClass</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> Z <span style=color:#a6e22e>get</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> resource<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getSize</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> resource<span style=color:#f92672>.</span><span style=color:#a6e22e>getSize</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>recycle</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>acquired <span style=color:#f92672>&gt;</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Cannot recycle a resource while it is still acquired&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isRecycled<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Cannot recycle a resource that has already been recycled&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    isRecycled <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isRecyclable<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      resource<span style=color:#f92672>.</span><span style=color:#a6e22e>recycle</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>acquire</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isRecycled<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Cannot acquire a recycled resource&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>++</span>acquired<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>release</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> release <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>acquired <span style=color:#f92672>&lt;=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Cannot release a recycled or not yet acquired resource&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(--</span>acquired <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        release <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>release<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      listener<span style=color:#f92672>.</span><span style=color:#a6e22e>onResourceReleased</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到，acquire() 方法内部会对一个整型变量 acquired 进行自增操作，这个变量表示该资源被引用的次数，当它大于 0 的时候表示图片正在使用中。相应地，在 release() 方法内部会 acquired 进行自减，并且当变量为 0 的时候，表示没有被任何地方引用，这时会调用 listener.onResourceReleased(key, this) 通知监听器资源已被释放，从而进行后续操作。</p><p>acquire() 和 release() 方法在一般情况下外部是不能主动调用的，只有 Glide 框架会在合适的时机下会调用这两个方法。</p><p>前面介绍活动资源的时候已经提到过，EngineResource.ResourceListener 唯一实现类为 Engine，来看它的实现内容：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onResourceReleased</span><span style=color:#f92672>(</span>Key cacheKey<span style=color:#f92672>,</span> EngineResource<span style=color:#f92672>&lt;?&gt;</span> resource<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//从 ActiveResource 中删除
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  activeResources<span style=color:#f92672>.</span><span style=color:#a6e22e>deactivate</span><span style=color:#f92672>(</span>cacheKey<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>resource<span style=color:#f92672>.</span><span style=color:#a6e22e>isMemoryCacheable</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//如果开启了缓存则放入 MemoryCache 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    cache<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>cacheKey<span style=color:#f92672>,</span> resource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    resourceRecycler<span style=color:#f92672>.</span><span style=color:#a6e22e>recycle</span><span style=color:#f92672>(</span>resource<span style=color:#f92672>,</span> <span style=color:#75715e>/*forceNextFrame=*/</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>首先会将缓存图片从活动资源中移除，然后再将它存入 MemoryCache 中。回到刚刚分析的 Engine.load 方法中，再看一次获取 ActiveResource 和 MemoryCache 的方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> EngineResource<span style=color:#f92672>&lt;?&gt;</span> loadFromActiveResources<span style=color:#f92672>(</span>Key key<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  EngineResource<span style=color:#f92672>&lt;?&gt;</span> active <span style=color:#f92672>=</span> activeResources<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>active <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    active<span style=color:#f92672>.</span><span style=color:#a6e22e>acquire</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> active<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> EngineResource<span style=color:#f92672>&lt;?&gt;</span> loadFromCache<span style=color:#f92672>(</span>Key key<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//从 MemoryCache 中移除
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  EngineResource<span style=color:#f92672>&lt;?&gt;</span> cached <span style=color:#f92672>=</span> getEngineResourceFromCache<span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>cached <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    cached<span style=color:#f92672>.</span><span style=color:#a6e22e>acquire</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//放入 ActiveResource 中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    activeResources<span style=color:#f92672>.</span><span style=color:#a6e22e>activate</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> cached<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> cached<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>除了从根据 Key 获取到 EngineResource 之外，中间还调用了 active.acquire() 方法。只要命中了缓存，那么该资源的引用计数就会加一。而且，如果命中的是 MemoryCache，那么此资源会被移动到 ActiveResource 中。</p><p>结合刚才的分析过程可知，EngineResource 在 ActiveResource 和 MemoryCache 中是互斥存在的。正在使用中的图片使用弱引用（ActiveResource）来进行缓存，不在使用中和被 GC 回收的图片使用 LruCahce（MemoryCache） 来进行缓存。</p><h3 id=磁盘缓存>磁盘缓存
<a class=anchor href=#%e7%a3%81%e7%9b%98%e7%bc%93%e5%ad%98>#</a></h3><h4 id=decocejob>DecoceJob
<a class=anchor href=#decocejob>#</a></h4><p>回到 Engine.load() 方法中，如果是首次加载资源，那么 ActiveResouce 和 MemoryCache 中必然没有缓存下来，接着会走 waitForExistingOrStartNewJob() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#f92672>&lt;</span>R<span style=color:#f92672>&gt;</span> LoadStatus <span style=color:#a6e22e>waitForExistingOrStartNewJob</span><span style=color:#f92672>(...)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  EngineJob<span style=color:#f92672>&lt;</span>R<span style=color:#f92672>&gt;</span> engineJob <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      engineJobFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>          key<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>          isMemoryCacheable<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>          useUnlimitedSourceExecutorPool<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>          useAnimationPool<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>          onlyRetrieveFromCache<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  DecodeJob<span style=color:#f92672>&lt;</span>R<span style=color:#f92672>&gt;</span> decodeJob <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      decodeJobFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>(...);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  jobs<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> engineJob<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  engineJob<span style=color:#f92672>.</span><span style=color:#a6e22e>addCallback</span><span style=color:#f92672>(</span>cb<span style=color:#f92672>,</span> callbackExecutor<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  engineJob<span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>(</span>decodeJob<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>VERBOSE_IS_LOGGABLE<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    logWithTimeAndKey<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Started new load&#34;</span><span style=color:#f92672>,</span> startTime<span style=color:#f92672>,</span> key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> LoadStatus<span style=color:#f92672>(</span>cb<span style=color:#f92672>,</span> engineJob<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>DecoceJob 实现了 Runnable 接口，然后会被 EngineJob.start() 方法提交到对应的线程池中去执行，查看 DecoceJob.run() 方法的调用栈：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>.</span>    
</span></span><span style=display:flex><span>    runWrapped<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Throwable t<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>.</span>    
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>runWrapped</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>runReason<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> INITIALIZE<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      stage <span style=color:#f92672>=</span> getNextStage<span style=color:#f92672>(</span>Stage<span style=color:#f92672>.</span><span style=color:#a6e22e>INITIALIZE</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      currentGenerator <span style=color:#f92672>=</span> getNextGenerator<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      runGenerators<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> SWITCH_TO_SOURCE_SERVICE<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      runGenerators<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> DECODE_DATA<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      decodeFromRetrievedData<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Unrecognized run reason: &#34;</span> <span style=color:#f92672>+</span> runReason<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> Stage <span style=color:#a6e22e>getNextStage</span><span style=color:#f92672>(</span>Stage current<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>current<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> INITIALIZE<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> diskCacheStrategy<span style=color:#f92672>.</span><span style=color:#a6e22e>decodeCachedResource</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>?</span> Stage<span style=color:#f92672>.</span><span style=color:#a6e22e>RESOURCE_CACHE</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>:</span> getNextStage<span style=color:#f92672>(</span>Stage<span style=color:#f92672>.</span><span style=color:#a6e22e>RESOURCE_CACHE</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> RESOURCE_CACHE<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> diskCacheStrategy<span style=color:#f92672>.</span><span style=color:#a6e22e>decodeCachedData</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>?</span> Stage<span style=color:#f92672>.</span><span style=color:#a6e22e>DATA_CACHE</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>:</span> getNextStage<span style=color:#f92672>(</span>Stage<span style=color:#f92672>.</span><span style=color:#a6e22e>DATA_CACHE</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> DATA_CACHE<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Skip loading from source if the user opted to only retrieve the resource from cache.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>return</span> onlyRetrieveFromCache <span style=color:#f92672>?</span> Stage<span style=color:#f92672>.</span><span style=color:#a6e22e>FINISHED</span> <span style=color:#f92672>:</span> Stage<span style=color:#f92672>.</span><span style=color:#a6e22e>SOURCE</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> SOURCE<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> FINISHED<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> Stage<span style=color:#f92672>.</span><span style=color:#a6e22e>FINISHED</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Unrecognized stage: &#34;</span> <span style=color:#f92672>+</span> current<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> DataFetcherGenerator <span style=color:#a6e22e>getNextGenerator</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>stage<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> RESOURCE_CACHE<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ResourceCacheGenerator<span style=color:#f92672>(</span>decodeHelper<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> DATA_CACHE<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> DataCacheGenerator<span style=color:#f92672>(</span>decodeHelper<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> SOURCE<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> SourceGenerator<span style=color:#f92672>(</span>decodeHelper<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> FINISHED<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Unrecognized stage: &#34;</span> <span style=color:#f92672>+</span> stage<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>runGenerators</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  currentThread <span style=color:#f92672>=</span> Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  startFetchTime <span style=color:#f92672>=</span> LogTime<span style=color:#f92672>.</span><span style=color:#a6e22e>getLogTime</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>boolean</span> isStarted <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> <span style=color:#f92672>(!</span>isCancelled
</span></span><span style=display:flex><span>      <span style=color:#f92672>&amp;&amp;</span> currentGenerator <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!(</span>isStarted <span style=color:#f92672>=</span> currentGenerator<span style=color:#f92672>.</span><span style=color:#a6e22e>startNext</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    stage <span style=color:#f92672>=</span> getNextStage<span style=color:#f92672>(</span>stage<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    currentGenerator <span style=color:#f92672>=</span> getNextGenerator<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>stage <span style=color:#f92672>==</span> Stage<span style=color:#f92672>.</span><span style=color:#a6e22e>SOURCE</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      reschedule<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// We&#39;ve run out of stages and generators, give up.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>stage <span style=color:#f92672>==</span> Stage<span style=color:#f92672>.</span><span style=color:#a6e22e>FINISHED</span> <span style=color:#f92672>||</span> isCancelled<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>isStarted<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    notifyFailed<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Otherwise a generator started a new load and we expect to be called back in
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// onDataFetcherReady.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>DecoceJob.run() 中主要调用了 runWrapped() 方法。在此方法中，首次加载时 runReason 为初始化即 RunReason.INITIALIZE 状态 ，又 diskCacheStrategy 默认为 DiskCacheStrategy.AUTOMATIC，且没有设置过 onlyRetrieveFromCache(true)。所以， decode data 的状态依次为 INITIALIZE -> RESOURCE_CACHE -> DATA_CACHE -> SOURCE -> FINISHED。对应的 DataFectcherGenerator 的 list 依次为 ResourceCacheGenerator -> DataCacheGenerator -> SourceGenerator。</p><p>在 runGenerators() 方法中会依次调用各个状态生成的 DataFetcherGenerator 的 startNext() 方法尝试 fetch 数据，直到有某个状态的 DataFetcherGenerator.startNext() 方法可以胜任。若状态抵达到了 Stage.FINISHED 或 Job 被取消，且所有状态的 DataFetcherGenerator.startNext() 都无法满足条件，则调用 SingleRequest.onLoadFailed() 进行错误处理。</p><p>这里总共有三个 DataFetcherGenerator，依次是：</p><ol><li><strong>ResourceCacheGenerator</strong>：获取采样后、transformed 后资源文件的缓存文件</li><li><strong>DataCacheGenerator</strong>：获取原始的没有修改过的资源文件的缓存文件</li><li><strong>SourceGenerator</strong>：获取原始源数据，即从网络下载或者从本地资源中加载</li></ol><h4 id=resourcecachekey-和-datacachekey>ResourceCacheKey 和 DataCacheKey
<a class=anchor href=#resourcecachekey-%e5%92%8c-datacachekey>#</a></h4><p>看以看到，ResourceCacheGenerator 和 DataCacheGenerator 分别对应 Resource 和 Data 类型的缓存数据，都属于磁盘缓存的一部分，那么这两种数据的存取规则有什么区别呢？</p><p>先看看 ResourceCacheGenerator 中查找缓存时 key 的组成部分：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>currentKey <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>new</span> ResourceCacheKey<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        helper<span style=color:#f92672>.</span><span style=color:#a6e22e>getArrayPool</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>        sourceId<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        helper<span style=color:#f92672>.</span><span style=color:#a6e22e>getSignature</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>        helper<span style=color:#f92672>.</span><span style=color:#a6e22e>getWidth</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>        helper<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeight</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>        transformation<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        resourceClass<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        helper<span style=color:#f92672>.</span><span style=color:#a6e22e>getOptions</span><span style=color:#f92672>());</span>
</span></span></code></pre></div><p>它的各个参数含义如下：</p><table><thead><tr><th>参数</th><th>含义</th></tr></thead><tbody><tr><td>helper.getArrayPool()</td><td>GlideBuilder.build 时初始化，默认为 LruArrayPool；但不参与 key 的 equals 方法</td></tr><tr><td>sourceId</td><td>如果请求的是 URL，那么此处会是一个 GlideUrl</td></tr><tr><td>helper.getSignature()</td><td>BaseRequestOptions 的成员变量，默认会是 EmptySignature.obtain()<br>在加载本地 resource 资源时会变成 ApplicationVersionSignature.obtain(context)</td></tr><tr><td>helper.getWidth()<br>helper.getHeight()</td><td>如果没有指定 override(int size)，那么将得到 view 的 size</td></tr><tr><td>transformation</td><td>默认会根据 ImageView 的 scaleType 设置对应的 BitmapTransformation；<br>如果指定了 transform，那就是指定的值</td></tr><tr><td>resourceClass</td><td>可以被编码成的资源类型，比如 BitmapDrawable 等</td></tr><tr><td>helper.getOptions()</td><td>如果没有设置过 transform，此处会根据 ImageView 的 scaleType 默认指定一个 KV</td></tr></tbody></table><p>在 ResourceCacheKey 中，arrayPool 并没有参与 equals 方法，所以判断两个 ResourceCacheKey 是否相等只需要其他 7 个参数。</p><p>然后看看 DataCacheGenerator 中 Key 的组成部分：</p><p>Key originalKey = new DataCacheKey(sourceId, helper.getSignature());</p><p>它的各个参数含义如下：</p><table><thead><tr><th>参数</th><th>含义</th></tr></thead><tbody><tr><td>sourceId</td><td>如果请求的是 URL，那么此处会是一个 GlideUrl</td></tr><tr><td>helper.getSignature()</td><td>BaseRequestOptions 的成员变量，默认会是 EmptySignature.obtain()<br>在加载本地 resource 资源时会变成 ApplicationVersionSignature.obtain(context)</td></tr></tbody></table><p>在 DataCacheKey 中，仅有的两个变量都参与了 equals 方法。这两个变量就是上面 ResourceCacheKey 中的两个变量。</p><p>显然，Data Cache 就是比较原始的数据构成的缓存，而 Resource Cache 是被解码、转换后的 Data Cache，与前面的分析呼应起来了。</p><h4 id=resourcecachegenerator>ResourceCacheGenerator
<a class=anchor href=#resourcecachegenerator>#</a></h4><p>先来看 ResourceCacheGenerator 的 startNext() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>startNext</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>modelLoaders <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>hasNextModelLoader<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>   currentKey <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>new</span> ResourceCacheKey<span style=color:#f92672>(</span><span style=color:#75715e>// NOPMD AvoidInstantiatingObjectsInLoops
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>           helper<span style=color:#f92672>.</span><span style=color:#a6e22e>getArrayPool</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>           sourceId<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>           helper<span style=color:#f92672>.</span><span style=color:#a6e22e>getSignature</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>           helper<span style=color:#f92672>.</span><span style=color:#a6e22e>getWidth</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>           helper<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeight</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>           transformation<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>           resourceClass<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>           helper<span style=color:#f92672>.</span><span style=color:#a6e22e>getOptions</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>   <span style=color:#75715e>//根据 ResourceCacheKey 获取缓存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   cacheFile <span style=color:#f92672>=</span> helper<span style=color:#f92672>.</span><span style=color:#a6e22e>getDiskCache</span><span style=color:#f92672>().</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>currentKey<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>   <span style=color:#75715e>//如果找到了缓存文件，那么循环条件则会为 false，也就退出循环了
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>cacheFile <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>     sourceKey <span style=color:#f92672>=</span> sourceId<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>     modelLoaders <span style=color:#f92672>=</span> helper<span style=color:#f92672>.</span><span style=color:#a6e22e>getModelLoaders</span><span style=color:#f92672>(</span>cacheFile<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>     modelLoaderIndex <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span> <span style=color:#75715e>// 如果找到了，hasNextModelLoader() 方法则会为 true，可以执行循环
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#75715e>// 没有找到缓存文件，则不会进入循环，会直接返回 false
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> loadData <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>boolean</span> started <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>while</span> <span style=color:#f92672>(!</span>started <span style=color:#f92672>&amp;&amp;</span> hasNextModelLoader<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   ModelLoader<span style=color:#f92672>&lt;</span>File<span style=color:#f92672>,</span> <span style=color:#f92672>?&gt;</span> modelLoader <span style=color:#f92672>=</span> modelLoaders<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>modelLoaderIndex<span style=color:#f92672>++);</span>
</span></span><span style=display:flex><span>   <span style=color:#75715e>// 在循环中会依次判断某个 ModelLoader 能不能加载此文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   loadData <span style=color:#f92672>=</span> modelLoader<span style=color:#f92672>.</span><span style=color:#a6e22e>buildLoadData</span><span style=color:#f92672>(</span>cacheFile<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>       helper<span style=color:#f92672>.</span><span style=color:#a6e22e>getWidth</span><span style=color:#f92672>(),</span> helper<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeight</span><span style=color:#f92672>(),</span> helper<span style=color:#f92672>.</span><span style=color:#a6e22e>getOptions</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>loadData <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> helper<span style=color:#f92672>.</span><span style=color:#a6e22e>hasLoadPath</span><span style=color:#f92672>(</span>loadData<span style=color:#f92672>.</span><span style=color:#a6e22e>fetcher</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getDataClass</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>     started <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>// 如果某个 ModelLoader 可以，那么就调用其 fetcher 进行加载数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>     <span style=color:#75715e>// 加载成功或失败会通知自身
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>     loadData<span style=color:#f92672>.</span><span style=color:#a6e22e>fetcher</span><span style=color:#f92672>.</span><span style=color:#a6e22e>loadData</span><span style=color:#f92672>(</span>helper<span style=color:#f92672>.</span><span style=color:#a6e22e>getPriority</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>return</span> started<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>获取缓存的那行代码 helper.getDiskCache().get(currentKey) 将会调用到 DiskLruCacheWrapper.get 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> File <span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>Key key<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//生成一个 String 类型的 SafeKey
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  String safeKey <span style=color:#f92672>=</span> safeKeyGenerator<span style=color:#f92672>.</span><span style=color:#a6e22e>getSafeKey</span><span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Log<span style=color:#f92672>.</span><span style=color:#a6e22e>isLoggable</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> Log<span style=color:#f92672>.</span><span style=color:#a6e22e>VERBOSE</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Log<span style=color:#f92672>.</span><span style=color:#a6e22e>v</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Get: Obtained: &#34;</span> <span style=color:#f92672>+</span> safeKey <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; for for Key: &#34;</span> <span style=color:#f92672>+</span> key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  File result <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//真正去获取磁盘文件缓存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>final</span> DiskLruCache<span style=color:#f92672>.</span><span style=color:#a6e22e>Value</span> value <span style=color:#f92672>=</span> getDiskCache<span style=color:#f92672>().</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>safeKey<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>value <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      result <span style=color:#f92672>=</span> value<span style=color:#f92672>.</span><span style=color:#a6e22e>getFile</span><span style=color:#f92672>(</span>0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Log<span style=color:#f92672>.</span><span style=color:#a6e22e>isLoggable</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> Log<span style=color:#f92672>.</span><span style=color:#a6e22e>WARN</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      Log<span style=color:#f92672>.</span><span style=color:#a6e22e>w</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Unable to get from disk cache&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>首先会使用 Key 映射成一个 String 类型的 safeKey，接着根据这个 safeKey 从 DiskCache 中获取缓存。</p><p>回到 ResourceCacheGenerator 中，如果确实有缓存，那么会加载该缓存文件。对于 URL 来说，调用了 ByteBufferFetcher 进行缓存文件的加载，加载成功了返回了一个 ByteBuffer，并调用了 callback 也 就是 ResourceCacheGenerator 的 onDataReady 方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onDataReady</span><span style=color:#f92672>(</span>Object data<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  cb<span style=color:#f92672>.</span><span style=color:#a6e22e>onDataFetcherReady</span><span style=color:#f92672>(</span>sourceKey<span style=color:#f92672>,</span> data<span style=color:#f92672>,</span> loadData<span style=color:#f92672>.</span><span style=color:#a6e22e>fetcher</span><span style=color:#f92672>,</span> DataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>RESOURCE_DISK_CACHE</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      currentKey<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>然后 ResourceCacheGenerator 又会回调 DecodeJob 的 onDataFetcherReady 方法进行后续的解码操作。</p><p>如果没有在 ResourceCacheGenerator 中被 fetch，则会回调 onLoadFailed() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onLoadFailed</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  cb<span style=color:#f92672>.</span><span style=color:#a6e22e>onDataFetcherFailed</span><span style=color:#f92672>(</span>currentKey<span style=color:#f92672>,</span> e<span style=color:#f92672>,</span> loadData<span style=color:#f92672>.</span><span style=color:#a6e22e>fetcher</span><span style=color:#f92672>,</span> DataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>RESOURCE_DISK_CACHE</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>后面 DataCacheGenerator 和 SourceGenerator 的成功回调都会到这里来。</p><p>接着回调到 DecodeJob 中继续执行 runGenerators() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onDataFetcherFailed</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    Key attemptedKey<span style=color:#f92672>,</span> Exception e<span style=color:#f92672>,</span> DataFetcher<span style=color:#f92672>&lt;?&gt;</span> fetcher<span style=color:#f92672>,</span> DataSource dataSource<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  fetcher<span style=color:#f92672>.</span><span style=color:#a6e22e>cleanup</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  GlideException exception <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> GlideException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Fetching data failed&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  exception<span style=color:#f92672>.</span><span style=color:#a6e22e>setLoggingDetails</span><span style=color:#f92672>(</span>attemptedKey<span style=color:#f92672>,</span> dataSource<span style=color:#f92672>,</span> fetcher<span style=color:#f92672>.</span><span style=color:#a6e22e>getDataClass</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  throwables<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>exception<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> currentThread<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    runReason <span style=color:#f92672>=</span> RunReason<span style=color:#f92672>.</span><span style=color:#a6e22e>SWITCH_TO_SOURCE_SERVICE</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    callback<span style=color:#f92672>.</span><span style=color:#a6e22e>reschedule</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    runGenerators<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=datacachegenerator>DataCacheGenerator
<a class=anchor href=#datacachegenerator>#</a></h4><p>DecodeJob.runGenerators 方法中，继续执行 while 循环将会调用 DataCacheGenerator 的 startNext() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>startNext</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>modelLoaders <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>hasNextModelLoader<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    sourceIdIndex<span style=color:#f92672>++;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>sourceIdIndex <span style=color:#f92672>&gt;=</span> cacheKeys<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    Key sourceId <span style=color:#f92672>=</span> cacheKeys<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>sourceIdIndex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// PMD.AvoidInstantiatingObjectsInLoops The loop iterates a limited number of times
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// and the actions it performs are much more expensive than a single allocation.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;PMD.AvoidInstantiatingObjectsInLoops&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    Key originalKey <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DataCacheKey<span style=color:#f92672>(</span>sourceId<span style=color:#f92672>,</span> helper<span style=color:#f92672>.</span><span style=color:#a6e22e>getSignature</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    cacheFile <span style=color:#f92672>=</span> helper<span style=color:#f92672>.</span><span style=color:#a6e22e>getDiskCache</span><span style=color:#f92672>().</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>originalKey<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>cacheFile <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sourceKey</span> <span style=color:#f92672>=</span> sourceId<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      modelLoaders <span style=color:#f92672>=</span> helper<span style=color:#f92672>.</span><span style=color:#a6e22e>getModelLoaders</span><span style=color:#f92672>(</span>cacheFile<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      modelLoaderIndex <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  loadData <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>boolean</span> started <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> <span style=color:#f92672>(!</span>started <span style=color:#f92672>&amp;&amp;</span> hasNextModelLoader<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    ModelLoader<span style=color:#f92672>&lt;</span>File<span style=color:#f92672>,</span> <span style=color:#f92672>?&gt;</span> modelLoader <span style=color:#f92672>=</span> modelLoaders<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>modelLoaderIndex<span style=color:#f92672>++);</span>
</span></span><span style=display:flex><span>    loadData <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        modelLoader<span style=color:#f92672>.</span><span style=color:#a6e22e>buildLoadData</span><span style=color:#f92672>(</span>cacheFile<span style=color:#f92672>,</span> helper<span style=color:#f92672>.</span><span style=color:#a6e22e>getWidth</span><span style=color:#f92672>(),</span> helper<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeight</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>            helper<span style=color:#f92672>.</span><span style=color:#a6e22e>getOptions</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>loadData <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> helper<span style=color:#f92672>.</span><span style=color:#a6e22e>hasLoadPath</span><span style=color:#f92672>(</span>loadData<span style=color:#f92672>.</span><span style=color:#a6e22e>fetcher</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getDataClass</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      started <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      loadData<span style=color:#f92672>.</span><span style=color:#a6e22e>fetcher</span><span style=color:#f92672>.</span><span style=color:#a6e22e>loadData</span><span style=color:#f92672>(</span>helper<span style=color:#f92672>.</span><span style=color:#a6e22e>getPriority</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> started<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>hasNextModelLoader</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> modelLoaderIndex <span style=color:#f92672>&lt;</span> modelLoaders<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>过程和 ResourceCacheGenerator 相似，由于获取的是原始的源数据，所以这里的 key 的组成非常简单。</p><h4 id=sourcegenerator>SourceGenerator
<a class=anchor href=#sourcegenerator>#</a></h4><p>由于是第一次加载，本地缓存文件肯定是没有的，接着会调用 SourceGenerator 的 startNext() 方法从网络或者本地资源中加载。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> loadDataListIndex<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>startNext</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 首次运行 dataToCache 为 null
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>dataToCache <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Object data <span style=color:#f92672>=</span> dataToCache<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    dataToCache <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    cacheData<span style=color:#f92672>(</span>data<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 首次运行 sourceCacheGenerator 为 null
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>sourceCacheGenerator <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> sourceCacheGenerator<span style=color:#f92672>.</span><span style=color:#a6e22e>startNext</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  sourceCacheGenerator <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 准备加载数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  loadData <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>boolean</span> started <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 这里直接调用了 DecodeHelper.getLoadData() 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// 该方法在前面在 ResourceCacheGenerator 中被调用过，且被缓存了下来
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>while</span> <span style=color:#f92672>(!</span>started <span style=color:#f92672>&amp;&amp;</span> hasNextModelLoader<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    loadData <span style=color:#f92672>=</span> helper<span style=color:#f92672>.</span><span style=color:#a6e22e>getLoadData</span><span style=color:#f92672>().</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>loadDataListIndex<span style=color:#f92672>++);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>loadData <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>(</span>helper<span style=color:#f92672>.</span><span style=color:#a6e22e>getDiskCacheStrategy</span><span style=color:#f92672>().</span><span style=color:#a6e22e>isDataCacheable</span><span style=color:#f92672>(</span>loadData<span style=color:#f92672>.</span><span style=color:#a6e22e>fetcher</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getDataSource</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>||</span> helper<span style=color:#f92672>.</span><span style=color:#a6e22e>hasLoadPath</span><span style=color:#f92672>(</span>loadData<span style=color:#f92672>.</span><span style=color:#a6e22e>fetcher</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getDataClass</span><span style=color:#f92672>())))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      started <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>//调用 MultiFetcher.loadData，然后用 this 接收回调
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      loadData<span style=color:#f92672>.</span><span style=color:#a6e22e>fetcher</span><span style=color:#f92672>.</span><span style=color:#a6e22e>loadData</span><span style=color:#f92672>(</span>helper<span style=color:#f92672>.</span><span style=color:#a6e22e>getPriority</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> started<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>hasNextModelLoader</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> loadDataListIndex <span style=color:#f92672>&lt;</span> helper<span style=color:#f92672>.</span><span style=color:#a6e22e>getLoadData</span><span style=color:#f92672>().</span><span style=color:#a6e22e>size</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>helper.getLoadData() 的值在 ResourceCacheGenerator 中就已经被获取并缓存下来了，这是一个 MultiModelLoader 对象生成的 LoadData 对象，LoadData 对象里面有两个 fetcher。</p><p>在上面的方法中，会遍历 LoadData list，找出符合条件的 LoadData，然后调用 loadData.fetcher.loadData 加载数据。</p><p>在 loadData 不为空的前提下，会判断 Glide 的缓存策略是否可以缓存此数据源，或者是否有加载路径。默认情况下 Glide 的缓存策略是 DiskCacheStrategy.AUTOMATIC，它的 isDataCacheable 实现如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isDataCacheable</span><span style=color:#f92672>(</span>DataSource dataSource<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//DataSource.REMOTE 代表网络资源
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>return</span> dataSource <span style=color:#f92672>==</span> DataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>REMOTE</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>再看下 loadData.fetcher.getDataSource()：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MultiFetcher</span><span style=color:#f92672>&lt;</span>Data<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>implements</span> DataFetcher<span style=color:#f92672>&lt;</span>Data<span style=color:#f92672>&gt;,</span> DataCallback<span style=color:#f92672>&lt;</span>Data<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> DataSource <span style=color:#a6e22e>getDataSource</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//fetchers 数组保存的两个 DataFetcher 都是 HttpUrlFetcher
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> fetchers<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>0<span style=color:#f92672>).</span><span style=color:#a6e22e>getDataSource</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HttpUrlFetcher</span> <span style=color:#66d9ef>implements</span> DataFetcher<span style=color:#f92672>&lt;</span>InputStream<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> DataSource <span style=color:#a6e22e>getDataSource</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> DataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>REMOTE</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>显然，Glide 的缓存策略是可以缓存此数据源的，所以会进行数据加载。接着看看 MultiFetcher.loadData 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MultiFetcher</span><span style=color:#f92672>&lt;</span>Data<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>implements</span> DataFetcher<span style=color:#f92672>&lt;</span>Data<span style=color:#f92672>&gt;,</span> DataCallback<span style=color:#f92672>&lt;</span>Data<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> List<span style=color:#f92672>&lt;</span>DataFetcher<span style=color:#f92672>&lt;</span>Data<span style=color:#f92672>&gt;&gt;</span> fetchers<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> currentIndex<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> Priority priority<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> DataCallback<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>super</span> Data<span style=color:#f92672>&gt;</span> callback<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>loadData</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>@NonNull</span> Priority priority<span style=color:#f92672>,</span> <span style=color:#a6e22e>@NonNull</span> DataCallback<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>super</span> Data<span style=color:#f92672>&gt;</span> callback<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>priority</span> <span style=color:#f92672>=</span> priority<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>callback</span> <span style=color:#f92672>=</span> callback<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    exceptions <span style=color:#f92672>=</span> throwableListPool<span style=color:#f92672>.</span><span style=color:#a6e22e>acquire</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    fetchers<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>currentIndex<span style=color:#f92672>).</span><span style=color:#a6e22e>loadData</span><span style=color:#f92672>(</span>priority<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// If a race occurred where we cancelled the fetcher in cancel() and then called loadData here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// immediately after, make sure that we cancel the newly started fetcher. We don&#39;t bother
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// checking cancelled before loadData because it&#39;s not required for correctness and would
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// require an unlikely race to be useful.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isCancelled<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      cancel<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onDataReady</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@Nullable</span> Data data<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>data <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      callback<span style=color:#f92672>.</span><span style=color:#a6e22e>onDataReady</span><span style=color:#f92672>(</span>data<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      startNextOrFail<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onLoadFailed</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Preconditions<span style=color:#f92672>.</span><span style=color:#a6e22e>checkNotNull</span><span style=color:#f92672>(</span>exceptions<span style=color:#f92672>).</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    startNextOrFail<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>startNextOrFail</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isCancelled<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>currentIndex <span style=color:#f92672>&lt;</span> fetchers<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>()</span> <span style=color:#f92672>-</span> 1<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      currentIndex<span style=color:#f92672>++;</span>
</span></span><span style=display:flex><span>      loadData<span style=color:#f92672>(</span>priority<span style=color:#f92672>,</span> callback<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      Preconditions<span style=color:#f92672>.</span><span style=color:#a6e22e>checkNotNull</span><span style=color:#f92672>(</span>exceptions<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      callback<span style=color:#f92672>.</span><span style=color:#a6e22e>onLoadFailed</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> GlideException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Fetch failed&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;(</span>exceptions<span style=color:#f92672>)));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这里面两个 DataFetcher 都是参数相同的 HttpUrlFetcher 实例，我们直接看里面如何从网络加载图片的。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>loadData</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Priority priority<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NonNull</span> DataCallback<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>super</span> InputStream<span style=color:#f92672>&gt;</span> callback<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>long</span> startTime <span style=color:#f92672>=</span> LogTime<span style=color:#f92672>.</span><span style=color:#a6e22e>getLogTime</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//获取 InputStream 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    InputStream result <span style=color:#f92672>=</span> loadDataWithRedirects<span style=color:#f92672>(</span>glideUrl<span style=color:#f92672>.</span><span style=color:#a6e22e>toURL</span><span style=color:#f92672>(),</span> 0<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> glideUrl<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeaders</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//将结果回调给 MultiFetcher
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    callback<span style=color:#f92672>.</span><span style=color:#a6e22e>onDataReady</span><span style=color:#f92672>(</span>result<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Log<span style=color:#f92672>.</span><span style=color:#a6e22e>isLoggable</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> Log<span style=color:#f92672>.</span><span style=color:#a6e22e>DEBUG</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      Log<span style=color:#f92672>.</span><span style=color:#a6e22e>d</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Failed to load data for url&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    callback<span style=color:#f92672>.</span><span style=color:#a6e22e>onLoadFailed</span><span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Log<span style=color:#f92672>.</span><span style=color:#a6e22e>isLoggable</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> Log<span style=color:#f92672>.</span><span style=color:#a6e22e>VERBOSE</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      Log<span style=color:#f92672>.</span><span style=color:#a6e22e>v</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Finished http url fetcher fetch in &#34;</span> <span style=color:#f92672>+</span> LogTime<span style=color:#f92672>.</span><span style=color:#a6e22e>getElapsedMillis</span><span style=color:#f92672>(</span>startTime<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这里将请求操作放到了 loadDataWithRedirects() 方法中，然后将请求结果通过回调返回上一层也就是 MultiFetcher.onDataReady() 中。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> InputStream <span style=color:#a6e22e>loadDataWithRedirects</span><span style=color:#f92672>(</span>URL url<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> redirects<span style=color:#f92672>,</span> URL lastUrl<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> headers<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 检查重定向次数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>redirects <span style=color:#f92672>&gt;=</span> MAXIMUM_REDIRECTS<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> HttpException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Too many (&gt; &#34;</span> <span style=color:#f92672>+</span> MAXIMUM_REDIRECTS <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;) redirects!&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Comparing the URLs using .equals performs additional network I/O and is generally broken.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// See http://michaelscharf.blogspot.com/2006/11/javaneturlequals-and-hashcode-make.html.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 检查是不是重定向到自身了
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>lastUrl <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> url<span style=color:#f92672>.</span><span style=color:#a6e22e>toURI</span><span style=color:#f92672>().</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>lastUrl<span style=color:#f92672>.</span><span style=color:#a6e22e>toURI</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> HttpException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;In re-direct loop&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>URISyntaxException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Do nothing, this is best effort.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// connectionFactory默认是DefaultHttpUrlConnectionFactory
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// 其build方法就是调用了url.openConnection()
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  urlConnection <span style=color:#f92672>=</span> connectionFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>(</span>url<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Map<span style=color:#f92672>.</span><span style=color:#a6e22e>Entry</span><span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> headerEntry <span style=color:#f92672>:</span> headers<span style=color:#f92672>.</span><span style=color:#a6e22e>entrySet</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    urlConnection<span style=color:#f92672>.</span><span style=color:#a6e22e>addRequestProperty</span><span style=color:#f92672>(</span>headerEntry<span style=color:#f92672>.</span><span style=color:#a6e22e>getKey</span><span style=color:#f92672>(),</span> headerEntry<span style=color:#f92672>.</span><span style=color:#a6e22e>getValue</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  urlConnection<span style=color:#f92672>.</span><span style=color:#a6e22e>setConnectTimeout</span><span style=color:#f92672>(</span>timeout<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  urlConnection<span style=color:#f92672>.</span><span style=color:#a6e22e>setReadTimeout</span><span style=color:#f92672>(</span>timeout<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  urlConnection<span style=color:#f92672>.</span><span style=color:#a6e22e>setUseCaches</span><span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  urlConnection<span style=color:#f92672>.</span><span style=color:#a6e22e>setDoInput</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Stop the urlConnection instance of HttpUrlConnection from following redirects so that
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// redirects will be handled by recursive calls to this method, loadDataWithRedirects.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// 禁止HttpUrlConnection自动重定向，重定向功能由本方法自己实现
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  urlConnection<span style=color:#f92672>.</span><span style=color:#a6e22e>setInstanceFollowRedirects</span><span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Connect explicitly to avoid errors in decoders if connection fails.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  urlConnection<span style=color:#f92672>.</span><span style=color:#a6e22e>connect</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Set the stream so that it&#39;s closed in cleanup to avoid resource leaks. See #2352.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  stream <span style=color:#f92672>=</span> urlConnection<span style=color:#f92672>.</span><span style=color:#a6e22e>getInputStream</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isCancelled<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> statusCode <span style=color:#f92672>=</span> urlConnection<span style=color:#f92672>.</span><span style=color:#a6e22e>getResponseCode</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isHttpOk<span style=color:#f92672>(</span>statusCode<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// statusCode=2xx，请求成功
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> getStreamForSuccessfulRequest<span style=color:#f92672>(</span>urlConnection<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isHttpRedirect<span style=color:#f92672>(</span>statusCode<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// statusCode=3xx，需要重定向
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    String redirectUrlString <span style=color:#f92672>=</span> urlConnection<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeaderField</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Location&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>TextUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>(</span>redirectUrlString<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> HttpException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Received empty or null redirect url&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    URL redirectUrl <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> URL<span style=color:#f92672>(</span>url<span style=color:#f92672>,</span> redirectUrlString<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Closing the stream specifically is required to avoid leaking ResponseBodys in addition
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// to disconnecting the url connection below. See #2352.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    cleanup<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> loadDataWithRedirects<span style=color:#f92672>(</span>redirectUrl<span style=color:#f92672>,</span> redirects <span style=color:#f92672>+</span> 1<span style=color:#f92672>,</span> url<span style=color:#f92672>,</span> headers<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>statusCode <span style=color:#f92672>==</span> INVALID_STATUS_CODE<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// -1 表示不是HTTP响应
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> HttpException<span style=color:#f92672>(</span>statusCode<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 其他HTTP错误
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> HttpException<span style=color:#f92672>(</span>urlConnection<span style=color:#f92672>.</span><span style=color:#a6e22e>getResponseMessage</span><span style=color:#f92672>(),</span> statusCode<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>到这一步已经获得网络图片的 InputStream 了，该资源会通过回调经过 MultiFetcher 然后再次回调到 SourceGenerator 中。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onDataReady</span><span style=color:#f92672>(</span>Object data<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  DiskCacheStrategy diskCacheStrategy <span style=color:#f92672>=</span> helper<span style=color:#f92672>.</span><span style=color:#a6e22e>getDiskCacheStrategy</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>data <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> diskCacheStrategy<span style=color:#f92672>.</span><span style=color:#a6e22e>isDataCacheable</span><span style=color:#f92672>(</span>loadData<span style=color:#f92672>.</span><span style=color:#a6e22e>fetcher</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getDataSource</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    dataToCache <span style=color:#f92672>=</span> data<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// We might be being called back on someone else&#39;s thread. Before doing anything, we should
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// reschedule to get back onto Glide&#39;s thread.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    cb<span style=color:#f92672>.</span><span style=color:#a6e22e>reschedule</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    cb<span style=color:#f92672>.</span><span style=color:#a6e22e>onDataFetcherReady</span><span style=color:#f92672>(</span>loadData<span style=color:#f92672>.</span><span style=color:#a6e22e>sourceKey</span><span style=color:#f92672>,</span> data<span style=color:#f92672>,</span> loadData<span style=color:#f92672>.</span><span style=color:#a6e22e>fetcher</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        loadData<span style=color:#f92672>.</span><span style=color:#a6e22e>fetcher</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getDataSource</span><span style=color:#f92672>(),</span> originalKey<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onLoadFailed</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  cb<span style=color:#f92672>.</span><span style=color:#a6e22e>onDataFetcherFailed</span><span style=color:#f92672>(</span>originalKey<span style=color:#f92672>,</span> e<span style=color:#f92672>,</span> loadData<span style=color:#f92672>.</span><span style=color:#a6e22e>fetcher</span><span style=color:#f92672>,</span> loadData<span style=color:#f92672>.</span><span style=color:#a6e22e>fetcher</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getDataSource</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>onLoadFailed() 方法很简单，直接回调 DecodeJob.onDataFetcherFailed 方法。onDataReady() 方法会首先判 data 能不能缓存，若能缓存则缓存起来，然后调用 DataCacheGenerator 进行加载缓存；若不能缓存，则直接回调 DecodeJob.onDataFetcherReady() 方法通知外界 data 已经准备好了。</p><p>获取 DiskCacheStrategy 并判断能不能被缓存的逻辑在 SourceGenerator.startNext() 中出现过，之类显然是可以的。然后将 data 保存到 dataToCache，并调用 cb.reschedule()。</p><p>cb.reschedule() 的作用就是将 DecodeJob 提交到 Glide 的 source 线程池中。然后执行 DecodeJob.run() 方法，经过 runWrapped()、 runGenerators() 方法后，又回到了 SourceGenerator.startNext() 方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>startNext</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//首先判断是否有数据待缓存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>dataToCache <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Object data <span style=color:#f92672>=</span> dataToCache<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    dataToCache <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    cacheData<span style=color:#f92672>(</span>data<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e>//刚刚构建了一个 DataCacheGenerator，这里不为空
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>//调用 startNext() 后返回 true
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>sourceCacheGenerator <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> sourceCacheGenerator<span style=color:#f92672>.</span><span style=color:#a6e22e>startNext</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>cacheData</span><span style=color:#f92672>(</span>Object dataToCache<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>long</span> startTime <span style=color:#f92672>=</span> LogTime<span style=color:#f92672>.</span><span style=color:#a6e22e>getLogTime</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Encoder<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> encoder <span style=color:#f92672>=</span> helper<span style=color:#f92672>.</span><span style=color:#a6e22e>getSourceEncoder</span><span style=color:#f92672>(</span>dataToCache<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    DataCacheWriter<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> writer <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> DataCacheWriter<span style=color:#f92672>&lt;&gt;(</span>encoder<span style=color:#f92672>,</span> dataToCache<span style=color:#f92672>,</span> helper<span style=color:#f92672>.</span><span style=color:#a6e22e>getOptions</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    originalKey <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DataCacheKey<span style=color:#f92672>(</span>loadData<span style=color:#f92672>.</span><span style=color:#a6e22e>sourceKey</span><span style=color:#f92672>,</span> helper<span style=color:#f92672>.</span><span style=color:#a6e22e>getSignature</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//缓存 data
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    helper<span style=color:#f92672>.</span><span style=color:#a6e22e>getDiskCache</span><span style=color:#f92672>().</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>originalKey<span style=color:#f92672>,</span> writer<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Log<span style=color:#f92672>.</span><span style=color:#a6e22e>isLoggable</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> Log<span style=color:#f92672>.</span><span style=color:#a6e22e>VERBOSE</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      Log<span style=color:#f92672>.</span><span style=color:#a6e22e>v</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Finished encoding source to cache&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;, key: &#34;</span> <span style=color:#f92672>+</span> originalKey
</span></span><span style=display:flex><span>          <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;, data: &#34;</span> <span style=color:#f92672>+</span> dataToCache
</span></span><span style=display:flex><span>          <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;, encoder: &#34;</span> <span style=color:#f92672>+</span> encoder
</span></span><span style=display:flex><span>          <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;, duration: &#34;</span> <span style=color:#f92672>+</span> LogTime<span style=color:#f92672>.</span><span style=color:#a6e22e>getElapsedMillis</span><span style=color:#f92672>(</span>startTime<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    loadData<span style=color:#f92672>.</span><span style=color:#a6e22e>fetcher</span><span style=color:#f92672>.</span><span style=color:#a6e22e>cleanup</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//构建一个 DataCacheGenerator，传入 this 作为回调
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  sourceCacheGenerator <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>new</span> DataCacheGenerator<span style=color:#f92672>(</span>Collections<span style=color:#f92672>.</span><span style=color:#a6e22e>singletonList</span><span style=color:#f92672>(</span>loadData<span style=color:#f92672>.</span><span style=color:#a6e22e>sourceKey</span><span style=color:#f92672>),</span> helper<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>在 startNext() 方法的开头，会判断 dataToCache 是否为空，此时显然不为空，所以会调用 cacheData(Object) 方法进行 data 的缓存处理。缓存完毕后，会为该缓存文件生成一个 SourceCacheGenerator。然后在 startNext() 方法中会直接调用该变量进行加载。</p><p>由于在构造 DataCacheGenerator 时，指定了 FetcherReadyCallback 为 this，所以这时 DataCacheGenerator 加载结果会由 SourceGenerator 转发给 DecodeJob。</p><h4 id=decodejobfetcherreadycallback>DecodeJob.FetcherReadyCallback
<a class=anchor href=#decodejobfetcherreadycallback>#</a></h4><p>先看一下 fetch 失败时干了什么，DecodeJob.onDataFetcherFailed() 方法的实现代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onDataFetcherFailed</span><span style=color:#f92672>(</span>Key attemptedKey<span style=color:#f92672>,</span> Exception e<span style=color:#f92672>,</span> DataFetcher<span style=color:#f92672>&lt;?&gt;</span> fetcher<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    DataSource dataSource<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  fetcher<span style=color:#f92672>.</span><span style=color:#a6e22e>cleanup</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  GlideException exception <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> GlideException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Fetching data failed&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  exception<span style=color:#f92672>.</span><span style=color:#a6e22e>setLoggingDetails</span><span style=color:#f92672>(</span>attemptedKey<span style=color:#f92672>,</span> dataSource<span style=color:#f92672>,</span> fetcher<span style=color:#f92672>.</span><span style=color:#a6e22e>getDataClass</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  throwables<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>exception<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> currentThread<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    runReason <span style=color:#f92672>=</span> RunReason<span style=color:#f92672>.</span><span style=color:#a6e22e>SWITCH_TO_SOURCE_SERVICE</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    callback<span style=color:#f92672>.</span><span style=color:#a6e22e>reschedule</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    runGenerators<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>显然，如果 fetch 失败了，如果不在 source 线程中就会回调 EnginJob 的 reschedule() 方法切换到 source 线程，然后重新调用 runGenerators() 方法尝试使用下一个 DataFetcherGenerator 进行加载，一直到没有一个可以加载，这时会调用 notifyFailed() 方法，正式宣告加载失败。</p><p>然后再看成功的时候回调的 onDataFetcherReady() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onDataFetcherReady</span><span style=color:#f92672>(</span>Key sourceKey<span style=color:#f92672>,</span> Object data<span style=color:#f92672>,</span> DataFetcher<span style=color:#f92672>&lt;?&gt;</span> fetcher<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    DataSource dataSource<span style=color:#f92672>,</span> Key attemptedKey<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>currentSourceKey</span> <span style=color:#f92672>=</span> sourceKey<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>currentData</span> <span style=color:#f92672>=</span> data<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>currentFetcher</span> <span style=color:#f92672>=</span> fetcher<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>currentDataSource</span> <span style=color:#f92672>=</span> dataSource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>currentAttemptingKey</span> <span style=color:#f92672>=</span> attemptedKey<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//判断当前线程是否为 currentThread
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> currentThread<span style=color:#f92672>)</span> 
</span></span><span style=display:flex><span>    runReason <span style=color:#f92672>=</span> RunReason<span style=color:#f92672>.</span><span style=color:#a6e22e>DECODE_DATA</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//如果不是，则让 EngineJob 重新调度，最后也会调用 decodeFromRetrievedData
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    callback<span style=color:#f92672>.</span><span style=color:#a6e22e>reschedule</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    GlideTrace<span style=color:#f92672>.</span><span style=color:#a6e22e>beginSection</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;DecodeJob.decodeFromRetrievedData&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      decodeFromRetrievedData<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      GlideTrace<span style=color:#f92672>.</span><span style=color:#a6e22e>endSection</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>首先会保存传入的参数，然后确认执行线程后调用 decodeFromRetrievedData() 方法进行解码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>decodeFromRetrievedData</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Log<span style=color:#f92672>.</span><span style=color:#a6e22e>isLoggable</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> Log<span style=color:#f92672>.</span><span style=color:#a6e22e>VERBOSE</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    logWithTimeAndKey<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Retrieved data&#34;</span><span style=color:#f92672>,</span> startFetchTime<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;data: &#34;</span> <span style=color:#f92672>+</span> currentData
</span></span><span style=display:flex><span>            <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;, cache key: &#34;</span> <span style=color:#f92672>+</span> currentSourceKey
</span></span><span style=display:flex><span>            <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;, fetcher: &#34;</span> <span style=color:#f92672>+</span> currentFetcher<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  Resource<span style=color:#f92672>&lt;</span>R<span style=color:#f92672>&gt;</span> resource <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    resource <span style=color:#f92672>=</span> decodeFromData<span style=color:#f92672>(</span>currentFetcher<span style=color:#f92672>,</span> currentData<span style=color:#f92672>,</span> currentDataSource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>GlideException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    e<span style=color:#f92672>.</span><span style=color:#a6e22e>setLoggingDetails</span><span style=color:#f92672>(</span>currentAttemptingKey<span style=color:#f92672>,</span> currentDataSource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    throwables<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>resource <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    notifyEncodeAndRelease<span style=color:#f92672>(</span>resource<span style=color:#f92672>,</span> currentDataSource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    runGenerators<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>先调用 decodeFromData() 方法进行解码，然后调用 notifyEncodeAndRelease() 方法进行缓存，同时也会通知 EngineJob 资源已经准备好了。</p><p>decodeFromData() 方法调用栈如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#f92672>&lt;</span>Data<span style=color:#f92672>&gt;</span> Resource<span style=color:#f92672>&lt;</span>R<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>decodeFromData</span><span style=color:#f92672>(</span>DataFetcher<span style=color:#f92672>&lt;?&gt;</span> fetcher<span style=color:#f92672>,</span> Data data<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    DataSource dataSource<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> GlideException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>data <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>long</span> startTime <span style=color:#f92672>=</span> LogTime<span style=color:#f92672>.</span><span style=color:#a6e22e>getLogTime</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    Resource<span style=color:#f92672>&lt;</span>R<span style=color:#f92672>&gt;</span> result <span style=color:#f92672>=</span> decodeFromFetcher<span style=color:#f92672>(</span>data<span style=color:#f92672>,</span> dataSource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Log<span style=color:#f92672>.</span><span style=color:#a6e22e>isLoggable</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> Log<span style=color:#f92672>.</span><span style=color:#a6e22e>VERBOSE</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      logWithTimeAndKey<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Decoded result &#34;</span> <span style=color:#f92672>+</span> result<span style=color:#f92672>,</span> startTime<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    fetcher<span style=color:#f92672>.</span><span style=color:#a6e22e>cleanup</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;unchecked&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#f92672>&lt;</span>Data<span style=color:#f92672>&gt;</span> Resource<span style=color:#f92672>&lt;</span>R<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>decodeFromFetcher</span><span style=color:#f92672>(</span>Data data<span style=color:#f92672>,</span> DataSource dataSource<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throws</span> GlideException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  LoadPath<span style=color:#f92672>&lt;</span>Data<span style=color:#f92672>,</span> <span style=color:#f92672>?,</span> R<span style=color:#f92672>&gt;</span> path <span style=color:#f92672>=</span> decodeHelper<span style=color:#f92672>.</span><span style=color:#a6e22e>getLoadPath</span><span style=color:#f92672>((</span>Class<span style=color:#f92672>&lt;</span>Data<span style=color:#f92672>&gt;)</span> data<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> runLoadPath<span style=color:#f92672>(</span>data<span style=color:#f92672>,</span> dataSource<span style=color:#f92672>,</span> path<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#f92672>&lt;</span>Data<span style=color:#f92672>,</span> ResourceType<span style=color:#f92672>&gt;</span> Resource<span style=color:#f92672>&lt;</span>R<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>runLoadPath</span><span style=color:#f92672>(</span>Data data<span style=color:#f92672>,</span> DataSource dataSource<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    LoadPath<span style=color:#f92672>&lt;</span>Data<span style=color:#f92672>,</span> ResourceType<span style=color:#f92672>,</span> R<span style=color:#f92672>&gt;</span> path<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> GlideException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  Options options <span style=color:#f92672>=</span> getOptionsWithHardwareConfig<span style=color:#f92672>(</span>dataSource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  DataRewinder<span style=color:#f92672>&lt;</span>Data<span style=color:#f92672>&gt;</span> rewinder <span style=color:#f92672>=</span> glideContext<span style=color:#f92672>.</span><span style=color:#a6e22e>getRegistry</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getRewinder</span><span style=color:#f92672>(</span>data<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ResourceType in DecodeCallback below is required for compilation to work with gradle.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> path<span style=color:#f92672>.</span><span style=color:#a6e22e>load</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        rewinder<span style=color:#f92672>,</span> options<span style=color:#f92672>,</span> width<span style=color:#f92672>,</span> height<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> DecodeCallback<span style=color:#f92672>&lt;</span>ResourceType<span style=color:#f92672>&gt;(</span>dataSource<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    rewinder<span style=color:#f92672>.</span><span style=color:#a6e22e>cleanup</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><code>path.load(..., new DecodeCallback&lt;ResourceType>(dataSource))</code> 这行代码中，最后传入了一个 DecodeCallback 回调，该类的回调方法会回调给 DecodeJob 对应的方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DecodeCallback</span><span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>implements</span> DecodePath<span style=color:#f92672>.</span><span style=color:#a6e22e>DecodeCallback</span><span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> DataSource dataSource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Synthetic</span>
</span></span><span style=display:flex><span>  DecodeCallback<span style=color:#f92672>(</span>DataSource dataSource<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>dataSource</span> <span style=color:#f92672>=</span> dataSource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> Resource<span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>onResourceDecoded</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Resource<span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> decoded<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> DecodeJob<span style=color:#f92672>.</span><span style=color:#a6e22e>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>onResourceDecoded</span><span style=color:#f92672>(</span>dataSource<span style=color:#f92672>,</span> decoded<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>然后来看一下 LoadPath.load() 方法的实现：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> Resource<span style=color:#f92672>&lt;</span>Transcode<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>load</span><span style=color:#f92672>(</span>DataRewinder<span style=color:#f92672>&lt;</span>Data<span style=color:#f92672>&gt;</span> rewinder<span style=color:#f92672>,</span> <span style=color:#a6e22e>@NonNull</span> Options options<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> width<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> height<span style=color:#f92672>,</span> DecodePath<span style=color:#f92672>.</span><span style=color:#a6e22e>DecodeCallback</span><span style=color:#f92672>&lt;</span>ResourceType<span style=color:#f92672>&gt;</span> decodeCallback<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> GlideException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  List<span style=color:#f92672>&lt;</span>Throwable<span style=color:#f92672>&gt;</span> throwables <span style=color:#f92672>=</span> Preconditions<span style=color:#f92672>.</span><span style=color:#a6e22e>checkNotNull</span><span style=color:#f92672>(</span>listPool<span style=color:#f92672>.</span><span style=color:#a6e22e>acquire</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> loadWithExceptionList<span style=color:#f92672>(</span>rewinder<span style=color:#f92672>,</span> options<span style=color:#f92672>,</span> width<span style=color:#f92672>,</span> height<span style=color:#f92672>,</span> decodeCallback<span style=color:#f92672>,</span> throwables<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    listPool<span style=color:#f92672>.</span><span style=color:#a6e22e>release</span><span style=color:#f92672>(</span>throwables<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> Resource<span style=color:#f92672>&lt;</span>Transcode<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>loadWithExceptionList</span><span style=color:#f92672>(</span>DataRewinder<span style=color:#f92672>&lt;</span>Data<span style=color:#f92672>&gt;</span> rewinder<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NonNull</span> Options options<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> width<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> height<span style=color:#f92672>,</span> DecodePath<span style=color:#f92672>.</span><span style=color:#a6e22e>DecodeCallback</span><span style=color:#f92672>&lt;</span>ResourceType<span style=color:#f92672>&gt;</span> decodeCallback<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>Throwable<span style=color:#f92672>&gt;</span> exceptions<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> GlideException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  Resource<span style=color:#f92672>&lt;</span>Transcode<span style=color:#f92672>&gt;</span> result <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//noinspection ForLoopReplaceableByForEach to improve perf
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>,</span> size <span style=color:#f92672>=</span> decodePaths<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>();</span> i <span style=color:#f92672>&lt;</span> size<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    DecodePath<span style=color:#f92672>&lt;</span>Data<span style=color:#f92672>,</span> ResourceType<span style=color:#f92672>,</span> Transcode<span style=color:#f92672>&gt;</span> path <span style=color:#f92672>=</span> decodePaths<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>i<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      result <span style=color:#f92672>=</span> path<span style=color:#f92672>.</span><span style=color:#a6e22e>decode</span><span style=color:#f92672>(</span>rewinder<span style=color:#f92672>,</span> width<span style=color:#f92672>,</span> height<span style=color:#f92672>,</span> options<span style=color:#f92672>,</span> decodeCallback<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>GlideException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      exceptions<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>result <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>result <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> GlideException<span style=color:#f92672>(</span>failureMessage<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;(</span>exceptions<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>对于每条 DecodePath，都调用其 decode() 方法，直到有一个 DecodePath 可以 decode 出资源。继续看看 DecodePath.decode() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> Resource<span style=color:#f92672>&lt;</span>Transcode<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>decode</span><span style=color:#f92672>(</span>DataRewinder<span style=color:#f92672>&lt;</span>DataType<span style=color:#f92672>&gt;</span> rewinder<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> width<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> height<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NonNull</span> Options options<span style=color:#f92672>,</span> DecodeCallback<span style=color:#f92672>&lt;</span>ResourceType<span style=color:#f92672>&gt;</span> callback<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> GlideException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  Resource<span style=color:#f92672>&lt;</span>ResourceType<span style=color:#f92672>&gt;</span> decoded <span style=color:#f92672>=</span> decodeResource<span style=color:#f92672>(</span>rewinder<span style=color:#f92672>,</span> width<span style=color:#f92672>,</span> height<span style=color:#f92672>,</span> options<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  Resource<span style=color:#f92672>&lt;</span>ResourceType<span style=color:#f92672>&gt;</span> transformed <span style=color:#f92672>=</span> callback<span style=color:#f92672>.</span><span style=color:#a6e22e>onResourceDecoded</span><span style=color:#f92672>(</span>decoded<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> transcoder<span style=color:#f92672>.</span><span style=color:#a6e22e>transcode</span><span style=color:#f92672>(</span>transformed<span style=color:#f92672>,</span> options<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到，这里有三个步骤：</p><ol><li>使用 ResourceDecoder List 进行 decode，将原始数据解码成原始图片</li><li>将 decoded 的资源进行 transform</li><li>将 transformed 的资源进行 transcode</li></ol><p>首先是 decodeResource() 的过程：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> Resource<span style=color:#f92672>&lt;</span>ResourceType<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>decodeResource</span><span style=color:#f92672>(</span>DataRewinder<span style=color:#f92672>&lt;</span>DataType<span style=color:#f92672>&gt;</span> rewinder<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> width<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> height<span style=color:#f92672>,</span> <span style=color:#a6e22e>@NonNull</span> Options options<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> GlideException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  List<span style=color:#f92672>&lt;</span>Throwable<span style=color:#f92672>&gt;</span> exceptions <span style=color:#f92672>=</span> Preconditions<span style=color:#f92672>.</span><span style=color:#a6e22e>checkNotNull</span><span style=color:#f92672>(</span>listPool<span style=color:#f92672>.</span><span style=color:#a6e22e>acquire</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> decodeResourceWithList<span style=color:#f92672>(</span>rewinder<span style=color:#f92672>,</span> width<span style=color:#f92672>,</span> height<span style=color:#f92672>,</span> options<span style=color:#f92672>,</span> exceptions<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    listPool<span style=color:#f92672>.</span><span style=color:#a6e22e>release</span><span style=color:#f92672>(</span>exceptions<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> Resource<span style=color:#f92672>&lt;</span>ResourceType<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>decodeResourceWithList</span><span style=color:#f92672>(</span>DataRewinder<span style=color:#f92672>&lt;</span>DataType<span style=color:#f92672>&gt;</span> rewinder<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> width<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> height<span style=color:#f92672>,</span> <span style=color:#a6e22e>@NonNull</span> Options options<span style=color:#f92672>,</span> List<span style=color:#f92672>&lt;</span>Throwable<span style=color:#f92672>&gt;</span> exceptions<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> GlideException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  Resource<span style=color:#f92672>&lt;</span>ResourceType<span style=color:#f92672>&gt;</span> result <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//noinspection ForLoopReplaceableByForEach to improve perf
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>,</span> size <span style=color:#f92672>=</span> decoders<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>();</span> i <span style=color:#f92672>&lt;</span> size<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//decoders 只有一条，就是 ByteBufferBitmapDecoder
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    ResourceDecoder<span style=color:#f92672>&lt;</span>DataType<span style=color:#f92672>,</span> ResourceType<span style=color:#f92672>&gt;</span> decoder <span style=color:#f92672>=</span> decoders<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>i<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>//rewinder 自然是 ByteBufferRewind
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>//data 为 ByteBuffer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      DataType data <span style=color:#f92672>=</span> rewinder<span style=color:#f92672>.</span><span style=color:#a6e22e>rewindAndGet</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>//ByteBufferBitmapDecoder 内部会调用 Downsampler 的 hanldes 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// 它对任意的 InputStream 和 ByteBuffer 都返回 true
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>decoder<span style=color:#f92672>.</span><span style=color:#a6e22e>handles</span><span style=color:#f92672>(</span>data<span style=color:#f92672>,</span> options<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//调用 ByteBuffer.position(0) 复位
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        data <span style=color:#f92672>=</span> rewinder<span style=color:#f92672>.</span><span style=color:#a6e22e>rewindAndGet</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//开始解码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        result <span style=color:#f92672>=</span> decoder<span style=color:#f92672>.</span><span style=color:#a6e22e>decode</span><span style=color:#f92672>(</span>data<span style=color:#f92672>,</span> width<span style=color:#f92672>,</span> height<span style=color:#f92672>,</span> options<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Some decoders throw unexpectedly. If they do, we shouldn&#39;t fail the entire load path, but
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// instead log and continue. See #2406 for an example.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException <span style=color:#f92672>|</span> RuntimeException <span style=color:#f92672>|</span> OutOfMemoryError e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Log<span style=color:#f92672>.</span><span style=color:#a6e22e>isLoggable</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> Log<span style=color:#f92672>.</span><span style=color:#a6e22e>VERBOSE</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Log<span style=color:#f92672>.</span><span style=color:#a6e22e>v</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Failed to decode data for &#34;</span> <span style=color:#f92672>+</span> decoder<span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      exceptions<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>result <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>result <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> GlideException<span style=color:#f92672>(</span>failureMessage<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;(</span>exceptions<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>ByteBufferBitmapDecoder<span style=color:#f92672>.</span><span style=color:#a6e22e>decode</span><span style=color:#f92672>()</span> 方法<span style=color:#960050;background-color:#1e0010>：</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Resource<span style=color:#f92672>&lt;</span>Bitmap<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>decode</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> ByteBuffer source<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> width<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> height<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NonNull</span> Options options<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  InputStream is <span style=color:#f92672>=</span> ByteBufferUtil<span style=color:#f92672>.</span><span style=color:#a6e22e>toStream</span><span style=color:#f92672>(</span>source<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> downsampler<span style=color:#f92672>.</span><span style=color:#a6e22e>decode</span><span style=color:#f92672>(</span>is<span style=color:#f92672>,</span> width<span style=color:#f92672>,</span> height<span style=color:#f92672>,</span> options<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>先将 ByteBuffer 转换成 InputStream，然后调用 Downsampler.decode() 方法进行解码。</p><p>这里执行完毕，会将 decode 出来的 Bitmap 包装成为一个 BitmapResource 对象。然后就一直往上返回，返回到 DecodePath.decode 方法中。接下来执行第二行：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Resource<span style=color:#f92672>&lt;</span>ResourceType<span style=color:#f92672>&gt;</span> transformed <span style=color:#f92672>=</span> callback<span style=color:#f92672>.</span><span style=color:#a6e22e>onResourceDecoded</span><span style=color:#f92672>(</span>decoded<span style=color:#f92672>);</span>
</span></span></code></pre></div><p>这里的 callback 在前面提到过，这会调用 <code>DecodeJob.onResourceDecoded(DataSource, Resource&lt;Z>)</code> 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Synthetic</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> Resource<span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>onResourceDecoded</span><span style=color:#f92672>(</span>DataSource dataSource<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NonNull</span> Resource<span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> decoded<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;unchecked&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  Class<span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> resourceSubClass <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;)</span> decoded<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>();</span><span style=color:#75715e>// Bitmap.class
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Transformation<span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> appliedTransformation <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  Resource<span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> transformed <span style=color:#f92672>=</span> decoded<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//dataSource为DATA_DISK_CACHE，所以满足条件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>dataSource <span style=color:#f92672>!=</span> DataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>RESOURCE_DISK_CACHE</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//Bitmap.class对应的正是FitCenter()
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    appliedTransformation <span style=color:#f92672>=</span> decodeHelper<span style=color:#f92672>.</span><span style=color:#a6e22e>getTransformation</span><span style=color:#f92672>(</span>resourceSubClass<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//对decoded资源进行transform
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    transformed <span style=color:#f92672>=</span> appliedTransformation<span style=color:#f92672>.</span><span style=color:#a6e22e>transform</span><span style=color:#f92672>(</span>glideContext<span style=color:#f92672>,</span> decoded<span style=color:#f92672>,</span> width<span style=color:#f92672>,</span> height<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//TODO: Make this the responsibility of the Transformation.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>decoded<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>transformed<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    decoded<span style=color:#f92672>.</span><span style=color:#a6e22e>recycle</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> EncodeStrategy encodeStrategy<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> ResourceEncoder<span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> encoder<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//Bitmap有注册对应的BitmapEncoder，所以是available的
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>decodeHelper<span style=color:#f92672>.</span><span style=color:#a6e22e>isResourceEncoderAvailable</span><span style=color:#f92672>(</span>transformed<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//encoder就是BitmapEncoder
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    encoder <span style=color:#f92672>=</span> decodeHelper<span style=color:#f92672>.</span><span style=color:#a6e22e>getResultEncoder</span><span style=color:#f92672>(</span>transformed<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//encodeStrategy为EncodeStrategy.TRANSFORMED
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    encodeStrategy <span style=color:#f92672>=</span> encoder<span style=color:#f92672>.</span><span style=color:#a6e22e>getEncodeStrategy</span><span style=color:#f92672>(</span>options<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    encoder <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    encodeStrategy <span style=color:#f92672>=</span> EncodeStrategy<span style=color:#f92672>.</span><span style=color:#a6e22e>NONE</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  Resource<span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> result <span style=color:#f92672>=</span> transformed<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//isSourceKey显然为true，所以isFromAlternateCacheKey为false，所以就返回了
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>boolean</span> isFromAlternateCacheKey <span style=color:#f92672>=</span> <span style=color:#f92672>!</span>decodeHelper<span style=color:#f92672>.</span><span style=color:#a6e22e>isSourceKey</span><span style=color:#f92672>(</span>currentSourceKey<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//diskCacheStrategy为AUTOMATIC，该方法返回false
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>diskCacheStrategy<span style=color:#f92672>.</span><span style=color:#a6e22e>isResourceCacheable</span><span style=color:#f92672>(</span>isFromAlternateCacheKey<span style=color:#f92672>,</span> dataSource<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      encodeStrategy<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>encoder <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Registry<span style=color:#f92672>.</span><span style=color:#a6e22e>NoResultEncoderAvailableException</span><span style=color:#f92672>(</span>transformed<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> Key key<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>encodeStrategy<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> SOURCE<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        key <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DataCacheKey<span style=color:#f92672>(</span>currentSourceKey<span style=color:#f92672>,</span> signature<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> TRANSFORMED<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        key <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> ResourceCacheKey<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                decodeHelper<span style=color:#f92672>.</span><span style=color:#a6e22e>getArrayPool</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>                currentSourceKey<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                signature<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                width<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                height<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                appliedTransformation<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                resourceSubClass<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                options<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Unknown strategy: &#34;</span> <span style=color:#f92672>+</span> encodeStrategy<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    LockedResource<span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> lockedResult <span style=color:#f92672>=</span> LockedResource<span style=color:#f92672>.</span><span style=color:#a6e22e>obtain</span><span style=color:#f92672>(</span>transformed<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    deferredEncodeManager<span style=color:#f92672>.</span><span style=color:#a6e22e>init</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> encoder<span style=color:#f92672>,</span> lockedResult<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> lockedResult<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>当 dataSource != DataSource.RESOURCE_DISK_CACHE 时会进行 transform，这是因为 resource cache 肯定已经经历过 transform 了，所以就不用重新来一遍了。</p><p>然后就回到 DecodePath.decode 方法的第三行了：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>return</span> transcoder<span style=color:#f92672>.</span><span style=color:#a6e22e>transcode</span><span style=color:#f92672>(</span>transformed<span style=color:#f92672>,</span> options<span style=color:#f92672>);</span>
</span></span></code></pre></div><p>这里的 transcoder 就是 BitmapDrawableTranscoder，该方法返回了一个 LazyBitmapDrawableResource。</p><p>至此，resource 已经 decode 完毕。下面一直返回到 DecodeJob.decodeFromRetrievedData() 方法中。下面会调用 notifyEncodeAndRelease() 方法完成后面的事宜。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>notifyEncodeAndRelease</span><span style=color:#f92672>(</span>Resource<span style=color:#f92672>&lt;</span>R<span style=color:#f92672>&gt;</span> resource<span style=color:#f92672>,</span> DataSource dataSource<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// resource是BitmapResource类型，实现了Initializable接口
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>resource <span style=color:#66d9ef>instanceof</span> Initializable<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// initialize方法调用了bitmap.prepareToDraw()
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>((</span>Initializable<span style=color:#f92672>)</span> resource<span style=color:#f92672>).</span><span style=color:#a6e22e>initialize</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  Resource<span style=color:#f92672>&lt;</span>R<span style=color:#f92672>&gt;</span> result <span style=color:#f92672>=</span> resource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  LockedResource<span style=color:#f92672>&lt;</span>R<span style=color:#f92672>&gt;</span> lockedResource <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>deferredEncodeManager<span style=color:#f92672>.</span><span style=color:#a6e22e>hasResourceToEncode</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    lockedResource <span style=color:#f92672>=</span> LockedResource<span style=color:#f92672>.</span><span style=color:#a6e22e>obtain</span><span style=color:#f92672>(</span>resource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> lockedResource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 通知回调，资源已经就绪
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  notifyComplete<span style=color:#f92672>(</span>result<span style=color:#f92672>,</span> dataSource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  stage <span style=color:#f92672>=</span> Stage<span style=color:#f92672>.</span><span style=color:#a6e22e>ENCODE</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// TODO
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>deferredEncodeManager<span style=color:#f92672>.</span><span style=color:#a6e22e>hasResourceToEncode</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      deferredEncodeManager<span style=color:#f92672>.</span><span style=color:#a6e22e>encode</span><span style=color:#f92672>(</span>diskCacheProvider<span style=color:#f92672>,</span> options<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// lockedResource为null, skip
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>lockedResource <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      lockedResource<span style=color:#f92672>.</span><span style=color:#a6e22e>unlock</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Call onEncodeComplete outside the finally block so that it&#39;s not called if the encode process
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// throws.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// 进行清理工作
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  onEncodeComplete<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>重点在于 notifyComplete() 方法，该方法内部会调用 callback.onResourceReady(resource, dataSource) 将结果传递给回调，这里的回调是 EngineJob：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onResourceReady</span><span style=color:#f92672>(</span>Resource<span style=color:#f92672>&lt;</span>R<span style=color:#f92672>&gt;</span> resource<span style=color:#f92672>,</span> DataSource dataSource<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>resource</span> <span style=color:#f92672>=</span> resource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>dataSource</span> <span style=color:#f92672>=</span> dataSource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  notifyCallbacksOfResult<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>notifyCallbacksOfResult</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  ResourceCallbacksAndExecutors copy<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  Key localKey<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  EngineResource<span style=color:#f92672>&lt;?&gt;</span> localResource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    stateVerifier<span style=color:#f92672>.</span><span style=color:#a6e22e>throwIfRecycled</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isCancelled<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// TODO: Seems like we might as well put this in the memory cache instead of just recycling
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// it since we&#39;ve gotten this far...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      resource<span style=color:#f92672>.</span><span style=color:#a6e22e>recycle</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      release<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>cbs<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Received a resource without any callbacks to notify&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>hasResource<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Already have resource&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// engineResourceFactory默认为EngineResourceFactory
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 其build方法就是new一个对应的资源
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// new EngineResource&lt;&gt;(resource, isMemoryCacheable, /*isRecyclable=*/ true)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    engineResource <span style=color:#f92672>=</span> engineResourceFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>(</span>resource<span style=color:#f92672>,</span> isCacheable<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Hold on to resource for duration of our callbacks below so we don&#39;t recycle it in the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// middle of notifying if it synchronously released by one of the callbacks. Acquire it under
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// a lock here so that any newly added callback that executes before the next locked section
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// below can&#39;t recycle the resource before we call the callbacks.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    hasResource <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    copy <span style=color:#f92672>=</span> cbs<span style=color:#f92672>.</span><span style=color:#a6e22e>copy</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    incrementPendingCallbacks<span style=color:#f92672>(</span>copy<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> 1<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    localKey <span style=color:#f92672>=</span> key<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    localResource <span style=color:#f92672>=</span> engineResource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// listener就是Engine，该方法会将资源保存到activeResources中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  listener<span style=color:#f92672>.</span><span style=color:#a6e22e>onEngineJobComplete</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> localKey<span style=color:#f92672>,</span> localResource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 这里的ResourceCallbackAndExecutor就是我创建EngineJob和DecodeJob
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// 并在执行DecodeJob之前添加的回调
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// entry.executor就是Glide.with.load.into中出现的Executors.mainThreadExecutor()
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// entry.cb就是SingleRequest
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> ResourceCallbackAndExecutor entry <span style=color:#f92672>:</span> copy<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    entry<span style=color:#f92672>.</span><span style=color:#a6e22e>executor</span><span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> CallResourceReady<span style=color:#f92672>(</span>entry<span style=color:#f92672>.</span><span style=color:#a6e22e>cb</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  decrementPendingCallbacks<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>listener.onEngineJobComplete() 的代码很简单。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onEngineJobComplete</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    EngineJob<span style=color:#f92672>&lt;?&gt;</span> engineJob<span style=color:#f92672>,</span> Key key<span style=color:#f92672>,</span> EngineResource<span style=color:#f92672>&lt;?&gt;</span> resource<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// A null resource indicates that the load failed, usually due to an exception.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>resource <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    resource<span style=color:#f92672>.</span><span style=color:#a6e22e>setResourceListener</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>resource<span style=color:#f92672>.</span><span style=color:#a6e22e>isCacheable</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      activeResources<span style=color:#f92672>.</span><span style=color:#a6e22e>activate</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> resource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  jobs<span style=color:#f92672>.</span><span style=color:#a6e22e>removeIfCurrent</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> engineJob<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onResourceReleased</span><span style=color:#f92672>(</span>Key cacheKey<span style=color:#f92672>,</span> EngineResource<span style=color:#f92672>&lt;?&gt;</span> resource<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  activeResources<span style=color:#f92672>.</span><span style=color:#a6e22e>deactivate</span><span style=color:#f92672>(</span>cacheKey<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>resource<span style=color:#f92672>.</span><span style=color:#a6e22e>isCacheable</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    cache<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>cacheKey<span style=color:#f92672>,</span> resource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    resourceRecycler<span style=color:#f92672>.</span><span style=color:#a6e22e>recycle</span><span style=color:#f92672>(</span>resource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>首先会设置资源的回调为自己，这样在资源释放时会通知自己的回调方法，将资源从 active 状态变为 cache 状态，如 onResourceReleased() 方法；然后将资源放入 activeResources 中，资源变为 active 状态；最后将 engineJob 从 Jobs 中移除。</p><p>然后看下 entry.executor.execute(new CallResourceReady(entry.cb)) 方法的实现，关注点在 CallResourceReady 上面：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CallResourceReady</span> <span style=color:#66d9ef>implements</span> Runnable <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ResourceCallback cb<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    CallResourceReady<span style=color:#f92672>(</span>ResourceCallback cb<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>cb</span> <span style=color:#f92672>=</span> cb<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span>EngineJob<span style=color:#f92672>.</span><span style=color:#a6e22e>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>cbs<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span>cb<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e>// Acquire for this particular callback.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          engineResource<span style=color:#f92672>.</span><span style=color:#a6e22e>acquire</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>          callCallbackOnResourceReady<span style=color:#f92672>(</span>cb<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          removeCallback<span style=color:#f92672>(</span>cb<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        decrementPendingCallbacks<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>首先调用 callCallbackOnResourceReady(cb) 调用 callback，然后调用 removeCallback(cb) 移除 callback。看看 callCallbackOnResourceReady(cb)：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>callCallbackOnResourceReady</span><span style=color:#f92672>(</span>ResourceCallback cb<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// This is overly broad, some Glide code is actually called here, but it&#39;s much
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// simpler to encapsulate here than to do so at the actual call point in the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Request implementation.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    cb<span style=color:#f92672>.</span><span style=color:#a6e22e>onResourceReady</span><span style=color:#f92672>(</span>engineResource<span style=color:#f92672>,</span> dataSource<span style=color:#f92672>,</span> isLoadedFromAlternateCacheKey<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Throwable t<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> CallbackException<span style=color:#f92672>(</span>t<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这里就调用了 cb.onResourceReady()，这里说到过 entry.cb 就是 SingleRequest。所以继续看看 SingleRequest.onResourceReady() 方法:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onResourceReady</span><span style=color:#f92672>(</span>Resource<span style=color:#f92672>&lt;?&gt;</span> resource<span style=color:#f92672>,</span> DataSource dataSource<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  onResourceReady<span style=color:#f92672>((</span>Resource<span style=color:#f92672>&lt;</span>R<span style=color:#f92672>&gt;)</span> resource<span style=color:#f92672>,</span> <span style=color:#f92672>(</span>R<span style=color:#f92672>)</span> received<span style=color:#f92672>,</span> dataSource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onResourceReady</span><span style=color:#f92672>(</span>Resource<span style=color:#f92672>&lt;</span>R<span style=color:#f92672>&gt;</span> resource<span style=color:#f92672>,</span> R result<span style=color:#f92672>,</span> DataSource dataSource<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// We must call isFirstReadyResource before setting status.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// 由于requestCoordinator为null，所以返回true
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>boolean</span> isFirstResource <span style=color:#f92672>=</span> isFirstReadyResource<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 将status状态设置为COMPLETE
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  status <span style=color:#f92672>=</span> Status<span style=color:#f92672>.</span><span style=color:#a6e22e>COMPLETE</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>resource</span> <span style=color:#f92672>=</span> resource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>glideContext<span style=color:#f92672>.</span><span style=color:#a6e22e>getLogLevel</span><span style=color:#f92672>()</span> <span style=color:#f92672>&lt;=</span> Log<span style=color:#f92672>.</span><span style=color:#a6e22e>DEBUG</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Log<span style=color:#f92672>.</span><span style=color:#a6e22e>d</span><span style=color:#f92672>(</span>GLIDE_TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Finished loading &#34;</span> <span style=color:#f92672>+</span> result<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getSimpleName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; from &#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>+</span> dataSource <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; for &#34;</span> <span style=color:#f92672>+</span> model <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; with size [&#34;</span> <span style=color:#f92672>+</span> width <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;x&#34;</span> <span style=color:#f92672>+</span> height <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;] in &#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>+</span> LogTime<span style=color:#f92672>.</span><span style=color:#a6e22e>getElapsedMillis</span><span style=color:#f92672>(</span>startTime<span style=color:#f92672>)</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; ms&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  isCallingCallbacks <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>// 尝试调用各个listener的onResourceReady回调进行处理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>boolean</span> anyListenerHandledUpdatingTarget <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>requestListeners <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>RequestListener<span style=color:#f92672>&lt;</span>R<span style=color:#f92672>&gt;</span> listener <span style=color:#f92672>:</span> requestListeners<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        anyListenerHandledUpdatingTarget <span style=color:#f92672>|=</span>
</span></span><span style=display:flex><span>            listener<span style=color:#f92672>.</span><span style=color:#a6e22e>onResourceReady</span><span style=color:#f92672>(</span>result<span style=color:#f92672>,</span> model<span style=color:#f92672>,</span> target<span style=color:#f92672>,</span> dataSource<span style=color:#f92672>,</span> isFirstResource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    anyListenerHandledUpdatingTarget <span style=color:#f92672>|=</span>
</span></span><span style=display:flex><span>        targetListener <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&amp;&amp;</span> targetListener<span style=color:#f92672>.</span><span style=color:#a6e22e>onResourceReady</span><span style=color:#f92672>(</span>result<span style=color:#f92672>,</span> model<span style=color:#f92672>,</span> target<span style=color:#f92672>,</span> dataSource<span style=color:#f92672>,</span> isFirstResource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果没有一个回调能够处理，那么自己处理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>anyListenerHandledUpdatingTarget<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// animationFactory默认为NoTransition.getFactory()，生成的animation为NO_ANIMATION
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      Transition<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>super</span> R<span style=color:#f92672>&gt;</span> animation <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>          animationFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>(</span>dataSource<span style=color:#f92672>,</span> isFirstResource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// target为DrawableImageViewTarget
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      target<span style=color:#f92672>.</span><span style=color:#a6e22e>onResourceReady</span><span style=color:#f92672>(</span>result<span style=color:#f92672>,</span> animation<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    isCallingCallbacks <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 通知requestCoordinator
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  notifyLoadSuccess<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>其处理过程和 onLoadFailed() 方法非常类似。</p><p>DrawableImageViewTarget 的基类 ImageViewTarget 实现了此方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// ImageViewTarget.java
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onResourceReady</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Z resource<span style=color:#f92672>,</span> <span style=color:#a6e22e>@Nullable</span> Transition<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>super</span> Z<span style=color:#f92672>&gt;</span> transition<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// NO_ANIMATION.transition返回false，所以直接调用setResourceInternal方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>transition <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>transition<span style=color:#f92672>.</span><span style=color:#a6e22e>transition</span><span style=color:#f92672>(</span>resource<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    setResourceInternal<span style=color:#f92672>(</span>resource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    maybeUpdateAnimatable<span style=color:#f92672>(</span>resource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setResourceInternal</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@Nullable</span> Z resource<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Order matters here. Set the resource first to make sure that the Drawable has a valid and
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// non-null Callback before starting it.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// 先设置图片
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  setResource<span style=color:#f92672>(</span>resource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 然后如果是动画，会执行动画
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  maybeUpdateAnimatable<span style=color:#f92672>(</span>resource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>maybeUpdateAnimatable</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@Nullable</span> Z resource<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// BitmapDrawable显然不是一个Animatable对象，所以走else分支
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>resource <span style=color:#66d9ef>instanceof</span> Animatable<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    animatable <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>Animatable<span style=color:#f92672>)</span> resource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    animatable<span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    animatable <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// DrawableImageViewTarget
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setResource</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@Nullable</span> Drawable resource<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  view<span style=color:#f92672>.</span><span style=color:#a6e22e>setImageDrawable</span><span style=color:#f92672>(</span>resource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>OK，至此网络图片已经通过 view.setImageDrawable(resource) 加载完毕。</p><p>最后，回到 DecodeJob.notifyEncodeAndRelease() 方法，notifyComplete() 被调用后，会判断 deferredEncodeManager.hasResourceToEncode()，如果为 true 则会调用 deferredEncodeManager.encode() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DeferredEncodeManager</span><span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> Key key<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> ResourceEncoder<span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> encoder<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> LockedResource<span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> toEncode<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Synthetic</span>
</span></span><span style=display:flex><span>  DeferredEncodeManager<span style=color:#f92672>()</span> <span style=color:#f92672>{</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e>// We just need the encoder and resource type to match, which this will enforce.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;unchecked&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;</span>X<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>init</span><span style=color:#f92672>(</span>Key key<span style=color:#f92672>,</span> ResourceEncoder<span style=color:#f92672>&lt;</span>X<span style=color:#f92672>&gt;</span> encoder<span style=color:#f92672>,</span> LockedResource<span style=color:#f92672>&lt;</span>X<span style=color:#f92672>&gt;</span> toEncode<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>key</span> <span style=color:#f92672>=</span> key<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>encoder</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>ResourceEncoder<span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;)</span> encoder<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>toEncode</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>LockedResource<span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;)</span> toEncode<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>encode</span><span style=color:#f92672>(</span>DiskCacheProvider diskCacheProvider<span style=color:#f92672>,</span> Options options<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    GlideTrace<span style=color:#f92672>.</span><span style=color:#a6e22e>beginSection</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;DecodeJob.encode&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      diskCacheProvider<span style=color:#f92672>.</span><span style=color:#a6e22e>getDiskCache</span><span style=color:#f92672>().</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>new</span> DataCacheWriter<span style=color:#f92672>&lt;&gt;(</span>encoder<span style=color:#f92672>,</span> toEncode<span style=color:#f92672>,</span> options<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      toEncode<span style=color:#f92672>.</span><span style=color:#a6e22e>unlock</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      GlideTrace<span style=color:#f92672>.</span><span style=color:#a6e22e>endSection</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>hasResourceToEncode</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> toEncode <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>clear</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    key <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    encoder <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    toEncode <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>DiskLruCacheWrapper 在写入的时候会使用到写锁 DiskCacheWriteLocker，锁对象由对象池创建，写锁 WriteLock 实现是一个重入锁 ReentrantLock，该锁默认是一个不公平锁。</p><p>在缓存写入前，会判断 key 对应的 value 存不存在，若存在则放弃写入。缓存的真正写入会由 DataCacheWriter 交给 ByteBufferEncoder 和 StreamEncoder 两个具体类来写入，前者负责将 ByteBuffe 写入到文件，后者负责将 InputStream 写入到文件。</p><p>至此，磁盘缓存的读写都已经完毕，剩下的就是内存缓存的两个层次了。回到 DecodeJob.notifyEncodeAndRelease 方法中，经过 notifyComplete、EngineJob.onResourceReady、notifyCallbacksOfResult 方法中。</p><p>在该方法中一方面会将原始的 resource 包装成一个 EngineResource，然后通过回调传给 Engine.onEngineJobComplete()，在这里会将资源保持在 ActiveResource 中：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onEngineJobComplete</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    EngineJob<span style=color:#f92672>&lt;?&gt;</span> engineJob<span style=color:#f92672>,</span> Key key<span style=color:#f92672>,</span> EngineResource<span style=color:#f92672>&lt;?&gt;</span> resource<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// A null resource indicates that the load failed, usually due to an exception.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>resource <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    resource<span style=color:#f92672>.</span><span style=color:#a6e22e>setResourceListener</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>resource<span style=color:#f92672>.</span><span style=color:#a6e22e>isCacheable</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      activeResources<span style=color:#f92672>.</span><span style=color:#a6e22e>activate</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> resource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  jobs<span style=color:#f92672>.</span><span style=color:#a6e22e>removeIfCurrent</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> engineJob<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>另一方面会使用 Executors.mainThreadExecutor() 调用 SingleRequest.onResourceReady() 回调进行资源的显示。</p><p>在触发回调前后各有一个地方会对 engineResource 进行 acquire() 和 release() 操作。该过程发生在 notifyCallbacksOfResult() 方法的 incrementPendingCallbacks()、decrementPendingCallbacks() 调用中。这一顿操作下来，engineResource 的引用计数应该是 1：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Synthetic</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>notifyCallbacksOfResult</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  ResourceCallbacksAndExecutors copy<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  Key localKey<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  EngineResource<span style=color:#f92672>&lt;?&gt;</span> localResource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    engineResource <span style=color:#f92672>=</span> engineResourceFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>(</span>resource<span style=color:#f92672>,</span> isCacheable<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Hold on to resource for duration of our callbacks below so we don&#39;t recycle it in the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// middle of notifying if it synchronously released by one of the callbacks. Acquire it under
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// a lock here so that any newly added callback that executes before the next locked section
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// below can&#39;t recycle the resource before we call the callbacks.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    hasResource <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    copy <span style=color:#f92672>=</span> cbs<span style=color:#f92672>.</span><span style=color:#a6e22e>copy</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    incrementPendingCallbacks<span style=color:#f92672>(</span>copy<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> 1<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    localKey <span style=color:#f92672>=</span> key<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    localResource <span style=color:#f92672>=</span> engineResource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  listener<span style=color:#f92672>.</span><span style=color:#a6e22e>onEngineJobComplete</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> localKey<span style=color:#f92672>,</span> localResource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> ResourceCallbackAndExecutor entry <span style=color:#f92672>:</span> copy<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    entry<span style=color:#f92672>.</span><span style=color:#a6e22e>executor</span><span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> CallResourceReady<span style=color:#f92672>(</span>entry<span style=color:#f92672>.</span><span style=color:#a6e22e>cb</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  decrementPendingCallbacks<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>incrementPendingCallbacks</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> count<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>pendingCallbacks<span style=color:#f92672>.</span><span style=color:#a6e22e>getAndAdd</span><span style=color:#f92672>(</span>count<span style=color:#f92672>)</span> <span style=color:#f92672>==</span> 0 <span style=color:#f92672>&amp;&amp;</span> engineResource <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    engineResource<span style=color:#f92672>.</span><span style=color:#a6e22e>acquire</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>decrementPendingCallbacks</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> decremented <span style=color:#f92672>=</span> pendingCallbacks<span style=color:#f92672>.</span><span style=color:#a6e22e>decrementAndGet</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>decremented <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>engineResource <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      engineResource<span style=color:#f92672>.</span><span style=color:#a6e22e>release</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    release<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>engineResource 的引用计数会在 RequestManager.onDestory() 方法中经过 clear()、untrackOrDelegate()、untrack()、RequestTracker.clearRemoveAndRecycle()、clearRemoveAndMaybeRecycle() 方法，调用 SingleRequest.clear() 方法经过 releaseResource()、Engine.release()，进行释放。这样引用计数就为 0 了。</p><p>前面在看 EngineResource 的代码时我们知道，一旦引用计数为 0，就会通知 Engine 将此资源从 active 状态变成 memory cache 状态。如果我们再次加载资源时可以从 memory cache 中加载，那么资源又会从 memory cache 状态变成 active 状态。</p><p>也就是说，在资源第一次显示后，我们关闭页面，资源会由 active 变成 memory cache；然后我们再次进入页面，加载时会命中 memory cache，从而又变成 active 状态。</p><p>本章 Glide 缓存机制的源码内容到此为止了，现在看看文章最开始的流程图，是不是有一点点熟悉的味道。</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-2/clipboard_20230323_034514.png width=auto alt></p><p>DecodeJob.onDataFetcherReady 该方法完成两个事情：</p><ol><li>将比较原始的 data 数据转变为可以供 ImageView 显示的 resource 数据</li><li>将 resource 数据显示出来</li></ol><p>在过程 1 中，将原始 data encode 成 resource 数据后，会调用 DecodeJob.onResourceDecoded 对 resource 数据进行进一步的处理。DecodeJob.onResourceDecoded 首先会对 resource 进行 transform，然后可能会进行磁盘缓存。</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-2/clipboard_20230323_034509.png width=auto alt></p><h1 id=面试题>面试题
<a class=anchor href=#%e9%9d%a2%e8%af%95%e9%a2%98>#</a></h1><p>内存缓存分两个原因：</p><p>1、活动缓存主要是当前正在使用的图片资源。图片资源存放在弱引用中。下面是只用活动缓存的缺点</p><p>场景：上下滑动列表，图片会不断创建，当 GC 来临时候，会将当前不使用的图片资源进行回收，由于存放在弱引用中。这样就会导致下次滑动回来还需要加载到内存中。</p><p>2、Lru 缓存主要存放：最近被加载过的资源。下面是只用 Lru 的缺点</p><p>场景：滑动列表头部头像不动，列表不断滑动，由于 Lru 的机制缓存到达一定大小，可能会将头部图片资源回收。</p><p>3、配合使用，两者互斥存在。当资源正在使用的时候放在活动缓存中，当不使用的时候放在 Lru 中（引用为 0 的时候）。so,两者结合性能最佳</p><p>磁盘缓存分两个原因：
1、资源缓存主要是变换后的资源
2、原始缓存是原始的资源文件</p><p>场景：同一张图片，先在 100<em>100 的 view 上显示，然后在 200</em>200 的 view 上显示。
分析：如果不缓存变换后的图，那么每次都需要变换。如果不缓存原图，那么每次都需要重新网络下载原图</p><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://guanpj.github.io/amethyst/quartz/js/graph.cbd78cfa87df7d3e230d16fc24f06548.js></script></div></div><div id=contact_buttons><footer><p>Made with <a href=https://github.com/64bitpandas/amethyst>Amethyst</a>, © 2023 guanpj</p><ul><li><a href=https://guanpj.github.io/amethyst/>Home</a></li><li><a href=https://bencuan.me>Website</a></li><li><a href=https://blog.bencuan.me>Blog</a></li></ul></footer></div></article><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#strong加载流程strong><strong>加载流程</strong></a><ul><li><a href=#with>with</a><ul><li><a href=#getretrievercontext>getRetriever(Context)</a></li><li><a href=#requestmanagerretrieverget>RequestManagerRetriever.get</a></li><li><a href=#小结>小结</a></li></ul></li><li><a href=#strongloadstrong><strong>load</strong></a><ul><li><a href=#requestmanagerasxx>RequestManager.asXx</a></li><li><a href=#requestbuilderload>RequestBuilder.load</a></li><li><a href=#小结-1>小结</a></li></ul></li><li><a href=#into>into</a></li><li><a href=#strong整体流程strong><strong>整体流程</strong></a></li></ul></li><li><a href=#strong缓存strong><strong>缓存</strong></a><ul><li><a href=#glide-缓存机制>Glide 缓存机制</a></li><li><a href=#strong配置缓存strong><strong>配置缓存</strong></a><ul><li><a href=#磁盘缓存策略>磁盘缓存策略</a></li><li><a href=#仅从缓存加载图片>仅从缓存加载图片</a></li><li><a href=#跳过缓存>跳过缓存</a></li></ul></li><li><a href=#活动资源-activeresource>活动资源 ActiveResource</a></li><li><a href=#内存缓存-memorycache>内存缓存 MemoryCache</a></li><li><a href=#strong磁盘缓存-diskcachestrong><strong>磁盘缓存 DiskCache</strong></a></li><li><a href=#缓存流程>缓存流程</a><ul><li><a href=#enginekey>EngineKey</a></li><li><a href=#内存缓存>内存缓存</a><ul><li><a href=#activeresource-和-memorycache>ActiveResource 和 MemoryCache</a></li></ul></li><li><a href=#磁盘缓存>磁盘缓存</a><ul><li><a href=#decocejob>DecoceJob</a></li><li><a href=#resourcecachekey-和-datacachekey>ResourceCacheKey 和 DataCacheKey</a></li><li><a href=#resourcecachegenerator>ResourceCacheGenerator</a></li><li><a href=#datacachegenerator>DataCacheGenerator</a></li><li><a href=#sourcegenerator>SourceGenerator</a></li><li><a href=#decodejobfetcherreadycallback>DecodeJob.FetcherReadyCallback</a></li></ul></li></ul></li></ul></li><li><a href=#面试题>面试题</a></li></ul></nav></div></aside></main></body></html>