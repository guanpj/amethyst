<!doctype html><html lang=en dir=ltr><head><meta property="og:title" content="Glide 高级用法"><meta property="og:description" content="回调与监听 #  Target #  我们都知道，使用 Glide 在界面上加载并展示一张图片只需要一行代码：
Glide.with(this).load(url).into(imageView); 将 ImageView 的实例传入到 into() 方法当中，Glide 将图片加载完成之后，图片就能显示到 ImageView 上了。这是怎么实现的呢？来看一下 into() 方法的源码：
@NonNull public ViewTarget<ImageView, TranscodeType> into(@NonNull ImageView view) {  Util.assertMainThread();  Preconditions.checkNotNull(view);   BaseRequestOptions<?> requestOptions = this;  if (!requestOptions.isTransformationSet()  && requestOptions.isTransformationAllowed()  && view.getScaleType() != null) {  // Clone in this method so that if we use this RequestBuilder to load into a View and then  // into a different target, we don't retain the transformation applied based on the previous  // View's scale type."><meta property="og:type" content="article"><meta property="og:url" content="https://guanpj.github.io/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/Glide-%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95/"><meta property="article:section" content="Knowledge"><meta property="og:site_name" content="guanpj's blog"><title>Glide 高级用法 | guanpj's blog</title><link rel=manifest href=/amethyst/manifest.json><link rel=icon href=/amethyst/favicon.png type=image/x-icon><link rel=stylesheet href=/amethyst/book.min.c27ff4755c78daab11627953d5a6dd7e2698690e086398032995aae74d6397b6.css integrity="sha256-wn/0dVx42qsRYnlT1abdfiaYaQ4IY5gDKZWq501jl7Y=" crossorigin=anonymous><meta charset=utf-8><meta name=description content="回调与监听 #  Target #  我们都知道，使用 Glide 在界面上加载并展示一张图片只需要一行代码：
Glide.with(this).load(url).into(imageView); 将 ImageView 的实例传入到 into() 方法当中，Glide 将图片加载完成之后，图片就能显示到 ImageView 上了。这是怎么实现的呢？来看一下 into() 方法的源码：
@NonNull public ViewTarget<ImageView, TranscodeType> into(@NonNull ImageView view) {  Util.assertMainThread();  Preconditions.checkNotNull(view);   BaseRequestOptions<?> requestOptions = this;  if (!requestOptions.isTransformationSet()  && requestOptions.isTransformationAllowed()  && view.getScaleType() != null) {  // Clone in this method so that if we use this RequestBuilder to load into a View and then  // into a different target, we don't retain the transformation applied based on the previous  // View's scale type."><title>Glide 高级用法</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://guanpj.github.io/amethyst//favicon.png><link href=https://guanpj.github.io/amethyst/styles.e08ceb33360cec132feb69cfb982e2a4.min.css rel=stylesheet><link href=https://guanpj.github.io/amethyst/quartz/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://guanpj.github.io/amethyst/quartz/js/darkmode.1bc498b60ed24d8858f74f99e480db82.min.js></script>
<script src=https://guanpj.github.io/amethyst/quartz/js/util.c69e233dc1cc331a30b0f670e657b425.min.js></script>
<script async src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script async src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://guanpj.github.io/amethyst/quartz/js/popover.f03552ccb84d99ca615d1cfb9abde59e.min.js></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://guanpj.github.io/amethyst/",fetchData=Promise.all([fetch("https://guanpj.github.io/amethyst/indices/linkIndex.f13ba8f7c67305f3500d259bdfb72f53.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://guanpj.github.io/amethyst/indices/contentIndex.1d36e1d8fc5979d61a65084cf1563896.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addCollapsibleCallouts(),initPopover("https://guanpj.github.io/amethyst",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!0;drawGraph("https://guanpj.github.io/amethyst",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script>window.Million={navigate:e=>window.location.href=e,prefetch:()=>{}},window.addEventListener("DOMContentLoaded",()=>{init(),render()})</script></head><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><header class=book-header><label for=menu-control><img src=/amethyst/svg/menu.svg class=book-icon alt=Menu></label><h1 id=page-title><a href=https://guanpj.github.io/amethyst/>guanpj's blog</a></h1><div class=spacer></div><div id=search-icon class=quartz-search><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control><main class=flex><aside class=book-menu><div class=book-menu-content><nav><div class=menu-search><div id=search-icon class=quartz-search><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div></div><ul><li><span class=book-menu-title>Atlas</span><ul><li><a href=/amethyst/Atlas/About-Atlas/>About Atlas</a></li><li><a href=/amethyst/Atlas/Index-for-Atlases/>Index for Atlases</a></li></ul></li><li><span class=book-menu-title>Dashborads</span><ul><li><a href=/amethyst/Dashborad/Buttons/>Buttons</a></li><li><a href=/amethyst/Dashborad/ControlPanel/>Control Panel</a></li></ul></li><li><span class=book-menu-title>Excalidraws</span><ul><li><a href=/amethyst/Excalidraw/MyDraw/>My Draw</a></li></ul></li><li><span class=book-menu-title>Extras</span><ul><li><a href=/amethyst/Extras/Linter/>Linter</a></li><li><a href=/amethyst/Extras/Index-for-Extras/>Index for Extras</a></li></ul></li><li><span class=book-menu-title>Knowledges</span><ul><li><a href=/amethyst/Knowledge/Kotlin/%E5%A7%94%E6%89%98/>委托</a></li><li><a href=/amethyst/Knowledge/Kotlin/%E6%89%A9%E5%B1%95%E5%87%BD%E6%95%B0/>扩展函数</a></li><li><a href=/amethyst/Knowledge/Python/%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%96%87%E6%9C%AC%E6%9B%BF%E6%8D%A2/>文件读取、文本替换</a></li><li><a href=/amethyst/Knowledge/Python/%E7%B1%BB%E7%9A%84%E5%AE%9A%E4%B9%89%E4%BD%BF%E7%94%A8/>类的定义、使用</a></li><li><a href=/amethyst/Knowledge/Python/%E9%81%8D%E5%8E%86%E6%96%87%E4%BB%B6%E9%87%8D%E5%91%BD%E5%90%8D/>遍历文件、重命名</a></li><li><a href=/amethyst/Knowledge/%E7%AE%97%E6%B3%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E5%BC%95%E7%94%A8/>引用</a></li><li><a href=/amethyst/Knowledge/%E7%AE%97%E6%B3%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%8C%87%E9%92%88/>指针</a></li><li><a href=/amethyst/Knowledge/Android/Android-%E5%9F%BA%E7%A1%80/ADB-%E5%91%BD%E4%BB%A4/>ADB 命令</a></li><li><a href=/amethyst/Knowledge/Android/%E7%83%AD%E4%BF%AE%E5%A4%8D%E6%8F%92%E4%BB%B6%E5%8C%96/Java-%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/>ADB 命令</a></li><li><a href=/amethyst/Knowledge/Android/Android-%E5%9F%BA%E7%A1%80/Android-%E5%AF%B9%E5%AE%B9%E5%99%A8%E7%B1%BB%E7%9A%84%E4%BC%98%E5%8C%96/>Android 对容器类的优化</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/CAS-%E5%92%8C-AQS-%E5%8E%9F%E7%90%86/>CAS 和 AQS 原理</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/EventBus-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>EventBus 使用及源码解析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/Glide-%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E5%92%8C%E7%BC%93%E5%AD%98%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/>Glide 加载流程和缓存原理分析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/Glide-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/>Glide 基本使用</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/Glide-%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95/ class=active>Glide 高级用法</a></li><li><a href=/amethyst/Knowledge/Java/%E5%9F%BA%E7%A1%80/HashMap-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>HashMap 源码解析</a></li><li><a href=/amethyst/Knowledge/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9B%B8%E5%85%B3/HTTP-%E5%9F%BA%E7%A1%80/>HTTP 基础</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/Java-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/>Java 内存模型</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E4%B8%AD%E7%9A%84%E5%AF%B9%E8%B1%A1%E5%92%8C%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/>JVM 中的对象和垃圾回收</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F/>JVM 内存区域</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E5%AD%97%E8%8A%82%E7%A0%81%E6%8C%87%E4%BB%A4%E7%AE%80%E4%BB%8B/>JVM 字节码指令简介</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E5%AD%97%E8%8A%82%E7%A0%81%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/>JVM 字节码结构分析</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/>JVM 类加载机制</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/LeakCanary-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>LeakCanary 使用及源码解析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/OkHttp-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>OkHttp 使用及源码分析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/Retrofit-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>Retrofit 使用及源码分析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/RxJava-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>RxJava 使用及源码分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%B8%80Binder-%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90%E6%A6%82%E5%BF%B5%E7%AF%87/>一、Binder 机制分析——概念篇</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%B8%83View-%E4%BA%8B%E4%BB%B6%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/>七、View 事件机制分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%B8%89Handler-%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/>三、Handler 原理分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%BA%8CBinder-%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90%E5%BA%94%E7%94%A8%E7%AF%87/>二、Binder 机制分析——应用篇</a></li><li><a href=/amethyst/Knowledge/%E7%AE%97%E6%B3%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E4%BA%8C%E5%8F%89%E6%A0%91%E9%81%8D%E5%8E%86/>二叉树遍历</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%BA%94App-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/>五、App 启动流程分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E5%85%ADView-%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/>六、View 绘制流程分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E5%9B%9B%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/>四、系统启动流程分析</a></li><li><a href=/amethyst/Knowledge/Java/%E5%9F%BA%E7%A1%80/%E5%AE%B9%E5%99%A8%E7%B1%BB/>容器类</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/>并发容器</a></li><li><a href=/amethyst/Knowledge/Java/%E5%9F%BA%E7%A1%80/%E6%B3%9B%E5%9E%8B/>泛型</a></li><li><a href=/amethyst/Knowledge/Java/%E5%9F%BA%E7%A1%80/%E6%B3%A8%E8%A7%A3%E5%92%8C%E5%8F%8D%E5%B0%84/>注解和反射</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E7%AD%89%E5%BE%85-%E9%80%9A%E7%9F%A5%E6%9C%BA%E5%88%B6/>等待-通知机制</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E7%BA%BF%E7%A8%8B%E5%8D%8F%E4%BD%9C/>线程协作</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80/>线程基础</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%92%8C-BlockingQueue/>线程池和 BlockingQueue</a></li><li><a href=/amethyst/Knowledge/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9B%B8%E5%85%B3/%E7%BC%96%E7%A0%81%E5%8A%A0%E5%AF%86Hash%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%AD%97%E7%AC%A6%E9%9B%86/>编码、加密、Hash、序列化和字符集</a></li><li><a href=/amethyst/Knowledge/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9B%B8%E5%85%B3/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84TCPIP-%E5%92%8C-HTTPS/>计算机网络体系结构、TCP&IP 和 HTTPS</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E9%94%81/>锁</a></li></ul></li><li><span class=book-menu-title>Notes</span><ul><li><a href=/amethyst/Notes/2023-03-15/>2023 03 15</a></li><li><a href=/amethyst/Notes/2023-03-18/>2023 03 18</a></li><li><a href=/amethyst/Notes/2023-03-19/>2023 03 19</a></li><li><a href=/amethyst/Notes/2023-03-20/>2023 03 20</a></li><li><a href=/amethyst/Notes/2023-03-22/>Troubleshooting and FAQ</a></li></ul></li></ul><ul><li><a href=https://github.com/64bitpandas/amethyst target=_blank rel=noopener>Github</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class="book-page container"><article class=markdown><h1 class=title>Glide 高级用法</h1><h1 id=回调与监听>回调与监听
<a class=anchor href=#%e5%9b%9e%e8%b0%83%e4%b8%8e%e7%9b%91%e5%90%ac>#</a></h1><h2 id=target>Target
<a class=anchor href=#target>#</a></h2><p>我们都知道，使用 Glide 在界面上加载并展示一张图片只需要一行代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Glide<span style=color:#f92672>.</span><span style=color:#a6e22e>with</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>).</span><span style=color:#a6e22e>load</span><span style=color:#f92672>(</span>url<span style=color:#f92672>).</span><span style=color:#a6e22e>into</span><span style=color:#f92672>(</span>imageView<span style=color:#f92672>);</span>
</span></span></code></pre></div><p>将 ImageView 的实例传入到 into() 方法当中，Glide 将图片加载完成之后，图片就能显示到 ImageView 上了。这是怎么实现的呢？来看一下 into() 方法的源码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> ViewTarget<span style=color:#f92672>&lt;</span>ImageView<span style=color:#f92672>,</span> TranscodeType<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>into</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> ImageView view<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  Util<span style=color:#f92672>.</span><span style=color:#a6e22e>assertMainThread</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  Preconditions<span style=color:#f92672>.</span><span style=color:#a6e22e>checkNotNull</span><span style=color:#f92672>(</span>view<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  BaseRequestOptions<span style=color:#f92672>&lt;?&gt;</span> requestOptions <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>requestOptions<span style=color:#f92672>.</span><span style=color:#a6e22e>isTransformationSet</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&amp;&amp;</span> requestOptions<span style=color:#f92672>.</span><span style=color:#a6e22e>isTransformationAllowed</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&amp;&amp;</span> view<span style=color:#f92672>.</span><span style=color:#a6e22e>getScaleType</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Clone in this method so that if we use this RequestBuilder to load into a View and then
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// into a different target, we don&#39;t retain the transformation applied based on the previous
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// View&#39;s scale type.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>view<span style=color:#f92672>.</span><span style=color:#a6e22e>getScaleType</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> CENTER_CROP<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        requestOptions <span style=color:#f92672>=</span> requestOptions<span style=color:#f92672>.</span><span style=color:#a6e22e>clone</span><span style=color:#f92672>().</span><span style=color:#a6e22e>optionalCenterCrop</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> CENTER_INSIDE<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        requestOptions <span style=color:#f92672>=</span> requestOptions<span style=color:#f92672>.</span><span style=color:#a6e22e>clone</span><span style=color:#f92672>().</span><span style=color:#a6e22e>optionalCenterInside</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> FIT_CENTER<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> FIT_START<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> FIT_END<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        requestOptions <span style=color:#f92672>=</span> requestOptions<span style=color:#f92672>.</span><span style=color:#a6e22e>clone</span><span style=color:#f92672>().</span><span style=color:#a6e22e>optionalFitCenter</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> FIT_XY<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        requestOptions <span style=color:#f92672>=</span> requestOptions<span style=color:#f92672>.</span><span style=color:#a6e22e>clone</span><span style=color:#f92672>().</span><span style=color:#a6e22e>optionalCenterInside</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> CENTER<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> MATRIX<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Do nothing.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> into<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>      glideContext<span style=color:#f92672>.</span><span style=color:#a6e22e>buildImageViewTarget</span><span style=color:#f92672>(</span>view<span style=color:#f92672>,</span> transcodeClass<span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>/*targetListener=*/</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      requestOptions<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>mainThreadExecutor</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到，最后一行代码会调用 glideContext.buildImageViewTarget() 方法构建出一个 Target 对象，然后再把它传入到另一个接收 Target 参数的 into() 方法中。Target 对象则是用来最终展示图片用的，跟进方法 glideContext.buildImageViewTarget：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>X<span style=color:#f92672>&gt;</span> ViewTarget<span style=color:#f92672>&lt;</span>ImageView<span style=color:#f92672>,</span> X<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>buildImageViewTarget</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NonNull</span> ImageView imageView<span style=color:#f92672>,</span> <span style=color:#a6e22e>@NonNull</span> Class<span style=color:#f92672>&lt;</span>X<span style=color:#f92672>&gt;</span> transcodeClass<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> imageViewTargetFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>buildTarget</span><span style=color:#f92672>(</span>imageView<span style=color:#f92672>,</span> transcodeClass<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>继续跟进：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ImageViewTargetFactory</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;unchecked&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> ViewTarget<span style=color:#f92672>&lt;</span>ImageView<span style=color:#f92672>,</span> Z<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>buildTarget</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>@NonNull</span> ImageView view<span style=color:#f92672>,</span> <span style=color:#a6e22e>@NonNull</span> Class<span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> clazz<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Bitmap<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>clazz<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>ViewTarget<span style=color:#f92672>&lt;</span>ImageView<span style=color:#f92672>,</span> Z<span style=color:#f92672>&gt;)</span> <span style=color:#66d9ef>new</span> BitmapImageViewTarget<span style=color:#f92672>(</span>view<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Drawable<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isAssignableFrom</span><span style=color:#f92672>(</span>clazz<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>ViewTarget<span style=color:#f92672>&lt;</span>ImageView<span style=color:#f92672>,</span> Z<span style=color:#f92672>&gt;)</span> <span style=color:#66d9ef>new</span> DrawableImageViewTarget<span style=color:#f92672>(</span>view<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;Unhandled class: &#34;</span> <span style=color:#f92672>+</span> clazz <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;, try .as*(Class).transcode(ResourceTranscoder)&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>回顾之前的分析流程，在 into(ImageView) 过程中，会将 ImageView 包装成为一个 ViewTarget 类。如果调用过 asBitmap() 方法，那么此处会是 BitmapImageViewTarget，否则都将会是 DrawableImageViewTarget。BitmapImageViewTarget 和 DrawableImageViewTarget 除了 setResource 方法中调用的设置图片的 API 不同外，没有任何区别。</p><p>DrawableImageView 的继承链如下：DrawableImageView -> ImageViewTarget -> ViewTarget -> BaseTarget -> Target。</p><ul><li>Target 是一个继承了 LifecycleListener 接口的接口类，该类提供了资源加载过程中的回调操作。</li></ul><p>典型的生命周期为 onLoadStarted -> onResourceReady/onLoadFailed -> onLoadCleared，但不保证所有的都是这样。如果资源在内存中或者由于 model 为 null 而加载失败，onLoadStarted 不会被调用。同样，如果 target 不会清除，那么 onLoadCleared 方法也不会被调用。</p><ul><li>BaseTarget 是一个实现了 Target 接口的抽象类。</li></ul><p>该类实现了 setRequest(Request)、getRequest() 两个方法，其他方法相当于适配器模式的实现。</p><ul><li>ViewTarget</li></ul><p>该类虽然继承了 BaseTarget 类，但其重写了 setRequest(Request)、getRequest() 两个方法，这两个方法会调用 View.setTag 方法将 Request 对象传入。</p><p>In addition, <strong>for</strong> ViewTarget<strong>s only</strong>, you can pass in a new instance to each load or clear call and allow Glide to retrieve information about previous loads from the Views tags</p><p>This will <strong>not</strong> work unless your Target extends ViewTarget or implements setRequest() and getRequest() in a way that allows you to retrieve previous requests in new Target instances.</p><p><a href=http://bumptech.github.io/glide/doc/targets.html#cancellation-and-re-use rel=noopener>Cancellation and re-use</a></p><ul><li>ImageViewTarget</li></ul><p>该类的作用就是在加载的生命周期回调中给 ImageView 设置对应的资源。但由于加载成功后返回的资源可能是 Bitmap 或者 Drawable，所以这个不确定类型的加载由 setResource 抽象方法声明，待子类 BitmapImageViewTarget 和 DrawableImageViewTarget 实现。</p><ul><li>DrawableImageViewTarget</li></ul><p>继承了 ImageViewTarget 类，唯一的作用就是实现 setResource(Drawable) 方法。</p><p>在了解了 DrawableImageViewTarget 以及相关的类之后，我们看一下其他的 Target。下面是 Glide v4 中出现的所有的 Target：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-3/clipboard_20230323_031827.png width=auto alt></p><p>虽然 Target 很多，但是自定义只需要继承 CustomViewTarget 或者 CustomTarget 就行了。</p><p><strong>为什么要继承 </strong>CustomViewTarget <strong>而不是 </strong>ViewTarget？
ViewTarget 已经被标记为废弃了，建议我们使用 CustomViewTarget。这是因为，如果子类没有实现 ViewTarget.onLoadCleared 方法，将会导致被回收的 bitmap 仍然被 UI 所引用，从而导致崩溃。而 CustomViewTarget.onLoadCleared 方法是 final 类型的，并且提供了一个抽象方法 onResourceCleared 强制我们实现。除此之外，两个类基本没有任何区别。</p><p><strong>为什么要继承 </strong>CustomTarget <strong>而不是 </strong>SimpleTarget？原因同上。</p><p>下面举一个实际例子，在某些场景下，此时我们需要获取到加载成功后的 Bitma p 对象：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>Glide.with(<span style=color:#66d9ef>this</span>)
</span></span><span style=display:flex><span>    .asBitmap()
</span></span><span style=display:flex><span>    .load(<span style=color:#66d9ef>file</span>)
</span></span><span style=display:flex><span>    .into(<span style=color:#66d9ef>object</span> <span style=color:#960050;background-color:#1e0010>: </span><span style=color:#a6e22e>CustomTarget</span>&lt;Bitmap&gt;() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onResourceReady</span>(
</span></span><span style=display:flex><span>            resource: Bitmap,
</span></span><span style=display:flex><span>            transition: Transition&lt;<span style=color:#66d9ef>in</span> Bitmap&gt;?
</span></span><span style=display:flex><span>        ) {
</span></span><span style=display:flex><span>            ivFace.setImageBitmap(resource)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onLoadCleared</span>(placeholder: Drawable?) {
</span></span><span style=display:flex><span>            ivFace.setImageDrawable(placeholder)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    })
</span></span></code></pre></div><h2 id=requestbuilder-高级-api>RequestBuilder 高级 API
<a class=anchor href=#requestbuilder-%e9%ab%98%e7%ba%a7-api>#</a></h2><p>在了解了 Target 之后，我们再看看 RequestBuilder 中高级一点的 API。</p><p>下面这些都是 Target 的应用，内部调用的是 <strong>修改过配置</strong> 的 into/submit 方法，但 RequestBuilder.downloadOnly 方法已经被废弃；建议采用 RequestManager 的 downloadOnly() 方法和 into/submit 方法</p><p>此外还有还需要注意的一个 API：listener/addListener</p><h3 id=preload>preload
<a class=anchor href=#preload>#</a></h3><p>作用：将资源预加载到缓存中</p><p>preload 的重载方法如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>  * Preloads the resource into the cache using the given width and height.
</span></span></span><span style=display:flex><span><span style=color:#75715e>  *
</span></span></span><span style=display:flex><span><span style=color:#75715e>  * &lt;p&gt; Pre-loading is useful for making sure that resources you are going to to want in the near
</span></span></span><span style=display:flex><span><span style=color:#75715e>  * future are available quickly. &lt;/p&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e>  *
</span></span></span><span style=display:flex><span><span style=color:#75715e>  * @param width  The desired width in pixels, or {@link Target#SIZE_ORIGINAL}. This will be
</span></span></span><span style=display:flex><span><span style=color:#75715e>  *               overridden by
</span></span></span><span style=display:flex><span><span style=color:#75715e>  *               {@link com.bumptech.glide.request.RequestOptions#override(int, int)} if
</span></span></span><span style=display:flex><span><span style=color:#75715e>  *               previously called.
</span></span></span><span style=display:flex><span><span style=color:#75715e>  * @param height The desired height in pixels, or {@link Target#SIZE_ORIGINAL}. This will be
</span></span></span><span style=display:flex><span><span style=color:#75715e>  *               overridden by
</span></span></span><span style=display:flex><span><span style=color:#75715e>  *               {@link com.bumptech.glide.request.RequestOptions#override(int, int)}} if
</span></span></span><span style=display:flex><span><span style=color:#75715e>  *               previously called).
</span></span></span><span style=display:flex><span><span style=color:#75715e>  * @return A {@link Target} that can be used to cancel the load via
</span></span></span><span style=display:flex><span><span style=color:#75715e>  * {@link RequestManager#clear(Target)}.
</span></span></span><span style=display:flex><span><span style=color:#75715e>  * @see com.bumptech.glide.ListPreloader
</span></span></span><span style=display:flex><span><span style=color:#75715e>  */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Target<span style=color:#f92672>&lt;</span>TranscodeType<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>preload</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> width<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> height<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> PreloadTarget<span style=color:#f92672>&lt;</span>TranscodeType<span style=color:#f92672>&gt;</span> target <span style=color:#f92672>=</span> PreloadTarget<span style=color:#f92672>.</span><span style=color:#a6e22e>obtain</span><span style=color:#f92672>(</span>requestManager<span style=color:#f92672>,</span> width<span style=color:#f92672>,</span> height<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> into<span style=color:#f92672>(</span>target<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>  * Preloads the resource into the cache using {@link Target#SIZE_ORIGINAL} as the target width and
</span></span></span><span style=display:flex><span><span style=color:#75715e>  * height. Equivalent to calling {@link #preload(int, int)} with {@link Target#SIZE_ORIGINAL} as
</span></span></span><span style=display:flex><span><span style=color:#75715e>  * the width and height.
</span></span></span><span style=display:flex><span><span style=color:#75715e>  *
</span></span></span><span style=display:flex><span><span style=color:#75715e>  * @return A {@link Target} that can be used to cancel the load via
</span></span></span><span style=display:flex><span><span style=color:#75715e>  * {@link RequestManager#clear(Target)}
</span></span></span><span style=display:flex><span><span style=color:#75715e>  * @see #preload(int, int)
</span></span></span><span style=display:flex><span><span style=color:#75715e>  */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Target<span style=color:#f92672>&lt;</span>TranscodeType<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>preload</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> preload<span style=color:#f92672>(</span>Target<span style=color:#f92672>.</span><span style=color:#a6e22e>SIZE_ORIGINAL</span><span style=color:#f92672>,</span> Target<span style=color:#f92672>.</span><span style=color:#a6e22e>SIZE_ORIGINAL</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>注意，在注释中出现了一个 ListPreload 类，该类是在 ListView 中做 item 预加载的一个工具类，使用方法为 AbsListView#setOnScrollListener(android.widget.AbsListView.OnScrollListener)。该类代码很简单，要点就是在滚动时计算需要预处理的 item。</p><p>这么好用，那我要是 RecyclerView 怎么办？Glide 也提供了 RecyclerView 的版本，不过需要添加新的依赖 recyclerview-integration，详情可以查看文档
<a href=http://bumptech.github.io/glide/int/recyclerview.html rel=noopener>INTEGRATION LIBRARIES - RecyclerView</a>。</p><p>我们可以看到，在 preload 的实现中关键点就在于 PreloadTarget 类。该类实现非常简单，就是在 onResourceReady 回调发生后，经过 Handler 中转，最后由构造参数之一的 RequestManager 对象 clear 掉。PreloadTarget 实现代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * A one time use {@link com.bumptech.glide.request.target.Target} class that loads a resource into
</span></span></span><span style=display:flex><span><span style=color:#75715e> * memory and then clears itself.
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param &lt;Z&gt; The type of resource that will be loaded into memory.
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PreloadTarget</span><span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>extends</span> SimpleTarget<span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> MESSAGE_CLEAR <span style=color:#f92672>=</span> 1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Handler HANDLER <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Handler<span style=color:#f92672>(</span>Looper<span style=color:#f92672>.</span><span style=color:#a6e22e>getMainLooper</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>new</span> Callback<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>handleMessage</span><span style=color:#f92672>(</span>Message message<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>message<span style=color:#f92672>.</span><span style=color:#a6e22e>what</span> <span style=color:#f92672>==</span> MESSAGE_CLEAR<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>((</span>PreloadTarget<span style=color:#f92672>&lt;?&gt;)</span> message<span style=color:#f92672>.</span><span style=color:#a6e22e>obj</span><span style=color:#f92672>).</span><span style=color:#a6e22e>clear</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> RequestManager requestManager<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * Returns a PreloadTarget.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   *
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * @param width  The width in pixels of the desired resource.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * @param height The height in pixels of the desired resource.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * @param &lt;Z&gt;    The type of the desired resource.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> PreloadTarget<span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>obtain</span><span style=color:#f92672>(</span>RequestManager requestManager<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> width<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> height<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> PreloadTarget<span style=color:#f92672>&lt;&gt;(</span>requestManager<span style=color:#f92672>,</span> width<span style=color:#f92672>,</span> height<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>PreloadTarget</span><span style=color:#f92672>(</span>RequestManager requestManager<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> width<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> height<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>width<span style=color:#f92672>,</span> height<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>requestManager</span> <span style=color:#f92672>=</span> requestManager<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onResourceReady</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Z resource<span style=color:#f92672>,</span> <span style=color:#a6e22e>@Nullable</span> Transition<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>super</span> Z<span style=color:#f92672>&gt;</span> transition<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    HANDLER<span style=color:#f92672>.</span><span style=color:#a6e22e>obtainMessage</span><span style=color:#f92672>(</span>MESSAGE_CLEAR<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>).</span><span style=color:#a6e22e>sendToTarget</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;WeakerAccess&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Synthetic</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>clear</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    requestManager<span style=color:#f92672>.</span><span style=color:#a6e22e>clear</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=submit>submit
<a class=anchor href=#submit>#</a></h3><p>作用：返回一个 Future 对象，其 get() 方法会阻塞住，所以需要在后台线程中调用</p><p>submit 的两个重载方法如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>  * Returns a future that can be used to do a blocking get on a background thread.
</span></span></span><span style=display:flex><span><span style=color:#75715e>  *
</span></span></span><span style=display:flex><span><span style=color:#75715e>  * &lt;p&gt;This method defaults to {@link Target#SIZE_ORIGINAL} for the width and the height. However,
</span></span></span><span style=display:flex><span><span style=color:#75715e>  * since the width and height will be overridden by values passed to {@link
</span></span></span><span style=display:flex><span><span style=color:#75715e>  * RequestOptions#override(int, int)}, this method can be used whenever {@link RequestOptions}
</span></span></span><span style=display:flex><span><span style=color:#75715e>  * with override values are applied, or whenever you want to retrieve the image in its original
</span></span></span><span style=display:flex><span><span style=color:#75715e>  * size.
</span></span></span><span style=display:flex><span><span style=color:#75715e>  *
</span></span></span><span style=display:flex><span><span style=color:#75715e>  * @see #submit(int, int)
</span></span></span><span style=display:flex><span><span style=color:#75715e>  * @see #into(Target)
</span></span></span><span style=display:flex><span><span style=color:#75715e>  */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> FutureTarget<span style=color:#f92672>&lt;</span>TranscodeType<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>submit</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> submit<span style=color:#f92672>(</span>Target<span style=color:#f92672>.</span><span style=color:#a6e22e>SIZE_ORIGINAL</span><span style=color:#f92672>,</span> Target<span style=color:#f92672>.</span><span style=color:#a6e22e>SIZE_ORIGINAL</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>  * Returns a future that can be used to do a blocking get on a background thread.
</span></span></span><span style=display:flex><span><span style=color:#75715e>  *
</span></span></span><span style=display:flex><span><span style=color:#75715e>  * @param width  The desired width in pixels, or {@link Target#SIZE_ORIGINAL}. This will be
</span></span></span><span style=display:flex><span><span style=color:#75715e>  *               overridden by
</span></span></span><span style=display:flex><span><span style=color:#75715e>  *               {@link com.bumptech.glide.request.RequestOptions#override(int, int)} if
</span></span></span><span style=display:flex><span><span style=color:#75715e>  *               previously called.
</span></span></span><span style=display:flex><span><span style=color:#75715e>  * @param height The desired height in pixels, or {@link Target#SIZE_ORIGINAL}. This will be
</span></span></span><span style=display:flex><span><span style=color:#75715e>  *               overridden by
</span></span></span><span style=display:flex><span><span style=color:#75715e>  *               {@link com.bumptech.glide.request.RequestOptions#override(int, int)}} if
</span></span></span><span style=display:flex><span><span style=color:#75715e>  *               previously called).
</span></span></span><span style=display:flex><span><span style=color:#75715e>  */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> FutureTarget<span style=color:#f92672>&lt;</span>TranscodeType<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>submit</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> width<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> height<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> RequestFutureTarget<span style=color:#f92672>&lt;</span>TranscodeType<span style=color:#f92672>&gt;</span> target <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RequestFutureTarget<span style=color:#f92672>&lt;&gt;(</span>width<span style=color:#f92672>,</span> height<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> into<span style=color:#f92672>(</span>target<span style=color:#f92672>,</span> target<span style=color:#f92672>,</span> Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>directExecutor</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>由于方法会生成一个 RequestFutureTarget 对象，而其 getSize 的实现就是构造参数。所以，此处的值会覆盖掉 RequestOptions 设置的值。</p><p>submit 之后生成了一个 RequestFutureTarget 对象，调用该对象的 get 方法可以在资源加载成功后立即获得资源对象，在获得之前会阻塞，所以 get 方法需要在后台线程中执行，否则会报错。</p><p>RequestFutureTarget 的示例代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>FutureTarget<span style=color:#f92672>&lt;</span>File<span style=color:#f92672>&gt;</span> target <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>RequestManager requestManager <span style=color:#f92672>=</span> Glide<span style=color:#f92672>.</span><span style=color:#a6e22e>with</span><span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  target <span style=color:#f92672>=</span> requestManager
</span></span><span style=display:flex><span>     <span style=color:#f92672>.</span><span style=color:#a6e22e>downloadOnly</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>     <span style=color:#f92672>.</span><span style=color:#a6e22e>load</span><span style=color:#f92672>(</span>model<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>     <span style=color:#f92672>.</span><span style=color:#a6e22e>submit</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  File downloadedFile <span style=color:#f92672>=</span> target<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ... do something with the file (usually throws IOException)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>ExecutionException <span style=color:#f92672>|</span> InterruptedException <span style=color:#f92672>|</span> IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ... bug reporting or recovery
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// make sure to cancel pending operations and free resources
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>target <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    target<span style=color:#f92672>.</span><span style=color:#a6e22e>cancel</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span> <span style=color:#75715e>// mayInterruptIfRunning
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=downloadonly>downloadOnly
<a class=anchor href=#downloadonly>#</a></h3><p>作用：下载原始的无修改的 data 文件。</p><p>downloadOnly 内部调用的是修改过配置的 into/submit 方法，但 downloadOnly 方法已经被废弃；建议采用 RequestManager 的 downloadOnly() 方法和 into/submit 方法。</p><p>实际上 RequestBuilder.downloadOnly 方法与 RequestManager.downloadOnly()、RequestBuilder.into/submit 方法组合没有什么区别。</p><p>两处代码如下：</p><p><em>RequestBuilder.downloadOnly</em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Deprecated</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>Y <span style=color:#66d9ef>extends</span> Target<span style=color:#f92672>&lt;</span>File<span style=color:#f92672>&gt;&gt;</span> Y <span style=color:#a6e22e>downloadOnly</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Y target<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> getDownloadOnlyRequest<span style=color:#f92672>().</span><span style=color:#a6e22e>into</span><span style=color:#f92672>(</span>target<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Deprecated</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> FutureTarget<span style=color:#f92672>&lt;</span>File<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>downloadOnly</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> width<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> height<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> getDownloadOnlyRequest<span style=color:#f92672>().</span><span style=color:#a6e22e>submit</span><span style=color:#f92672>(</span>width<span style=color:#f92672>,</span> height<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>protected</span> RequestBuilder<span style=color:#f92672>&lt;</span>File<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getDownloadOnlyRequest</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> RequestBuilder<span style=color:#f92672>&lt;&gt;(</span>File<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>).</span><span style=color:#a6e22e>apply</span><span style=color:#f92672>(</span>DOWNLOAD_ONLY_OPTIONS<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><em>RequestManager.downloadOnly、RequestBuilder.into/submit</em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> &lt;<span style=color:#f92672>Y</span> <span style=color:#a6e22e>extends</span> <span style=color:#a6e22e>Target</span><span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#a6e22e>TranscodeType</span>&gt;<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>Y</span> <span style=color:#a6e22e>into</span>(<span style=color:#66d9ef>@NonNull</span> <span style=color:#a6e22e>Y</span> <span style=color:#a6e22e>target</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>into</span>(<span style=color:#a6e22e>target</span>, <span style=color:#75715e>/*targetListener=*/</span> <span style=color:#66d9ef>null</span>, <span style=color:#a6e22e>Executors</span>.<span style=color:#a6e22e>mainThreadExecutor</span>());
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>FutureTarget</span>&lt;<span style=color:#f92672>TranscodeType</span>&gt; <span style=color:#a6e22e>submit</span>(<span style=color:#a6e22e>int</span> <span style=color:#a6e22e>width</span>, <span style=color:#a6e22e>int</span> <span style=color:#a6e22e>height</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>final</span> <span style=color:#a6e22e>RequestFutureTarget</span>&lt;<span style=color:#f92672>TranscodeType</span>&gt; <span style=color:#a6e22e>target</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>RequestFutureTarget</span>&lt;&gt;(<span style=color:#a6e22e>width</span>, <span style=color:#a6e22e>height</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>into</span>(<span style=color:#a6e22e>target</span>, <span style=color:#a6e22e>target</span>, <span style=color:#a6e22e>Executors</span>.<span style=color:#a6e22e>directExecutor</span>());
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RequestBuilder</span>&lt;<span style=color:#f92672>File</span>&gt; <span style=color:#a6e22e>downloadOnly() {</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>as</span>(<span style=color:#a6e22e>File</span>.<span style=color:#66d9ef>class</span>).<span style=color:#a6e22e>apply</span>(<span style=color:#a6e22e>DOWNLOAD_ONLY_OPTIONS</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>所以，这里的 DOWNLOAD_ONLY_OPTIONS 才是 downloadOnly 的精髓，我们看看该变量的值：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> RequestOptions DOWNLOAD_ONLY_OPTIONS <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>new</span> RequestOptions<span style=color:#f92672>().</span><span style=color:#a6e22e>diskCacheStrategy</span><span style=color:#f92672>(</span>DiskCacheStrategy<span style=color:#f92672>.</span><span style=color:#a6e22e>DATA</span><span style=color:#f92672>).</span><span style=color:#a6e22e>priority</span><span style=color:#f92672>(</span>Priority<span style=color:#f92672>.</span><span style=color:#a6e22e>LOW</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>skipMemoryCache</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><p>果然是下载的是原始的无修改的 data 资源。</p><h3 id=listeneraddlistener>listener/addListener
<a class=anchor href=#listeneraddlistener>#</a></h3><p>listener 与 addListener 不同之处在于，前者只会保留当前的 Listener，而后者会保留之前的 Listener。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SuppressWarnings</span>(<span style=color:#e6db74>&#34;unchecked&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> RequestBuilder&lt;TranscodeType&gt; listener(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Nullable</span> RequestListener&lt;TranscodeType&gt; requestListener) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>.requestListeners = <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> addListener(requestListener);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> RequestBuilder&lt;TranscodeType&gt; addListener(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Nullable</span> RequestListener&lt;TranscodeType&gt; requestListener) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (requestListener <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.requestListeners <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.requestListeners = new ArrayList&lt;&gt;();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.requestListeners.add(requestListener);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这些 listener 会在资源记载失败或者成功的时候被调用，SingleRequest 中关于 requestListeners 的代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onResourceReady</span><span style=color:#f92672>(</span>Resource<span style=color:#f92672>&lt;</span>R<span style=color:#f92672>&gt;</span> resource<span style=color:#f92672>,</span> R result<span style=color:#f92672>,</span> DataSource dataSource<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// We must call isFirstReadyResource before setting status.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>boolean</span> isFirstResource <span style=color:#f92672>=</span> isFirstReadyResource<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  status <span style=color:#f92672>=</span> Status<span style=color:#f92672>.</span><span style=color:#a6e22e>COMPLETE</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>resource</span> <span style=color:#f92672>=</span> resource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  isCallingCallbacks <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> anyListenerHandledUpdatingTarget <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>requestListeners <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>RequestListener<span style=color:#f92672>&lt;</span>R<span style=color:#f92672>&gt;</span> listener <span style=color:#f92672>:</span> requestListeners<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        anyListenerHandledUpdatingTarget <span style=color:#f92672>|=</span>
</span></span><span style=display:flex><span>            listener<span style=color:#f92672>.</span><span style=color:#a6e22e>onResourceReady</span><span style=color:#f92672>(</span>result<span style=color:#f92672>,</span> model<span style=color:#f92672>,</span> target<span style=color:#f92672>,</span> dataSource<span style=color:#f92672>,</span> isFirstResource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    anyListenerHandledUpdatingTarget <span style=color:#f92672>|=</span>
</span></span><span style=display:flex><span>        targetListener <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&amp;&amp;</span> targetListener<span style=color:#f92672>.</span><span style=color:#a6e22e>onResourceReady</span><span style=color:#f92672>(</span>result<span style=color:#f92672>,</span> model<span style=color:#f92672>,</span> target<span style=color:#f92672>,</span> dataSource<span style=color:#f92672>,</span> isFirstResource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>anyListenerHandledUpdatingTarget<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      Transition<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>super</span> R<span style=color:#f92672>&gt;</span> animation <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>          animationFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>(</span>dataSource<span style=color:#f92672>,</span> isFirstResource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      target<span style=color:#f92672>.</span><span style=color:#a6e22e>onResourceReady</span><span style=color:#f92672>(</span>result<span style=color:#f92672>,</span> animation<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    isCallingCallbacks <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  notifyLoadSuccess<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onLoadFailed</span><span style=color:#f92672>(</span>GlideException e<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> maxLogLevel<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  stateVerifier<span style=color:#f92672>.</span><span style=color:#a6e22e>throwIfRecycled</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  e<span style=color:#f92672>.</span><span style=color:#a6e22e>setOrigin</span><span style=color:#f92672>(</span>requestOrigin<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  loadStatus <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  status <span style=color:#f92672>=</span> Status<span style=color:#f92672>.</span><span style=color:#a6e22e>FAILED</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  isCallingCallbacks <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//TODO: what if this is a thumbnail request?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>boolean</span> anyListenerHandledUpdatingTarget <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>requestListeners <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>RequestListener<span style=color:#f92672>&lt;</span>R<span style=color:#f92672>&gt;</span> listener <span style=color:#f92672>:</span> requestListeners<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        anyListenerHandledUpdatingTarget <span style=color:#f92672>|=</span>
</span></span><span style=display:flex><span>            listener<span style=color:#f92672>.</span><span style=color:#a6e22e>onLoadFailed</span><span style=color:#f92672>(</span>e<span style=color:#f92672>,</span> model<span style=color:#f92672>,</span> target<span style=color:#f92672>,</span> isFirstReadyResource<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    anyListenerHandledUpdatingTarget <span style=color:#f92672>|=</span>
</span></span><span style=display:flex><span>        targetListener <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&amp;&amp;</span> targetListener<span style=color:#f92672>.</span><span style=color:#a6e22e>onLoadFailed</span><span style=color:#f92672>(</span>e<span style=color:#f92672>,</span> model<span style=color:#f92672>,</span> target<span style=color:#f92672>,</span> isFirstReadyResource<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>anyListenerHandledUpdatingTarget<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      setErrorPlaceholder<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    isCallingCallbacks <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  notifyLoadFailed<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>调用逻辑是这样：在 requestListeners 集合、targetListener 中依次调用对应的回调，找到第一个能够处理的 (返回 true)，后面的就不再调用。</p><p>同时，如果有一个回调返回了 true，那么资源的对应方法会被拦截：</p><ol><li>对于 onResourceReady 方法来说，Target 的 onResourceReady 方法不会被回调</li><li>对于 onLoadFailed 方法来说，setErrorPlaceholder 调用不会调用，即不会显示任何失败的占位符</li></ol><h1 id=transform>Transform
<a class=anchor href=#transform>#</a></h1><h2 id=transform-行为分析>Transform 行为分析
<a class=anchor href=#transform-%e8%a1%8c%e4%b8%ba%e5%88%86%e6%9e%90>#</a></h2><h3 id=场景还原>场景还原
<a class=anchor href=#%e5%9c%ba%e6%99%af%e8%bf%98%e5%8e%9f>#</a></h3><p>布局文件：ImageView 宽高都是 wrap_content</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#75715e>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>android.support.constraint.ConstraintLayout</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>xmlns:android</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://schemas.android.com/apk/res/android&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>xmlns:app</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://schemas.android.com/apk/res-auto&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>android:layout_width</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;match_parent&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>android:layout_height</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;match_parent&#34;</span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>ImageView</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;@+id/ivGlide&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:layout_width</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;wrap_content&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:layout_height</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;wrap_content&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:layout_constraintStart_toStartOf</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;parent&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:layout_constraintTop_toTopOf</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;parent&#34;</span>/&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>android.support.design.widget.FloatingActionButton</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;@+id/fab&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:layout_width</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;wrap_content&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:layout_height</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;wrap_content&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:layout_margin</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;24dp&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;@drawable/btn_camera&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:layout_constraintEnd_toEndOf</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;parent&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:layout_constraintBottom_toBottomOf</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;parent&#34;</span>/&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>android.support.constraint.ConstraintLayout</span>&gt;
</span></span></code></pre></div><p>代码：测试的可选项为代码中被注释的两行代码</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#f92672>..</span>.
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> com.bumptech.glide.request.target.Target <span style=color:#66d9ef>as</span> GlideTarget
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>GlideFragment</span> : Fragment() {
</span></span><span style=display:flex><span>    <span style=color:#f92672>..</span>.
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onViewCreated</span>(view: View, savedInstanceState: Bundle?) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span>.onViewCreated(view, savedInstanceState)
</span></span><span style=display:flex><span>        fab.setOnClickListener {
</span></span><span style=display:flex><span>            load()
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>load</span>() {
</span></span><span style=display:flex><span>        Glide.with(<span style=color:#66d9ef>this</span>)
</span></span><span style=display:flex><span>            .load(URL)
</span></span><span style=display:flex><span><span style=color:#75715e>//            .dontTransform()
</span></span></span><span style=display:flex><span><span style=color:#75715e>//            .override(GlideTarget.SIZE_ORIGINAL, GlideTarget.SIZE_ORIGINAL)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            .into(ivGlide)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>companion</span> <span style=color:#66d9ef>object</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 540*258  1080/(759-243)-(540/258)=0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>val</span> URL = <span style=color:#e6db74>&#34;https://www.baidu.com/img/bd_logo1.png&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>整个例子非常简单，点击一下 FAB 就会调用 load 方法加载网路图片。注意这里 ImageView 的宽高都是 wrap_content。</p><p>下面从左至右 4 张图分别对应以下配置开启时的效果（下面分析时会称为例 1、例 2、例 3、例 4）：</p><ol><li>直接加载</li><li>只使用 dontTransform</li><li>只使用 override</li><li>dontTransform 和 override 同时</li></ol><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-3/clipboard_20230323_031837.png width=auto alt></p><p>可以很明显的看到，显示的图片也有所差异，ImageView 的宽高有所差异。</p><p>如果没有调用 override(Target.SIZE_ORIGINAL, Target.SIZE_ORIGINAL)，ImageView 宽度会是 match_parent 的效果，且如果 dontTransform()，那么高度也是 match_parent 效果。调用了 override 之后会显示的图片的真实尺寸。</p><p>带着这个问题，到源码中看看是怎么回事。</p><h3 id=代码分析>代码分析
<a class=anchor href=#%e4%bb%a3%e7%a0%81%e5%88%86%e6%9e%90>#</a></h3><p>首先 dontTransform() 方法实现在 BaseRequestOptions 文件中，该方法的意思就是不使用任何 transform：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> T <span style=color:#a6e22e>dontTransform</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isAutoCloneEnabled<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> clone<span style=color:#f92672>().</span><span style=color:#a6e22e>dontTransform</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  transformations<span style=color:#f92672>.</span><span style=color:#a6e22e>clear</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  fields <span style=color:#f92672>&amp;=</span> <span style=color:#f92672>~</span>TRANSFORMATION<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  isTransformationRequired <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  fields <span style=color:#f92672>&amp;=</span> <span style=color:#f92672>~</span>TRANSFORMATION_REQUIRED<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  isTransformationAllowed <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  fields <span style=color:#f92672>|=</span> TRANSFORMATION_ALLOWED<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  isScaleOnlyOrNoTransform <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> selfOrThrowIfLocked<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这里首先清空了 transformations，然后设置了一些标志位。这些标志位后面看到再说。然后是 override 方法，该方法的意思是只加载指定宽高的像素的图片，方法实现只是保存了参数，待后面使用：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CheckResult</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> T <span style=color:#66d9ef>override</span>(int width, int height) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (isAutoCloneEnabled) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> clone().<span style=color:#66d9ef>override</span>(width, height);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>.overrideWidth = width;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>.overrideHeight = height;
</span></span><span style=display:flex><span>  fields |= OVERRIDE;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> selfOrThrowIfLocked();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在配置完参数后，调用 into 方法开始加载图片。整个加载流程非常冗长，详情请看前面的分析文章。所以这里只挑选相关的代码，其他的会一笔带过。</p><p>先是 RequestBuilder.into(ImageView) 的实现，该方法会默认进行一些 transform 的配置：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> ViewTarget<span style=color:#f92672>&lt;</span>ImageView<span style=color:#f92672>,</span> TranscodeType<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>into</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> ImageView view<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  Util<span style=color:#f92672>.</span><span style=color:#a6e22e>assertMainThread</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  Preconditions<span style=color:#f92672>.</span><span style=color:#a6e22e>checkNotNull</span><span style=color:#f92672>(</span>view<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  BaseRequestOptions<span style=color:#f92672>&lt;?&gt;</span> requestOptions <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>requestOptions<span style=color:#f92672>.</span><span style=color:#a6e22e>isTransformationSet</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&amp;&amp;</span> requestOptions<span style=color:#f92672>.</span><span style=color:#a6e22e>isTransformationAllowed</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&amp;&amp;</span> view<span style=color:#f92672>.</span><span style=color:#a6e22e>getScaleType</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Clone in this method so that if we use this RequestBuilder to load into a View and then
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// into a different target, we don&#39;t retain the transformation applied based on the previous
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// View&#39;s scale type.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>view<span style=color:#f92672>.</span><span style=color:#a6e22e>getScaleType</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> CENTER_CROP<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        requestOptions <span style=color:#f92672>=</span> requestOptions<span style=color:#f92672>.</span><span style=color:#a6e22e>clone</span><span style=color:#f92672>().</span><span style=color:#a6e22e>optionalCenterCrop</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> CENTER_INSIDE<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        requestOptions <span style=color:#f92672>=</span> requestOptions<span style=color:#f92672>.</span><span style=color:#a6e22e>clone</span><span style=color:#f92672>().</span><span style=color:#a6e22e>optionalCenterInside</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> FIT_CENTER<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> FIT_START<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> FIT_END<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        requestOptions <span style=color:#f92672>=</span> requestOptions<span style=color:#f92672>.</span><span style=color:#a6e22e>clone</span><span style=color:#f92672>().</span><span style=color:#a6e22e>optionalFitCenter</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> FIT_XY<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        requestOptions <span style=color:#f92672>=</span> requestOptions<span style=color:#f92672>.</span><span style=color:#a6e22e>clone</span><span style=color:#f92672>().</span><span style=color:#a6e22e>optionalCenterInside</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> CENTER<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> MATRIX<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Do nothing.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> into<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>      glideContext<span style=color:#f92672>.</span><span style=color:#a6e22e>buildImageViewTarget</span><span style=color:#f92672>(</span>view<span style=color:#f92672>,</span> transcodeClass<span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>/*targetListener=*/</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      requestOptions<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>mainThreadExecutor</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>在上面代码第 7 行的判断语句 !requestOptions.isTransformationSet()，判断的是 fields 是否含有标记位 TRANSFORMATION。</p><p>第 8 行判断语句 requestOptions.isTransformationAllowed() 判断的是 isTransformationAllowed。</p><p>对于这两个判断条件，如果调用了 dontTransform() 方法（例 2、例 4），那么显然条件 1 满足，但是条件 2 就不满足了。否则（例 1、例 3），这两个条件都是满足的，也就意味着 Glide 会有一个默认的 transform。默认的 transform 会根据 ImageView 的 ScaleType 有不同的取值。</p><p>ScaleType 与默认的 transform 之间关系如下表：</p><p>在 ImageView.initImageView() 方法中可以看到，默认的 ScaleType 为 ScaleType.FIT_CENTER。所以，此时 Glide 会默认调用 optionalFitCenter() 方法。</p><p>注意，optionalFitCenter() 方法与非 optional 的 fitCenter() 方法的差别在于 isTransformationRequired 参数的值不同。在最后 DecodeHelper.getTransformation(Class) 方法中，如果找不到可用的 transform，且 isTransformationRequired 为 true，就会抛出 IllegalArgumentException。除此之外两者没有别的差别。</p><p>optionalFitCenter() 方法会针对四种不同类型的数据产生不同的 transformation：</p><p>现在可以开始加载图片了，最开始会调用 SingleRequest.begin 方法，在该方法中会判断需要显示多大尺寸的图片。如果指定了 override(int, int)（例 3、例 4），那么就无需 ViewTarget 参与计算，直接调用 onSizeReady(int, int) 开始下一步；否则（例 1、例 2）就要计算了：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>begin</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>model <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Util<span style=color:#f92672>.</span><span style=color:#a6e22e>isValidDimensions</span><span style=color:#f92672>(</span>overrideWidth<span style=color:#f92672>,</span> overrideHeight<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      width <span style=color:#f92672>=</span> overrideWidth<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      height <span style=color:#f92672>=</span> overrideHeight<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>status <span style=color:#f92672>==</span> Status<span style=color:#f92672>.</span><span style=color:#a6e22e>RUNNING</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Cannot restart a running request&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>status <span style=color:#f92672>==</span> Status<span style=color:#f92672>.</span><span style=color:#a6e22e>COMPLETE</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    onResourceReady<span style=color:#f92672>(</span>resource<span style=color:#f92672>,</span> DataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>MEMORY_CACHE</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Restarts for requests that are neither complete nor running can be treated as new requests
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// and can run again from the beginning.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  status <span style=color:#f92672>=</span> Status<span style=color:#f92672>.</span><span style=color:#a6e22e>WAITING_FOR_SIZE</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Util<span style=color:#f92672>.</span><span style=color:#a6e22e>isValidDimensions</span><span style=color:#f92672>(</span>overrideWidth<span style=color:#f92672>,</span> overrideHeight<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    onSizeReady<span style=color:#f92672>(</span>overrideWidth<span style=color:#f92672>,</span> overrideHeight<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    target<span style=color:#f92672>.</span><span style=color:#a6e22e>getSize</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>status <span style=color:#f92672>==</span> Status<span style=color:#f92672>.</span><span style=color:#a6e22e>RUNNING</span> <span style=color:#f92672>||</span> status <span style=color:#f92672>==</span> Status<span style=color:#f92672>.</span><span style=color:#a6e22e>WAITING_FOR_SIZE</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&amp;&amp;</span> canNotifyStatusChanged<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    target<span style=color:#f92672>.</span><span style=color:#a6e22e>onLoadStarted</span><span style=color:#f92672>(</span>getPlaceholderDrawable<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>显然，造成示例中图片尺寸差异的一个原因就是这个第 27 行的 target.getSize(this) 方法了。对应方法的实现在 ViewTarget 中，这个请求会转发给内部的 SizeDeterminer 来完成。看一下 ViewTarget.SizeDeterminer 类：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SizeDeterminer</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>getSize</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> SizeReadyCallback cb<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> currentWidth <span style=color:#f92672>=</span> getTargetWidth<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> currentHeight <span style=color:#f92672>=</span> getTargetHeight<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isViewStateAndSizeValid<span style=color:#f92672>(</span>currentWidth<span style=color:#f92672>,</span> currentHeight<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      cb<span style=color:#f92672>.</span><span style=color:#a6e22e>onSizeReady</span><span style=color:#f92672>(</span>currentWidth<span style=color:#f92672>,</span> currentHeight<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getTargetHeight</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> verticalPadding <span style=color:#f92672>=</span> view<span style=color:#f92672>.</span><span style=color:#a6e22e>getPaddingTop</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> view<span style=color:#f92672>.</span><span style=color:#a6e22e>getPaddingBottom</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    LayoutParams layoutParams <span style=color:#f92672>=</span> view<span style=color:#f92672>.</span><span style=color:#a6e22e>getLayoutParams</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> layoutParamSize <span style=color:#f92672>=</span> layoutParams <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> layoutParams<span style=color:#f92672>.</span><span style=color:#a6e22e>height</span> <span style=color:#f92672>:</span> PENDING_SIZE<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> getTargetDimen<span style=color:#f92672>(</span>view<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeight</span><span style=color:#f92672>(),</span> layoutParamSize<span style=color:#f92672>,</span> verticalPadding<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getTargetWidth</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> horizontalPadding <span style=color:#f92672>=</span> view<span style=color:#f92672>.</span><span style=color:#a6e22e>getPaddingLeft</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> view<span style=color:#f92672>.</span><span style=color:#a6e22e>getPaddingRight</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    LayoutParams layoutParams <span style=color:#f92672>=</span> view<span style=color:#f92672>.</span><span style=color:#a6e22e>getLayoutParams</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> layoutParamSize <span style=color:#f92672>=</span> layoutParams <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> layoutParams<span style=color:#f92672>.</span><span style=color:#a6e22e>width</span> <span style=color:#f92672>:</span> PENDING_SIZE<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> getTargetDimen<span style=color:#f92672>(</span>view<span style=color:#f92672>.</span><span style=color:#a6e22e>getWidth</span><span style=color:#f92672>(),</span> layoutParamSize<span style=color:#f92672>,</span> horizontalPadding<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>首先在第 3、4 行调用方法获取 Target 的宽高，由于在本例中宽高都是 WRAP_CONTENT，而且也没有其他的限制，所以最后调用 getTargetDimen 时传入的参数都是一样的 (viewSize=0, paramSize=WRAP_CONTENT=-2, paddingSize=0)。然后，看看 getTargetDimen 方法的实现：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getTargetDimen</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> viewSize<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> paramSize<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> paddingSize<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// We consider the View state as valid if the View has non-null layout params and a non-zero
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// layout params width and height. This is imperfect. We&#39;re making an assumption that View
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// parents will obey their child&#39;s layout parameters, which isn&#39;t always the case.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>int</span> adjustedParamSize <span style=color:#f92672>=</span> paramSize <span style=color:#f92672>-</span> paddingSize<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>adjustedParamSize <span style=color:#f92672>&gt;</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> adjustedParamSize<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Since we always prefer layout parameters with fixed sizes, even if waitForLayout is true,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// we might as well ignore it and just return the layout parameters above if we have them.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// Otherwise we should wait for a layout pass before checking the View&#39;s dimensions.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>waitForLayout <span style=color:#f92672>&amp;&amp;</span> view<span style=color:#f92672>.</span><span style=color:#a6e22e>isLayoutRequested</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> PENDING_SIZE<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// We also consider the View state valid if the View has a non-zero width and height. This
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// means that the View has gone through at least one layout pass. It does not mean the Views
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// width and height are from the current layout pass. For example, if a View is re-used in
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// RecyclerView or ListView, this width/height may be from an old position. In some cases
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// the dimensions of the View at the old position may be different than the dimensions of the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// View in the new position because the LayoutManager/ViewParent can arbitrarily decide to
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// change them. Nevertheless, in most cases this should be a reasonable choice.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>int</span> adjustedViewSize <span style=color:#f92672>=</span> viewSize <span style=color:#f92672>-</span> paddingSize<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>adjustedViewSize <span style=color:#f92672>&gt;</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> adjustedViewSize<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Finally we consider the view valid if the layout parameter size is set to wrap_content.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// It&#39;s difficult for Glide to figure out what to do here. Although Target.SIZE_ORIGINAL is a
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// coherent choice, it&#39;s extremely dangerous because original images may be much too large to
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// fit in memory or so large that only a couple can fit in memory, causing OOMs. If users want
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// the original image, they can always use .override(Target.SIZE_ORIGINAL). Since wrap_content
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// may never resolve to a real size unless we load something, we aim for a square whose length
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// is the largest screen size. That way we&#39;re loading something and that something has some
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// hope of being downsampled to a size that the device can support. We also log a warning that
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// tries to explain what Glide is doing and why some alternatives are preferable.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// Since WRAP_CONTENT is sometimes used as a default layout parameter, we always wait for
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// layout to complete before using this fallback parameter (ConstraintLayout among others).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>view<span style=color:#f92672>.</span><span style=color:#a6e22e>isLayoutRequested</span><span style=color:#f92672>()</span> <span style=color:#f92672>&amp;&amp;</span> paramSize <span style=color:#f92672>==</span> LayoutParams<span style=color:#f92672>.</span><span style=color:#a6e22e>WRAP_CONTENT</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Log<span style=color:#f92672>.</span><span style=color:#a6e22e>isLoggable</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> Log<span style=color:#f92672>.</span><span style=color:#a6e22e>INFO</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      Log<span style=color:#f92672>.</span><span style=color:#a6e22e>i</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Glide treats LayoutParams.WRAP_CONTENT as a request for an image the size of&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; this device&#39;s screen dimensions. If you want to load the original image and are&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; ok with the corresponding memory cost and OOMs (depending on the input size), use&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; .override(Target.SIZE_ORIGINAL). Otherwise, use LayoutParams.MATCH_PARENT, set&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; layout_width and layout_height to fixed dimension, or use .override() with fixed&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; dimensions.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> getMaxDisplayLength<span style=color:#f92672>(</span>view<span style=color:#f92672>.</span><span style=color:#a6e22e>getContext</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// If the layout parameters are &lt; padding, the view size is &lt; padding, or the layout
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// parameters are set to match_parent or wrap_content and no layout has occurred, we should
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// wait for layout and repeat.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>return</span> PENDING_SIZE<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>在 getTargetDimen 方法中会通过参数计算 Target 的尺寸，显然这里最后会调用 getMaxDisplayLength(view.getContext()) 来返回 View 的尺寸。至于为什么 wrap_content 时会这样做，在注释中说的很清楚了，主要是考虑到加载的资源的不确定性，万一是一个大图片就直接 OOM 了。而且 Glide 会打印出 log 告诉我们一些解决方法，如果我们不满意这种处理方式。</p><p>getMaxDisplayLength(Context) 会返回 Display size 宽高的较大者：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Use the maximum to avoid depending on the device&#39;s current orientation.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getMaxDisplayLength</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Context context<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>maxDisplayLength <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    WindowManager windowManager <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>(</span>WindowManager<span style=color:#f92672>)</span> context<span style=color:#f92672>.</span><span style=color:#a6e22e>getSystemService</span><span style=color:#f92672>(</span>Context<span style=color:#f92672>.</span><span style=color:#a6e22e>WINDOW_SERVICE</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    Display display <span style=color:#f92672>=</span> Preconditions<span style=color:#f92672>.</span><span style=color:#a6e22e>checkNotNull</span><span style=color:#f92672>(</span>windowManager<span style=color:#f92672>).</span><span style=color:#a6e22e>getDefaultDisplay</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    Point displayDimensions <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Point<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    display<span style=color:#f92672>.</span><span style=color:#a6e22e>getSize</span><span style=color:#f92672>(</span>displayDimensions<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    maxDisplayLength <span style=color:#f92672>=</span> Math<span style=color:#f92672>.</span><span style=color:#a6e22e>max</span><span style=color:#f92672>(</span>displayDimensions<span style=color:#f92672>.</span><span style=color:#a6e22e>x</span><span style=color:#f92672>,</span> displayDimensions<span style=color:#f92672>.</span><span style=color:#a6e22e>y</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> maxDisplayLength<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>显然，在示例中，最后获取到的宽高都是一样的，在竖屏状态下会是 Display 的高。</p><p><strong>Display#getSize 与 Display#getRealSize 的区别？</strong></p><p>Display#getRealSize 返回的是屏幕真实的尺寸；而 Display#getSize 返回的是“可用”的屏幕尺寸，常见的情况是，有 NavigationBar 就会等于 RealSize 减去 NavigationBar 的高度。</p><p>获取到了 Target 的尺寸之后，会调用 isViewStateAndSizeValid 方法检查是否 OK：OK 就调用 SingleRequest.onSizeReady 方法进入下一步了；否则会给 ViewTree 添加 OnPreDrawListener 监听器，在 onPreDraw 方法回调中再次获取一下尺寸。</p><p>在经过一系列操作，加载到原始数据之后，会现在 DecodePath.decode 中对原始 data 进行 decode，这样就得到了 Bitmap，但是过程中涉及到 Bitmap 尺寸的操作。具体经过 ByteBufferBitmapDecoder 到 Downsampler#decodeFromWrappedStreams 方法中。里面绝大多数都是计算，这里拿例 1 来描述计算过程：</p><ol><li>获取 Bitmap 的宽高：sourceWidth=540,sourceHeight=258；获取 Target 的宽高：targetWidth=targetHeight=1776</li><li>调用 calculateScaling 方法计算 inSampleSize、inTargetDensity、inDensity 等一系列参数，这里会用到 DownsampleStrategy.FitCenter 类，该对象在前面 optionalFitCenter() 过程保存的 KV 表格中提到过。其 getScaleFactor 方法实现就是取 target 宽高 / source 宽高的较小者，也就是 3.288889，该值由 inTargetDensity/inDensity 保存。</li><li>最后计算 expectedWidth=round(540<em>3.288889)=1776，expectedHeight=round(258</em>3.288889)=849，并从 BitmapPool 中获取这么一个宽高的 Bitmap 设置给 Options.inBitmap</li><li>再次进行解码，解码完毕后获得的图片就是 1776x849 大小的图片了。</li></ol><p>如果是 dontTransform（例 2），DownsampleStrategy 会是默认值 DownsampleStrategy.CenterOutside。其 getScaleFactor 方法实现就是取 target 宽高 / source 宽高的较大者，也就是 6.883721。因此最后解码完毕的图片大小为 3717x1776。</p><p>如果是 override 过的（例 3、例 4），由于不需要缩放，所以返回的就是原始大小的图片。</p><p>在 decode 完毕后，会回到 DecodeJob.onResourceDecoded 方法中接着进行 transform 操作：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Synthetic</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> Resource<span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>onResourceDecoded</span><span style=color:#f92672>(</span>DataSource dataSource<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NonNull</span> Resource<span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> decoded<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;unchecked&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  Class<span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> resourceSubClass <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;)</span> decoded<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  Transformation<span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> appliedTransformation <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  Resource<span style=color:#f92672>&lt;</span>Z<span style=color:#f92672>&gt;</span> transformed <span style=color:#f92672>=</span> decoded<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>dataSource <span style=color:#f92672>!=</span> DataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>RESOURCE_DISK_CACHE</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    appliedTransformation <span style=color:#f92672>=</span> decodeHelper<span style=color:#f92672>.</span><span style=color:#a6e22e>getTransformation</span><span style=color:#f92672>(</span>resourceSubClass<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    transformed <span style=color:#f92672>=</span> appliedTransformation<span style=color:#f92672>.</span><span style=color:#a6e22e>transform</span><span style=color:#f92672>(</span>glideContext<span style=color:#f92672>,</span> decoded<span style=color:#f92672>,</span> width<span style=color:#f92672>,</span> height<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>在这里首先判断是不是 DataSource.RESOURCE_DISK_CACHE，如果不是才需要进行 transform。</p><p><strong>But, why?</strong> Glide 中很重要的概念——resource 和 data：差别在于 resource 是已经 transform 过了的，即 transform(data)=resource。所以，我们知道 resource 已经经过 transform 过了，自然就不再需要。</p><p>对于调用过 dontTransform() 方法的例子（例 2、例 4）来说，decodeHelper.getTransformation 返回的是一个 UnitTransformation，其 transform 没有干任何有意义的事情，也就是说不进行 transform。</p><p>对于普通的 Glide 加载请求（例 1、例 3）来说，一个 URL 已经经过一系列 Registry 的变换，到这里就变成 了 Bitmap.class，所以在第 11 行调用的是 <code>FitCenter().transform(Context, Resource&lt;Bitmap>, int, int )</code> 方法。而 FitCenter 又是 BitmapTransformation 的子类，所以先看看 BitmapTransformation：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BitmapTransformation</span> <span style=color:#66d9ef>implements</span> Transformation<span style=color:#f92672>&lt;</span>Bitmap<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> Resource<span style=color:#f92672>&lt;</span>Bitmap<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>transform</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>@NonNull</span> Context context<span style=color:#f92672>,</span> <span style=color:#a6e22e>@NonNull</span> Resource<span style=color:#f92672>&lt;</span>Bitmap<span style=color:#f92672>&gt;</span> resource<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> outWidth<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> outHeight<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>Util<span style=color:#f92672>.</span><span style=color:#a6e22e>isValidDimensions</span><span style=color:#f92672>(</span>outWidth<span style=color:#f92672>,</span> outHeight<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;Cannot apply transformation on width: &#34;</span> <span style=color:#f92672>+</span> outWidth <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; or height: &#34;</span> <span style=color:#f92672>+</span> outHeight
</span></span><span style=display:flex><span>              <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; less than or equal to zero and not Target.SIZE_ORIGINAL&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    BitmapPool bitmapPool <span style=color:#f92672>=</span> Glide<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>context<span style=color:#f92672>).</span><span style=color:#a6e22e>getBitmapPool</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    Bitmap toTransform <span style=color:#f92672>=</span> resource<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> targetWidth <span style=color:#f92672>=</span> outWidth <span style=color:#f92672>==</span> Target<span style=color:#f92672>.</span><span style=color:#a6e22e>SIZE_ORIGINAL</span> <span style=color:#f92672>?</span> toTransform<span style=color:#f92672>.</span><span style=color:#a6e22e>getWidth</span><span style=color:#f92672>()</span> <span style=color:#f92672>:</span> outWidth<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> targetHeight <span style=color:#f92672>=</span> outHeight <span style=color:#f92672>==</span> Target<span style=color:#f92672>.</span><span style=color:#a6e22e>SIZE_ORIGINAL</span> <span style=color:#f92672>?</span> toTransform<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeight</span><span style=color:#f92672>()</span> <span style=color:#f92672>:</span> outHeight<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    Bitmap transformed <span style=color:#f92672>=</span> transform<span style=color:#f92672>(</span>bitmapPool<span style=color:#f92672>,</span> toTransform<span style=color:#f92672>,</span> targetWidth<span style=color:#f92672>,</span> targetHeight<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> Resource<span style=color:#f92672>&lt;</span>Bitmap<span style=color:#f92672>&gt;</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>toTransform<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>transformed<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      result <span style=color:#f92672>=</span> resource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      result <span style=color:#f92672>=</span> BitmapResource<span style=color:#f92672>.</span><span style=color:#a6e22e>obtain</span><span style=color:#f92672>(</span>transformed<span style=color:#f92672>,</span> bitmapPool<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>abstract</span> Bitmap <span style=color:#a6e22e>transform</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>@NonNull</span> BitmapPool pool<span style=color:#f92672>,</span> <span style=color:#a6e22e>@NonNull</span> Bitmap toTransform<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> outWidth<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> outHeight<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>首先做 sanity check，然后获取 targetWidth、targetHeight。如果指定了 override(Target.SIZE_ORIGINAL, Target.SIZE_ORIGINAL)，这里会是图片的真实尺寸，否则就是 Target 的尺寸了。</p><p>然后调用抽象方法进行 transform 操作，并返回 transform 后的结果。显然，transform 抽象方法就是子类需要实现的了，所以看看 FitCenter 的方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FitCenter</span> <span style=color:#66d9ef>extends</span> BitmapTransformation <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String ID <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;com.bumptech.glide.load.resource.bitmap.FitCenter&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> ID_BYTES <span style=color:#f92672>=</span> ID<span style=color:#f92672>.</span><span style=color:#a6e22e>getBytes</span><span style=color:#f92672>(</span>CHARSET<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>protected</span> Bitmap <span style=color:#a6e22e>transform</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> BitmapPool pool<span style=color:#f92672>,</span> <span style=color:#a6e22e>@NonNull</span> Bitmap toTransform<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> outWidth<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>int</span> outHeight<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> TransformationUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>fitCenter</span><span style=color:#f92672>(</span>pool<span style=color:#f92672>,</span> toTransform<span style=color:#f92672>,</span> outWidth<span style=color:#f92672>,</span> outHeight<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>Object o<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> o <span style=color:#66d9ef>instanceof</span> FitCenter<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>hashCode</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> ID<span style=color:#f92672>.</span><span style=color:#a6e22e>hashCode</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>updateDiskCacheKey</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> MessageDigest messageDigest<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    messageDigest<span style=color:#f92672>.</span><span style=color:#a6e22e>update</span><span style=color:#f92672>(</span>ID_BYTES<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到 FitCenter.transform 方法直接调用了 TransformationUtils 的 fitCenter 方法。除此之外，需要注意一下 equals、hashCode、updateDiskCacheKey 方法，这三个方法要重写的原因是因为 transform 会作为 key 的组成部分，参与到 key 的比较、缓存读写时 safeKey 生成，具体内容可以参考之前分析的文章。</p><p>至于 TransformationUtils 类，该类里面有很多处理图片的静态方法，内置的几种 BitmapTransformation 都是调用该工具类里面对应的方法来完成 transform 功能的。这里只看 fitCenter 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> Bitmap <span style=color:#a6e22e>fitCenter</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> BitmapPool pool<span style=color:#f92672>,</span> <span style=color:#a6e22e>@NonNull</span> Bitmap inBitmap<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> width<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> height<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>inBitmap<span style=color:#f92672>.</span><span style=color:#a6e22e>getWidth</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> width <span style=color:#f92672>&amp;&amp;</span> inBitmap<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeight</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> height<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Log<span style=color:#f92672>.</span><span style=color:#a6e22e>isLoggable</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> Log<span style=color:#f92672>.</span><span style=color:#a6e22e>VERBOSE</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      Log<span style=color:#f92672>.</span><span style=color:#a6e22e>v</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;requested target size matches input, returning input&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> inBitmap<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>float</span> widthPercentage <span style=color:#f92672>=</span> width <span style=color:#f92672>/</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>float</span><span style=color:#f92672>)</span> inBitmap<span style=color:#f92672>.</span><span style=color:#a6e22e>getWidth</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>float</span> heightPercentage <span style=color:#f92672>=</span> height <span style=color:#f92672>/</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>float</span><span style=color:#f92672>)</span> inBitmap<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeight</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>float</span> minPercentage <span style=color:#f92672>=</span> Math<span style=color:#f92672>.</span><span style=color:#a6e22e>min</span><span style=color:#f92672>(</span>widthPercentage<span style=color:#f92672>,</span> heightPercentage<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Round here in case we&#39;ve decoded exactly the image we want, but take the floor below to
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// avoid a line of garbage or blank pixels in images.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>int</span> targetWidth <span style=color:#f92672>=</span> Math<span style=color:#f92672>.</span><span style=color:#a6e22e>round</span><span style=color:#f92672>(</span>minPercentage <span style=color:#f92672>*</span> inBitmap<span style=color:#f92672>.</span><span style=color:#a6e22e>getWidth</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> targetHeight <span style=color:#f92672>=</span> Math<span style=color:#f92672>.</span><span style=color:#a6e22e>round</span><span style=color:#f92672>(</span>minPercentage <span style=color:#f92672>*</span> inBitmap<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeight</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>inBitmap<span style=color:#f92672>.</span><span style=color:#a6e22e>getWidth</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> targetWidth <span style=color:#f92672>&amp;&amp;</span> inBitmap<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeight</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> targetHeight<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Log<span style=color:#f92672>.</span><span style=color:#a6e22e>isLoggable</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> Log<span style=color:#f92672>.</span><span style=color:#a6e22e>VERBOSE</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      Log<span style=color:#f92672>.</span><span style=color:#a6e22e>v</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;adjusted target size matches input, returning input&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> inBitmap<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Take the floor of the target width/height, not round. If the matrix
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// passed into drawBitmap rounds differently, we want to slightly
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// overdraw, not underdraw, to avoid artifacts from bitmap reuse.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  targetWidth <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span><span style=color:#f92672>)</span> <span style=color:#f92672>(</span>minPercentage <span style=color:#f92672>*</span> inBitmap<span style=color:#f92672>.</span><span style=color:#a6e22e>getWidth</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  targetHeight <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span><span style=color:#f92672>)</span> <span style=color:#f92672>(</span>minPercentage <span style=color:#f92672>*</span> inBitmap<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeight</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Bitmap<span style=color:#f92672>.</span><span style=color:#a6e22e>Config</span> config <span style=color:#f92672>=</span> getNonNullConfig<span style=color:#f92672>(</span>inBitmap<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  Bitmap toReuse <span style=color:#f92672>=</span> pool<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>targetWidth<span style=color:#f92672>,</span> targetHeight<span style=color:#f92672>,</span> config<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// We don&#39;t add or remove alpha, so keep the alpha setting of the Bitmap we were given.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  TransformationUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>setAlpha</span><span style=color:#f92672>(</span>inBitmap<span style=color:#f92672>,</span> toReuse<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Log<span style=color:#f92672>.</span><span style=color:#a6e22e>isLoggable</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> Log<span style=color:#f92672>.</span><span style=color:#a6e22e>VERBOSE</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Log<span style=color:#f92672>.</span><span style=color:#a6e22e>v</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;request: &#34;</span> <span style=color:#f92672>+</span> width <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;x&#34;</span> <span style=color:#f92672>+</span> height<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    Log<span style=color:#f92672>.</span><span style=color:#a6e22e>v</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;toFit:   &#34;</span> <span style=color:#f92672>+</span> inBitmap<span style=color:#f92672>.</span><span style=color:#a6e22e>getWidth</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;x&#34;</span> <span style=color:#f92672>+</span> inBitmap<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeight</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    Log<span style=color:#f92672>.</span><span style=color:#a6e22e>v</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;toReuse: &#34;</span> <span style=color:#f92672>+</span> toReuse<span style=color:#f92672>.</span><span style=color:#a6e22e>getWidth</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;x&#34;</span> <span style=color:#f92672>+</span> toReuse<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeight</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    Log<span style=color:#f92672>.</span><span style=color:#a6e22e>v</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;minPct:   &#34;</span> <span style=color:#f92672>+</span> minPercentage<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Matrix matrix <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Matrix<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  matrix<span style=color:#f92672>.</span><span style=color:#a6e22e>setScale</span><span style=color:#f92672>(</span>minPercentage<span style=color:#f92672>,</span> minPercentage<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  applyMatrix<span style=color:#f92672>(</span>inBitmap<span style=color:#f92672>,</span> toReuse<span style=color:#f92672>,</span> matrix<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> toReuse<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>该方法最开始会检查尺寸是否需要进行缩放，对于 override(Target.SIZE_ORIGINAL, Target.SIZE_ORIGINAL)（例 3）来说，显然是不需要的，所以就直接返回了。</p><p>否则，对于例 1 来说，需要继续执行后面的代码显示合适的图片。由于 Bitmap 的宽高在 encode 过程中计算出来了，为 1776x849，而传入的 width、height 为 1776，显然 minPercentage 会取 widthPercentage，也就意味着会按照屏幕的宽度进行缩放。但 widthPercentage 为 1，所以导致第 18 行的判断条件为 true，因此直接返回了图片。</p><p>后面就是纯粹的展示问题了，在 DrawableImageViewTarget.setResource 方法中会将上面的图片设置到 ImageView 中，此时 ImageView 宽高都是 0，resource 的宽高为 1776x849。下面怎么显示就是 ImageView 决 定的了。</p><p>下面对四个例子做一个小结：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-3/clipboard_20230323_031849.png width=auto alt></p><p>各例子之所以表现各不一样，其原因就在于 decode 出来的图片的尺寸不一致，而使用 wrap_content 宽高的 ImageView 加载这些图片，就会造成这些效果。</p><h2 id=glide-自带的-transformation>Glide 自带的 Transformation
<a class=anchor href=#glide-%e8%87%aa%e5%b8%a6%e7%9a%84-transformation>#</a></h2><p>在上一节遇到的 FitCenter、CenterOutside 这两个 BitmapTransformation 都是 Glide 自带的，除了这两个外还有其他四个自带的。这些 BitmapTransformation 的名称和作用如下：</p><ul><li>CenterInside：如果图片的尺小于等于 target，图片保持不变；否则会调用 fitCenter。</li><li>FitCenter：等比缩放，使得图片的一条边和 target 相同，另外一边小于给定的 target。</li><li>CenterCrop：首先缩放图片，使图片的宽和给定的宽相等，且图片的高大于给定的高。或者高相等，图片的宽大于给定的宽。然后 crop，使较大的一边的像素和给定的相同。这种缩放最终效果显然不是等比缩放。</li><li>Rotate：旋转 Bitmap</li><li>RoundedCorners：圆角，单位是 pixel</li><li>CircleCrop：圆形</li></ul><p>前面三个我们非常熟悉了，和 ImageView 的 ScaleType 有对应关系，所以下面的示例用来演示一下后面的三个 Transformation。</p><p>布局文件很简单，一个参照的 ImageView + 三个显示对应效果的 ImageView:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;android.support.constraint.ConstraintLayout</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>xmlns:android=</span><span style=color:#e6db74>&#34;http://schemas.android.com/apk/res/android&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>xmlns:app=</span><span style=color:#e6db74>&#34;http://schemas.android.com/apk/res-auto&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>android:layout_width=</span><span style=color:#e6db74>&#34;match_parent&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>android:layout_height=</span><span style=color:#e6db74>&#34;match_parent&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;android.support.constraint.Guideline</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:id=</span><span style=color:#e6db74>&#34;@+id/guideline&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:layout_width=</span><span style=color:#e6db74>&#34;0dp&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:layout_height=</span><span style=color:#e6db74>&#34;0dp&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:layout_constraintGuide_percent=</span><span style=color:#e6db74>&#34;0.5&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:orientation=</span><span style=color:#e6db74>&#34;vertical&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;ImageView</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:id=</span><span style=color:#e6db74>&#34;@+id/ivGlide1&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:layout_width=</span><span style=color:#e6db74>&#34;0dp&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:layout_height=</span><span style=color:#e6db74>&#34;wrap_content&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:layout_constraintStart_toStartOf=</span><span style=color:#e6db74>&#34;parent&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:layout_constraintEnd_toEndOf=</span><span style=color:#e6db74>&#34;@id/guideline&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:layout_constraintTop_toTopOf=</span><span style=color:#e6db74>&#34;parent&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;ImageView</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:id=</span><span style=color:#e6db74>&#34;@+id/ivGlide2&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:layout_width=</span><span style=color:#e6db74>&#34;0dp&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:layout_height=</span><span style=color:#e6db74>&#34;wrap_content&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:layout_constraintStart_toStartOf=</span><span style=color:#e6db74>&#34;@id/guideline&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:layout_constraintEnd_toEndOf=</span><span style=color:#e6db74>&#34;parent&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:layout_constraintTop_toTopOf=</span><span style=color:#e6db74>&#34;parent&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;ImageView</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:id=</span><span style=color:#e6db74>&#34;@+id/ivGlide3&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:layout_width=</span><span style=color:#e6db74>&#34;0dp&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:layout_height=</span><span style=color:#e6db74>&#34;wrap_content&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:layout_constraintStart_toStartOf=</span><span style=color:#e6db74>&#34;parent&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:layout_constraintEnd_toEndOf=</span><span style=color:#e6db74>&#34;@id/guideline&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:layout_constraintTop_toBottomOf=</span><span style=color:#e6db74>&#34;@id/ivGlide1&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;ImageView</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:id=</span><span style=color:#e6db74>&#34;@+id/ivGlide4&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:layout_width=</span><span style=color:#e6db74>&#34;0dp&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:layout_height=</span><span style=color:#e6db74>&#34;wrap_content&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:layout_constraintStart_toStartOf=</span><span style=color:#e6db74>&#34;@id/guideline&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:layout_constraintEnd_toEndOf=</span><span style=color:#e6db74>&#34;parent&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:layout_constraintTop_toBottomOf=</span><span style=color:#e6db74>&#34;@id/ivGlide2&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;android.support.design.widget.FloatingActionButton</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:id=</span><span style=color:#e6db74>&#34;@+id/fab&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:layout_width=</span><span style=color:#e6db74>&#34;wrap_content&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:layout_height=</span><span style=color:#e6db74>&#34;wrap_content&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:layout_margin=</span><span style=color:#e6db74>&#34;24dp&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:src=</span><span style=color:#e6db74>&#34;@drawable/btn_camera&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:layout_constraintEnd_toEndOf=</span><span style=color:#e6db74>&#34;parent&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app:layout_constraintBottom_toBottomOf=</span><span style=color:#e6db74>&#34;parent&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/android.support.constraint.ConstraintLayout&gt;</span>
</span></span></code></pre></div><p>源文件也比较简单：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#75715e>// private const val URL = &#34;http://cn.bing.com/az/hprichbg/rb/Dongdaemun_ZH-CN10736487148_1920x1080.jpg&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>Glide.with(<span style=color:#66d9ef>this</span>)
</span></span><span style=display:flex><span>    .load(URL)
</span></span><span style=display:flex><span>    .into(ivGlide1)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Glide.with(<span style=color:#66d9ef>this</span>)
</span></span><span style=display:flex><span>    .load(URL)
</span></span><span style=display:flex><span>    .transform(FitCenter(), Rotate(<span style=color:#ae81ff>180</span>))
</span></span><span style=display:flex><span>    .into(ivGlide2)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Glide.with(<span style=color:#66d9ef>this</span>)
</span></span><span style=display:flex><span>    .load(URL)
</span></span><span style=display:flex><span>    .transform(MultiTransformation(FitCenter(), RoundedCorners(<span style=color:#ae81ff>303</span> ushr <span style=color:#ae81ff>1</span>)))
</span></span><span style=display:flex><span>    .into(ivGlide3)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Glide.with(<span style=color:#66d9ef>this</span>)
</span></span><span style=display:flex><span>    .load(URL)
</span></span><span style=display:flex><span>    .transform(CircleCrop())
</span></span><span style=display:flex><span>    .into(ivGlide4)
</span></span></code></pre></div><p>Rotate、RoundedCorners、CircleCrop 效果图如下：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Glide-3/clipboard_20230323_031855.png width=auto alt></p><p>看完图后，这三个 Transformation 的特点一目了然了。注意上面第 2、3 个加载时，因为 ImageView 高度为 wrap_content，所以需要加上 FitCenter，使 Bitmap 的宽高达到我们的预期（图片宽高为 1920<em>1080，ImageView 宽度为 540，因此高度为 (540/1920</em>1080=303.75，转为 int 后为 303)），然后在此基础上进行圆角或圆形处理。</p><p>Glide 使用 map 保存 transformation，所以调用多个 transform 方法，只有最后一个才会生效。如果我们想要使用多个 transformation，可以使用 MultiTransformation 类或者 <code>transforms(Transformation&lt;Bitmap>...)</code> 以及 <code>transform(Transformation&lt;Bitmap>...)</code> 方法。</p><h2 id=自定义-bitmaptransformation>自定义 BitmapTransformation
<a class=anchor href=#%e8%87%aa%e5%ae%9a%e4%b9%89-bitmaptransformation>#</a></h2><p>如果我们想 transform Bitmap，继承 BitmapTransformation 是最好的方式了。BitmapTransformation 为我们处理了一些基础的东西，例如，如果 Transformation 返回了一个新的 Bitmap， BitmapTransformation 将负责提取和回收原始的 Bitmap。</p><p>下面是一个简单的实现：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FillSpace</span> <span style=color:#66d9ef>extends</span> BitmapTransformation <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String ID <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;com.bumptech.glide.transformations.FillSpace&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String ID_BYTES <span style=color:#f92672>=</span> ID<span style=color:#f92672>.</span><span style=color:#a6e22e>getBytes</span><span style=color:#f92672>(</span>STRING_CHARSET_NAME<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Bitmap <span style=color:#a6e22e>transform</span><span style=color:#f92672>(</span>BitmapPool pool<span style=color:#f92672>,</span> Bitmap toTransform<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> outWidth<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> outHeight<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>toTransform<span style=color:#f92672>.</span><span style=color:#a6e22e>getWidth</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> outWidth <span style=color:#f92672>&amp;&amp;</span> toTransform<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeight</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> outHeight<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> toTransform<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Bitmap<span style=color:#f92672>.</span><span style=color:#a6e22e>createScaledBitmap</span><span style=color:#f92672>(</span>toTransform<span style=color:#f92672>,</span> outWidth<span style=color:#f92672>,</span> outHeight<span style=color:#f92672>,</span> <span style=color:#75715e>/*filter=*/</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>Object o<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> o <span style=color:#66d9ef>instanceof</span> FillSpace<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>hashCode</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> ID<span style=color:#f92672>.</span><span style=color:#a6e22e>hashCode</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>updateDiskCacheKey</span><span style=color:#f92672>(</span>MessageDigest messageDigest<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throws</span> UnsupportedEncodingException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      messageDigest<span style=color:#f92672>.</span><span style=color:#a6e22e>update</span><span style=color:#f92672>(</span>ID_BYTES<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>上面的例子虽然简单，但是包含了必须实现的方法：</p><ol><li>transform 是该类存在的意义，作用不言而喻。</li><li>第一个参数 pool，这个是 Glide 中的一个 Bitmap 缓存池，用于对 Bitmap 对象进行重用，否则每次图片变换都重新创建 Bitmap 对象将会非常消耗内存。</li><li>第二个参数 toTransform，这个是原始图片的 Bitmap 对象，我们就是要对它来进行图片变换。</li><li>第三和第四个参数比较简单，分别代表图片变换后的宽度和高度，其实也就是 override() 方法中传入的宽和高的值了。</li><li>equals、hashCode、updateDiskCacheKey 三个方法必须实现，因为磁盘缓存和内存缓存都需要这个。详情可以看之前的分析文章。</li></ol><p>此外，如果自定义的 BitmapTransformation 有构造参数，那么 equals、hashCode、updateDiskCacheKey 三个方法也需要对构造参数做处理。比如 RoundedCorners：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RoundedCorners</span> <span style=color:#66d9ef>extends</span> BitmapTransformation <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String ID <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;com.bumptech.glide.load.resource.bitmap.RoundedCorners&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> ID_BYTES <span style=color:#f92672>=</span> ID<span style=color:#f92672>.</span><span style=color:#a6e22e>getBytes</span><span style=color:#f92672>(</span>CHARSET<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> roundingRadius<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * @param roundingRadius the corner radius (in device-specific pixels).
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * @throws IllegalArgumentException if rounding radius is 0 or less.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RoundedCorners</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> roundingRadius<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Preconditions<span style=color:#f92672>.</span><span style=color:#a6e22e>checkArgument</span><span style=color:#f92672>(</span>roundingRadius <span style=color:#f92672>&gt;</span> 0<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;roundingRadius must be greater than 0.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>roundingRadius</span> <span style=color:#f92672>=</span> roundingRadius<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>protected</span> Bitmap <span style=color:#a6e22e>transform</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>@NonNull</span> BitmapPool pool<span style=color:#f92672>,</span> <span style=color:#a6e22e>@NonNull</span> Bitmap toTransform<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> outWidth<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> outHeight<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> TransformationUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>roundedCorners</span><span style=color:#f92672>(</span>pool<span style=color:#f92672>,</span> toTransform<span style=color:#f92672>,</span> roundingRadius<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>Object o<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>o <span style=color:#66d9ef>instanceof</span> RoundedCorners<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      RoundedCorners other <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>RoundedCorners<span style=color:#f92672>)</span> o<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> roundingRadius <span style=color:#f92672>==</span> other<span style=color:#f92672>.</span><span style=color:#a6e22e>roundingRadius</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>hashCode</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> Util<span style=color:#f92672>.</span><span style=color:#a6e22e>hashCode</span><span style=color:#f92672>(</span>ID<span style=color:#f92672>.</span><span style=color:#a6e22e>hashCode</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>        Util<span style=color:#f92672>.</span><span style=color:#a6e22e>hashCode</span><span style=color:#f92672>(</span>roundingRadius<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>updateDiskCacheKey</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> MessageDigest messageDigest<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    messageDigest<span style=color:#f92672>.</span><span style=color:#a6e22e>update</span><span style=color:#f92672>(</span>ID_BYTES<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> radiusData <span style=color:#f92672>=</span> ByteBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>allocate</span><span style=color:#f92672>(</span>4<span style=color:#f92672>).</span><span style=color:#a6e22e>putInt</span><span style=color:#f92672>(</span>roundingRadius<span style=color:#f92672>).</span><span style=color:#a6e22e>array</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    messageDigest<span style=color:#f92672>.</span><span style=color:#a6e22e>update</span><span style=color:#f92672>(</span>radiusData<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h1 id=appglidemodule>AppGlideModule
<a class=anchor href=#appglidemodule>#</a></h1><p>Glide 之所以强大，另外一个重要的功能就是可以自定义模块，自定义模块功能可以将更改 Glide 配置，替换 Glide 组件等操作独立出来，使得我们能轻松地对 Glide 的各种配置进行自定义，并且又和 Glide 的图片加载逻辑没有任何交集，这也是一种低耦合编程方式的体现。</p><p>需要注意的是，更改 Glide 默认配置应该关注是否会造成性能倒退。</p><h2 id=使用>使用
<a class=anchor href=#%e4%bd%bf%e7%94%a8>#</a></h2><p>首先，使用 kapt 将 compiler 引入到项目中：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>apply plugin: <span style=color:#e6db74>&#39;kotlin-kapt&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dependencies <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  implementation <span style=color:#e6db74>&#39;com.github.bumptech.glide:glide:4.12.0&#39;</span>
</span></span><span style=display:flex><span>  kapt <span style=color:#e6db74>&#39;com.github.bumptech.glide:compiler:4.12.0&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>并且在你的 <code>proguard.cfg</code> 中 keep 住你的 AppGlideModule 实现：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>-keep public class  extends com.bumptech.glide.module.AppGlideModule
</span></span><span style=display:flex><span>-keep class com.bumptech.glide.GeneratedAppGlideModuleImpl
</span></span></code></pre></div><p>接着，新建一个类继承自 AppGlideModule：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#a6e22e>@GlideModule</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyAppGlideModule</span> : AppGlideModule() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>applyOptions</span>(context: Context, builder: GlideBuilder) {
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>isManifestParsingEnabled</span>() = <span style=color:#66d9ef>super</span>.isManifestParsingEnabled()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>registerComponents</span>(context: Context, glide: Glide, registry: Registry) {
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>可以看到，一共有三个方法可以进行重写，它们分别代表什么呢？</p><h3 id=applyoptions>applyOptions
<a class=anchor href=#applyoptions>#</a></h3><p>applyOptions 方法主要用于更改 Glide 默认配置，比如修改硬盘缓存路径、设置 Bitmap 的解码格式、设置 LRUCahce 大小甚至使用自定义 LRUCahce 实现或者自定义磁盘缓存实现等。下面将罗列一些常用的配置选项。</p><h4 id=strong内存缓存memorycachestrong><strong>内存缓存（MemoryCache）</strong>
<a class=anchor href=#strong%e5%86%85%e5%ad%98%e7%bc%93%e5%ad%98memorycachestrong>#</a></h4><p>Glide 使用 LruResourceCache 作为 MemoryCache 接口的一个默认实现，使用固定大小的内存和 LRU 算法。LruResourceCache 的大小由 Glide 的 MemorySizeCalculator 类来决定，这个类主要关注设备的内存类型，设备 RAM 大小，以及屏幕分辨率。</p><p>使用 applyOptions(Context, GlideBuilder) 方法配置 MemorySizeCalculator 可以自定义 MemoryCache 的大小：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>applyOptions</span>(context: Context, builder: GlideBuilder) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> calculator = MemorySizeCalculator.Builder(context)
</span></span><span style=display:flex><span>        .setMemoryCacheScreens(<span style=color:#ae81ff>2f</span>)
</span></span><span style=display:flex><span>        .build()
</span></span><span style=display:flex><span>    builder.setMemoryCache(LruResourceCache(calculator.memoryCacheSize.toLong()))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>也可以直接覆写缓存大小：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>applyOptions</span>(context: Context, builder: GlideBuilder) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> memoryCacheSizeBytes = <span style=color:#ae81ff>1024</span> * <span style=color:#ae81ff>1024</span> * <span style=color:#ae81ff>20</span> <span style=color:#75715e>// 20mb
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    builder.setMemoryCache(LruResourceCache(memoryCacheSizeBytes.toLong()))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>甚至可以提供自己的 MemoryCache 实现：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>override</span> fun applyOptions<span style=color:#f92672>(</span>context<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Context</span><span style=color:#f92672>,</span> builder<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>GlideBuilder</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    builder<span style=color:#f92672>.</span>setMemoryCache<span style=color:#f92672>(</span><span style=color:#a6e22e>YourAppMemoryCacheImpl</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=strongbitmappoolstrong><strong>BitmapPool</strong>
<a class=anchor href=#strongbitmappoolstrong>#</a></h4><p>Glide 使用 LruBitmapPool 作为默认的 BitmapPool 。LruBitmapPool 是一个内存中的固定大小的 BitmapPool，使用 LRU 算法清理。默认大小基于设备的分辨率和密度，同时也考虑内存类和 isLowRamDevice 的返回值。具体的计算通过 Glide 的 MemorySizeCalculator 来完成，与 Glide 的 MemoryCache 的大小检测方法相似。</p><p>可以在 AppGlideModule 中定制 BitmapPool 的尺寸，使用 applyOptions(Context, GlideBuilder) 方法并配置 MemorySizeCalculator:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>applyOptions</span>(context: Context, builder: GlideBuilder) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> calculator = MemorySizeCalculator.Builder(context)
</span></span><span style=display:flex><span>        .setBitmapPoolScreens(<span style=color:#ae81ff>3f</span>)
</span></span><span style=display:flex><span>        .build()
</span></span><span style=display:flex><span>    builder.setBitmapPool(LruBitmapPool(calculator.bitmapPoolSize.toLong()))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>也可以直接复写这个池的大小：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>applyOptions</span>(context: Context, builder: GlideBuilder) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> bitmapPoolSizeBytes = <span style=color:#ae81ff>1024</span> * <span style=color:#ae81ff>1024</span> * <span style=color:#ae81ff>30</span> <span style=color:#75715e>// 30mb
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    builder.setBitmapPool(LruBitmapPool(bitmapPoolSizeBytes.toLong()))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>当然也可以提供 BitmapPool 的完全自定义实现：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>override</span> fun applyOptions<span style=color:#f92672>(</span>context<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Context</span><span style=color:#f92672>,</span> builder<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>GlideBuilder</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    builder<span style=color:#f92672>.</span>setBitmapPool<span style=color:#f92672>(</span><span style=color:#a6e22e>YourAppBitmapPoolImpl</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=strong磁盘缓存diskcachestrong><strong>磁盘缓存（DiskCache）</strong>
<a class=anchor href=#strong%e7%a3%81%e7%9b%98%e7%bc%93%e5%ad%98diskcachestrong>#</a></h4><p>Glide 使用 DiskLruCacheWrapper 作为默认的 磁盘缓存 。 DiskLruCacheWrapper 是一个使用 LRU 算法的固定大小的磁盘缓存。默认磁盘大小为 250 MB ，位置是在应用的缓存文件夹中的一个特定目录（<em>/data/data/{package}/cache/image_manager_disk_cache/</em>） 。</p><p>假如使用 Glide 展示图片内容是公开的，那么应用可以将这个缓存位置改到外部存储：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>applyOptions</span>(context: Context, builder: GlideBuilder) {
</span></span><span style=display:flex><span>    builder.setDiskCache(ExternalPreferredCacheDiskCacheFactory(context))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>无论使用内部或外部磁盘缓存，应用程序都可以改变磁盘缓存的大小：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>applyOptions</span>(context: Context, builder: GlideBuilder) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> diskCacheSizeBytes = <span style=color:#ae81ff>1024</span> * <span style=color:#ae81ff>1024</span> * <span style=color:#ae81ff>100</span>;  <span style=color:#75715e>//100 MB
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    builder.setDiskCache(ExternalPreferredCacheDiskCacheFactory(context,
</span></span><span style=display:flex><span>         diskCacheSizeBytes.toLong()))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>还可以自己命名外存或内存上的缓存文件夹：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>applyOptions</span>(context: Context, builder: GlideBuilder) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> diskCacheSizeBytes = <span style=color:#ae81ff>1024</span> * <span style=color:#ae81ff>1024</span> * <span style=color:#ae81ff>100</span>;  <span style=color:#75715e>//100 MB
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    builder.setDiskCache(InternalCacheDiskCacheFactory(context, 
</span></span><span style=display:flex><span>        cacheFolderName, diskCacheSizeBytes.toLong()))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>此外，还可以自定义 DiskCache 接口的实现，并提供自己的 DiskCache.Factory 来创建缓存。Glide 使用一个工厂接口来在后台线程中打开磁盘缓存 ，这样方便缓存做诸如检查路径存在性等的 IO 操作而不用触发严格模式（StrictMode） 。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>applyOptions</span>(context: Context, builder: GlideBuilder) {
</span></span><span style=display:flex><span>    builder.setDiskCache(DiskCache.Factory { YourAppCustomDiskCache() })
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=strong默认请求选项defaultrequestoptionsstrong><strong>默认请求选项（DefaultRequestOptions）</strong>
<a class=anchor href=#strong%e9%bb%98%e8%ae%a4%e8%af%b7%e6%b1%82%e9%80%89%e9%a1%b9defaultrequestoptionsstrong>#</a></h4><p>虽然 RequestOptions<strong> </strong>通常由每个请求单独指定，也可以通过 AppGlideModule 应用一个 RequestOptions 的集合以作用于每次请求，比如设置 Bitmap 的解码格式为 RGB_565 (默认为 ARGB_8888)：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>applyOptions</span>(context: Context, builder: GlideBuilder) {
</span></span><span style=display:flex><span>    builder.setDefaultRequestOptions(
</span></span><span style=display:flex><span>        RequestOptions()
</span></span><span style=display:flex><span>            .format(DecodeFormat.PREFER_RGB_565)
</span></span><span style=display:flex><span>            .disallowHardwareConfig()
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>一旦创建了新的请求，这些选项将通过 GlideBuilder 中的 setDefaultRequestOptions 被应用上。因此，任何单独请求里应用的选项将覆盖 GlideBuilder 里设置的冲突选项。</p><p>类似地，RequestManagers 允许你为这个特定的 RequestManager 启动的所有加载请求设置默认的 RequestOptions。 因为每个 Activity 和 Fragment 都拥有自己的 RequestManager，你可以使用 RequestManager 的 applyDefaultRequestOptions 方法来设置默认的 RequestOption，并仅作用于一个特定的 Activity 或 Fragment：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>Glide.with(fragment)
</span></span><span style=display:flex><span>    .applyDefaultRequestOptions(
</span></span><span style=display:flex><span>        RequestOptions()
</span></span><span style=display:flex><span>            .format(DecodeFormat.PREFER_RGB_565)
</span></span><span style=display:flex><span>            .disallowHardwareConfig()
</span></span><span style=display:flex><span>    )
</span></span></code></pre></div><p>RequestManager 还有一个 setDefaultRequestOptions 方法，可以完全替换掉之前设置的任意的默认 RequestOptions，无论它是通过 AppGlideModule 的 [GlideBuilder] 还是 RequestManager。使用 [setDefaultRequestOptions] 要小心，因为很容易意外覆盖掉其他地方设置的重要默认选项。 通常 applyDefaultRequestOptions 更安全，使用起来更直观。</p><h4 id=strong未捕获异常策略-uncaughtthrowablestrategystrong><strong>未捕获异常策略 (UncaughtThrowableStrategy)</strong>
<a class=anchor href=#strong%e6%9c%aa%e6%8d%95%e8%8e%b7%e5%bc%82%e5%b8%b8%e7%ad%96%e7%95%a5-uncaughtthrowablestrategystrong>#</a></h4><p>在加载图片时假如发生了一个异常 (例如, OOM), Glide 将会使用一个 GlideExecutor.UncaughtThrowableStrategy 。</p><p>默认策略是将异常打印到设备的 LogCat 中。 这个策略从 Glide 4.2.0 起将可被定制。 你可以传入一个 DiskCacheExecutor 和 / 或一个 SourceExecutor：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>applyOptions</span>(context: Context, builder: GlideBuilder) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> myUncaughtThrowableStrategy = UncaughtThrowableStrategy.LOG
</span></span><span style=display:flex><span>    builder.setDiskCacheExecutor(GlideExecutor.newDiskCacheBuilder()
</span></span><span style=display:flex><span>        .setUncaughtThrowableStrategy { myUncaughtThrowableStrategy }
</span></span><span style=display:flex><span>        .build())
</span></span><span style=display:flex><span>    builder.setSourceExecutor(GlideExecutor.newSourceBuilder()
</span></span><span style=display:flex><span>        .setUncaughtThrowableStrategy { myUncaughtThrowableStrategy }
</span></span><span style=display:flex><span>        .build())
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=strong日志级别loglevel-strong><strong>日志级别（LogLevel ）</strong>
<a class=anchor href=#strong%e6%97%a5%e5%bf%97%e7%ba%a7%e5%88%abloglevel-strong>#</a></h4><p>可以使用 setLogLevel (结合 Android 的 Log 定义的值) 来获取格式化日志的子集，包括请求失败时的日志行。通常来说 Log.VERBOSE 粒度太细，而 Log.ERROR 又会让日志更趋向静默。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>applyOptions</span>(context: Context, builder: GlideBuilder) {
</span></span><span style=display:flex><span>    builder.setLogLevel(Log.DEBUG)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>所有的配置选项如下</p><table><thead><tr><th>方法</th><th>作用</th></tr></thead><tbody><tr><td>setBitmapPool</td><td></td></tr><tr><td>setArrayPool</td><td></td></tr><tr><td>setMemoryCache</td><td></td></tr><tr><td>setDiskCache</td><td></td></tr><tr><td>setResizeExecutor</td><td></td></tr><tr><td>setSourceExecutor</td><td></td></tr><tr><td>setDiskCacheExecutor</td><td></td></tr><tr><td>setAnimationExecutor</td><td></td></tr><tr><td>setDefaultRequestOptions</td><td></td></tr><tr><td>setDefaultTransitionOptions</td><td></td></tr><tr><td>setMemorySizeCalculator</td><td></td></tr><tr><td>setConnectivityMonitorFactory</td><td></td></tr><tr><td>setLogLevel</td><td></td></tr><tr><td>setIsActiveResourceRetentionAllowed</td><td></td></tr><tr><td>addGlobalRequestListener</td><td></td></tr><tr><td>setLogRequestOrigins</td><td></td></tr><tr><td>setImageDecoderEnabledForBitmaps</td><td></td></tr></tbody></table><h3 id=ismanifestparsingenabled>isManifestParsingEnabled
<a class=anchor href=#ismanifestparsingenabled>#</a></h3><p>在 Glide v3 中，使用自定义模块需要在 AndroidManifest.xml 文件中通过 meta-data 进行配置：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;application</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>...</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;meta-data</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:name=</span><span style=color:#e6db74>&#34;xxx.xxx.MyGlideModule&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>android:value=</span><span style=color:#e6db74>&#34;GlideModule&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;activity</span> <span style=color:#960050;background-color:#1e0010>...</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/application&gt;</span>
</span></span></code></pre></div><p>MyGlideModule 代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyGlideModule</span> : GlideModule {
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>applyOptions</span>(context: Context, builder: GlideBuilder) {
</span></span><span style=display:flex><span>       <span style=color:#f92672>..</span>.
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>registerComponents</span>(context: Context, glide: Glide, registry: Registry) {
</span></span><span style=display:flex><span>       <span style=color:#f92672>..</span>.
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>为了维持对 Glide v3 的 GlideModules 的向后兼容性，Glide 仍然会解析应用程序和所有被包含的库中的 AndroidManifest.xml 文件，并包含在这些清单中列出的旧 GlideModules 模块类。</p><p>如果你已经迁移到 Glide v4 的 AppGlideModule 和 LibraryGlideModule ，你可以完全禁用清单解析。这样可以改善 Glide 的初始启动时间，并避免尝试解析元数据时的一些潜在问题。要禁用清单解析，可以在 AppGlideModule 实现中复写 isManifestParsingEnabled() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>isManifestParsingEnabled</span>() = <span style=color:#66d9ef>false</span>
</span></span></code></pre></div><h3 id=registercomponents>registerComponents
<a class=anchor href=#registercomponents>#</a></h3><p>应用程序和库都可以注册很多组件来扩展 Glide 的功能。可用的组件包括：</p><ol><li>ModelLoader, 用于加载自定义的 Model(Url, Uri,任意的 POJO ) 和 Data(InputStreams, FileDescriptors)。</li><li>ResourceDecoder, 用于对新的 Resources(Drawables, Bitmaps) 或新的 Data 类型 (InputStreams, FileDescriptors) 进行解码。</li><li>Encoder, 用于向 Glide 的磁盘缓存写 Data (InputStreams, FileDesciptors)。</li><li>ResourceTranscoder，用于在不同的资源类型之间做转换，例如，从 BitmapResource 转换为 DrawableResource 。</li><li>ResourceEncoder，用于向 Glide 的磁盘缓存写 Resources(BitmapResource, DrawableResource)。</li></ol><p>组件通过 Registry 类来注册。例如，添加一个 ModelLoader ，使其能从自定义的 Model 对象中创建一个 InputStream ：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>registerComponents</span>(context: Context, glide: Glide, registry: Registry) {
</span></span><span style=display:flex><span>    registry.append(Photo<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java, InputStream<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java, Factory())
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在一个 GlideModule 里可以注册很多组件。ModelLoader 和 ResourceDecoder 对于同样的参数类型还可以有多种实现。</p><p>在前文的分析中知道了，Glide 加载网络图片默认使用的是 HttpUrlConnection，如果想把这个位置的实现替换成 OkHttp3 或者 Volley 实现可以吗？显然是可以的，而且官方也提供了这个功能：</p><ul><li><a href=http://bumptech.github.io/glide/int/okhttp3.html rel=noopener>OkHttp3</a></li><li><a href=http://bumptech.github.io/glide/int/volley.html rel=noopener>Volley</a></li></ul><p>以 OkHttp3 为例，用起来很简单，只需要集成一个 library 即可，非常符合 Glide 的风格。build.gradle 的配置如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>implementation <span style=color:#e6db74>&#34;com.github.bumptech.glide:okhttp3-integration:4.12.0&#34;</span>
</span></span></code></pre></div><p>首先找到里面的 @GlideModule 修饰的类，而且应该是一个 LibraryGlideModule 类：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#a6e22e>@GlideModule</span>
</span></span><span style=display:flex><span>public <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OkHttpLibraryGlideModule</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>LibraryGlideModule</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  public void registerComponents<span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> <span style=color:#a6e22e>Context</span> context<span style=color:#f92672>,</span> <span style=color:#a6e22e>@NonNull</span> <span style=color:#a6e22e>Glide</span> glide<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>@NonNull</span> <span style=color:#a6e22e>Registry</span> registry<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    registry<span style=color:#f92672>.</span>replace<span style=color:#f92672>(</span><span style=color:#a6e22e>GlideUrl</span><span style=color:#f92672>.</span>class<span style=color:#f92672>,</span> <span style=color:#a6e22e>InputStream</span><span style=color:#f92672>.</span>class<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>OkHttpUrlLoader</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>此外，里面还发现了一个实现了 com.bumptech.glide.module.GlideModule 接口的废弃类 OkHttpGlideModule：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Deprecated</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OkHttpGlideModule</span> <span style=color:#66d9ef>implements</span> com<span style=color:#f92672>.</span><span style=color:#a6e22e>bumptech</span><span style=color:#f92672>.</span><span style=color:#a6e22e>glide</span><span style=color:#f92672>.</span><span style=color:#a6e22e>module</span><span style=color:#f92672>.</span><span style=color:#a6e22e>GlideModule</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>applyOptions</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Context context<span style=color:#f92672>,</span> <span style=color:#a6e22e>@NonNull</span> GlideBuilder builder<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Do nothing.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>registerComponents</span><span style=color:#f92672>(</span>Context context<span style=color:#f92672>,</span> Glide glide<span style=color:#f92672>,</span> Registry registry<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    registry<span style=color:#f92672>.</span><span style=color:#a6e22e>replace</span><span style=color:#f92672>(</span>GlideUrl<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> InputStream<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> OkHttpUrlLoader<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>由于我们使用的 Glide 版本为 4.x，使用了上面的 OkHttpLibraryGlideModule 并且无需在 AndroidManifest.xml 中配置，自然也用不到这个类。</p><p>回到 OkHttpLibraryGlideModule 类中，看看 registerComponents 方法的实现：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>registry<span style=color:#f92672>.</span><span style=color:#a6e22e>replace</span><span style=color:#f92672>(</span>GlideUrl<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> InputStream<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>new</span> OkHttpUrlLoader<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span><span style=color:#f92672>());</span>
</span></span></code></pre></div><p>对于此项，Glide 的默认配置中有如下代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>.</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span>GlideUrl<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> InputStream<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> 
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> HttpGlideUrlLoader<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span><span style=color:#f92672>())</span>
</span></span></code></pre></div><p>所以可以理解为，原本交给 HttpGlideUrlLoader.Factory() 处理的任务会交给 OkHttpUrlLoader.Factory() 处理。</p><p><strong>OkHttpUrlLoader</strong> 源码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OkHttpUrlLoader</span> <span style=color:#66d9ef>implements</span> ModelLoader<span style=color:#f92672>&lt;</span>GlideUrl<span style=color:#f92672>,</span> InputStream<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Call<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span> client<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Public API.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;WeakerAccess&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>OkHttpUrlLoader</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Call<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span> client<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>client</span> <span style=color:#f92672>=</span> client<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>handles</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> GlideUrl url<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> LoadData<span style=color:#f92672>&lt;</span>InputStream<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>buildLoadData</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>@NonNull</span> GlideUrl model<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> width<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> height<span style=color:#f92672>,</span> <span style=color:#a6e22e>@NonNull</span> Options options<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> LoadData<span style=color:#f92672>&lt;&gt;(</span>model<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> OkHttpStreamFetcher<span style=color:#f92672>(</span>client<span style=color:#f92672>,</span> model<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/** The default factory for {@link OkHttpUrlLoader}s. */</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Public API.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;WeakerAccess&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Factory</span> <span style=color:#66d9ef>implements</span> ModelLoaderFactory<span style=color:#f92672>&lt;</span>GlideUrl<span style=color:#f92672>,</span> InputStream<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>volatile</span> Call<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span> internalClient<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Call<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span> client<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> Call<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span> <span style=color:#a6e22e>getInternalClient</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>internalClient <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span>Factory<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>internalClient <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            internalClient <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> OkHttpClient<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> internalClient<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** Constructor for a new Factory that runs requests using a static singleton client. */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Factory</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>(</span>getInternalClient<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Constructor for a new Factory that runs requests using given client.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param client this is typically an instance of {@code OkHttpClient}.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Factory</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Call<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span> client<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>client</span> <span style=color:#f92672>=</span> client<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> ModelLoader<span style=color:#f92672>&lt;</span>GlideUrl<span style=color:#f92672>,</span> InputStream<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>build</span><span style=color:#f92672>(</span>MultiModelLoaderFactory multiFactory<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> OkHttpUrlLoader<span style=color:#f92672>(</span>client<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>teardown</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Do nothing, this instance doesn&#39;t own the client.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到，OkHttpUrlLoader.Factory 的无参构造器会使用 DCL 单例模式创建一个 OkHttpClient() 对象，其 build 方法会返回一个 new OkHttpUrlLoader(client)。</p><p>OkHttpUrlLoader.buildLoadData 方法会返回一个 fetcher 为 <strong>OkHttpStreamFetcher</strong> 的 LoadData。当需要进行加载的时候，会调用 fetcher 的 loadData 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>loadData</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Priority priority<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NonNull</span> <span style=color:#66d9ef>final</span> DataCallback<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>super</span> InputStream<span style=color:#f92672>&gt;</span> callback<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Request<span style=color:#f92672>.</span><span style=color:#a6e22e>Builder</span> requestBuilder <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Request<span style=color:#f92672>.</span><span style=color:#a6e22e>Builder</span><span style=color:#f92672>().</span><span style=color:#a6e22e>url</span><span style=color:#f92672>(</span>url<span style=color:#f92672>.</span><span style=color:#a6e22e>toStringUrl</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Map<span style=color:#f92672>.</span><span style=color:#a6e22e>Entry</span><span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> headerEntry <span style=color:#f92672>:</span> url<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeaders</span><span style=color:#f92672>().</span><span style=color:#a6e22e>entrySet</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        String key <span style=color:#f92672>=</span> headerEntry<span style=color:#f92672>.</span><span style=color:#a6e22e>getKey</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        requestBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>addHeader</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> headerEntry<span style=color:#f92672>.</span><span style=color:#a6e22e>getValue</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    Request request <span style=color:#f92672>=</span> requestBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>callback</span> <span style=color:#f92672>=</span> callback<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    call <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span><span style=color:#a6e22e>newCall</span><span style=color:#f92672>(</span>request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    call<span style=color:#f92672>.</span><span style=color:#a6e22e>enqueue</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onFailure</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Call call<span style=color:#f92672>,</span> <span style=color:#a6e22e>@NonNull</span> IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Log<span style=color:#f92672>.</span><span style=color:#a6e22e>isLoggable</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> Log<span style=color:#f92672>.</span><span style=color:#a6e22e>DEBUG</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Log<span style=color:#f92672>.</span><span style=color:#a6e22e>d</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;OkHttp failed to obtain result&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    callback<span style=color:#f92672>.</span><span style=color:#a6e22e>onLoadFailed</span><span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onResponse</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Call call<span style=color:#f92672>,</span> <span style=color:#a6e22e>@NonNull</span> Response response<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    responseBody <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>response<span style=color:#f92672>.</span><span style=color:#a6e22e>isSuccessful</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> contentLength <span style=color:#f92672>=</span> Preconditions<span style=color:#f92672>.</span><span style=color:#a6e22e>checkNotNull</span><span style=color:#f92672>(</span>responseBody<span style=color:#f92672>).</span><span style=color:#a6e22e>contentLength</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        stream <span style=color:#f92672>=</span> ContentLengthInputStream<span style=color:#f92672>.</span><span style=color:#a6e22e>obtain</span><span style=color:#f92672>(</span>responseBody<span style=color:#f92672>.</span><span style=color:#a6e22e>byteStream</span><span style=color:#f92672>(),</span> contentLength<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        callback<span style=color:#f92672>.</span><span style=color:#a6e22e>onDataReady</span><span style=color:#f92672>(</span>stream<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        callback<span style=color:#f92672>.</span><span style=color:#a6e22e>onLoadFailed</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> HttpException<span style=color:#f92672>(</span>response<span style=color:#f92672>.</span><span style=color:#a6e22e>message</span><span style=color:#f92672>(),</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>code</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>OkHttpStreamFetcher 的实现比 HttpUrlFetcher 简单多了，而且看起来也没有什么难度。</p><p>如果我们想使用 App 现有的 OkHttpClient 而不是默认创建一个新的，我们可以先 @Excludes 掉 OkHttpLibraryGlideModule；然后在 replace 的同时，在 OkHttpUrlLoader.Factory(Call.Factory) 构造时注入现有的 OkHttpClient：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#a6e22e>@GlideModule</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Excludes</span>(value = [OkHttpLibraryGlideModule<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>, MyLibraryGlideModule<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>, MyGlideModule<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyAppGlideModule</span> : AppGlideModule() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>applyOptions</span>(context: Context, builder: GlideBuilder) {
</span></span><span style=display:flex><span>        builder.setDiskCache(ExternalPreferredCacheDiskCacheFactory(context))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>registerComponents</span>(context: Context, glide: Glide, registry: Registry) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>val</span> okHttpClient = OkHttpClient.Builder()
</span></span><span style=display:flex><span>            .connectTimeout(<span style=color:#ae81ff>10</span>, TimeUnit.SECONDS)
</span></span><span style=display:flex><span>            .readTimeout(<span style=color:#ae81ff>30</span>, TimeUnit.SECONDS)
</span></span><span style=display:flex><span>            .writeTimeout(<span style=color:#ae81ff>30</span>, TimeUnit.SECONDS)
</span></span><span style=display:flex><span>            .addNetworkInterceptor(
</span></span><span style=display:flex><span>                HttpLoggingInterceptor {
</span></span><span style=display:flex><span>                    Log.i(<span style=color:#e6db74>&#34;MyAppGlideModule&#34;</span>, <span style=color:#66d9ef>it</span>)
</span></span><span style=display:flex><span>                }.apply {
</span></span><span style=display:flex><span>                    level = HttpLoggingInterceptor.Level.BODY
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            ).build()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        registry.replace(GlideUrl<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java, InputStream<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java,
</span></span><span style=display:flex><span>             OkHttpUrlLoader.Factory(okHttpClient))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=原理>原理
<a class=anchor href=#%e5%8e%9f%e7%90%86>#</a></h2><h3 id=glide-初始化流程分析>Glide 初始化流程分析
<a class=anchor href=#glide-%e5%88%9d%e5%a7%8b%e5%8c%96%e6%b5%81%e7%a8%8b%e5%88%86%e6%9e%90>#</a></h3><p>之前在分析
<a href=https://ywue4d2ujm.feishu.cn/docs/doccnY69t6P4JXuanj2oz8GBp5g rel=noopener>Glide 加载流程</a> 的文章中已经知道，with 方法调用过程中会调用到 Glide.get(context) 方法生成并返回全局 Glide 单例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> Glide <span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Context context<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>glide <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果有配置 @GlideModule 注解的 Module
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 这里会反射构造 kapt 生成的 GeneratedAppGlideModuleImpl 类
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    GeneratedAppGlideModule annotationGeneratedModule <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        getAnnotationGeneratedGlideModules<span style=color:#f92672>(</span>context<span style=color:#f92672>.</span><span style=color:#a6e22e>getApplicationContext</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span>Glide<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>glide <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        checkAndInitializeGlide<span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> annotationGeneratedModule<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> glide<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GuardedBy</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Glide.class&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>checkAndInitializeGlide</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Context context<span style=color:#f92672>,</span> <span style=color:#a6e22e>@Nullable</span> GeneratedAppGlideModule generatedAppGlideModule<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isInitializing<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;You cannot call Glide.get() in registerComponents(), use the provided Glide instance instead&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        isInitializing <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        initializeGlide<span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> generatedAppGlideModule<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        isInitializing <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>initializeGlide</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Context context<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  initializeGlide<span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> GlideBuilder<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>initializeGlide</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NonNull</span> Context context<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NonNull</span> GlideBuilder builder<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Nullable</span> GeneratedAppGlideModule annotationGeneratedModule<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  Context applicationContext <span style=color:#f92672>=</span> context<span style=color:#f92672>.</span><span style=color:#a6e22e>getApplicationContext</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 如果 GeneratedAppGlideModuleImpl 存在，且允许解析 manifest 文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// 则遍历 manifest 中的 meta-data，解析出所有的 GlideModule 类
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  List<span style=color:#f92672>&lt;</span>com<span style=color:#f92672>.</span><span style=color:#a6e22e>bumptech</span><span style=color:#f92672>.</span><span style=color:#a6e22e>glide</span><span style=color:#f92672>.</span><span style=color:#a6e22e>module</span><span style=color:#f92672>.</span><span style=color:#a6e22e>GlideModule</span><span style=color:#f92672>&gt;</span> manifestModules <span style=color:#f92672>=</span> Collections<span style=color:#f92672>.</span><span style=color:#a6e22e>emptyList</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>annotationGeneratedModule <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> annotationGeneratedModule<span style=color:#f92672>.</span><span style=color:#a6e22e>isManifestParsingEnabled</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    manifestModules <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ManifestParser<span style=color:#f92672>(</span>applicationContext<span style=color:#f92672>).</span><span style=color:#a6e22e>parse</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 根据 Impl 的排除名单，剔除 manifest 中的 GlideModule 类
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>annotationGeneratedModule <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>annotationGeneratedModule<span style=color:#f92672>.</span><span style=color:#a6e22e>getExcludedModuleClasses</span><span style=color:#f92672>().</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Set<span style=color:#f92672>&lt;</span>Class<span style=color:#f92672>&lt;?&gt;&gt;</span> excludedModuleClasses <span style=color:#f92672>=</span> annotationGeneratedModule<span style=color:#f92672>.</span><span style=color:#a6e22e>getExcludedModuleClasses</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    Iterator<span style=color:#f92672>&lt;</span>com<span style=color:#f92672>.</span><span style=color:#a6e22e>bumptech</span><span style=color:#f92672>.</span><span style=color:#a6e22e>glide</span><span style=color:#f92672>.</span><span style=color:#a6e22e>module</span><span style=color:#f92672>.</span><span style=color:#a6e22e>GlideModule</span><span style=color:#f92672>&gt;</span> iterator <span style=color:#f92672>=</span> manifestModules<span style=color:#f92672>.</span><span style=color:#a6e22e>iterator</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>iterator<span style=color:#f92672>.</span><span style=color:#a6e22e>hasNext</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      com<span style=color:#f92672>.</span><span style=color:#a6e22e>bumptech</span><span style=color:#f92672>.</span><span style=color:#a6e22e>glide</span><span style=color:#f92672>.</span><span style=color:#a6e22e>module</span><span style=color:#f92672>.</span><span style=color:#a6e22e>GlideModule</span> current <span style=color:#f92672>=</span> iterator<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>excludedModuleClasses<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span>current<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>continue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Log<span style=color:#f92672>.</span><span style=color:#a6e22e>isLoggable</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> Log<span style=color:#f92672>.</span><span style=color:#a6e22e>DEBUG</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Log<span style=color:#f92672>.</span><span style=color:#a6e22e>d</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;AppGlideModule excludes manifest GlideModule: &#34;</span> <span style=color:#f92672>+</span> current<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      iterator<span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Log<span style=color:#f92672>.</span><span style=color:#a6e22e>isLoggable</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> Log<span style=color:#f92672>.</span><span style=color:#a6e22e>DEBUG</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>com<span style=color:#f92672>.</span><span style=color:#a6e22e>bumptech</span><span style=color:#f92672>.</span><span style=color:#a6e22e>glide</span><span style=color:#f92672>.</span><span style=color:#a6e22e>module</span><span style=color:#f92672>.</span><span style=color:#a6e22e>GlideModule</span> glideModule <span style=color:#f92672>:</span> manifestModules<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      Log<span style=color:#f92672>.</span><span style=color:#a6e22e>d</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Discovered GlideModule from manifest: &#34;</span> <span style=color:#f92672>+</span> glideModule<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 如果 Impl 存在，那么设置为该类的 RequestManagerFactory；否则设置为 null
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  RequestManagerRetriever<span style=color:#f92672>.</span><span style=color:#a6e22e>RequestManagerFactory</span> factory <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      annotationGeneratedModule <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>?</span> annotationGeneratedModule<span style=color:#f92672>.</span><span style=color:#a6e22e>getRequestManagerFactory</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  builder<span style=color:#f92672>.</span><span style=color:#a6e22e>setRequestManagerFactory</span><span style=color:#f92672>(</span>factory<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 依次调用 manifest 中 GlideModule 类的 applyOptions 方法，将配置写到 builder 里
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>com<span style=color:#f92672>.</span><span style=color:#a6e22e>bumptech</span><span style=color:#f92672>.</span><span style=color:#a6e22e>glide</span><span style=color:#f92672>.</span><span style=color:#a6e22e>module</span><span style=color:#f92672>.</span><span style=color:#a6e22e>GlideModule</span> module <span style=color:#f92672>:</span> manifestModules<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    module<span style=color:#f92672>.</span><span style=color:#a6e22e>applyOptions</span><span style=color:#f92672>(</span>applicationContext<span style=color:#f92672>,</span> builder<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 写入 Impl 的配置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// 也就是说 Impl 配置的优先级更高，如果有冲突的话
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>annotationGeneratedModule <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    annotationGeneratedModule<span style=color:#f92672>.</span><span style=color:#a6e22e>applyOptions</span><span style=color:#f92672>(</span>applicationContext<span style=color:#f92672>,</span> builder<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 调用GlideBuilder.build方法创建 Glide
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Glide glide <span style=color:#f92672>=</span> builder<span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>(</span>applicationContext<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 依次调用 manifest 中 GlideModule 类的 registerComponents 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// 来替换 Glide 的默认配置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>com<span style=color:#f92672>.</span><span style=color:#a6e22e>bumptech</span><span style=color:#f92672>.</span><span style=color:#a6e22e>glide</span><span style=color:#f92672>.</span><span style=color:#a6e22e>module</span><span style=color:#f92672>.</span><span style=color:#a6e22e>GlideModule</span> module <span style=color:#f92672>:</span> manifestModules<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      module<span style=color:#f92672>.</span><span style=color:#a6e22e>registerComponents</span><span style=color:#f92672>(</span>applicationContext<span style=color:#f92672>,</span> glide<span style=color:#f92672>,</span> glide<span style=color:#f92672>.</span><span style=color:#a6e22e>registry</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>AbstractMethodError e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;Attempting to register a Glide v3 module. If you see this, you or one of your&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; dependencies may be including Glide v3 even though you&#39;re using Glide v4.&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; You&#39;ll need to find and remove (or update) the offending dependency.&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; The v3 module name is: &#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>+</span> module<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>          e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 调用 Impl 中替换 Glide 配置的方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>annotationGeneratedModule <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    annotationGeneratedModule<span style=color:#f92672>.</span><span style=color:#a6e22e>registerComponents</span><span style=color:#f92672>(</span>applicationContext<span style=color:#f92672>,</span> glide<span style=color:#f92672>,</span> glide<span style=color:#f92672>.</span><span style=color:#a6e22e>registry</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 注册内存管理的回调，因为 Glide 实现了 ComponentCallbacks2 接口
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  applicationContext<span style=color:#f92672>.</span><span style=color:#a6e22e>registerComponentCallbacks</span><span style=color:#f92672>(</span>glide<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 保存 glide 实例到静态变量中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Glide<span style=color:#f92672>.</span><span style=color:#a6e22e>glide</span> <span style=color:#f92672>=</span> glide<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到，这里首先会调用 getAnnotationGeneratedGlideModules() 方法反射构造出注解处理器生成的 GeneratedAppGlideModuleImpl 对象。</p><p>接着，Glide 的创建（line 84）发生在 applyOptions 之后，registerComponents 之前。也好理解，因为 applyOptions 是更改配置，肯定是初始化时就要确定的；而 registerComponents 针对的运行时的功能扩展，而且需要调用 Glide 对象的方法，所以在 Glide 创建之后调用。</p><p>看看 GlideBuilder.build 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>Glide <span style=color:#a6e22e>build</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Context context<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>sourceExecutor <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    sourceExecutor <span style=color:#f92672>=</span> GlideExecutor<span style=color:#f92672>.</span><span style=color:#a6e22e>newSourceExecutor</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>diskCacheExecutor <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    diskCacheExecutor <span style=color:#f92672>=</span> GlideExecutor<span style=color:#f92672>.</span><span style=color:#a6e22e>newDiskCacheExecutor</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>animationExecutor <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    animationExecutor <span style=color:#f92672>=</span> GlideExecutor<span style=color:#f92672>.</span><span style=color:#a6e22e>newAnimationExecutor</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>memorySizeCalculator <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    memorySizeCalculator <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> MemorySizeCalculator<span style=color:#f92672>.</span><span style=color:#a6e22e>Builder</span><span style=color:#f92672>(</span>context<span style=color:#f92672>).</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>connectivityMonitorFactory <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    connectivityMonitorFactory <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DefaultConnectivityMonitorFactory<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>bitmapPool <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> size <span style=color:#f92672>=</span> memorySizeCalculator<span style=color:#f92672>.</span><span style=color:#a6e22e>getBitmapPoolSize</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>size <span style=color:#f92672>&gt;</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      bitmapPool <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LruBitmapPool<span style=color:#f92672>(</span>size<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      bitmapPool <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> BitmapPoolAdapter<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>arrayPool <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    arrayPool <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LruArrayPool<span style=color:#f92672>(</span>memorySizeCalculator<span style=color:#f92672>.</span><span style=color:#a6e22e>getArrayPoolSizeInBytes</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>memoryCache <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    memoryCache <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LruResourceCache<span style=color:#f92672>(</span>memorySizeCalculator<span style=color:#f92672>.</span><span style=color:#a6e22e>getMemoryCacheSize</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>diskCacheFactory <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    diskCacheFactory <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> InternalCacheDiskCacheFactory<span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>engine <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    engine <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> Engine<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            memoryCache<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            diskCacheFactory<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            diskCacheExecutor<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            sourceExecutor<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            GlideExecutor<span style=color:#f92672>.</span><span style=color:#a6e22e>newUnlimitedSourceExecutor</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>            animationExecutor<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            isActiveResourceRetentionAllowed<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>defaultRequestListeners <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    defaultRequestListeners <span style=color:#f92672>=</span> Collections<span style=color:#f92672>.</span><span style=color:#a6e22e>emptyList</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    defaultRequestListeners <span style=color:#f92672>=</span> Collections<span style=color:#f92672>.</span><span style=color:#a6e22e>unmodifiableList</span><span style=color:#f92672>(</span>defaultRequestListeners<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  GlideExperiments experiments <span style=color:#f92672>=</span> glideExperimentsBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  RequestManagerRetriever requestManagerRetriever <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>new</span> RequestManagerRetriever<span style=color:#f92672>(</span>requestManagerFactory<span style=color:#f92672>,</span> experiments<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Glide<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>      context<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      engine<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      memoryCache<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      bitmapPool<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      arrayPool<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      requestManagerRetriever<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      connectivityMonitorFactory<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      logLevel<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      defaultRequestOptionsFactory<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      defaultTransitionOptions<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      defaultRequestListeners<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      experiments<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到，build 方法基本对每一个参数都进行了 null 判断，如果为 null 则使用默认的参数。那么，这些参数什么时候不为空呢？当在 AppliesOptions 接口的实现（即前面所说的 applyOptions 方法）中通过传入参数 GlideBuilder 设置后，这里 build 时就不会为 null 了。</p><p>比如，前面举例的通过 GlideBuilder.setDiskCache 来将 diskCacheFactory 设置为我们指定的值，从而将磁盘缓存位置切换到 externalCacheDir 中。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#a6e22e>@GlideModule</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyAppGlideModule</span> : AppGlideModule() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>applyOptions</span>(context: Context, builder: GlideBuilder) {
</span></span><span style=display:flex><span>        builder.setDiskCache(ExternalPreferredCacheDiskCacheFactory(context))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=kapt-生成文件过程分析>kapt 生成文件过程分析
<a class=anchor href=#kapt-%e7%94%9f%e6%88%90%e6%96%87%e4%bb%b6%e8%bf%87%e7%a8%8b%e5%88%86%e6%9e%90>#</a></h3><p>为了更好地理解 Glide 中 annotation processor 的作用，这里分别实现 AppGlideModule、LibraryGlideModule 以及 GlideModule ：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#a6e22e>@GlideModule</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Excludes</span>(value = [MyGlideModule<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyAppGlideModule</span> : AppGlideModule()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GlideModule</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyLibraryGlideModule</span> : LibraryGlideModule()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyGlideModule</span> : GlideModule {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>applyOptions</span>(context: Context, builder: GlideBuilder) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>registerComponents</span>(context: Context, glide: Glide, registry: Registry) {}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在 AndroidManifest 文件中配置好 MyGlideModule 之后，我们先 rebuild 一下，看一下生成的 GeneratedAppGlideModuleImpl 文件：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;deprecation&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>GeneratedAppGlideModuleImpl</span> <span style=color:#66d9ef>extends</span> GeneratedAppGlideModule <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> MyAppGlideModule appGlideModule<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>GeneratedAppGlideModuleImpl</span><span style=color:#f92672>(</span>Context context<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    appGlideModule <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> MyAppGlideModule<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Log<span style=color:#f92672>.</span><span style=color:#a6e22e>isLoggable</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Glide&#34;</span><span style=color:#f92672>,</span> Log<span style=color:#f92672>.</span><span style=color:#a6e22e>DEBUG</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      Log<span style=color:#f92672>.</span><span style=color:#a6e22e>d</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Glide&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Discovered AppGlideModule from annotation: com.me.guanpj.myapplication.MyAppGlideModule&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      Log<span style=color:#f92672>.</span><span style=color:#a6e22e>d</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Glide&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Discovered LibraryGlideModule from annotation: com.me.guanpj.myapplication.MyLibraryGlideModule&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>applyOptions</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Context context<span style=color:#f92672>,</span> <span style=color:#a6e22e>@NonNull</span> GlideBuilder builder<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    appGlideModule<span style=color:#f92672>.</span><span style=color:#a6e22e>applyOptions</span><span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> builder<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>registerComponents</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Context context<span style=color:#f92672>,</span> <span style=color:#a6e22e>@NonNull</span> Glide glide<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>@NonNull</span> Registry registry<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>new</span> MyLibraryGlideModule<span style=color:#f92672>().</span><span style=color:#a6e22e>registerComponents</span><span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> glide<span style=color:#f92672>,</span> registry<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    appGlideModule<span style=color:#f92672>.</span><span style=color:#a6e22e>registerComponents</span><span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> glide<span style=color:#f92672>,</span> registry<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isManifestParsingEnabled</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> appGlideModule<span style=color:#f92672>.</span><span style=color:#a6e22e>isManifestParsingEnabled</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> Set<span style=color:#f92672>&lt;</span>Class<span style=color:#f92672>&lt;?&gt;&gt;</span> getExcludedModuleClasses<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Set<span style=color:#f92672>&lt;</span>Class<span style=color:#f92672>&lt;?&gt;&gt;</span> excludedClasses <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashSet<span style=color:#f92672>&lt;</span>Class<span style=color:#f92672>&lt;?&gt;&gt;();</span>
</span></span><span style=display:flex><span>    excludedClasses<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>com<span style=color:#f92672>.</span><span style=color:#a6e22e>me</span><span style=color:#f92672>.</span><span style=color:#a6e22e>guanpj</span><span style=color:#f92672>.</span><span style=color:#a6e22e>myapplication</span><span style=color:#f92672>.</span><span style=color:#a6e22e>MyGlideModule</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> excludedClasses<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>  GeneratedRequestManagerFactory <span style=color:#a6e22e>getRequestManagerFactory</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> GeneratedRequestManagerFactory<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>代码很简单，属于 AppGlideModule 的三个方法基本都调用了 MyAppGlideModule 的三个配置方法。在此基础上，每个 LibraryGlideModule 的 registerComponents 方法都会在 GeneratedAppGlideModuleImpl.registerComponents 方法中被调用。</p><p>另外，我们关注一下最后两个方法，这两个方法都是基类 GeneratedAppGlideModule 额外提供了的，代码如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>GeneratedAppGlideModule</span> <span style=color:#66d9ef>extends</span> AppGlideModule <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * This method can be removed when manifest parsing is no longer supported.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>abstract</span> Set<span style=color:#f92672>&lt;</span>Class<span style=color:#f92672>&lt;?&gt;&gt;</span> getExcludedModuleClasses<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Nullable</span>
</span></span><span style=display:flex><span>  RequestManagerRetriever<span style=color:#f92672>.</span><span style=color:#a6e22e>RequestManagerFactory</span> <span style=color:#a6e22e>getRequestManagerFactory</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>getRequestManagerFactory 在子类的实现是固定的，就是 return new GeneratedRequestManagerFactory()。</p><h4 id=excludes>@Excludes
<a class=anchor href=#excludes>#</a></h4><p>GeneratedAppGlideModuleImpl.getExcludedModuleClasses() 的实现，与 @Excludes 注解有关，使用该注解可以让 Glide 忽略指定的 GlideModule 或 LibraryGlideModule。@Excludes 注解只能用在 AppGlideModules 上，下面的例子将会让 Glide 忽略掉 MyLibraryGlideModule、MyGlideModule 的配置：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#a6e22e>@GlideModule</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Excludes</span><span style=color:#f92672>(</span>value <span style=color:#66d9ef>=</span> <span style=color:#f92672>[</span><span style=color:#66d9ef>MyLibraryGlideModule::class</span>, <span style=color:#66d9ef>MyGlideModule::class</span><span style=color:#f92672>])</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyAppGlideModule</span> <span style=color:#66d9ef>:</span> <span style=color:#66d9ef>AppGlideModule</span><span style=color:#f92672>()</span>
</span></span></code></pre></div><p>此时 rebuild 之后，生成的 GeneratedAppGlideModuleImpl 文件的相关方法如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>registerComponents</span>(<span style=color:#66d9ef>@NonNull</span> <span style=color:#a6e22e>Context</span> <span style=color:#a6e22e>context</span>, <span style=color:#66d9ef>@NonNull</span> <span style=color:#a6e22e>Glide</span> <span style=color:#a6e22e>glide</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>@NonNull</span> <span style=color:#a6e22e>Registry</span> <span style=color:#a6e22e>registry</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 注意，没有new MyLibraryGlideModule().registerComponents(context, glide, registry);了
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>appGlideModule</span>.<span style=color:#a6e22e>registerComponents</span>(<span style=color:#a6e22e>context</span>, <span style=color:#a6e22e>glide</span>, <span style=color:#a6e22e>registry</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@NonNull</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Set</span>&lt;<span style=color:#f92672>Class</span><span style=color:#960050;background-color:#1e0010>&lt;?</span>&gt;<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getExcludedModuleClasses() {</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Set</span>&lt;<span style=color:#f92672>Class</span><span style=color:#960050;background-color:#1e0010>&lt;?</span>&gt;<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>excludedClasses</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>HashSet</span>&lt;<span style=color:#f92672>Class</span><span style=color:#960050;background-color:#1e0010>&lt;?</span>&gt;<span style=color:#f92672>&gt;</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>excludedClasses</span>.<span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>com</span>.<span style=color:#a6e22e>me</span>.<span style=color:#a6e22e>guanpj</span>.<span style=color:#a6e22e>myapplication</span>.<span style=color:#a6e22e>MyGlideModule</span>.<span style=color:#66d9ef>class</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>excludedClasses</span>.<span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>com</span>.<span style=color:#a6e22e>me</span>.<span style=color:#a6e22e>guanpj</span>.<span style=color:#a6e22e>myapplication</span>. <span style=color:#a6e22e>MyLibraryGlideModule</span>.<span style=color:#66d9ef>class</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>excludedClasses</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>然后在 Glide 初始化的时候，在方法返回结果 set 里面的 GlideModule 将会从集合中移除。</p><h4 id=glideextension>@GlideExtension
<a class=anchor href=#glideextension>#</a></h4><p>@GlideExtension 注解修饰的类可以扩展 Glide 的 API。该类必须是工具类的形式，里面的方法必须都是静态的，除了私有的空实现的构造器。</p><p>Application 可以实现多个 @GlideExtension 注解类，Library 也可以实现任意数量的 @GlideExtension 注解类。Glide 在编译时，一旦发现一个 AppGlideModule，所有可用的 GlideExtension 都会合并，并生成单个的 API 文件。任何冲突都会导致 Glide 注解生成器的编译错误。</p><p>GlideExtension 注解类可以定义两种扩展方法：</p><ol><li>@GlideOption——为 RequestOptions 添加自定义的配置，扩展 RequestOptions 的静态方法。常见作用有：</li><li>定义在整个应用程序中经常使用的一组选项</li><li>添加新选项，通常与 Glide 的 com.bumptech.glide.load.Option 一起使用。</li><li>@GlideType——为新资源类型（GIFs、SVG 等）添加支持，扩展 RequestManager 的静态方法</li></ol><p>下面的示例来自于官方文档 GlideExtension 的示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#a6e22e>@GlideExtension</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>object</span> <span style=color:#a6e22e>MyAppExtension</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Size of mini thumb in pixels.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>val</span> MINI_THUMB_SIZE = <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>val</span> DECODE_TYPE_GIF = RequestOptions.decodeTypeOf(GifDrawable<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java).lock()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GlideOption</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@JvmStatic</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>miniThumb</span>(options: BaseRequestOptions&lt;*&gt;): BaseRequestOptions&lt;*&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> options
</span></span><span style=display:flex><span>            .fitCenter()
</span></span><span style=display:flex><span>            .<span style=color:#66d9ef>override</span>(MINI_THUMB_SIZE)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GlideType</span>(GifDrawable<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@JvmStatic</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>asGifTest</span>(requestBuilder: RequestBuilder&lt;GifDrawable&gt;): RequestBuilder&lt;GifDrawable&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> requestBuilder
</span></span><span style=display:flex><span>            .transition(DrawableTransitionOptions())
</span></span><span style=display:flex><span>            .apply(DECODE_TYPE_GIF)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这里为 RequestOptions 扩展了 miniThumb 方法，为 RequestManager 扩展了 asGifTest 方法。所以我们可以这样使用：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>GlideApp.with(<span style=color:#66d9ef>this</span>)
</span></span><span style=display:flex><span>    .asGifTest()
</span></span><span style=display:flex><span>    .load(URL)
</span></span><span style=display:flex><span>    .miniThumb()
</span></span><span style=display:flex><span>    .into(ivGlide1)
</span></span></code></pre></div><p>注意这里使用的不再是 Glide，而是 GlideApp。GlideApp 是专门用来处理这种扩展 API 的。</p><p>在 Glide 初始化的时候，会将 GeneratedAppGlideModuleImpl.getRequestManagerFactory() 方法返回的 GeneratedRequestManagerFactory 作为 requestManagerFactory 参数，这样创建 RequestManager 时都会调用 GeneratedRequestManagerFactory.build 方法生成 GlideRequests。</p><p><strong>GlideRequests</strong> 继承至 RequestManager，里面包含了 @GlideType 注解修饰的 API：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>GlideRequests</span> <span style=color:#66d9ef>extends</span> RequestManager <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>GlideRequests</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Glide glide<span style=color:#f92672>,</span> <span style=color:#a6e22e>@NonNull</span> Lifecycle lifecycle<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                       <span style=color:#a6e22e>@NonNull</span> RequestManagerTreeNode treeNode<span style=color:#f92672>,</span> <span style=color:#a6e22e>@NonNull</span> Context context<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>glide<span style=color:#f92672>,</span> lifecycle<span style=color:#f92672>,</span> treeNode<span style=color:#f92672>,</span> context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * @see MyAppExtension#asGifTest(RequestBuilder)
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@CheckResult</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> GlideRequest<span style=color:#f92672>&lt;</span>GifDrawable<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>asGifTest</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>GlideRequest<span style=color:#f92672>&lt;</span>GifDrawable<span style=color:#f92672>&gt;)</span> MyAppExtension<span style=color:#f92672>.</span><span style=color:#a6e22e>asGifTest</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>as</span><span style=color:#f92672>(</span>GifDrawable<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><strong>GlideRequest（注意没有 s）</strong> 则继承至 RequestBuilder，包含了 @GlideOption 提供的 API：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>public <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>GlideRequest</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>TranscodeType</span><span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>RequestBuilder</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>TranscodeType</span><span style=color:#f92672>&gt;</span> implements <span style=color:#a6e22e>Cloneable</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * @see MyAppExtension#miniThumb(BaseRequestOptions)
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;unchecked&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@CheckResult</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@NonNull</span>
</span></span><span style=display:flex><span>  public <span style=color:#a6e22e>GlideRequest</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>TranscodeType</span><span style=color:#f92672>&gt;</span> miniThumb<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span><span style=color:#a6e22e>GlideRequest</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>TranscodeType</span><span style=color:#f92672>&gt;)</span> <span style=color:#a6e22e>MyAppExtension</span><span style=color:#f92672>.</span>miniThumb<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>此外，如果需要使用到 RequestOptions，要使用 Generated API 生成的 GlideOptions。</p><p>总的来说，如果想使用 Generated API，注意一下三个类的关系</p><ul><li>RequestManager -> GlideRequests</li><li>RequestBuilder -> GlideRequest</li><li>RequestOptions -> GlideOptions</li></ul><h2 id=实战分析>实战分析
<a class=anchor href=#%e5%ae%9e%e6%88%98%e5%88%86%e6%9e%90>#</a></h2><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://guanpj.github.io/amethyst/quartz/js/graph.cbd78cfa87df7d3e230d16fc24f06548.js></script></div></div><div id=contact_buttons><footer><p>Made with <a href=https://github.com/64bitpandas/amethyst>Amethyst</a>, © 2023 guanpj</p><ul><li><a href=https://guanpj.github.io/amethyst/>Home</a></li><li><a href=https://bencuan.me>Website</a></li><li><a href=https://blog.bencuan.me>Blog</a></li></ul></footer></div></article><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#回调与监听>回调与监听</a><ul><li><a href=#target>Target</a></li><li><a href=#requestbuilder-高级-api>RequestBuilder 高级 API</a><ul><li><a href=#preload>preload</a></li><li><a href=#submit>submit</a></li><li><a href=#downloadonly>downloadOnly</a></li><li><a href=#listeneraddlistener>listener/addListener</a></li></ul></li></ul></li><li><a href=#transform>Transform</a><ul><li><a href=#transform-行为分析>Transform 行为分析</a><ul><li><a href=#场景还原>场景还原</a></li><li><a href=#代码分析>代码分析</a></li></ul></li><li><a href=#glide-自带的-transformation>Glide 自带的 Transformation</a></li><li><a href=#自定义-bitmaptransformation>自定义 BitmapTransformation</a></li></ul></li><li><a href=#appglidemodule>AppGlideModule</a><ul><li><a href=#使用>使用</a><ul><li><a href=#applyoptions>applyOptions</a><ul><li><a href=#strong内存缓存memorycachestrong><strong>内存缓存（MemoryCache）</strong></a></li><li><a href=#strongbitmappoolstrong><strong>BitmapPool</strong></a></li><li><a href=#strong磁盘缓存diskcachestrong><strong>磁盘缓存（DiskCache）</strong></a></li><li><a href=#strong默认请求选项defaultrequestoptionsstrong><strong>默认请求选项（DefaultRequestOptions）</strong></a></li><li><a href=#strong未捕获异常策略-uncaughtthrowablestrategystrong><strong>未捕获异常策略 (UncaughtThrowableStrategy)</strong></a></li><li><a href=#strong日志级别loglevel-strong><strong>日志级别（LogLevel ）</strong></a></li></ul></li><li><a href=#ismanifestparsingenabled>isManifestParsingEnabled</a></li><li><a href=#registercomponents>registerComponents</a></li></ul></li><li><a href=#原理>原理</a><ul><li><a href=#glide-初始化流程分析>Glide 初始化流程分析</a></li><li><a href=#kapt-生成文件过程分析>kapt 生成文件过程分析</a><ul><li><a href=#excludes>@Excludes</a></li><li><a href=#glideextension>@GlideExtension</a></li></ul></li></ul></li><li><a href=#实战分析>实战分析</a></li></ul></li></ul></nav></div></aside></main></body></html>