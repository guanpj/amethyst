<!doctype html><html lang=en dir=ltr><head><meta property="og:title" content="HashMap 源码解析"><meta property="og:description" content="前言 #  HashMap 是 Java 中最常用 K-V 容器，使用哈希值来确定元素存储的位置，HashMap 对 Entry 进行了扩展（Node），使其形成以链表或者树的形式存储在 HashMap 的容器里。
在 Java 8 之前和之后，HashMap 的实现有较大的不同，因此对于 put 流程、扩容机制等主要过程分析将会采用两个版本进行对比。
成员变量 #  HashMap 成员变量和构造方法声明如下（Java 7 和 8 大致相同，以下为 Java 8 版本）：
public class HashMap<K,V> extends AbstractMap<K,V>   implements Map<K,V>, Cloneable, Serializable {   // 初始容量 16  static final int DEFAULT_INITIAL_CAPACITY = 1 << 4; // aka 16   // 最大容量，该数组最大值为2^31一次方。  static final int MAXIMUM_CAPACITY = 1 << 30;   // 默认的加载因子，如果构造的时候不传则为 0."><meta property="og:type" content="article"><meta property="og:url" content="https://guanpj.github.io/amethyst/Knowledge/Java/%E5%9F%BA%E7%A1%80/HashMap-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"><meta property="article:section" content="Knowledge"><meta property="og:site_name" content="guanpj's blog"><title>HashMap 源码解析 | guanpj's blog</title><link rel=manifest href=/amethyst/manifest.json><link rel=icon href=/amethyst/favicon.png type=image/x-icon><link rel=stylesheet href=/amethyst/book.min.c27ff4755c78daab11627953d5a6dd7e2698690e086398032995aae74d6397b6.css integrity="sha256-wn/0dVx42qsRYnlT1abdfiaYaQ4IY5gDKZWq501jl7Y=" crossorigin=anonymous><meta charset=utf-8><meta name=description content="前言 #  HashMap 是 Java 中最常用 K-V 容器，使用哈希值来确定元素存储的位置，HashMap 对 Entry 进行了扩展（Node），使其形成以链表或者树的形式存储在 HashMap 的容器里。
在 Java 8 之前和之后，HashMap 的实现有较大的不同，因此对于 put 流程、扩容机制等主要过程分析将会采用两个版本进行对比。
成员变量 #  HashMap 成员变量和构造方法声明如下（Java 7 和 8 大致相同，以下为 Java 8 版本）：
public class HashMap<K,V> extends AbstractMap<K,V>   implements Map<K,V>, Cloneable, Serializable {   // 初始容量 16  static final int DEFAULT_INITIAL_CAPACITY = 1 << 4; // aka 16   // 最大容量，该数组最大值为2^31一次方。  static final int MAXIMUM_CAPACITY = 1 << 30;   // 默认的加载因子，如果构造的时候不传则为 0."><title>HashMap 源码解析</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://guanpj.github.io/amethyst//favicon.png><link href=https://guanpj.github.io/amethyst/styles.e08ceb33360cec132feb69cfb982e2a4.min.css rel=stylesheet><link href=https://guanpj.github.io/amethyst/quartz/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://guanpj.github.io/amethyst/quartz/js/darkmode.1bc498b60ed24d8858f74f99e480db82.min.js></script>
<script src=https://guanpj.github.io/amethyst/quartz/js/util.c69e233dc1cc331a30b0f670e657b425.min.js></script>
<script async src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script async src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://guanpj.github.io/amethyst/quartz/js/popover.f03552ccb84d99ca615d1cfb9abde59e.min.js></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://guanpj.github.io/amethyst/",fetchData=Promise.all([fetch("https://guanpj.github.io/amethyst/indices/linkIndex.f13ba8f7c67305f3500d259bdfb72f53.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://guanpj.github.io/amethyst/indices/contentIndex.1a908c783dc71dfdcce2d7bedf40efc5.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addCollapsibleCallouts(),initPopover("https://guanpj.github.io/amethyst",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!0;drawGraph("https://guanpj.github.io/amethyst",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script>window.Million={navigate:e=>window.location.href=e,prefetch:()=>{}},window.addEventListener("DOMContentLoaded",()=>{init(),render()})</script></head><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><header class=book-header><label for=menu-control><img src=/amethyst/svg/menu.svg class=book-icon alt=Menu></label><h1 id=page-title><a href=https://guanpj.github.io/amethyst/>guanpj's blog</a></h1><div class=spacer></div><div id=search-icon class=quartz-search><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control><main class=flex><aside class=book-menu><div class=book-menu-content><nav><div class=menu-search><div id=search-icon class=quartz-search><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div></div><ul><li><span class=book-menu-title>Atlas</span><ul><li><a href=/amethyst/Atlas/About-Atlas/>About Atlas</a></li><li><a href=/amethyst/Atlas/Index-for-Atlases/>Index for Atlases</a></li></ul></li><li><span class=book-menu-title>Dashborads</span><ul><li><a href=/amethyst/Dashborad/Buttons/>Buttons</a></li><li><a href=/amethyst/Dashborad/ControlPanel/>Control Panel</a></li></ul></li><li><span class=book-menu-title>Excalidraws</span><ul><li><a href=/amethyst/Excalidraw/MyDraw/>My Draw</a></li></ul></li><li><span class=book-menu-title>Extras</span><ul><li><a href=/amethyst/Extras/Linter/>Linter</a></li><li><a href=/amethyst/Extras/Index-for-Extras/>Index for Extras</a></li></ul></li><li><span class=book-menu-title>Knowledges</span><ul><li><a href=/amethyst/Knowledge/Kotlin/%E5%A7%94%E6%89%98/>委托</a></li><li><a href=/amethyst/Knowledge/Kotlin/%E6%89%A9%E5%B1%95%E5%87%BD%E6%95%B0/>扩展函数</a></li><li><a href=/amethyst/Knowledge/Python/%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%96%87%E6%9C%AC%E6%9B%BF%E6%8D%A2/>文件读取、文本替换</a></li><li><a href=/amethyst/Knowledge/Python/%E7%B1%BB%E7%9A%84%E5%AE%9A%E4%B9%89%E4%BD%BF%E7%94%A8/>类的定义、使用</a></li><li><a href=/amethyst/Knowledge/Python/%E9%81%8D%E5%8E%86%E6%96%87%E4%BB%B6%E9%87%8D%E5%91%BD%E5%90%8D/>遍历文件、重命名</a></li><li><a href=/amethyst/Knowledge/%E7%AE%97%E6%B3%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E5%BC%95%E7%94%A8/>引用</a></li><li><a href=/amethyst/Knowledge/%E7%AE%97%E6%B3%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%8C%87%E9%92%88/>指针</a></li><li><a href=/amethyst/Knowledge/Android/Android-%E5%9F%BA%E7%A1%80/ADB-%E5%91%BD%E4%BB%A4/>ADB 命令</a></li><li><a href=/amethyst/Knowledge/Android/%E7%83%AD%E4%BF%AE%E5%A4%8D%E6%8F%92%E4%BB%B6%E5%8C%96/Java-%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/>ADB 命令</a></li><li><a href=/amethyst/Knowledge/Android/Android-%E5%9F%BA%E7%A1%80/Android-%E5%AF%B9%E5%AE%B9%E5%99%A8%E7%B1%BB%E7%9A%84%E4%BC%98%E5%8C%96/>Android 对容器类的优化</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/CAS-%E5%92%8C-AQS-%E5%8E%9F%E7%90%86/>CAS 和 AQS 原理</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/EventBus-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>EventBus 使用及源码解析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/Glide-%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E5%92%8C%E7%BC%93%E5%AD%98%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/>Glide 加载流程和缓存原理分析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/Glide-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/>Glide 基本使用</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/Glide-%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95/>Glide 高级用法</a></li><li><a href=/amethyst/Knowledge/Java/%E5%9F%BA%E7%A1%80/HashMap-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/ class=active>HashMap 源码解析</a></li><li><a href=/amethyst/Knowledge/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9B%B8%E5%85%B3/HTTP-%E5%9F%BA%E7%A1%80/>HTTP 基础</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/Java-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/>Java 内存模型</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E4%B8%AD%E7%9A%84%E5%AF%B9%E8%B1%A1%E5%92%8C%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/>JVM 中的对象和垃圾回收</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F/>JVM 内存区域</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E5%AD%97%E8%8A%82%E7%A0%81%E6%8C%87%E4%BB%A4%E7%AE%80%E4%BB%8B/>JVM 字节码指令简介</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E5%AD%97%E8%8A%82%E7%A0%81%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/>JVM 字节码结构分析</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/>JVM 类加载机制</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/LeakCanary-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>LeakCanary 使用及源码解析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/OkHttp-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>OkHttp 使用及源码分析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/Retrofit-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>Retrofit 使用及源码分析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/RxJava-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>RxJava 使用及源码分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%B8%80Binder-%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90%E6%A6%82%E5%BF%B5%E7%AF%87/>一、Binder 机制分析——概念篇</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%B8%83View-%E4%BA%8B%E4%BB%B6%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/>七、View 事件机制分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%B8%89Handler-%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/>三、Handler 原理分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%BA%8CBinder-%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90%E5%BA%94%E7%94%A8%E7%AF%87/>二、Binder 机制分析——应用篇</a></li><li><a href=/amethyst/Knowledge/%E7%AE%97%E6%B3%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E4%BA%8C%E5%8F%89%E6%A0%91%E9%81%8D%E5%8E%86/>二叉树遍历</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%BA%94App-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/>五、App 启动流程分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E5%85%ADView-%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/>六、View 绘制流程分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E5%9B%9B%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/>四、系统启动流程分析</a></li><li><a href=/amethyst/Knowledge/Java/%E5%9F%BA%E7%A1%80/%E5%AE%B9%E5%99%A8%E7%B1%BB/>容器类</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/>并发容器</a></li><li><a href=/amethyst/Knowledge/Java/%E5%9F%BA%E7%A1%80/%E6%B3%9B%E5%9E%8B/>泛型</a></li><li><a href=/amethyst/Knowledge/Java/%E5%9F%BA%E7%A1%80/%E6%B3%A8%E8%A7%A3%E5%92%8C%E5%8F%8D%E5%B0%84/>注解和反射</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E7%AD%89%E5%BE%85-%E9%80%9A%E7%9F%A5%E6%9C%BA%E5%88%B6/>等待-通知机制</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E7%BA%BF%E7%A8%8B%E5%8D%8F%E4%BD%9C/>线程协作</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80/>线程基础</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%92%8C-BlockingQueue/>线程池和 BlockingQueue</a></li><li><a href=/amethyst/Knowledge/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9B%B8%E5%85%B3/%E7%BC%96%E7%A0%81%E5%8A%A0%E5%AF%86Hash%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%AD%97%E7%AC%A6%E9%9B%86/>编码、加密、Hash、序列化和字符集</a></li><li><a href=/amethyst/Knowledge/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9B%B8%E5%85%B3/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84TCPIP-%E5%92%8C-HTTPS/>计算机网络体系结构、TCP&IP 和 HTTPS</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E9%94%81/>锁</a></li></ul></li><li><span class=book-menu-title>Notes</span><ul><li><a href=/amethyst/Notes/2023-03-15/>2023 03 15</a></li><li><a href=/amethyst/Notes/2023-03-18/>2023 03 18</a></li><li><a href=/amethyst/Notes/2023-03-19/>2023 03 19</a></li><li><a href=/amethyst/Notes/2023-03-20/>2023 03 20</a></li><li><a href=/amethyst/Notes/2023-03-22/>Troubleshooting and FAQ</a></li></ul></li><li><span class=book-menu-title>Templates</span><ul><li><a href=/amethyst/Templates/%E5%85%B6%E4%BB%96%E6%A8%A1%E7%89%88/>其他模版</a></li></ul></li><li><span class=book-menu-title>Temps</span><ul><li><a href=/amethyst/Temp/MyIdeas/>MyIdeas</a></li></ul></li></ul><ul><li><a href=https://github.com/64bitpandas/amethyst target=_blank rel=noopener>Github</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class="book-page container"><article class=markdown><h1 class=title>HashMap 源码解析</h1><h1 id=前言>前言
<a class=anchor href=#%e5%89%8d%e8%a8%80>#</a></h1><p>HashMap 是 Java 中最常用 K-V 容器，使用哈希值来确定元素存储的位置，HashMap 对 Entry 进行了扩展（Node），使其形成以链表或者树的形式存储在 HashMap 的容器里。</p><p>在 Java 8 之前和之后，HashMap 的实现有较大的不同，因此对于 put 流程、扩容机制等主要过程分析将会采用两个版本进行对比。</p><h1 id=成员变量>成员变量
<a class=anchor href=#%e6%88%90%e5%91%98%e5%8f%98%e9%87%8f>#</a></h1><p>HashMap 成员变量和构造方法声明如下（Java 7 和 8 大致相同，以下为 Java 8 版本）：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HashMap</span><span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>extends</span> AbstractMap<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>implements</span> Map<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;,</span> Cloneable<span style=color:#f92672>,</span> Serializable <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 初始容量 16  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> DEFAULT_INITIAL_CAPACITY <span style=color:#f92672>=</span> 1 <span style=color:#f92672>&lt;&lt;</span> 4<span style=color:#f92672>;</span> <span style=color:#75715e>// aka 16  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 最大容量，该数组最大值为2^31一次方。  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> MAXIMUM_CAPACITY <span style=color:#f92672>=</span> 1 <span style=color:#f92672>&lt;&lt;</span> 30<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 默认的加载因子，如果构造的时候不传则为 0.75  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>float</span> DEFAULT_LOAD_FACTOR <span style=color:#f92672>=</span> 0<span style=color:#f92672>.</span><span style=color:#a6e22e>75f</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// @1.8：数组某个位置下的 node 链表转化为红黑树对该链表的最小长度要求  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> TREEIFY_THRESHOLD <span style=color:#f92672>=</span> 8<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// @1.8：当一个反树化的阈值，当这个 node 长度减少到该值就会从树转化成链表  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> UNTREEIFY_THRESHOLD <span style=color:#f92672>=</span> 6<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// @1.8：数组某个位置下的 node 链表转化为红黑树对元素个数的最小要求  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> MIN_TREEIFY_CAPACITY <span style=color:#f92672>=</span> 64<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 具体存放数据的数组  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>transient</span> Node<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;[]</span> table<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// entrySet，一个存放 k-v 缓冲区  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>transient</span> Set<span style=color:#f92672>&lt;</span>Map<span style=color:#f92672>.</span><span style=color:#a6e22e>Entry</span><span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;&gt;</span> entrySet<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 存放键值对的个数。  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>transient</span> <span style=color:#66d9ef>int</span> size<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 记录更改 map 结构次数(添加、删除、扩容？)  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>transient</span> <span style=color:#66d9ef>int</span> modCount<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 临界值，当实际大小(容量*填充因子)超过临界值时，会进行扩容  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> threshold<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 填充因子  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>float</span> loadFactor<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 指定初始容量  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>HashMap</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> initialCapacity<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>(</span>initialCapacity<span style=color:#f92672>,</span> DEFAULT_LOAD_FACTOR<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 默认构造函数  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>HashMap</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 默认 threshold 在首次 put 时才复制，Java 7 则是调用  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// this(DEFAULT_INITIAL_CAPACITY, DEFAULT_LOAD_FACTOR)  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>loadFactor</span> <span style=color:#f92672>=</span> DEFAULT_LOAD_FACTOR<span style=color:#f92672>;</span>   
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 包含另一个 Map  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>HashMap</span><span style=color:#f92672>(</span>Map<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> K<span style=color:#f92672>,</span> <span style=color:#f92672>?</span> <span style=color:#66d9ef>extends</span> V<span style=color:#f92672>&gt;</span> m<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>loadFactor</span> <span style=color:#f92672>=</span> DEFAULT_LOAD_FACTOR<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        putMapEntries<span style=color:#f92672>(</span>m<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 指定初始容量和填充因子  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>HashMap</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> initialCapacity<span style=color:#f92672>,</span> <span style=color:#66d9ef>float</span> loadFactor<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>initialCapacity <span style=color:#f92672>&lt;</span> 0<span style=color:#f92672>)</span> <span style=color:#75715e>// 容量不能为负数  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Illegal initial capacity: &#34;</span> <span style=color:#f92672>+</span> initialCapacity<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 当容量大于 2^31 就取最大值 1&lt;&lt;30;   
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>initialCapacity <span style=color:#f92672>&gt;</span> MAXIMUM_CAPACITY<span style=color:#f92672>)</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            initialCapacity <span style=color:#f92672>=</span> MAXIMUM_CAPACITY<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>loadFactor <span style=color:#f92672>&lt;=</span> 0 <span style=color:#f92672>||</span> Float<span style=color:#f92672>.</span><span style=color:#a6e22e>isNaN</span><span style=color:#f92672>(</span>loadFactor<span style=color:#f92672>))</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Illegal load factor: &#34;</span>                <span style=color:#f92672>+</span> loadFactor<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>loadFactor</span> <span style=color:#f92672>=</span> loadFactor<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// tableSizeFor 保证了数组长度一定是 2 的幂次方，是大于等于    initialCapacity 最接近的值。  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 这里使用 threshold 暂时保存计算后的 initialCapacity 值  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>threshold</span> <span style=color:#f92672>=</span> tableSizeFor<span style=color:#f92672>(</span>initialCapacity<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span></code></pre></div><h1 id=数据结构>数据结构
<a class=anchor href=#%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84>#</a></h1><p>Java 7 采用数组 + 链表方式进行存储，元素类型为 Entry：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Entry</span><span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>implements</span> Map<span style=color:#f92672>.</span><span style=color:#a6e22e>Entry</span><span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> K key<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    V value<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    Entry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> next<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> hash<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span></code></pre></div><p>元素的存储结构如下：<br><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/HashMap/clipboard_20230322_035018.png width=auto alt>
Java 8 开始，采用数组 + 链表 + 红黑树方式进行存储，元素类型为 Node 和 TreeNode：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Node</span><span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>implements</span> Map<span style=color:#f92672>.</span><span style=color:#a6e22e>Entry</span><span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> hash<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> K key<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    V value<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    Node<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> next<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TreeNode</span><span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>extends</span> LinkedHashMap<span style=color:#f92672>.</span><span style=color:#a6e22e>Entry</span><span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    TreeNode<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> parent<span style=color:#f92672>;</span>  <span style=color:#75715e>// red-black tree links  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span>    TreeNode<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> left<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    TreeNode<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> right<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    TreeNode<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> prev<span style=color:#f92672>;</span>    <span style=color:#75715e>// needed to unlink next upon deletion  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> red<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span></code></pre></div><p>元素的存储结构如下：
<img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/HashMap/clipboard_20230322_041741.png width=auto alt></p><h1 id=put-流程分析>put 流程分析
<a class=anchor href=#put-%e6%b5%81%e7%a8%8b%e5%88%86%e6%9e%90>#</a></h1><h2 id=java-7-put-流程>Java 7 put 流程
<a class=anchor href=#java-7-put-%e6%b5%81%e7%a8%8b>#</a></h2><h3 id=代码分析>代码分析
<a class=anchor href=#%e4%bb%a3%e7%a0%81%e5%88%86%e6%9e%90>#</a></h3><p>Java 7 put 流程主要方法源码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> V <span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>K key<span style=color:#f92672>,</span> V value<span style=color:#f92672>)</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>table <span style=color:#f92672>==</span> EMPTY_TABLE<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 初始化 table  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        inflateTable<span style=color:#f92672>(</span>threshold<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>key <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 在 table[0] 处插入 key 为 null 元素并返回  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> putForNullKey<span style=color:#f92672>(</span>value<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 先进行一次 hash 计算     
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> hash <span style=color:#f92672>=</span> hash<span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 根据 hash 值计算 table 下标  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> indexFor<span style=color:#f92672>(</span>hash<span style=color:#f92672>,</span> table<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 遍历 table[i] 处的链表  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Entry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> e <span style=color:#f92672>=</span> table<span style=color:#f92672>[</span>i<span style=color:#f92672>];</span> e <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span> e <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>        Object k<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// hash 一样且 key 相等或者 equals 方法返回 true 才进行替换  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>hash</span> <span style=color:#f92672>==</span> hash <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>((</span>k <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>key</span><span style=color:#f92672>)</span> <span style=color:#f92672>==</span> key <span style=color:#f92672>||</span> key<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>k<span style=color:#f92672>)))</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>            V oldValue <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            e<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span> <span style=color:#f92672>=</span> value<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            e<span style=color:#f92672>.</span><span style=color:#a6e22e>recordAccess</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> oldValue<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 出循环意味着 table[i] 这条链表没有此元素  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 更新 modCount  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    modCount<span style=color:#f92672>++;</span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 插入新元素  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    addEntry<span style=color:#f92672>(</span>hash<span style=color:#f92672>,</span> key<span style=color:#f92672>,</span> value<span style=color:#f92672>,</span> i<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>inflateTable</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> toSize<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取大于  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> capacity <span style=color:#f92672>=</span> roundUpToPowerOf2<span style=color:#f92672>(</span>toSize<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 重新计算阈值  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    threshold <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span><span style=color:#f92672>)</span> Math<span style=color:#f92672>.</span><span style=color:#a6e22e>min</span><span style=color:#f92672>(</span>capacity <span style=color:#f92672>*</span> loadFactor<span style=color:#f92672>,</span>   
</span></span><span style=display:flex><span>            MAXIMUM_CAPACITY <span style=color:#f92672>+</span> 1<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 创建数组  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    table <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Entry<span style=color:#f92672>[</span>capacity<span style=color:#f92672>];</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 根据配置判断是否初始化 hashSeed  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    initHashSeedAsNeeded<span style=color:#f92672>(</span>capacity<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> V <span style=color:#a6e22e>putForNullKey</span><span style=color:#f92672>(</span>V value<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 最多循环一次，因为这个位置最多只有一个元素  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Entry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> e <span style=color:#f92672>=</span> table<span style=color:#f92672>[</span>0<span style=color:#f92672>];</span> e <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span> e <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// key 为 null 直接替换  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>key</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>            V oldValue <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>            e<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span> <span style=color:#f92672>=</span> value<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>            e<span style=color:#f92672>.</span><span style=color:#a6e22e>recordAccess</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> oldValue<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 更新 modCount  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    modCount<span style=color:#f92672>++;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 在 table[0] 处插入元素  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    addEntry<span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> value<span style=color:#f92672>,</span> 0<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>addEntry</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> hash<span style=color:#f92672>,</span> K key<span style=color:#f92672>,</span> V value<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> bucketIndex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 元素数量达到临界值且 table[bucketIndex] 位置不为空才进行扩容  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>size <span style=color:#f92672>&gt;=</span> threshold<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>null</span> <span style=color:#f92672>!=</span> table<span style=color:#f92672>[</span>bucketIndex<span style=color:#f92672>]))</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 两倍容量  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        resize<span style=color:#f92672>(</span>2 <span style=color:#f92672>*</span> table<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 重新计算 hash  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        hash <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>null</span> <span style=color:#f92672>!=</span> key<span style=color:#f92672>)</span> <span style=color:#f92672>?</span> hash<span style=color:#f92672>(</span>key<span style=color:#f92672>)</span> <span style=color:#f92672>:</span> 0<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 重新确定数组下标  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        bucketIndex <span style=color:#f92672>=</span> indexFor<span style=color:#f92672>(</span>hash<span style=color:#f92672>,</span> table<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 创建并插入新元素  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    createEntry<span style=color:#f92672>(</span>hash<span style=color:#f92672>,</span> key<span style=color:#f92672>,</span> value<span style=color:#f92672>,</span> bucketIndex<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>// 在链表头部插入新元素  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>createEntry</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> hash<span style=color:#f92672>,</span> K key<span style=color:#f92672>,</span> V value<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> bucketIndex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 保存原头结点  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Entry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> e <span style=color:#f92672>=</span> table<span style=color:#f92672>[</span>bucketIndex<span style=color:#f92672>];</span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 创建新元素、把 next 指向头节点，并替换原来 bucketIndex 位置的链表  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    table<span style=color:#f92672>[</span>bucketIndex<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Entry<span style=color:#f92672>&lt;&gt;(</span>hash<span style=color:#f92672>,</span> key<span style=color:#f92672>,</span> value<span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 元素数量++  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    size<span style=color:#f92672>++</span><span style=color:#960050;background-color:#1e0010>；</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span></code></pre></div><h3 id=流程图示>流程图示
<a class=anchor href=#%e6%b5%81%e7%a8%8b%e5%9b%be%e7%a4%ba>#</a></h3><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/HashMap/clipboard_20230322_040358.png width=auto alt></p><h2 id=java-8-put-流程>Java 8 put 流程
<a class=anchor href=#java-8-put-%e6%b5%81%e7%a8%8b>#</a></h2><h3 id=代码分析-1>代码分析
<a class=anchor href=#%e4%bb%a3%e7%a0%81%e5%88%86%e6%9e%90-1>#</a></h3><p>Java 8 put 流程主要方法源码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> V <span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>K key<span style=color:#f92672>,</span> V value<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>      <span style=color:#75715e>// onlyIfAbsent 默认为 false，即元素存在时进行替换  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> putVal<span style=color:#f92672>(</span>hash<span style=color:#f92672>(</span>key<span style=color:#f92672>),</span> key<span style=color:#f92672>,</span> value<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>final</span> V <span style=color:#a6e22e>putVal</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> hash<span style=color:#f92672>,</span> K key<span style=color:#f92672>,</span> V value<span style=color:#f92672>,</span>   
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>boolean</span> onlyIfAbsent<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> evict<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>    Node<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;[]</span> tab<span style=color:#f92672>;</span> Node<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> p<span style=color:#f92672>;</span> <span style=color:#66d9ef>int</span> n<span style=color:#f92672>,</span> i<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// table 未初始化或者长度为 0，进行扩容  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>tab <span style=color:#f92672>=</span> table<span style=color:#f92672>)</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> <span style=color:#f92672>(</span>n <span style=color:#f92672>=</span> tab<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>)</span> <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span>  
</span></span><span style=display:flex><span>        n <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>tab <span style=color:#f92672>=</span> resize<span style=color:#f92672>()).</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// (n - 1) &amp; hash 确定元素存放位置，位置为空则直接放入该位置  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>p <span style=color:#f92672>=</span> tab<span style=color:#f92672>[</span>i <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>n <span style=color:#f92672>-</span> 1<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;</span> hash<span style=color:#f92672>])</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>  
</span></span><span style=display:flex><span>        tab<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> newNode<span style=color:#f92672>(</span>hash<span style=color:#f92672>,</span> key<span style=color:#f92672>,</span> value<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 数组对应位置已经存在元素  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>        Node<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> e<span style=color:#f92672>;</span> K k<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 比较数组中第一个元素  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>p<span style=color:#f92672>.</span><span style=color:#a6e22e>hash</span> <span style=color:#f92672>==</span> hash <span style=color:#f92672>&amp;&amp;</span>  
</span></span><span style=display:flex><span>            <span style=color:#f92672>((</span>k <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span><span style=color:#a6e22e>key</span><span style=color:#f92672>)</span> <span style=color:#f92672>==</span> key <span style=color:#f92672>||</span> <span style=color:#f92672>(</span>key <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> key<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>k<span style=color:#f92672>))))</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 将第一个元素赋值给 e  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                e <span style=color:#f92672>=</span> p<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 是否为红黑树结点  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>p <span style=color:#66d9ef>instanceof</span> TreeNode<span style=color:#f92672>)</span>  
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 放入树中  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            e <span style=color:#f92672>=</span> <span style=color:#f92672>((</span>TreeNode<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;)</span>p<span style=color:#f92672>).</span><span style=color:#a6e22e>putTreeVal</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> tab<span style=color:#f92672>,</span>   
</span></span><span style=display:flex><span>                        hash<span style=color:#f92672>,</span> key<span style=color:#f92672>,</span> value<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 链表结点  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 遍历链表  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> binCount <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> <span style=color:#f92672>;</span> <span style=color:#f92672>++</span>binCount<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 到达链表的尾部，说明没有找到相等的 key  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>e <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>)</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 在尾部插入新结点  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    p<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span> <span style=color:#f92672>=</span> newNode<span style=color:#f92672>(</span>hash<span style=color:#f92672>,</span> key<span style=color:#f92672>,</span> value<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 判断结点数量是否达到阈值(TREEIFY_THRESHOLD 默认为 8)  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>binCount <span style=color:#f92672>&gt;=</span> TREEIFY_THRESHOLD <span style=color:#f92672>-</span> 1<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// 根据数组长度决定是否树化  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        treeifyBin<span style=color:#f92672>(</span>tab<span style=color:#f92672>,</span> hash<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 跳出循环  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 判断链表中结点的 key 值是否与插入的 key 相等  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>hash</span> <span style=color:#f92672>==</span> hash <span style=color:#f92672>&amp;&amp;</span>  
</span></span><span style=display:flex><span>                    <span style=color:#f92672>((</span>k <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>key</span><span style=color:#f92672>)</span> <span style=color:#f92672>==</span> key <span style=color:#f92672>||</span>   
</span></span><span style=display:flex><span>                          <span style=color:#f92672>(</span>key <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> key<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>k<span style=color:#f92672>))))</span>  
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// key 相等，跳出循环，此时 e 就是目标结点  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 与前面的 e = p.next 组合遍历链表  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                p <span style=color:#f92672>=</span> e<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 找到 key 值相等的目标结点  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>e <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            V oldValue <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#75715e>// onlyIfAbsent 为 false 或者目标接点值为 null  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>onlyIfAbsent <span style=color:#f92672>||</span> oldValue <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>                <span style=color:#75715e>//用新值替换旧值  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                e<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span> <span style=color:#f92672>=</span> value<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 空实现，用于访问后回调给子类，如 LinkedHashMap  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            afterNodeAccess<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 返回旧值  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>return</span> oldValue<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 结构修改，更新 modCount  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>++</span>modCount<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 实际大小大于阈值则扩容  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(++</span>size <span style=color:#f92672>&gt;</span> threshold<span style=color:#f92672>)</span>  
</span></span><span style=display:flex><span>        resize<span style=color:#f92672>();</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 插入后回调  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    afterNodeInsertion<span style=color:#f92672>(</span>evict<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span></code></pre></div><h4 id=流程图示-1>流程图示
<a class=anchor href=#%e6%b5%81%e7%a8%8b%e5%9b%be%e7%a4%ba-1>#</a></h4><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/HashMap/clipboard_20230322_040522.png width=auto alt></p><h1 id=hash-计算与元素位置确定>hash 计算与元素位置确定
<a class=anchor href=#hash-%e8%ae%a1%e7%ae%97%e4%b8%8e%e5%85%83%e7%b4%a0%e4%bd%8d%e7%bd%ae%e7%a1%ae%e5%ae%9a>#</a></h1><h2 id=java-7>Java 7
<a class=anchor href=#java-7>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>int</span> hash <span style=color:#f92672>=</span> hash<span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> indexFor<span style=color:#f92672>(</span>hash<span style=color:#f92672>,</span> table<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>hash</span><span style=color:#f92672>(</span>Object k<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 默认为 0，初始化方法见后文  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> h <span style=color:#f92672>=</span> hashSeed<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果 hashSeed 不为零且 key 是 String 类型  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>0 <span style=color:#f92672>!=</span> h <span style=color:#f92672>&amp;&amp;</span> k <span style=color:#66d9ef>instanceof</span> String<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 返回特定 hash 值  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> sun<span style=color:#f92672>.</span><span style=color:#a6e22e>misc</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Hashing</span><span style=color:#f92672>.</span><span style=color:#a6e22e>stringHash32</span><span style=color:#f92672>((</span>String<span style=color:#f92672>)</span> k<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    h <span style=color:#f92672>^=</span> k<span style=color:#f92672>.</span><span style=color:#a6e22e>hashCode</span><span style=color:#f92672>();</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 多次异或  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    h <span style=color:#f92672>^=</span> <span style=color:#f92672>(</span>h <span style=color:#f92672>&gt;&gt;&gt;</span> 20<span style=color:#f92672>)</span> <span style=color:#f92672>^</span> <span style=color:#f92672>(</span>h <span style=color:#f92672>&gt;&gt;&gt;</span> 12<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> h <span style=color:#f92672>^</span> <span style=color:#f92672>(</span>h <span style=color:#f92672>&gt;&gt;&gt;</span> 7<span style=color:#f92672>)</span> <span style=color:#f92672>^</span> <span style=color:#f92672>(</span>h <span style=color:#f92672>&gt;&gt;&gt;</span> 4<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>indexFor</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> h<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> length<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// assert Integer.bitCount(length) == 1 : &#34;length must be a non-zero power of 2&#34;;  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> h <span style=color:#f92672>&amp;</span> <span style=color:#f92672>(</span>length<span style=color:#f92672>-</span>1<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span></code></pre></div><h2 id=java-8>Java 8
<a class=anchor href=#java-8>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> V <span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>K key<span style=color:#f92672>,</span> V value<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> putVal<span style=color:#f92672>(</span>hash<span style=color:#f92672>(</span>key<span style=color:#f92672>),</span> key<span style=color:#f92672>,</span> value<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>hash</span><span style=color:#f92672>(</span>Object key<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> h<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 让高 16 位和低 16 位异或  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>key <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>?</span> 0 <span style=color:#f92672>:</span> <span style=color:#f92672>(</span>h <span style=color:#f92672>=</span> key<span style=color:#f92672>.</span><span style=color:#a6e22e>hashCode</span><span style=color:#f92672>())</span> <span style=color:#f92672>^</span> <span style=color:#f92672>(</span>h <span style=color:#f92672>&gt;&gt;&gt;</span> 16<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p <span style=color:#f92672>=</span> tab<span style=color:#f92672>[</span>index <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>n <span style=color:#f92672>-</span> 1<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;</span> hash<span style=color:#f92672>]</span><span style=color:#960050;background-color:#1e0010>；</span>  
</span></span></code></pre></div><h1 id=扩容流程>扩容流程
<a class=anchor href=#%e6%89%a9%e5%ae%b9%e6%b5%81%e7%a8%8b>#</a></h1><p>扩容过程涉及到 rehash、复制数据等操作，非常消耗性能。</p><p>和扩容相关的全局变量及其含义：</p><table><thead><tr><th>全局变量   </th><th>含义                                                                                                                                                                                                                                                                                                                                                                                                      </th></tr></thead><tbody><tr><td>capacity   </td><td>table 的容量大小，默认为 16。需要注意的是 capacity 必须保证为 2 的 n 次方。                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td>size       </td><td>存放键值对数量。                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td>threshold  </td><td>size 的临界值，当 size 大于等于 threshold 就必须进行扩容操作。threshold = (int) (capacity * loadFactor)                                                                                                                                                                                                                                                                                                   </td></tr><tr><td>loadFactor</td><td>填充因子，table 能够使用的比例。loadFactor 能够控制数组存放数据的疏密程度，loadFactor 越趋近于 1，那么数组中存放的数据(entry)也就越多，也就越密，也就是会让链表的长度增加，loadFactor 越小，也就是趋近于 0，数组中存放的数据(entry)也就越少，也就越稀疏。<br>loadFactor 太大导致查找元素效率低，太小导致数组的利用率低，存放的数据会很分散。loadFactor 的默认值为 0.75f 是官方给出的一个比较好的临界值。</td></tr></tbody></table><h2 id=java-7-扩容流程>Java 7 扩容流程
<a class=anchor href=#java-7-%e6%89%a9%e5%ae%b9%e6%b5%81%e7%a8%8b>#</a></h2><h3 id=代码分析-2>代码分析
<a class=anchor href=#%e4%bb%a3%e7%a0%81%e5%88%86%e6%9e%90-2>#</a></h3><p>Java 7 的 resize 方法相关代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>resize</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> newCapacity<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>    Entry<span style=color:#f92672>[]</span> oldTable <span style=color:#f92672>=</span> table<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 记录旧容量  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> oldCapacity <span style=color:#f92672>=</span> oldTable<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果容量已达到上限，则扩容阈值设置成不可能达到的最大值，即后续不再扩容  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>oldCapacity <span style=color:#f92672>==</span> MAXIMUM_CAPACITY<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>        threshold <span style=color:#f92672>=</span> Integer<span style=color:#f92672>.</span><span style=color:#a6e22e>MAX_VALUE</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 根据新容量创建出新数组  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Entry<span style=color:#f92672>[]</span> newTable <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Entry<span style=color:#f92672>[</span>newCapacity<span style=color:#f92672>];</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 将旧数组的节点转移到新数组  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    transfer<span style=color:#f92672>(</span>newTable<span style=color:#f92672>,</span> initHashSeedAsNeeded<span style=color:#f92672>(</span>newCapacity<span style=color:#f92672>));</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 新旧易主  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    table <span style=color:#f92672>=</span> newTable<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 根据新容量重新确定新阈值  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    threshold <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span><span style=color:#f92672>)</span>Math<span style=color:#f92672>.</span><span style=color:#a6e22e>min</span><span style=color:#f92672>(</span>newCapacity <span style=color:#f92672>*</span> loadFactor<span style=color:#f92672>,</span> MAXIMUM_CAPACITY <span style=color:#f92672>+</span> 1<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#75715e>// 从配置中获取是否启用备用 hash，用于减少字符串 hash 冲突  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>initHashSeedAsNeeded</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> capacity<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 是否已经启用备用 hash  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>boolean</span> currentAltHashing <span style=color:#f92672>=</span> hashSeed <span style=color:#f92672>!=</span> 0<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 虚拟机已经启动且数组容量大于 ALTERNATIVE_HASHING_THRESHOLD  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>boolean</span> useAltHashing <span style=color:#f92672>=</span> sun<span style=color:#f92672>.</span><span style=color:#a6e22e>misc</span><span style=color:#f92672>.</span><span style=color:#a6e22e>VM</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isBooted</span><span style=color:#f92672>()</span> <span style=color:#f92672>&amp;&amp;</span>  
</span></span><span style=display:flex><span>            <span style=color:#f92672>(</span>capacity <span style=color:#f92672>&gt;=</span> Holder<span style=color:#f92672>.</span><span style=color:#a6e22e>ALTERNATIVE_HASHING_THRESHOLD</span><span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 异或操作判断是否切换  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>boolean</span> switching <span style=color:#f92672>=</span> currentAltHashing <span style=color:#f92672>^</span> useAltHashing<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>switching<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// useAltHashing 为 true 则 hashSeed 初始化为也给随机 hash 值  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        hashSeed <span style=color:#f92672>=</span> useAltHashing  
</span></span><span style=display:flex><span>            <span style=color:#f92672>?</span> sun<span style=color:#f92672>.</span><span style=color:#a6e22e>misc</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Hashing</span><span style=color:#f92672>.</span><span style=color:#a6e22e>randomHashSeed</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span>  
</span></span><span style=display:flex><span>            <span style=color:#f92672>:</span> 0<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> switching<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>transfer</span><span style=color:#f92672>(</span>Entry<span style=color:#f92672>[]</span> newTable<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> rehash<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> newCapacity <span style=color:#f92672>=</span> newTable<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 遍历旧数组  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Entry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> e <span style=color:#f92672>:</span> table<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 遍历数组上的链表  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>while</span><span style=color:#f92672>(</span><span style=color:#66d9ef>null</span> <span style=color:#f92672>!=</span> e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 记录下一个位置  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            Entry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> next <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 判断是否重新计算 hash 值  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>rehash<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>                e<span style=color:#f92672>.</span><span style=color:#a6e22e>hash</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>==</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>key</span> <span style=color:#f92672>?</span> 0 <span style=color:#f92672>:</span> hash<span style=color:#f92672>(</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>key</span><span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 根据新容量重新计算位置  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> indexFor<span style=color:#f92672>(</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>hash</span><span style=color:#f92672>,</span> newCapacity<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 按旧链表的正序遍历链表、在新链表的头部依次插入  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// 因此扩容后可能出现逆序  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            e<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span> <span style=color:#f92672>=</span> newTable<span style=color:#f92672>[</span>i<span style=color:#f92672>];</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            newTable<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> e<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            e <span style=color:#f92672>=</span> next<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span></code></pre></div><h3 id=扩容流程在多线程环境下的隐患>扩容流程在多线程环境下的隐患
<a class=anchor href=#%e6%89%a9%e5%ae%b9%e6%b5%81%e7%a8%8b%e5%9c%a8%e5%a4%9a%e7%ba%bf%e7%a8%8b%e7%8e%af%e5%a2%83%e4%b8%8b%e7%9a%84%e9%9a%90%e6%82%a3>#</a></h3><p>在 resize 扩容过程中，在将旧数组上的数据转移到新数组上时，转移数据操作是按旧链表的正序遍历链表、在新链表的头部依次插入的。在多线程的环境下，由于这些操作不具有原子性和内存可见性，转移数据、扩容后，容易出现环形链表的情况。</p><h2 id=java-8-扩容流程>Java 8 扩容流程
<a class=anchor href=#java-8-%e6%89%a9%e5%ae%b9%e6%b5%81%e7%a8%8b>#</a></h2><h3 id=代码分析-3>代码分析
<a class=anchor href=#%e4%bb%a3%e7%a0%81%e5%88%86%e6%9e%90-3>#</a></h3><p>Java 8 中的 resize 和 treeifyBin 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>treeifyBin</span><span style=color:#f92672>(</span>Node<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;[]</span> tab<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> hash<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> n<span style=color:#f92672>,</span> index<span style=color:#f92672>;</span> Node<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> e<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果数组为空或者数组长度小于 64，则进行扩容  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>tab <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> <span style=color:#f92672>(</span>n <span style=color:#f92672>=</span> tab<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>)</span> <span style=color:#f92672>&lt;</span> MIN_TREEIFY_CAPACITY<span style=color:#f92672>)</span>  
</span></span><span style=display:flex><span>        resize<span style=color:#f92672>();</span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 根据 hash 获取数组下标，该位置有值再进行树化  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>e <span style=color:#f92672>=</span> tab<span style=color:#f92672>[</span>index <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>n <span style=color:#f92672>-</span> 1<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;</span> hash<span style=color:#f92672>])</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>        TreeNode<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> hd <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> tl <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 遍历链表  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>do</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Node 节点转换成 TreeNode 节点  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            TreeNode<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> p <span style=color:#f92672>=</span> replacementTreeNode<span style=color:#f92672>(</span>e<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>tl <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>  
</span></span><span style=display:flex><span>                hd <span style=color:#f92672>=</span> p<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>                p<span style=color:#f92672>.</span><span style=color:#a6e22e>prev</span> <span style=color:#f92672>=</span> tl<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>                tl<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span> <span style=color:#f92672>=</span> p<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            tl <span style=color:#f92672>=</span> p<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>while</span> <span style=color:#f92672>((</span>e <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>tab<span style=color:#f92672>[</span>index<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> hd<span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>  
</span></span><span style=display:flex><span>            hd<span style=color:#f92672>.</span><span style=color:#a6e22e>treeify</span><span style=color:#f92672>(</span>tab<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>final</span> Node<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;[]</span> <span style=color:#a6e22e>resize</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    Node<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;[]</span> oldTab <span style=color:#f92672>=</span> table<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> oldCap <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>oldTab <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>?</span> 0 <span style=color:#f92672>:</span> oldTab<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> oldThr <span style=color:#f92672>=</span> threshold<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> newCap<span style=color:#f92672>,</span> newThr <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>oldCap <span style=color:#f92672>&gt;</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 超过最大值后续不再扩容  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>oldCap <span style=color:#f92672>&gt;=</span> MAXIMUM_CAPACITY<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>            threshold <span style=color:#f92672>=</span> Integer<span style=color:#f92672>.</span><span style=color:#a6e22e>MAX_VALUE</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> oldTab<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 否则扩充为原来的2倍  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>newCap <span style=color:#f92672>=</span> oldCap <span style=color:#f92672>&lt;&lt;</span> 1<span style=color:#f92672>)</span> <span style=color:#f92672>&lt;</span> MAXIMUM_CAPACITY <span style=color:#f92672>&amp;&amp;</span> oldCap <span style=color:#f92672>&gt;=</span> DEFAULT_INITIAL_CAPACITY<span style=color:#f92672>)</span>  
</span></span><span style=display:flex><span>            newThr <span style=color:#f92672>=</span> oldThr <span style=color:#f92672>&lt;&lt;</span> 1<span style=color:#f92672>;</span> <span style=color:#75715e>// double threshold  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>oldThr <span style=color:#f92672>&gt;</span> 0<span style=color:#f92672>)</span> <span style=color:#75715e>// initial capacity was placed in threshold  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        newCap <span style=color:#f92672>=</span> oldThr<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// signifies using defaults  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        newCap <span style=color:#f92672>=</span> DEFAULT_INITIAL_CAPACITY<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        newThr <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span><span style=color:#f92672>)(</span>DEFAULT_LOAD_FACTOR <span style=color:#f92672>*</span> DEFAULT_INITIAL_CAPACITY<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 计算新的 resize 上限  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>newThr <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>float</span> ft <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>float</span><span style=color:#f92672>)</span>newCap <span style=color:#f92672>*</span> loadFactor<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>        newThr <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>newCap <span style=color:#f92672>&lt;</span> MAXIMUM_CAPACITY <span style=color:#f92672>&amp;&amp;</span> ft <span style=color:#f92672>&lt;</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>float</span><span style=color:#f92672>)</span>MAXIMUM_CAPACITY <span style=color:#f92672>?</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span><span style=color:#f92672>)</span>ft <span style=color:#f92672>:</span> Integer<span style=color:#f92672>.</span><span style=color:#a6e22e>MAX_VALUE</span><span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    threshold <span style=color:#f92672>=</span> newThr<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>({</span><span style=color:#e6db74>&#34;rawtypes&#34;</span><span style=color:#f92672>,</span><span style=color:#e6db74>&#34;unchecked&#34;</span><span style=color:#f92672>})</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    Node<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;[]</span> newTab <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>Node<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;[])</span><span style=color:#66d9ef>new</span> Node<span style=color:#f92672>[</span>newCap<span style=color:#f92672>];</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    table <span style=color:#f92672>=</span> newTab<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>oldTab <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 旧数组迁移至新数组  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> j <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> j <span style=color:#f92672>&lt;</span> oldCap<span style=color:#f92672>;</span> <span style=color:#f92672>++</span>j<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>            Node<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> e<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>e <span style=color:#f92672>=</span> oldTab<span style=color:#f92672>[</span>j<span style=color:#f92672>])</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>                oldTab<span style=color:#f92672>[</span>j<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>  
</span></span><span style=display:flex><span>                    newTab<span style=color:#f92672>[</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>hash</span> <span style=color:#f92672>&amp;</span> <span style=color:#f92672>(</span>newCap <span style=color:#f92672>-</span> 1<span style=color:#f92672>)]</span> <span style=color:#f92672>=</span> e<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>e <span style=color:#66d9ef>instanceof</span> TreeNode<span style=color:#f92672>)</span>  
</span></span><span style=display:flex><span>                    <span style=color:#f92672>((</span>TreeNode<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;)</span>e<span style=color:#f92672>).</span><span style=color:#a6e22e>split</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> newTab<span style=color:#f92672>,</span> j<span style=color:#f92672>,</span> oldCap<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>                    Node<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> loHead <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> loTail <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>                    Node<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> hiHead <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> hiTail <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>                    Node<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> next<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>do</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>                        next <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// 原索引  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>hash</span> <span style=color:#f92672>&amp;</span> oldCap<span style=color:#f92672>)</span> <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>loTail <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>  
</span></span><span style=display:flex><span>                                loHead <span style=color:#f92672>=</span> e<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>else</span>  
</span></span><span style=display:flex><span>                                loTail<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span> <span style=color:#f92672>=</span> e<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>                            loTail <span style=color:#f92672>=</span> e<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// 原索引+oldCap  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>hiTail <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>  
</span></span><span style=display:flex><span>                                hiHead <span style=color:#f92672>=</span> e<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>else</span>  
</span></span><span style=display:flex><span>                                hiTail<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span> <span style=color:#f92672>=</span> e<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>                            hiTail <span style=color:#f92672>=</span> e<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span> <span style=color:#66d9ef>while</span> <span style=color:#f92672>((</span>e <span style=color:#f92672>=</span> next<span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 原索引元素放到新数组中  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>loTail <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>                        loTail<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>                        newTab<span style=color:#f92672>[</span>j<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> loHead<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 原索引 +oldCap 元素放到新数组中  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>hiTail <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>                        hiTail<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>                        newTab<span style=color:#f92672>[</span>j <span style=color:#f92672>+</span> oldCap<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> hiHead<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> newTab<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span></code></pre></div><p>resize 方法中的前半段，关于 newCap 和 newThr 的计算过程，简化后如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>oldCap <span style=color:#f92672>&gt;</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 嵌套条件分支  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>oldCap <span style=color:#f92672>&gt;=</span> MAXIMUM_CAPACITY<span style=color:#f92672>)</span> <span style=color:#f92672>{...}</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>newCap <span style=color:#f92672>=</span> oldCap <span style=color:#f92672>&lt;&lt;</span> 1<span style=color:#f92672>)</span> <span style=color:#f92672>&lt;</span> MAXIMUM_CAPACITY <span style=color:#f92672>&amp;&amp;</span>  
</span></span><span style=display:flex><span>                 oldCap <span style=color:#f92672>&gt;=</span> DEFAULT_INITIAL_CAPACITY<span style=color:#f92672>)</span> <span style=color:#f92672>{...}</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>   
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>oldThr <span style=color:#f92672>&gt;</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{...}</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span> <span style=color:#f92672>{...}</span>  
</span></span></code></pre></div><p>这些判断分别对应以下几种条件：</p><table><thead><tr><th>条件                       </th><th>覆盖情况                            </th><th>备注                                                                                                                         </th></tr></thead><tbody><tr><td>oldCap > 0                 </td><td>桶数组 table 已经被初始化           </td><td>                                                                                                                              </td></tr><tr><td>oldThr > 0                 </td><td>threshold > 0，且桶数组未被初始化   </td><td>调用 HashMap(int) 和 HashMap(int, float) 构造方法时会产生这种情况，此种情况下 newCap = oldThr，newThr 在第二个条件分支中算出</td></tr><tr><td>oldCap <mark>0 && oldThr</mark> 0</td><td>桶数组未被初始化，且 threshold 为 0</td><td>调用 HashMap() 构造方法会产生这种情况。                                                                                      </td></tr></tbody></table><p>oldCap > 0 时表示 table 数组已经被初始化过，这时需要再次计算容量和阈值：</p><table><thead><tr><th>条件                        </th><th>覆盖情况                                      </th><th>备注                                                      </th></tr></thead><tbody><tr><td>oldCap >= 230               </td><td>桶数组容量大于或等于最大桶容量 230            </td><td>后续不再扩容                                              </td></tr><tr><td>newCap &lt; 230 && oldCap > 16</td><td>新桶数组容量小于最大值，且旧桶数组容量大于 16</td><td>该种情况下新阈值 newThr = oldThr &#171; 1，移位可能会导致溢出</td></tr></tbody></table><p>resize 方法后续过程中可以看出，Java 8 转移数据操作是按旧链表的正序遍历链表、在新链表的尾部依次插入的，所以不会出现链表 逆序、倒置的情况，故不容易出现环形链表的情况。但仍然还是线程不安全，因为没有加同步锁保护。</p><h2 id=扩容流程对比>扩容流程对比
<a class=anchor href=#%e6%89%a9%e5%ae%b9%e6%b5%81%e7%a8%8b%e5%af%b9%e6%af%94>#</a></h2><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/HashMap/clipboard_20230322_040805.png width=auto alt></p><h1 id=get-流程分析>get 流程分析
<a class=anchor href=#get-%e6%b5%81%e7%a8%8b%e5%88%86%e6%9e%90>#</a></h1><h2 id=java-7-1>Java 7
<a class=anchor href=#java-7-1>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> V <span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>Object key<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>key <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> getForNullKey<span style=color:#f92672>();</span>  
</span></span><span style=display:flex><span>    Entry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> entry <span style=color:#f92672>=</span> getEntry<span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>==</span> entry <span style=color:#f92672>?</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>:</span> entry<span style=color:#f92672>.</span><span style=color:#a6e22e>getValue</span><span style=color:#f92672>();</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> V <span style=color:#a6e22e>getForNullKey</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>size <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 下标为 0 处获取 key 为 null 的元素  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Entry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> e <span style=color:#f92672>=</span> table<span style=color:#f92672>[</span>0<span style=color:#f92672>];</span> e <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span> e <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>key</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>final</span> Entry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getEntry</span><span style=color:#f92672>(</span>Object key<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>size <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> hash <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>key <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>?</span> 0 <span style=color:#f92672>:</span> hash<span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Entry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> e <span style=color:#f92672>=</span> table<span style=color:#f92672>[</span>indexFor<span style=color:#f92672>(</span>hash<span style=color:#f92672>,</span> table<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>)];</span>  
</span></span><span style=display:flex><span>             e <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span> e <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>        Object k<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>hash</span> <span style=color:#f92672>==</span> hash <span style=color:#f92672>&amp;&amp;</span>  
</span></span><span style=display:flex><span>            <span style=color:#f92672>((</span>k <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>key</span><span style=color:#f92672>)</span> <span style=color:#f92672>==</span> key <span style=color:#f92672>||</span> <span style=color:#f92672>(</span>key <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> key<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>k<span style=color:#f92672>))))</span>  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> e<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span></code></pre></div><h2 id=java-8-1>Java 8
<a class=anchor href=#java-8-1>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> V <span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>Object key<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>    Node<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> e<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>e <span style=color:#f92672>=</span> getNode<span style=color:#f92672>(</span>hash<span style=color:#f92672>(</span>key<span style=color:#f92672>),</span> key<span style=color:#f92672>))</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>:</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>final</span> Node<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getNode</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> hash<span style=color:#f92672>,</span> Object key<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>    Node<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;[]</span> tab<span style=color:#f92672>;</span> Node<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> first<span style=color:#f92672>,</span> e<span style=color:#f92672>;</span> <span style=color:#66d9ef>int</span> n<span style=color:#f92672>;</span> K k<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>tab <span style=color:#f92672>=</span> table<span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>(</span>n <span style=color:#f92672>=</span> tab<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>)</span> <span style=color:#f92672>&gt;</span> 0 <span style=color:#f92672>&amp;&amp;</span>  
</span></span><span style=display:flex><span>        <span style=color:#f92672>(</span>first <span style=color:#f92672>=</span> tab<span style=color:#f92672>[(</span>n <span style=color:#f92672>-</span> 1<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;</span> hash<span style=color:#f92672>])</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 先判断 tab[index] 中的第一个元素  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>first<span style=color:#f92672>.</span><span style=color:#a6e22e>hash</span> <span style=color:#f92672>==</span> hash <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75715e>// always check first node  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#f92672>((</span>k <span style=color:#f92672>=</span> first<span style=color:#f92672>.</span><span style=color:#a6e22e>key</span><span style=color:#f92672>)</span> <span style=color:#f92672>==</span> key <span style=color:#f92672>||</span> <span style=color:#f92672>(</span>key <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> key<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>k<span style=color:#f92672>))))</span>  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> first<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>e <span style=color:#f92672>=</span> first<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 结点为红黑树则使用 TreeNode 的方法获取  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>first <span style=color:#66d9ef>instanceof</span> TreeNode<span style=color:#f92672>)</span>  
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#f92672>((</span>TreeNode<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;)</span>first<span style=color:#f92672>).</span><span style=color:#a6e22e>getTreeNode</span><span style=color:#f92672>(</span>hash<span style=color:#f92672>,</span> key<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>do</span> <span style=color:#f92672>{</span> <span style=color:#75715e>//否则遍历链表  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>hash</span> <span style=color:#f92672>==</span> hash <span style=color:#f92672>&amp;&amp;</span>  
</span></span><span style=display:flex><span>                    <span style=color:#f92672>((</span>k <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>key</span><span style=color:#f92672>)</span> <span style=color:#f92672>==</span> key <span style=color:#f92672>||</span> <span style=color:#f92672>(</span>key <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> key<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>k<span style=color:#f92672>))))</span>  
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> e<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>while</span> <span style=color:#f92672>((</span>e <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span></code></pre></div><p>遍历方式</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Integer<span style=color:#f92672>&gt;</span> map <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Integer<span style=color:#f92672>&gt;()</span> <span style=color:#f92672>{{</span>  
</span></span><span style=display:flex><span>    put<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;a&#34;</span><span style=color:#f92672>,</span> 10<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>    put<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;b&#34;</span><span style=color:#f92672>,</span> 20<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}};</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>// 方式一：迭代 entrySet  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Map<span style=color:#f92672>.</span><span style=color:#a6e22e>Entry</span><span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Integer<span style=color:#f92672>&gt;</span> entry <span style=color:#f92672>:</span> map<span style=color:#f92672>.</span><span style=color:#a6e22e>entrySet</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>    String key <span style=color:#f92672>=</span> entry<span style=color:#f92672>.</span><span style=color:#a6e22e>getKey</span><span style=color:#f92672>();</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> value <span style=color:#f92672>=</span> entry<span style=color:#f92672>.</span><span style=color:#a6e22e>getValue</span><span style=color:#f92672>();</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 方式二：单独迭代 keySet 或 values  
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 迭代键  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>String key <span style=color:#f92672>:</span> map<span style=color:#f92672>.</span><span style=color:#a6e22e>keySet</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Key = &#34;</span> <span style=color:#f92672>+</span> key<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>// 迭代值  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Integer value <span style=color:#f92672>:</span> map<span style=color:#f92672>.</span><span style=color:#a6e22e>values</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Value = &#34;</span> <span style=color:#f92672>+</span> value<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 方式三：使用 iterator  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span>Iterator<span style=color:#f92672>&lt;</span>Map<span style=color:#f92672>.</span><span style=color:#a6e22e>Entry</span><span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Integer<span style=color:#f92672>&gt;&gt;</span> entries <span style=color:#f92672>=</span>         
</span></span><span style=display:flex><span>          map<span style=color:#f92672>.</span><span style=color:#a6e22e>entrySet</span><span style=color:#f92672>().</span><span style=color:#a6e22e>iterator</span><span style=color:#f92672>();</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>entries<span style=color:#f92672>.</span><span style=color:#a6e22e>hasNext</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>    Map<span style=color:#f92672>.</span><span style=color:#a6e22e>Entry</span><span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Integer<span style=color:#f92672>&gt;</span> entry <span style=color:#f92672>=</span> entries<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>();</span>  
</span></span><span style=display:flex><span>    String key <span style=color:#f92672>=</span> entry<span style=color:#f92672>.</span><span style=color:#a6e22e>getKey</span><span style=color:#f92672>();</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> value <span style=color:#f92672>=</span> entry<span style=color:#f92672>.</span><span style=color:#a6e22e>getValue</span><span style=color:#f92672>();</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 方式四：Lambda 表达式  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>map<span style=color:#f92672>.</span><span style=color:#a6e22e>forEach</span><span style=color:#f92672>((</span>k<span style=color:#f92672>,</span> v<span style=color:#f92672>)</span> <span style=color:#f92672>-&gt;</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;key: &#34;</span> <span style=color:#f92672>+</span> k <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; value:&#34;</span> <span style=color:#f92672>+</span> v<span style=color:#f92672>));</span>  
</span></span></code></pre></div><h1 id=面试题>面试题
<a class=anchor href=#%e9%9d%a2%e8%af%95%e9%a2%98>#</a></h1><h2 id=为什么-hashmap-数组长度为-2-的幂次方>为什么 HashMap 数组长度为 2 的幂次方？
<a class=anchor href=#%e4%b8%ba%e4%bb%80%e4%b9%88-hashmap-%e6%95%b0%e7%bb%84%e9%95%bf%e5%ba%a6%e4%b8%ba-2-%e7%9a%84%e5%b9%82%e6%ac%a1%e6%96%b9>#</a></h2><p>如果数组中 hash 冲突太过频繁，某些位置的元素形成过长的链表，就会导致数据存取效率过低，因此要使元素均匀地分布在数组中，hash 碰撞就不能太频繁。而 hash 值范围为 -2147483648 到 2147483647，如果用如此长的数组来进行存放加上合理 hash 映射确实可以使 hash 碰撞降到很低的水平，但这明显是不现实的。</p><p>因此这个 hash 值是不能直接使用的，首先需要进行二次 hash 使得结果更加随机，这时理论上可以使用 hash % length 得到一个不小于数组长度 length 的 index 值，这样不但能避免产生数组越界，并且可以使元素均匀分布，事实上很多 hash 算法都是采用该方法。但是在计算机中，% 取模运算比位 & 运算的效率要低得多，而当 length 为 2 的幂次方时，hash % length 刚好等于 hash & (length - 1) ，从而能够将 % 运算转换成 & 运算，更加快速地得到 index 值。</p><p>因此采用 2 的幂次方作为数组的长度的好处是：使元素均匀分部以降低 hash 冲突的基础上，大大加快了计算元素所在数组位置的速度。</p><h2 id=hash-冲突有哪些解决方法hashmap-是怎样解决的>hash 冲突有哪些解决方法？HashMap 是怎样解决的？
<a class=anchor href=#hash-%e5%86%b2%e7%aa%81%e6%9c%89%e5%93%aa%e4%ba%9b%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95hashmap-%e6%98%af%e6%80%8e%e6%a0%b7%e8%a7%a3%e5%86%b3%e7%9a%84>#</a></h2><p>1. 二次 hash，通过高 16 位与低 16 位异或运算，使得结果更加随机；<br>2. 拉链地址法，将 hash 值相同的元素串成一个链表或者转为红黑树。</p><h2 id=hashmap-会造成哪些安全问题怎么解决>HashMap 会造成哪些安全问题？怎么解决？
<a class=anchor href=#hashmap-%e4%bc%9a%e9%80%a0%e6%88%90%e5%93%aa%e4%ba%9b%e5%ae%89%e5%85%a8%e9%97%ae%e9%a2%98%e6%80%8e%e4%b9%88%e8%a7%a3%e5%86%b3>#</a></h2><p>如前面文章所述，在 Java 7 中，HashMap 在扩容的时候是通过遍历旧数组，然后在新数组中使用头插法进行转移元素的。这在单线程环境中是没有问题的，但是到了多线程环境下，由于 JMM 的特性，会以一定的概率形成环形链表的情况。在 Java 8 中这个问题通过使用尾插法得到解决，但是多线程下很多操作仍然会导致线程安全问题，比如多个线程 put 后某些元素丢失等。因此多线程环境下要保证线程安全，可以使用 ConcurentHashMap 代替 HashMap。</p><h2 id=使用对象作为-hashmap-的-key-应该注意什么>使用对象作为 HashMap 的 key 应该注意什么？
<a class=anchor href=#%e4%bd%bf%e7%94%a8%e5%af%b9%e8%b1%a1%e4%bd%9c%e4%b8%ba-hashmap-%e7%9a%84-key-%e5%ba%94%e8%af%a5%e6%b3%a8%e6%84%8f%e4%bb%80%e4%b9%88>#</a></h2><p>应当重写对象的 hashCode() 和 equals() 方法。如前面代码所示，HashMap 在 put 一个元素的时候，会调用此元素的 key 值的 hashCode 方法确定元素存放位置，并且会调用 hashCode 和 equals 方法判断元素是否相等。因此如果没有重写这两个方法，或者方法重写的时候没有遵守规则，HashMap 通过 put 存入一组元素后，再通过此元素的 key 值去 get 对象的时候就有可能出现跟预期结果不一致的情况。</p><p>在重写 equals 方法的时候，需要遵守下面的通用约定：</p><p>- <strong>自反性</strong>：对于任何非空引用 x，x.equals(x) 必须返回 true；<br>- <strong>对称性</strong>：对于任何非空引用 x 和 y，如果且仅当 y.equals(x) 返回 true 时 x.equals(y) 必须返回 true；<br>- <strong>传递性</strong>：对于任何非空引用 x、y、z，如果 x.equals(y) 返回 true，y.equals(z) 返回 true，则 x.equals(z) 必须返回 true；<br>- <strong>一致性</strong>：对于任何非空引用 x 和 y，如果在 equals 比较中使用的信息没有修改，则 x.equals(y) 的多次调用必须始终返回 true 或始终返回 false；<br>- <strong>非空性</strong>：对于任何非空引用 x，x.equals(null) 必须返回 false。</p><p><strong>重写 hashCode 方法的大致方式（非强制）：</strong></p><p>1. 把某个非零常数值，比如说 31（最好是素数，考虑到 HashMap 源码中的异或操作），保存在一个叫 result 的 int 类型的变量中。<br>2. 对于对象中每一个关键域 f（值 equals 方法中考虑的每一个域），完成以下步骤：<br>3. 为该域计算 int 类型的散列码 c:</p><pre tabindex=0><code>1. 如果该域是 boolean 类型，则计算 (f?0:1)  
  
2. 如果该域是 byte、char、short 或者 int 类型，则计算 (int)f  
  
3. 如果该域是 float 类型，则计算 Float.floatToIntBits(f)  
  
4. 如果该域是 long 类型，则计算 (int)(f ^ (f&gt;&gt;&gt;32))  
  
5. 如果该域是double类型，则计算 Double.doubleToLongBits(f) 得到一个 long 类型的值，然后按照步骤 4，对该 long 型值计算散列值  
  
6. 如果该域是一个对象引用，并且该类的 equals 方法通过递归调用 equals 的方式来比较这个域，则同样对这个对象递归调用 hashCode 方法。  
  
7. 如果该域是一个数组，则把每一个元素当做单独的域来处理。也就是说，递归地应用上述规则，对每个重要的元素计算一个散列码，然后根据步骤下面的做法把这些散列值组合起来。  
</code></pre><p>2. 按照下面的公式，把步骤 1 中计算得到的散列码 c 组合到 result 中：result = 31 x result+c。<br>3. 返回 result。<br>4. 写完 hashCode 方法之后，确认是否相等的实例具有相等的散列码。如果不是的话，找出原因，并修改。</p><p>样例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Student</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String name<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> age<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Grades grades<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Student</span><span style=color:#f92672>(</span>String name<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> age<span style=color:#f92672>,</span> Grades grades<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> name<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>age</span> <span style=color:#f92672>=</span> age<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>grades</span> <span style=color:#f92672>=</span> grades<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>hashCode</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> prime <span style=color:#f92672>=</span> 31<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> result <span style=color:#f92672>=</span> 1<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> prime <span style=color:#f92672>*</span> result <span style=color:#f92672>+</span> age<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> prime <span style=color:#f92672>*</span> result <span style=color:#f92672>+</span>  
</span></span><span style=display:flex><span>                <span style=color:#f92672>((</span>name <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>?</span> 0 <span style=color:#f92672>:</span> name<span style=color:#f92672>.</span><span style=color:#a6e22e>hashCode</span><span style=color:#f92672>());</span>  
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> prime <span style=color:#f92672>*</span> result <span style=color:#f92672>+</span>  
</span></span><span style=display:flex><span>                <span style=color:#f92672>(</span>grades <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> 0 <span style=color:#f92672>:</span> grades<span style=color:#f92672>.</span><span style=color:#a6e22e>hashCode</span><span style=color:#f92672>());</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>Object obj<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span> <span style=color:#f92672>==</span> obj<span style=color:#f92672>)</span> <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>obj <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> getClass<span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> obj<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>())</span> <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        Student other <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>Student<span style=color:#f92672>)</span> obj<span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>age <span style=color:#f92672>!=</span> other<span style=color:#f92672>.</span><span style=color:#a6e22e>age</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>name <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> <span style=color:#f92672>!</span>name<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>other<span style=color:#f92672>.</span><span style=color:#a6e22e>name</span><span style=color:#f92672>)</span> <span style=color:#f92672>:</span>   
</span></span><span style=display:flex><span>              other<span style=color:#f92672>.</span><span style=color:#a6e22e>name</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>grades <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> <span style=color:#f92672>!</span>grades<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>other<span style=color:#f92672>.</span><span style=color:#a6e22e>grades</span><span style=color:#f92672>)</span> <span style=color:#f92672>:</span>           
</span></span><span style=display:flex><span>              other<span style=color:#f92672>.</span><span style=color:#a6e22e>grades</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span></code></pre></div><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://guanpj.github.io/amethyst/quartz/js/graph.cbd78cfa87df7d3e230d16fc24f06548.js></script></div></div><div id=contact_buttons><footer><p>Made with <a href=https://github.com/64bitpandas/amethyst>Amethyst</a>, © 2023 guanpj</p><ul><li><a href=https://guanpj.github.io/amethyst/>Home</a></li><li><a href=https://bencuan.me>Website</a></li><li><a href=https://blog.bencuan.me>Blog</a></li></ul></footer></div></article><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#成员变量>成员变量</a></li><li><a href=#数据结构>数据结构</a></li><li><a href=#put-流程分析>put 流程分析</a><ul><li><a href=#java-7-put-流程>Java 7 put 流程</a><ul><li><a href=#代码分析>代码分析</a></li><li><a href=#流程图示>流程图示</a></li></ul></li><li><a href=#java-8-put-流程>Java 8 put 流程</a><ul><li><a href=#代码分析-1>代码分析</a><ul><li><a href=#流程图示-1>流程图示</a></li></ul></li></ul></li></ul></li><li><a href=#hash-计算与元素位置确定>hash 计算与元素位置确定</a><ul><li><a href=#java-7>Java 7</a></li><li><a href=#java-8>Java 8</a></li></ul></li><li><a href=#扩容流程>扩容流程</a><ul><li><a href=#java-7-扩容流程>Java 7 扩容流程</a><ul><li><a href=#代码分析-2>代码分析</a></li><li><a href=#扩容流程在多线程环境下的隐患>扩容流程在多线程环境下的隐患</a></li></ul></li><li><a href=#java-8-扩容流程>Java 8 扩容流程</a><ul><li><a href=#代码分析-3>代码分析</a></li></ul></li><li><a href=#扩容流程对比>扩容流程对比</a></li></ul></li><li><a href=#get-流程分析>get 流程分析</a><ul><li><a href=#java-7-1>Java 7</a></li><li><a href=#java-8-1>Java 8</a></li></ul></li><li><a href=#面试题>面试题</a><ul><li><a href=#为什么-hashmap-数组长度为-2-的幂次方>为什么 HashMap 数组长度为 2 的幂次方？</a></li><li><a href=#hash-冲突有哪些解决方法hashmap-是怎样解决的>hash 冲突有哪些解决方法？HashMap 是怎样解决的？</a></li><li><a href=#hashmap-会造成哪些安全问题怎么解决>HashMap 会造成哪些安全问题？怎么解决？</a></li><li><a href=#使用对象作为-hashmap-的-key-应该注意什么>使用对象作为 HashMap 的 key 应该注意什么？</a></li></ul></li></ul></nav></div></aside></main></body></html>