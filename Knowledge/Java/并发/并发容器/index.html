<!doctype html><html lang=en dir=ltr><head><meta property="og:title" content="并发容器"><meta property="og:description" content="ConcurentHashMap #  Java 7 实现 #  Java 7 版本的 ConcurrentHashMap 数据结构示意图：
 ConcurrentHashMap 内部进行了 Segment 分段，Segment 继承了 ReentrantLock，可以理解为一把锁，各个 Segment 之间都是相互独立上锁的，互不影响。相比于之前的 Hashtable 每次操作都需要把整个对象锁住而言，大大提高了并发效率。因为它的锁与锁之间是独立的，而不是整个对象只有一把锁。
每个 Segment 的底层数据结构与 HashMap 类似，仍然是数组和链表组成的拉链法结构。默认有 0~15 共 16 个 Segment，所以最多可以同时支持 16 个线程并发操作（操作分别分布在不同的 Segment 上）。16 这个默认值可以在初始化的时候设置为其他值，但是一旦确认初始化以后，是不可以扩容的。
构造方法 #  public ConcurrentHashMap(int initialCapacity,  float loadFactor, int concurrencyLevel) {  if (!(loadFactor > 0) || initialCapacity < 0  || concurrencyLevel <= 0)  throw new IllegalArgumentException();  if (concurrencyLevel > MAX_SEGMENTS)  concurrencyLevel = MAX_SEGMENTS;  // Find power-of-two sizes best matching arguments  int sshift = 0;  int ssize = 1;  while (ssize < concurrencyLevel) {  ++sshift;  ssize <<= 1;  }  this."><meta property="og:type" content="article"><meta property="og:url" content="https://guanpj.github.io/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/"><meta property="article:section" content="Knowledge"><meta property="og:site_name" content="guanpj's blog"><title>并发容器 | guanpj's blog</title><link rel=manifest href=/amethyst/manifest.json><link rel=icon href=/amethyst/favicon.png type=image/x-icon><link rel=stylesheet href=/amethyst/book.min.c27ff4755c78daab11627953d5a6dd7e2698690e086398032995aae74d6397b6.css integrity="sha256-wn/0dVx42qsRYnlT1abdfiaYaQ4IY5gDKZWq501jl7Y=" crossorigin=anonymous><meta charset=utf-8><meta name=description content="ConcurentHashMap #  Java 7 实现 #  Java 7 版本的 ConcurrentHashMap 数据结构示意图：
 ConcurrentHashMap 内部进行了 Segment 分段，Segment 继承了 ReentrantLock，可以理解为一把锁，各个 Segment 之间都是相互独立上锁的，互不影响。相比于之前的 Hashtable 每次操作都需要把整个对象锁住而言，大大提高了并发效率。因为它的锁与锁之间是独立的，而不是整个对象只有一把锁。
每个 Segment 的底层数据结构与 HashMap 类似，仍然是数组和链表组成的拉链法结构。默认有 0~15 共 16 个 Segment，所以最多可以同时支持 16 个线程并发操作（操作分别分布在不同的 Segment 上）。16 这个默认值可以在初始化的时候设置为其他值，但是一旦确认初始化以后，是不可以扩容的。
构造方法 #  public ConcurrentHashMap(int initialCapacity,  float loadFactor, int concurrencyLevel) {  if (!(loadFactor > 0) || initialCapacity < 0  || concurrencyLevel <= 0)  throw new IllegalArgumentException();  if (concurrencyLevel > MAX_SEGMENTS)  concurrencyLevel = MAX_SEGMENTS;  // Find power-of-two sizes best matching arguments  int sshift = 0;  int ssize = 1;  while (ssize < concurrencyLevel) {  ++sshift;  ssize <<= 1;  }  this."><title>并发容器</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://guanpj.github.io/amethyst//favicon.png><link href=https://guanpj.github.io/amethyst/styles.e08ceb33360cec132feb69cfb982e2a4.min.css rel=stylesheet><link href=https://guanpj.github.io/amethyst/quartz/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://guanpj.github.io/amethyst/quartz/js/darkmode.1bc498b60ed24d8858f74f99e480db82.min.js></script>
<script src=https://guanpj.github.io/amethyst/quartz/js/util.c69e233dc1cc331a30b0f670e657b425.min.js></script>
<script async src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script async src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://guanpj.github.io/amethyst/quartz/js/popover.f03552ccb84d99ca615d1cfb9abde59e.min.js></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://guanpj.github.io/amethyst/",fetchData=Promise.all([fetch("https://guanpj.github.io/amethyst/indices/linkIndex.f13ba8f7c67305f3500d259bdfb72f53.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://guanpj.github.io/amethyst/indices/contentIndex.767b9c56833005004f7fb80c5d9acd82.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addCollapsibleCallouts(),initPopover("https://guanpj.github.io/amethyst",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!0;drawGraph("https://guanpj.github.io/amethyst",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script>window.Million={navigate:e=>window.location.href=e,prefetch:()=>{}},window.addEventListener("DOMContentLoaded",()=>{init(),render()})</script></head><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><header class=book-header><label for=menu-control><img src=/amethyst/svg/menu.svg class=book-icon alt=Menu></label><h1 id=page-title><a href=https://guanpj.github.io/amethyst/>guanpj's blog</a></h1><div class=spacer></div><div id=search-icon class=quartz-search><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control><main class=flex><aside class=book-menu><div class=book-menu-content><nav><div class=menu-search><div id=search-icon class=quartz-search><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div></div><ul><li><span class=book-menu-title>Atlas</span><ul><li><a href=/amethyst/Atlas/About-Atlas/>About Atlas</a></li><li><a href=/amethyst/Atlas/Index-for-Atlases/>Index for Atlases</a></li></ul></li><li><span class=book-menu-title>Dashborads</span><ul><li><a href=/amethyst/Dashborad/Buttons/>Buttons</a></li><li><a href=/amethyst/Dashborad/ControlPanel/>Control Panel</a></li></ul></li><li><span class=book-menu-title>Excalidraws</span><ul><li><a href=/amethyst/Excalidraw/MyDraw/>My Draw</a></li></ul></li><li><span class=book-menu-title>Extras</span><ul><li><a href=/amethyst/Extras/Linter/>Linter</a></li><li><a href=/amethyst/Extras/Index-for-Extras/>Index for Extras</a></li></ul></li><li><a href=/amethyst/Home/>Home</a></li><li><span class=book-menu-title>Knowledges</span><ul><li><a href=/amethyst/Knowledge/Kotlin/%E5%A7%94%E6%89%98/>委托</a></li><li><a href=/amethyst/Knowledge/Kotlin/%E6%89%A9%E5%B1%95%E5%87%BD%E6%95%B0/>扩展函数</a></li><li><a href=/amethyst/Knowledge/Python/%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%96%87%E6%9C%AC%E6%9B%BF%E6%8D%A2/>文件读取、文本替换</a></li><li><a href=/amethyst/Knowledge/Python/%E7%B1%BB%E7%9A%84%E5%AE%9A%E4%B9%89%E4%BD%BF%E7%94%A8/>类的定义、使用</a></li><li><a href=/amethyst/Knowledge/Python/%E9%81%8D%E5%8E%86%E6%96%87%E4%BB%B6%E9%87%8D%E5%91%BD%E5%90%8D/>遍历文件、重命名</a></li><li><a href=/amethyst/Knowledge/%E7%AE%97%E6%B3%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E5%BC%95%E7%94%A8/>引用</a></li><li><a href=/amethyst/Knowledge/%E7%AE%97%E6%B3%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%8C%87%E9%92%88/>指针</a></li><li><a href=/amethyst/Knowledge/Android/Android-%E5%9F%BA%E7%A1%80/ADB-%E5%91%BD%E4%BB%A4/>ADB 命令</a></li><li><a href=/amethyst/Knowledge/Android/%E7%83%AD%E4%BF%AE%E5%A4%8D%E6%8F%92%E4%BB%B6%E5%8C%96/Java-%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/>ADB 命令</a></li><li><a href=/amethyst/Knowledge/Android/Android-%E5%9F%BA%E7%A1%80/Android-%E5%AF%B9%E5%AE%B9%E5%99%A8%E7%B1%BB%E7%9A%84%E4%BC%98%E5%8C%96/>Android 对容器类的优化</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/CAS-%E5%92%8C-AQS-%E5%8E%9F%E7%90%86/>CAS 和 AQS 原理</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/EventBus-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>EventBus 使用及源码解析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/Glide-%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E5%92%8C%E7%BC%93%E5%AD%98%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/>Glide 加载流程和缓存原理分析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/Glide-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/>Glide 基本使用</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/Glide-%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95/>Glide 高级用法</a></li><li><a href=/amethyst/Knowledge/Java/%E5%9F%BA%E7%A1%80/HashMap-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>HashMap 源码解析</a></li><li><a href=/amethyst/Knowledge/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9B%B8%E5%85%B3/HTTP-%E5%9F%BA%E7%A1%80/>HTTP 基础</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/Java-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/>Java 内存模型</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E4%B8%AD%E7%9A%84%E5%AF%B9%E8%B1%A1%E5%92%8C%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/>JVM 中的对象和垃圾回收</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F/>JVM 内存区域</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E5%AD%97%E8%8A%82%E7%A0%81%E6%8C%87%E4%BB%A4%E7%AE%80%E4%BB%8B/>JVM 字节码指令简介</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E5%AD%97%E8%8A%82%E7%A0%81%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/>JVM 字节码结构分析</a></li><li><a href=/amethyst/Knowledge/Java/%E8%99%9A%E6%8B%9F%E6%9C%BA/JVM-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/>JVM 类加载机制</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/LeakCanary-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>LeakCanary 使用及源码解析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/OkHttp-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>OkHttp 使用及源码分析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/Retrofit-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>Retrofit 使用及源码分析</a></li><li><a href=/amethyst/Knowledge/Android/%E5%BC%80%E6%BA%90%E5%BA%93/RxJava-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>RxJava 使用及源码分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%B8%80Binder-%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90%E6%A6%82%E5%BF%B5%E7%AF%87/>一、Binder 机制分析——概念篇</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%B8%83View-%E4%BA%8B%E4%BB%B6%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/>七、View 事件机制分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%B8%89Handler-%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/>三、Handler 原理分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%BA%8CBinder-%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90%E5%BA%94%E7%94%A8%E7%AF%87/>二、Binder 机制分析——应用篇</a></li><li><a href=/amethyst/Knowledge/%E7%AE%97%E6%B3%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E4%BA%8C%E5%8F%89%E6%A0%91%E9%81%8D%E5%8E%86/>二叉树遍历</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E4%BA%94App-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/>五、App 启动流程分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E5%85%ADView-%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/>六、View 绘制流程分析</a></li><li><a href=/amethyst/Knowledge/Android/Framework/%E5%9B%9B%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/>四、系统启动流程分析</a></li><li><a href=/amethyst/Knowledge/Java/%E5%9F%BA%E7%A1%80/%E5%AE%B9%E5%99%A8%E7%B1%BB/>容器类</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/ class=active>并发容器</a></li><li><a href=/amethyst/Knowledge/Java/%E5%9F%BA%E7%A1%80/%E6%B3%9B%E5%9E%8B/>泛型</a></li><li><a href=/amethyst/Knowledge/Java/%E5%9F%BA%E7%A1%80/%E6%B3%A8%E8%A7%A3%E5%92%8C%E5%8F%8D%E5%B0%84/>注解和反射</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E7%AD%89%E5%BE%85-%E9%80%9A%E7%9F%A5%E6%9C%BA%E5%88%B6/>等待-通知机制</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E7%BA%BF%E7%A8%8B%E5%8D%8F%E4%BD%9C/>线程协作</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80/>线程基础</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%92%8C-BlockingQueue/>线程池和 BlockingQueue</a></li><li><a href=/amethyst/Knowledge/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9B%B8%E5%85%B3/%E7%BC%96%E7%A0%81%E5%8A%A0%E5%AF%86Hash%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%AD%97%E7%AC%A6%E9%9B%86/>编码、加密、Hash、序列化和字符集</a></li><li><a href=/amethyst/Knowledge/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9B%B8%E5%85%B3/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84TCPIP-%E5%92%8C-HTTPS/>计算机网络体系结构、TCP&IP 和 HTTPS</a></li><li><a href=/amethyst/Knowledge/Java/%E5%B9%B6%E5%8F%91/%E9%94%81/>锁</a></li></ul></li><li><span class=book-menu-title>Notes</span><ul><li><a href=/amethyst/Notes/2023-03-15/>2023 03 15</a></li><li><a href=/amethyst/Notes/2023-03-18/>2023 03 18</a></li><li><a href=/amethyst/Notes/2023-03-19/>2023 03 19</a></li><li><a href=/amethyst/Notes/2023-03-20/>2023 03 20</a></li><li><a href=/amethyst/Notes/2023-03-22/>Troubleshooting and FAQ</a></li></ul></li><li><span class=book-menu-title>Templates</span><ul><li><a href=/amethyst/Templates/%E5%85%B6%E4%BB%96%E6%A8%A1%E7%89%88/>其他模版</a></li></ul></li><li><span class=book-menu-title>Temps</span><ul><li><a href=/amethyst/Temp/MyIdeas/>MyIdeas</a></li></ul></li></ul><ul><li><a href=https://github.com/64bitpandas/amethyst target=_blank rel=noopener>Github</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class="book-page container"><article class=markdown><h1 class=title>并发容器</h1><h1 id=concurenthashmap>ConcurentHashMap
<a class=anchor href=#concurenthashmap>#</a></h1><h2 id=java-7-实现>Java 7 实现
<a class=anchor href=#java-7-%e5%ae%9e%e7%8e%b0>#</a></h2><p>Java 7 版本的 ConcurrentHashMap 数据结构示意图：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Concurent-Container/clipboard_20230323_094240.png width=auto alt></p><p>ConcurrentHashMap 内部进行了 Segment 分段，Segment 继承了 ReentrantLock，可以理解为一把锁，各个 Segment 之间都是相互独立上锁的，互不影响。相比于之前的 Hashtable 每次操作都需要把整个对象锁住而言，大大提高了并发效率。因为它的锁与锁之间是独立的，而不是整个对象只有一把锁。</p><p>每个 Segment 的底层数据结构与 HashMap 类似，仍然是数组和链表组成的拉链法结构。默认有 0~15 共 16 个 Segment，所以最多可以同时支持 16 个线程并发操作（操作分别分布在不同的 Segment 上）。16 这个默认值可以在初始化的时候设置为其他值，但是一旦确认初始化以后，是不可以扩容的。</p><h3 id=构造方法>构造方法
<a class=anchor href=#%e6%9e%84%e9%80%a0%e6%96%b9%e6%b3%95>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>ConcurrentHashMap</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> initialCapacity<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                         <span style=color:#66d9ef>float</span> loadFactor<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> concurrencyLevel<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!(</span>loadFactor <span style=color:#f92672>&gt;</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>||</span> initialCapacity <span style=color:#f92672>&lt;</span> 0 
</span></span><span style=display:flex><span>            <span style=color:#f92672>||</span> concurrencyLevel <span style=color:#f92672>&lt;=</span> 0<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>concurrencyLevel <span style=color:#f92672>&gt;</span> MAX_SEGMENTS<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        concurrencyLevel <span style=color:#f92672>=</span> MAX_SEGMENTS<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Find power-of-two sizes best matching arguments
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> sshift <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> ssize <span style=color:#f92672>=</span> 1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>ssize <span style=color:#f92672>&lt;</span> concurrencyLevel<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>++</span>sshift<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        ssize <span style=color:#f92672>&lt;&lt;=</span> 1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>segmentShift</span> <span style=color:#f92672>=</span> 32 <span style=color:#f92672>-</span> sshift<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>segmentMask</span> <span style=color:#f92672>=</span> ssize <span style=color:#f92672>-</span> 1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>initialCapacity <span style=color:#f92672>&gt;</span> MAXIMUM_CAPACITY<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        initialCapacity <span style=color:#f92672>=</span> MAXIMUM_CAPACITY<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> c <span style=color:#f92672>=</span> initialCapacity <span style=color:#f92672>/</span> ssize<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>c <span style=color:#f92672>*</span> ssize <span style=color:#f92672>&lt;</span> initialCapacity<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>++</span>c<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> cap <span style=color:#f92672>=</span> MIN_SEGMENT_TABLE_CAPACITY<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>cap <span style=color:#f92672>&lt;</span> c<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        cap <span style=color:#f92672>&lt;&lt;=</span> 1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// create segments and segments[0]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Segment<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> s0 <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> Segment<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;(</span>loadFactor<span style=color:#f92672>,</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span><span style=color:#f92672>)(</span>cap <span style=color:#f92672>*</span> loadFactor<span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>                         <span style=color:#f92672>(</span>HashEntry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;[])</span><span style=color:#66d9ef>new</span> HashEntry<span style=color:#f92672>[</span>cap<span style=color:#f92672>]);</span>
</span></span><span style=display:flex><span>    Segment<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;[]</span> ss <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>Segment<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;[])</span><span style=color:#66d9ef>new</span> Segment<span style=color:#f92672>[</span>ssize<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>    UNSAFE<span style=color:#f92672>.</span><span style=color:#a6e22e>putOrderedObject</span><span style=color:#f92672>(</span>ss<span style=color:#f92672>,</span> SBASE<span style=color:#f92672>,</span> s0<span style=color:#f92672>);</span> <span style=color:#75715e>// ordered write of segments[0]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>segments</span> <span style=color:#f92672>=</span> ss<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=segment>Segment
<a class=anchor href=#segment>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Segment</span><span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>extends</span> ReentrantLock <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> MAX_SCAN_RETRIES <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        Runtime<span style=color:#f92672>.</span><span style=color:#a6e22e>getRuntime</span><span style=color:#f92672>().</span><span style=color:#a6e22e>availableProcessors</span><span style=color:#f92672>()</span> <span style=color:#f92672>&gt;</span> 1 <span style=color:#f92672>?</span> 64 <span style=color:#f92672>:</span> 1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>transient</span> <span style=color:#66d9ef>volatile</span> HashEntry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;[]</span> table<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>transient</span> <span style=color:#66d9ef>int</span> count<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>transient</span> <span style=color:#66d9ef>int</span> modCount<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>transient</span> <span style=color:#66d9ef>int</span> threshold<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>float</span> loadFactor<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> V <span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>K key<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> hash<span style=color:#f92672>,</span> V value<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> onlyIfAbsent<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        HashEntry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> node <span style=color:#f92672>=</span> tryLock<span style=color:#f92672>()</span> <span style=color:#f92672>?</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            scanAndLockForPut<span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> hash<span style=color:#f92672>,</span> value<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        V oldValue<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            HashEntry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;[]</span> tab <span style=color:#f92672>=</span> table<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> index <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>tab<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> 1<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;</span> hash<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            HashEntry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> first <span style=color:#f92672>=</span> entryAt<span style=color:#f92672>(</span>tab<span style=color:#f92672>,</span> index<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>HashEntry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> e <span style=color:#f92672>=</span> first<span style=color:#f92672>;;)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>e <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    K k<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>k <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>key</span><span style=color:#f92672>)</span> <span style=color:#f92672>==</span> key <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>(</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>hash</span> <span style=color:#f92672>==</span> hash <span style=color:#f92672>&amp;&amp;</span> key<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>k<span style=color:#f92672>)))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        oldValue <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>onlyIfAbsent<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            e<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span> <span style=color:#f92672>=</span> value<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#f92672>++</span>modCount<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    e <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>node <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                        node<span style=color:#f92672>.</span><span style=color:#a6e22e>setNext</span><span style=color:#f92672>(</span>first<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>                        node <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashEntry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;(</span>hash<span style=color:#f92672>,</span> 
</span></span><span style=display:flex><span>                                key<span style=color:#f92672>,</span> value<span style=color:#f92672>,</span> first<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>int</span> c <span style=color:#f92672>=</span> count <span style=color:#f92672>+</span> 1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>c <span style=color:#f92672>&gt;</span> threshold <span style=color:#f92672>&amp;&amp;</span> 
</span></span><span style=display:flex><span>                          tab<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span> <span style=color:#f92672>&lt;</span> MAXIMUM_CAPACITY<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                        rehash<span style=color:#f92672>(</span>node<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>                        setEntryAt<span style=color:#f92672>(</span>tab<span style=color:#f92672>,</span> index<span style=color:#f92672>,</span> node<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>++</span>modCount<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    count <span style=color:#f92672>=</span> c<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    oldValue <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            unlock<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> oldValue<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> HashEntry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>scanAndLockForPut</span><span style=color:#f92672>(</span>K key<span style=color:#f92672>,</span> 
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> hash<span style=color:#f92672>,</span> V value<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        HashEntry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> first <span style=color:#f92672>=</span> entryForHash<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> hash<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        HashEntry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> e <span style=color:#f92672>=</span> first<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        HashEntry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> node <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> retries <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>;</span> <span style=color:#75715e>// negative while locating node
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>while</span> <span style=color:#f92672>(!</span>tryLock<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            HashEntry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> f<span style=color:#f92672>;</span> <span style=color:#75715e>// to recheck first below
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>retries <span style=color:#f92672>&lt;</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>e <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>node <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#75715e>// speculatively create node
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        node <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashEntry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;(</span>hash<span style=color:#f92672>,</span> 
</span></span><span style=display:flex><span>                                key<span style=color:#f92672>,</span> value<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    retries <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>key<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>key</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>                    retries <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>                    e <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(++</span>retries <span style=color:#f92672>&gt;</span> MAX_SCAN_RETRIES<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                lock<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>retries <span style=color:#f92672>&amp;</span> 1<span style=color:#f92672>)</span> <span style=color:#f92672>==</span> 0 <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>                 <span style=color:#f92672>(</span>f <span style=color:#f92672>=</span> entryForHash<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> hash<span style=color:#f92672>))</span> <span style=color:#f92672>!=</span> first<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                e <span style=color:#f92672>=</span> first <span style=color:#f92672>=</span> f<span style=color:#f92672>;</span> <span style=color:#75715e>// re-traverse if entry changed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                retries <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> node<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>rehash</span><span style=color:#f92672>(</span>HashEntry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> node<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        HashEntry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;[]</span> oldTable <span style=color:#f92672>=</span> table<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> oldCapacity <span style=color:#f92672>=</span> oldTable<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> newCapacity <span style=color:#f92672>=</span> oldCapacity <span style=color:#f92672>&lt;&lt;</span> 1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        threshold <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span><span style=color:#f92672>)(</span>newCapacity <span style=color:#f92672>*</span> loadFactor<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        HashEntry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;[]</span> newTable <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>(</span>HashEntry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;[])</span> <span style=color:#66d9ef>new</span> HashEntry<span style=color:#f92672>[</span>newCapacity<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> sizeMask <span style=color:#f92672>=</span> newCapacity <span style=color:#f92672>-</span> 1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> oldCapacity <span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            HashEntry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> e <span style=color:#f92672>=</span> oldTable<span style=color:#f92672>[</span>i<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>e <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                HashEntry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> next <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int</span> idx <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>hash</span> <span style=color:#f92672>&amp;</span> sizeMask<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>next <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>   <span style=color:#75715e>//  Single node on list
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    newTable<span style=color:#f92672>[</span>idx<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                  <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span> <span style=color:#75715e>// Reuse consecutive sequence at same slot
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                   HashEntry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> lastRun <span style=color:#f92672>=</span> e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>int</span> lastIdx <span style=color:#f92672>=</span> idx<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>HashEntry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> last <span style=color:#f92672>=</span> next<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                         last <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                         last <span style=color:#f92672>=</span> last<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>int</span> k <span style=color:#f92672>=</span> last<span style=color:#f92672>.</span><span style=color:#a6e22e>hash</span> <span style=color:#f92672>&amp;</span> sizeMask<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>k <span style=color:#f92672>!=</span> lastIdx<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            lastIdx <span style=color:#f92672>=</span> k<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                            lastRun <span style=color:#f92672>=</span> last<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    newTable<span style=color:#f92672>[</span>lastIdx<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> lastRun<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// Clone remaining nodes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>HashEntry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> p <span style=color:#f92672>=</span> e<span style=color:#f92672>;</span> p <span style=color:#f92672>!=</span> lastRun<span style=color:#f92672>;</span> 
</span></span><span style=display:flex><span>                            p <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        V v <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>int</span> h <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span><span style=color:#a6e22e>hash</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>int</span> k <span style=color:#f92672>=</span> h <span style=color:#f92672>&amp;</span> sizeMask<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        HashEntry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> n <span style=color:#f92672>=</span> newTable<span style=color:#f92672>[</span>k<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>                        newTable<span style=color:#f92672>[</span>k<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashEntry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;(</span>h<span style=color:#f92672>,</span> 
</span></span><span style=display:flex><span>                                p<span style=color:#f92672>.</span><span style=color:#a6e22e>key</span><span style=color:#f92672>,</span> v<span style=color:#f92672>,</span> n<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> nodeIndex <span style=color:#f92672>=</span> node<span style=color:#f92672>.</span><span style=color:#a6e22e>hash</span> <span style=color:#f92672>&amp;</span> sizeMask<span style=color:#f92672>;</span> <span style=color:#75715e>// add the new node
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        node<span style=color:#f92672>.</span><span style=color:#a6e22e>setNext</span><span style=color:#f92672>(</span>newTable<span style=color:#f92672>[</span>nodeIndex<span style=color:#f92672>]);</span>
</span></span><span style=display:flex><span>        newTable<span style=color:#f92672>[</span>nodeIndex<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> node<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        table <span style=color:#f92672>=</span> newTable<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=put-流程分析>put 流程分析
<a class=anchor href=#put-%e6%b5%81%e7%a8%8b%e5%88%86%e6%9e%90>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> V <span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>K key<span style=color:#f92672>,</span> V value<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Segment<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> s<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>value <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> NullPointerException<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> hash <span style=color:#f92672>=</span> hash<span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> j <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>hash <span style=color:#f92672>&gt;&gt;&gt;</span> segmentShift<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;</span> segmentMask<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>s <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>Segment<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;)</span>UNSAFE<span style=color:#f92672>.</span><span style=color:#a6e22e>getObject</span>  <span style=color:#75715e>// nonvolatile; recheck
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>         <span style=color:#f92672>(</span>segments<span style=color:#f92672>,</span> <span style=color:#f92672>(</span>j <span style=color:#f92672>&lt;&lt;</span> SSHIFT<span style=color:#f92672>)</span> <span style=color:#f92672>+</span> SBASE<span style=color:#f92672>))</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> 
</span></span><span style=display:flex><span>        <span style=color:#75715e>//in ensureSegment
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        s <span style=color:#f92672>=</span> ensureSegment<span style=color:#f92672>(</span>j<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> s<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> hash<span style=color:#f92672>,</span> value<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> Segment<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ensureSegment</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> k<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> Segment<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;[]</span> ss <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>segments</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>long</span> u <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>k <span style=color:#f92672>&lt;&lt;</span> SSHIFT<span style=color:#f92672>)</span> <span style=color:#f92672>+</span> SBASE<span style=color:#f92672>;</span> <span style=color:#75715e>// raw offset
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Segment<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> seg<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>seg <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>Segment<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;)</span>UNSAFE
</span></span><span style=display:flex><span>            <span style=color:#f92672>.</span><span style=color:#a6e22e>getObjectVolatile</span><span style=color:#f92672>(</span>ss<span style=color:#f92672>,</span> u<span style=color:#f92672>))</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Segment<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> proto <span style=color:#f92672>=</span> ss<span style=color:#f92672>[</span>0<span style=color:#f92672>];</span> <span style=color:#75715e>// use segment 0 as prototype
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>int</span> cap <span style=color:#f92672>=</span> proto<span style=color:#f92672>.</span><span style=color:#a6e22e>table</span><span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>float</span> lf <span style=color:#f92672>=</span> proto<span style=color:#f92672>.</span><span style=color:#a6e22e>loadFactor</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> threshold <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span><span style=color:#f92672>)(</span>cap <span style=color:#f92672>*</span> lf<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        HashEntry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;[]</span> tab <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>HashEntry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;[])</span><span style=color:#66d9ef>new</span> HashEntry<span style=color:#f92672>[</span>cap<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>seg <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>Segment<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;)</span>UNSAFE<span style=color:#f92672>.</span><span style=color:#a6e22e>getObjectVolatile</span><span style=color:#f92672>(</span>ss<span style=color:#f92672>,</span> u<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span> <span style=color:#75715e>// recheck
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            Segment<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> s <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Segment<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;(</span>lf<span style=color:#f92672>,</span> threshold<span style=color:#f92672>,</span> tab<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>while</span> <span style=color:#f92672>((</span>seg <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>Segment<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;)</span>UNSAFE
</span></span><span style=display:flex><span>                      <span style=color:#f92672>.</span><span style=color:#a6e22e>getObjectVolatile</span><span style=color:#f92672>(</span>ss<span style=color:#f92672>,</span> u<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>                   <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>UNSAFE<span style=color:#f92672>.</span><span style=color:#a6e22e>compareAndSwapObject</span><span style=color:#f92672>(</span>ss<span style=color:#f92672>,</span> u<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> seg <span style=color:#f92672>=</span> s<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> seg<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=get-流程分析>get 流程分析
<a class=anchor href=#get-%e6%b5%81%e7%a8%8b%e5%88%86%e6%9e%90>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> V <span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>Object key<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Segment<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> s<span style=color:#f92672>;</span> <span style=color:#75715e>// manually integrate access methods to reduce overhead
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    HashEntry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;[]</span> tab<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> h <span style=color:#f92672>=</span> hash<span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>long</span> u <span style=color:#f92672>=</span> <span style=color:#f92672>(((</span>h <span style=color:#f92672>&gt;&gt;&gt;</span> segmentShift<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;</span> segmentMask<span style=color:#f92672>)</span> <span style=color:#f92672>&lt;&lt;</span> SSHIFT<span style=color:#f92672>)</span> <span style=color:#f92672>+</span> SBASE<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>s <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>Segment<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;)</span>UNSAFE<span style=color:#f92672>.</span><span style=color:#a6e22e>getObjectVolatile</span><span style=color:#f92672>(</span>segments<span style=color:#f92672>,</span> u<span style=color:#f92672>))</span> 
</span></span><span style=display:flex><span>              <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>(</span>tab <span style=color:#f92672>=</span> s<span style=color:#f92672>.</span><span style=color:#a6e22e>table</span><span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>HashEntry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> e <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>HashEntry<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;)</span>         
</span></span><span style=display:flex><span>                UNSAFE<span style=color:#f92672>.</span><span style=color:#a6e22e>getObjectVolatile</span><span style=color:#f92672>(</span>tab<span style=color:#f92672>,</span> 
</span></span><span style=display:flex><span>                <span style=color:#f92672>((</span><span style=color:#66d9ef>long</span><span style=color:#f92672>)(((</span>tab<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> 1<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;</span> h<span style=color:#f92672>))</span> <span style=color:#f92672>&lt;&lt;</span> TSHIFT<span style=color:#f92672>)</span> <span style=color:#f92672>+</span> TBASE<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>             e <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span> e <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            K k<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>k <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>key</span><span style=color:#f92672>)</span> <span style=color:#f92672>==</span> key <span style=color:#f92672>||</span> <span style=color:#f92672>(</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>hash</span> <span style=color:#f92672>==</span> h <span style=color:#f92672>&amp;&amp;</span> key<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>k<span style=color:#f92672>)))</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=java-8-实现>Java 8 实现
<a class=anchor href=#java-8-%e5%ae%9e%e7%8e%b0>#</a></h2><p>Java 8 版本的 ConcurrentHashMap 数据结构示意图：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Concurent-Container/clipboard_20230323_094255.png width=auto alt></p><h3 id=node-节点>Node 节点
<a class=anchor href=#node-%e8%8a%82%e7%82%b9>#</a></h3><p>内部存储结构 Node 源码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Node</span><span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>implements</span> Map<span style=color:#f92672>.</span><span style=color:#a6e22e>Entry</span><span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> hash<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> K key<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>volatile</span> V val<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>volatile</span> Node<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> next<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看出，每个 Node 里面是 key-value 的形式，并且把 value 用 volatile 修饰，以便保证可见性，同时内部还有一个指向下一个节点的 next 指针，方便产生链表结构。</p><h3 id=put-方法源码分析>put 方法源码分析
<a class=anchor href=#put-%e6%96%b9%e6%b3%95%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> V <span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>K key<span style=color:#f92672>,</span> V value<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> putVal<span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> value<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>final</span> V <span style=color:#a6e22e>putVal</span><span style=color:#f92672>(</span>K key<span style=color:#f92672>,</span> V value<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> onlyIfAbsent<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>key <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> value <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> NullPointerException<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//计算 hash 值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> hash <span style=color:#f92672>=</span> spread<span style=color:#f92672>(</span>key<span style=color:#f92672>.</span><span style=color:#a6e22e>hashCode</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> binCount <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Node<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span> V<span style=color:#f92672>&gt;[]</span> tab <span style=color:#f92672>=</span> table<span style=color:#f92672>;</span> <span style=color:#f92672>;</span> <span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Node<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span> V<span style=color:#f92672>&gt;</span> f<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> n<span style=color:#f92672>,</span> i<span style=color:#f92672>,</span> fh<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//如果数组是空的，就进行初始化
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>tab <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> <span style=color:#f92672>(</span>n <span style=color:#f92672>=</span> tab<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>)</span> <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            tab <span style=color:#f92672>=</span> initTable<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 找该 hash 值对应的数组下标
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>f <span style=color:#f92672>=</span> tabAt<span style=color:#f92672>(</span>tab<span style=color:#f92672>,</span> i <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>n <span style=color:#f92672>-</span> 1<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;</span> hash<span style=color:#f92672>))</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//如果该位置是空的，就用 CAS 的方式放入新值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>casTabAt<span style=color:#f92672>(</span>tab<span style=color:#f92672>,</span> i<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>new</span> Node<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span> V<span style=color:#f92672>&gt;(</span>hash<span style=color:#f92672>,</span> key<span style=color:#f92672>,</span> value<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//hash值等于 MOVED 代表在扩容
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>fh <span style=color:#f92672>=</span> f<span style=color:#f92672>.</span><span style=color:#a6e22e>hash</span><span style=color:#f92672>)</span> <span style=color:#f92672>==</span> MOVED<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            tab <span style=color:#f92672>=</span> helpTransfer<span style=color:#f92672>(</span>tab<span style=color:#f92672>,</span> f<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 槽点上是有值的情况
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            V oldVal <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 用 synchronized 锁住当前槽点，保证并发安全
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span>f<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>tabAt<span style=color:#f92672>(</span>tab<span style=color:#f92672>,</span> i<span style=color:#f92672>)</span> <span style=color:#f92672>==</span> f<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 如果是链表的形式
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>fh <span style=color:#f92672>&gt;=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        binCount <span style=color:#f92672>=</span> 1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// 遍历链表
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Node<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span> V<span style=color:#f92672>&gt;</span> e <span style=color:#f92672>=</span> f<span style=color:#f92672>;</span> <span style=color:#f92672>;</span> <span style=color:#f92672>++</span>binCount<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            K ek<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#75715e>// 如果发现该 key 已存在，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                            <span style=color:#75715e>// 就判断是否需要进行覆盖，然后返回
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>hash</span> <span style=color:#f92672>==</span> hash <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#f92672>((</span>ek <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>key</span><span style=color:#f92672>)</span> <span style=color:#f92672>==</span> key <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>                                    <span style=color:#f92672>(</span>ek <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> key<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>ek<span style=color:#f92672>))))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                oldVal <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>val</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>onlyIfAbsent<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                    e<span style=color:#f92672>.</span><span style=color:#a6e22e>val</span> <span style=color:#f92672>=</span> value<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                            Node<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span> V<span style=color:#f92672>&gt;</span> pred <span style=color:#f92672>=</span> e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#75715e>// 到了链表的尾部也没有发现该 key，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                            <span style=color:#75715e>// 说明之前不存在，就把新值添加到链表的最后
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                            <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>e <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>)</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                pred<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Node<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span> V<span style=color:#f92672>&gt;(</span>hash<span style=color:#f92672>,</span> key<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                        value<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>//如果是红黑树的形式
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>f <span style=color:#66d9ef>instanceof</span> TreeBin<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        Node<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span> V<span style=color:#f92672>&gt;</span> p<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        binCount <span style=color:#f92672>=</span> 2<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>//调用 putTreeVal 方法往红黑树里增加数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>p <span style=color:#f92672>=</span> <span style=color:#f92672>((</span>TreeBin<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span> V<span style=color:#f92672>&gt;)</span> f<span style=color:#f92672>).</span><span style=color:#a6e22e>putTreeVal</span><span style=color:#f92672>(</span>hash<span style=color:#f92672>,</span>         
</span></span><span style=display:flex><span>                                key<span style=color:#f92672>,</span> value<span style=color:#f92672>))</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            oldVal <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span><span style=color:#a6e22e>val</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>onlyIfAbsent<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                p<span style=color:#f92672>.</span><span style=color:#a6e22e>val</span> <span style=color:#f92672>=</span> value<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>binCount <span style=color:#f92672>!=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 检查是否满足条件并把链表转换为红黑树的形式，       
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// 默认的 TREEIFY_THRESHOLD 阈值是 8
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>binCount <span style=color:#f92672>&gt;=</span> TREEIFY_THRESHOLD<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    treeifyBin<span style=color:#f92672>(</span>tab<span style=color:#f92672>,</span> i<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// putVal 的返回是添加前的旧值，所以返回 oldVal
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>oldVal <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> oldVal<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    addCount<span style=color:#f92672>(</span>1L<span style=color:#f92672>,</span> binCount<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>通过以上的源码分析，我们对于 putVal 方法有了详细的认识，可以看出，方法中会逐步根据当前槽点是未初始化、空、扩容、链表、红黑树等不同情况做出不同的处理。</p><h3 id=get-方法源码分析>get 方法源码分析
<a class=anchor href=#get-%e6%96%b9%e6%b3%95%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90>#</a></h3><p>get 方法比较简单，同样用源码注释的方式来分析一下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> V <span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>Object key<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Node<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;[]</span> tab<span style=color:#f92672>;</span> Node<span style=color:#f92672>&lt;</span>K<span style=color:#f92672>,</span>V<span style=color:#f92672>&gt;</span> e<span style=color:#f92672>,</span> p<span style=color:#f92672>;</span> <span style=color:#66d9ef>int</span> n<span style=color:#f92672>,</span> eh<span style=color:#f92672>;</span> K ek<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 计算 hash 值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> h <span style=color:#f92672>=</span> spread<span style=color:#f92672>(</span>key<span style=color:#f92672>.</span><span style=color:#a6e22e>hashCode</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果整个数组是空的，或者当前槽点的数据是空的，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 说明 key 对应的 value 不存在，直接返回 null
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>tab <span style=color:#f92672>=</span> table<span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>(</span>n <span style=color:#f92672>=</span> tab<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>)</span> <span style=color:#f92672>&gt;</span> 0 <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>(</span>e <span style=color:#f92672>=</span> tabAt<span style=color:#f92672>(</span>tab<span style=color:#f92672>,</span> <span style=color:#f92672>(</span>n <span style=color:#f92672>-</span> 1<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;</span> h<span style=color:#f92672>))</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 判断头结点是否就是我们需要的节点，如果是则直接返回
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>eh <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>hash</span><span style=color:#f92672>)</span> <span style=color:#f92672>==</span> h<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>ek <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>key</span><span style=color:#f92672>)</span> <span style=color:#f92672>==</span> key <span style=color:#f92672>||</span> <span style=color:#f92672>(</span>ek <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> key<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>ek<span style=color:#f92672>)))</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>val</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 如果头结点 hash 值小于 0，说明是红黑树或者正在扩容，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 就用对应的 find 方法来查找
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>eh <span style=color:#f92672>&lt;</span> 0<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>p <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>find</span><span style=color:#f92672>(</span>h<span style=color:#f92672>,</span> key<span style=color:#f92672>))</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> p<span style=color:#f92672>.</span><span style=color:#a6e22e>val</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 遍历链表来查找
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>while</span> <span style=color:#f92672>((</span>e <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>hash</span> <span style=color:#f92672>==</span> h <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>((</span>ek <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>key</span><span style=color:#f92672>)</span> <span style=color:#f92672>==</span> key 
</span></span><span style=display:flex><span>                  <span style=color:#f92672>||</span> <span style=color:#f92672>(</span>ek <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> key<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>ek<span style=color:#f92672>))))</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>val</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>总结一下 get 的过程：</p><ol><li>计算 Hash 值，并由此值找到对应的槽点；</li><li>如果数组是空的或者该位置为 null，那么直接返回 null 就可以了；</li><li>如果该位置处的节点刚好就是我们需要的，直接返回该节点的值；</li><li>如果该位置节点是红黑树或者正在扩容，就用 find 方法继续查找；</li><li>否则那就是链表，就进行遍历链表查找。</li></ol><h2 id=对比-java7-和-java8-版本的异同和优缺点>对比 Java7 和 Java8 版本的异同和优缺点
<a class=anchor href=#%e5%af%b9%e6%af%94-java7-%e5%92%8c-java8-%e7%89%88%e6%9c%ac%e7%9a%84%e5%bc%82%e5%90%8c%e5%92%8c%e4%bc%98%e7%bc%ba%e7%82%b9>#</a></h2><ul><li>数据结构</li></ul><p>正如最开始的两个结构示意图所示，Java 7 采用 Segment 分段锁来实现，而 Java 8 中的 ConcurrentHashMap 使用数组 + 链表 + 红黑树，在这一点上它们的差别非常大。</p><ul><li>并发度</li></ul><p>Java 7 中，每个 Segment 独立加锁，最大并发个数就是 Segment 的个数，默认是 16。</p><p>但是到了 Java 8 中，锁粒度更细，理想情况下 table 数组元素的个数（也就是数组长度）就是其支持并发的最大个数，并发度比之前有提高。</p><ul><li>保证并发安全的原理</li></ul><p>Java 7 采用 Segment 分段锁来保证安全，而 Segment 是继承自 ReentrantLock。</p><p>Java 8 中放弃了 Segment 的设计，采用 Node + CAS + synchronized 保证线程安全。</p><ul><li>处理 Hash 冲突</li></ul><p>Java 7 在 Hash 冲突时，会使用拉链法，也就是链表的形式。</p><p>Java 8 先使用拉链法，在链表长度超过一定阈值时，将链表转换为红黑树，来提高查找效率。</p><ul><li>查询时间复杂度</li></ul><p>Java 7 遍历链表的时间复杂度是 O(n)，n 为链表长度。</p><p>Java 8 如果变成遍历红黑树，那么时间复杂度降低为 O(log(n))，n 为树的节点个数。</p><h1 id=copyonwritearraylist>CopyOnWriteArrayList
<a class=anchor href=#copyonwritearraylist>#</a></h1><p>在 CopyOnWriteArrayList 出现之前，已经有了 ArrayList 和 LinkedList 作为 List 的数组和链表的实现，而且也有了线程安全的 Vector 和 Collections.synchronizedList() 可以使用。</p><p>Vector 内部是使用 synchronized 来保证线程安全的，并且锁的粒度比较大，都是方法级别的锁，在并发量高的时候，很容易发生竞争，并发效率相对比较低。在这一点上，Vector 和 Hashtable 很类似。</p><p>并且，前面这几种 List 在迭代期间不允许编辑，如果在迭代期间进行添加或删除元素等操作，则会抛出 ConcurrentModificationException 异常，这样的特点也在很多情况下给使用者带来了麻烦。</p><p>所以从 JDK1.5 开始，Java 并发包里提供了使用 CopyOnWrite 机制实现的并发容器  CopyOnWriteArrayList 作为主要的并发 List，CopyOnWrite 的并发集合还包括 CopyOnWriteArraySet，其底层正是利用 CopyOnWriteArrayList 实现的。</p><h2 id=适用场景>适用场景
<a class=anchor href=#%e9%80%82%e7%94%a8%e5%9c%ba%e6%99%af>#</a></h2><ul><li>读操作可以尽可能的快，而写即使慢一些也没关系</li></ul><p>在很多应用场景中，读操作可能会远远多于写操作。比如，有些系统级别的信息，往往只需要加载或者修改很少的次数，但是会被系统内所有模块频繁的访问。对于这种场景，我们最希望看到的就是读操作可以尽可能的快，而写即使慢一些也没关系。</p><ul><li>读多写少</li></ul><p>黑名单是最典型的场景，假如我们有一个搜索网站，用户在这个网站的搜索框中，输入关键字搜索内容，但是某些关键字不允许被搜索。这些不能被搜索的关键字会被放在一个黑名单中，黑名单并不需要实时更新，可能每天晚上更新一次就可以了。当用户搜索时，会检查当前关键字在不在黑名单中，如果在，则提示不能搜索。这种读多写少的场景也很适合使用 CopyOnWrite 集合。</p><h2 id=读写规则>读写规则
<a class=anchor href=#%e8%af%bb%e5%86%99%e8%a7%84%e5%88%99>#</a></h2><ul><li>读写锁的规则</li></ul><p>读写锁的思想是：读读共享、其他都互斥（写写互斥、读写互斥、写读互斥），原因是由于读操作不会修改原有的数据，因此并发读并不会有安全问题；而写操作是危险的，所以当写操作发生时，不允许有读操作加入，也不允许第二个写线程加入。</p><ul><li>对读写锁规则的升级</li></ul><p>CopyOnWriteArrayList 的思想比读写锁的思想又更进一步。为了将读取的性能发挥到极致，CopyOnWriteArrayList 读取是完全不用加锁的，更厉害的是，写入也不会阻塞读取操作，也就是说你可以在写入的同时进行读取，只有写入和写入之间需要进行同步，也就是不允许多个写入同时发生，但是在写入发生时允许读取同时发生。这样一来，读操作的性能就会大幅度提升。</p><h2 id=特点>特点
<a class=anchor href=#%e7%89%b9%e7%82%b9>#</a></h2><ul><li>CopyOnWrite 的含义</li></ul><p>从 CopyOnWriteArrayList 的名字就能看出它是满足 CopyOnWrite 的 ArrayList，CopyOnWrite 的意思是说，当容器需要被修改的时候，不直接修改当前容器，而是先将当前容器进行 Copy，复制出一个新的容器，然后修改新的容器，完成修改之后，再将原容器的引用指向新的容器。这样就完成了整个修改过程。</p><p>这样做的好处是，CopyOnWriteArrayList 利用了“不变性”原理，因为容器每次修改都是创建新副本，所以对于旧容器来说，其实是不可变的，也是线程安全的，无需进一步的同步操作。我们可以对 CopyOnWrite 容器进行并发的读，而不需要加锁，因为当前容器不会添加任何元素，也不会有修改。</p><p>CopyOnWriteArrayList 的所有修改操作（add，set 等）都是通过创建底层数组的新副本来实现的，所以 CopyOnWrite 容器也是一种读写分离的思想体现，读和写使用不同的容器。</p><ul><li>迭代期间允许修改集合内容</li></ul><p>我们知道 ArrayList 在迭代期间如果修改集合的内容，会抛出 ConcurrentModificationException 异常。CopyOnWriteArrayList 的迭代器在迭代的时候，如果数组内容被修改了，CopyOnWriteArrayList 不会报 ConcurrentModificationException 的异常，因为迭代器使用的依然是旧数组，只不过迭代的内容可能已经过时了</p><h2 id=源码分析>源码分析
<a class=anchor href=#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90>#</a></h2><h3 id=数据结构>数据结构
<a class=anchor href=#%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CopyOnWriteArrayList</span><span style=color:#f92672>&lt;</span>E<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>implements</span> List<span style=color:#f92672>&lt;</span>E<span style=color:#f92672>&gt;,</span>
</span></span><span style=display:flex><span>             RandomAccess <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** The lock protecting all mutators */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>transient</span> ReentrantLock lock <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ReentrantLock<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** The array, accessed only via getArray/setArray. */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>transient</span> <span style=color:#66d9ef>volatile</span> Object<span style=color:#f92672>[]</span> array<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> Object<span style=color:#f92672>[]</span> <span style=color:#a6e22e>getArray</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> array<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setArray</span><span style=color:#f92672>(</span>Object<span style=color:#f92672>[]</span> a<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        array <span style=color:#f92672>=</span> a<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>CopyOnWriteArrayList</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        setArray<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Object<span style=color:#f92672>[</span>0<span style=color:#f92672>]);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>CopyOnWriteArrayList</span><span style=color:#f92672>(</span>Collection<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> E<span style=color:#f92672>&gt;</span> c<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Object<span style=color:#f92672>[]</span> elements<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>c<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> CopyOnWriteArrayList<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            elements <span style=color:#f92672>=</span> <span style=color:#f92672>((</span>CopyOnWriteArrayList<span style=color:#f92672>&lt;?&gt;)</span>c<span style=color:#f92672>).</span><span style=color:#a6e22e>getArray</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            elements <span style=color:#f92672>=</span> c<span style=color:#f92672>.</span><span style=color:#a6e22e>toArray</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>c<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> ArrayList<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                elements <span style=color:#f92672>=</span> Arrays<span style=color:#f92672>.</span><span style=color:#a6e22e>copyOf</span><span style=color:#f92672>(</span>elements<span style=color:#f92672>,</span> elements<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>,</span> Object<span style=color:#f92672>[].</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        setArray<span style=color:#f92672>(</span>elements<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>在这个类中首先会有一个 ReentrantLock 锁，用来保证修改操作的线程安全。下面被命名为 array 的 Object[] 数组是被 volatile 修饰的，可以保证数组的可见性，这正是存储元素的数组，同样，我们可以从 getArray()、setArray 以及它的构造方法看出，CopyOnWriteArrayList 的底层正是利用数组实现的，这也符合它的名字。</p><h3 id=strongadd-方法strong><strong>add 方法</strong>
<a class=anchor href=#strongadd-%e6%96%b9%e6%b3%95strong>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>E e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 加锁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>final</span> ReentrantLock lock <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>lock</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    lock<span style=color:#f92672>.</span><span style=color:#a6e22e>lock</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 得到原数组的长度和元素
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Object<span style=color:#f92672>[]</span> elements <span style=color:#f92672>=</span> getArray<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> len <span style=color:#f92672>=</span> elements<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 复制出一个新数组
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Object<span style=color:#f92672>[]</span> newElements <span style=color:#f92672>=</span> Arrays<span style=color:#f92672>.</span><span style=color:#a6e22e>copyOf</span><span style=color:#f92672>(</span>elements<span style=color:#f92672>,</span> len <span style=color:#f92672>+</span> 1<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 添加时，将新元素添加到新数组中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        newElements<span style=color:#f92672>[</span>len<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 将volatile Object[] array 的指向替换成新数组
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        setArray<span style=color:#f92672>(</span>newElements<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        lock<span style=color:#f92672>.</span><span style=color:#a6e22e>unlock</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>add 方法的作用是往 CopyOnWriteArrayList 中添加元素，是一种修改操作。首先需要利用 ReentrantLock 的 lock 方法进行加锁，获取锁之后，得到原数组的长度和元素，也就是利用 getArray 方法得到 elements 并且保存 length。之后利用 Arrays.copyOf 方法复制出一个新的数组，得到一个和原数组内容相同的新数组，并且把新元素添加到新数组中。完成添加动作后，需要转换引用所指向的对象，利用 setArray(newElements) 操作就可以把 volatile Object[] array 的指向替换成新数组，最后在 finally 中把锁解除。</p><p>总结流程：在添加的时候首先上锁，并复制一个新数组，增加操作在新数组上完成，然后将 array 指向到新数组，最后解锁。</p><p>上面的步骤实现了 CopyOnWrite 的思想：写操作是在原来容器的拷贝上进行的，并且在读取数据的时候不会锁住 list。而且可以看到，如果对容器拷贝操作的过程中有新的读线程进来，那么读到的还是旧的数据，因为在那个时候对象的引用还没有被更改。</p><h3 id=get-方法>get 方法
<a class=anchor href=#get-%e6%96%b9%e6%b3%95>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> E <span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> index<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> get<span style=color:#f92672>(</span>getArray<span style=color:#f92672>(),</span> index<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>final</span> Object<span style=color:#f92672>[]</span> <span style=color:#a6e22e>getArray</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> array<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> E <span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>Object<span style=color:#f92672>[]</span> a<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> index<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>E<span style=color:#f92672>)</span> a<span style=color:#f92672>[</span>index<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看出，get 相关的操作没有加锁，保证了读取操作的高速。</p><h3 id=strong迭代器-cowiterator-类strong><strong>迭代器 COWIterator 类</strong>
<a class=anchor href=#strong%e8%bf%ad%e4%bb%a3%e5%99%a8-cowiterator-%e7%b1%bbstrong>#</a></h3><p>这个迭代器有两个重要的属性，分别是 Object[] snapshot 和 int cursor。其中 snapshot 代表数组的快照，也就是创建迭代器那个时刻的数组情况，而 cursor 则是迭代器的游标。迭代器的构造方法如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#a6e22e>COWIterator</span><span style=color:#f92672>(</span>Object<span style=color:#f92672>[]</span> elements<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> initialCursor<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    cursor <span style=color:#f92672>=</span> initialCursor<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    snapshot <span style=color:#f92672>=</span> elements<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看出，迭代器在被构建的时候，会把当时的 elements 赋值给 snapshot，而之后的迭代器所有的操作都基于 snapshot 数组进行的，比如：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> E <span style=color:#a6e22e>next</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span> hasNext<span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> NoSuchElementException<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>E<span style=color:#f92672>)</span> snapshot<span style=color:#f92672>[</span>cursor<span style=color:#f92672>++];</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>在 next 方法中可以看到，返回的内容是 snapshot 对象，所以，后续就算原数组被修改，这个 snapshot 既不会感知到，也不会受影响，执行迭代操作不需要加锁，也不会因此抛出异常。迭代器返回的结果，和创建迭代器的时候的内容一致。</p><h1 id=copyonwritearrayset>CopyOnWriteArraySet
<a class=anchor href=#copyonwritearrayset>#</a></h1><h1 id=concurrentlinkedqueue>ConcurrentLinkedQueue
<a class=anchor href=#concurrentlinkedqueue>#</a></h1><p>Java 提供的线程安全的 Queue 可以分为阻塞队列和非阻塞队列，其中阻塞队列的典型例子是 BlockingQueue，非阻塞队列的典型例子是 ConcurrentLinkedQueue，在实际应用中要根据实际需要选用阻塞队列或者非阻塞队列。 阻塞队列可以通过加锁来实现，非阻塞队列可以通过 CAS 操作实现。</p><p>从名字可以看出，ConcurrentLinkedQueue 这个队列使用链表作为其数据结构．ConcurrentLinkedQueue 应该算是在高并发环境中性能最好的队列了。它之所有能有很好的性能，是因为其内部复杂的实现。</p><p>ConcurrentLinkedQueue 内部代码这里就不分析了，主要使用 CAS 非阻塞算法来实现线程安全。</p><p>ConcurrentLinkedQueue 适合在对性能要求相对较高，同时对队列的读写存在多个线程同时进行的场景，即如果对队列加锁的成本较高则适合使用无锁的 ConcurrentLinkedQueue 来替代。</p><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://guanpj.github.io/amethyst/quartz/js/graph.cbd78cfa87df7d3e230d16fc24f06548.js></script></div></div><div id=contact_buttons><footer><p>Made with <a href=https://github.com/64bitpandas/amethyst>Amethyst</a>, © 2023 guanpj</p><ul><li><a href=https://guanpj.github.io/amethyst/>Home</a></li><li><a href=https://bencuan.me>Website</a></li><li><a href=https://blog.bencuan.me>Blog</a></li></ul></footer></div></article><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#concurenthashmap>ConcurentHashMap</a><ul><li><a href=#java-7-实现>Java 7 实现</a><ul><li><a href=#构造方法>构造方法</a></li><li><a href=#segment>Segment</a></li><li><a href=#put-流程分析>put 流程分析</a></li><li><a href=#get-流程分析>get 流程分析</a></li></ul></li><li><a href=#java-8-实现>Java 8 实现</a><ul><li><a href=#node-节点>Node 节点</a></li><li><a href=#put-方法源码分析>put 方法源码分析</a></li><li><a href=#get-方法源码分析>get 方法源码分析</a></li></ul></li><li><a href=#对比-java7-和-java8-版本的异同和优缺点>对比 Java7 和 Java8 版本的异同和优缺点</a></li></ul></li><li><a href=#copyonwritearraylist>CopyOnWriteArrayList</a><ul><li><a href=#适用场景>适用场景</a></li><li><a href=#读写规则>读写规则</a></li><li><a href=#特点>特点</a></li><li><a href=#源码分析>源码分析</a><ul><li><a href=#数据结构>数据结构</a></li><li><a href=#strongadd-方法strong><strong>add 方法</strong></a></li><li><a href=#get-方法>get 方法</a></li><li><a href=#strong迭代器-cowiterator-类strong><strong>迭代器 COWIterator 类</strong></a></li></ul></li></ul></li><li><a href=#copyonwritearrayset>CopyOnWriteArraySet</a></li><li><a href=#concurrentlinkedqueue>ConcurrentLinkedQueue</a></li></ul></nav></div></aside></main></body></html>