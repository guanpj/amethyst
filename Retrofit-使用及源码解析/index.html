<!doctype html><html lang=en dir=ltr><head><meta property="og:title" content="Retrofit 使用及源码分析"><meta property="og:description" content="使用 #   导入依赖。  implementation &#34;com.squareup.okhttp3:okhttp:4.9.0&#34; implementation &#34;com.squareup.okhttp3:logging-interceptor:4.9.0&#34;  implementation &#34;com.squareup.retrofit2:retrofit:2.9.0&#34; implementation &#34;com.squareup.retrofit2:converter-gson:2.9.0&#34; implementation &#34;com.squareup.retrofit2:adapter-rxjava3:2.9.0&#34;  implementation &#34;io.reactivex.rxjava3:rxjava:3.0.0&#34; implementation &#34;io.reactivex.rxjava3:rxandroid:3.0.0&#34; 创建一个 interface 作为 WebService 的请求集合，在里面用注解写入需要配置的请求方法。  interface GitHubService {  @GET(&#34;users/{user}/repos&#34;)  fun listRepos(@Path(&#34;user&#34;) user: String?): Call<List<Repo>>   @GET(&#34;users/{user}/repos&#34;)  fun listReposRx(@Path(&#34;user&#34;) user: String?): Observable<List<Repo>>   @GET(&#34;users/{user}/repos&#34;)  fun listReposCompletable(@Path(&#34;user&#34;) user: String?): CompletableFuture<List<Repo>>   @GET(&#34;users/{user}/repos&#34;)  suspend fun listReposSuspend(@Path(&#34;user&#34;) user: String?): List<Repo>   @GET(&#34;users/{user}/repos&#34;)  fun listReposOptional(@Path(&#34;user&#34;) user: String?"><meta property="og:type" content="article"><meta property="og:url" content="https://guanpj.github.io/amethyst/Retrofit-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"><meta property="article:section" content><meta property="og:site_name" content="guanpj's blog"><title>Retrofit 使用及源码分析 | guanpj's blog</title><link rel=manifest href=/amethyst/manifest.json><link rel=icon href=/amethyst/favicon.png type=image/x-icon><link rel=stylesheet href=/amethyst/book.min.c27ff4755c78daab11627953d5a6dd7e2698690e086398032995aae74d6397b6.css integrity="sha256-wn/0dVx42qsRYnlT1abdfiaYaQ4IY5gDKZWq501jl7Y=" crossorigin=anonymous><meta charset=utf-8><meta name=description content="使用 #   导入依赖。  implementation &#34;com.squareup.okhttp3:okhttp:4.9.0&#34; implementation &#34;com.squareup.okhttp3:logging-interceptor:4.9.0&#34;  implementation &#34;com.squareup.retrofit2:retrofit:2.9.0&#34; implementation &#34;com.squareup.retrofit2:converter-gson:2.9.0&#34; implementation &#34;com.squareup.retrofit2:adapter-rxjava3:2.9.0&#34;  implementation &#34;io.reactivex.rxjava3:rxjava:3.0.0&#34; implementation &#34;io.reactivex.rxjava3:rxandroid:3.0.0&#34; 创建一个 interface 作为 WebService 的请求集合，在里面用注解写入需要配置的请求方法。  interface GitHubService {  @GET(&#34;users/{user}/repos&#34;)  fun listRepos(@Path(&#34;user&#34;) user: String?): Call<List<Repo>>   @GET(&#34;users/{user}/repos&#34;)  fun listReposRx(@Path(&#34;user&#34;) user: String?): Observable<List<Repo>>   @GET(&#34;users/{user}/repos&#34;)  fun listReposCompletable(@Path(&#34;user&#34;) user: String?): CompletableFuture<List<Repo>>   @GET(&#34;users/{user}/repos&#34;)  suspend fun listReposSuspend(@Path(&#34;user&#34;) user: String?): List<Repo>   @GET(&#34;users/{user}/repos&#34;)  fun listReposOptional(@Path(&#34;user&#34;) user: String?"><title>Retrofit 使用及源码分析</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://guanpj.github.io/amethyst//favicon.png><link href=https://guanpj.github.io/amethyst/styles.e08ceb33360cec132feb69cfb982e2a4.min.css rel=stylesheet><link href=https://guanpj.github.io/amethyst/quartz/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://guanpj.github.io/amethyst/quartz/js/darkmode.1bc498b60ed24d8858f74f99e480db82.min.js></script>
<script src=https://guanpj.github.io/amethyst/quartz/js/util.c69e233dc1cc331a30b0f670e657b425.min.js></script>
<script async src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script async src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://guanpj.github.io/amethyst/quartz/js/popover.f03552ccb84d99ca615d1cfb9abde59e.min.js></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://guanpj.github.io/amethyst/",fetchData=Promise.all([fetch("https://guanpj.github.io/amethyst/indices/linkIndex.a0cf85a144674d956ca9db3dfb7745ab.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://guanpj.github.io/amethyst/indices/contentIndex.6e36d79b0a0d4a81007275dd2fa73365.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addCollapsibleCallouts(),initPopover("https://guanpj.github.io/amethyst",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!0;drawGraph("https://guanpj.github.io/amethyst",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script>window.Million={navigate:e=>window.location.href=e,prefetch:()=>{}},window.addEventListener("DOMContentLoaded",()=>{init(),render()})</script></head><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><header class=book-header><label for=menu-control><img src=/amethyst/svg/menu.svg class=book-icon alt=Menu></label><h1 id=page-title><a href=https://guanpj.github.io/amethyst/>guanpj's blog</a></h1><div class=spacer></div><div id=search-icon class=quartz-search><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control><main class=flex><aside class=book-menu><div class=book-menu-content><nav><div class=menu-search><div id=search-icon class=quartz-search><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div></div><ul><li><a href=/amethyst/2023-03-15/>2023 03 15</a></li><li><a href=/amethyst/2023-03-18/>2023 03 18</a></li><li><a href=/amethyst/2023-03-19/>2023 03 19</a></li><li><a href=/amethyst/2023-03-20/>2023 03 20</a></li><li><a href=/amethyst/Buttons/>Buttons</a></li><li><a href=/amethyst/ControlPanel/>Control Panel</a></li><li><a href=/amethyst/Linter/>Linter</a></li><li><a href=/amethyst/MyDraw/>My Draw</a></li><li><a href=/amethyst/%E5%85%B6%E4%BB%96%E6%A8%A1%E7%89%88/>其他模版</a></li><li><a href=/amethyst/%E5%A7%94%E6%89%98/>委托</a></li><li><a href=/amethyst/%E5%BC%95%E7%94%A8/>引用</a></li><li><a href=/amethyst/%E6%89%A9%E5%B1%95%E5%87%BD%E6%95%B0/>扩展函数</a></li><li><a href=/amethyst/%E6%8C%87%E9%92%88/>指针</a></li><li><a href=/amethyst/%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%96%87%E6%9C%AC%E6%9B%BF%E6%8D%A2/>文件读取、文本替换</a></li><li><a href=/amethyst/%E7%B1%BB%E7%9A%84%E5%AE%9A%E4%B9%89%E4%BD%BF%E7%94%A8/>类的定义、使用</a></li><li><a href=/amethyst/%E9%81%8D%E5%8E%86%E6%96%87%E4%BB%B6%E9%87%8D%E5%91%BD%E5%90%8D/>遍历文件、重命名</a></li><li><a href=/amethyst/About-Atlas/>About Atlas</a></li><li><a href=/amethyst/ADB-%E5%91%BD%E4%BB%A4/>ADB 命令</a></li><li><a href=/amethyst/Java-%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/>ADB 命令</a></li><li><a href=/amethyst/Android-%E5%AF%B9%E5%AE%B9%E5%99%A8%E7%B1%BB%E7%9A%84%E4%BC%98%E5%8C%96/>Android 对容器类的优化</a></li><li><a href=/amethyst/CAS-%E5%92%8C-AQS-%E5%8E%9F%E7%90%86/>CAS 和 AQS 原理</a></li><li><a href=/amethyst/EventBus-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>EventBus 使用及源码解析</a></li><li><a href=/amethyst/Glide-%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E5%92%8C%E7%BC%93%E5%AD%98%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/>Glide 加载流程和缓存原理分析</a></li><li><a href=/amethyst/Glide-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/>Glide 基本使用</a></li><li><a href=/amethyst/Glide-%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95/>Glide 高级用法</a></li><li><a href=/amethyst/HashMap-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>HashMap 源码解析</a></li><li><a href=/amethyst/HTTP-%E5%9F%BA%E7%A1%80/>HTTP 基础</a></li><li><a href=/amethyst/Index-for-Atlases/>Index for Atlases</a></li><li><a href=/amethyst/Index-for-Extras/>Index for Extras</a></li><li><a href=/amethyst/Java-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/>Java 内存模型</a></li><li><a href=/amethyst/JVM-%E4%B8%AD%E7%9A%84%E5%AF%B9%E8%B1%A1%E5%92%8C%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/>JVM 中的对象和垃圾回收</a></li><li><a href=/amethyst/JVM-%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F/>JVM 内存区域</a></li><li><a href=/amethyst/JVM-%E5%AD%97%E8%8A%82%E7%A0%81%E6%8C%87%E4%BB%A4%E7%AE%80%E4%BB%8B/>JVM 字节码指令简介</a></li><li><a href=/amethyst/JVM-%E5%AD%97%E8%8A%82%E7%A0%81%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/>JVM 字节码结构分析</a></li><li><a href=/amethyst/JVM-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/>JVM 类加载机制</a></li><li><a href=/amethyst/LeakCanary-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>LeakCanary 使用及源码解析</a></li><li><a href=/amethyst/MyIdeas/>MyIdeas</a></li><li><a href=/amethyst/OkHttp-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>OkHttp 使用及源码分析</a></li><li><a href=/amethyst/Retrofit-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/ class=active>Retrofit 使用及源码分析</a></li><li><a href=/amethyst/RxJava-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>RxJava 使用及源码分析</a></li><li><a href=/amethyst/2023-03-22/>Troubleshooting and FAQ</a></li><li><a href=/amethyst/%E4%B8%80Binder-%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90%E6%A6%82%E5%BF%B5%E7%AF%87/>一、Binder 机制分析——概念篇</a></li><li><a href=/amethyst/%E4%B8%83View-%E4%BA%8B%E4%BB%B6%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/>七、View 事件机制分析</a></li><li><a href=/amethyst/%E4%B8%89Handler-%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/>三、Handler 原理分析</a></li><li><a href=/amethyst/%E4%BA%8CBinder-%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90%E5%BA%94%E7%94%A8%E7%AF%87/>二、Binder 机制分析——应用篇</a></li><li><a href=/amethyst/%E4%BA%8C%E5%8F%89%E6%A0%91%E9%81%8D%E5%8E%86/>二叉树遍历</a></li><li><a href=/amethyst/%E4%BA%94App-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/>五、App 启动流程分析</a></li><li><a href=/amethyst/%E5%85%ADView-%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/>六、View 绘制流程分析</a></li><li><a href=/amethyst/%E5%9B%9B%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/>四、系统启动流程分析</a></li><li><a href=/amethyst/%E5%AE%B9%E5%99%A8%E7%B1%BB/>容器类</a></li><li><a href=/amethyst/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/>并发容器</a></li><li><a href=/amethyst/%E6%B3%9B%E5%9E%8B/>泛型</a></li><li><a href=/amethyst/%E6%B3%A8%E8%A7%A3%E5%92%8C%E5%8F%8D%E5%B0%84/>注解和反射</a></li><li><a href=/amethyst/%E7%AD%89%E5%BE%85-%E9%80%9A%E7%9F%A5%E6%9C%BA%E5%88%B6/>等待-通知机制</a></li><li><a href=/amethyst/%E7%BA%BF%E7%A8%8B%E5%8D%8F%E4%BD%9C/>线程协作</a></li><li><a href=/amethyst/%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80/>线程基础</a></li><li><a href=/amethyst/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%92%8C-BlockingQueue/>线程池和 BlockingQueue</a></li><li><a href=/amethyst/%E7%BC%96%E7%A0%81%E5%8A%A0%E5%AF%86Hash%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%AD%97%E7%AC%A6%E9%9B%86/>编码、加密、Hash、序列化和字符集</a></li><li><a href=/amethyst/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84TCPIP-%E5%92%8C-HTTPS/>计算机网络体系结构、TCP&IP 和 HTTPS</a></li><li><a href=/amethyst/%E9%94%81/>锁</a></li></ul><ul><li><a href=https://github.com/64bitpandas/amethyst target=_blank rel=noopener>Github</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class="book-page container"><article class=markdown><h1 class=title>Retrofit 使用及源码分析</h1><h1 id=使用>使用
<a class=anchor href=#%e4%bd%bf%e7%94%a8>#</a></h1><ol><li>导入依赖。</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>implementation <span style=color:#e6db74>&#34;com.squareup.okhttp3:okhttp:4.9.0&#34;</span>
</span></span><span style=display:flex><span>implementation <span style=color:#e6db74>&#34;com.squareup.okhttp3:logging-interceptor:4.9.0&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>implementation <span style=color:#e6db74>&#34;com.squareup.retrofit2:retrofit:2.9.0&#34;</span>
</span></span><span style=display:flex><span>implementation <span style=color:#e6db74>&#34;com.squareup.retrofit2:converter-gson:2.9.0&#34;</span>
</span></span><span style=display:flex><span>implementation <span style=color:#e6db74>&#34;com.squareup.retrofit2:adapter-rxjava3:2.9.0&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>implementation <span style=color:#e6db74>&#34;io.reactivex.rxjava3:rxjava:3.0.0&#34;</span>
</span></span><span style=display:flex><span>implementation <span style=color:#e6db74>&#34;io.reactivex.rxjava3:rxandroid:3.0.0&#34;</span>
</span></span></code></pre></div><ol start=2><li>创建一个 interface 作为 WebService 的请求集合，在里面用注解写入需要配置的请求方法。</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>GitHubService</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@GET</span>(<span style=color:#e6db74>&#34;users/{user}/repos&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>listRepos</span>(<span style=color:#a6e22e>@Path</span>(<span style=color:#e6db74>&#34;user&#34;</span>) user: String?): Call&lt;List&lt;Repo&gt;&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@GET</span>(<span style=color:#e6db74>&#34;users/{user}/repos&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>listReposRx</span>(<span style=color:#a6e22e>@Path</span>(<span style=color:#e6db74>&#34;user&#34;</span>) user: String?): Observable&lt;List&lt;Repo&gt;&gt;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@GET</span>(<span style=color:#e6db74>&#34;users/{user}/repos&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>listReposCompletable</span>(<span style=color:#a6e22e>@Path</span>(<span style=color:#e6db74>&#34;user&#34;</span>) user: String?): CompletableFuture&lt;List&lt;Repo&gt;&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@GET</span>(<span style=color:#e6db74>&#34;users/{user}/repos&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>suspend</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>listReposSuspend</span>(<span style=color:#a6e22e>@Path</span>(<span style=color:#e6db74>&#34;user&#34;</span>) user: String?): List&lt;Repo&gt;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@GET</span>(<span style=color:#e6db74>&#34;users/{user}/repos&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>listReposOptional</span>(<span style=color:#a6e22e>@Path</span>(<span style=color:#e6db74>&#34;user&#34;</span>) user: String?): Call&lt;Optional&lt;List&lt;Repo&gt;&gt;&gt;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>在正式代码里用 Retrofit 创建出 interface 的实例。</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>val</span> user = <span style=color:#e6db74>&#34;guanpj&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> okHttpClient = OkHttpClient.Builder()
</span></span><span style=display:flex><span>    .connectTimeout(<span style=color:#ae81ff>15</span>, TimeUnit.SECONDS)
</span></span><span style=display:flex><span>    .writeTimeout(<span style=color:#ae81ff>30</span>, TimeUnit.SECONDS)
</span></span><span style=display:flex><span>    .readTimeout(<span style=color:#ae81ff>30</span>, TimeUnit.SECONDS)
</span></span><span style=display:flex><span>    .proxy(Proxy.NO_PROXY)
</span></span><span style=display:flex><span>    .addInterceptor(HttpLoggingInterceptor { message <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (BuildConfig.DEBUG) {
</span></span><span style=display:flex><span>            Log.i(<span style=color:#e6db74>&#34;OkHttp&#34;</span>, message)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    .build()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> retrofit = Retrofit.Builder()
</span></span><span style=display:flex><span>    .client(okHttpClient)
</span></span><span style=display:flex><span>    .baseUrl(<span style=color:#e6db74>&#34;https://api.github.com/&#34;</span>)
</span></span><span style=display:flex><span>    .addCallAdapterFactory(RxJava3CallAdapterFactory.create())
</span></span><span style=display:flex><span>    .addConverterFactory(GsonConverterFactory.create())
</span></span><span style=display:flex><span>    .build()
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> service = retrofit.create(GitHubService<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java)
</span></span></code></pre></div><ol start=4><li>调用创建出的 Service 实例的对应方法，创建出相应的可以用来发起网络请求的 Call 对象 / Obsevable 对象 / suspend 挂起函数，并发起请求。</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>val</span> listRepos = service.listRepos(user)
</span></span><span style=display:flex><span>listRepos.enqueue(<span style=color:#66d9ef>object</span> <span style=color:#960050;background-color:#1e0010>: </span><span style=color:#a6e22e>retrofit2</span>.Callback&lt;List&lt;Repo&gt;?&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onFailure</span>(call: retrofit2.Call&lt;List&lt;Repo&gt;?&gt;, t: Throwable) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onResponse</span>(call: retrofit2.Call&lt;List&lt;Repo&gt;?&gt;, response: retrofit2.Response&lt;List&lt;Repo&gt;?&gt;) {
</span></span><span style=display:flex><span>      Log.e(<span style=color:#e6db74>&#34;gpj&#34;</span>, <span style=color:#e6db74>&#34;Response: </span><span style=color:#e6db74>${response.body()!![0].name}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> listReposRx = service.listReposRx(user)
</span></span><span style=display:flex><span>listReposRx.subscribeOn(Schedulers.io())
</span></span><span style=display:flex><span>    .observeOn(AndroidSchedulers.mainThread())
</span></span><span style=display:flex><span>    .subscribe(<span style=color:#66d9ef>object</span> <span style=color:#960050;background-color:#1e0010>: </span><span style=color:#a6e22e>Observer</span>&lt;List&lt;Repo&gt;&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onSubscribe</span>(d: Disposable?) {
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onNext</span>(t: List&lt;Repo&gt;?) {
</span></span><span style=display:flex><span>          Log.e(<span style=color:#e6db74>&#34;gpj&#34;</span>, <span style=color:#e6db74>&#34;size:</span><span style=color:#e6db74>${t?.size}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onComplete</span>() {
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onError</span>(e: Throwable?) {
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> future: CompletableFuture&lt;List&lt;Repo&gt;&gt; = service.listReposCompletable(user)
</span></span><span style=display:flex><span>future.thenAccept { Log.e(<span style=color:#e6db74>&#34;gpj&#34;</span>, <span style=color:#e6db74>&#34;size:</span><span style=color:#e6db74>${it.size}</span><span style=color:#e6db74>&#34;</span>) }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>MainScope().launch {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> list = service.listReposSuspend(user)
</span></span><span style=display:flex><span>    Log.e(<span style=color:#e6db74>&#34;gpj&#34;</span>, <span style=color:#e6db74>&#34;size:</span><span style=color:#e6db74>${list.size}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> call = service.listReposOptional(user)
</span></span><span style=display:flex><span>thread {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 实际上这里是会抛出异常的，原因见后文分析
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>val</span> optionalList = call.execute().body()
</span></span><span style=display:flex><span>    optionalList<span style=color:#f92672>?.</span>ifPresent { list <span style=color:#f92672>-&gt;</span> list.map { Log.e(<span style=color:#e6db74>&#34;gpj&#34;</span>, <span style=color:#66d9ef>it</span>.full_name) } }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=解析>解析
<a class=anchor href=#%e8%a7%a3%e6%9e%90>#</a></h1><p>在正式开始前，先简单介绍一下几个关键词，供备忘：</p><ul><li><code>CallAdapter&lt;R, T></code>：将一个 Call 从响应类型 R 适配成 T 类型的适配器。<ul><li><code>Type responseType()</code> 适配器将 HTTP 响应体转换为 Java 对象时，该对象的类型。比如 <code>Call&lt;Repo></code> 的返回值是 Repo</li><li><code>T adapt(Call&lt;R> call)</code>：返回一个代理了 call 的 T</li></ul></li><li><code>CallAdapter.Factory</code>：用于创建 CallAdapter 实例的工厂<ul><li><code>CallAdapter&lt;?, ?> get(Type returnType, Annotation[] annotations, Retrofit retrofit)</code>：返回一个可以返回 returnType 的接口方法的 CallAdapter，如果不能处理，则返回 null</li></ul></li><li><code>Converter&lt;F, T></code>：将 F 转换为 T 类型的值的转换器。<ul><li><code>T convert(F value) throws IOException</code></li></ul></li><li><code>Converter.Factory</code>：基于一个类型和目标类型创建一个 Converter 实例的工厂<ul><li><code>Converter&lt;ResponseBody, ?> responseBodyConverter(Type type, Annotation[] annotations, Retrofit retrofit)</code>：返回一个可以转换 HTTP 响应体到 type 的转换器</li><li><code>Converter&lt;?, RequestBody> requestBodyConverter(Type type, Annotation[] parameterAnnotations, Annotation[] methodAnnotations, Retrofit retrofit)</code>：返回一个可以转换 type 到 HTTP 请求体的转换器</li><li><code>Converter&lt;?, String> stringConverter(Type type, Annotation[] annotations, Retrofit retrofit)</code>：返回一个可以转换 type 到 String 的转换器</li></ul></li></ul><h2 id=retrofitbuilder>Retrofit.Builder
<a class=anchor href=#retrofitbuilder>#</a></h2><p>如果想知道 Retrofit 在创建时干了些什么，就不得不看 Retrofit.Builder ，它的构造方法如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Builder<span style=color:#f92672>(</span>Platform platform<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>platform</span> <span style=color:#f92672>=</span> platform<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Builder</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span><span style=color:#f92672>(</span>Platform<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这里首先是调用了 <code>Platform.get()</code> 获取了一个 Platform 实例，然后保存到变量 platform 中。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Platform</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Platform PLATFORM <span style=color:#f92672>=</span> findPlatform<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> Platform <span style=color:#a6e22e>get</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> PLATFORM<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> Platform <span style=color:#a6e22e>findPlatform</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;Dalvik&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>System<span style=color:#f92672>.</span><span style=color:#a6e22e>getProperty</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;java.vm.name&#34;</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>?</span> <span style=color:#66d9ef>new</span> Android<span style=color:#f92672>()</span> <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> Platform<span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> hasJava8Types<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#a6e22e>@Nullable</span> Constructor<span style=color:#f92672>&lt;</span>Lookup<span style=color:#f92672>&gt;</span> lookupConstructor<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Platform<span style=color:#f92672>(</span><span style=color:#66d9ef>boolean</span> hasJava8Types<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>hasJava8Types</span> <span style=color:#f92672>=</span> hasJava8Types<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Constructor<span style=color:#f92672>&lt;</span>Lookup<span style=color:#f92672>&gt;</span> lookupConstructor <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>hasJava8Types<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Because the service interface might not be public, we need to use a MethodHandle lookup
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// that ignores the visibility of the declaringClass.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        lookupConstructor <span style=color:#f92672>=</span> Lookup<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getDeclaredConstructor</span><span style=color:#f92672>(</span>Class<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        lookupConstructor<span style=color:#f92672>.</span><span style=color:#a6e22e>setAccessible</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>NoClassDefFoundError ignored<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Android API 24 or 25 where Lookup doesn&#39;t exist. Calling default methods on non-public
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// interfaces will fail, but there&#39;s nothing we can do about it.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>NoSuchMethodException ignored<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Assume JDK 14+ which contains a fix that allows a regular lookup to succeed.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// See https://bugs.openjdk.java.net/browse/JDK-8209005.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>lookupConstructor</span> <span style=color:#f92672>=</span> lookupConstructor<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Nullable</span>
</span></span><span style=display:flex><span>  Executor <span style=color:#a6e22e>defaultCallbackExecutor</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 1、如果 API &lt; 24，这里列表中只有一个 DefaultCallAdapterFactory
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// 否则多一个 CompletableFutureCallAdapterFactory 用于支持 Java8
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  List<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> CallAdapter<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span><span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>defaultCallAdapterFactories</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>@Nullable</span> Executor callbackExecutor<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    DefaultCallAdapterFactory executorFactory <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DefaultCallAdapterFactory<span style=color:#f92672>(</span>callbackExecutor<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> hasJava8Types
</span></span><span style=display:flex><span>        <span style=color:#f92672>?</span> asList<span style=color:#f92672>(</span>CompletableFutureCallAdapterFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>INSTANCE</span><span style=color:#f92672>,</span> executorFactory<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>:</span> singletonList<span style=color:#f92672>(</span>executorFactory<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>defaultCallAdapterFactoriesSize</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> hasJava8Types <span style=color:#f92672>?</span> 2 <span style=color:#f92672>:</span> 1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 2、如果 API &lt; 24，这里列表为空；
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// 否则会有一个 OptionalConverterFactory 用于支持 Java8
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  List<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> Converter<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span><span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>defaultConverterFactories</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> hasJava8Types <span style=color:#f92672>?</span> singletonList<span style=color:#f92672>(</span>OptionalConverterFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>INSTANCE</span><span style=color:#f92672>)</span> <span style=color:#f92672>:</span> emptyList<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>defaultConverterFactoriesSize</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> hasJava8Types <span style=color:#f92672>?</span> 1 <span style=color:#f92672>:</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@IgnoreJRERequirement</span> <span style=color:#75715e>// Only called on API 24+.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isDefaultMethod</span><span style=color:#f92672>(</span>Method method<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> hasJava8Types <span style=color:#f92672>&amp;&amp;</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>isDefault</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@IgnoreJRERequirement</span> <span style=color:#75715e>// Only called on API 26+.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>@Nullable</span>
</span></span><span style=display:flex><span>  Object <span style=color:#a6e22e>invokeDefaultMethod</span><span style=color:#f92672>(</span>Method method<span style=color:#f92672>,</span> Class<span style=color:#f92672>&lt;?&gt;</span> declaringClass<span style=color:#f92672>,</span> Object object<span style=color:#f92672>,</span> Object<span style=color:#f92672>...</span> args<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throws</span> Throwable <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Lookup lookup <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        lookupConstructor <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>?</span> lookupConstructor<span style=color:#f92672>.</span><span style=color:#a6e22e>newInstance</span><span style=color:#f92672>(</span>declaringClass<span style=color:#f92672>,</span> <span style=color:#f92672>-</span>1 <span style=color:#75715e>/* trusted */</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>:</span> MethodHandles<span style=color:#f92672>.</span><span style=color:#a6e22e>lookup</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> lookup<span style=color:#f92672>.</span><span style=color:#a6e22e>unreflectSpecial</span><span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> declaringClass<span style=color:#f92672>).</span><span style=color:#a6e22e>bindTo</span><span style=color:#f92672>(</span>object<span style=color:#f92672>).</span><span style=color:#a6e22e>invokeWithArguments</span><span style=color:#f92672>(</span>args<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Android</span> <span style=color:#66d9ef>extends</span> Platform <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Android<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>//API 24 以上才支持 Java8
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>Build<span style=color:#f92672>.</span><span style=color:#a6e22e>VERSION</span><span style=color:#f92672>.</span><span style=color:#a6e22e>SDK_INT</span> <span style=color:#f92672>&gt;=</span> 24<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Executor <span style=color:#a6e22e>defaultCallbackExecutor</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> MainThreadExecutor<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Nullable</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    Object <span style=color:#a6e22e>invokeDefaultMethod</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        Method method<span style=color:#f92672>,</span> Class<span style=color:#f92672>&lt;?&gt;</span> declaringClass<span style=color:#f92672>,</span> Object object<span style=color:#f92672>,</span> Object<span style=color:#f92672>...</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Throwable <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Build<span style=color:#f92672>.</span><span style=color:#a6e22e>VERSION</span><span style=color:#f92672>.</span><span style=color:#a6e22e>SDK_INT</span> <span style=color:#f92672>&lt;</span> 26<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> UnsupportedOperationException<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Calling default methods on API 24 and 25 is not supported&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>invokeDefaultMethod</span><span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> declaringClass<span style=color:#f92672>,</span> object<span style=color:#f92672>,</span> args<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MainThreadExecutor</span> <span style=color:#66d9ef>implements</span> Executor <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Handler handler <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Handler<span style=color:#f92672>(</span>Looper<span style=color:#f92672>.</span><span style=color:#a6e22e>getMainLooper</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span>Runnable r<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        handler<span style=color:#f92672>.</span><span style=color:#a6e22e>post</span><span style=color:#f92672>(</span>r<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>findPlatform 方法会返回一个 Android 类型的 Platform 对象，它继承自 Platform 并重写了 defaultCallbackExecutor 返回一个 MainThreadExecutor。</p><p>同时注意 43 行注释一和 57 行注释二关于 defaultCallAdapterFactories 和 defaultConverterFactories 集合的赋值情况。</p><p>接下来我们在创建 Retrofit 对象的时候通过 Retrofit.Builder 设置了一些参数，这些参数都会保存到成员变量中，我们对照 Retrofit.Builder.build 方法进行解释：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> Retrofit <span style=color:#a6e22e>build</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>baseUrl <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Base URL required.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// callFactory 就是传入的 OkHttpClient
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// 因为 OkHttpClient 实现了 okhttp3.Call.Factory这个接口
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  okhttp3<span style=color:#f92672>.</span><span style=color:#a6e22e>Call</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span> callFactory <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>callFactory</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>callFactory <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    callFactory <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> OkHttpClient<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 如果没有设置 callbackExecutor，则获取 platform 的默认 callbackExecutor
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// 这里被赋值为了 MainThreadExecutor
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Executor callbackExecutor <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>callbackExecutor</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>callbackExecutor <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    callbackExecutor <span style=color:#f92672>=</span> platform<span style=color:#f92672>.</span><span style=color:#a6e22e>defaultCallbackExecutor</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 在配置的时候设置了一个 RxJava3CallAdapterFactory
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// 然后这里另外添加了一个 DefaultCallAdapterFactory，并传入刚获取的 callbackExecutor 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// 如果 Android API &gt;= 24，默认还有一个 CompletableFutureCallAdapterFactory
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// Make a defensive copy of the adapters and add the default Call adapter.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  List<span style=color:#f92672>&lt;</span>CallAdapter<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span><span style=color:#f92672>&gt;</span> callAdapterFactories <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>callAdapterFactories</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  callAdapterFactories<span style=color:#f92672>.</span><span style=color:#a6e22e>addAll</span><span style=color:#f92672>(</span>platform<span style=color:#f92672>.</span><span style=color:#a6e22e>defaultCallAdapterFactories</span><span style=color:#f92672>(</span>callbackExecutor<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Make a defensive copy of the converters.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  List<span style=color:#f92672>&lt;</span>Converter<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span><span style=color:#f92672>&gt;</span> converterFactories <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;(</span>
</span></span><span style=display:flex><span>          1 <span style=color:#f92672>+</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>converterFactories</span><span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> platform<span style=color:#f92672>.</span><span style=color:#a6e22e>defaultConverterFactoriesSize</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Add the built-in converter factory first. This prevents overriding its behavior but also
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// ensures correct behavior when using converters that consume all types.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// 添加内置 ConverterFactory
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  converterFactories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> BuiltInConverters<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 添加我们设置的 GsonConverterFactory
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  converterFactories<span style=color:#f92672>.</span><span style=color:#a6e22e>addAll</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>converterFactories</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 如果 Android API &gt;= 24，添加默认的 OptionalConverterFactory 支持 Java8
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  converterFactories<span style=color:#f92672>.</span><span style=color:#a6e22e>addAll</span><span style=color:#f92672>(</span>platform<span style=color:#f92672>.</span><span style=color:#a6e22e>defaultConverterFactories</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Retrofit<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>      callFactory<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      baseUrl<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      unmodifiableList<span style=color:#f92672>(</span>converterFactories<span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>      unmodifiableList<span style=color:#f92672>(</span>callAdapterFactories<span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>      callbackExecutor<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      validateEagerly<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这里首先是根据配置的内容和 Platform 获取到 callAdapterFactories 和 converterFactories 集合，然后利用这些参数创建一个 Retrofit 实例。</p><p>需要注意的是，第 37-39 行添加用户配置的 ConverterFactory 和 Platform 默认的 ConverterFactory 的顺序值得怀疑。后文分析过程将会进行解释。</p><h2 id=retrofitcreate>Retrofit.create
<a class=anchor href=#retrofitcreate>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> T <span style=color:#a6e22e>create</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> Class<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> service<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  validateServiceInterface<span style=color:#f92672>(</span>service<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>T<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      Proxy<span style=color:#f92672>.</span><span style=color:#a6e22e>newProxyInstance</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>          service<span style=color:#f92672>.</span><span style=color:#a6e22e>getClassLoader</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>new</span> Class<span style=color:#f92672>&lt;?&gt;[]</span> <span style=color:#f92672>{</span>service<span style=color:#f92672>},</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>new</span> InvocationHandler<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Platform platform <span style=color:#f92672>=</span> Platform<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Object<span style=color:#f92672>[]</span> emptyArgs <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Object<span style=color:#f92672>[</span>0<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>@Nullable</span> Object <span style=color:#a6e22e>invoke</span><span style=color:#f92672>(</span>Object proxy<span style=color:#f92672>,</span> Method method<span style=color:#f92672>,</span> <span style=color:#a6e22e>@Nullable</span> Object<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throws</span> Throwable <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>              <span style=color:#75715e>// If the method is a method from Object then defer to normal invocation.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>              <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>method<span style=color:#f92672>.</span><span style=color:#a6e22e>getDeclaringClass</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> Object<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>invoke</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> args<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>              args <span style=color:#f92672>=</span> args <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> args <span style=color:#f92672>:</span> emptyArgs<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>              <span style=color:#75715e>// 如果是 default 方法，则通过 platform 调用此方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>              <span style=color:#75715e>// 普通方法则进行 loadServiceMethod(method).invoke(args)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>              <span style=color:#66d9ef>return</span> platform<span style=color:#f92672>.</span><span style=color:#a6e22e>isDefaultMethod</span><span style=color:#f92672>(</span>method<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                  <span style=color:#f92672>?</span> platform<span style=color:#f92672>.</span><span style=color:#a6e22e>invokeDefaultMethod</span><span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> service<span style=color:#f92672>,</span> proxy<span style=color:#f92672>,</span> args<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                  <span style=color:#f92672>:</span> loadServiceMethod<span style=color:#f92672>(</span>method<span style=color:#f92672>).</span><span style=color:#a6e22e>invoke</span><span style=color:#f92672>(</span>args<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>validateServiceInterface</span><span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;?&gt;</span> service<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// service 必需是接口
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>service<span style=color:#f92672>.</span><span style=color:#a6e22e>isInterface</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;API declarations must be interfaces.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Deque<span style=color:#f92672>&lt;</span>Class<span style=color:#f92672>&lt;?&gt;&gt;</span> check <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayDeque<span style=color:#f92672>&lt;&gt;(</span>1<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  check<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>service<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> <span style=color:#f92672>(!</span>check<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Class<span style=color:#f92672>&lt;?&gt;</span> candidate <span style=color:#f92672>=</span> check<span style=color:#f92672>.</span><span style=color:#a6e22e>removeFirst</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>candidate<span style=color:#f92672>.</span><span style=color:#a6e22e>getTypeParameters</span><span style=color:#f92672>().</span><span style=color:#a6e22e>length</span> <span style=color:#f92672>!=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      StringBuilder message <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>new</span> StringBuilder<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Type parameters are unsupported on &#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span>candidate<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>candidate <span style=color:#f92672>!=</span> service<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        message<span style=color:#f92672>.</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34; which is an interface of &#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span>service<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span>message<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    Collections<span style=color:#f92672>.</span><span style=color:#a6e22e>addAll</span><span style=color:#f92672>(</span>check<span style=color:#f92672>,</span> candidate<span style=color:#f92672>.</span><span style=color:#a6e22e>getInterfaces</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 如果 Retrofit.Builder 中设置了此参数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>validateEagerly<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Platform platform <span style=color:#f92672>=</span> Platform<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 提前解析并验证所有非 default 和非 static 方法是否配置正确，并缓存解析结果
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Method method <span style=color:#f92672>:</span> service<span style=color:#f92672>.</span><span style=color:#a6e22e>getDeclaredMethods</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>platform<span style=color:#f92672>.</span><span style=color:#a6e22e>isDefaultMethod</span><span style=color:#f92672>(</span>method<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>Modifier<span style=color:#f92672>.</span><span style=color:#a6e22e>isStatic</span><span style=color:#f92672>(</span>method<span style=color:#f92672>.</span><span style=color:#a6e22e>getModifiers</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        loadServiceMethod<span style=color:#f92672>(</span>method<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看出，通过 Retrofit.create(Class) 方法的调用，会创建出 GitHubService 的实例，从而使得 GitHubService 中配置的方法变得可用，这是 Retrofit 代码结构的核心。</p><p>Retrofit.create() 方法的核心，使用的是 Proxy.newProxyInstance() 方法来创建 GitHubService 实例。这个方法会为参数中的多个 interface（具体到 Retrofit 来说，是固定传入一个 interface）创建一个对象，这个对象实现了所有 interface 的每个方法，并且每个方法的实现都是雷同的：调用对象实例内部的一个 InvocationHandler 成员变量的 invoke() 方法，并把自己的方法信息传递进去。这样就在实质上实现了代理逻辑：interface 中的方法全部由一个另外设定的 InvocationHandler 对象来进行代理操作。并且，这些方法的具体实现是在运行时生成 interface 实例时才确定的，而不是在编译时（虽然在编译时就已经可以通过代码逻辑推断出来）。这就是<strong>「动态代理机制」</strong>的具体含义。</p><p>因此，invoke() 方法中的逻辑，就是 Retrofit 创建 Service 实例的关键。</p><p>当调用 GitHubService 中配置好的请求方法时，<code>InvocationHandler.invoke()</code> 方法就会被回调。在 invoke 方法中，会进行判断，如果调用的是我们配置的请求方法，则会走到 <code>loadServiceMethod(method).invoke(args)</code>。</p><h2 id=loadservicemethodmethod>loadServiceMethod(method)
<a class=anchor href=#loadservicemethodmethod>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>ServiceMethod<span style=color:#f92672>&lt;?&gt;</span> loadServiceMethod<span style=color:#f92672>(</span>Method method<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  ServiceMethod<span style=color:#f92672>&lt;?&gt;</span> result <span style=color:#f92672>=</span> serviceMethodCache<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>method<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>result <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span>serviceMethodCache<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> serviceMethodCache<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>method<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>result <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      result <span style=color:#f92672>=</span> ServiceMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>parseAnnotations</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> method<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      serviceMethodCache<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> result<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到，这里对 ServiceMethod 进行了缓存设计。具体解析方法还是在 ServiceMethod 中：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ServiceMethod</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> ServiceMethod<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>parseAnnotations</span><span style=color:#f92672>(</span>Retrofit retrofit<span style=color:#f92672>,</span> Method method<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 解析方法注解并创建 RequestFactory
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    RequestFactory requestFactory <span style=color:#f92672>=</span> RequestFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>parseAnnotations</span><span style=color:#f92672>(</span>retrofit<span style=color:#f92672>,</span> method<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Type returnType <span style=color:#f92672>=</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getGenericReturnType</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>hasUnresolvableType</span><span style=color:#f92672>(</span>returnType<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> methodError<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>          method<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;Method return type must not include a type variable or wildcard: %s&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>          returnType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>returnType <span style=color:#f92672>==</span> <span style=color:#66d9ef>void</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> methodError<span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Service methods cannot return void.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 解析方法注解并创建 HttpServiceMethod 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> HttpServiceMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>parseAnnotations</span><span style=color:#f92672>(</span>retrofit<span style=color:#f92672>,</span> method<span style=color:#f92672>,</span> requestFactory<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>abstract</span> <span style=color:#a6e22e>@Nullable</span> T <span style=color:#a6e22e>invoke</span><span style=color:#f92672>(</span>Object<span style=color:#f92672>[]</span> args<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>HttpServiceMethod 继承自 ServiceMethod，parseAnnotations 方法如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>,</span> ReturnT<span style=color:#f92672>&gt;</span> HttpServiceMethod<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>,</span> ReturnT<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>parseAnnotations</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    Retrofit retrofit<span style=color:#f92672>,</span> Method method<span style=color:#f92672>,</span> RequestFactory requestFactory<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>boolean</span> isKotlinSuspendFunction <span style=color:#f92672>=</span> requestFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>isKotlinSuspendFunction</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>boolean</span> continuationWantsResponse <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>boolean</span> continuationBodyNullable <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Annotation<span style=color:#f92672>[]</span> annotations <span style=color:#f92672>=</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getAnnotations</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  Type adapterType<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 如果是 Kotlin suspend 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isKotlinSuspendFunction<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Type<span style=color:#f92672>[]</span> parameterTypes <span style=color:#f92672>=</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getGenericParameterTypes</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    Type responseType <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>getParameterLowerBound</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            0<span style=color:#f92672>,</span> <span style=color:#f92672>(</span>ParameterizedType<span style=color:#f92672>)</span> parameterTypes<span style=color:#f92672>[</span>parameterTypes<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> 1<span style=color:#f92672>]);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>getRawType<span style=color:#f92672>(</span>responseType<span style=color:#f92672>)</span> <span style=color:#f92672>==</span> Response<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span> <span style=color:#f92672>&amp;&amp;</span> responseType <span style=color:#66d9ef>instanceof</span> ParameterizedType<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Unwrap the actual body type from Response&lt;T&gt;.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      responseType <span style=color:#f92672>=</span> Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>getParameterUpperBound</span><span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> <span style=color:#f92672>(</span>ParameterizedType<span style=color:#f92672>)</span> responseType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      continuationWantsResponse <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// TODO figure out if type is nullable or not
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// Metadata metadata = method.getDeclaringClass().getAnnotation(Metadata.class)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// Find the entry for method
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// Determine if return type is nullable or not
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    adapterType <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>ParameterizedTypeImpl</span><span style=color:#f92672>(</span><span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> Call<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> responseType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    annotations <span style=color:#f92672>=</span> SkipCallbackExecutorImpl<span style=color:#f92672>.</span><span style=color:#a6e22e>ensurePresent</span><span style=color:#f92672>(</span>annotations<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 普通方法返回泛型参数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    adapterType <span style=color:#f92672>=</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getGenericReturnType</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 1、根据 method 的返回值类型以及方法注解返回第一个可以处理的 CallAdapter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  CallAdapter<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>,</span> ReturnT<span style=color:#f92672>&gt;</span> callAdapter <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      createCallAdapter<span style=color:#f92672>(</span>retrofit<span style=color:#f92672>,</span> method<span style=color:#f92672>,</span> adapterType<span style=color:#f92672>,</span> annotations<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  Type responseType <span style=color:#f92672>=</span> callAdapter<span style=color:#f92672>.</span><span style=color:#a6e22e>responseType</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>responseType <span style=color:#f92672>==</span> okhttp3<span style=color:#f92672>.</span><span style=color:#a6e22e>Response</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> methodError<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        method<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#39;&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>+</span> getRawType<span style=color:#f92672>(</span>responseType<span style=color:#f92672>).</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39; is not a valid response body type. Did you mean ResponseBody?&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>responseType <span style=color:#f92672>==</span> Response<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> methodError<span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Response must include generic type (e.g., Response&lt;String&gt;)&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// TODO support Unit for Kotlin?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>requestFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>httpMethod</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;HEAD&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>Void<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>responseType<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> methodError<span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;HEAD method must use Void as response type.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 2、根据 responseType 以及方法注解返回第一个可以处理的 Converter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Converter<span style=color:#f92672>&lt;</span>ResponseBody<span style=color:#f92672>,</span> ResponseT<span style=color:#f92672>&gt;</span> responseConverter <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      createResponseConverter<span style=color:#f92672>(</span>retrofit<span style=color:#f92672>,</span> method<span style=color:#f92672>,</span> responseType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 3、根据不同的场景返回不同的 HttpServiceMethod 实现
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  okhttp3<span style=color:#f92672>.</span><span style=color:#a6e22e>Call</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span> callFactory <span style=color:#f92672>=</span> retrofit<span style=color:#f92672>.</span><span style=color:#a6e22e>callFactory</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>isKotlinSuspendFunction<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 3.1、根据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> CallAdapted<span style=color:#f92672>&lt;&gt;(</span>requestFactory<span style=color:#f92672>,</span> callFactory<span style=color:#f92672>,</span> responseConverter<span style=color:#f92672>,</span> callAdapter<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>continuationWantsResponse<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//noinspection unchecked Kotlin compiler guarantees ReturnT to be Object.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>HttpServiceMethod<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>,</span> ReturnT<span style=color:#f92672>&gt;)</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> SuspendForResponse<span style=color:#f92672>&lt;&gt;(</span>
</span></span><span style=display:flex><span>            requestFactory<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            callFactory<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            responseConverter<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>(</span>CallAdapter<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>,</span> Call<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>&gt;&gt;)</span> callAdapter<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//noinspection unchecked Kotlin compiler guarantees ReturnT to be Object.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>HttpServiceMethod<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>,</span> ReturnT<span style=color:#f92672>&gt;)</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> SuspendForBody<span style=color:#f92672>&lt;&gt;(</span>
</span></span><span style=display:flex><span>            requestFactory<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            callFactory<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            responseConverter<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>(</span>CallAdapter<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>,</span> Call<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>&gt;&gt;)</span> callAdapter<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            continuationBodyNullable<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这行代码负责读取 interface 中原方法的信息（包括返回值类型、方法注解、参数类型、参数注解），并将这些信息做初步分析后根据这些信息创建出每个方法对应的 CallAdapter 和 Convetor 等对象，并将这些对象传入一个 CallAdapted 对象并返回此对象。</p><p>这里分别分析 32 行 <code>createCallAdapter</code> 和 51 行 <code>createResponseConverter</code> 的代码。</p><h3 id=createcalladapter>createCallAdapter
<a class=anchor href=#createcalladapter>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>,</span> ReturnT<span style=color:#f92672>&gt;</span> CallAdapter<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>,</span> ReturnT<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>createCallAdapter</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    Retrofit retrofit<span style=color:#f92672>,</span> Method method<span style=color:#f92672>,</span> Type returnType<span style=color:#f92672>,</span> Annotation<span style=color:#f92672>[]</span> annotations<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//noinspection unchecked
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>CallAdapter<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>,</span> ReturnT<span style=color:#f92672>&gt;)</span> retrofit<span style=color:#f92672>.</span><span style=color:#a6e22e>callAdapter</span><span style=color:#f92672>(</span>returnType<span style=color:#f92672>,</span> annotations<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>RuntimeException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span> <span style=color:#75715e>// Wide exception range because factories are user code.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>throw</span> methodError<span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> e<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Unable to create call adapter for %s&#34;</span><span style=color:#f92672>,</span> returnType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>还是交给 Retrofit 类处理：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> CallAdapter<span style=color:#f92672>&lt;?,</span> <span style=color:#f92672>?&gt;</span> callAdapter<span style=color:#f92672>(</span>Type returnType<span style=color:#f92672>,</span> Annotation<span style=color:#f92672>[]</span> annotations<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> nextCallAdapter<span style=color:#f92672>(</span><span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> returnType<span style=color:#f92672>,</span> annotations<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> CallAdapter<span style=color:#f92672>&lt;?,</span> <span style=color:#f92672>?&gt;</span> nextCallAdapter<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Nullable</span> CallAdapter<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span> skipPast<span style=color:#f92672>,</span> Type returnType<span style=color:#f92672>,</span> Annotation<span style=color:#f92672>[]</span> annotations<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  Objects<span style=color:#f92672>.</span><span style=color:#a6e22e>requireNonNull</span><span style=color:#f92672>(</span>returnType<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;returnType == null&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  Objects<span style=color:#f92672>.</span><span style=color:#a6e22e>requireNonNull</span><span style=color:#f92672>(</span>annotations<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;annotations == null&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 遍历 callAdapterFactories 集合
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>int</span> start <span style=color:#f92672>=</span> callAdapterFactories<span style=color:#f92672>.</span><span style=color:#a6e22e>indexOf</span><span style=color:#f92672>(</span>skipPast<span style=color:#f92672>)</span> <span style=color:#f92672>+</span> 1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> start<span style=color:#f92672>,</span> count <span style=color:#f92672>=</span> callAdapterFactories<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>();</span> i <span style=color:#f92672>&lt;</span> count<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 通过 CallAdapter.Factory.get 判断是否为符合要求的 CallAdapter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    CallAdapter<span style=color:#f92672>&lt;?,</span> <span style=color:#f92672>?&gt;</span> adapter <span style=color:#f92672>=</span> callAdapterFactories<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>i<span style=color:#f92672>).</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>returnType<span style=color:#f92672>,</span> annotations<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>adapter <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> adapter<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  StringBuilder builder <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>new</span> StringBuilder<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Could not locate call adapter for &#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span>returnType<span style=color:#f92672>).</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;.\n&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>skipPast <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    builder<span style=color:#f92672>.</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;  Skipped:&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> start<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      builder<span style=color:#f92672>.</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;\n   * &#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span>callAdapterFactories<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>i<span style=color:#f92672>).</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    builder<span style=color:#f92672>.</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#39;\n&#39;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  builder<span style=color:#f92672>.</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;  Tried:&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> start<span style=color:#f92672>,</span> count <span style=color:#f92672>=</span> callAdapterFactories<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>();</span> i <span style=color:#f92672>&lt;</span> count<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    builder<span style=color:#f92672>.</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;\n   * &#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span>callAdapterFactories<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>i<span style=color:#f92672>).</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span>builder<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>逻辑比较简单，就是遍历 callAdapterFactories 集合，调用每个 CallAdapter.Factory.get() 方法并传入请求方法的注解信息和返回值信息，根据这些信息每个 CallAdapter.Factory 去判断此请求方法适不适合自己。</p><h4 id=defaultcalladapterfactoryget>DefaultCallAdapterFactory.get()
<a class=anchor href=#defaultcalladapterfactoryget>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>@Nullable</span> CallAdapter<span style=color:#f92672>&lt;?,</span> <span style=color:#f92672>?&gt;</span> get<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    Type returnType<span style=color:#f92672>,</span> Annotation<span style=color:#f92672>[]</span> annotations<span style=color:#f92672>,</span> Retrofit retrofit<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 方法返回值为 Call 类型
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>getRawType<span style=color:#f92672>(</span>returnType<span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> Call<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 方法返回值必须包含泛型 Call&lt;Foo&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!(</span>returnType <span style=color:#66d9ef>instanceof</span> ParameterizedType<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;Call return type must be parameterized as Call&lt;Foo&gt; or Call&lt;? extends Foo&gt;&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> Type responseType <span style=color:#f92672>=</span> Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>getParameterUpperBound</span><span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> <span style=color:#f92672>(</span>ParameterizedType<span style=color:#f92672>)</span> returnType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// executor = callbackExecutor = MainThreadExecutor
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>final</span> Executor executor <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>isAnnotationPresent</span><span style=color:#f92672>(</span>annotations<span style=color:#f92672>,</span> SkipCallbackExecutor<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>?</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>:</span> callbackExecutor<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 返回匿名对象实现 CallAdapter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> CallAdapter<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>,</span> Call<span style=color:#f92672>&lt;?&gt;&gt;()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Type <span style=color:#a6e22e>responseType</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> responseType<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Call<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>adapt</span><span style=color:#f92672>(</span>Call<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> call<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> executor <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> call <span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> ExecutorCallbackCall<span style=color:#f92672>&lt;&gt;(</span>executor<span style=color:#f92672>,</span> call<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ol><li>DefaultCallAdapterFactory 首先通过判断方法返回值是否为 Call 类型并且是否带有泛型参数来确定能不能处理这个请求；</li><li>然后将 executor 赋值为前面 Retrofit.create 流程中获取到的 MainThreadExecutor；</li><li>最后返回一个 CallAdapter 的匿名实现类。</li></ol><h4 id=rxjava3calladapterfactoryget>RxJava3CallAdapterFactory.get()
<a class=anchor href=#rxjava3calladapterfactoryget>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>@Nullable</span> CallAdapter<span style=color:#f92672>&lt;?,</span> <span style=color:#f92672>?&gt;</span> get<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>  Type returnType<span style=color:#f92672>,</span> Annotation<span style=color:#f92672>[]</span> annotations<span style=color:#f92672>,</span> Retrofit retrofit<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Class<span style=color:#f92672>&lt;?&gt;</span> rawType <span style=color:#f92672>=</span> getRawType<span style=color:#f92672>(</span>returnType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>rawType <span style=color:#f92672>==</span> Completable<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Completable is not parameterized (which is what the rest of this method deals with) so it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// can only be created with a single configuration.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> RxJava3CallAdapter<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>          Void<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> scheduler<span style=color:#f92672>,</span> isAsync<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> isFlowable <span style=color:#f92672>=</span> rawType <span style=color:#f92672>==</span> Flowable<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> isSingle <span style=color:#f92672>=</span> rawType <span style=color:#f92672>==</span> Single<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> isMaybe <span style=color:#f92672>=</span> rawType <span style=color:#f92672>==</span> Maybe<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>rawType <span style=color:#f92672>!=</span> Observable<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>isFlowable <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>isSingle <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>isMaybe<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> isResult <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> isBody <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    Type responseType<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!(</span>returnType <span style=color:#66d9ef>instanceof</span> ParameterizedType<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      String name <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>          isFlowable <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;Flowable&#34;</span> <span style=color:#f92672>:</span> isSingle <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;Single&#34;</span> <span style=color:#f92672>:</span> isMaybe <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;Maybe&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Observable&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>          name
</span></span><span style=display:flex><span>              <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; return type must be parameterized&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; as &#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>+</span> name
</span></span><span style=display:flex><span>              <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&lt;Foo&gt; or &#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>+</span> name
</span></span><span style=display:flex><span>              <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&lt;? extends Foo&gt;&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Type observableType <span style=color:#f92672>=</span> getParameterUpperBound<span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> <span style=color:#f92672>(</span>ParameterizedType<span style=color:#f92672>)</span> returnType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    Class<span style=color:#f92672>&lt;?&gt;</span> rawObservableType <span style=color:#f92672>=</span> getRawType<span style=color:#f92672>(</span>observableType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>rawObservableType <span style=color:#f92672>==</span> Response<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!(</span>observableType <span style=color:#66d9ef>instanceof</span> ParameterizedType<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Response must be parameterized&#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; as Response&lt;Foo&gt; or Response&lt;? extends Foo&gt;&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      responseType <span style=color:#f92672>=</span> getParameterUpperBound<span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> <span style=color:#f92672>(</span>ParameterizedType<span style=color:#f92672>)</span> observableType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>rawObservableType <span style=color:#f92672>==</span> Result<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!(</span>observableType <span style=color:#66d9ef>instanceof</span> ParameterizedType<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Result must be parameterized&#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; as Result&lt;Foo&gt; or Result&lt;? extends Foo&gt;&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      responseType <span style=color:#f92672>=</span> getParameterUpperBound<span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> <span style=color:#f92672>(</span>ParameterizedType<span style=color:#f92672>)</span> observableType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      isResult <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      responseType <span style=color:#f92672>=</span> observableType<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      isBody <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> RxJava3CallAdapter<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        responseType<span style=color:#f92672>,</span> scheduler<span style=color:#f92672>,</span> isAsync<span style=color:#f92672>,</span> isResult<span style=color:#f92672>,</span> isBody<span style=color:#f92672>,</span> isFlowable<span style=color:#f92672>,</span> isSingle<span style=color:#f92672>,</span> isMaybe<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=completablefuturecalladapterfactoryget>CompletableFutureCallAdapterFactory.get()
<a class=anchor href=#completablefuturecalladapterfactoryget>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>@Nullable</span> CallAdapter<span style=color:#f92672>&lt;?,</span> <span style=color:#f92672>?&gt;</span> get<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    Type returnType<span style=color:#f92672>,</span> Annotation<span style=color:#f92672>[]</span> annotations<span style=color:#f92672>,</span> Retrofit retrofit<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>getRawType<span style=color:#f92672>(</span>returnType<span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> CompletableFuture<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!(</span>returnType <span style=color:#66d9ef>instanceof</span> ParameterizedType<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;CompletableFuture return type must be parameterized&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; as CompletableFuture&lt;Foo&gt; or CompletableFuture&lt;? extends Foo&gt;&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  Type innerType <span style=color:#f92672>=</span> getParameterUpperBound<span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> <span style=color:#f92672>(</span>ParameterizedType<span style=color:#f92672>)</span> returnType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>getRawType<span style=color:#f92672>(</span>innerType<span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> Response<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Generic type is not Response&lt;T&gt;. Use it for body-only adapter.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> BodyCallAdapter<span style=color:#f92672>&lt;&gt;(</span>innerType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Generic type is Response&lt;T&gt;. Extract T and create the Response version of the adapter.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!(</span>innerType <span style=color:#66d9ef>instanceof</span> ParameterizedType<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;Response must be parameterized&#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; as Response&lt;Foo&gt; or Response&lt;? extends Foo&gt;&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  Type responseType <span style=color:#f92672>=</span> getParameterUpperBound<span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> <span style=color:#f92672>(</span>ParameterizedType<span style=color:#f92672>)</span> innerType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ResponseCallAdapter<span style=color:#f92672>&lt;&gt;(</span>responseType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=小结>小结
<a class=anchor href=#%e5%b0%8f%e7%bb%93>#</a></h4><p>对于例子中 GithubService 中的请求方法：</p><ol><li><code>fun listRepos(@Path("user") user: String?): Call&lt;List&lt;Repo>></code></li></ol><p>返回匿名的 CallAdapter 实现类</p><ol start=2><li><code>fun listReposRx(@Path("user") user: String?): Observable&lt;List&lt;Repo>></code></li></ol><p>返回 RxJava3CallAdapter 实例</p><ol start=3><li><code>fun listReposCompletable(@Path("user") user: String?): CompletableFuture&lt;List&lt;Repo>></code></li></ol><p>返回 CompletableFutureCallAdapterFactory.ResponseCallAdapter 实例</p><p>Retrofit.callAdapter() 方法的逻辑如下：</p><ul><li>首先会遍历 callAdapterFactories 集合，并调用每个 CallAdapter.Factory.get() 方法并传入请求方法的注解信息和返回值信息，根据这些信息每个 CallAdapterFactory 去判断此请求方法适不适合自己。</li><li>一旦找到合适的 CallAdapter 则会立即打破循环并返回。</li><li>DefaultCallAdapterFactory 只能处理返回值为 <code>Call&lt;Foo></code> 或者 <code>Call&lt;? extends Foo></code> 的请求方法，并且为它们返回一个匿名的 CallAdapter 实现。</li><li>其它情况，如果要支持 Rxjava，则需要额外增加 CallAdapterFactory 支持。</li><li>如果 Android API >= 24，如果请求方法返回的是 CompletableFuture，Retrofit 默认会进行支持并返回 CompletableFutureCallAdapterFactory 进行处理。</li><li>如果需要支持其它的返回值类型，则需要手动通过 addCallAdapterFactory() 方法增加对 CallAdapterFactory 的支持。</li><li>如果请求方法返回值不受支持，则会抛出异常。</li></ul><h3 id=createresponseconverter>createResponseConverter
<a class=anchor href=#createresponseconverter>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>&gt;</span> Converter<span style=color:#f92672>&lt;</span>ResponseBody<span style=color:#f92672>,</span> ResponseT<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>createResponseConverter</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    Retrofit retrofit<span style=color:#f92672>,</span> Method method<span style=color:#f92672>,</span> Type responseType<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  Annotation<span style=color:#f92672>[]</span> annotations <span style=color:#f92672>=</span> method<span style=color:#f92672>.</span><span style=color:#a6e22e>getAnnotations</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> retrofit<span style=color:#f92672>.</span><span style=color:#a6e22e>responseBodyConverter</span><span style=color:#f92672>(</span>responseType<span style=color:#f92672>,</span> annotations<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>RuntimeException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span> <span style=color:#75715e>// Wide exception range because factories are user code.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>throw</span> methodError<span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> e<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Unable to create converter for %s&#34;</span><span style=color:#f92672>,</span> responseType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>还是从 Retrofit 类中获取：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> Converter<span style=color:#f92672>&lt;</span>ResponseBody<span style=color:#f92672>,</span> T<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>responseBodyConverter</span><span style=color:#f92672>(</span>Type type<span style=color:#f92672>,</span> Annotation<span style=color:#f92672>[]</span> annotations<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> nextResponseBodyConverter<span style=color:#f92672>(</span><span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> type<span style=color:#f92672>,</span> annotations<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> Converter<span style=color:#f92672>&lt;</span>ResponseBody<span style=color:#f92672>,</span> T<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>nextResponseBodyConverter</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Nullable</span> Converter<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span> skipPast<span style=color:#f92672>,</span> Type type<span style=color:#f92672>,</span> Annotation<span style=color:#f92672>[]</span> annotations<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  Objects<span style=color:#f92672>.</span><span style=color:#a6e22e>requireNonNull</span><span style=color:#f92672>(</span>type<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;type == null&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  Objects<span style=color:#f92672>.</span><span style=color:#a6e22e>requireNonNull</span><span style=color:#f92672>(</span>annotations<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;annotations == null&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> start <span style=color:#f92672>=</span> converterFactories<span style=color:#f92672>.</span><span style=color:#a6e22e>indexOf</span><span style=color:#f92672>(</span>skipPast<span style=color:#f92672>)</span> <span style=color:#f92672>+</span> 1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> start<span style=color:#f92672>,</span> count <span style=color:#f92672>=</span> converterFactories<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>();</span> i <span style=color:#f92672>&lt;</span> count<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Converter<span style=color:#f92672>&lt;</span>ResponseBody<span style=color:#f92672>,</span> <span style=color:#f92672>?&gt;</span> converter <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        converterFactories<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>i<span style=color:#f92672>).</span><span style=color:#a6e22e>responseBodyConverter</span><span style=color:#f92672>(</span>type<span style=color:#f92672>,</span> annotations<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>converter <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>//noinspection unchecked
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>Converter<span style=color:#f92672>&lt;</span>ResponseBody<span style=color:#f92672>,</span> T<span style=color:#f92672>&gt;)</span> converter<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  StringBuilder builder <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>new</span> StringBuilder<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Could not locate ResponseBody converter for &#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>.</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span>type<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>.</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;.\n&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>skipPast <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    builder<span style=color:#f92672>.</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;  Skipped:&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> start<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      builder<span style=color:#f92672>.</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;\n   * &#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span>converterFactories<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>i<span style=color:#f92672>).</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    builder<span style=color:#f92672>.</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#39;\n&#39;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  builder<span style=color:#f92672>.</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;  Tried:&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> start<span style=color:#f92672>,</span> count <span style=color:#f92672>=</span> converterFactories<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>();</span> i <span style=color:#f92672>&lt;</span> count<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    builder<span style=color:#f92672>.</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;\n   * &#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span>converterFactories<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>i<span style=color:#f92672>).</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span>builder<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=builtinconvertersresponsebodyconverter>BuiltInConverters.responseBodyConverter()
<a class=anchor href=#builtinconvertersresponsebodyconverter>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>@Nullable</span> Converter<span style=color:#f92672>&lt;</span>ResponseBody<span style=color:#f92672>,</span> <span style=color:#f92672>?&gt;</span> responseBodyConverter<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    Type type<span style=color:#f92672>,</span> Annotation<span style=color:#f92672>[]</span> annotations<span style=color:#f92672>,</span> Retrofit retrofit<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 返回值类型为 ResponseBody
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>type <span style=color:#f92672>==</span> ResponseBody<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>isAnnotationPresent</span><span style=color:#f92672>(</span>annotations<span style=color:#f92672>,</span> Streaming<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>?</span> StreamingResponseBodyConverter<span style=color:#f92672>.</span><span style=color:#a6e22e>INSTANCE</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>:</span> BufferingResponseBodyConverter<span style=color:#f92672>.</span><span style=color:#a6e22e>INSTANCE</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 返回值为 void
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>type <span style=color:#f92672>==</span> Void<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> VoidResponseBodyConverter<span style=color:#f92672>.</span><span style=color:#a6e22e>INSTANCE</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 返回值为 Kotlin 的 Unit
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>checkForKotlinUnit<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>type <span style=color:#f92672>==</span> Unit<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> UnitResponseBodyConverter<span style=color:#f92672>.</span><span style=color:#a6e22e>INSTANCE</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>NoClassDefFoundError ignored<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      checkForKotlinUnit <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>据前面分析可知，BuiltInConverters 是 Retrofit 在 Android Platform 上唯一默认的 ConvertFactory。因此，请求方法的返回值的数据类型（注意不是返回值类型）只有在以上三种情况下，通过 Retrofit.Builder() 创建 Retrofit 的时候才可以不指定 ConvertFactory，否则调用该方法的时候将会抛出异常。</p><h4 id=gsonconverterfactory-responsebodyconverter>GsonConverterFactory. responseBodyConverter()
<a class=anchor href=#gsonconverterfactory-responsebodyconverter>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Converter<span style=color:#f92672>&lt;</span>ResponseBody<span style=color:#f92672>,</span> <span style=color:#f92672>?&gt;</span> responseBodyConverter<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    Type type<span style=color:#f92672>,</span> Annotation<span style=color:#f92672>[]</span> annotations<span style=color:#f92672>,</span> Retrofit retrofit<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  TypeAdapter<span style=color:#f92672>&lt;?&gt;</span> adapter <span style=color:#f92672>=</span> gson<span style=color:#f92672>.</span><span style=color:#a6e22e>getAdapter</span><span style=color:#f92672>(</span>TypeToken<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>type<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> GsonResponseBodyConverter<span style=color:#f92672>&lt;&gt;(</span>gson<span style=color:#f92672>,</span> adapter<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>如果通过 addConverterFactory() 添加了 GsonConverterFactory ，这里将返回一个 GsonResponseBodyConverter 实例，不用进行任何判断，当然 gson.getAdapter 中不能抛出异常。</p><h4 id=optionalconverterfactoryresponsebodyconverter>OptionalConverterFactory.responseBodyConverter()
<a class=anchor href=#optionalconverterfactoryresponsebodyconverter>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>@Nullable</span> Converter<span style=color:#f92672>&lt;</span>ResponseBody<span style=color:#f92672>,</span> <span style=color:#f92672>?&gt;</span> responseBodyConverter<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    Type type<span style=color:#f92672>,</span> Annotation<span style=color:#f92672>[]</span> annotations<span style=color:#f92672>,</span> Retrofit retrofit<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>getRawType<span style=color:#f92672>(</span>type<span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> Optional<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 获取 Option 内层的泛型类型
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Type innerType <span style=color:#f92672>=</span> getParameterUpperBound<span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> <span style=color:#f92672>(</span>ParameterizedType<span style=color:#f92672>)</span> type<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  Converter<span style=color:#f92672>&lt;</span>ResponseBody<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> delegate <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      retrofit<span style=color:#f92672>.</span><span style=color:#a6e22e>responseBodyConverter</span><span style=color:#f92672>(</span>innerType<span style=color:#f92672>,</span> annotations<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> OptionalConverter<span style=color:#f92672>&lt;&gt;(</span>delegate<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>它只处理返回值为 <code>Call&lt;Option&lt;Foo>></code> 类型的请求，并且脱去外衣获取 Option 内层的泛型类型 innerType，并且使用这个 innerType 查找到另外一个符合要求 Converter，最后的 Convert 操作都使用这个 delegate 进行转换操作。</p><h4 id=小结-1>小结
<a class=anchor href=#%e5%b0%8f%e7%bb%93-1>#</a></h4><p>对于 BuiltInConverters，它只会查看泛型参数内容，如果泛型参数为 ResponseBody、Void 或者 Kotlin 的 Unit，BuiltInConverters 将会返回相应的 Converter；</p><p>对于 GsonConverterFactory，它将来者不拒，返回 GsonResponseBodyConverter。</p><p>对于 OptionalConverterFactory，它只处理返回值为 <code>Call&lt;Option&lt;Foo>></code> 类型的请求，并且委托另外一个符合要求 Converter 进行转换操作。</p><p>Retrofit.responseBodyConverter() 方法一旦找到合适的 CallAdapterFactory 则会立即打破循环并返回。</p><p>因此这里需要特别注意，前面提到过的 Retrofit.Builder.build() 方法中，converterFactories 的添加顺序如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 添加内置 ConverterFactory
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>converterFactories<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> BuiltInConverters<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 添加我们设置的 GsonConverterFactory
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>converterFactories<span style=color:#f92672>.</span><span style=color:#a6e22e>addAll</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>converterFactories</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 如果 Android API &gt;= 24，添加默认的 OptionalConverterFactory 支持 Java8
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>converterFactories<span style=color:#f92672>.</span><span style=color:#a6e22e>addAll</span><span style=color:#f92672>(</span>platform<span style=color:#f92672>.</span><span style=color:#a6e22e>defaultConverterFactories</span><span style=color:#f92672>());</span>
</span></span></code></pre></div><p>这时候如果要像这样使用 Optional 去接收数据：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#a6e22e>@GET</span>(<span style=color:#e6db74>&#34;users/{user}/repos&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>listReposOptional</span>(<span style=color:#a6e22e>@Path</span>(<span style=color:#e6db74>&#34;user&#34;</span>) user: String?): Call&lt;Optional&lt;List&lt;Repo&gt;&gt;&gt;
</span></span></code></pre></div><p>就会抛出异常：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>com.google.gson.JsonSyntaxException: java.lang.IllegalStateException: Expected BEGIN_OBJECT but was BEGIN_ARRAY at line 1 column 2 path $
</span></span><span style=display:flex><span>        at com.google.gson.internal.bind.ReflectiveTypeAdapterFactory$Adapter.read(ReflectiveTypeAdapterFactory.java:226)
</span></span><span style=display:flex><span>        at retrofit2.converter.gson.GsonResponseBodyConverter.convert(GsonResponseBodyConverter.java:40)
</span></span><span style=display:flex><span>        at retrofit2.converter.gson.GsonResponseBodyConverter.convert(GsonResponseBodyConverter.java:27)
</span></span><span style=display:flex><span>        at retrofit2.OkHttpCall.parseResponse(OkHttpCall.java:243)
</span></span><span style=display:flex><span>        at retrofit2.OkHttpCall$1.onResponse(OkHttpCall.java:153)
</span></span></code></pre></div><p>很明显这是来自 gson 的错误，根据前面的分析，如果在 Retrofit.Builder 过程添加了 GsonConverterFactory，responseBodyConverter() 方法中会直接返回一个 GsonResponseBodyConverter 对象，在解释返回结果的时候会拿 <code>Optional&lt;List&lt;Repo>></code> 去接收 JSON 数组，导致解析出错。</p><p>如果要使这个流程走得通，就需要将第 4 行和第 6 行代码进行交换。（本人亲自验证可行）</p><p>可能这是 Retrofit 的一个 bug，如果有其他不同的理解，欢迎讨论。</p><h3 id=return>return
<a class=anchor href=#return>#</a></h3><p>从以上分析可知，parseAnnotations() 方法最终会返回 HttpServiceMethod 实例，而 HttpServiceMethod 类又三个子类，parseAnnotations() 方法的最后会根据不同的条件来返回不同的子类实例。</p><p>如果我们的请求方法不是 Kotlin 挂起函数，返回的是 CallAdapted 对象。</p><h4 id=calladapted>CallAdapted
<a class=anchor href=#calladapted>#</a></h4><p>此时 loadServiceMethod() 返回的对象为 CallAdapted：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CallAdapted</span><span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>,</span> ReturnT<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>extends</span> HttpServiceMethod<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>,</span> ReturnT<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> CallAdapter<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>,</span> ReturnT<span style=color:#f92672>&gt;</span> callAdapter<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  CallAdapted<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>      RequestFactory requestFactory<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      okhttp3<span style=color:#f92672>.</span><span style=color:#a6e22e>Call</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span> callFactory<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      Converter<span style=color:#f92672>&lt;</span>ResponseBody<span style=color:#f92672>,</span> ResponseT<span style=color:#f92672>&gt;</span> responseConverter<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      CallAdapter<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>,</span> ReturnT<span style=color:#f92672>&gt;</span> callAdapter<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>requestFactory<span style=color:#f92672>,</span> callFactory<span style=color:#f92672>,</span> responseConverter<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>callAdapter</span> <span style=color:#f92672>=</span> callAdapter<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>protected</span> ReturnT <span style=color:#a6e22e>adapt</span><span style=color:#f92672>(</span>Call<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>&gt;</span> call<span style=color:#f92672>,</span> Object<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> callAdapter<span style=color:#f92672>.</span><span style=color:#a6e22e>adapt</span><span style=color:#f92672>(</span>call<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=suspendforresponse>SuspendForResponse
<a class=anchor href=#suspendforresponse>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SuspendForResponse</span><span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>extends</span> HttpServiceMethod<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> CallAdapter<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>,</span> Call<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>&gt;&gt;</span> callAdapter<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  SuspendForResponse<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>      RequestFactory requestFactory<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      okhttp3<span style=color:#f92672>.</span><span style=color:#a6e22e>Call</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span> callFactory<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      Converter<span style=color:#f92672>&lt;</span>ResponseBody<span style=color:#f92672>,</span> ResponseT<span style=color:#f92672>&gt;</span> responseConverter<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      CallAdapter<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>,</span> Call<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>&gt;&gt;</span> callAdapter<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>requestFactory<span style=color:#f92672>,</span> callFactory<span style=color:#f92672>,</span> responseConverter<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>callAdapter</span> <span style=color:#f92672>=</span> callAdapter<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>protected</span> Object <span style=color:#a6e22e>adapt</span><span style=color:#f92672>(</span>Call<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>&gt;</span> call<span style=color:#f92672>,</span> Object<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    call <span style=color:#f92672>=</span> callAdapter<span style=color:#f92672>.</span><span style=color:#a6e22e>adapt</span><span style=color:#f92672>(</span>call<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//noinspection unchecked Checked by reflection inside RequestFactory.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Continuation<span style=color:#f92672>&lt;</span>Response<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>&gt;&gt;</span> continuation <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>(</span>Continuation<span style=color:#f92672>&lt;</span>Response<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>&gt;&gt;)</span> args<span style=color:#f92672>[</span>args<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> 1<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// See SuspendForBody for explanation about this try/catch.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> KotlinExtensions<span style=color:#f92672>.</span><span style=color:#a6e22e>awaitResponse</span><span style=color:#f92672>(</span>call<span style=color:#f92672>,</span> continuation<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> KotlinExtensions<span style=color:#f92672>.</span><span style=color:#a6e22e>suspendAndThrow</span><span style=color:#f92672>(</span>e<span style=color:#f92672>,</span> continuation<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=suspendforbody>SuspendForBody
<a class=anchor href=#suspendforbody>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SuspendForBody</span><span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>extends</span> HttpServiceMethod<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> CallAdapter<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>,</span> Call<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>&gt;&gt;</span> callAdapter<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> isNullable<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  SuspendForBody<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>      RequestFactory requestFactory<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      okhttp3<span style=color:#f92672>.</span><span style=color:#a6e22e>Call</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span> callFactory<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      Converter<span style=color:#f92672>&lt;</span>ResponseBody<span style=color:#f92672>,</span> ResponseT<span style=color:#f92672>&gt;</span> responseConverter<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      CallAdapter<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>,</span> Call<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>&gt;&gt;</span> callAdapter<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>boolean</span> isNullable<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>requestFactory<span style=color:#f92672>,</span> callFactory<span style=color:#f92672>,</span> responseConverter<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>callAdapter</span> <span style=color:#f92672>=</span> callAdapter<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isNullable</span> <span style=color:#f92672>=</span> isNullable<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>protected</span> Object <span style=color:#a6e22e>adapt</span><span style=color:#f92672>(</span>Call<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>&gt;</span> call<span style=color:#f92672>,</span> Object<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    call <span style=color:#f92672>=</span> callAdapter<span style=color:#f92672>.</span><span style=color:#a6e22e>adapt</span><span style=color:#f92672>(</span>call<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//noinspection unchecked Checked by reflection inside RequestFactory.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Continuation<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>&gt;</span> continuation <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>Continuation<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>&gt;)</span> args<span style=color:#f92672>[</span>args<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> 1<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Calls to OkHttp Call.enqueue() like those inside await and awaitNullable can sometimes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// invoke the supplied callback with an exception before the invoking stack frame can return.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Coroutines will intercept the subsequent invocation of the Continuation and throw the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// exception synchronously. A Java Proxy cannot throw checked exceptions without them being
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// declared on the interface method. To avoid the synchronous checked exception being wrapped
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// in an UndeclaredThrowableException, it is intercepted and supplied to a helper which will
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// force suspension to occur so that it can be instead delivered to the continuation to
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// bypass this restriction.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> isNullable
</span></span><span style=display:flex><span>          <span style=color:#f92672>?</span> KotlinExtensions<span style=color:#f92672>.</span><span style=color:#a6e22e>awaitNullable</span><span style=color:#f92672>(</span>call<span style=color:#f92672>,</span> continuation<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>:</span> KotlinExtensions<span style=color:#f92672>.</span><span style=color:#a6e22e>await</span><span style=color:#f92672>(</span>call<span style=color:#f92672>,</span> continuation<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> KotlinExtensions<span style=color:#f92672>.</span><span style=color:#a6e22e>suspendAndThrow</span><span style=color:#f92672>(</span>e<span style=color:#f92672>,</span> continuation<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=httpservicemethodinvokeobject-args>HttpServiceMethod.invoke(Object[] args)
<a class=anchor href=#httpservicemethodinvokeobject-args>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#a6e22e>@Nullable</span> ReturnT <span style=color:#a6e22e>invoke</span><span style=color:#f92672>(</span>Object<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  Call<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>&gt;</span> call <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> OkHttpCall<span style=color:#f92672>&lt;&gt;(</span>requestFactory<span style=color:#f92672>,</span> args<span style=color:#f92672>,</span> callFactory<span style=color:#f92672>,</span> responseConverter<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> adapt<span style=color:#f92672>(</span>call<span style=color:#f92672>,</span> args<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>abstract</span> <span style=color:#a6e22e>@Nullable</span> ReturnT <span style=color:#a6e22e>adapt</span><span style=color:#f92672>(</span>Call<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>&gt;</span> call<span style=color:#f92672>,</span> Object<span style=color:#f92672>[]</span> args<span style=color:#f92672>);</span>
</span></span></code></pre></div><h3 id=new-okhttpcall>new OkHttpCall&lt;>()
<a class=anchor href=#new-okhttpcall>#</a></h3><p>OkHttpCall 的创建：<code>new OkHttpCall&lt;>(requestFactory, args, callFactory, responseConverter)</code></p><p>OkHttpCall 是 retrofit2.Call 的子类。这行代码负责将 ServiceMethod 解读到的信息（主要是一个 RequestFactory 、一个 CallFactory 和一个 ResponseConverter）封装进 OkHttpCall；而这个对象可以在需要的时候（例如它的 enqueue() 方法被调用的时候）， 利用 RequestFactory 和 CallFactory 来创建一个 okhttp3.Call 对象，并调用这个 okhttp3.Call 对象来进行网络请求的发起，然后利用 ResponseConverter 对结果进行预处理之后，交回给 Retrofit 的 Callback 。</p><h3 id=httpservicemethodadapt>HttpServiceMethod.adapt()
<a class=anchor href=#httpservicemethodadapt>#</a></h3><p>调用 adapt() 方法：<code>adapt(call, args)</code></p><p>创建 OkHttpCall 对象后，会调用 abstract 方法 <code>adapt(Call&lt;ResponseT> call, Object[] args)</code> 将 OkHttpCall 对象和请求参数传入。</p><p>根据前面的分析，HttpServiceMethod 有三个子类并且都是 HttpServiceMethod 的内部类，分别是</p><p>CallAdapted、SuspendForResponse 和 SuspendForBody。</p><h4 id=calladaptedadapt>CallAdapted.adapt
<a class=anchor href=#calladaptedadapt>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>protected</span> ReturnT <span style=color:#a6e22e>adapt</span><span style=color:#f92672>(</span>Call<span style=color:#f92672>&lt;</span>ResponseT<span style=color:#f92672>&gt;</span> call<span style=color:#f92672>,</span> Object<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> callAdapter<span style=color:#f92672>.</span><span style=color:#a6e22e>adapt</span><span style=color:#f92672>(</span>call<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到，这里是直接调用了 callAdapter 的 adapt 方法，这个 callAdapter 就是前面 loadServiceMethod() 流程中通过 createCallAdapter() 方法获取到的 CallAdapter 对象。</p><p>因此，根据前面的分析可知，此时的 CallAdapter 会根据请求方法的类型来使相应的实现类。</p><h5 id=defaultcalladapterfactory-中的匿名-calladapter>DefaultCallAdapterFactory 中的匿名 CallAdapter
<a class=anchor href=#defaultcalladapterfactory-%e4%b8%ad%e7%9a%84%e5%8c%bf%e5%90%8d-calladapter>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>new</span> CallAdapter<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>,</span> Call<span style=color:#f92672>&lt;?&gt;&gt;()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> Type <span style=color:#a6e22e>responseType</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> responseType<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> Call<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>adapt</span><span style=color:#f92672>(</span>Call<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> call<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> executor <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> call <span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> ExecutorCallbackCall<span style=color:#f92672>&lt;&gt;(</span>executor<span style=color:#f92672>,</span> call<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到，adapt 方法返回的是 ExecutorCallbackCall 对象。</p><h5 id=rxjava3calladapterfactoryrxjava3calladapter>RxJava3CallAdapterFactory.RxJava3CallAdapter
<a class=anchor href=#rxjava3calladapterfactoryrxjava3calladapter>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>adapt</span><span style=color:#f92672>(</span>Call<span style=color:#f92672>&lt;</span>R<span style=color:#f92672>&gt;</span> call<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  Observable<span style=color:#f92672>&lt;</span>Response<span style=color:#f92672>&lt;</span>R<span style=color:#f92672>&gt;&gt;</span> responseObservable <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      isAsync <span style=color:#f92672>?</span> <span style=color:#66d9ef>new</span> CallEnqueueObservable<span style=color:#f92672>&lt;&gt;(</span>call<span style=color:#f92672>)</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> CallExecuteObservable<span style=color:#f92672>&lt;&gt;(</span>call<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Observable<span style=color:#f92672>&lt;?&gt;</span> observable<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isResult<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    observable <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ResultObservable<span style=color:#f92672>&lt;&gt;(</span>responseObservable<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isBody<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    observable <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> BodyObservable<span style=color:#f92672>&lt;&gt;(</span>responseObservable<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    observable <span style=color:#f92672>=</span> responseObservable<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>scheduler <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    observable <span style=color:#f92672>=</span> observable<span style=color:#f92672>.</span><span style=color:#a6e22e>subscribeOn</span><span style=color:#f92672>(</span>scheduler<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isFlowable<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// We only ever deliver a single value, and the RS spec states that you MUST request at least
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// one element which means we never need to honor backpressure.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> observable<span style=color:#f92672>.</span><span style=color:#a6e22e>toFlowable</span><span style=color:#f92672>(</span>BackpressureStrategy<span style=color:#f92672>.</span><span style=color:#a6e22e>MISSING</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isSingle<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> observable<span style=color:#f92672>.</span><span style=color:#a6e22e>singleOrError</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isMaybe<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> observable<span style=color:#f92672>.</span><span style=color:#a6e22e>singleElement</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isCompletable<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> observable<span style=color:#f92672>.</span><span style=color:#a6e22e>ignoreElements</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> RxJavaPlugins<span style=color:#f92672>.</span><span style=color:#a6e22e>onAssembly</span><span style=color:#f92672>(</span>observable<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h5 id=completablefuturecalladapterfactoryresponsecalladapter>CompletableFutureCallAdapterFactory.ResponseCallAdapter
<a class=anchor href=#completablefuturecalladapterfactoryresponsecalladapter>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> CompletableFuture<span style=color:#f92672>&lt;</span>R<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>adapt</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> Call<span style=color:#f92672>&lt;</span>R<span style=color:#f92672>&gt;</span> call<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  CompletableFuture<span style=color:#f92672>&lt;</span>R<span style=color:#f92672>&gt;</span> future <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CallCancelCompletableFuture<span style=color:#f92672>&lt;&gt;(</span>call<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  call<span style=color:#f92672>.</span><span style=color:#a6e22e>enqueue</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> BodyCallback<span style=color:#f92672>(</span>future<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> future<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h5 id=小结-2>小结
<a class=anchor href=#%e5%b0%8f%e7%bb%93-2>#</a></h5><p>对于例子中 GithubService 中的请求方法：</p><ol><li><code>fun listRepos(@Path("user") user: String?): Call&lt;List&lt;Repo>></code></li></ol><p>返回 DefaultCallAdapterFactory.ExecutorCallbackCall 实例</p><ol start=2><li><code>fun listReposRx(@Path("user") user: String?): Observable&lt;List&lt;Repo>></code></li></ol><p>异步方式返回 CallEnqueueObservable 实例，同步方式返回 CallExecuteObservable 实例</p><ol start=3><li><code>fun listReposCompletable(@Path("user") user: String?): CompletableFuture&lt;List&lt;Repo>></code></li></ol><p>返回 CompletableFutureCallAdapterFactory.CallCancelCompletableFuture 实例</p><p>因此，CallAdatper 的作用就是把 OkHttpCall 根据请求方法的返回值包装成一个新的对象，并且返回给调用者。</p><h4 id=suspendforresponseadapt>SuspendForResponse.adapt
<a class=anchor href=#suspendforresponseadapt>#</a></h4><h4 id=suspendforbodyadapt>SuspendForBody.adapt
<a class=anchor href=#suspendforbodyadapt>#</a></h4><h2 id=callenqueue>Call.enqueue()
<a class=anchor href=#callenqueue>#</a></h2><p>根据前面的分析，在 Android 平台上，对于返回 Call 类型的请求方法被调用时，会被一个匿名 CallAdapter 在 adapt 方法中包装成 ExecutorCallbackCall 并返回给调用者。不用多说也应该知道，这个类继承自 Call 接口。那么它是怎么实现请求的呢？</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ExecutorCallbackCall</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>implements</span> Call<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> Executor callbackExecutor<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> Call<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> delegate<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ExecutorCallbackCall<span style=color:#f92672>(</span>Executor callbackExecutor<span style=color:#f92672>,</span> Call<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> delegate<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>callbackExecutor</span> <span style=color:#f92672>=</span> callbackExecutor<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>delegate</span> <span style=color:#f92672>=</span> delegate<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>enqueue</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> Callback<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> callback<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Objects<span style=color:#f92672>.</span><span style=color:#a6e22e>requireNonNull</span><span style=color:#f92672>(</span>callback<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;callback == null&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    delegate<span style=color:#f92672>.</span><span style=color:#a6e22e>enqueue</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> Callback<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onResponse</span><span style=color:#f92672>(</span>Call<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> call<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> Response<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> response<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            callbackExecutor<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>delegate<span style=color:#f92672>.</span><span style=color:#a6e22e>isCanceled</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// Emulate OkHttp&#39;s behavior of throwing/delivering an IOException on
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>// cancellation.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    callback<span style=color:#f92672>.</span><span style=color:#a6e22e>onFailure</span><span style=color:#f92672>(</span>ExecutorCallbackCall<span style=color:#f92672>.</span><span style=color:#a6e22e>this</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> IOException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Canceled&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>                  <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    callback<span style=color:#f92672>.</span><span style=color:#a6e22e>onResponse</span><span style=color:#f92672>(</span>ExecutorCallbackCall<span style=color:#f92672>.</span><span style=color:#a6e22e>this</span><span style=color:#f92672>,</span> response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onFailure</span><span style=color:#f92672>(</span>Call<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> call<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> Throwable t<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            callbackExecutor<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> callback<span style=color:#f92672>.</span><span style=color:#a6e22e>onFailure</span><span style=color:#f92672>(</span>ExecutorCallbackCall<span style=color:#f92672>.</span><span style=color:#a6e22e>this</span><span style=color:#f92672>,</span> t<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isExecuted</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> delegate<span style=color:#f92672>.</span><span style=color:#a6e22e>isExecuted</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> Response<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>execute</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> delegate<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>cancel</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    delegate<span style=color:#f92672>.</span><span style=color:#a6e22e>cancel</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isCanceled</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> delegate<span style=color:#f92672>.</span><span style=color:#a6e22e>isCanceled</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;CloneDoesntCallSuperClone&#34;</span><span style=color:#f92672>)</span> <span style=color:#75715e>// Performing deep clone.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> Call<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>clone</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ExecutorCallbackCall<span style=color:#f92672>&lt;&gt;(</span>callbackExecutor<span style=color:#f92672>,</span> delegate<span style=color:#f92672>.</span><span style=color:#a6e22e>clone</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> Request <span style=color:#a6e22e>request</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> delegate<span style=color:#f92672>.</span><span style=color:#a6e22e>request</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> Timeout <span style=color:#a6e22e>timeout</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> delegate<span style=color:#f92672>.</span><span style=color:#a6e22e>timeout</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到，这是一个典型的代理模式的实现，ExecutorCallbackCall 的全部实现都交给了 delegate 对象，而这个 delegate 正是 HttpServiceMethod.invoke() 流程中生成的 OkHttpCall 对象。</p><p>在 enqueue() 方法中，首先会调用 OkHttpCall.enqueue() 方法获取请求结果，然后在 CallBack 回调中在 callbackExecutor.execute() 中将回调结果再次回调给 callback。</p><p>这里 callbackExecutor 就是 Platform.Android.MainThreadExecutor，因此外层获取的回调实在主线程中的，不用再切换线程。</p><p>那么再看 OkHttpCall.enqueue() 是如何工作的：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>enqueue</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> Callback<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> callback<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  Objects<span style=color:#f92672>.</span><span style=color:#a6e22e>requireNonNull</span><span style=color:#f92672>(</span>callback<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;callback == null&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  okhttp3<span style=color:#f92672>.</span><span style=color:#a6e22e>Call</span> call<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  Throwable failure<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>executed<span style=color:#f92672>)</span> <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Already executed.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    executed <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    call <span style=color:#f92672>=</span> rawCall<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    failure <span style=color:#f92672>=</span> creationFailure<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>call <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> failure <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        call <span style=color:#f92672>=</span> rawCall <span style=color:#f92672>=</span> createRawCall<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Throwable t<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        throwIfFatal<span style=color:#f92672>(</span>t<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        failure <span style=color:#f92672>=</span> creationFailure <span style=color:#f92672>=</span> t<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>failure <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    callback<span style=color:#f92672>.</span><span style=color:#a6e22e>onFailure</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> failure<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>canceled<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    call<span style=color:#f92672>.</span><span style=color:#a6e22e>cancel</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  call<span style=color:#f92672>.</span><span style=color:#a6e22e>enqueue</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>new</span> okhttp3<span style=color:#f92672>.</span><span style=color:#a6e22e>Callback</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onResponse</span><span style=color:#f92672>(</span>okhttp3<span style=color:#f92672>.</span><span style=color:#a6e22e>Call</span> call<span style=color:#f92672>,</span> okhttp3<span style=color:#f92672>.</span><span style=color:#a6e22e>Response</span> rawResponse<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          Response<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> response<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 解析结果
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            response <span style=color:#f92672>=</span> parseResponse<span style=color:#f92672>(</span>rawResponse<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Throwable e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            throwIfFatal<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            callFailure<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            callback<span style=color:#f92672>.</span><span style=color:#a6e22e>onResponse</span><span style=color:#f92672>(</span>OkHttpCall<span style=color:#f92672>.</span><span style=color:#a6e22e>this</span><span style=color:#f92672>,</span> response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Throwable t<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            throwIfFatal<span style=color:#f92672>(</span>t<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            t<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span> <span style=color:#75715e>// TODO this is not great
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onFailure</span><span style=color:#f92672>(</span>okhttp3<span style=color:#f92672>.</span><span style=color:#a6e22e>Call</span> call<span style=color:#f92672>,</span> IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          callFailure<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>callFailure</span><span style=color:#f92672>(</span>Throwable e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            callback<span style=color:#f92672>.</span><span style=color:#a6e22e>onFailure</span><span style=color:#f92672>(</span>OkHttpCall<span style=color:#f92672>.</span><span style=color:#a6e22e>this</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Throwable t<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            throwIfFatal<span style=color:#f92672>(</span>t<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            t<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span> <span style=color:#75715e>// TODO this is not great
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Response<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>parseResponse</span><span style=color:#f92672>(</span>okhttp3<span style=color:#f92672>.</span><span style=color:#a6e22e>Response</span> rawResponse<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  ResponseBody rawBody <span style=color:#f92672>=</span> rawResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Remove the body&#39;s source (the only stateful object) so we can pass the response along.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  rawResponse <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      rawResponse
</span></span><span style=display:flex><span>          <span style=color:#f92672>.</span><span style=color:#a6e22e>newBuilder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> NoContentResponseBody<span style=color:#f92672>(</span>rawBody<span style=color:#f92672>.</span><span style=color:#a6e22e>contentType</span><span style=color:#f92672>(),</span> rawBody<span style=color:#f92672>.</span><span style=color:#a6e22e>contentLength</span><span style=color:#f92672>()))</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> code <span style=color:#f92672>=</span> rawResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>code</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>code <span style=color:#f92672>&lt;</span> 200 <span style=color:#f92672>||</span> code <span style=color:#f92672>&gt;=</span> 300<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Buffer the entire body to avoid future I/O.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      ResponseBody bufferedBody <span style=color:#f92672>=</span> Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>buffer</span><span style=color:#f92672>(</span>rawBody<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> Response<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span>bufferedBody<span style=color:#f92672>,</span> rawResponse<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      rawBody<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>code <span style=color:#f92672>==</span> 204 <span style=color:#f92672>||</span> code <span style=color:#f92672>==</span> 205<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    rawBody<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> Response<span style=color:#f92672>.</span><span style=color:#a6e22e>success</span><span style=color:#f92672>(</span><span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> rawResponse<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ExceptionCatchingResponseBody catchingBody <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ExceptionCatchingResponseBody<span style=color:#f92672>(</span>rawBody<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 使用 responseConverter 完成转换
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    T body <span style=color:#f92672>=</span> responseConverter<span style=color:#f92672>.</span><span style=color:#a6e22e>convert</span><span style=color:#f92672>(</span>catchingBody<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> Response<span style=color:#f92672>.</span><span style=color:#a6e22e>success</span><span style=color:#f92672>(</span>body<span style=color:#f92672>,</span> rawResponse<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>RuntimeException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// If the underlying source threw an exception, propagate that rather than indicating it was
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// a runtime exception.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    catchingBody<span style=color:#f92672>.</span><span style=color:#a6e22e>throwIfCaught</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到，这里是依赖 OkHttp3 来实现网络请求的。获取到请求结果后，第 40 行将会调用 parseResponse() 方法将结果解析出来。parseResponse() 方法第 100 行将会调用 responseConverter 进行转换。</p><p>这一整个过程可以一下时序图直观展示：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Retrofit/clipboard_20230323_035658.png width=auto alt></p><h2 id=observablesubscribe>Observable.subscribe()
<a class=anchor href=#observablesubscribe>#</a></h2><p>对于返回 Observable 的请求方法，我们知道经过 RxJava3CallAdapter.adapt 方法的包装，最终返回的是 CallEnqueueObservable 或者 CallExecuteObservable。以前者为例，来看看具体的实现方式。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CallEnqueueObservable</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>extends</span> Observable<span style=color:#f92672>&lt;</span>Response<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Call<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> originalCall<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  CallEnqueueObservable<span style=color:#f92672>(</span>Call<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> originalCall<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>originalCall</span> <span style=color:#f92672>=</span> originalCall<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>subscribeActual</span><span style=color:#f92672>(</span>Observer<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>super</span> Response<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;&gt;</span> observer<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Since Call is a one-shot type, clone it for each new observer.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Call<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> call <span style=color:#f92672>=</span> originalCall<span style=color:#f92672>.</span><span style=color:#a6e22e>clone</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    CallCallback<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> callback <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CallCallback<span style=color:#f92672>&lt;&gt;(</span>call<span style=color:#f92672>,</span> observer<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    observer<span style=color:#f92672>.</span><span style=color:#a6e22e>onSubscribe</span><span style=color:#f92672>(</span>callback<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>callback<span style=color:#f92672>.</span><span style=color:#a6e22e>isDisposed</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      call<span style=color:#f92672>.</span><span style=color:#a6e22e>enqueue</span><span style=color:#f92672>(</span>callback<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CallCallback</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>implements</span> Disposable<span style=color:#f92672>,</span> Callback<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Call<span style=color:#f92672>&lt;?&gt;</span> call<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Observer<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>super</span> Response<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;&gt;</span> observer<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>volatile</span> <span style=color:#66d9ef>boolean</span> disposed<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> terminated <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    CallCallback<span style=color:#f92672>(</span>Call<span style=color:#f92672>&lt;?&gt;</span> call<span style=color:#f92672>,</span> Observer<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>super</span> Response<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;&gt;</span> observer<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>call</span> <span style=color:#f92672>=</span> call<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>observer</span> <span style=color:#f92672>=</span> observer<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onResponse</span><span style=color:#f92672>(</span>Call<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> call<span style=color:#f92672>,</span> Response<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> response<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>disposed<span style=color:#f92672>)</span> <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        observer<span style=color:#f92672>.</span><span style=color:#a6e22e>onNext</span><span style=color:#f92672>(</span>response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>disposed<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          terminated <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>          observer<span style=color:#f92672>.</span><span style=color:#a6e22e>onComplete</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Throwable t<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Exceptions<span style=color:#f92672>.</span><span style=color:#a6e22e>throwIfFatal</span><span style=color:#f92672>(</span>t<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>terminated<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          RxJavaPlugins<span style=color:#f92672>.</span><span style=color:#a6e22e>onError</span><span style=color:#f92672>(</span>t<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>disposed<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            observer<span style=color:#f92672>.</span><span style=color:#a6e22e>onError</span><span style=color:#f92672>(</span>t<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Throwable inner<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Exceptions<span style=color:#f92672>.</span><span style=color:#a6e22e>throwIfFatal</span><span style=color:#f92672>(</span>inner<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            RxJavaPlugins<span style=color:#f92672>.</span><span style=color:#a6e22e>onError</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> CompositeException<span style=color:#f92672>(</span>t<span style=color:#f92672>,</span> inner<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onFailure</span><span style=color:#f92672>(</span>Call<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> call<span style=color:#f92672>,</span> Throwable t<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>call<span style=color:#f92672>.</span><span style=color:#a6e22e>isCanceled</span><span style=color:#f92672>())</span> <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        observer<span style=color:#f92672>.</span><span style=color:#a6e22e>onError</span><span style=color:#f92672>(</span>t<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Throwable inner<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Exceptions<span style=color:#f92672>.</span><span style=color:#a6e22e>throwIfFatal</span><span style=color:#f92672>(</span>inner<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        RxJavaPlugins<span style=color:#f92672>.</span><span style=color:#a6e22e>onError</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> CompositeException<span style=color:#f92672>(</span>t<span style=color:#f92672>,</span> inner<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>dispose</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      disposed <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      call<span style=color:#f92672>.</span><span style=color:#a6e22e>cancel</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isDisposed</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> disposed<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>在 subscribeActual() 方法中，同样调用的是 OkHttpCall.enqueue() 方法实现请求，并且在 CallCallback 回调中把请求结果通过 onNext(response) 发射给下游的 Observer。</p><p>这个过程的时序图如下：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Retrofit/clipboard_20230323_035702.png width=auto alt></p><h1 id=总结>总结
<a class=anchor href=#%e6%80%bb%e7%bb%93>#</a></h1><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/Retrofit/clipboard_20230323_035708.png width=auto alt></p><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://guanpj.github.io/amethyst/quartz/js/graph.cbd78cfa87df7d3e230d16fc24f06548.js></script></div></div><div id=contact_buttons><footer><p>Made with <a href=https://github.com/64bitpandas/amethyst>Amethyst</a>, © 2023 guanpj</p><ul><li><a href=https://guanpj.github.io/amethyst/>Home</a></li><li><a href=https://bencuan.me>Website</a></li><li><a href=https://blog.bencuan.me>Blog</a></li></ul></footer></div></article><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#使用>使用</a></li><li><a href=#解析>解析</a><ul><li><a href=#retrofitbuilder>Retrofit.Builder</a></li><li><a href=#retrofitcreate>Retrofit.create</a></li><li><a href=#loadservicemethodmethod>loadServiceMethod(method)</a><ul><li><a href=#createcalladapter>createCallAdapter</a><ul><li><a href=#defaultcalladapterfactoryget>DefaultCallAdapterFactory.get()</a></li><li><a href=#rxjava3calladapterfactoryget>RxJava3CallAdapterFactory.get()</a></li><li><a href=#completablefuturecalladapterfactoryget>CompletableFutureCallAdapterFactory.get()</a></li><li><a href=#小结>小结</a></li></ul></li><li><a href=#createresponseconverter>createResponseConverter</a><ul><li><a href=#builtinconvertersresponsebodyconverter>BuiltInConverters.responseBodyConverter()</a></li><li><a href=#gsonconverterfactory-responsebodyconverter>GsonConverterFactory. responseBodyConverter()</a></li><li><a href=#optionalconverterfactoryresponsebodyconverter>OptionalConverterFactory.responseBodyConverter()</a></li><li><a href=#小结-1>小结</a></li></ul></li><li><a href=#return>return</a><ul><li><a href=#calladapted>CallAdapted</a></li><li><a href=#suspendforresponse>SuspendForResponse</a></li><li><a href=#suspendforbody>SuspendForBody</a></li></ul></li></ul></li><li><a href=#httpservicemethodinvokeobject-args>HttpServiceMethod.invoke(Object[] args)</a><ul><li><a href=#new-okhttpcall>new OkHttpCall&lt;>()</a></li><li><a href=#httpservicemethodadapt>HttpServiceMethod.adapt()</a><ul><li><a href=#calladaptedadapt>CallAdapted.adapt</a><ul><li><a href=#defaultcalladapterfactory-中的匿名-calladapter>DefaultCallAdapterFactory 中的匿名 CallAdapter</a></li><li><a href=#rxjava3calladapterfactoryrxjava3calladapter>RxJava3CallAdapterFactory.RxJava3CallAdapter</a></li><li><a href=#completablefuturecalladapterfactoryresponsecalladapter>CompletableFutureCallAdapterFactory.ResponseCallAdapter</a></li><li><a href=#小结-2>小结</a></li></ul></li><li><a href=#suspendforresponseadapt>SuspendForResponse.adapt</a></li><li><a href=#suspendforbodyadapt>SuspendForBody.adapt</a></li></ul></li></ul></li><li><a href=#callenqueue>Call.enqueue()</a></li><li><a href=#observablesubscribe>Observable.subscribe()</a></li></ul></li><li><a href=#总结>总结</a></li></ul></nav></div></aside></main></body></html>