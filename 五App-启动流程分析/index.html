<!doctype html><html lang=en dir=ltr><head><meta property="og:title" content="五、App 启动流程分析"><meta property="og:description" content="在我的上一篇文章 Android 系统启动流程分析中，我们分析了系统在开机以后的一系列行为，其中最后一阶段 AMS(ActivityManagerService) 会启动 Launcher 来展示我们手机中所有已安装的应用图标，点击图标后相应的应用程序将会被系统启动运行并展示在我们面前，那么，点击了图标之后系统道理做了哪些工作呢？应用进程是怎么被启动的呢？Activity 的生命周期是什么时候被谁调用的呢？本文将继续基于 Android Nougat 的 frameworks 层源码的解答这些问题。
阅读建议：
如果你是首次阅读这个过程的源码，建议你忽略一些细枝末节的代码，先抓主干代码，从整体上理解代码的执行流程（右下角文章目录视图中可以点击跳转到相应章节），否则将会被细节的代码扰乱思路。最后可以回头多看几遍，这时候如果有需要可以追踪一些枝干代码，做到融会贯通。
1. Launcher —— AMS #  1.1 调用过程分析 #  1.1.1 Launcher.onClick #  在 Launcher app 的主 Activity —— Launcher.java 中，App 图标的点击事件最终会回调 Launcher.java 中的 onClick 方法，
[packages/apps/Launcher3/src/com/android/launcher3/Launcher.java]( https://android.googlesource.com/platform/packages/apps/Launcher3/ /nougat-release/src/com/android/launcher3/Launcher.java?autodive=0/)：
public void onClick(View v) {  ...  Object tag = v.getTag();  if (tag instanceof ShortcutInfo) {  // 从快捷方式图标启动  onClickAppShortcut(v);  } else if (tag instanceof FolderInfo) {  // 文件夹  if (v instanceof FolderIcon) {  onClickFolderIcon(v);  }  } else if (v == mAllAppsButton) {  // “所有应用”按钮  onClickAllAppsButton(v);  } else if (tag instanceof AppInfo) {  // 从“所有应用”中启动的应用  startAppShortcutOrInfoActivity(v);  } else if (tag instanceof LauncherAppWidgetInfo) {  // 组件  if (v instanceof PendingAppWidgetHostView) {  onClickPendingWidget((PendingAppWidgetHostView) v);  }  } } 1."><meta property="og:type" content="article"><meta property="og:url" content="https://guanpj.github.io/amethyst/%E4%BA%94App-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/"><meta property="article:section" content><meta property="og:site_name" content="guanpj's blog"><title>五、App 启动流程分析 | guanpj's blog</title><link rel=manifest href=/amethyst/manifest.json><link rel=icon href=/amethyst/favicon.png type=image/x-icon><link rel=stylesheet href=/amethyst/book.min.c27ff4755c78daab11627953d5a6dd7e2698690e086398032995aae74d6397b6.css integrity="sha256-wn/0dVx42qsRYnlT1abdfiaYaQ4IY5gDKZWq501jl7Y=" crossorigin=anonymous><meta charset=utf-8><meta name=description content="在我的上一篇文章 Android 系统启动流程分析中，我们分析了系统在开机以后的一系列行为，其中最后一阶段 AMS(ActivityManagerService) 会启动 Launcher 来展示我们手机中所有已安装的应用图标，点击图标后相应的应用程序将会被系统启动运行并展示在我们面前，那么，点击了图标之后系统道理做了哪些工作呢？应用进程是怎么被启动的呢？Activity 的生命周期是什么时候被谁调用的呢？本文将继续基于 Android Nougat 的 frameworks 层源码的解答这些问题。
阅读建议：
如果你是首次阅读这个过程的源码，建议你忽略一些细枝末节的代码，先抓主干代码，从整体上理解代码的执行流程（右下角文章目录视图中可以点击跳转到相应章节），否则将会被细节的代码扰乱思路。最后可以回头多看几遍，这时候如果有需要可以追踪一些枝干代码，做到融会贯通。
1. Launcher —— AMS #  1.1 调用过程分析 #  1.1.1 Launcher.onClick #  在 Launcher app 的主 Activity —— Launcher.java 中，App 图标的点击事件最终会回调 Launcher.java 中的 onClick 方法，
[packages/apps/Launcher3/src/com/android/launcher3/Launcher.java]( https://android.googlesource.com/platform/packages/apps/Launcher3/ /nougat-release/src/com/android/launcher3/Launcher.java?autodive=0/)：
public void onClick(View v) {  ...  Object tag = v.getTag();  if (tag instanceof ShortcutInfo) {  // 从快捷方式图标启动  onClickAppShortcut(v);  } else if (tag instanceof FolderInfo) {  // 文件夹  if (v instanceof FolderIcon) {  onClickFolderIcon(v);  }  } else if (v == mAllAppsButton) {  // “所有应用”按钮  onClickAllAppsButton(v);  } else if (tag instanceof AppInfo) {  // 从“所有应用”中启动的应用  startAppShortcutOrInfoActivity(v);  } else if (tag instanceof LauncherAppWidgetInfo) {  // 组件  if (v instanceof PendingAppWidgetHostView) {  onClickPendingWidget((PendingAppWidgetHostView) v);  }  } } 1."><title>五、App 启动流程分析</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://guanpj.github.io/amethyst//favicon.png><link href=https://guanpj.github.io/amethyst/styles.e08ceb33360cec132feb69cfb982e2a4.min.css rel=stylesheet><link href=https://guanpj.github.io/amethyst/quartz/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://guanpj.github.io/amethyst/quartz/js/darkmode.1bc498b60ed24d8858f74f99e480db82.min.js></script>
<script src=https://guanpj.github.io/amethyst/quartz/js/util.c69e233dc1cc331a30b0f670e657b425.min.js></script>
<script async src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script async src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://guanpj.github.io/amethyst/quartz/js/popover.f03552ccb84d99ca615d1cfb9abde59e.min.js></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://guanpj.github.io/amethyst/",fetchData=Promise.all([fetch("https://guanpj.github.io/amethyst/indices/linkIndex.a0cf85a144674d956ca9db3dfb7745ab.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://guanpj.github.io/amethyst/indices/contentIndex.6e36d79b0a0d4a81007275dd2fa73365.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addCollapsibleCallouts(),initPopover("https://guanpj.github.io/amethyst",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!0;drawGraph("https://guanpj.github.io/amethyst",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script>window.Million={navigate:e=>window.location.href=e,prefetch:()=>{}},window.addEventListener("DOMContentLoaded",()=>{init(),render()})</script></head><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><header class=book-header><label for=menu-control><img src=/amethyst/svg/menu.svg class=book-icon alt=Menu></label><h1 id=page-title><a href=https://guanpj.github.io/amethyst/>guanpj's blog</a></h1><div class=spacer></div><div id=search-icon class=quartz-search><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control><main class=flex><aside class=book-menu><div class=book-menu-content><nav><div class=menu-search><div id=search-icon class=quartz-search><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div></div><ul><li><a href=/amethyst/2023-03-15/>2023 03 15</a></li><li><a href=/amethyst/2023-03-18/>2023 03 18</a></li><li><a href=/amethyst/2023-03-19/>2023 03 19</a></li><li><a href=/amethyst/2023-03-20/>2023 03 20</a></li><li><a href=/amethyst/Buttons/>Buttons</a></li><li><a href=/amethyst/ControlPanel/>Control Panel</a></li><li><a href=/amethyst/Linter/>Linter</a></li><li><a href=/amethyst/MyDraw/>My Draw</a></li><li><a href=/amethyst/%E5%85%B6%E4%BB%96%E6%A8%A1%E7%89%88/>其他模版</a></li><li><a href=/amethyst/%E5%A7%94%E6%89%98/>委托</a></li><li><a href=/amethyst/%E5%BC%95%E7%94%A8/>引用</a></li><li><a href=/amethyst/%E6%89%A9%E5%B1%95%E5%87%BD%E6%95%B0/>扩展函数</a></li><li><a href=/amethyst/%E6%8C%87%E9%92%88/>指针</a></li><li><a href=/amethyst/%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%96%87%E6%9C%AC%E6%9B%BF%E6%8D%A2/>文件读取、文本替换</a></li><li><a href=/amethyst/%E7%B1%BB%E7%9A%84%E5%AE%9A%E4%B9%89%E4%BD%BF%E7%94%A8/>类的定义、使用</a></li><li><a href=/amethyst/%E9%81%8D%E5%8E%86%E6%96%87%E4%BB%B6%E9%87%8D%E5%91%BD%E5%90%8D/>遍历文件、重命名</a></li><li><a href=/amethyst/About-Atlas/>About Atlas</a></li><li><a href=/amethyst/ADB-%E5%91%BD%E4%BB%A4/>ADB 命令</a></li><li><a href=/amethyst/Java-%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/>ADB 命令</a></li><li><a href=/amethyst/Android-%E5%AF%B9%E5%AE%B9%E5%99%A8%E7%B1%BB%E7%9A%84%E4%BC%98%E5%8C%96/>Android 对容器类的优化</a></li><li><a href=/amethyst/CAS-%E5%92%8C-AQS-%E5%8E%9F%E7%90%86/>CAS 和 AQS 原理</a></li><li><a href=/amethyst/EventBus-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>EventBus 使用及源码解析</a></li><li><a href=/amethyst/Glide-%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E5%92%8C%E7%BC%93%E5%AD%98%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/>Glide 加载流程和缓存原理分析</a></li><li><a href=/amethyst/Glide-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/>Glide 基本使用</a></li><li><a href=/amethyst/Glide-%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95/>Glide 高级用法</a></li><li><a href=/amethyst/HashMap-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>HashMap 源码解析</a></li><li><a href=/amethyst/HTTP-%E5%9F%BA%E7%A1%80/>HTTP 基础</a></li><li><a href=/amethyst/Index-for-Atlases/>Index for Atlases</a></li><li><a href=/amethyst/Index-for-Extras/>Index for Extras</a></li><li><a href=/amethyst/Java-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/>Java 内存模型</a></li><li><a href=/amethyst/JVM-%E4%B8%AD%E7%9A%84%E5%AF%B9%E8%B1%A1%E5%92%8C%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/>JVM 中的对象和垃圾回收</a></li><li><a href=/amethyst/JVM-%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F/>JVM 内存区域</a></li><li><a href=/amethyst/JVM-%E5%AD%97%E8%8A%82%E7%A0%81%E6%8C%87%E4%BB%A4%E7%AE%80%E4%BB%8B/>JVM 字节码指令简介</a></li><li><a href=/amethyst/JVM-%E5%AD%97%E8%8A%82%E7%A0%81%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/>JVM 字节码结构分析</a></li><li><a href=/amethyst/JVM-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/>JVM 类加载机制</a></li><li><a href=/amethyst/LeakCanary-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>LeakCanary 使用及源码解析</a></li><li><a href=/amethyst/MyIdeas/>MyIdeas</a></li><li><a href=/amethyst/OkHttp-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>OkHttp 使用及源码分析</a></li><li><a href=/amethyst/Retrofit-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>Retrofit 使用及源码分析</a></li><li><a href=/amethyst/RxJava-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>RxJava 使用及源码分析</a></li><li><a href=/amethyst/2023-03-22/>Troubleshooting and FAQ</a></li><li><a href=/amethyst/%E4%B8%80Binder-%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90%E6%A6%82%E5%BF%B5%E7%AF%87/>一、Binder 机制分析——概念篇</a></li><li><a href=/amethyst/%E4%B8%83View-%E4%BA%8B%E4%BB%B6%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/>七、View 事件机制分析</a></li><li><a href=/amethyst/%E4%B8%89Handler-%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/>三、Handler 原理分析</a></li><li><a href=/amethyst/%E4%BA%8CBinder-%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90%E5%BA%94%E7%94%A8%E7%AF%87/>二、Binder 机制分析——应用篇</a></li><li><a href=/amethyst/%E4%BA%8C%E5%8F%89%E6%A0%91%E9%81%8D%E5%8E%86/>二叉树遍历</a></li><li><a href=/amethyst/%E4%BA%94App-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/ class=active>五、App 启动流程分析</a></li><li><a href=/amethyst/%E5%85%ADView-%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/>六、View 绘制流程分析</a></li><li><a href=/amethyst/%E5%9B%9B%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/>四、系统启动流程分析</a></li><li><a href=/amethyst/%E5%AE%B9%E5%99%A8%E7%B1%BB/>容器类</a></li><li><a href=/amethyst/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/>并发容器</a></li><li><a href=/amethyst/%E6%B3%9B%E5%9E%8B/>泛型</a></li><li><a href=/amethyst/%E6%B3%A8%E8%A7%A3%E5%92%8C%E5%8F%8D%E5%B0%84/>注解和反射</a></li><li><a href=/amethyst/%E7%AD%89%E5%BE%85-%E9%80%9A%E7%9F%A5%E6%9C%BA%E5%88%B6/>等待-通知机制</a></li><li><a href=/amethyst/%E7%BA%BF%E7%A8%8B%E5%8D%8F%E4%BD%9C/>线程协作</a></li><li><a href=/amethyst/%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80/>线程基础</a></li><li><a href=/amethyst/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%92%8C-BlockingQueue/>线程池和 BlockingQueue</a></li><li><a href=/amethyst/%E7%BC%96%E7%A0%81%E5%8A%A0%E5%AF%86Hash%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%AD%97%E7%AC%A6%E9%9B%86/>编码、加密、Hash、序列化和字符集</a></li><li><a href=/amethyst/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84TCPIP-%E5%92%8C-HTTPS/>计算机网络体系结构、TCP&IP 和 HTTPS</a></li><li><a href=/amethyst/%E9%94%81/>锁</a></li></ul><ul><li><a href=https://github.com/64bitpandas/amethyst target=_blank rel=noopener>Github</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class="book-page container"><article class=markdown><h1 class=title>五、App 启动流程分析</h1><p>在我的上一篇文章
<a href=https://guanpj.cn/2017/09/17/Android-System-Startup-Flow-Analyze/ rel=noopener>Android 系统启动流程分析</a>中，我们分析了系统在开机以后的一系列行为，其中最后一阶段 AMS(ActivityManagerService) 会启动 Launcher 来展示我们手机中所有已安装的应用图标，点击图标后相应的应用程序将会被系统启动运行并展示在我们面前，那么，点击了图标之后系统道理做了哪些工作呢？应用进程是怎么被启动的呢？Activity 的生命周期是什么时候被谁调用的呢？本文将继续基于 Android Nougat 的 frameworks 层源码的解答这些问题。</p><p><strong>阅读建议：</strong></p><p>如果你是首次阅读这个过程的源码，建议你忽略一些细枝末节的代码，先抓主干代码，从整体上理解代码的执行流程（右下角文章目录视图中可以点击跳转到相应章节），否则将会被细节的代码扰乱思路。最后可以回头多看几遍，这时候如果有需要可以追踪一些枝干代码，做到融会贯通。</p><h1 id=1-launcher--ams>1. Launcher —— AMS
<a class=anchor href=#1-launcher--ams>#</a></h1><h2 id=11-调用过程分析>1.1 调用过程分析
<a class=anchor href=#11-%e8%b0%83%e7%94%a8%e8%bf%87%e7%a8%8b%e5%88%86%e6%9e%90>#</a></h2><h3 id=111-launcheronclick>1.1.1 Launcher.onClick
<a class=anchor href=#111-launcheronclick>#</a></h3><p>在 Launcher app 的主 Activity —— Launcher.java 中，App 图标的点击事件最终会回调 Launcher.java 中的 onClick 方法，</p><p>[packages/apps/Launcher3/src/com/android/launcher3/Launcher.java](
<a href=https://android.googlesource.com/platform/packages/apps/Launcher3/ rel=noopener>https://android.googlesource.com/platform/packages/apps/Launcher3/</a> /nougat-release/src/com/android/launcher3/Launcher.java?autodive=0/)：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onClick</span><span style=color:#f92672>(</span>View v<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    Object tag <span style=color:#f92672>=</span> v<span style=color:#f92672>.</span><span style=color:#a6e22e>getTag</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>tag <span style=color:#66d9ef>instanceof</span> ShortcutInfo<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 从快捷方式图标启动
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        onClickAppShortcut<span style=color:#f92672>(</span>v<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>tag <span style=color:#66d9ef>instanceof</span> FolderInfo<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 文件夹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>v <span style=color:#66d9ef>instanceof</span> FolderIcon<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>           onClickFolderIcon<span style=color:#f92672>(</span>v<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>v <span style=color:#f92672>==</span> mAllAppsButton<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// “所有应用”按钮
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        onClickAllAppsButton<span style=color:#f92672>(</span>v<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>tag <span style=color:#66d9ef>instanceof</span> AppInfo<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 从“所有应用”中启动的应用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        startAppShortcutOrInfoActivity<span style=color:#f92672>(</span>v<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>tag <span style=color:#66d9ef>instanceof</span> LauncherAppWidgetInfo<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 组件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>v <span style=color:#66d9ef>instanceof</span> PendingAppWidgetHostView<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            onClickPendingWidget<span style=color:#f92672>((</span>PendingAppWidgetHostView<span style=color:#f92672>)</span> v<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=112-launcheronclickappshortcut>1.1.2 Launcher.onClickAppShortcut
<a class=anchor href=#112-launcheronclickappshortcut>#</a></h3><p>如果是快捷方式图标，则调用 onClickAppShortcut 方法进而调用 startAppShortcutOrInfoActivity 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Thunk</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>startAppShortcutOrInfoActivity</span><span style=color:#f92672>(</span>View v<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Object tag <span style=color:#f92672>=</span> v<span style=color:#f92672>.</span><span style=color:#a6e22e>getTag</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> ShortcutInfo shortcut<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> Intent intent<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>tag <span style=color:#66d9ef>instanceof</span> ShortcutInfo<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        shortcut <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>ShortcutInfo<span style=color:#f92672>)</span> tag<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 去除对应的 Intent 对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        intent <span style=color:#f92672>=</span> shortcut<span style=color:#f92672>.</span><span style=color:#a6e22e>intent</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span><span style=color:#f92672>[]</span> pos <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>int</span><span style=color:#f92672>[</span>2<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>        v<span style=color:#f92672>.</span><span style=color:#a6e22e>getLocationOnScreen</span><span style=color:#f92672>(</span>pos<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        intent<span style=color:#f92672>.</span><span style=color:#a6e22e>setSourceBounds</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Rect<span style=color:#f92672>(</span>pos<span style=color:#f92672>[</span>0<span style=color:#f92672>],</span> pos<span style=color:#f92672>[</span>1<span style=color:#f92672>],</span>
</span></span><span style=display:flex><span>                pos<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span> <span style=color:#f92672>+</span> v<span style=color:#f92672>.</span><span style=color:#a6e22e>getWidth</span><span style=color:#f92672>(),</span> pos<span style=color:#f92672>[</span>1<span style=color:#f92672>]</span> <span style=color:#f92672>+</span> v<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeight</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>tag <span style=color:#66d9ef>instanceof</span> AppInfo<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        shortcut <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        intent <span style=color:#f92672>=</span> <span style=color:#f92672>((</span>AppInfo<span style=color:#f92672>)</span> tag<span style=color:#f92672>).</span><span style=color:#a6e22e>intent</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Input must be a Shortcut or AppInfo&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 调用 startActivitySafely 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>boolean</span> success <span style=color:#f92672>=</span> startActivitySafely<span style=color:#f92672>(</span>v<span style=color:#f92672>,</span> intent<span style=color:#f92672>,</span> tag<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    mStats<span style=color:#f92672>.</span><span style=color:#a6e22e>recordLaunch</span><span style=color:#f92672>(</span>v<span style=color:#f92672>,</span> intent<span style=color:#f92672>,</span> shortcut<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>success <span style=color:#f92672>&amp;&amp;</span> v <span style=color:#66d9ef>instanceof</span> BubbleTextView<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        mWaitingForResume <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>BubbleTextView<span style=color:#f92672>)</span> v<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        mWaitingForResume<span style=color:#f92672>.</span><span style=color:#a6e22e>setStayPressed</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=113-launcherstartactivity>1.1.3 Launcher.startActivity
<a class=anchor href=#113-launcherstartactivity>#</a></h3><p>获取相应 App 的 Intent 信息之后，调用 startActivity 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>startActivity</span><span style=color:#f92672>(</span>View v<span style=color:#f92672>,</span> Intent intent<span style=color:#f92672>,</span> Object tag<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 启动新的任务栈
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    intent<span style=color:#f92672>.</span><span style=color:#a6e22e>addFlags</span><span style=color:#f92672>(</span>Intent<span style=color:#f92672>.</span><span style=color:#a6e22e>FLAG_ACTIVITY_NEW_TASK</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>user <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> user<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>UserHandleCompat<span style=color:#f92672>.</span><span style=color:#a6e22e>myUserHandle</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            StrictMode<span style=color:#f92672>.</span><span style=color:#a6e22e>VmPolicy</span> oldPolicy <span style=color:#f92672>=</span> StrictMode<span style=color:#f92672>.</span><span style=color:#a6e22e>getVmPolicy</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>            
</span></span><span style=display:flex><span>                StrictMode<span style=color:#f92672>.</span><span style=color:#a6e22e>setVmPolicy</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> StrictMode<span style=color:#f92672>.</span><span style=color:#a6e22e>VmPolicy</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Builder</span><span style=color:#f92672>().</span><span style=color:#a6e22e>detectAll</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>.</span><span style=color:#a6e22e>penaltyLog</span><span style=color:#f92672>().</span><span style=color:#a6e22e>build</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 调用 Activity 的 startActivity 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                startActivity<span style=color:#f92672>(</span>intent<span style=color:#f92672>,</span> optsBundle<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                StrictMode<span style=color:#f92672>.</span><span style=color:#a6e22e>setVmPolicy</span><span style=color:#f92672>(</span>oldPolicy<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            launcherApps<span style=color:#f92672>.</span><span style=color:#a6e22e>startActivityForProfile</span><span style=color:#f92672>(</span>intent<span style=color:#f92672>.</span><span style=color:#a6e22e>getComponent</span><span style=color:#f92672>(),</span> user<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                    intent<span style=color:#f92672>.</span><span style=color:#a6e22e>getSourceBounds</span><span style=color:#f92672>(),</span> optsBundle<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>SecurityException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>      
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=114-activitystartactivity>1.1.4 Activity.startActivity
<a class=anchor href=#114-activitystartactivity>#</a></h3><p>这里最终调用了 Activity 中的 startActivity 方法，并且设置 Flag 为 FLAG_ACTIVITY_NEW_TASK。到此为止，已经跟启动普通的 Activity 流程汇合起来了，继续往下分析。</p><p>[frameworks/base/core/java/android/app/Activity.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/android/app/Activity.java)：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>startActivity</span><span style=color:#f92672>(</span>Intent intent<span style=color:#f92672>,</span> <span style=color:#a6e22e>@Nullable</span> Bundle options<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 第二个参数为 -1 表示不需要回调 onActivityResult 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>options <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        startActivityForResult<span style=color:#f92672>(</span>intent<span style=color:#f92672>,</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>,</span> options<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Note we want to go through this call for compatibility with
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// applications that may have overridden the method.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        startActivityForResult<span style=color:#f92672>(</span>intent<span style=color:#f92672>,</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=115-activitystartactivityforresult>1.1.5 Activity.startActivityForResult
<a class=anchor href=#115-activitystartactivityforresult>#</a></h3><p>调用 Activity 的 startActivityForResult 方法</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>startActivityForResult</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequiresPermission</span> Intent intent<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> requestCode<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>           <span style=color:#a6e22e>@Nullable</span> Bundle options<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// mParent 是当前 Activity 的父类，此时条件成立
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mParent <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 调用 Instrumentation 的 execStartActivity 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Instrumentation<span style=color:#f92672>.</span><span style=color:#a6e22e>ActivityResult</span> ar <span style=color:#f92672>=</span> mInstrumentation<span style=color:#f92672>.</span><span style=color:#a6e22e>execStartActivity</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>               mMainThread<span style=color:#f92672>.</span><span style=color:#a6e22e>getApplicationThread</span><span style=color:#f92672>(),</span> mToken<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> intent<span style=color:#f92672>,</span> requestCode<span style=color:#f92672>,</span> options<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=116-instrumentationexecstartactivity>1.1.6 Instrumentation.execStartActivity
<a class=anchor href=#116-instrumentationexecstartactivity>#</a></h3><p>[frameworks/base/core/java/android/app/Instrumentation.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/android/app/Instrumentation.java)：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> ActivityResult <span style=color:#a6e22e>execStartActivity</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        Context who<span style=color:#f92672>,</span> IBinder contextThread<span style=color:#f92672>,</span> IBinder token<span style=color:#f92672>,</span> Activity target<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        Intent intent<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> requestCode<span style=color:#f92672>,</span> Bundle options<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        intent<span style=color:#f92672>.</span><span style=color:#a6e22e>migrateExtraStreamToClipData</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        intent<span style=color:#f92672>.</span><span style=color:#a6e22e>prepareToLeaveProcess</span><span style=color:#f92672>(</span>who<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 获取 AMS 的代理对象并调用其 startActivity 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>int</span> result <span style=color:#f92672>=</span> ActivityManagerNative<span style=color:#f92672>.</span><span style=color:#a6e22e>getDefault</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>.</span><span style=color:#a6e22e>startActivity</span><span style=color:#f92672>(</span>whoThread<span style=color:#f92672>,</span> who<span style=color:#f92672>.</span><span style=color:#a6e22e>getBasePackageName</span><span style=color:#f92672>(),</span> intent<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                    intent<span style=color:#f92672>.</span><span style=color:#a6e22e>resolveTypeIfNeeded</span><span style=color:#f92672>(</span>who<span style=color:#f92672>.</span><span style=color:#a6e22e>getContentResolver</span><span style=color:#f92672>()),</span>
</span></span><span style=display:flex><span>                    token<span style=color:#f92672>,</span> target <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> target<span style=color:#f92672>.</span><span style=color:#a6e22e>mEmbeddedID</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                    requestCode<span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> options<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        checkStartActivityResult<span style=color:#f92672>(</span>result<span style=color:#f92672>,</span> intent<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>RemoteException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Failure from system&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=117-activitymanagerproxystartactivity>1.1.7 ActivityManagerProxy.startActivity
<a class=anchor href=#117-activitymanagerproxystartactivity>#</a></h3><p>以上过程是在 Launcher App 所在的进程中发生的，在我的另外一篇文章
<a href=https://guanpj.cn/2017/08/13/Android-Binder-Apply/ rel=noopener>借助 AIDL 理解 Android Binder 机制——AIDL 的使用和原理分析</a>中我们分析了 AIDL 的实现过程，由于远程 Service 跟使用 Service 的 Activity 不在同一个进程中，因此他们之间交互需要通过 Binder IPC 机制的支持，在这个过程中 Client 首先获取到 Server 端的代理对象，在 Client 看来 Server 代理对象同样具有 Server 本地对象承诺的能力，因此 Client 可以调用 Server 代理对象跟 Sever 本地对象进行数据交互，Binder 驱动作为桥梁在他们中间起到中间人的作用。</p><p>同样，在
<a href=https://guanpj.cn/2017/09/17/Android-System-Startup-Flow-Analyze/ rel=noopener>Android 系统启动流程分析</a>中我们了解到，AMS 是运行在 system_server 线程中的，这时 AMS 就相当于 AIDL 中的远程 Service，App 进程要与 AMS 交互，需要通过 AMS 的代理对象 AMP(ActivityManagerProxy) 来完成，来看 ActivityManagerNative.getDefault() 拿到的是什么：
[frameworks/base/core/java/android/app/ActivityManagerNative.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/android/app/ActivityManagerNative.java)：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>public</span> IActivityManager <span style=color:#a6e22e>getDefault</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> gDefault<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>getDefault 是一个静态变量：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Singleton<span style=color:#f92672>&lt;</span>IActivityManager<span style=color:#f92672>&gt;</span> gDefault <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Singleton<span style=color:#f92672>&lt;</span>IActivityManager<span style=color:#f92672>&gt;()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> IActivityManager <span style=color:#a6e22e>create</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 向 ServiceManager 查询一个 key 为 &#34;activity&#34; 的引用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        IBinder b <span style=color:#f92672>=</span> ServiceManager<span style=color:#f92672>.</span><span style=color:#a6e22e>getService</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;activity&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Log<span style=color:#f92672>.</span><span style=color:#a6e22e>v</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ActivityManager&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;default service binder = &#34;</span> <span style=color:#f92672>+</span> b<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        IActivityManager am <span style=color:#f92672>=</span> asInterface<span style=color:#f92672>(</span>b<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Log<span style=color:#f92672>.</span><span style=color:#a6e22e>v</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ActivityManager&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;default service = &#34;</span> <span style=color:#f92672>+</span> am<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> am<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>};</span>
</span></span></code></pre></div><p>同样，在文章
<a href=https://guanpj.cn/2017/08/10/Android-Binder-Principle-Analyze/ rel=noopener>借助 AIDL 理解 Android Binder 机制——Binder 来龙去脉</a>中也讲到过：</p><blockquote><p>ServiceManager 是 Binder IPC 通信过程的核心，是上下文的管理者，Binder 服务端必须先向 ServerManager 注册才能够为客户端提供服务，Binder 客户端在与服务端通信之前需要从 ServerManager 中查找并获取 Binder 服务端的引用。</p></blockquote><p>这里通过 &ldquo;activity&rdquo; 这个名字向 ServiceManager 查询 AMS 的引用，获取 AMS 的引用后，调用 asInterface 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>public</span> IActivityManager <span style=color:#a6e22e>asInterface</span><span style=color:#f92672>(</span>IBinder obj<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>obj <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 根据 descriptor 查询 obj 是否为 Binder 本地对象，具体过程请看前文中提到的文章
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    IActivityManager in <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>IActivityManager<span style=color:#f92672>)</span>obj<span style=color:#f92672>.</span><span style=color:#a6e22e>queryLocalInterface</span><span style=color:#f92672>(</span>descriptor<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>in <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> in<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果 obj 不是 Binder 本地对象，则将其包装成代理对象并返回
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ActivityManagerProxy<span style=color:#f92672>(</span>obj<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>因为 AMS 与 Launcher App 不在同一个进程中，这里返回的 IBinder 对象是一个 Binder 代理对象，因此这类将其包装成 AMP(ActivityManagerProxy) 对象并返回，AMP 是 AMN(ActivityManagerNative) 的内部类，查看 AMP 类 ：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ActivityManagerProxy</span> <span style=color:#66d9ef>implements</span> IActivityManager
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>ActivityManagerProxy</span><span style=color:#f92672>(</span>IBinder remote<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        mRemote <span style=color:#f92672>=</span> remote<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> IBinder <span style=color:#a6e22e>asBinder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> mRemote<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>startActivity</span><span style=color:#f92672>(</span>IApplicationThread caller<span style=color:#f92672>,</span> String callingPackage<span style=color:#f92672>,</span> Intent intent<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            String resolvedType<span style=color:#f92672>,</span> IBinder resultTo<span style=color:#f92672>,</span> String resultWho<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> requestCode<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> startFlags<span style=color:#f92672>,</span> ProfilerInfo profilerInfo<span style=color:#f92672>,</span> Bundle options<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> RemoteException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 调用号为 START_ACTIVITY_TRANSACTION
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        mRemote<span style=color:#f92672>.</span><span style=color:#a6e22e>transact</span><span style=color:#f92672>(</span>START_ACTIVITY_TRANSACTION<span style=color:#f92672>,</span> data<span style=color:#f92672>,</span> reply<span style=color:#f92672>,</span> 0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        reply<span style=color:#f92672>.</span><span style=color:#a6e22e>readException</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> result <span style=color:#f92672>=</span> reply<span style=color:#f92672>.</span><span style=color:#a6e22e>readInt</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        reply<span style=color:#f92672>.</span><span style=color:#a6e22e>recycle</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        data<span style=color:#f92672>.</span><span style=color:#a6e22e>recycle</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> ComponentName <span style=color:#a6e22e>startService</span><span style=color:#f92672>(</span>IApplicationThread caller<span style=color:#f92672>,</span> Intent service<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            String resolvedType<span style=color:#f92672>,</span> String callingPackage<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> userId<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> RemoteException
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        mRemote<span style=color:#f92672>.</span><span style=color:#a6e22e>transact</span><span style=color:#f92672>(</span>START_SERVICE_TRANSACTION<span style=color:#f92672>,</span> data<span style=color:#f92672>,</span> reply<span style=color:#f92672>,</span> 0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        reply<span style=color:#f92672>.</span><span style=color:#a6e22e>readException</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        ComponentName res <span style=color:#f92672>=</span> ComponentName<span style=color:#f92672>.</span><span style=color:#a6e22e>readFromParcel</span><span style=color:#f92672>(</span>reply<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        data<span style=color:#f92672>.</span><span style=color:#a6e22e>recycle</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        reply<span style=color:#f92672>.</span><span style=color:#a6e22e>recycle</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> res<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到，AMP 里面将客户端的请求通过 mRemote.transact 进行转发，mRemote 对象正是 Binder 驱动返回来的 Binder Proxy 对象，通过 Binder Proxy，Binder 驱动最终将调用处于 Binder Server 端 AMN 中的 onTransact 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>onTransact</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> code<span style=color:#f92672>,</span> Parcel data<span style=color:#f92672>,</span> Parcel reply<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> flags<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> RemoteException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 根据方法调用号 code 决定调用哪个方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>code<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> START_ACTIVITY_TRANSACTION<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 调用 startActivity 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>int</span> result <span style=color:#f92672>=</span> startActivity<span style=color:#f92672>(</span>app<span style=color:#f92672>,</span> callingPackage<span style=color:#f92672>,</span> intent<span style=color:#f92672>,</span> resolvedType<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                resultTo<span style=color:#f92672>,</span> resultWho<span style=color:#f92672>,</span> requestCode<span style=color:#f92672>,</span> startFlags<span style=color:#f92672>,</span> profilerInfo<span style=color:#f92672>,</span> options<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        reply<span style=color:#f92672>.</span><span style=color:#a6e22e>writeNoException</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        reply<span style=color:#f92672>.</span><span style=color:#a6e22e>writeInt</span><span style=color:#f92672>(</span>result<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> START_SERVICE_TRANSACTION<span style=color:#f92672>:</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        ComponentName cn <span style=color:#f92672>=</span> startService<span style=color:#f92672>(</span>app<span style=color:#f92672>,</span> service<span style=color:#f92672>,</span> resolvedType<span style=color:#f92672>,</span> callingPackage<span style=color:#f92672>,</span> userId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            reply<span style=color:#f92672>.</span><span style=color:#a6e22e>writeNoException</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            ComponentName<span style=color:#f92672>.</span><span style=color:#a6e22e>writeToParcel</span><span style=color:#f92672>(</span>cn<span style=color:#f92672>,</span> reply<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>AMN 是一个抽象类，它的 startActivity 为抽象方法，具体的实现在 ActivityManagerService.java 中。</p><h3 id=118-activitymanagerservicestartactivity>1.1.8 ActivityManagerService.startActivity
<a class=anchor href=#118-activitymanagerservicestartactivity>#</a></h3><p>[frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/services/core/java/com/android/server/am/ActivityManagerService.java)：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ActivityManagerService</span> <span style=color:#66d9ef>extends</span> ActivityManagerNative
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>implements</span> Watchdog<span style=color:#f92672>.</span><span style=color:#a6e22e>Monitor</span><span style=color:#f92672>,</span> BatteryStatsImpl<span style=color:#f92672>.</span><span style=color:#a6e22e>BatteryCallback</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>startActivity</span><span style=color:#f92672>(</span>IApplicationThread caller<span style=color:#f92672>,</span> String callingPackage<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                   Intent intent<span style=color:#f92672>,</span> String resolvedType<span style=color:#f92672>,</span> IBinder resultTo<span style=color:#f92672>,</span> String resultWho<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> requestCode<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                   <span style=color:#66d9ef>int</span> startFlags<span style=color:#f92672>,</span> ProfilerInfo profilerInfo<span style=color:#f92672>,</span> Bundle bOptions<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> startActivityAsUser<span style=color:#f92672>(</span>caller<span style=color:#f92672>,</span> callingPackage<span style=color:#f92672>,</span> intent<span style=color:#f92672>,</span> resolvedType<span style=color:#f92672>,</span> resultTo<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                resultWho<span style=color:#f92672>,</span> requestCode<span style=color:#f92672>,</span> startFlags<span style=color:#f92672>,</span> profilerInfo<span style=color:#f92672>,</span> bOptions<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                UserHandle<span style=color:#f92672>.</span><span style=color:#a6e22e>getCallingUserId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=12-小结>1.2 小结
<a class=anchor href=#12-%e5%b0%8f%e7%bb%93>#</a></h2><p>从 Launcher App 到 AMS 的调用过程中使用了 Binder IPC 机制，如果你已经看了上面提到的我之前写的两篇文章——
<a href=https://guanpj.cn/2017/08/10/Android-Binder-Principle-Analyze/ rel=noopener>借助 AIDL 理解 Android Binder 机制——Binder 来龙去脉</a>和
<a href=https://guanpj.cn/2017/08/13/Android-Binder-Apply/ rel=noopener>借助 AIDL 理解 Android Binder 机制——AIDL 的使用和原理分析</a>，并且运行了文章中使用到的
<a href=https://github.com/guanpj/BinderDemo rel=noopener>Demo</a>，你应该可以发现，相对于 AIDL 的调用过程，调用方 Launcher App 相当于 AIDL 过程中的 Activity 所在的 App，充当 Clinent 的角色；AMS 相当于远程 Service 的角色，充当 Server 端角色，他们的调用过程总体上都是一样的。</p><p>从 Launcher App 到 AMS 的时序图如下：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/App-Startup/clipboard_20230323_045438.png width=auto alt></p><h1 id=2-ams--zygote>2. AMS —— zygote
<a class=anchor href=#2-ams--zygote>#</a></h1><h2 id=21-调用过程分析>2.1 调用过程分析
<a class=anchor href=#21-%e8%b0%83%e7%94%a8%e8%bf%87%e7%a8%8b%e5%88%86%e6%9e%90>#</a></h2><h3 id=211-activitymanagerservicestartactivityasuser>2.1.1 ActivityManagerService.startActivityAsUser
<a class=anchor href=#211-activitymanagerservicestartactivityasuser>#</a></h3><p>接着从 AMS 的 startActivityAsUser 方法开始分析：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>startActivityAsUser</span><span style=color:#f92672>(</span>IApplicationThread caller<span style=color:#f92672>,</span> String callingPackage<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        Intent intent<span style=color:#f92672>,</span> String resolvedType<span style=color:#f92672>,</span> IBinder resultTo<span style=color:#f92672>,</span> String resultWho<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> requestCode<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> startFlags<span style=color:#f92672>,</span> ProfilerInfo profilerInfo<span style=color:#f92672>,</span> Bundle bOptions<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> userId<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    enforceNotIsolatedCaller<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;startActivity&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    userId <span style=color:#f92672>=</span> mUserController<span style=color:#f92672>.</span><span style=color:#a6e22e>handleIncomingUser</span><span style=color:#f92672>(</span>Binder<span style=color:#f92672>.</span><span style=color:#a6e22e>getCallingPid</span><span style=color:#f92672>(),</span> Binder<span style=color:#f92672>.</span><span style=color:#a6e22e>getCallingUid</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>                userId<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>,</span> ALLOW_FULL_ONLY<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;startActivity&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// TODO: Switch to user app stacks here.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 调用 ActivityStarter 的 startActivityMayWait 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> mActivityStarter<span style=color:#f92672>.</span><span style=color:#a6e22e>startActivityMayWait</span><span style=color:#f92672>(</span>caller<span style=color:#f92672>,</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>,</span> callingPackage<span style=color:#f92672>,</span> intent<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            resolvedType<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> resultTo<span style=color:#f92672>,</span> resultWho<span style=color:#f92672>,</span> requestCode<span style=color:#f92672>,</span> startFlags<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            profilerInfo<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> bOptions<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>,</span> userId<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=212-activitystarterstartactivitymaywait>2.1.2 ActivityStarter.startActivityMayWait
<a class=anchor href=#212-activitystarterstartactivitymaywait>#</a></h3><p>继续跟进 [frameworks/base/services/core/java/com/android/server/am/ActivityStarter.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/services/core/java/com/android/server/am/ActivityStarter.java)：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>startActivityMayWait</span><span style=color:#f92672>(</span>IApplicationThread caller<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> callingUid<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        String callingPackage<span style=color:#f92672>,</span> Intent intent<span style=color:#f92672>,</span> String resolvedType<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        IVoiceInteractionSession voiceSession<span style=color:#f92672>,</span> IVoiceInteractor voiceInteractor<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        IBinder resultTo<span style=color:#f92672>,</span> String resultWho<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> requestCode<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> startFlags<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        ProfilerInfo profilerInfo<span style=color:#f92672>,</span> IActivityManager<span style=color:#f92672>.</span><span style=color:#a6e22e>WaitResult</span> outResult<span style=color:#f92672>,</span> Configuration config<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        Bundle bOptions<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> ignoreTargetSecurity<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> userId<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        IActivityContainer iContainer<span style=color:#f92672>,</span> TaskRecord inTask<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span>mService<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 调用 startActivityLocked 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>int</span> res <span style=color:#f92672>=</span> startActivityLocked<span style=color:#f92672>(</span>caller<span style=color:#f92672>,</span> intent<span style=color:#f92672>,</span> ephemeralIntent<span style=color:#f92672>,</span> resolvedType<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                aInfo<span style=color:#f92672>,</span> rInfo<span style=color:#f92672>,</span> voiceSession<span style=color:#f92672>,</span> voiceInteractor<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                resultTo<span style=color:#f92672>,</span> resultWho<span style=color:#f92672>,</span> requestCode<span style=color:#f92672>,</span> callingPid<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                callingUid<span style=color:#f92672>,</span> callingPackage<span style=color:#f92672>,</span> realCallingPid<span style=color:#f92672>,</span> realCallingUid<span style=color:#f92672>,</span> startFlags<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                options<span style=color:#f92672>,</span> ignoreTargetSecurity<span style=color:#f92672>,</span> componentSpecified<span style=color:#f92672>,</span> outRecord<span style=color:#f92672>,</span> container<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                inTask<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> res<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=213-activitystarterstartactivitylocked>2.1.3 ActivityStarter.startActivityLocked
<a class=anchor href=#213-activitystarterstartactivitylocked>#</a></h3><p>查看 startActivityLocked 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>startActivityLocked</span><span style=color:#f92672>(</span>IApplicationThread caller<span style=color:#f92672>,</span> Intent intent<span style=color:#f92672>,</span> Intent ephemeralIntent<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        String resolvedType<span style=color:#f92672>,</span> ActivityInfo aInfo<span style=color:#f92672>,</span> ResolveInfo rInfo<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        IVoiceInteractionSession voiceSession<span style=color:#f92672>,</span> IVoiceInteractor voiceInteractor<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        IBinder resultTo<span style=color:#f92672>,</span> String resultWho<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> requestCode<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> callingPid<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> callingUid<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        String callingPackage<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> realCallingPid<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> realCallingUid<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> startFlags<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        ActivityOptions options<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> ignoreTargetSecurity<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> componentSpecified<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        ActivityRecord<span style=color:#f92672>[]</span> outActivity<span style=color:#f92672>,</span> ActivityStackSupervisor<span style=color:#f92672>.</span><span style=color:#a6e22e>ActivityContainer</span> container<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        TaskRecord inTask<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 调用 doPendingActivityLaunchesLocked 方法，传入 false 参数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    doPendingActivityLaunchesLocked<span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> err<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=214-activitystarterdopendingactivitylauncheslocked>2.1.4 ActivityStarter.doPendingActivityLaunchesLocked
<a class=anchor href=#214-activitystarterdopendingactivitylauncheslocked>#</a></h3><p>查看 doPendingActivityLaunchesLocked 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>doPendingActivityLaunchesLocked</span><span style=color:#f92672>(</span><span style=color:#66d9ef>boolean</span> doResume<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#f92672>(!</span>mPendingActivityLaunches<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> PendingActivityLaunch pal <span style=color:#f92672>=</span> mPendingActivityLaunches<span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>(</span>0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> resume <span style=color:#f92672>=</span> doResume <span style=color:#f92672>&amp;&amp;</span> mPendingActivityLaunches<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 调用 startActivityUnchecked 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> result <span style=color:#f92672>=</span> startActivityUnchecked<span style=color:#f92672>(</span>pal<span style=color:#f92672>.</span><span style=color:#a6e22e>r</span><span style=color:#f92672>,</span> pal<span style=color:#f92672>.</span><span style=color:#a6e22e>sourceRecord</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                pal<span style=color:#f92672>.</span><span style=color:#a6e22e>startFlags</span><span style=color:#f92672>,</span> resume<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            postStartActivityUncheckedProcessing<span style=color:#f92672>(</span>pal<span style=color:#f92672>.</span><span style=color:#a6e22e>r</span><span style=color:#f92672>,</span> result<span style=color:#f92672>,</span> mSupervisor<span style=color:#f92672>.</span><span style=color:#a6e22e>mFocusedStack</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mStackId</span><span style=color:#f92672>,</span> 
</span></span><span style=display:flex><span>                mSourceRecord<span style=color:#f92672>,</span> mTargetStack<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Slog<span style=color:#f92672>.</span><span style=color:#a6e22e>e</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Exception during pending activity launch pal=&#34;</span> <span style=color:#f92672>+</span> pal<span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            pal<span style=color:#f92672>.</span><span style=color:#a6e22e>sendErrorResult</span><span style=color:#f92672>(</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessage</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=215-activitystarterstartactivityunchecked>2.1.5 ActivityStarter.startActivityUnchecked
<a class=anchor href=#215-activitystarterstartactivityunchecked>#</a></h3><p>查看 startActivityUnchecked 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>startActivityUnchecked</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> ActivityRecord r<span style=color:#f92672>,</span> ActivityRecord sourceRecord<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        IVoiceInteractionSession voiceSession<span style=color:#f92672>,</span> IVoiceInteractor voiceInteractor<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> startFlags<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> doResume<span style=color:#f92672>,</span> ActivityOptions options<span style=color:#f92672>,</span> TaskRecord inTask<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 调用 ActivityStackSupervisor 的 resumeFocusedStackTopActivityLocked 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    mSupervisor<span style=color:#f92672>.</span><span style=color:#a6e22e>resumeFocusedStackTopActivityLocked</span><span style=color:#f92672>();</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span> 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> START_SUCCESS<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=216-activitystacksupervisorresumefocusedstacktopactivitylocked>2.1.6 ActivityStackSupervisor.resumeFocusedStackTopActivityLocked
<a class=anchor href=#216-activitystacksupervisorresumefocusedstacktopactivitylocked>#</a></h3><p>[frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/services/core/java/com/android/server/am/ActivityStackSupervisor.java)：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>resumeFocusedStackTopActivityLocked</span><span style=color:#f92672>(</span>ActivityStack targetStack<span style=color:#f92672>,</span> ActivityRecord target<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            ActivityOptions targetOptions<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>targetStack <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> isFocusedStack<span style=color:#f92672>(</span>targetStack<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> targetStack<span style=color:#f92672>.</span><span style=color:#a6e22e>resumeTopActivityUncheckedLocked</span><span style=color:#f92672>(</span>target<span style=color:#f92672>,</span> targetOptions<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> ActivityRecord r <span style=color:#f92672>=</span> mFocusedStack<span style=color:#f92672>.</span><span style=color:#a6e22e>topRunningActivityLocked</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>r <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>state</span> <span style=color:#f92672>!=</span> RESUMED<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 调用 ActivityStack 的 resumeTopActivityUncheckedLocked 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        mFocusedStack<span style=color:#f92672>.</span><span style=color:#a6e22e>resumeTopActivityUncheckedLocked</span><span style=color:#f92672>(</span><span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=217-activitystackresumetopactivityuncheckedlocked>2.1.7 ActivityStack.resumeTopActivityUncheckedLocked
<a class=anchor href=#217-activitystackresumetopactivityuncheckedlocked>#</a></h3><p>查看 [ActivityStack](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/services/core/java/com/android/server/am/ActivityStack.java) 的 resumeTopActivityUncheckedLocked 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>resumeTopActivityUncheckedLocked</span><span style=color:#f92672>(</span>ActivityRecord prev<span style=color:#f92672>,</span> ActivityOptions options<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 调用 resumeTopActivityInnerLocked 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        result <span style=color:#f92672>=</span> resumeTopActivityInnerLocked<span style=color:#f92672>(</span>prev<span style=color:#f92672>,</span> options<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        mStackSupervisor<span style=color:#f92672>.</span><span style=color:#a6e22e>inResumeTopActivity</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=218-activitystackresumetopactivityinnerlocked>2.1.8 ActivityStack.resumeTopActivityInnerLocked
<a class=anchor href=#218-activitystackresumetopactivityinnerlocked>#</a></h3><p>查看 resumeTopActivityInnerLocked 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>resumeTopActivityInnerLocked</span><span style=color:#f92672>(</span>ActivityRecord prev<span style=color:#f92672>,</span> ActivityOptions options<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> ActivityRecord next <span style=color:#f92672>=</span> topRunningActivityLocked<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>next<span style=color:#f92672>.</span><span style=color:#a6e22e>app</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> next<span style=color:#f92672>.</span><span style=color:#a6e22e>app</span><span style=color:#f92672>.</span><span style=color:#a6e22e>thread</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>DEBUG_STATES<span style=color:#f92672>)</span> Slog<span style=color:#f92672>.</span><span style=color:#a6e22e>d</span><span style=color:#f92672>(</span>TAG_STATES<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;resumeTopActivityLocked: Restarting &#34;</span> <span style=color:#f92672>+</span> next<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 调用 ActivityStackSupervisor 的 startSpecificActivityLocked 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        mStackSupervisor<span style=color:#f92672>.</span><span style=color:#a6e22e>startSpecificActivityLocked</span><span style=color:#f92672>(</span>next<span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>DEBUG_STACK<span style=color:#f92672>)</span> mStackSupervisor<span style=color:#f92672>.</span><span style=color:#a6e22e>validateTopActivitiesLocked</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=219-activitystacksupervisorstartspecificactivitylocked>2.1.9 ActivityStackSupervisor.startSpecificActivityLocked
<a class=anchor href=#219-activitystacksupervisorstartspecificactivitylocked>#</a></h3><p>回到 ActivityStackSupervisor 的 startSpecificActivityLocked 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>startSpecificActivityLocked</span><span style=color:#f92672>(</span>ActivityRecord r<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> andResume<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> checkConfig<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 当前 Activity 附属的 Application
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    ProcessRecord app <span style=color:#f92672>=</span> mService<span style=color:#f92672>.</span><span style=color:#a6e22e>getProcessRecordLocked</span><span style=color:#f92672>(</span>r<span style=color:#f92672>.</span><span style=color:#a6e22e>processName</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            r<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>.</span><span style=color:#a6e22e>applicationInfo</span><span style=color:#f92672>.</span><span style=color:#a6e22e>uid</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span><span style=color:#a6e22e>task</span><span style=color:#f92672>.</span><span style=color:#a6e22e>stack</span><span style=color:#f92672>.</span><span style=color:#a6e22e>setLaunchTime</span><span style=color:#f92672>(</span>r<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果 Application 已经运行
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>app <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> app<span style=color:#f92672>.</span><span style=color:#a6e22e>thread</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>r<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>.</span><span style=color:#a6e22e>flags</span><span style=color:#f92672>&amp;</span>ActivityInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>FLAG_MULTIPROCESS</span><span style=color:#f92672>)</span> <span style=color:#f92672>==</span> 0
</span></span><span style=display:flex><span>                    <span style=color:#f92672>||</span> <span style=color:#f92672>!</span><span style=color:#e6db74>&#34;android&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>r<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>.</span><span style=color:#a6e22e>packageName</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                app<span style=color:#f92672>.</span><span style=color:#a6e22e>addPackage</span><span style=color:#f92672>(</span>r<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>.</span><span style=color:#a6e22e>packageName</span><span style=color:#f92672>,</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>.</span><span style=color:#a6e22e>applicationInfo</span><span style=color:#f92672>.</span><span style=color:#a6e22e>versionCode</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                        mService<span style=color:#f92672>.</span><span style=color:#a6e22e>mProcessStats</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            realStartActivityLocked<span style=color:#f92672>(</span>r<span style=color:#f92672>,</span> app<span style=color:#f92672>,</span> andResume<span style=color:#f92672>,</span> checkConfig<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>RemoteException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Slog<span style=color:#f92672>.</span><span style=color:#a6e22e>w</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Exception when starting activity &#34;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>+</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>intent</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getComponent</span><span style=color:#f92672>().</span><span style=color:#a6e22e>flattenToShortString</span><span style=color:#f92672>(),</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 启动新进程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    mService<span style=color:#f92672>.</span><span style=color:#a6e22e>startProcessLocked</span><span style=color:#f92672>(</span>r<span style=color:#f92672>.</span><span style=color:#a6e22e>processName</span><span style=color:#f92672>,</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>.</span><span style=color:#a6e22e>applicationInfo</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;activity&#34;</span><span style=color:#f92672>,</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>intent</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getComponent</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>首先，在方法中获取了当前 Activity 附属的 Application，如果已经在运行了，说明这个 App 是已经被启动过了的，这时候调用 <strong>realStartActivityLocked</strong> 方法就可以进入下一步的流程了，同一个 App 中不同 Activity 的相互启动就是走的这个流程。当 Application 没有运行的时候，就需要调用 AMS 的 startProcessLocked 方法启动一个进程去承载它然后完成后续的工作，顺便铺垫一下，当新进程被启动完成后还会调用回到这个方法，查看 AMS 的 startProcessLocked 方法：</p><h3 id=2110-activitymanagerservicestartprocesslocked>2.1.10 ActivityManagerService.startProcessLocked
<a class=anchor href=#2110-activitymanagerservicestartprocesslocked>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>final</span> ProcessRecord <span style=color:#a6e22e>startProcessLocked</span><span style=color:#f92672>(</span>String processName<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        ApplicationInfo info<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> knownToBeDead<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> intentFlags<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        String hostingType<span style=color:#f92672>,</span> ComponentName hostingName<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> allowWhileBooting<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>boolean</span> isolated<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> keepIfLarge<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> startProcessLocked<span style=color:#f92672>(</span>processName<span style=color:#f92672>,</span> info<span style=color:#f92672>,</span> knownToBeDead<span style=color:#f92672>,</span> intentFlags<span style=color:#f92672>,</span> hostingType<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            hostingName<span style=color:#f92672>,</span> allowWhileBooting<span style=color:#f92672>,</span> isolated<span style=color:#f92672>,</span> 0 <span style=color:#75715e>/* isolatedUid */</span><span style=color:#f92672>,</span> keepIfLarge<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>null</span> <span style=color:#75715e>/* ABI override */</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span> <span style=color:#75715e>/* entryPoint */</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span> <span style=color:#75715e>/* entryPointArgs */</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>null</span> <span style=color:#75715e>/* crashHandler */</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=2111-activitymanagerservicestartprocesslocked>2.1.11 ActivityManagerService.startProcessLocked
<a class=anchor href=#2111-activitymanagerservicestartprocesslocked>#</a></h3><p>调用 startProcessLocked 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>final</span> ProcessRecord <span style=color:#a6e22e>startProcessLocked</span><span style=color:#f92672>(</span>String processName<span style=color:#f92672>,</span> ApplicationInfo info<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>boolean</span> knownToBeDead<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> intentFlags<span style=color:#f92672>,</span> String hostingType<span style=color:#f92672>,</span> ComponentName hostingName<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>boolean</span> allowWhileBooting<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> isolated<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> isolatedUid<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> keepIfLarge<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        String abiOverride<span style=color:#f92672>,</span> String entryPoint<span style=color:#f92672>,</span> String<span style=color:#f92672>[]</span> entryPointArgs<span style=color:#f92672>,</span> Runnable crashHandler<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    startProcessLocked<span style=color:#f92672>(</span>app<span style=color:#f92672>,</span> hostingType<span style=color:#f92672>,</span> hostingNameStr<span style=color:#f92672>,</span> abiOverride<span style=color:#f92672>,</span> entryPoint<span style=color:#f92672>,</span> entryPointArgs<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    checkTime<span style=color:#f92672>(</span>startTime<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;startProcess: done starting proc!&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>app<span style=color:#f92672>.</span><span style=color:#a6e22e>pid</span> <span style=color:#f92672>!=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>?</span> app <span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=2112-activitymanagerservicestartprocesslocked>2.1.12 ActivityManagerService.startProcessLocked
<a class=anchor href=#2112-activitymanagerservicestartprocesslocked>#</a></h3><p>调用 startProcessLocked 的重载方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>startProcessLocked</span><span style=color:#f92672>(</span>ProcessRecord app<span style=color:#f92672>,</span> String hostingType<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        String hostingNameStr<span style=color:#f92672>,</span> String abiOverride<span style=color:#f92672>,</span> String entryPoint<span style=color:#f92672>,</span> String<span style=color:#f92672>[]</span> entryPointArgs<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 调用 Process 的 start 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Process<span style=color:#f92672>.</span><span style=color:#a6e22e>ProcessStartResult</span> startResult <span style=color:#f92672>=</span> Process<span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>(</span>entryPoint<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                app<span style=color:#f92672>.</span><span style=color:#a6e22e>processName</span><span style=color:#f92672>,</span> uid<span style=color:#f92672>,</span> uid<span style=color:#f92672>,</span> gids<span style=color:#f92672>,</span> debugFlags<span style=color:#f92672>,</span> mountExternal<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                app<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>.</span><span style=color:#a6e22e>targetSdkVersion</span><span style=color:#f92672>,</span> app<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>.</span><span style=color:#a6e22e>seinfo</span><span style=color:#f92672>,</span> requiredAbi<span style=color:#f92672>,</span> instructionSet<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                app<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>.</span><span style=color:#a6e22e>dataDir</span><span style=color:#f92672>,</span> entryPointArgs<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>RuntimeException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=2113-processstart>2.1.13 Process.start
<a class=anchor href=#2113-processstart>#</a></h3><p>[frameworks/base/services/core/java/android/os/Process.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/android/os/Process.java)：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> ProcessStartResult <span style=color:#a6e22e>start</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> String processClass<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>final</span> String niceName<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>int</span> uid<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> gid<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span><span style=color:#f92672>[]</span> gids<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>int</span> debugFlags<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> mountExternal<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>int</span> targetSdkVersion<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                String seInfo<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                String abi<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                String instructionSet<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                String appDataDir<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                String<span style=color:#f92672>[]</span> zygoteArgs<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 调用 startViaZygote 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> startViaZygote<span style=color:#f92672>(</span>processClass<span style=color:#f92672>,</span> niceName<span style=color:#f92672>,</span> uid<span style=color:#f92672>,</span> gid<span style=color:#f92672>,</span> gids<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                debugFlags<span style=color:#f92672>,</span> mountExternal<span style=color:#f92672>,</span> targetSdkVersion<span style=color:#f92672>,</span> seInfo<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                abi<span style=color:#f92672>,</span> instructionSet<span style=color:#f92672>,</span> appDataDir<span style=color:#f92672>,</span> zygoteArgs<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>ZygoteStartFailedEx ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Log<span style=color:#f92672>.</span><span style=color:#a6e22e>e</span><span style=color:#f92672>(</span>LOG_TAG<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;Starting VM process through Zygote failed&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;Starting VM process through Zygote failed&#34;</span><span style=color:#f92672>,</span> ex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=2114-processstartviazygote>2.1.14 Process.startViaZygote
<a class=anchor href=#2114-processstartviazygote>#</a></h3><p>查看 startViaZygote 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> ProcessStartResult <span style=color:#a6e22e>startViaZygote</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> String processClass<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>final</span> String niceName<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> uid<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> gid<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span><span style=color:#f92672>[]</span> gids<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>int</span> debugFlags<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> mountExternal<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>int</span> targetSdkVersion<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                String seInfo<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                String abi<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                String instructionSet<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                String appDataDir<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                String<span style=color:#f92672>[]</span> extraArgs<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>throws</span> ZygoteStartFailedEx <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span><span style=color:#f92672>(</span>Process<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 调用 zygoteSendArgsAndGetResult 方法，传入 openZygoteSocketIfNeeded 的返回值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> zygoteSendArgsAndGetResult<span style=color:#f92672>(</span>openZygoteSocketIfNeeded<span style=color:#f92672>(</span>abi<span style=color:#f92672>),</span> argsForZygote<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=2115-processzygotesendargsandgetresultprocessopenzygotesocketifneeded>2.1.15 Process.zygoteSendArgsAndGetResult、Process.openZygoteSocketIfNeeded
<a class=anchor href=#2115-processzygotesendargsandgetresultprocessopenzygotesocketifneeded>#</a></h3><p>查看 zygoteSendArgsAndGetResult 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> ProcessStartResult <span style=color:#a6e22e>zygoteSendArgsAndGetResult</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            ZygoteState zygoteState<span style=color:#f92672>,</span> ArrayList<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> args<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throws</span> ZygoteStartFailedEx <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> BufferedWriter writer <span style=color:#f92672>=</span> zygoteState<span style=color:#f92672>.</span><span style=color:#a6e22e>writer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> DataInputStream inputStream <span style=color:#f92672>=</span> zygoteState<span style=color:#f92672>.</span><span style=color:#a6e22e>inputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        writer<span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>Integer<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>(</span>args<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>        writer<span style=color:#f92672>.</span><span style=color:#a6e22e>newLine</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> sz<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            String arg <span style=color:#f92672>=</span> args<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>i<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            writer<span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>arg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            writer<span style=color:#f92672>.</span><span style=color:#a6e22e>newLine</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        writer<span style=color:#f92672>.</span><span style=color:#a6e22e>flush</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Should there be a timeout on this?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        ProcessStartResult result <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ProcessStartResult<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 等待 socket 服务端（即zygote）返回新创建的进程pid;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        result<span style=color:#f92672>.</span><span style=color:#a6e22e>pid</span> <span style=color:#f92672>=</span> inputStream<span style=color:#f92672>.</span><span style=color:#a6e22e>readInt</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        result<span style=color:#f92672>.</span><span style=color:#a6e22e>usingWrapper</span> <span style=color:#f92672>=</span> inputStream<span style=color:#f92672>.</span><span style=color:#a6e22e>readBoolean</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>result<span style=color:#f92672>.</span><span style=color:#a6e22e>pid</span> <span style=color:#f92672>&lt;</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ZygoteStartFailedEx<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;fork() failed&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        zygoteState<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ZygoteStartFailedEx<span style=color:#f92672>(</span>ex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>在 zygoteSendArgsAndGetResult 中等待 Socket 服务端，也就是 zygote 进程返回创建新进程的结果，这里 zygoteState 参数是由 openZygoteSocketIfNeeded 方法返回的，openZygoteSocketIfNeeded 方法则负责根据 abi 向 Zygote 进程发起连接请求：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> ZygoteState <span style=color:#a6e22e>openZygoteSocketIfNeeded</span><span style=color:#f92672>(</span>String abi<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> ZygoteStartFailedEx <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>primaryZygoteState <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> primaryZygoteState<span style=color:#f92672>.</span><span style=color:#a6e22e>isClosed</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 向主zygote发起connect()操作
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            primaryZygoteState <span style=color:#f92672>=</span> ZygoteState<span style=color:#f92672>.</span><span style=color:#a6e22e>connect</span><span style=color:#f92672>(</span>ZYGOTE_SOCKET<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException ioe<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ZygoteStartFailedEx<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Error connecting to primary zygote&#34;</span><span style=color:#f92672>,</span> ioe<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>primaryZygoteState<span style=color:#f92672>.</span><span style=color:#a6e22e>matches</span><span style=color:#f92672>(</span>abi<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> primaryZygoteState<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>secondaryZygoteState <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> secondaryZygoteState<span style=color:#f92672>.</span><span style=color:#a6e22e>isClosed</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 当主zygote没能匹配成功，则采用第二个zygote，发起connect()操作
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            secondaryZygoteState <span style=color:#f92672>=</span> ZygoteState<span style=color:#f92672>.</span><span style=color:#a6e22e>connect</span><span style=color:#f92672>(</span>SECONDARY_ZYGOTE_SOCKET<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException ioe<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ZygoteStartFailedEx<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Error connecting to secondary zygote&#34;</span><span style=color:#f92672>,</span> ioe<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>secondaryZygoteState<span style=color:#f92672>.</span><span style=color:#a6e22e>matches</span><span style=color:#f92672>(</span>abi<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> secondaryZygoteState<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ZygoteStartFailedEx<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Unsupported zygote ABI: &#34;</span> <span style=color:#f92672>+</span> abi<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=22-小结>2.2 小结
<a class=anchor href=#22-%e5%b0%8f%e7%bb%93>#</a></h2><p>如果是从桌面新启动一个 App 中的 Activity，此时是没有进程去承载这个 App 的，因此需要通过 AMS 向 zygote 继承发起请求去完成这个任务，AMS 运行在 system_server 进程中，它通过 Socket 向 zygote 发起 fock 进程的请求，从 AMS 开始的调用时序图如下：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/App-Startup/clipboard_20230323_045449.png width=auto alt></p><h1 id=3-zygote--activitythread>3. zygote —— ActivityThread
<a class=anchor href=#3-zygote--activitythread>#</a></h1><h2 id=31-调用过程分析>3.1 调用过程分析
<a class=anchor href=#31-%e8%b0%83%e7%94%a8%e8%bf%87%e7%a8%8b%e5%88%86%e6%9e%90>#</a></h2><h3 id=311-zygoteinitmain>3.1.1 ZygoteInit.main
<a class=anchor href=#311-zygoteinitmain>#</a></h3><p>在
<a href=https://guanpj.cn/2017/09/17/Android-System-Startup-Flow-Analyze/ rel=noopener>Android 系统启动流程分析</a> 文中提到过 zygote 进程的其中一项任务就是：</p><blockquote><p>调用 registerZygoteSocket() 函数建立 Socket 通道，使 zygote 进程成为 Socket 服务端，并通过 runSelectLoop() 函数等待 ActivityManagerService 发送请求创建新的应用程序进程。</p></blockquote><p>zygote 终于要再次上场了！接下来从 ZygoteInit.java 的 main 方法开始回顾一下 zygote 进程的工作：</p><p>[frameworks/base/core/java/com/android/internal/os/ZygoteInit.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/com/android/internal/os/ZygoteInit.java)：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String argv<span style=color:#f92672>[])</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        runSelectLoop<span style=color:#f92672>(</span>abiList<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>....</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>MethodAndArgsCaller caller<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        caller<span style=color:#f92672>.</span><span style=color:#a6e22e>run</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>RuntimeException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        closeServerSocket<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> ex<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=312-zygoteinitrunselectloop>3.1.2 ZygoteInit.runSelectLoop
<a class=anchor href=#312-zygoteinitrunselectloop>#</a></h3><p>查看 runSelectLoop 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>runSelectLoop</span><span style=color:#f92672>(</span>String abiList<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> MethodAndArgsCaller <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 循环读取状态
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> pollFds<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> 1<span style=color:#f92672>;</span> i <span style=color:#f92672>&gt;=</span> 0<span style=color:#f92672>;</span> <span style=color:#f92672>--</span>i<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 读取的状态不是客户端连接或者数据请求时，进入下一次循环
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>pollFds<span style=color:#f92672>[</span>i<span style=color:#f92672>].</span><span style=color:#a6e22e>revents</span> <span style=color:#f92672>&amp;</span> POLLIN<span style=color:#f92672>)</span> <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>i <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span><span style=color:#75715e>// i = 0 表示跟客户端 Socket 连接上了
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                ZygoteConnection newPeer <span style=color:#f92672>=</span> acceptCommandPeer<span style=color:#f92672>(</span>abiList<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                peers<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>newPeer<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                fds<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>newPeer<span style=color:#f92672>.</span><span style=color:#a6e22e>getFileDesciptor</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span><span style=color:#75715e>// i &gt; 0 表示接收到客户端 Socket 发送过来的请求
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// runOnce 方法创建一个新的应用程序进程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>boolean</span> done <span style=color:#f92672>=</span> peers<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>i<span style=color:#f92672>).</span><span style=color:#a6e22e>runOnce</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>done<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    peers<span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>(</span>i<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    fds<span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>(</span>i<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=313-zygoteconnectionrunonce>3.1.3 ZygoteConnection.runOnce
<a class=anchor href=#313-zygoteconnectionrunonce>#</a></h3><p>查看 [frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/com/android/internal/os/ZygoteConnection.java) 的 runOnce 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>runOnce</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> ZygoteInit<span style=color:#f92672>.</span><span style=color:#a6e22e>MethodAndArgsCaller</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    String args<span style=color:#f92672>[];</span>
</span></span><span style=display:flex><span>    Arguments parsedArgs <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    FileDescriptor<span style=color:#f92672>[]</span> descriptors<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 读取 socket 客户端发送过来的参数列表
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        args <span style=color:#f92672>=</span> readArgumentList<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        descriptors <span style=color:#f92672>=</span> mSocket<span style=color:#f92672>.</span><span style=color:#a6e22e>getAncillaryFileDescriptors</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// EOF reached.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        closeSocket<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 将 socket 客户端传递过来的参数，解析成 Arguments 对象格式
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        parsedArgs <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Arguments<span style=color:#f92672>(</span>args<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 同样调用 Zygote.java 的 forkAndSpecialize 方法 fock 出子进程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        pid <span style=color:#f92672>=</span> Zygote<span style=color:#f92672>.</span><span style=color:#a6e22e>forkAndSpecialize</span><span style=color:#f92672>(</span>parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>uid</span><span style=color:#f92672>,</span> parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>gid</span><span style=color:#f92672>,</span> parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>gids</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>debugFlags</span><span style=color:#f92672>,</span> rlimits<span style=color:#f92672>,</span> parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>mountExternal</span><span style=color:#f92672>,</span> parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>seInfo</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>niceName</span><span style=color:#f92672>,</span> fdsToClose<span style=color:#f92672>,</span> parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>instructionSet</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>appDataDir</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>pid <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 子进程执行
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            IoUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>closeQuietly</span><span style=color:#f92672>(</span>serverPipeFd<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            serverPipeFd <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 进入子进程流程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            handleChildProc<span style=color:#f92672>(</span>parsedArgs<span style=color:#f92672>,</span> descriptors<span style=color:#f92672>,</span> childPipeFd<span style=color:#f92672>,</span> newStderr<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 父进程执行
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            IoUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>closeQuietly</span><span style=color:#f92672>(</span>childPipeFd<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            childPipeFd <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> handleParentProc<span style=color:#f92672>(</span>pid<span style=color:#f92672>,</span> descriptors<span style=color:#f92672>,</span> serverPipeFd<span style=color:#f92672>,</span> parsedArgs<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        IoUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>closeQuietly</span><span style=color:#f92672>(</span>childPipeFd<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        IoUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>closeQuietly</span><span style=color:#f92672>(</span>serverPipeFd<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=314-zygoteconnectionhandlechildproc>3.1.4 ZygoteConnection.handleChildProc
<a class=anchor href=#314-zygoteconnectionhandlechildproc>#</a></h3><p>首先解析 Socket 客户端传过来的参数，[Zygote.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/com/android/internal/os/Zygote.java) 的 forkAndSpecialize 返回的 pid == 0 的时候表示此时在 fock 出来的子进程中执行，继续调用 handleChildProc 方法，并将参数继续层层传递：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handleChildProc</span><span style=color:#f92672>(</span>Arguments parsedArgs<span style=color:#f92672>,</span> FileDescriptor<span style=color:#f92672>[]</span> 
</span></span><span style=display:flex><span>    descriptors<span style=color:#f92672>,</span> FileDescriptor pipeFd<span style=color:#f92672>,</span> PrintStream newStderr<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> ZygoteInit<span style=color:#f92672>.</span><span style=color:#a6e22e>MethodAndArgsCaller</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/*由于 fock 出来的 system_server 进程会复制 zygote 进程的地址空间，因此它也得到了 zygote
</span></span></span><span style=display:flex><span><span style=color:#75715e>    进程中的 Socket，这个 Socket 对它来说并无用处，这里将其关闭 
</span></span></span><span style=display:flex><span><span style=color:#75715e>    */</span>
</span></span><span style=display:flex><span>    closeSocket<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    ZygoteInit<span style=color:#f92672>.</span><span style=color:#a6e22e>closeServerSocket</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>niceName</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 设置进程名
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Process<span style=color:#f92672>.</span><span style=color:#a6e22e>setArgV0</span><span style=color:#f92672>(</span>parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>niceName</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>invokeWith</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 调用 RuntimeInit 的 zygoteInit 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        RuntimeInit<span style=color:#f92672>.</span><span style=color:#a6e22e>zygoteInit</span><span style=color:#f92672>(</span>parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>targetSdkVersion</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                parsedArgs<span style=color:#f92672>.</span><span style=color:#a6e22e>remainingArgs</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=315-runtimeinitzygoteinit>3.1.5 RuntimeInit.zygoteInit
<a class=anchor href=#315-runtimeinitzygoteinit>#</a></h3><p>查看 [frameworks/base/core/java/com/android/internal/os/RuntimeInit.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/com/android/internal/os/RuntimeInit.java) 的 zygoteInit 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>zygoteInit</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> targetSdkVersion<span style=color:#f92672>,</span> String<span style=color:#f92672>[]</span> argv<span style=color:#f92672>,</span> 
</span></span><span style=display:flex><span>            ClassLoader classLoader<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> ZygoteInit<span style=color:#f92672>.</span><span style=color:#a6e22e>MethodAndArgsCaller</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>DEBUG<span style=color:#f92672>)</span> Slog<span style=color:#f92672>.</span><span style=color:#a6e22e>d</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;RuntimeInit: Starting application from zygote&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>traceBegin</span><span style=color:#f92672>(</span>Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>TRACE_TAG_ACTIVITY_MANAGER</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;RuntimeInit&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 重定向 log 输出
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    redirectLogStreams<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 初始化一些通用的设置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    commonInit<span style=color:#f92672>();</span> 
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *通过 Native 层中 AndroidRuntime.cpp 的 JNI 方法最终调用 app_main.cpp 的 
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *onZygoteInit 方法启动 Binder 线程池， 使 system_server 进程可以使用 Binder  *与其他进程通信
</span></span></span><span style=display:flex><span><span style=color:#75715e>     **/</span>
</span></span><span style=display:flex><span>    nativeZygoteInit<span style=color:#f92672>();</span> 
</span></span><span style=display:flex><span>    applicationInit<span style=color:#f92672>(</span>targetSdkVersion<span style=color:#f92672>,</span> argv<span style=color:#f92672>,</span> classLoader<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=316-runtimeinitapplicationinit>3.1.6 RuntimeInit.applicationInit
<a class=anchor href=#316-runtimeinitapplicationinit>#</a></h3><p>继续调用 applicationInit 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>applicationInit</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> targetSdkVersion<span style=color:#f92672>,</span> String<span style=color:#f92672>[]</span> argv<span style=color:#f92672>,</span> ClassLoader classLoader<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throws</span> ZygoteInit<span style=color:#f92672>.</span><span style=color:#a6e22e>MethodAndArgsCaller</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 提取出参数里面的要启动的类的名字
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    invokeStaticMain<span style=color:#f92672>(</span>args<span style=color:#f92672>.</span><span style=color:#a6e22e>startClass</span><span style=color:#f92672>,</span> args<span style=color:#f92672>.</span><span style=color:#a6e22e>startArgs</span><span style=color:#f92672>,</span> classLoader<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=317-runtimeinitinvokestaticmain>3.1.7 RuntimeInit.invokeStaticMain
<a class=anchor href=#317-runtimeinitinvokestaticmain>#</a></h3><p>主要调用了 invokeStaticMain 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>invokeStaticMain</span><span style=color:#f92672>(</span>String className<span style=color:#f92672>,</span> String<span style=color:#f92672>[]</span> argv<span style=color:#f92672>,</span> ClassLoader classLoader<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>throws</span> ZygoteInit<span style=color:#f92672>.</span><span style=color:#a6e22e>MethodAndArgsCaller</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Class<span style=color:#f92672>&lt;?&gt;</span> cl<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>/** className 为通过 Socket 客户端（AMS）传递过来的一系列参数中的其中一个，这里获取到的值为传&#34;com.android.app.ActivityThread&#34;，然后通过反射得到 ActivityThread 类 **/</span>
</span></span><span style=display:flex><span>        cl <span style=color:#f92672>=</span> Class<span style=color:#f92672>.</span><span style=color:#a6e22e>forName</span><span style=color:#f92672>(</span>className<span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> classLoader<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>ClassNotFoundException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Missing class when invoking static main &#34;</span> <span style=color:#f92672>+</span> className<span style=color:#f92672>,</span> ex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    Method m<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 找到 ActivityThread 类的 main 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        m <span style=color:#f92672>=</span> cl<span style=color:#f92672>.</span><span style=color:#a6e22e>getMethod</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;main&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Class<span style=color:#f92672>[]</span> <span style=color:#f92672>{</span> String<span style=color:#f92672>[].</span><span style=color:#a6e22e>class</span> <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>NoSuchMethodException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Missing static main on &#34;</span> <span style=color:#f92672>+</span> className<span style=color:#f92672>,</span> ex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>SecurityException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Problem getting static main on &#34;</span> <span style=color:#f92672>+</span> className<span style=color:#f92672>,</span> ex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> modifiers <span style=color:#f92672>=</span> m<span style=color:#f92672>.</span><span style=color:#a6e22e>getModifiers</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span> <span style=color:#f92672>(</span>Modifier<span style=color:#f92672>.</span><span style=color:#a6e22e>isStatic</span><span style=color:#f92672>(</span>modifiers<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span> Modifier<span style=color:#f92672>.</span><span style=color:#a6e22e>isPublic</span><span style=color:#f92672>(</span>modifiers<span style=color:#f92672>)))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Main method is not public and static on &#34;</span> <span style=color:#f92672>+</span> className<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 将 main 方法包装在 ZygoteInit.MethodAndArgsCaller 类中并作为异常抛出
</span></span></span><span style=display:flex><span><span style=color:#75715e>    捕获异常的地方在上一小节中 ZygoteInit.java 的 main 方法 **/</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ZygoteInit<span style=color:#f92672>.</span><span style=color:#a6e22e>MethodAndArgsCaller</span><span style=color:#f92672>(</span>m<span style=color:#f92672>,</span> argv<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=318-methodandargscallerrun>3.1.8 MethodAndArgsCaller.run
<a class=anchor href=#318-methodandargscallerrun>#</a></h3><p>回到 ZygoteInit 的 main 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String argv<span style=color:#f92672>[])</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    closeServerSocket<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>MethodAndArgsCaller caller<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 接收到 caller 对象后调用它的 run 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        caller<span style=color:#f92672>.</span><span style=color:#a6e22e>run</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>RuntimeException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Log<span style=color:#f92672>.</span><span style=color:#a6e22e>e</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Zygote died with exception&#34;</span><span style=color:#f92672>,</span> ex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        closeServerSocket<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> ex<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>跟 system_server 进程的启动过程一样，这里同样通过抛出异常的方式来清空调用 ActivityThread.main 之前的方法栈帧。</p><p>ZygoteInit 的 MethodAndArgsCaller 类是一个 Exception 类，同时也实现了 Runnable 接口：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MethodAndArgsCaller</span> <span style=color:#66d9ef>extends</span> Exception
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>implements</span> Runnable <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Method mMethod<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> String<span style=color:#f92672>[]</span> mArgs<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>MethodAndArgsCaller</span><span style=color:#f92672>(</span>Method method<span style=color:#f92672>,</span> String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        mMethod <span style=color:#f92672>=</span> method<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        mArgs <span style=color:#f92672>=</span> args<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 调用传递过来的 mMethod
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            mMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>invoke</span><span style=color:#f92672>(</span><span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Object<span style=color:#f92672>[]</span> <span style=color:#f92672>{</span> mArgs <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IllegalAccessException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span>ex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InvocationTargetException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=319-activitythread-main>3.1.9 ActivityThread .main
<a class=anchor href=#319-activitythread-main>#</a></h3><p>最后通过反射调用到 ActivityThread 的 main 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    Environment<span style=color:#f92672>.</span><span style=color:#a6e22e>initForCurrentUser</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    Process<span style=color:#f92672>.</span><span style=color:#a6e22e>setArgV0</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&lt;pre-initialized&gt;&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 创建主线程 Looper
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Looper<span style=color:#f92672>.</span><span style=color:#a6e22e>prepareMainLooper</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ActivityThread thread <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ActivityThread<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// attach 到系统进程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    thread<span style=color:#f92672>.</span><span style=color:#a6e22e>attach</span><span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>sMainThreadHandler <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        sMainThreadHandler <span style=color:#f92672>=</span> thread<span style=color:#f92672>.</span><span style=color:#a6e22e>getHandler</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 主线程进入轮询状态
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Looper<span style=color:#f92672>.</span><span style=color:#a6e22e>loop</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 抛出异常说明轮询出现问题
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Main thread loop unexpectedly exited&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=32-小结>3.2 小结
<a class=anchor href=#32-%e5%b0%8f%e7%bb%93>#</a></h2><p>zygote 进程作为 Socket 服务端在接收到作为客户端的 AMS 发送过来的请求和参数之后，fock 出新的进程并根据各种参数进程了初始化的工作，这个过程和 zygote 启动 system_server 进程的过程如出一辙，时序图如下所示：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/App-Startup/clipboard_20230323_045452.png width=auto alt></p><h1 id=4-activitythread--activity>4. ActivityThread —— Activity
<a class=anchor href=#4-activitythread--activity>#</a></h1><h2 id=41-调用过程分析>4.1 调用过程分析
<a class=anchor href=#41-%e8%b0%83%e7%94%a8%e8%bf%87%e7%a8%8b%e5%88%86%e6%9e%90>#</a></h2><h3 id=411-activitythreadattach>4.1.1 ActivityThread.attach
<a class=anchor href=#411-activitythreadattach>#</a></h3><p>上一小节的最后，ActivityThread 的 main 通过反射被运行起来了，接着会调用 ActivityThread 的 attach 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>attach</span><span style=color:#f92672>(</span><span style=color:#66d9ef>boolean</span> system<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    mSystemThread <span style=color:#f92672>=</span> system<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>system<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 获取 ActivityManagerProxy 对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>final</span> IActivityManager mgr <span style=color:#f92672>=</span> ActivityManagerNative<span style=color:#f92672>.</span><span style=color:#a6e22e>getDefault</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 通过 Binder 调用 AMS 的 attachApplication 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            mgr<span style=color:#f92672>.</span><span style=color:#a6e22e>attachApplication</span><span style=color:#f92672>(</span>mAppThread<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>RemoteException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> ex<span style=color:#f92672>.</span><span style=color:#a6e22e>rethrowFromSystemServer</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这里，我们再一次通过 Binder IPC 机制跟 AMS 通信，通信模型跟前面 Launcher App 调用 AMS 的 startActivity 方法一样，getDefault 过程不重复分析，这次是调用了 AMS 的 attachApplication 方法，注意这里将 ApplicationThead 类型的 mAppThread 对象作为参数传递了过去，ApplicationThead 是 ActivityThread 的一个内部类，后面我们会讲到，先查看 AMP 的 attachApplication 方法：</p><h3 id=412-activitymanagerproxyattachapplication>4.1.2 ActivityManagerProxy.attachApplication
<a class=anchor href=#412-activitymanagerproxyattachapplication>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>attachApplication</span><span style=color:#f92672>(</span>IApplicationThread app<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> RemoteException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 调用 asBinder 方法使其能够跨进程传输
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    data<span style=color:#f92672>.</span><span style=color:#a6e22e>writeStrongBinder</span><span style=color:#f92672>(</span>app<span style=color:#f92672>.</span><span style=color:#a6e22e>asBinder</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 通过 transact 方法将数据交给 Binder 驱动
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    mRemote<span style=color:#f92672>.</span><span style=color:#a6e22e>transact</span><span style=color:#f92672>(</span>ATTACH_APPLICATION_TRANSACTION<span style=color:#f92672>,</span> data<span style=color:#f92672>,</span> reply<span style=color:#f92672>,</span> 0<span style=color:#f92672>);</span> 
</span></span><span style=display:flex><span>    reply<span style=color:#f92672>.</span><span style=color:#a6e22e>readException</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    data<span style=color:#f92672>.</span><span style=color:#a6e22e>recycle</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    reply<span style=color:#f92672>.</span><span style=color:#a6e22e>recycle</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=413-activitymanagernativeontransact>4.1.3 ActivityManagerNative.onTransact
<a class=anchor href=#413-activitymanagernativeontransact>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>onTransact</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> code<span style=color:#f92672>,</span> Parcel data<span style=color:#f92672>,</span> Parcel reply<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> flags<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> RemoteException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>code<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> ATTACH_APPLICATION_TRANSACTION<span style=color:#f92672>:</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            data<span style=color:#f92672>.</span><span style=color:#a6e22e>enforceInterface</span><span style=color:#f92672>(</span>IActivityManager<span style=color:#f92672>.</span><span style=color:#a6e22e>descriptor</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 获取 ApplicationThread 的代理对象，这里返回的是 ApplicationThreadNative(ATN)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// 的内部类：ApplicationThreadProxy(ATP) 对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            IApplicationThread app <span style=color:#f92672>=</span> ApplicationThreadNative<span style=color:#f92672>.</span><span style=color:#a6e22e>asInterface</span><span style=color:#f92672>(</span>data<span style=color:#f92672>.</span><span style=color:#a6e22e>readStrongBinder</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>app <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 委托给 AMS 执行
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                attachApplication<span style=color:#f92672>(</span>app<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            reply<span style=color:#f92672>.</span><span style=color:#a6e22e>writeNoException</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>asInterface 将 ActivityThread 对象转换成了 [ApplicationThreadNative(ATN)](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/android/app/ActivityManagerNative.java) 的 Binder 代理对象 ApplicationThreadProxy(ATP)，并作为参数传给 attachApplication 方法，其中 ATP 是 ATN 的内部类。</p><h3 id=414-activitymanagerserviceattachapplication>4.1.4 ActivityManagerService.attachApplication
<a class=anchor href=#414-activitymanagerserviceattachapplication>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>attachApplication</span><span style=color:#f92672>(</span>IApplicationThread thread<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> callingPid <span style=color:#f92672>=</span> Binder<span style=color:#f92672>.</span><span style=color:#a6e22e>getCallingPid</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> origId <span style=color:#f92672>=</span> Binder<span style=color:#f92672>.</span><span style=color:#a6e22e>clearCallingIdentity</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        attachApplicationLocked<span style=color:#f92672>(</span>thread<span style=color:#f92672>,</span> callingPid<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        Binder<span style=color:#f92672>.</span><span style=color:#a6e22e>restoreCallingIdentity</span><span style=color:#f92672>(</span>origId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=415-activitymanagerserviceattachapplicationlocked>4.1.5 ActivityManagerService.attachApplicationLocked
<a class=anchor href=#415-activitymanagerserviceattachapplicationlocked>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>attachApplicationLocked</span><span style=color:#f92672>(</span>IApplicationThread thread<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> pid<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    ProcessRecord app<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 绑定死亡通知
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        AppDeathRecipient adr <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AppDeathRecipient<span style=color:#f92672>(</span>app<span style=color:#f92672>,</span> pid<span style=color:#f92672>,</span> thread<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        thread<span style=color:#f92672>.</span><span style=color:#a6e22e>asBinder</span><span style=color:#f92672>().</span><span style=color:#a6e22e>linkToDeath</span><span style=color:#f92672>(</span>adr<span style=color:#f92672>,</span> 0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        app<span style=color:#f92672>.</span><span style=color:#a6e22e>deathRecipient</span> <span style=color:#f92672>=</span> adr<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>RemoteException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        app<span style=color:#f92672>.</span><span style=color:#a6e22e>resetPackageList</span><span style=color:#f92672>(</span>mProcessStats<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 如果 system_server 进程死亡则重新启动进程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        startProcessLocked<span style=color:#f92672>(</span>app<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;link fail&#34;</span><span style=color:#f92672>,</span> processName<span style=color:#f92672>);</span> 
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 获取应用appInfo
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        ApplicationInfo appInfo <span style=color:#f92672>=</span> app<span style=color:#f92672>.</span><span style=color:#a6e22e>instrumentationInfo</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>?</span> app<span style=color:#f92672>.</span><span style=color:#a6e22e>instrumentationInfo</span> <span style=color:#f92672>:</span> app<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 绑定应用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        thread<span style=color:#f92672>.</span><span style=color:#a6e22e>bindApplication</span><span style=color:#f92672>(</span>processName<span style=color:#f92672>,</span> appInfo<span style=color:#f92672>,</span> providers<span style=color:#f92672>,</span> app<span style=color:#f92672>.</span><span style=color:#a6e22e>instrumentationClass</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                profilerInfo<span style=color:#f92672>,</span> app<span style=color:#f92672>.</span><span style=color:#a6e22e>instrumentationArguments</span><span style=color:#f92672>,</span> app<span style=color:#f92672>.</span><span style=color:#a6e22e>instrumentationWatcher</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                app<span style=color:#f92672>.</span><span style=color:#a6e22e>instrumentationUiAutomationConnection</span><span style=color:#f92672>,</span> testMode<span style=color:#f92672>,</span> enableOpenGlTrace<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                isRestrictedBackupMode <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>normalMode<span style=color:#f92672>,</span> app<span style=color:#f92672>.</span><span style=color:#a6e22e>persistent</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>new</span> Configuration<span style=color:#f92672>(</span>mConfiguration<span style=color:#f92672>),</span> app<span style=color:#f92672>.</span><span style=color:#a6e22e>compat</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                getCommonServicesLocked<span style=color:#f92672>(</span>app<span style=color:#f92672>.</span><span style=color:#a6e22e>isolated</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>                mCoreSettingsObserver<span style=color:#f92672>.</span><span style=color:#a6e22e>getCoreSettingsLocked</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        app<span style=color:#f92672>.</span><span style=color:#a6e22e>resetPackageList</span><span style=color:#f92672>(</span>mProcessStats<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        app<span style=color:#f92672>.</span><span style=color:#a6e22e>unlinkDeathRecipient</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// bindApplication 失败也要重启进程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        startProcessLocked<span style=color:#f92672>(</span>app<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;bind fail&#34;</span><span style=color:#f92672>,</span> processName<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果是 Activity: 检查最顶层可见的Activity是否等待在该进程中运行
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>normalMode<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mStackSupervisor<span style=color:#f92672>.</span><span style=color:#a6e22e>attachApplicationLocked</span><span style=color:#f92672>(</span>app<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                didSomething <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            badApp <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果是 Service: 寻找所有需要在该进程中运行的服务
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>badApp<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            didSomething <span style=color:#f92672>|=</span> mServices<span style=color:#f92672>.</span><span style=color:#a6e22e>attachApplicationLocked</span><span style=color:#f92672>(</span>app<span style=color:#f92672>,</span> processName<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            badApp <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果是 BroadcastReceiver: 检查是否在这个进程中有下一个广播接收者
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>badApp <span style=color:#f92672>&amp;&amp;</span> isPendingBroadcastProcessLocked<span style=color:#f92672>(</span>pid<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            didSomething <span style=color:#f92672>|=</span> sendPendingBroadcastsLocked<span style=color:#f92672>(</span>app<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            badApp <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 检查是否在这个进程中有下一个 backup 代理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>badApp <span style=color:#f92672>&amp;&amp;</span> mBackupTarget <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> mBackupTarget<span style=color:#f92672>.</span><span style=color:#a6e22e>appInfo</span><span style=color:#f92672>.</span><span style=color:#a6e22e>uid</span> <span style=color:#f92672>==</span> app<span style=color:#f92672>.</span><span style=color:#a6e22e>uid</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        ensurePackageDexOpt<span style=color:#f92672>(</span>mBackupTarget<span style=color:#f92672>.</span><span style=color:#a6e22e>appInfo</span><span style=color:#f92672>.</span><span style=color:#a6e22e>packageName</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            thread<span style=color:#f92672>.</span><span style=color:#a6e22e>scheduleCreateBackupAgent</span><span style=color:#f92672>(</span>mBackupTarget<span style=color:#f92672>.</span><span style=color:#a6e22e>appInfo</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                    compatibilityInfoForPackageLocked<span style=color:#f92672>(</span>mBackupTarget<span style=color:#f92672>.</span><span style=color:#a6e22e>appInfo</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>                    mBackupTarget<span style=color:#f92672>.</span><span style=color:#a6e22e>backupMode</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            badApp <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>badApp<span style=color:#f92672>)</span> <span style=color:#f92672>{</span> 
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 杀掉 badApp
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        app<span style=color:#f92672>.</span><span style=color:#a6e22e>kill</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;error during init&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        handleAppDiedLocked<span style=color:#f92672>(</span>app<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>didSomething<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 更新 adj(组件的权值)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        updateOomAdjLocked<span style=color:#f92672>();</span> 
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>首先，通过 ATP 使用 Binder 向 ATN 发起 bindApplication 请求，然后通过 normalMode 字段判断是否为 Activity，如果是则执行 ActivityStackSupervisor 的 attachApplicationLocked 方法。</p><h4 id=strong4151-activitythreadjavaapplicationthreadbindapplicationstrong><strong>4.1.5.1 ActivityThread.java::ApplicationThread.bindApplication</strong>
<a class=anchor href=#strong4151-activitythreadjavaapplicationthreadbindapplicationstrong>#</a></h4><p>thread 对象类型是 ATP，通过 Binder 驱动调到了 ATN 的方法，ATN 是一个抽象类，它的实现都委托给了 ApplicationThread(这跟 AMS 跟 AMN 的关系一样)，ApplicationThread 作为 ActivityThread 的内部类存在，它的 binderApplication 方法如下：</p><p>[ActivityThread.java::ApplicationThread](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/java/android/app/ActivityThread.java)：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>bindApplication</span><span style=color:#f92672>(</span>String processName<span style=color:#f92672>,</span> ApplicationInfo appInfo<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>ProviderInfo<span style=color:#f92672>&gt;</span> providers<span style=color:#f92672>,</span> ComponentName instrumentationName<span style=color:#f92672>,</span> ProfilerInfo profilerInfo<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    Bundle instrumentationArgs<span style=color:#f92672>,</span> IInstrumentationWatcher instrumentationWatcher<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    IUiAutomationConnection instrumentationUiConnection<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> debugMode<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span>
</span></span><span style=display:flex><span>    enableOpenGlTrace<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> isRestrictedBackupMode<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> persistent<span style=color:#f92672>,</span> Configuration
</span></span><span style=display:flex><span>    config<span style=color:#f92672>,</span> CompatibilityInfo compatInfo<span style=color:#f92672>,</span> Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> IBinder<span style=color:#f92672>&gt;</span> services<span style=color:#f92672>,</span> Bundle coreSettings<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>services <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 将services缓存起来, 减少binder检索服务的次数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        ServiceManager<span style=color:#f92672>.</span><span style=color:#a6e22e>initServiceCache</span><span style=color:#f92672>(</span>services<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 发送消息 H.BIND_APPLICATION 给 Handler 对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    sendMessage<span style=color:#f92672>(</span>H<span style=color:#f92672>.</span><span style=color:#a6e22e>BIND_APPLICATION</span><span style=color:#f92672>,</span> data<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>H 是 ActivityThread 中的一个 Handler 对象，用于处理发送过来的各种消息：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>H</span> <span style=color:#66d9ef>extends</span> Handler <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> BIND_APPLICATION        <span style=color:#f92672>=</span> 110<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handleMessage</span><span style=color:#f92672>(</span>Message msg<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> BIND_APPLICATION<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>traceBegin</span><span style=color:#f92672>(</span>Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>TRACE_TAG_ACTIVITY_MANAGER</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;bindApplication&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            AppBindData data <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>AppBindData<span style=color:#f92672>)</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>obj</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            handleBindApplication<span style=color:#f92672>(</span>data<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>traceEnd</span><span style=color:#f92672>(</span>Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>TRACE_TAG_ACTIVITY_MANAGER</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>调用了 handleBindApplication 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handleBindApplication</span><span style=color:#f92672>(</span>AppBindData data<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取 LoadedApk 对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    data<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span> <span style=color:#f92672>=</span> getPackageInfoNoCheck<span style=color:#f92672>(</span>data<span style=color:#f92672>.</span><span style=color:#a6e22e>appInfo</span><span style=color:#f92672>,</span> data<span style=color:#f92672>.</span><span style=color:#a6e22e>compatInfo</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 创建 ContextImpl 上下文
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>final</span> ContextImpl appContext <span style=color:#f92672>=</span> ContextImpl<span style=color:#f92672>.</span><span style=color:#a6e22e>createAppContext</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> data<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 创建 Instrumentation 对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>data<span style=color:#f92672>.</span><span style=color:#a6e22e>instrumentationName</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        mInstrumentation <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Instrumentation<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 调用 LoadedApk 的 makeApplication 方法创建 Application
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Application app <span style=color:#f92672>=</span> data<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>.</span><span style=color:#a6e22e>makeApplication</span><span style=color:#f92672>(</span>data<span style=color:#f92672>.</span><span style=color:#a6e22e>restrictedBackupMode</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        mInitialApplication <span style=color:#f92672>=</span> app<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        mInstrumentation<span style=color:#f92672>.</span><span style=color:#a6e22e>onCreate</span><span style=color:#f92672>(</span>data<span style=color:#f92672>.</span><span style=color:#a6e22e>instrumentationArgs</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 调用 Application.onCreate 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        mInstrumentation<span style=color:#f92672>.</span><span style=color:#a6e22e>callApplicationOnCreate</span><span style=color:#f92672>(</span>app<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        StrictMode<span style=color:#f92672>.</span><span style=color:#a6e22e>setThreadPolicy</span><span style=color:#f92672>(</span>savedPolicy<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=strong4152-activitystacksupervisorattachapplicationlockedstrong><strong>4.1.5.2 ActivityStackSupervisor.attachApplicationLocked</strong>
<a class=anchor href=#strong4152-activitystacksupervisorattachapplicationlockedstrong>#</a></h4><p>在 <strong>4.1.4</strong> 小节中通过 Binder 向 ActivityThread 发起 bindApplication 请求后，会根据启动组件的类型去做相应的处理，如果是 Acitivity，则会调用 ActivityStackSupervisor 的 attachApplicationLocked 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>attachApplicationLocked</span><span style=color:#f92672>(</span>ProcessRecord app<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> RemoteException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> String processName <span style=color:#f92672>=</span> app<span style=color:#f92672>.</span><span style=color:#a6e22e>processName</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> didSomething <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> displayNdx <span style=color:#f92672>=</span> mActivityDisplays<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>()</span> <span style=color:#f92672>-</span> 1<span style=color:#f92672>;</span> displayNdx <span style=color:#f92672>&gt;=</span> 0<span style=color:#f92672>;</span> <span style=color:#f92672>--</span>displayNdx<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        ArrayList<span style=color:#f92672>&lt;</span>ActivityStack<span style=color:#f92672>&gt;</span> stacks <span style=color:#f92672>=</span> mActivityDisplays<span style=color:#f92672>.</span><span style=color:#a6e22e>valueAt</span><span style=color:#f92672>(</span>displayNdx<span style=color:#f92672>).</span><span style=color:#a6e22e>mStacks</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> stackNdx <span style=color:#f92672>=</span> stacks<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>()</span> <span style=color:#f92672>-</span> 1<span style=color:#f92672>;</span> stackNdx <span style=color:#f92672>&gt;=</span> 0<span style=color:#f92672>;</span> <span style=color:#f92672>--</span>stackNdx<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>final</span> ActivityStack stack <span style=color:#f92672>=</span> stacks<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>stackNdx<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>isFrontStack<span style=color:#f92672>(</span>stack<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 获取前台stack中栈顶第一个非 finishing 状态的 Activity
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            ActivityRecord hr <span style=color:#f92672>=</span> stack<span style=color:#f92672>.</span><span style=color:#a6e22e>topRunningActivityLocked</span><span style=color:#f92672>(</span><span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>hr <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>hr<span style=color:#f92672>.</span><span style=color:#a6e22e>app</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> app<span style=color:#f92672>.</span><span style=color:#a6e22e>uid</span> <span style=color:#f92672>==</span> hr<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>.</span><span style=color:#a6e22e>applicationInfo</span><span style=color:#f92672>.</span><span style=color:#a6e22e>uid</span> <span style=color:#f92672>&amp;&amp;</span> processName<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>hr<span style=color:#f92672>.</span><span style=color:#a6e22e>processName</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// 真正的启动 Activity
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>realStartActivityLocked<span style=color:#f92672>(</span>hr<span style=color:#f92672>,</span> app<span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            didSomething <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>RemoteException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>throw</span> e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> didSomething<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h5 id=strong41521-activitystacksupervisorrealstartactivitylockedstrong><strong>4.1.5.2.1 ActivityStackSupervisor.realStartActivityLocked</strong>
<a class=anchor href=#strong41521-activitystacksupervisorrealstartactivitylockedstrong>#</a></h5><p>前面 <strong>2.1.8 ActivityStackSupervisor.startSpecificActivityLocked</strong> 小节中分析过，如果当前 Activity 依附的 Application 已经被启动，则调用 realStartActivityLocked 方法，否则创建新的进程，再创建新的进程之后，两个流程的在这里合并起来了：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>realStartActivityLocked</span><span style=color:#f92672>(</span>ActivityRecord r<span style=color:#f92672>,</span> ProcessRecord app<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> andResume<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> checkConfig<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> RemoteException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> ActivityStack stack <span style=color:#f92672>=</span> task<span style=color:#f92672>.</span><span style=color:#a6e22e>stack</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        app<span style=color:#f92672>.</span><span style=color:#a6e22e>forceProcessStateUpTo</span><span style=color:#f92672>(</span>mService<span style=color:#f92672>.</span><span style=color:#a6e22e>mTopProcessState</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 通过 Binder 调用 ApplicationThread 的 scheduleLaunchActivity 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        app<span style=color:#f92672>.</span><span style=color:#a6e22e>thread</span><span style=color:#f92672>.</span><span style=color:#a6e22e>scheduleLaunchActivity</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Intent<span style=color:#f92672>(</span>r<span style=color:#f92672>.</span><span style=color:#a6e22e>intent</span><span style=color:#f92672>),</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>appToken</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                System<span style=color:#f92672>.</span><span style=color:#a6e22e>identityHashCode</span><span style=color:#f92672>(</span>r<span style=color:#f92672>),</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Configuration<span style=color:#f92672>(</span>mService<span style=color:#f92672>.</span><span style=color:#a6e22e>mConfiguration</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>new</span> Configuration<span style=color:#f92672>(</span>stack<span style=color:#f92672>.</span><span style=color:#a6e22e>mOverrideConfig</span><span style=color:#f92672>),</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>compat</span><span style=color:#f92672>,</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>launchedFromPackage</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                task<span style=color:#f92672>.</span><span style=color:#a6e22e>voiceInteractor</span><span style=color:#f92672>,</span> app<span style=color:#f92672>.</span><span style=color:#a6e22e>repProcState</span><span style=color:#f92672>,</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>icicle</span><span style=color:#f92672>,</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>persistentState</span><span style=color:#f92672>,</span> results<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                newIntents<span style=color:#f92672>,</span> <span style=color:#f92672>!</span>andResume<span style=color:#f92672>,</span> mService<span style=color:#f92672>.</span><span style=color:#a6e22e>isNextTransitionForward</span><span style=color:#f92672>(),</span> profilerInfo<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>RemoteException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>r<span style=color:#f92672>.</span><span style=color:#a6e22e>launchFailed</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 第二次启动失败，则结束该 Activity
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            mService<span style=color:#f92672>.</span><span style=color:#a6e22e>appDiedLocked</span><span style=color:#f92672>(</span>app<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            stack<span style=color:#f92672>.</span><span style=color:#a6e22e>requestFinishActivityLocked</span><span style=color:#f92672>(</span>r<span style=color:#f92672>.</span><span style=color:#a6e22e>appToken</span><span style=color:#f92672>,</span> Activity<span style=color:#f92672>.</span><span style=color:#a6e22e>RESULT_CANCELED</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;2nd-crash&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 第一个启动失败，则重启进程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        app<span style=color:#f92672>.</span><span style=color:#a6e22e>activities</span><span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>(</span>r<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这里有一次使用 Binder 调用 ApplicationThread 的 scheduleLaunchActivity 方法。</p><h5 id=strong41522-applicationthreadschedulelaunchactivitystrong><strong>4.1.5.2.2 ApplicationThread.scheduleLaunchActivity</strong>
<a class=anchor href=#strong41522-applicationthreadschedulelaunchactivitystrong>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>scheduleLaunchActivity</span><span style=color:#f92672>(</span>Intent intent<span style=color:#f92672>,</span> IBinder token<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> ident<span style=color:#f92672>,</span> ActivityInfo 
</span></span><span style=display:flex><span>        info<span style=color:#f92672>,</span> Configuration curConfig<span style=color:#f92672>,</span> Configuration overrideConfig<span style=color:#f92672>,</span> CompatibilityInfo 
</span></span><span style=display:flex><span>        compatInfo<span style=color:#f92672>,</span> String referrer<span style=color:#f92672>,</span> IVoiceInteractor voiceInteractor<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> procState<span style=color:#f92672>,</span> Bundle 
</span></span><span style=display:flex><span>        state<span style=color:#f92672>,</span> PersistableBundle persistentState<span style=color:#f92672>,</span> List<span style=color:#f92672>&lt;</span>ResultInfo<span style=color:#f92672>&gt;</span> pendingResults<span style=color:#f92672>,</span> 
</span></span><span style=display:flex><span>        List<span style=color:#f92672>&lt;</span>ReferrerIntent<span style=color:#f92672>&gt;</span> pendingNewIntents<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> notResumed<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> isForward<span style=color:#f92672>,</span> 
</span></span><span style=display:flex><span>        ProfilerInfo profilerInfo<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    updateProcessState<span style=color:#f92672>(</span>procState<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    ActivityClientRecord r <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ActivityClientRecord<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    sendMessage<span style=color:#f92672>(</span>H<span style=color:#f92672>.</span><span style=color:#a6e22e>LAUNCH_ACTIVITY</span><span style=color:#f92672>,</span> r<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>上面提到过，H 是 ActivityThread 中一个 Handler 类，它接收到 LAUNCH_ACTIVITY 消息后会调用 handleLaunchActivity 方法。</p><h5 id=strong41523-activitythreadhandlelaunchactivitystrong><strong>4.1.5.2.3 ActivityThread.handleLaunchActivity</strong>
<a class=anchor href=#strong41523-activitythreadhandlelaunchactivitystrong>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handleLaunchActivity</span><span style=color:#f92672>(</span>ActivityClientRecord r<span style=color:#f92672>,</span> Intent customIntent<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 初始化 WMS
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    WindowManagerGlobal<span style=color:#f92672>.</span><span style=color:#a6e22e>initialize</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 执行 performLaunchActivity 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Activity a <span style=color:#f92672>=</span> performLaunchActivity<span style=color:#f92672>(</span>r<span style=color:#f92672>,</span> customIntent<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>a <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        r<span style=color:#f92672>.</span><span style=color:#a6e22e>createdConfig</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Configuration<span style=color:#f92672>(</span>mConfiguration<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        Bundle oldState <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>state</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 执行 handleResumeActivity 方法，最终调用 onStart 和 onResume 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        handleResumeActivity<span style=color:#f92672>(</span>r<span style=color:#f92672>.</span><span style=color:#a6e22e>token</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>,</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>isForward</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>!</span>r<span style=color:#f92672>.</span><span style=color:#a6e22e>activity</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mFinished</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>r<span style=color:#f92672>.</span><span style=color:#a6e22e>startsNotResumed</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>r<span style=color:#f92672>.</span><span style=color:#a6e22e>activity</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mFinished</span> <span style=color:#f92672>&amp;&amp;</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>startsNotResumed</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            r<span style=color:#f92672>.</span><span style=color:#a6e22e>activity</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mCalled</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            mInstrumentation<span style=color:#f92672>.</span><span style=color:#a6e22e>callActivityOnPause</span><span style=color:#f92672>(</span>r<span style=color:#f92672>.</span><span style=color:#a6e22e>activity</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            r<span style=color:#f92672>.</span><span style=color:#a6e22e>paused</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 停止该 Activity
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        ActivityManagerNative<span style=color:#f92672>.</span><span style=color:#a6e22e>getDefault</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>.</span><span style=color:#a6e22e>finishActivity</span><span style=color:#f92672>(</span>r<span style=color:#f92672>.</span><span style=color:#a6e22e>token</span><span style=color:#f92672>,</span> Activity<span style=color:#f92672>.</span><span style=color:#a6e22e>RESULT_CANCELED</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h5 id=strong41424-applicationthreadperformlaunchactivitystrong><strong>4.1.4.2.4 ApplicationThread.performLaunchActivity</strong>
<a class=anchor href=#strong41424-applicationthreadperformlaunchactivitystrong>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> Activity <span style=color:#a6e22e>performLaunchActivity</span><span style=color:#f92672>(</span>ActivityClientRecord r<span style=color:#f92672>,</span> Intent customIntent<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    Activity activity <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        java<span style=color:#f92672>.</span><span style=color:#a6e22e>lang</span><span style=color:#f92672>.</span><span style=color:#a6e22e>ClassLoader</span> cl <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>packageInfo</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getClassLoader</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Instrumentation 中使用反射创建 Activity
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        activity <span style=color:#f92672>=</span> mInstrumentation<span style=color:#f92672>.</span><span style=color:#a6e22e>newActivity</span><span style=color:#f92672>(</span>cl<span style=color:#f92672>,</span> component<span style=color:#f92672>.</span><span style=color:#a6e22e>getClassName</span><span style=color:#f92672>(),</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>intent</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 创建 Application 对象并调用 Application 的 onCreate 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Application app <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>packageInfo</span><span style=color:#f92672>.</span><span style=color:#a6e22e>makeApplication</span><span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>,</span> mInstrumentation<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>activity <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>            Window window <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>r<span style=color:#f92672>.</span><span style=color:#a6e22e>mPendingRemoveWindow</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>mPreserveWindow</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                window <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>mPendingRemoveWindow</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                r<span style=color:#f92672>.</span><span style=color:#a6e22e>mPendingRemoveWindow</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                r<span style=color:#f92672>.</span><span style=color:#a6e22e>mPendingRemoveWindowManager</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// attach 到 Window 上
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            activity<span style=color:#f92672>.</span><span style=color:#a6e22e>attach</span><span style=color:#f92672>(</span>appContext<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> getInstrumentation<span style=color:#f92672>(),</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>token</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                    r<span style=color:#f92672>.</span><span style=color:#a6e22e>ident</span><span style=color:#f92672>,</span> app<span style=color:#f92672>,</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>intent</span><span style=color:#f92672>,</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>activityInfo</span><span style=color:#f92672>,</span> title<span style=color:#f92672>,</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>parent</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                    r<span style=color:#f92672>.</span><span style=color:#a6e22e>embeddedID</span><span style=color:#f92672>,</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>lastNonConfigurationInstances</span><span style=color:#f92672>,</span> config<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                    r<span style=color:#f92672>.</span><span style=color:#a6e22e>referrer</span><span style=color:#f92672>,</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>voiceInteractor</span><span style=color:#f92672>,</span> window<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>customIntent <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                activity<span style=color:#f92672>.</span><span style=color:#a6e22e>mIntent</span> <span style=color:#f92672>=</span> customIntent<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            r<span style=color:#f92672>.</span><span style=color:#a6e22e>lastNonConfigurationInstances</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            activity<span style=color:#f92672>.</span><span style=color:#a6e22e>mStartedActivity</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> theme <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>activityInfo</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getThemeResource</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>theme <span style=color:#f92672>!=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 设置主题
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                activity<span style=color:#f92672>.</span><span style=color:#a6e22e>setTheme</span><span style=color:#f92672>(</span>theme<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            activity<span style=color:#f92672>.</span><span style=color:#a6e22e>mCalled</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>r<span style=color:#f92672>.</span><span style=color:#a6e22e>isPersistable</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 重新创建的 Activity
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                mInstrumentation<span style=color:#f92672>.</span><span style=color:#a6e22e>callActivityOnCreate</span><span style=color:#f92672>(</span>activity<span style=color:#f92672>,</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>state</span><span style=color:#f92672>,</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>persistentState</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 第一次创建的 Activity
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                mInstrumentation<span style=color:#f92672>.</span><span style=color:#a6e22e>callActivityOnCreate</span><span style=color:#f92672>(</span>activity<span style=color:#f92672>,</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>state</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>  <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> activity<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h5 id=strong41525-instrumentationcallactivityoncreatestrong><strong>4.1.5.2.5 Instrumentation.callActivityOnCreate</strong>
<a class=anchor href=#strong41525-instrumentationcallactivityoncreatestrong>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>callActivityOnCreate</span><span style=color:#f92672>(</span>Activity activity<span style=color:#f92672>,</span> Bundle icicle<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            PersistableBundle persistentState<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    prePerformCreate<span style=color:#f92672>(</span>activity<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 调用 Activity 的 performCreate 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    activity<span style=color:#f92672>.</span><span style=color:#a6e22e>performCreate</span><span style=color:#f92672>(</span>icicle<span style=color:#f92672>,</span> persistentState<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    postPerformCreate<span style=color:#f92672>(</span>activity<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h5 id=strong41526-activityperformcreatestrong><strong>4.1.5.2.6 Activity.performCreate</strong>
<a class=anchor href=#strong41526-activityperformcreatestrong>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>performCreate</span><span style=color:#f92672>(</span>Bundle icicle<span style=color:#f92672>,</span> PersistableBundle persistentState<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        restoreHasCurrentPermissionRequest<span style=color:#f92672>(</span>icicle<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    onCreate<span style=color:#f92672>(</span>icicle<span style=color:#f92672>,</span> persistentState<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    mActivityTransitionState<span style=color:#f92672>.</span><span style=color:#a6e22e>readState</span><span style=color:#f92672>(</span>icicle<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    performCreateCommon<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>终于，onCreate 方法被调用了！！！</p><h2 id=42-小结>4.2 小结
<a class=anchor href=#42-%e5%b0%8f%e7%bb%93>#</a></h2><p>从 ActivityThread 到最终 Activity 被创建及生命周期被调用，核心过程涉及到了三次 Binder IPC 过程，分别是：ActivityThread 调用 AMS 的 attachApplication 方法、AMS 调用 ApplicationThread 的 bindApplication 方法、ASS 调用 Application 的 attachApplicationLocked 方法，整个过程的时序图如下：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/App-Startup/clipboard_20230323_045420.png width=auto alt></p><h1 id=5-总结>5. 总结
<a class=anchor href=#5-%e6%80%bb%e7%bb%93>#</a></h1><p>纵观整个过程，从 Launcher 到 AMS、从 AMS 再到 Zygote、再从 Zygote 到 ActivityThread，最后在 ActivitThread 中层层调用到 Activity 的生命周期方法，中间涉及到了无数的细节，但总体上脉络还是非常清晰的，各个 Android 版本的 Framework 层代码可以某些过程的实现不太一样，但是整个调用流程大体上也是相同的，借用
<a href=http://gityuan.com/android/ rel=noopener>Gityuan</a> 大神的一张图作为结尾：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/App-Startup/clipboard_20230323_045430.png width=auto alt></p><p><strong>系列文章</strong></p><p><a href=https://guanpj.cn/2017/09/17/Android-System-Startup-Flow-Analyze/ rel=noopener>按下电源键后竟然发生了这一幕 —— Android 系统启动流程分析</a></p><p><a href=https://guanpj.cn/2017/10/23/Android-App-Startup-Flow-Analyze/ rel=noopener>App 竟然是这样跑起来的 —— Android App/Activity 启动流程分析</a>（本文）</p><p><a href=https://guanpj.cn/2017/11/09/Android-View-Workflow/ rel=noopener>屏幕上内容究竟是怎样画出来的 —— Android View 工作原理详解</a></p><p><strong>参考文章</strong></p><p><a href=http://gityuan.com/2016/03/12/start-activity/ rel=noopener>startActivity 启动过程分析</a></p><p><a href=http://liuwangshu.cn/framework/component/1-activity-start-1.html rel=noopener>Android 深入四大组件（一）应用程序启动过程（前篇）</a></p><blockquote><p>如果你对文章内容有疑问或者有不同的意见，欢迎留言，我们一同探讨。</p></blockquote><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://guanpj.github.io/amethyst/quartz/js/graph.cbd78cfa87df7d3e230d16fc24f06548.js></script></div></div><div id=contact_buttons><footer><p>Made with <a href=https://github.com/64bitpandas/amethyst>Amethyst</a>, © 2023 guanpj</p><ul><li><a href=https://guanpj.github.io/amethyst/>Home</a></li><li><a href=https://bencuan.me>Website</a></li><li><a href=https://blog.bencuan.me>Blog</a></li></ul></footer></div></article><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#1-launcher--ams>1. Launcher —— AMS</a><ul><li><a href=#11-调用过程分析>1.1 调用过程分析</a><ul><li><a href=#111-launcheronclick>1.1.1 Launcher.onClick</a></li><li><a href=#112-launcheronclickappshortcut>1.1.2 Launcher.onClickAppShortcut</a></li><li><a href=#113-launcherstartactivity>1.1.3 Launcher.startActivity</a></li><li><a href=#114-activitystartactivity>1.1.4 Activity.startActivity</a></li><li><a href=#115-activitystartactivityforresult>1.1.5 Activity.startActivityForResult</a></li><li><a href=#116-instrumentationexecstartactivity>1.1.6 Instrumentation.execStartActivity</a></li><li><a href=#117-activitymanagerproxystartactivity>1.1.7 ActivityManagerProxy.startActivity</a></li><li><a href=#118-activitymanagerservicestartactivity>1.1.8 ActivityManagerService.startActivity</a></li></ul></li><li><a href=#12-小结>1.2 小结</a></li></ul></li><li><a href=#2-ams--zygote>2. AMS —— zygote</a><ul><li><a href=#21-调用过程分析>2.1 调用过程分析</a><ul><li><a href=#211-activitymanagerservicestartactivityasuser>2.1.1 ActivityManagerService.startActivityAsUser</a></li><li><a href=#212-activitystarterstartactivitymaywait>2.1.2 ActivityStarter.startActivityMayWait</a></li><li><a href=#213-activitystarterstartactivitylocked>2.1.3 ActivityStarter.startActivityLocked</a></li><li><a href=#214-activitystarterdopendingactivitylauncheslocked>2.1.4 ActivityStarter.doPendingActivityLaunchesLocked</a></li><li><a href=#215-activitystarterstartactivityunchecked>2.1.5 ActivityStarter.startActivityUnchecked</a></li><li><a href=#216-activitystacksupervisorresumefocusedstacktopactivitylocked>2.1.6 ActivityStackSupervisor.resumeFocusedStackTopActivityLocked</a></li><li><a href=#217-activitystackresumetopactivityuncheckedlocked>2.1.7 ActivityStack.resumeTopActivityUncheckedLocked</a></li><li><a href=#218-activitystackresumetopactivityinnerlocked>2.1.8 ActivityStack.resumeTopActivityInnerLocked</a></li><li><a href=#219-activitystacksupervisorstartspecificactivitylocked>2.1.9 ActivityStackSupervisor.startSpecificActivityLocked</a></li><li><a href=#2110-activitymanagerservicestartprocesslocked>2.1.10 ActivityManagerService.startProcessLocked</a></li><li><a href=#2111-activitymanagerservicestartprocesslocked>2.1.11 ActivityManagerService.startProcessLocked</a></li><li><a href=#2112-activitymanagerservicestartprocesslocked>2.1.12 ActivityManagerService.startProcessLocked</a></li><li><a href=#2113-processstart>2.1.13 Process.start</a></li><li><a href=#2114-processstartviazygote>2.1.14 Process.startViaZygote</a></li><li><a href=#2115-processzygotesendargsandgetresultprocessopenzygotesocketifneeded>2.1.15 Process.zygoteSendArgsAndGetResult、Process.openZygoteSocketIfNeeded</a></li></ul></li><li><a href=#22-小结>2.2 小结</a></li></ul></li><li><a href=#3-zygote--activitythread>3. zygote —— ActivityThread</a><ul><li><a href=#31-调用过程分析>3.1 调用过程分析</a><ul><li><a href=#311-zygoteinitmain>3.1.1 ZygoteInit.main</a></li><li><a href=#312-zygoteinitrunselectloop>3.1.2 ZygoteInit.runSelectLoop</a></li><li><a href=#313-zygoteconnectionrunonce>3.1.3 ZygoteConnection.runOnce</a></li><li><a href=#314-zygoteconnectionhandlechildproc>3.1.4 ZygoteConnection.handleChildProc</a></li><li><a href=#315-runtimeinitzygoteinit>3.1.5 RuntimeInit.zygoteInit</a></li><li><a href=#316-runtimeinitapplicationinit>3.1.6 RuntimeInit.applicationInit</a></li><li><a href=#317-runtimeinitinvokestaticmain>3.1.7 RuntimeInit.invokeStaticMain</a></li><li><a href=#318-methodandargscallerrun>3.1.8 MethodAndArgsCaller.run</a></li><li><a href=#319-activitythread-main>3.1.9 ActivityThread .main</a></li></ul></li><li><a href=#32-小结>3.2 小结</a></li></ul></li><li><a href=#4-activitythread--activity>4. ActivityThread —— Activity</a><ul><li><a href=#41-调用过程分析>4.1 调用过程分析</a><ul><li><a href=#411-activitythreadattach>4.1.1 ActivityThread.attach</a></li><li><a href=#412-activitymanagerproxyattachapplication>4.1.2 ActivityManagerProxy.attachApplication</a></li><li><a href=#413-activitymanagernativeontransact>4.1.3 ActivityManagerNative.onTransact</a></li><li><a href=#414-activitymanagerserviceattachapplication>4.1.4 ActivityManagerService.attachApplication</a></li><li><a href=#415-activitymanagerserviceattachapplicationlocked>4.1.5 ActivityManagerService.attachApplicationLocked</a><ul><li><a href=#strong4151-activitythreadjavaapplicationthreadbindapplicationstrong><strong>4.1.5.1 ActivityThread.java::ApplicationThread.bindApplication</strong></a></li><li><a href=#strong4152-activitystacksupervisorattachapplicationlockedstrong><strong>4.1.5.2 ActivityStackSupervisor.attachApplicationLocked</strong></a><ul><li><a href=#strong41521-activitystacksupervisorrealstartactivitylockedstrong><strong>4.1.5.2.1 ActivityStackSupervisor.realStartActivityLocked</strong></a></li><li><a href=#strong41522-applicationthreadschedulelaunchactivitystrong><strong>4.1.5.2.2 ApplicationThread.scheduleLaunchActivity</strong></a></li><li><a href=#strong41523-activitythreadhandlelaunchactivitystrong><strong>4.1.5.2.3 ActivityThread.handleLaunchActivity</strong></a></li><li><a href=#strong41424-applicationthreadperformlaunchactivitystrong><strong>4.1.4.2.4 ApplicationThread.performLaunchActivity</strong></a></li><li><a href=#strong41525-instrumentationcallactivityoncreatestrong><strong>4.1.5.2.5 Instrumentation.callActivityOnCreate</strong></a></li><li><a href=#strong41526-activityperformcreatestrong><strong>4.1.5.2.6 Activity.performCreate</strong></a></li></ul></li></ul></li></ul></li><li><a href=#42-小结>4.2 小结</a></li></ul></li><li><a href=#5-总结>5. 总结</a></li></ul></nav></div></aside></main></body></html>