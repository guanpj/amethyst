<!doctype html><html lang=en dir=ltr><head><meta property="og:title" content="六、View 绘制流程分析"><meta property="og:description" content="在我的系列文章上一篇： App 竟然是这样跑起来的 —— Android App/Activity 启动流程分析 中已经分析了一个 App 从点击它的图标到 Activity 的 onCreate()、onStart() 和 onResume() 等生命周期被调用的整个流程。我们都知道，普通 App 屏幕上显示的内容都是由一个个自己设计的界面被系统加载而来的，而这些界面中的元素又是怎么被渲染出来的呢？本文将继续基于 Android Nougat 从源码的角度来进一步分析整个过程。
在开始之前，回顾一下上一篇文章中分析的从 ActivityThread 到 Activity 过程的时序图：
 一：初始化 PhoneWindow 和 WindowManager #  如上图所示，在 Activity 的 onCreate()、onStart() 和 onResume() 等生命周期被调用之前，它的 attach() 方法将会先被调用，因此，我们将 attach() 方法作为这篇文章主线的开头：
final void attach(Context context, ActivityThread aThread,  Instrumentation instr, IBinder token, int ident,  Application application, Intent intent, ActivityInfo info,  CharSequence title, Activity parent, String id,  NonConfigurationInstances lastNonConfigurationInstances,  Configuration config, String referrer, IVoiceInteractor voiceInteractor,  Window window) {  attachBaseContext(context);  ."><meta property="og:type" content="article"><meta property="og:url" content="https://guanpj.github.io/amethyst/%E5%85%ADView-%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/"><meta property="article:section" content><meta property="og:site_name" content="guanpj's blog"><title>六、View 绘制流程分析 | guanpj's blog</title><link rel=manifest href=/amethyst/manifest.json><link rel=icon href=/amethyst/favicon.png type=image/x-icon><link rel=stylesheet href=/amethyst/book.min.c27ff4755c78daab11627953d5a6dd7e2698690e086398032995aae74d6397b6.css integrity="sha256-wn/0dVx42qsRYnlT1abdfiaYaQ4IY5gDKZWq501jl7Y=" crossorigin=anonymous><meta charset=utf-8><meta name=description content="在我的系列文章上一篇： App 竟然是这样跑起来的 —— Android App/Activity 启动流程分析 中已经分析了一个 App 从点击它的图标到 Activity 的 onCreate()、onStart() 和 onResume() 等生命周期被调用的整个流程。我们都知道，普通 App 屏幕上显示的内容都是由一个个自己设计的界面被系统加载而来的，而这些界面中的元素又是怎么被渲染出来的呢？本文将继续基于 Android Nougat 从源码的角度来进一步分析整个过程。
在开始之前，回顾一下上一篇文章中分析的从 ActivityThread 到 Activity 过程的时序图：
 一：初始化 PhoneWindow 和 WindowManager #  如上图所示，在 Activity 的 onCreate()、onStart() 和 onResume() 等生命周期被调用之前，它的 attach() 方法将会先被调用，因此，我们将 attach() 方法作为这篇文章主线的开头：
final void attach(Context context, ActivityThread aThread,  Instrumentation instr, IBinder token, int ident,  Application application, Intent intent, ActivityInfo info,  CharSequence title, Activity parent, String id,  NonConfigurationInstances lastNonConfigurationInstances,  Configuration config, String referrer, IVoiceInteractor voiceInteractor,  Window window) {  attachBaseContext(context);  ."><title>六、View 绘制流程分析</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://guanpj.github.io/amethyst//favicon.png><link href=https://guanpj.github.io/amethyst/styles.e08ceb33360cec132feb69cfb982e2a4.min.css rel=stylesheet><link href=https://guanpj.github.io/amethyst/quartz/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://guanpj.github.io/amethyst/quartz/js/darkmode.1bc498b60ed24d8858f74f99e480db82.min.js></script>
<script src=https://guanpj.github.io/amethyst/quartz/js/util.c69e233dc1cc331a30b0f670e657b425.min.js></script>
<script async src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script async src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://guanpj.github.io/amethyst/quartz/js/popover.f03552ccb84d99ca615d1cfb9abde59e.min.js></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://guanpj.github.io/amethyst/",fetchData=Promise.all([fetch("https://guanpj.github.io/amethyst/indices/linkIndex.a0cf85a144674d956ca9db3dfb7745ab.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://guanpj.github.io/amethyst/indices/contentIndex.6e36d79b0a0d4a81007275dd2fa73365.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addCollapsibleCallouts(),initPopover("https://guanpj.github.io/amethyst",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!0;drawGraph("https://guanpj.github.io/amethyst",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script>window.Million={navigate:e=>window.location.href=e,prefetch:()=>{}},window.addEventListener("DOMContentLoaded",()=>{init(),render()})</script></head><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://guanpj.github.io/amethyst/quartz/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><header class=book-header><label for=menu-control><img src=/amethyst/svg/menu.svg class=book-icon alt=Menu></label><h1 id=page-title><a href=https://guanpj.github.io/amethyst/>guanpj's blog</a></h1><div class=spacer></div><div id=search-icon class=quartz-search><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control><main class=flex><aside class=book-menu><div class=book-menu-content><nav><div class=menu-search><div id=search-icon class=quartz-search><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div></div><ul><li><a href=/amethyst/2023-03-15/>2023 03 15</a></li><li><a href=/amethyst/2023-03-18/>2023 03 18</a></li><li><a href=/amethyst/2023-03-19/>2023 03 19</a></li><li><a href=/amethyst/2023-03-20/>2023 03 20</a></li><li><a href=/amethyst/Buttons/>Buttons</a></li><li><a href=/amethyst/ControlPanel/>Control Panel</a></li><li><a href=/amethyst/Linter/>Linter</a></li><li><a href=/amethyst/MyDraw/>My Draw</a></li><li><a href=/amethyst/%E5%85%B6%E4%BB%96%E6%A8%A1%E7%89%88/>其他模版</a></li><li><a href=/amethyst/%E5%A7%94%E6%89%98/>委托</a></li><li><a href=/amethyst/%E5%BC%95%E7%94%A8/>引用</a></li><li><a href=/amethyst/%E6%89%A9%E5%B1%95%E5%87%BD%E6%95%B0/>扩展函数</a></li><li><a href=/amethyst/%E6%8C%87%E9%92%88/>指针</a></li><li><a href=/amethyst/%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%96%87%E6%9C%AC%E6%9B%BF%E6%8D%A2/>文件读取、文本替换</a></li><li><a href=/amethyst/%E7%B1%BB%E7%9A%84%E5%AE%9A%E4%B9%89%E4%BD%BF%E7%94%A8/>类的定义、使用</a></li><li><a href=/amethyst/%E9%81%8D%E5%8E%86%E6%96%87%E4%BB%B6%E9%87%8D%E5%91%BD%E5%90%8D/>遍历文件、重命名</a></li><li><a href=/amethyst/About-Atlas/>About Atlas</a></li><li><a href=/amethyst/ADB-%E5%91%BD%E4%BB%A4/>ADB 命令</a></li><li><a href=/amethyst/Java-%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/>ADB 命令</a></li><li><a href=/amethyst/Android-%E5%AF%B9%E5%AE%B9%E5%99%A8%E7%B1%BB%E7%9A%84%E4%BC%98%E5%8C%96/>Android 对容器类的优化</a></li><li><a href=/amethyst/CAS-%E5%92%8C-AQS-%E5%8E%9F%E7%90%86/>CAS 和 AQS 原理</a></li><li><a href=/amethyst/EventBus-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>EventBus 使用及源码解析</a></li><li><a href=/amethyst/Glide-%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E5%92%8C%E7%BC%93%E5%AD%98%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/>Glide 加载流程和缓存原理分析</a></li><li><a href=/amethyst/Glide-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/>Glide 基本使用</a></li><li><a href=/amethyst/Glide-%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95/>Glide 高级用法</a></li><li><a href=/amethyst/HashMap-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>HashMap 源码解析</a></li><li><a href=/amethyst/HTTP-%E5%9F%BA%E7%A1%80/>HTTP 基础</a></li><li><a href=/amethyst/Index-for-Atlases/>Index for Atlases</a></li><li><a href=/amethyst/Index-for-Extras/>Index for Extras</a></li><li><a href=/amethyst/Java-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/>Java 内存模型</a></li><li><a href=/amethyst/JVM-%E4%B8%AD%E7%9A%84%E5%AF%B9%E8%B1%A1%E5%92%8C%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/>JVM 中的对象和垃圾回收</a></li><li><a href=/amethyst/JVM-%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F/>JVM 内存区域</a></li><li><a href=/amethyst/JVM-%E5%AD%97%E8%8A%82%E7%A0%81%E6%8C%87%E4%BB%A4%E7%AE%80%E4%BB%8B/>JVM 字节码指令简介</a></li><li><a href=/amethyst/JVM-%E5%AD%97%E8%8A%82%E7%A0%81%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/>JVM 字节码结构分析</a></li><li><a href=/amethyst/JVM-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/>JVM 类加载机制</a></li><li><a href=/amethyst/LeakCanary-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>LeakCanary 使用及源码解析</a></li><li><a href=/amethyst/MyIdeas/>MyIdeas</a></li><li><a href=/amethyst/OkHttp-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>OkHttp 使用及源码分析</a></li><li><a href=/amethyst/Retrofit-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>Retrofit 使用及源码分析</a></li><li><a href=/amethyst/RxJava-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>RxJava 使用及源码分析</a></li><li><a href=/amethyst/2023-03-22/>Troubleshooting and FAQ</a></li><li><a href=/amethyst/%E4%B8%80Binder-%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90%E6%A6%82%E5%BF%B5%E7%AF%87/>一、Binder 机制分析——概念篇</a></li><li><a href=/amethyst/%E4%B8%83View-%E4%BA%8B%E4%BB%B6%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/>七、View 事件机制分析</a></li><li><a href=/amethyst/%E4%B8%89Handler-%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/>三、Handler 原理分析</a></li><li><a href=/amethyst/%E4%BA%8CBinder-%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90%E5%BA%94%E7%94%A8%E7%AF%87/>二、Binder 机制分析——应用篇</a></li><li><a href=/amethyst/%E4%BA%8C%E5%8F%89%E6%A0%91%E9%81%8D%E5%8E%86/>二叉树遍历</a></li><li><a href=/amethyst/%E4%BA%94App-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/>五、App 启动流程分析</a></li><li><a href=/amethyst/%E5%85%ADView-%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/ class=active>六、View 绘制流程分析</a></li><li><a href=/amethyst/%E5%9B%9B%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/>四、系统启动流程分析</a></li><li><a href=/amethyst/%E5%AE%B9%E5%99%A8%E7%B1%BB/>容器类</a></li><li><a href=/amethyst/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/>并发容器</a></li><li><a href=/amethyst/%E6%B3%9B%E5%9E%8B/>泛型</a></li><li><a href=/amethyst/%E6%B3%A8%E8%A7%A3%E5%92%8C%E5%8F%8D%E5%B0%84/>注解和反射</a></li><li><a href=/amethyst/%E7%AD%89%E5%BE%85-%E9%80%9A%E7%9F%A5%E6%9C%BA%E5%88%B6/>等待-通知机制</a></li><li><a href=/amethyst/%E7%BA%BF%E7%A8%8B%E5%8D%8F%E4%BD%9C/>线程协作</a></li><li><a href=/amethyst/%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80/>线程基础</a></li><li><a href=/amethyst/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%92%8C-BlockingQueue/>线程池和 BlockingQueue</a></li><li><a href=/amethyst/%E7%BC%96%E7%A0%81%E5%8A%A0%E5%AF%86Hash%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%AD%97%E7%AC%A6%E9%9B%86/>编码、加密、Hash、序列化和字符集</a></li><li><a href=/amethyst/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84TCPIP-%E5%92%8C-HTTPS/>计算机网络体系结构、TCP&IP 和 HTTPS</a></li><li><a href=/amethyst/%E9%94%81/>锁</a></li></ul><ul><li><a href=https://github.com/64bitpandas/amethyst target=_blank rel=noopener>Github</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class="book-page container"><article class=markdown><h1 class=title>六、View 绘制流程分析</h1><p>在我的系列文章上一篇：
<a href=https://guanpj.cn/2017/10/23/Android-App-Startup-Flow-Analyze/ rel=noopener>App 竟然是这样跑起来的 —— Android App/Activity 启动流程分析</a> 中已经分析了一个 App 从点击它的图标到 Activity 的 onCreate()、onStart() 和 onResume() 等生命周期被调用的整个流程。我们都知道，普通 App 屏幕上显示的内容都是由一个个自己设计的界面被系统加载而来的，而这些界面中的元素又是怎么被渲染出来的呢？本文将继续基于 Android Nougat 从源码的角度来进一步分析整个过程。</p><p>在开始之前，回顾一下上一篇文章中分析的从 ActivityThread 到 Activity 过程的时序图：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/View-Draw/clipboard_20230323_045616.png width=auto alt></p><h1 id=一初始化-phonewindow-和-windowmanager>一：初始化 PhoneWindow 和 WindowManager
<a class=anchor href=#%e4%b8%80%e5%88%9d%e5%a7%8b%e5%8c%96-phonewindow-%e5%92%8c-windowmanager>#</a></h1><p>如上图所示，在 Activity 的 onCreate()、onStart() 和 onResume() 等生命周期被调用之前，它的 attach() 方法将会先被调用，因此，我们将 attach() 方法作为这篇文章主线的开头：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>attach</span><span style=color:#f92672>(</span>Context context<span style=color:#f92672>,</span> ActivityThread aThread<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        Instrumentation instr<span style=color:#f92672>,</span> IBinder token<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> ident<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        Application application<span style=color:#f92672>,</span> Intent intent<span style=color:#f92672>,</span> ActivityInfo info<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        CharSequence title<span style=color:#f92672>,</span> Activity parent<span style=color:#f92672>,</span> String id<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        NonConfigurationInstances lastNonConfigurationInstances<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        Configuration config<span style=color:#f92672>,</span> String referrer<span style=color:#f92672>,</span> IVoiceInteractor voiceInteractor<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        Window window<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    attachBaseContext<span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// mWindow 是一个 PhoneWindow 对象实例
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    mWindow <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> PhoneWindow<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> window<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    mWindow<span style=color:#f92672>.</span><span style=color:#a6e22e>setWindowControllerCallback</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    mWindow<span style=color:#f92672>.</span><span style=color:#a6e22e>setCallback</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    mWindow<span style=color:#f92672>.</span><span style=color:#a6e22e>setOnWindowDismissedCallback</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    mWindow<span style=color:#f92672>.</span><span style=color:#a6e22e>getLayoutInflater</span><span style=color:#f92672>().</span><span style=color:#a6e22e>setPrivateFactory</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 调用 Window 的 setWindowManager 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    mWindow<span style=color:#f92672>.</span><span style=color:#a6e22e>setWindowManager</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>(</span>WindowManager<span style=color:#f92672>)</span>context<span style=color:#f92672>.</span><span style=color:#a6e22e>getSystemService</span><span style=color:#f92672>(</span>Context<span style=color:#f92672>.</span><span style=color:#a6e22e>WINDOW_SERVICE</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>            mToken<span style=color:#f92672>,</span> mComponent<span style=color:#f92672>.</span><span style=color:#a6e22e>flattenToString</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>(</span>info<span style=color:#f92672>.</span><span style=color:#a6e22e>flags</span> <span style=color:#f92672>&amp;</span> ActivityInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>FLAG_HARDWARE_ACCELERATED</span><span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> 0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mParent <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        mWindow<span style=color:#f92672>.</span><span style=color:#a6e22e>setContainer</span><span style=color:#f92672>(</span>mParent<span style=color:#f92672>.</span><span style=color:#a6e22e>getWindow</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 从 Window 中获取 WindowManager
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    mWindowManager <span style=color:#f92672>=</span> mWindow<span style=color:#f92672>.</span><span style=color:#a6e22e>getWindowManager</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    mCurrentConfig <span style=color:#f92672>=</span> config<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>mWindow 是一个 Window 类型的变量，在 attach() 方法中，创建了一个 PhoneWindow 对象实例并赋值给了 mWindow，PhoneWindow 直接继承自 Window 类。然后调用了 Window 的 setWindowManager() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setWindowManager</span><span style=color:#f92672>(</span>WindowManager wm<span style=color:#f92672>,</span> IBinder appToken<span style=color:#f92672>,</span> String appName<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>boolean</span> hardwareAccelerated<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// mWindowManager 就是 WindowManagerImpl 对象的实例
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    mWindowManager <span style=color:#f92672>=</span> <span style=color:#f92672>((</span>WindowManagerImpl<span style=color:#f92672>)</span>wm<span style=color:#f92672>).</span><span style=color:#a6e22e>createLocalWindowManager</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>因此，Acitvity 中的 mWindow 变量就是 PhoneWindow 类的实例，而 mWindowManager 是 WindowManagerImpl 类的实例，attach() 方法的主要工作就是初始化这两个变量。</p><h1 id=二初始化-decorview>二：初始化 DecorView
<a class=anchor href=#%e4%ba%8c%e5%88%9d%e5%a7%8b%e5%8c%96-decorview>#</a></h1><h2 id=源码分析>源码分析
<a class=anchor href=#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90>#</a></h2><p>接下来到了 onCreate 方法，我们都知道，如果想要让自己设计的 layout 布局文件或者 View 显示在 Activity 中，必须要在 Activity 的 onCreate() 方法中应该调用 setContentView() 方法将我们的布局 id 或者 View 传递过去，查看其中一个 setContentView() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setContentView</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@LayoutRes</span> <span style=color:#66d9ef>int</span> layoutResID<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    getWindow<span style=color:#f92672>().</span><span style=color:#a6e22e>setContentView</span><span style=color:#f92672>(</span>layoutResID<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    initWindowDecorActionBar<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>继续查看 PhoneWindow 类的 setContentView() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setContentView</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> layoutResID<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mContentParent <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span><span style=color:#75715e>// 是否首次调用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 初始化 Decor
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        installDecor<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>hasFeature<span style=color:#f92672>(</span>FEATURE_CONTENT_TRANSITIONS<span style=color:#f92672>))</span> <span style=color:#f92672>{</span><span style=color:#75715e>// 转场动画，默认 false
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        mContentParent<span style=color:#f92672>.</span><span style=color:#a6e22e>removeAllViews</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>hasFeature<span style=color:#f92672>(</span>FEATURE_CONTENT_TRANSITIONS<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 解析布局文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        mLayoutInflater<span style=color:#f92672>.</span><span style=color:#a6e22e>inflate</span><span style=color:#f92672>(</span>layoutResID<span style=color:#f92672>,</span> mContentParent<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>如果是首次调用这个方法，则 mContentParent 为 null，否则如果没有转场动画的话就移除 mContentParent 的全部子 View，继续跟踪 installDecor() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>installDecor</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    mForceDecorInstall <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mDecor <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 生成 DecorView 对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        mDecor <span style=color:#f92672>=</span> generateDecor<span style=color:#f92672>(-</span>1<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        mDecor<span style=color:#f92672>.</span><span style=color:#a6e22e>setDescendantFocusability</span><span style=color:#f92672>(</span>ViewGroup<span style=color:#f92672>.</span><span style=color:#a6e22e>FOCUS_AFTER_DESCENDANTS</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        mDecor<span style=color:#f92672>.</span><span style=color:#a6e22e>setIsRootNamespace</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>mInvalidatePanelMenuPosted <span style=color:#f92672>&amp;&amp;</span> mInvalidatePanelMenuFeatures <span style=color:#f92672>!=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            mDecor<span style=color:#f92672>.</span><span style=color:#a6e22e>postOnAnimation</span><span style=color:#f92672>(</span>mInvalidatePanelMenuRunnable<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        mDecor<span style=color:#f92672>.</span><span style=color:#a6e22e>setWindow</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mContentParent <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 调用 generateLayout 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        mContentParent <span style=color:#f92672>=</span> generateLayout<span style=color:#f92672>(</span>mDecor<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>当 mDecor 为 null 的时候会调用 generateDecor() 方法创建一个 DecorView 类的实例，DecorView 继承自 FrameLayout。接下来判断 mContentParent 是否为 null（前面已经提到过，首次加载的时候就是 null），如果是则调用 generateLayout() 方法，这个方法就会创建 mContentParent 对象，跟踪进去：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>protected</span> ViewGroup <span style=color:#a6e22e>generateLayout</span><span style=color:#f92672>(</span>DecorView decor<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    TypedArray a <span style=color:#f92672>=</span> getWindowStyle<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 通过 WindowStyle 中设置的各种属性对 Window 进行各种初始化操作
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    mIsFloating <span style=color:#f92672>=</span> a<span style=color:#f92672>.</span><span style=color:#a6e22e>getBoolean</span><span style=color:#f92672>(</span>R<span style=color:#f92672>.</span><span style=color:#a6e22e>styleable</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Window_windowIsFloating</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> flagsToUpdate <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>FLAG_LAYOUT_IN_SCREEN<span style=color:#f92672>|</span>FLAG_LAYOUT_INSET_DECOR<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&amp;</span> <span style=color:#f92672>(~</span>getForcedWindowFlags<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mIsFloating<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        setLayout<span style=color:#f92672>(</span>WRAP_CONTENT<span style=color:#f92672>,</span> WRAP_CONTENT<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        setFlags<span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> flagsToUpdate<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        setFlags<span style=color:#f92672>(</span>FLAG_LAYOUT_IN_SCREEN<span style=color:#f92672>|</span>FLAG_LAYOUT_INSET_DECOR<span style=color:#f92672>,</span> flagsToUpdate<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>....</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> layoutResource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> features <span style=color:#f92672>=</span> getLocalFeatures<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 根据设定好的 features 值获取相应的布局文件并赋值给 layoutResource
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>features <span style=color:#f92672>&amp;</span> <span style=color:#f92672>(</span>1 <span style=color:#f92672>&lt;&lt;</span> FEATURE_SWIPE_TO_DISMISS<span style=color:#f92672>))</span> <span style=color:#f92672>!=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        layoutResource <span style=color:#f92672>=</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>layout</span><span style=color:#f92672>.</span><span style=color:#a6e22e>screen_swipe_dismiss</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>features <span style=color:#f92672>&amp;</span> <span style=color:#f92672>((</span>1 <span style=color:#f92672>&lt;&lt;</span> FEATURE_LEFT_ICON<span style=color:#f92672>)</span> <span style=color:#f92672>|</span> <span style=color:#f92672>(</span>1 <span style=color:#f92672>&lt;&lt;</span> FEATURE_RIGHT_ICON<span style=color:#f92672>)))</span> <span style=color:#f92672>!=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mIsFloating<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            TypedValue res <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TypedValue<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            getContext<span style=color:#f92672>().</span><span style=color:#a6e22e>getTheme</span><span style=color:#f92672>().</span><span style=color:#a6e22e>resolveAttribute</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                    R<span style=color:#f92672>.</span><span style=color:#a6e22e>attr</span><span style=color:#f92672>.</span><span style=color:#a6e22e>dialogTitleIconsDecorLayout</span><span style=color:#f92672>,</span> res<span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            layoutResource <span style=color:#f92672>=</span> res<span style=color:#f92672>.</span><span style=color:#a6e22e>resourceId</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            layoutResource <span style=color:#f92672>=</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>layout</span><span style=color:#f92672>.</span><span style=color:#a6e22e>screen_title_icons</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        removeFeature<span style=color:#f92672>(</span>FEATURE_ACTION_BAR<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>features <span style=color:#f92672>&amp;</span> <span style=color:#f92672>((</span>1 <span style=color:#f92672>&lt;&lt;</span> FEATURE_PROGRESS<span style=color:#f92672>)</span> <span style=color:#f92672>|</span> <span style=color:#f92672>(</span>1 <span style=color:#f92672>&lt;&lt;</span> FEATURE_INDETERMINATE_PROGRESS<span style=color:#f92672>)))</span> <span style=color:#f92672>!=</span> 0
</span></span><span style=display:flex><span>            <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>(</span>features <span style=color:#f92672>&amp;</span> <span style=color:#f92672>(</span>1 <span style=color:#f92672>&lt;&lt;</span> FEATURE_ACTION_BAR<span style=color:#f92672>))</span> <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        layoutResource <span style=color:#f92672>=</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>layout</span><span style=color:#f92672>.</span><span style=color:#a6e22e>screen_progress</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>features <span style=color:#f92672>&amp;</span> <span style=color:#f92672>(</span>1 <span style=color:#f92672>&lt;&lt;</span> FEATURE_CUSTOM_TITLE<span style=color:#f92672>))</span> <span style=color:#f92672>!=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mIsFloating<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            TypedValue res <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TypedValue<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            getContext<span style=color:#f92672>().</span><span style=color:#a6e22e>getTheme</span><span style=color:#f92672>().</span><span style=color:#a6e22e>resolveAttribute</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                    R<span style=color:#f92672>.</span><span style=color:#a6e22e>attr</span><span style=color:#f92672>.</span><span style=color:#a6e22e>dialogCustomTitleDecorLayout</span><span style=color:#f92672>,</span> res<span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            layoutResource <span style=color:#f92672>=</span> res<span style=color:#f92672>.</span><span style=color:#a6e22e>resourceId</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            layoutResource <span style=color:#f92672>=</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>layout</span><span style=color:#f92672>.</span><span style=color:#a6e22e>screen_custom_title</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        removeFeature<span style=color:#f92672>(</span>FEATURE_ACTION_BAR<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>features <span style=color:#f92672>&amp;</span> <span style=color:#f92672>(</span>1 <span style=color:#f92672>&lt;&lt;</span> FEATURE_NO_TITLE<span style=color:#f92672>))</span> <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mIsFloating<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            TypedValue res <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TypedValue<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            getContext<span style=color:#f92672>().</span><span style=color:#a6e22e>getTheme</span><span style=color:#f92672>().</span><span style=color:#a6e22e>resolveAttribute</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                    R<span style=color:#f92672>.</span><span style=color:#a6e22e>attr</span><span style=color:#f92672>.</span><span style=color:#a6e22e>dialogTitleDecorLayout</span><span style=color:#f92672>,</span> res<span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            layoutResource <span style=color:#f92672>=</span> res<span style=color:#f92672>.</span><span style=color:#a6e22e>resourceId</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>features <span style=color:#f92672>&amp;</span> <span style=color:#f92672>(</span>1 <span style=color:#f92672>&lt;&lt;</span> FEATURE_ACTION_BAR<span style=color:#f92672>))</span> <span style=color:#f92672>!=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            layoutResource <span style=color:#f92672>=</span> a<span style=color:#f92672>.</span><span style=color:#a6e22e>getResourceId</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                    R<span style=color:#f92672>.</span><span style=color:#a6e22e>styleable</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Window_windowActionBarFullscreenDecorLayout</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                    R<span style=color:#f92672>.</span><span style=color:#a6e22e>layout</span><span style=color:#f92672>.</span><span style=color:#a6e22e>screen_action_bar</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            layoutResource <span style=color:#f92672>=</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>layout</span><span style=color:#f92672>.</span><span style=color:#a6e22e>screen_title</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>features <span style=color:#f92672>&amp;</span> <span style=color:#f92672>(</span>1 <span style=color:#f92672>&lt;&lt;</span> FEATURE_ACTION_MODE_OVERLAY<span style=color:#f92672>))</span> <span style=color:#f92672>!=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        layoutResource <span style=color:#f92672>=</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>layout</span><span style=color:#f92672>.</span><span style=color:#a6e22e>screen_simple_overlay_action_mode</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        layoutResource <span style=color:#f92672>=</span> R<span style=color:#f92672>.</span><span style=color:#a6e22e>layout</span><span style=color:#f92672>.</span><span style=color:#a6e22e>screen_simple</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    mDecor<span style=color:#f92672>.</span><span style=color:#a6e22e>startChanging</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 调用 onResourcesLoaded 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    mDecor<span style=color:#f92672>.</span><span style=color:#a6e22e>onResourcesLoaded</span><span style=color:#f92672>(</span>mLayoutInflater<span style=color:#f92672>,</span> layoutResource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 在 layoutResource 中根据 id:com.android.internal.R.id.content 获取一个 ViewGroup 并赋值给 contentParent  对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    ViewGroup contentParent <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>ViewGroup<span style=color:#f92672>)</span>findViewById<span style=color:#f92672>(</span>ID_ANDROID_CONTENT<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>contentParent <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Window couldn&#39;t find content container view&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    mDecor<span style=color:#f92672>.</span><span style=color:#a6e22e>finishChanging</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 返回 contentParent
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> contentParent<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>DecorView 的 onResourcesLoaded() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onResourcesLoaded</span><span style=color:#f92672>(</span>LayoutInflater inflater<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> layoutResource<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    mDecorCaptionView <span style=color:#f92672>=</span> createDecorCaptionView<span style=color:#f92672>(</span>inflater<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 解析 layoutResource 文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>final</span> View root <span style=color:#f92672>=</span> inflater<span style=color:#f92672>.</span><span style=color:#a6e22e>inflate</span><span style=color:#f92672>(</span>layoutResource<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mDecorCaptionView <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 作为根布局添加到 mDecor 中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        addView<span style=color:#f92672>(</span>root<span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> ViewGroup<span style=color:#f92672>.</span><span style=color:#a6e22e>LayoutParams</span><span style=color:#f92672>(</span>MATCH_PARENT<span style=color:#f92672>,</span> MATCH_PARENT<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    mContentRoot <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>ViewGroup<span style=color:#f92672>)</span> root<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    initializeElevation<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到，generateLayout() 方法主要分为四个部分：</p><ol><li>首先会通过 com.android.internal.R.styleable.Window 中设置的各种属性对 Window 进行各 requestFeature 或者 setFlags 等操作。</li><li>接下来是根据设定好的 features 值选择不同的窗口修饰布局文件，得到 layoutResource 值。</li></ol><blockquote><p>因此在自己的 Activity 中设置全屏的 requestFeature() 等方法也需要在 setContentView 之前调用，才能够根据你的设置来选择不同的根布局。</p></blockquote><ol start=3><li>将 layoutResource 值传给 DecorView 的 onResourcesLoaded() 方法，通过 LayoutInflater 把布局转化成 View 作为根视图并将其添加到 mDecor。</li><li>在 mDecor 中查找 id 为 com.android.internal.R.id.content 的 ViewGroup 并作为返回值返回，这个 ViewGroup 一般为 FrameLayout。</li></ol><p>关于第四点，可能有人会有疑问，为什么根据 id 为 com.android.internal.R.id.content 就一定能找到对应的 ViewGroup？答案就在前面我们分析过的 generateLayout() 方法中，这里会根据设定好的 features 值获取相应的布局文件并赋值给 layoutResource，而这所有的布局文件中都包括了一个 id 为 content 的 FrameLayout，除此之外有些布局文件中还可能有 ActiionBar 和 Title 等，这些布局文件存放于 [该目录下](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /nougat-release/core/res/res/layout/)。以 R.layout.screen_simple 为例，它的内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;LinearLayout</span> <span style=color:#a6e22e>xmlns:android=</span><span style=color:#e6db74>&#34;http://schemas.android.com/apk/res/android&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>android:layout_width=</span><span style=color:#e6db74>&#34;match_parent&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>android:layout_height=</span><span style=color:#e6db74>&#34;match_parent&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>android:fitsSystemWindows=</span><span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>android:orientation=</span><span style=color:#e6db74>&#34;vertical&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;ViewStub</span> <span style=color:#a6e22e>android:id=</span><span style=color:#e6db74>&#34;@+id/action_mode_bar_stub&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>android:inflatedId=</span><span style=color:#e6db74>&#34;@+id/action_mode_bar&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>android:layout=</span><span style=color:#e6db74>&#34;@layout/action_mode_bar&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>android:layout_width=</span><span style=color:#e6db74>&#34;match_parent&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>android:layout_height=</span><span style=color:#e6db74>&#34;wrap_content&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>android:theme=</span><span style=color:#e6db74>&#34;?attr/actionBarTheme&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;FrameLayout</span>
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>android:id=</span><span style=color:#e6db74>&#34;@android:id/content&#34;</span>
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>android:layout_width=</span><span style=color:#e6db74>&#34;match_parent&#34;</span>
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>android:layout_height=</span><span style=color:#e6db74>&#34;match_parent&#34;</span>
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>android:foregroundInsidePadding=</span><span style=color:#e6db74>&#34;false&#34;</span>
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>android:foregroundGravity=</span><span style=color:#e6db74>&#34;fill_horizontal|top&#34;</span>
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>android:foreground=</span><span style=color:#e6db74>&#34;?android:attr/windowContentOverlay&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/LinearLayout&gt;</span>
</span></span></code></pre></div><p>回到 PhoneWindow 的 setContentView() 方法，执行完 installDecor() 之后，mDecor 被初始化了，同时 mContentParent 也被赋了值， 回到 setContentView() 方法，最后一个重要步骤就是通过 mLayoutInflater.inflater 将我们的 layout 布局文件压入 mDecor 中 id 为 content 的 FrameLayout 中。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setContentView</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> layoutResID<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mContentParent <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span><span style=color:#75715e>// 是否首次调用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 初始化 Decor
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        installDecor<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>hasFeature<span style=color:#f92672>(</span>FEATURE_CONTENT_TRANSITIONS<span style=color:#f92672>))</span> <span style=color:#f92672>{</span><span style=color:#75715e>// 转场动画，默认 false
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        mContentParent<span style=color:#f92672>.</span><span style=color:#a6e22e>removeAllViews</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>hasFeature<span style=color:#f92672>(</span>FEATURE_CONTENT_TRANSITIONS<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 解析布局文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        mLayoutInflater<span style=color:#f92672>.</span><span style=color:#a6e22e>inflate</span><span style=color:#f92672>(</span>layoutResID<span style=color:#f92672>,</span> mContentParent<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=小结>小结
<a class=anchor href=#%e5%b0%8f%e7%bb%93>#</a></h2><p>至此，setContentView() 方法的流程就走完了，总体来看分为三个步骤：</p><ol><li>初始化 mDecor，它是 DecorView 类的实例，DecorView 继承自 FrameLayout；</li><li>根据 theme 中的属性值，选择相应的布局文件并通过 infalter.inflater() 方法将它加载出来并 add 到 mDecor 中；这些布局文件都有一个 id 为 content 的 FrameLayout；</li><li>在 Activity 的 setContentView() 方法中设置的 layout 布局文件，会通过 mLayoutInflater.inflater() 压入 mDecor 中 id 为 content 的 FrameLayout 中。</li></ol><p>这个过程的时序图如下：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/View-Draw/clipboard_20230323_045625.png width=auto alt></p><p>Activity、PhoneWindow、DecorView 和 ContentView 的关系如下图所示：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/View-Draw/clipboard_20230323_045628.png width=auto alt></p><p>但是，此时我们的布局还没有显示出来，接着往下看。</p><h1 id=三初始化-viewrootimpl-并关联-decorview>三：初始化 ViewRootImpl 并关联 DecorView
<a class=anchor href=#%e4%b8%89%e5%88%9d%e5%a7%8b%e5%8c%96-viewrootimpl-%e5%b9%b6%e5%85%b3%e8%81%94-decorview>#</a></h1><h2 id=源码分析-1>源码分析
<a class=anchor href=#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90-1>#</a></h2><p>在开篇的时序图中我们可以看到，ActivityThread 在 handleLaunchActivity() 方法中的 performLaunchActivity() 操作间接调用了 Activity 的 attach() 和 onCreate()：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handleLaunchActivity</span><span style=color:#f92672>(</span>ActivityClientRecord r<span style=color:#f92672>,</span> Intent customIntent<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    WindowManagerGlobal<span style=color:#f92672>.</span><span style=color:#a6e22e>initialize</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 执行 performLaunchActivity 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Activity a <span style=color:#f92672>=</span> performLaunchActivity<span style=color:#f92672>(</span>r<span style=color:#f92672>,</span> customIntent<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>a <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        r<span style=color:#f92672>.</span><span style=color:#a6e22e>createdConfig</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Configuration<span style=color:#f92672>(</span>mConfiguration<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        Bundle oldState <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>state</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 执行 handleResumeActivity 方法，最终调用 onStart 和 onResume 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        handleResumeActivity<span style=color:#f92672>(</span>r<span style=color:#f92672>.</span><span style=color:#a6e22e>token</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>,</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>isForward</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>!</span>r<span style=color:#f92672>.</span><span style=color:#a6e22e>activity</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mFinished</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>r<span style=color:#f92672>.</span><span style=color:#a6e22e>startsNotResumed</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>r<span style=color:#f92672>.</span><span style=color:#a6e22e>activity</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mFinished</span> <span style=color:#f92672>&amp;&amp;</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>startsNotResumed</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            r<span style=color:#f92672>.</span><span style=color:#a6e22e>activity</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mCalled</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            mInstrumentation<span style=color:#f92672>.</span><span style=color:#a6e22e>callActivityOnPause</span><span style=color:#f92672>(</span>r<span style=color:#f92672>.</span><span style=color:#a6e22e>activity</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            r<span style=color:#f92672>.</span><span style=color:#a6e22e>paused</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 停止该 Activity
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        ActivityManagerNative<span style=color:#f92672>.</span><span style=color:#a6e22e>getDefault</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>.</span><span style=color:#a6e22e>finishActivity</span><span style=color:#f92672>(</span>r<span style=color:#f92672>.</span><span style=color:#a6e22e>token</span><span style=color:#f92672>,</span> Activity<span style=color:#f92672>.</span><span style=color:#a6e22e>RESULT_CANCELED</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>接着会调用 handleResumeActivity() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handleResumeActivity</span><span style=color:#f92672>(</span>IBinder token<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>boolean</span> clearHide<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> isForward<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> reallyResume<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> seq<span style=color:#f92672>,</span> String reason<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    ActivityClientRecord r <span style=color:#f92672>=</span> mActivities<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>token<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 最终会调用 onStart() 和 onResume() 等方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    r <span style=color:#f92672>=</span> performResumeActivity<span style=color:#f92672>(</span>token<span style=color:#f92672>,</span> clearHide<span style=color:#f92672>,</span> reason<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>r <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> Activity a <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>activity</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>r<span style=color:#f92672>.</span><span style=color:#a6e22e>window</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>a<span style=color:#f92672>.</span><span style=color:#a6e22e>mFinished</span> <span style=color:#f92672>&amp;&amp;</span> willBeVisible<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            r<span style=color:#f92672>.</span><span style=color:#a6e22e>window</span> <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>activity</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getWindow</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 获取 DecorView 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            View decor <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>window</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getDecorView</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 将 DecorView 设置成不可见
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            decor<span style=color:#f92672>.</span><span style=color:#a6e22e>setVisibility</span><span style=color:#f92672>(</span>View<span style=color:#f92672>.</span><span style=color:#a6e22e>INVISIBLE</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 获取 ViewManager，这里是 WindowManagerImpl 实例
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            ViewManager wm <span style=color:#f92672>=</span> a<span style=color:#f92672>.</span><span style=color:#a6e22e>getWindowManager</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            WindowManager<span style=color:#f92672>.</span><span style=color:#a6e22e>LayoutParams</span> l <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>window</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getAttributes</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            a<span style=color:#f92672>.</span><span style=color:#a6e22e>mDecor</span> <span style=color:#f92672>=</span> decor<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            l<span style=color:#f92672>.</span><span style=color:#a6e22e>type</span> <span style=color:#f92672>=</span> WindowManager<span style=color:#f92672>.</span><span style=color:#a6e22e>LayoutParams</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TYPE_BASE_APPLICATION</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            l<span style=color:#f92672>.</span><span style=color:#a6e22e>softInputMode</span> <span style=color:#f92672>|=</span> forwardBit<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>a<span style=color:#f92672>.</span><span style=color:#a6e22e>mVisibleFromClient</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>a<span style=color:#f92672>.</span><span style=color:#a6e22e>mWindowAdded</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 标记设置为 true
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                a<span style=color:#f92672>.</span><span style=color:#a6e22e>mWindowAdded</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 调用 WindowManagerImpl 的 addView 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                wm<span style=color:#f92672>.</span><span style=color:#a6e22e>addView</span><span style=color:#f92672>(</span>decor<span style=color:#f92672>,</span> l<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> 
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>willBeVisible<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>r<span style=color:#f92672>.</span><span style=color:#a6e22e>activity</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mFinished</span> <span style=color:#f92672>&amp;&amp;</span> willBeVisible
</span></span><span style=display:flex><span>                <span style=color:#f92672>&amp;&amp;</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>activity</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mDecor</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>r<span style=color:#f92672>.</span><span style=color:#a6e22e>hideForNow</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>r<span style=color:#f92672>.</span><span style=color:#a6e22e>activity</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mVisibleFromClient</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 调用 makeVisible 方法将 DecorView 设置为可见
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                r<span style=color:#f92672>.</span><span style=color:#a6e22e>activity</span><span style=color:#f92672>.</span><span style=color:#a6e22e>makeVisible</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 在此过程出现异常，则直接杀死 Activity
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            ActivityManagerNative<span style=color:#f92672>.</span><span style=color:#a6e22e>getDefault</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>finishActivity</span><span style=color:#f92672>(</span>token<span style=color:#f92672>,</span> Activity<span style=color:#f92672>.</span><span style=color:#a6e22e>RESULT_CANCELED</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                        Activity<span style=color:#f92672>.</span><span style=color:#a6e22e>DONT_FINISH_TASK_WITH_ACTIVITY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>RemoteException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> ex<span style=color:#f92672>.</span><span style=color:#a6e22e>rethrowFromSystemServer</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>执行完 performResumeActivity() 方法之后，接着会取出 ActivityClientRecord 中的 Activity 对象，并得到之前在 setContentView 流程中初始化好的 DecorView 对象，然后会将它作为参数传入 ViewManager 类型的对象 wm 的 addView 方法，ViewManager 是一个接口，那么它是由谁来实现的呢？</p><p>其实这就是文章开头部分提到过的，在 Activity 的 attach() 方法中，会初始化 PhoneWindow 和 WindowManager 对象，而这个 WindowManager 对象则是由 WindowManagerImpl 来实现的。</p><p>所以，Activity 的 getWindowManager() 此时获取到的就是 WindowManagerImpl 对象的实例，再看它的 addView() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>addView</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> View view<span style=color:#f92672>,</span> <span style=color:#a6e22e>@NonNull</span> ViewGroup<span style=color:#f92672>.</span><span style=color:#a6e22e>LayoutParams</span> params<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    applyDefaultToken<span style=color:#f92672>(</span>params<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// mGlobal 是 WindowManagerGlobal 对象的实例
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    mGlobal<span style=color:#f92672>.</span><span style=color:#a6e22e>addView</span><span style=color:#f92672>(</span>view<span style=color:#f92672>,</span> params<span style=color:#f92672>,</span> mContext<span style=color:#f92672>.</span><span style=color:#a6e22e>getDisplay</span><span style=color:#f92672>(),</span> mParentWindow<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这里将任务委托给了 mGlobal ，而它又是 WindowManagerGlobal 对象的实例，查看它的 addView() 方法：</p><p><a href=https://android.googlesource.com/platform/frameworks/base/+/refs/heads/nougat-release/core/java/android/view/WindowManagerGlobal.java rel=noopener>core/java/android/view/WindowManagerGlobal.java</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>addView</span><span style=color:#f92672>(</span>View view<span style=color:#f92672>,</span> ViewGroup<span style=color:#f92672>.</span><span style=color:#a6e22e>LayoutParams</span> params<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        Display display<span style=color:#f92672>,</span> Window parentWindow<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> WindowManager<span style=color:#f92672>.</span><span style=color:#a6e22e>LayoutParams</span> wparams <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>WindowManager<span style=color:#f92672>.</span><span style=color:#a6e22e>LayoutParams</span><span style=color:#f92672>)</span> params<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>parentWindow <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        parentWindow<span style=color:#f92672>.</span><span style=color:#a6e22e>adjustLayoutParamsForSubWindow</span><span style=color:#f92672>(</span>wparams<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// If there&#39;s no parent, then hardware acceleration for this view is
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// set from the application&#39;s hardware acceleration setting.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>final</span> Context context <span style=color:#f92672>=</span> view<span style=color:#f92672>.</span><span style=color:#a6e22e>getContext</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>context <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>               <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>(</span>context<span style=color:#f92672>.</span><span style=color:#a6e22e>getApplicationInfo</span><span style=color:#f92672>().</span><span style=color:#a6e22e>flags</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&amp;</span> ApplicationInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>FLAG_HARDWARE_ACCELERATED</span><span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            wparams<span style=color:#f92672>.</span><span style=color:#a6e22e>flags</span> <span style=color:#f92672>|=</span> WindowManager<span style=color:#f92672>.</span><span style=color:#a6e22e>LayoutParams</span><span style=color:#f92672>.</span><span style=color:#a6e22e>FLAG_HARDWARE_ACCELERATED</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    ViewRootImpl root<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    View panelParentView <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span>mLock<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 创建 ViewRootImpl
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        root <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ViewRootImpl<span style=color:#f92672>(</span>view<span style=color:#f92672>.</span><span style=color:#a6e22e>getContext</span><span style=color:#f92672>(),</span> display<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        view<span style=color:#f92672>.</span><span style=color:#a6e22e>setLayoutParams</span><span style=color:#f92672>(</span>wparams<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        mViews<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>view<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        mRoots<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>root<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        mParams<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>wparams<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 将传过来的 DecorView 添加到 ViewRootImpl 中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        root<span style=color:#f92672>.</span><span style=color:#a6e22e>setView</span><span style=color:#f92672>(</span>view<span style=color:#f92672>,</span> wparams<span style=color:#f92672>,</span> panelParentView<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>RuntimeException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>上面的变量中，mViews 存储的是所有 Window 对应的 View，mRoots 存储的是所有 Window 对应的 ViewRootImpl 对象，mParams 存储的是所有 Window 对应的布局参数。</p><h2 id=小结-1>小结
<a class=anchor href=#%e5%b0%8f%e7%bb%93-1>#</a></h2><p>可以看到，ViewRootImpl 是 DecorView 的管理者，它负责 View Tree 的测量、布局和绘制，以及后面会说到的通过 Choreographer 来控制 View Tree 的刷新操作。</p><h1 id=四建立-phonewindow-和-windowmanagerservice-之间的连接>四：建立 PhoneWindow 和 WindowManagerService 之间的连接
<a class=anchor href=#%e5%9b%9b%e5%bb%ba%e7%ab%8b-phonewindow-%e5%92%8c-windowmanagerservice-%e4%b9%8b%e9%97%b4%e7%9a%84%e8%bf%9e%e6%8e%a5>#</a></h1><p>WMS 是所有 Window 窗口的管理员，负责 Window 的添加和删除、Surface 的管理和事件的派发等等，因此每一个 Activity 中的 PhoneWindow 对象如果需要显示等操作，就必须通过与 WMS 的交互才能进行。</p><h2 id=源码分析-2>源码分析
<a class=anchor href=#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90-2>#</a></h2><p>接着上一个步骤的流程，查看 ViewRootImpl 的 setView 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setView</span><span style=color:#f92672>(</span>View view<span style=color:#f92672>,</span> WindowManager<span style=color:#f92672>.</span><span style=color:#a6e22e>LayoutParams</span> attrs<span style=color:#f92672>,</span> View panelParentView<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mView <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            mView <span style=color:#f92672>=</span> view<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            requestLayout<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 2
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                res <span style=color:#f92672>=</span> mWindowSession<span style=color:#f92672>.</span><span style=color:#a6e22e>addToDisplay</span><span style=color:#f92672>(</span>mWindow<span style=color:#f92672>,</span> mSeq<span style=color:#f92672>,</span> mWindowAttributes<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                      getHostVisibility<span style=color:#f92672>(),</span> mDisplay<span style=color:#f92672>.</span><span style=color:#a6e22e>getDisplayId</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>                      mAttachInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>mContentInsets</span><span style=color:#f92672>,</span> mAttachInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>mStableInsets</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                      mAttachInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>mOutsets</span><span style=color:#f92672>,</span> mInputChannel<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>RemoteException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>restore<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    attrs<span style=color:#f92672>.</span><span style=color:#a6e22e>restore</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>            view<span style=color:#f92672>.</span><span style=color:#a6e22e>assignParent</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>忽略 requestLayout 方法，先看注释 2 处：这里调用了 mWindowSession.addToDisplay() 方法来完成最终的添加流程，mWindowSession 为 IWindowSession 的实例，而 IWindowSession 是一个 Binder 的 Client 代理对象，对应的 Server 端的实现为 Session 类。在这之前代码都是运行在 app 进程的，而 Session 则是运行在 WMS 所在的进程（即 SystemServer 进程）中。</p><p>如此，往 Window 中添加 View 的流程就交给 WindowManagerService 去处理了，app 进程的 ViewRootImpl 要想和 WMS 通讯则需要借助 Binder 机制并通过 Session 来进行操作。Session 的 addToDisplay() 方法如下：</p><p>[services/core/java/com/android/server/wm/Session.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /refs/heads/nougat-release/services/core/java/com/android/server/wm/Session.java)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>addToDisplay</span><span style=color:#f92672>(</span>IWindow window<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> seq<span style=color:#f92672>,</span> WindowManager<span style=color:#f92672>.</span><span style=color:#a6e22e>LayoutParams</span> attrs<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> viewVisibility<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> displayId<span style=color:#f92672>,</span> Rect outContentInsets<span style=color:#f92672>,</span> Rect outStableInsets<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        Rect outOutsets<span style=color:#f92672>,</span> InputChannel outInputChannel<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> mService<span style=color:#f92672>.</span><span style=color:#a6e22e>addWindow</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> window<span style=color:#f92672>,</span> seq<span style=color:#f92672>,</span> attrs<span style=color:#f92672>,</span> viewVisibility<span style=color:#f92672>,</span> displayId<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            outContentInsets<span style=color:#f92672>,</span> outStableInsets<span style=color:#f92672>,</span> outOutsets<span style=color:#f92672>,</span> outInputChannel<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到，这里调用了 WMS 的 addWindow() 方法并将自身作为参数传了进去，每个应用程序都会对应一个 Session，WMS 会用一个 List 来保存这些 Session。接着 WMS 会为这个添加的窗口分配 Surface，并确定窗口显示次序，因此负责显示界面的是画布 Surface，而不是窗口本身。WMS 会将它管理的 Surface 交由 SurfaceFlinger 处理，SurfaceFlinger 会将这些 Surface 混合并绘制到屏幕上。</p><p>关于 WMS 的详细分析会在后续的文章中进行。</p><p>这个是一个典型的 Binder 双向通讯模型，Binder 机制的文章可参考
<a href=https://www.jianshu.com/p/73e351d25773 rel=noopener>借助 AIDL 理解 Android Binder 机制</a>。这个过程如下图所示：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/View-Draw/clipboard_20230323_045637.png width=auto alt></p><h2 id=小结-2>小结
<a class=anchor href=#%e5%b0%8f%e7%bb%93-2>#</a></h2><p>用一张图总结 Activity、Window 和 WMS 之间的关系：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/View-Draw/clipboard_20230323_045640.png width=auto alt></p><h1 id=五建立与-surfaceflinger-的连接>五：建立与 SurfaceFlinger 的连接
<a class=anchor href=#%e4%ba%94%e5%bb%ba%e7%ab%8b%e4%b8%8e-surfaceflinger-%e7%9a%84%e8%bf%9e%e6%8e%a5>#</a></h1><p>SurfaceFlinger 是 Android 最重要的系统服务之一，它的职责主要是进行 Layer(Surface 在 Native 叫法) 的合成和渲染。</p><h2 id=源码分析-3>源码分析
<a class=anchor href=#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90-3>#</a></h2><p>接上面的步骤，WindowState 的 attach() 方法将会调用到 Session 的 windowAddedLocked() 方法：</p><p>[services/core/java/com/android/server/wm/WindowState.java](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /refs/heads/nougat-release/services/core/java/com/android/server/wm/WindowState.java)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>attach</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>WindowManagerService<span style=color:#f92672>.</span><span style=color:#a6e22e>localLOGV</span><span style=color:#f92672>)</span> Slog<span style=color:#f92672>.</span><span style=color:#a6e22e>v</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Attaching &#34;</span> <span style=color:#f92672>+</span> <span style=color:#66d9ef>this</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; token=&#34;</span> <span style=color:#f92672>+</span> mToken
</span></span><span style=display:flex><span>        <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;, list=&#34;</span> <span style=color:#f92672>+</span> mToken<span style=color:#f92672>.</span><span style=color:#a6e22e>windows</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    mSession<span style=color:#f92672>.</span><span style=color:#a6e22e>windowAddedLocked</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Session.java</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>windowAddedLocked</span><span style=color:#f92672>(</span>String packageName<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mSurfaceSession <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span> 
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        mSurfaceSession <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SurfaceSession<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SurfaceSession</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>long</span> mNativeClient<span style=color:#f92672>;</span> <span style=color:#75715e>// SurfaceComposerClient*
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>native</span> <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>nativeCreate</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>SurfaceSession</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        mNativeClient <span style=color:#f92672>=</span> nativeCreate<span style=color:#f92672>();</span> 
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>nativeCreate() 方法是一个 native 方法：</p><p>[core/jni/android_view_SurfaceSession.cpp](
<a href=https://android.googlesource.com/platform/frameworks/base/ rel=noopener>https://android.googlesource.com/platform/frameworks/base/</a> /refs/heads/nougat-release/core/jni/android_view_SurfaceSession.cpp)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>static</span> jlong <span style=color:#a6e22e>nativeCreate</span>(JNIEnv<span style=color:#f92672>*</span> env, jclass clazz) {
</span></span><span style=display:flex><span>    SurfaceComposerClient<span style=color:#f92672>*</span> client <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SurfaceComposerClient();
</span></span><span style=display:flex><span>    client<span style=color:#f92672>-&gt;</span>incStrong((<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>)nativeCreate);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>reinterpret_cast</span><span style=color:#f92672>&lt;</span>jlong<span style=color:#f92672>&gt;</span>(client);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>nativeCreate 方法主要构造了一个 SurfaceComposerClient 对象，它是应用程序与 SurfaceFlinger 沟通的桥梁，SurfaceComposerClient 指针在第一次使用的时候会调用以下方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>void</span> SurfaceComposerClient<span style=color:#f92672>::</span>onFirstRef() {
</span></span><span style=display:flex><span>    ....
</span></span><span style=display:flex><span>    sp<span style=color:#f92672>&lt;</span>ISurfaceComposerClient<span style=color:#f92672>&gt;</span> conn;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// sf 就是 SurfaceFlinger 对象指针
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    conn <span style=color:#f92672>=</span> (rootProducer <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nullptr</span>) <span style=color:#f92672>?</span> sf<span style=color:#f92672>-&gt;</span>createScopedConnection(rootProducer) <span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            sf<span style=color:#f92672>-&gt;</span>createConnection();
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>它通过 SurfaceFlinger 的 createScopedConnection 方法创建了一个 ISurfaceComposerClient 对象：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>SurfaceFlinger.cpp
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sp<span style=color:#f92672>&lt;</span>ISurfaceComposerClient<span style=color:#f92672>&gt;</span> SurfaceFlinger<span style=color:#f92672>::</span>createConnection() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>initClient</span>(<span style=color:#66d9ef>new</span> Client(<span style=color:#66d9ef>this</span>)); 
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> sp<span style=color:#f92672>&lt;</span>ISurfaceComposerClient<span style=color:#f92672>&gt;</span> initClient(<span style=color:#66d9ef>const</span> sp<span style=color:#f92672>&lt;</span>Client<span style=color:#f92672>&gt;&amp;</span> client) {
</span></span><span style=display:flex><span>    status_t err <span style=color:#f92672>=</span> client<span style=color:#f92672>-&gt;</span>initCheck();
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 只是做了错误检查，然后返回 client 本身
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (err <span style=color:#f92672>==</span> NO_ERROR) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> client;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nullptr</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Client 类实现了 ISurfaceComposerClient(继承了 IInterface) 接口，因此它可以进行跨进程通信，SurfaceComposerClient 就是通过它来和 SurfaceFlinger 通信。除此之外它还可以创建 Surface，并且维护一个应用程序的所有 Layer。</p><p>initClicent 方法做了一些错误检查，然后返回 Client 本身。</p><h2 id=小结-3>小结
<a class=anchor href=#%e5%b0%8f%e7%bb%93-3>#</a></h2><p>这个过程如下图：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/View-Draw/clipboard_20230323_045645.png width=auto alt></p><h1 id=六申请-surface>六：申请 Surface
<a class=anchor href=#%e5%85%ad%e7%94%b3%e8%af%b7-surface>#</a></h1><p>经过步骤四和步骤五，ViewRootImpl 与 WMS、SurfaceFlinger 都已经建立连接，但是这时 View 还是没有显示出来。我们都知道，所有的 UI 最终都是要通过 Surface 来显示的，那么 Surface 是什么时候创建的呢？回到步骤四开头部分 ViewRootImpl 的 setView 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setView</span><span style=color:#f92672>(</span>View view<span style=color:#f92672>,</span> WindowManager<span style=color:#f92672>.</span><span style=color:#a6e22e>LayoutParams</span> attrs<span style=color:#f92672>,</span> View panelParentView<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mView <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            mView <span style=color:#f92672>=</span> view<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Schedule the first layout -before- adding to the window
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// manager, to make sure we do the relayout before receiving
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// any other events from the system.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            requestLayout<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>                res <span style=color:#f92672>=</span> mWindowSession<span style=color:#f92672>.</span><span style=color:#a6e22e>addToDisplay</span><span style=color:#f92672>(</span>mWindow<span style=color:#f92672>,</span> mSeq<span style=color:#f92672>,</span> mWindowAttributes<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                        getHostVisibility<span style=color:#f92672>(),</span> mDisplay<span style=color:#f92672>.</span><span style=color:#a6e22e>getDisplayId</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>                        mAttachInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>mContentInsets</span><span style=color:#f92672>,</span> mAttachInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>mStableInsets</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                        mAttachInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>mOutsets</span><span style=color:#f92672>,</span> mInputChannel<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> 
</span></span><span style=display:flex><span>            <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>注释处保留了官方原文，意思大概是 WMS 除了窗口管理，还需要处理事件派发，因此在与 WMS 进行关联之前，要确保 View Tree 已经进行了 layout 操作，以接收来自 WMS 的事件。</p><p>跟踪 ViewRootImpl 的 requestLayout() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>requestLayout</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>mHandlingLayoutInLayoutRequest<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        checkThread<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        mLayoutRequested <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        scheduleTraversals<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>scheduleTraversals() 方法如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>scheduleTraversals</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>mTraversalScheduled<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        mTraversalScheduled <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 设置同步障碍，暂停处理后面的同步消息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        mTraversalBarrier <span style=color:#f92672>=</span> mHandler<span style=color:#f92672>.</span><span style=color:#a6e22e>getLooper</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getQueue</span><span style=color:#f92672>().</span><span style=color:#a6e22e>postSyncBarrier</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 在下一帧到来的时候执行 mTraversalRunnable
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        mChoreographer<span style=color:#f92672>.</span><span style=color:#a6e22e>postCallback</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                Choreographer<span style=color:#f92672>.</span><span style=color:#a6e22e>CALLBACK_TRAVERSAL</span><span style=color:#f92672>,</span> mTraversalRunnable<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>首先，设置同步障碍，暂停处理后面的同步消息，然后利用 Choreographer 类在下一绘制帧来临的时候执行 mTraversalRunnable 对象（关于 Choreographer 原理，可查看
<a href=https://blog.csdn.net/yangwen123/article/details/39518923 rel=noopener>Android 系统 Choreographer 机制实现过程</a>）。</p><p>简单地说，Choreographer 内部会接收来自 SurfaceFlinger 发出的 VSync 垂直同步信号，这个信号周期一般为 16ms 左右。SurfaceFlinger 是由 init 进程启动的运行在底层的一个系统进程，它的主要职责是合成和渲染 Surface(Layer)，并向目标进程发送垂直同步信号 VSync。因此，如果需要接收 Vsync 信号，必须先与 SurfaceFlinger 建立连接，而这正是先走步骤五流程的原因。</p><p>mTraversalRunnable 是一个 Runnable 对象：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TraversalRunnable</span> <span style=color:#66d9ef>implements</span> Runnable <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        doTraversal<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>final</span> TraversalRunnable mTraversalRunnable <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TraversalRunnable<span style=color:#f92672>();</span>
</span></span></code></pre></div><p>run() 方法里面只有一句代码，doTraversal() 方法如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>doTraversal</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mTraversalScheduled<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        mTraversalScheduled <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 移除同步障碍
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        mHandler<span style=color:#f92672>.</span><span style=color:#a6e22e>getLooper</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getQueue</span><span style=color:#f92672>().</span><span style=color:#a6e22e>removeSyncBarrier</span><span style=color:#f92672>(</span>mTraversalBarrier<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 正式进入 View 绘制流程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        performTraversals<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>         <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>移除了同步障碍之后，所有绘制之前的准备工作已经执行完毕，接下来会调用 performTraversals() 方法正式进入 View 的绘制流程。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>performTraversals</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    finalView host <span style=color:#f92672>=</span> mView<span style=color:#f92672>;</span> <span style=color:#75715e>// mView 其实就是 DecorView
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    relayoutWindow<span style=color:#f92672>(</span>params<span style=color:#f92672>,</span> viewVisibility<span style=color:#f92672>,</span> insetsPending<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 执行 Measure 流程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    performMeasure<span style=color:#f92672>(</span>childWidthMeasureSpec<span style=color:#f92672>,</span> childHeightMeasureSpec<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 执行 Layout 流程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    performLayout<span style=color:#f92672>(</span>lp<span style=color:#f92672>,</span> desiredWindowWidth<span style=color:#f92672>,</span> desiredWindowHeight<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 执行 Draw 流程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    performLayout<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>跟踪 relayoutWindow 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>relayoutWindow</span><span style=color:#f92672>(</span>WindowManager<span style=color:#f92672>.</span><span style=color:#a6e22e>LayoutParams</span> params<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> viewVisibility<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>boolean</span> insetsPending<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> RemoteException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> relayoutResult <span style=color:#f92672>=</span> mWindowSession<span style=color:#f92672>.</span><span style=color:#a6e22e>relayout</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            mWindow<span style=color:#f92672>,</span> mSeq<span style=color:#f92672>,</span> params<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span><span style=color:#f92672>)</span> <span style=color:#f92672>(</span>mView<span style=color:#f92672>.</span><span style=color:#a6e22e>getMeasuredWidth</span><span style=color:#f92672>()</span> <span style=color:#f92672>*</span> appScale <span style=color:#f92672>+</span> 0<span style=color:#f92672>.</span><span style=color:#a6e22e>5f</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span><span style=color:#f92672>)</span> <span style=color:#f92672>(</span>mView<span style=color:#f92672>.</span><span style=color:#a6e22e>getMeasuredHeight</span><span style=color:#f92672>()</span> <span style=color:#f92672>*</span> appScale <span style=color:#f92672>+</span> 0<span style=color:#f92672>.</span><span style=color:#a6e22e>5f</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>            viewVisibility<span style=color:#f92672>,</span> insetsPending <span style=color:#f92672>?</span> WindowManagerGlobal<span style=color:#f92672>.</span><span style=color:#a6e22e>RELAYOUT_INSETS_PENDING</span> <span style=color:#f92672>:</span> 0<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            mWinFrame<span style=color:#f92672>,</span> mPendingOverscanInsets<span style=color:#f92672>,</span> mPendingContentInsets<span style=color:#f92672>,</span> mPendingVisibleInsets<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            mPendingStableInsets<span style=color:#f92672>,</span> mPendingOutsets<span style=color:#f92672>,</span> mPendingBackDropFrame<span style=color:#f92672>,</span> mPendingConfiguration<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            mSurface<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这里又是 Binder 调用（强烈建议掌握），它将调用到 WMS 的 relayout 方法，注意最后一个参数就是 SurfaceView 对象，它在 ViewRootImpl 中定义的时候就已经进行了初始化：</p><p>final Surface mSurface = new Surface();</p><p>再来看 WMS 的 relayoutWindow：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>relayoutWindow</span><span style=color:#f92672>(</span>Session session<span style=color:#f92672>,</span> IWindow client<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> seq<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            WindowManager<span style=color:#f92672>.</span><span style=color:#a6e22e>LayoutParams</span> attrs<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> requestedWidth<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> requestedHeight<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> viewVisibility<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> flags<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            Rect outFrame<span style=color:#f92672>,</span> Rect outOverscanInsets<span style=color:#f92672>,</span> Rect outContentInsets<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            Rect outVisibleInsets<span style=color:#f92672>,</span> Rect outStableInsets<span style=color:#f92672>,</span> Rect outOutsets<span style=color:#f92672>,</span> Rect outBackdropFrame<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            Configuration outConfig<span style=color:#f92672>,</span> Surface outSurface<span style=color:#f92672>){</span> 
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> createSurfaceControl<span style=color:#f92672>(</span>outSurface<span style=color:#f92672>,</span> result<span style=color:#f92672>,</span> win<span style=color:#f92672>,</span> winAnimator<span style=color:#f92672>);</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>createSurfaceControl</span><span style=color:#f92672>(</span>Surface outSurface<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> result<span style=color:#f92672>,</span> WindowState win<span style=color:#f92672>,</span>WindowStateAnimator winAnimator<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    surfaceController <span style=color:#f92672>=</span> winAnimator<span style=color:#f92672>.</span><span style=color:#a6e22e>createSurfaceLocked</span><span style=color:#f92672>(</span>win<span style=color:#f92672>.</span><span style=color:#a6e22e>mAttrs</span><span style=color:#f92672>.</span><span style=color:#a6e22e>type</span><span style=color:#f92672>,</span> win<span style=color:#f92672>.</span><span style=color:#a6e22e>mOwnerUid</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    surfaceController<span style=color:#f92672>.</span><span style=color:#a6e22e>getSurface</span><span style=color:#f92672>(</span>outSurface<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这里首先调用 WindowStateAnimator 的 createSurfaceLocked 生成一个真正有效的 Surface 对象，这个对象是在 Native 层的，接着 getSurface 方法将 Java 层的 Surface 对象与其关联起来。</p><h1 id=七正式绘制-view>七：正式绘制 View
<a class=anchor href=#%e4%b8%83%e6%ad%a3%e5%bc%8f%e7%bb%98%e5%88%b6-view>#</a></h1><p>接上一步骤的内容，申请了 Surface 之后，ViewRootImpl 的 performTraversals() 方法将会继续执行，这个方法内容相当多，忽略条件判断，精简过后如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>performTraversals</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    relayoutResult <span style=color:#f92672>=</span> relayoutWindow<span style=color:#f92672>(</span>params<span style=color:#f92672>,</span> viewVisibility<span style=color:#f92672>,</span> insetsPending<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    WindowManager<span style=color:#f92672>.</span><span style=color:#a6e22e>LayoutParams</span> lp <span style=color:#f92672>=</span> mWindowAttributes<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取 DecorView 宽和高的 MeasureSpec
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> childWidthMeasureSpec <span style=color:#f92672>=</span> getRootMeasureSpec<span style=color:#f92672>(</span>mWidth<span style=color:#f92672>,</span> lp<span style=color:#f92672>.</span><span style=color:#a6e22e>width</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> childHeightMeasureSpec <span style=color:#f92672>=</span> getRootMeasureSpec<span style=color:#f92672>(</span>mHeight<span style=color:#f92672>,</span> lp<span style=color:#f92672>.</span><span style=color:#a6e22e>height</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 执行 Measure 流程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    performMeasure<span style=color:#f92672>(</span>childWidthMeasureSpec<span style=color:#f92672>,</span> childHeightMeasureSpec<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 执行 Layout 流程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    performLayout<span style=color:#f92672>(</span>lp<span style=color:#f92672>,</span> desiredWindowWidth<span style=color:#f92672>,</span> desiredWindowHeight<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 执行 Draw 流程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    performLayout<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>首先，根据 getRootMeasureSpec() 方法获取到 childWidthMeasureSpec 和 childHeightMeasureSpec 的值，用于 DecorView 的绘制。因为 DecorView 是所有子元素的根元素，子元素的布局层层嵌套，因此会接着从 DecorView 开始进行一层层地对所有子元素进行测量、布局和绘制，分别对应 performMeasure()、performLayout() 和 performLayout() 方法，整个过程的示意图如下：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/View-Draw/clipboard_20230323_045652.png width=auto alt></p><h2 id=理解-measurespec>理解 MeasureSpec
<a class=anchor href=#%e7%90%86%e8%a7%a3-measurespec>#</a></h2><p>MeasureSpec 是 View 的一个内部类，简单来说就是一个 32 位的 int 值，采用它的高 2 位表示三种 SpecMode（测量模式），低 30 位用来表示 SpecSize（某种测量模式下的规格大小）。采用这种表示方法是为了避免创建过多的对象以减少内存分配，MeasureSpec 的定义如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MeasureSpec</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> MODE_SHIFT <span style=color:#f92672>=</span> 30<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> MODE_MASK <span style=color:#f92672>=</span> 0x3 <span style=color:#f92672>&lt;&lt;</span> MODE_SHIFT<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 不限定测量模式：父容器不对 View 作任何限制，View 想要多大给多大，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 这种模式通常用于系统内部。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> UNSPECIFIED <span style=color:#f92672>=</span> 0 <span style=color:#f92672>&lt;&lt;</span> MODE_SHIFT<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 精确为 SpecSize：父容器已经确定 View 需要的大小，就是 SpecSize，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 对应布局参数是 match_parent 或具体数值时的情况
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> EXACTLY <span style=color:#f92672>=</span> 1 <span style=color:#f92672>&lt;&lt;</span> MODE_SHIFT<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 最大只能是 SpecSize：父容器规定 View 最大只能是 SpecSize，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 对应布局参数是 wrap_content 时的情况
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> AT_MOST <span style=color:#f92672>=</span> 2 <span style=color:#f92672>&lt;&lt;</span> MODE_SHIFT<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 根据 SpecMode 和 SpecSize 创建一个 MeasureSpec
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>makeMeasureSpec</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> size<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> mode<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>sUseBrokenMakeMeasureSpec<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> size <span style=color:#f92672>+</span> mode<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>size <span style=color:#f92672>&amp;</span> <span style=color:#f92672>~</span>MODE_MASK<span style=color:#f92672>)</span> <span style=color:#f92672>|</span> <span style=color:#f92672>(</span>mode <span style=color:#f92672>&amp;</span> MODE_MASK<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取 SpecMode
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getMode</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> measureSpec<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>measureSpec <span style=color:#f92672>&amp;</span> MODE_MASK<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取 SpecSize
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getSize</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> measureSpec<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>measureSpec <span style=color:#f92672>&amp;</span> <span style=color:#f92672>~</span>MODE_MASK<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 调整 MeasureSpec
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>adjust</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> measureSpec<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> delta<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> mode <span style=color:#f92672>=</span> getMode<span style=color:#f92672>(</span>measureSpec<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mode <span style=color:#f92672>==</span> UNSPECIFIED<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> make <span style=color:#a6e22e>MeasureSpec</span><span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> UNSPECIFIED<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> size <span style=color:#f92672>=</span> getSize<span style=color:#f92672>(</span>measureSpec<span style=color:#f92672>)</span> <span style=color:#f92672>+</span> delta<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>size <span style=color:#f92672>&lt;</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            size <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> makeMeasureSpec<span style=color:#f92672>(</span>size<span style=color:#f92672>,</span> mode<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>接着看 getRootMeasureSpec() 方法，传入的第一个参数是整个屏幕的宽或者高，第二个参数是 Window 的 LayoutParams：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getRootMeasureSpec</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> windowSize<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> rootDimension<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> measureSpec<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>rootDimension<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> ViewGroup<span style=color:#f92672>.</span><span style=color:#a6e22e>LayoutParams</span><span style=color:#f92672>.</span><span style=color:#a6e22e>MATCH_PARENT</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        measureSpec <span style=color:#f92672>=</span> MeasureSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>makeMeasureSpec</span><span style=color:#f92672>(</span>windowSize<span style=color:#f92672>,</span> MeasureSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>EXACTLY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> ViewGroup<span style=color:#f92672>.</span><span style=color:#a6e22e>LayoutParams</span><span style=color:#f92672>.</span><span style=color:#a6e22e>WRAP_CONTENT</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        measureSpec <span style=color:#f92672>=</span> MeasureSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>makeMeasureSpec</span><span style=color:#f92672>(</span>windowSize<span style=color:#f92672>,</span> MeasureSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>AT_MOST</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        measureSpec <span style=color:#f92672>=</span> MeasureSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>makeMeasureSpec</span><span style=color:#f92672>(</span>rootDimension<span style=color:#f92672>,</span> MeasureSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>EXACTLY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> measureSpec<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>从代码逻辑来看，DecorView 的 MeasureSpec 的产生遵循如下规律：</p><ul><li>LayoutParams = MATCH_PARENT：精确模式，大小就是屏幕的宽或者高；</li><li>LayoutParams = WRAP_CONTENT：最大不能超过屏幕的宽或者高；</li><li>固定大小：精确模式，大小为 LayoutParams 中指定的值。</li></ul><p>但是对于普通的 View 来说，View 的 measure() 方法是由父容器 ViewGroup 调用的，看一下 ViewGroup 的 measureChildWithMargins() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>measureChildWithMargins</span><span style=color:#f92672>(</span>View child<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> parentWidthMeasureSpec<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> widthUsed<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> parentHeightMeasureSpec<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> heightUsed<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取子元素的布局参数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>final</span> MarginLayoutParams lp <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>MarginLayoutParams<span style=color:#f92672>)</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>getLayoutParams</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 产生子元素的 MeasureSpec
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> childWidthMeasureSpec <span style=color:#f92672>=</span> getChildMeasureSpec<span style=color:#f92672>(</span>parentWidthMeasureSpec<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            mPaddingLeft <span style=color:#f92672>+</span> mPaddingRight <span style=color:#f92672>+</span> lp<span style=color:#f92672>.</span><span style=color:#a6e22e>leftMargin</span> <span style=color:#f92672>+</span> lp<span style=color:#f92672>.</span><span style=color:#a6e22e>rightMargin</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>+</span> widthUsed<span style=color:#f92672>,</span> lp<span style=color:#f92672>.</span><span style=color:#a6e22e>width</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> childHeightMeasureSpec <span style=color:#f92672>=</span> getChildMeasureSpec<span style=color:#f92672>(</span>parentHeightMeasureSpec<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            mPaddingTop <span style=color:#f92672>+</span> mPaddingBottom <span style=color:#f92672>+</span> lp<span style=color:#f92672>.</span><span style=color:#a6e22e>topMargin</span> <span style=color:#f92672>+</span> lp<span style=color:#f92672>.</span><span style=color:#a6e22e>bottomMargin</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>+</span> heightUsed<span style=color:#f92672>,</span> lp<span style=color:#f92672>.</span><span style=color:#a6e22e>height</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    child<span style=color:#f92672>.</span><span style=color:#a6e22e>measure</span><span style=color:#f92672>(</span>childWidthMeasureSpec<span style=color:#f92672>,</span> childHeightMeasureSpec<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看出，在调用子元素 的 measure() 方法之前，先要调用 getChildMeasureSpec() 方法产生子元素的 MeasureSpec，子元素的产生除了跟父容器的 MeasureSpec 和子元素本身的 LayoutParams 有关之外，还与子元素的 Margin 和父容器的 Padding 值以及父容器当前占用空间有关，具体的过程可以看 getChildMeasureSpec() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getChildMeasureSpec</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> spec<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> padding<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> childDimesion<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> specMode <span style=color:#f92672>=</span> MeasureSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>getMode</span><span style=color:#f92672>(</span>spec<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> specSize <span style=color:#f92672>=</span> MeasureSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>getSize</span><span style=color:#f92672>(</span>spec<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 子元素最大可用空间为父容器的尺寸减去父容器中已被占用的空间的大小
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> size <span style=color:#f92672>=</span> Math<span style=color:#f92672>.</span><span style=color:#a6e22e>max</span><span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> specSize <span style=color:#f92672>-</span> padding<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> resultSize <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> resultMode <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>sepcMode<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Parent has imposed an exact size on us
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>case</span> MeasureSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>EXACTLY</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>childDimension <span style=color:#f92672>&gt;=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                resultSize <span style=color:#f92672>=</span> childDimension<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                resultMode <span style=color:#f92672>=</span> MeasureSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>EXACTLY</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>childDimension <span style=color:#f92672>==</span> LayoutParams<span style=color:#f92672>.</span><span style=color:#a6e22e>MATCH_PARENT</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Child wants to be our size. So be it.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                resultSize <span style=color:#f92672>=</span> size<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                resultMode <span style=color:#f92672>=</span> MeasureSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>EXACTLY</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>childDimesion <span style=color:#f92672>==</span> LayoutParams<span style=color:#f92672>.</span><span style=color:#a6e22e>WRAP_CONTENT</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Child wants to determine its own size. It can&#39;t be
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// bigger than us.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                resultSize <span style=color:#f92672>=</span> size<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                resultMode <span style=color:#f92672>=</span> MeasureSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>AT_MOST</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Parent has imposed a maximum size on us 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>case</span> MeasureSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>AT_MOST</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>childDimension <span style=color:#f92672>&gt;=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Child wants a specific size... so be it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                resultSize <span style=color:#f92672>=</span> childDimension<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                resultMode <span style=color:#f92672>=</span> MeasureSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>EXACTLY</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>childDimension <span style=color:#f92672>==</span> LayoutParams<span style=color:#f92672>.</span><span style=color:#a6e22e>MATCH_PARENT</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Child wants to be our size, but our size is not fixed.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// Constrain child to not be bigger than us.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                resultSize <span style=color:#f92672>=</span> size<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                resultMode <span style=color:#f92672>=</span> MeasureSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>AT_MOST</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>childDimension <span style=color:#f92672>==</span> LayoutParams<span style=color:#f92672>.</span><span style=color:#a6e22e>WRAP_CONTENT</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Child wants to determine its own size. It can&#39;t be
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// bigger than us.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                resultSize <span style=color:#f92672>=</span> size<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                resultMode <span style=color:#f92672>=</span> MeasureSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>AT_MOST</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Parent asked to see how big we want to be
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>case</span> MeasureSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>UNSPECIFIED</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>childDimension <span style=color:#f92672>&gt;=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Child wants a specific size... let him have it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                resultSize <span style=color:#f92672>=</span> childDimension<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                resultMode <span style=color:#f92672>=</span> MeasureSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>EXACTLY</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>childDimension <span style=color:#f92672>==</span> LayoutParams<span style=color:#f92672>.</span><span style=color:#a6e22e>MATCH_PARENT</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Child wants to be our size... find out how big it should be
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                resultSize <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                resultMode <span style=color:#f92672>=</span> MeasureSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>UNSPECIFIED</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>childDimension <span style=color:#f92672>==</span> LayoutParams<span style=color:#f92672>.</span><span style=color:#a6e22e>WRAP_CONTENT</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Child wants to determine its own size....
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// find out how big it should be
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                resultSize <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                resultMode <span style=color:#f92672>==</span> MeasureSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>UNSPECIFIED</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> MeasureSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>makeMeasureSpec</span><span style=color:#f92672>(</span>resultSize<span style=color:#f92672>,</span> resultMode<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>整个过程稍微有点复杂，可以参考以下表格：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/View-Draw/clipboard_20230323_045658.png width=auto alt></p><h2 id=measure-流程分析>Measure 流程分析
<a class=anchor href=#measure-%e6%b5%81%e7%a8%8b%e5%88%86%e6%9e%90>#</a></h2><p>回到 performTraversals() 方法中，获取到 DecorView 的 MeasureSpec 后接着会调用 performMeasure() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>performMeasure</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> childWidthMeasureSpec<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> childHeightMeasureSpec<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    mView<span style=color:#f92672>.</span><span style=color:#a6e22e>measure</span><span style=color:#f92672>(</span>childWidthMeasureSpec<span style=color:#f92672>,</span> childHeightMeasureSpec<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>mView 就是之前通过 setView() 方法传递过来的 DecorView 实例，它继承自 FrameLayout，而 FrameLayout 又是一个 ViewGroup 同时继承自 View。View 的 measure() 方法是 final 类型的，不允许子类去重写，因此这里调用的实际上是 View 的 measure 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>measure</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> widthMeasureSpec<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> heightMeasureSpec<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    onMeasure<span style=color:#f92672>(</span>widthMeasureSpec<span style=color:#f92672>,</span> heightMeasureSpec<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>View 的 onMeasure() 实现：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onMeasure</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> widthMeasureSpec<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> heightMeasureSpec<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    setMeasuredDimension<span style=color:#f92672>(</span>getDefaultSize<span style=color:#f92672>(</span>getSuggestedMinimumWidth<span style=color:#f92672>(),</span> widthMeasureSpec<span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>            getDefaultSize<span style=color:#f92672>(</span>getSuggestedMinimumHeight<span style=color:#f92672>(),</span> heightMeasureSpec<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到，View 默认的 onMeasure() 方法首先会调用 getDefaultSize() 获取宽和高的默认值，然后再调用 setMeasuredDimension() 将获取的值进行设置，查看 getDefaultSize() 的代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getDefaultSize</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> size<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> measureSpec<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> result <span style=color:#f92672>=</span> size<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> specMode <span style=color:#f92672>=</span> MeasureSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>getMode</span><span style=color:#f92672>(</span>measureSpec<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> specSize <span style=color:#f92672>=</span> MeasureSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>getSize</span><span style=color:#f92672>(</span>measureSpec<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>specMode<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> MeasureSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>UNSPECIFIED</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            result <span style=color:#f92672>=</span> size<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> MeasureSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>AT_MOST</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> MeasureSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>EXACTLY</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            result <span style=color:#f92672>=</span> specSize<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>无论是 AT_MOST 还是 EXACTLY，最终返回的都是 measureSpec 中的 specSize，这个 specSize 就是测量后的最终结果。至于 UNSPECIFIED 的情况，则会返回一个建议的最小值，这个值和子元素设置的最小值它的背景大小有关。</p><p>从 onMeasure() 的默认实现可以看出，如果我们自定义一个直接继承自 View 的控件如果不重写 onMeasure() 方法，在使用这个控件并把 layout_width 或 layout_height 设置成 wrap_content 的时候，效果将会和 match_parent 一样！因为布局中使用 wrap_content 的时候，根据上面 getChildMeasureSpec() 方法总结出来的表格可以知道，此时的 specMode 是 AT_MOST，specSize 是 parentSize，而 parentSize 是父容器当前剩余的空间大小，此时 getDefaultSize() 就会返回 specSize，因此子元素的宽或高就被设置成了等于当前父容器剩余空间的大小了，这显然不符合我们的预期，如何解决这个问题呢？一个通用的方案就是像如下方式重写 onMeasure() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onMeasure</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> widthMeasureSpec<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> heightMeasureSpec<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>onMeasure</span><span style=color:#f92672>(</span>widthMeasureSpec<span style=color:#f92672>,</span> heightMeasureSpec<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> widthMode <span style=color:#f92672>=</span> MeasureSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>getMode</span><span style=color:#f92672>(</span>widthMeasureSpec<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> widthSize <span style=color:#f92672>=</span> MeasureSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>getSize</span><span style=color:#f92672>(</span>widthMeasureSpec<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> heightMode <span style=color:#f92672>=</span> MeasureSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>getMode</span><span style=color:#f92672>(</span>heightMeasureSpec<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> heightSize <span style=color:#f92672>=</span> MeasureSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>getSize</span><span style=color:#f92672>(</span>heightMeasureSpec<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 默认的宽/高
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> mWidth <span style=color:#f92672>=</span> default_width<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> mHeight <span style=color:#f92672>=</span> default_height<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 当布局参数设置为 wrap_content 时，使用默认值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>getLayoutParams<span style=color:#f92672>().</span><span style=color:#a6e22e>width</span> <span style=color:#f92672>==</span> ViewGroup<span style=color:#f92672>.</span><span style=color:#a6e22e>LayoutParams</span><span style=color:#f92672>.</span><span style=color:#a6e22e>WRAP_CONTENT</span> <span style=color:#f92672>&amp;&amp;</span> getLayoutParams<span style=color:#f92672>().</span><span style=color:#a6e22e>height</span> <span style=color:#f92672>==</span> ViewGroup<span style=color:#f92672>.</span><span style=color:#a6e22e>LayoutParams</span><span style=color:#f92672>.</span><span style=color:#a6e22e>WRAP_CONTENT</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        setMeasuredDimension<span style=color:#f92672>(</span>mWidth<span style=color:#f92672>,</span> mHeight<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 宽 / 高任意一个布局参数为 wrap_content 时，都使用默认值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>getLayoutParams<span style=color:#f92672>().</span><span style=color:#a6e22e>width</span> <span style=color:#f92672>==</span> ViewGroup<span style=color:#f92672>.</span><span style=color:#a6e22e>LayoutParams</span><span style=color:#f92672>.</span><span style=color:#a6e22e>WRAP_CONTENT</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        setMeasuredDimension<span style=color:#f92672>(</span>mWidth<span style=color:#f92672>,</span> heightSize<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>getLayoutParams<span style=color:#f92672>().</span><span style=color:#a6e22e>height</span> <span style=color:#f92672>==</span> ViewGroup<span style=color:#f92672>.</span><span style=color:#a6e22e>LayoutParams</span><span style=color:#f92672>.</span><span style=color:#a6e22e>WRAP_CONTENT</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        setMeasuredDimension<span style=color:#f92672>(</span>widthSize<span style=color:#f92672>,</span> mHeight<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>因为 DecorView 继承自 FrameLayout，它是一个 ViewGroup，ViewGroup 是一个抽象类，它并没有定义一个具体的测量过程，默认使用 View 的 onMeasure() 进行测量。它的测量过程需要各个子类通过重写 onMeasure() 方法去实现，因为不同的子类具有不同的布局特性，因此需要不一样的测量逻辑，DecorView 也自然重写了 onMeasure() 方法来实现自己的测量逻辑，简略后方法内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onMeasure</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> widthMeasureSpec<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> heightMeasureSpec<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> widthMode <span style=color:#f92672>=</span> getMode<span style=color:#f92672>(</span>widthMeasureSpec<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> heightMode <span style=color:#f92672>=</span> getMode<span style=color:#f92672>(</span>heightMeasureSpec<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>widthMode <span style=color:#f92672>==</span> AT_MOST<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>heightMode <span style=color:#f92672>==</span> AT_MOST<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>onMeasure</span><span style=color:#f92672>(</span>widthMeasureSpec<span style=color:#f92672>,</span> heightMeasureSpec<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>最终会调用父类 FrameLayout 的 onMeasure() 方法，简略后方法内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onMeasure</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> widthMeasureSpec<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> heightMeasureSpec<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> count <span style=color:#f92672>=</span> getChildCount<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> count<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> View child <span style=color:#f92672>=</span> getChildAt<span style=color:#f92672>(</span>i<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mMeasureAllChildren <span style=color:#f92672>||</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>getVisibility</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> GONE<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            measureChildWithMargins<span style=color:#f92672>(</span>child<span style=color:#f92672>,</span> widthMeasureSpec<span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> heightMeasureSpec<span style=color:#f92672>,</span> 0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    setMeasuredDimension<span style=color:#f92672>(</span>resolveSizeAndState<span style=color:#f92672>(</span>maxWidth<span style=color:#f92672>,</span> widthMeasureSpec<span style=color:#f92672>,</span> childState<span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>            resolveSizeAndState<span style=color:#f92672>(</span>maxHeight<span style=color:#f92672>,</span> heightMeasureSpec<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                    childState <span style=color:#f92672>&lt;&lt;</span> MEASURED_HEIGHT_STATE_SHIFT<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到，这里会遍历它的每一个子元素，并调用 measureChildWithMargins() 方法，这个方法其实前面已经出现过，它的作用是计算出子元素的 MeasureSpec 后调用子元素本身的 measure() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>measureChildWithMargins</span><span style=color:#f92672>(</span>View child<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> parentWidthMeasureSpec<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> widthUsed<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> parentHeightMeasureSpec<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> heightUsed<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取子元素的布局参数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>final</span> MarginLayoutParams lp <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>MarginLayoutParams<span style=color:#f92672>)</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>getLayoutParams</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 产生子元素的 MeasureSpec
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> childWidthMeasureSpec <span style=color:#f92672>=</span> getChildMeasureSpec<span style=color:#f92672>(</span>parentWidthMeasureSpec<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            mPaddingLeft <span style=color:#f92672>+</span> mPaddingRight <span style=color:#f92672>+</span> lp<span style=color:#f92672>.</span><span style=color:#a6e22e>leftMargin</span> <span style=color:#f92672>+</span> lp<span style=color:#f92672>.</span><span style=color:#a6e22e>rightMargin</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>+</span> widthUsed<span style=color:#f92672>,</span> lp<span style=color:#f92672>.</span><span style=color:#a6e22e>width</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> childHeightMeasureSpec <span style=color:#f92672>=</span> getChildMeasureSpec<span style=color:#f92672>(</span>parentHeightMeasureSpec<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            mPaddingTop <span style=color:#f92672>+</span> mPaddingBottom <span style=color:#f92672>+</span> lp<span style=color:#f92672>.</span><span style=color:#a6e22e>topMargin</span> <span style=color:#f92672>+</span> lp<span style=color:#f92672>.</span><span style=color:#a6e22e>bottomMargin</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>+</span> heightUsed<span style=color:#f92672>,</span> lp<span style=color:#f92672>.</span><span style=color:#a6e22e>height</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    child<span style=color:#f92672>.</span><span style=color:#a6e22e>measure</span><span style=color:#f92672>(</span>childWidthMeasureSpec<span style=color:#f92672>,</span> childHeightMeasureSpec<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>此时实际上调用的也是 View 的 measure() 方法，从上面的内容可以知道，子元素的 onMeasure() 方法又会被调用，这样便实现了层层递归地调用到了每个子元素的 onMeasure() 方法进行测量。</p><h2 id=layout-流程分析>Layout 流程分析
<a class=anchor href=#layout-%e6%b5%81%e7%a8%8b%e5%88%86%e6%9e%90>#</a></h2><p>再次回到 performTraversals() 方法，执行完 performMeasure() 遍历测量所有子元素之后，接着会调用 performLayout() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>performLayout</span><span style=color:#f92672>(</span>WindowManager<span style=color:#f92672>.</span><span style=color:#a6e22e>LayoutParams</span> lp<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> desiredWindowWidth<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> desiredWindowHeight<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 调用 DecorView 的 layout() 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    host<span style=color:#f92672>.</span><span style=color:#a6e22e>layout</span><span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> host<span style=color:#f92672>.</span><span style=color:#a6e22e>getMeasuredWidth</span><span style=color:#f92672>(),</span> host<span style=color:#f92672>.</span><span style=color:#a6e22e>getMeasuredHeight</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这里的 getMeasuredWidth() 和 getMeasuredHeight() 就是 DecorView 在前面 Measure 流程中计算得到的测量值，它们都被作为参数传入 layout() 方法中，这里调用的是 View 的 layout() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>layout</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> l<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> t<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> r<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> b<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// View 状态是否发生了变化
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>boolean</span> changed <span style=color:#f92672>=</span> isLayoutModeOptical<span style=color:#f92672>(</span>mParent<span style=color:#f92672>)</span> <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span>                setOpticalFrame<span style=color:#f92672>(</span>l<span style=color:#f92672>,</span> t<span style=color:#f92672>,</span> r<span style=color:#f92672>,</span> b<span style=color:#f92672>)</span> <span style=color:#f92672>:</span> setFrame<span style=color:#f92672>(</span>l<span style=color:#f92672>,</span> t<span style=color:#f92672>,</span> r<span style=color:#f92672>,</span> b<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果 View 状态有变化，则重新布局
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>changed <span style=color:#f92672>||</span> <span style=color:#f92672>(</span>mPrivateFlags <span style=color:#f92672>&amp;</span> PFLAG_LAYOUT_REQUIRED<span style=color:#f92672>)</span> <span style=color:#f92672>==</span> PFLAG_LAYOUT_REQUIRED<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        onLayout<span style=color:#f92672>(</span>changed<span style=color:#f92672>,</span> l<span style=color:#f92672>,</span> t<span style=color:#f92672>,</span> r<span style=color:#f92672>,</span> b<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>setOpticalFrame() 内部也直接调用了 setFrame() 方法，查看 setFrame() 方法的实现：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>setFrame</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> left<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> top<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> right<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> bottom<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> changed <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mLeft <span style=color:#f92672>!=</span> left <span style=color:#f92672>||</span> mRight <span style=color:#f92672>!=</span> right <span style=color:#f92672>||</span> mTop <span style=color:#f92672>!=</span> top <span style=color:#f92672>||</span> mBottom <span style=color:#f92672>!=</span> bottom<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        changed <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> oldWidth <span style=color:#f92672>=</span> mRight <span style=color:#f92672>-</span> mLeft<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> oldHeight <span style=color:#f92672>=</span> mBottom <span style=color:#f92672>-</span> mTop<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> newWidth <span style=color:#f92672>=</span> right <span style=color:#f92672>-</span> left<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> newHeight <span style=color:#f92672>=</span> bottom <span style=color:#f92672>-</span> top<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>boolean</span> sizeChanged <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>newWidth <span style=color:#f92672>!=</span> oldWidth<span style=color:#f92672>)</span> <span style=color:#f92672>||</span> <span style=color:#f92672>(</span>newHeight <span style=color:#f92672>!=</span> oldHeight<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Invalidate our old position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        invalidate<span style=color:#f92672>(</span>sizeChanged<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 变量初始化
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>        mLeft <span style=color:#f92672>=</span> left<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        mTop <span style=color:#f92672>=</span> top<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        mRight <span style=color:#f92672>=</span> right<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        mBottom <span style=color:#f92672>=</span> bottom<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 更新用于渲染的显示列表
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        mRenderNode<span style=color:#f92672>.</span><span style=color:#a6e22e>setLeftTopRightBottom</span><span style=color:#f92672>(</span>mLeft<span style=color:#f92672>,</span> mTop<span style=color:#f92672>,</span> mRight<span style=color:#f92672>,</span> mBottom<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>sizeChanged<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 如果 View 大小发生变化，则会在里面回调 onSizeChanged 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            sizeChange<span style=color:#f92672>(</span>newWidth<span style=color:#f92672>,</span> newHeight<span style=color:#f92672>,</span> oldWidth<span style=color:#f92672>,</span> oldHeight<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 返回是否发生变化
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> changed<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>setFrame() 方法的主要作用有以下几点：</p><ol><li>判断 View 位置是否发生变化，并根据变化情况进行相应的处理；</li><li>初始化 mLeft、mBottom、mRight 和 mTop 变量，首次调用这个方法的时候返回值为 <em>true</em>；</li><li>调用 RenderNode 中原生方法更新用于渲染的显示列表。</li></ol><p>回到 layout() 方法，根据 setFrame() 方法返回的状态判断是否需要调用 onLayout() 进行重新布局，查看 onLayout() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Assign a size and position to a view and all of its
</span></span></span><span style=display:flex><span><span style=color:#75715e> * descendants
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * &lt;p&gt;This is the second phase of the layout mechanism.
</span></span></span><span style=display:flex><span><span style=color:#75715e> * (The first is measuring). In this phase, each parent calls
</span></span></span><span style=display:flex><span><span style=color:#75715e> * layout on all of its children to position them.
</span></span></span><span style=display:flex><span><span style=color:#75715e> * This is typically done using the child measurements
</span></span></span><span style=display:flex><span><span style=color:#75715e> * that were stored in the measure pass().&lt;/p&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * &lt;p&gt;Derived classes should not override this method.
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Derived classes with children should override
</span></span></span><span style=display:flex><span><span style=color:#75715e> * onLayout. In that method, they should
</span></span></span><span style=display:flex><span><span style=color:#75715e> * call layout on each of their children.&lt;/p&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onLayout</span><span style=color:#f92672>(</span><span style=color:#66d9ef>boolean</span> changed<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> left<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> top<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> right<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> bottom<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>onLayout() 方法是一个空方法，从注释最后一段内容可以了解到，单一的 View 并不需要重写这个方法，当 View 的子类具有子元素（即 ViewGroup）的时候，应该重写这个方法并调用每个子元素的 layout() 方法，因此作为一个 ViewGroup，我们查看 DecorView 的 onLayout() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onLayout</span><span style=color:#f92672>(</span><span style=color:#66d9ef>boolean</span> changed<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> left<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> top<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> right<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> bottom<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>onLayout</span><span style=color:#f92672>(</span>changed<span style=color:#f92672>,</span> left<span style=color:#f92672>,</span> top<span style=color:#f92672>,</span> right<span style=color:#f92672>,</span> bottom<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这里的主要逻辑是调用父类的 onLayout() 方法，继续跟踪 FrameLayout 的 onLayout() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onLayout</span><span style=color:#f92672>(</span><span style=color:#66d9ef>boolean</span> changed<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> left<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> top<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> right<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> bottom<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    layoutChildren<span style=color:#f92672>(</span>left<span style=color:#f92672>,</span> top<span style=color:#f92672>,</span> right<span style=color:#f92672>,</span> bottom<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span> <span style=color:#75715e>/* no force left gravity */</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>layoutChildren</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> left<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> top<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> right<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> bottom<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> forceLeftGravity<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> count <span style=color:#f92672>=</span> getChildCount<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> parentLeft <span style=color:#f92672>=</span> getPaddingLeftWithForeground<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> parentRight <span style=color:#f92672>=</span> right <span style=color:#f92672>-</span> left <span style=color:#f92672>-</span> getPaddingRightWithForeground<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> parentTop <span style=color:#f92672>=</span> getPaddingTopWithForeground<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> parentBottom <span style=color:#f92672>=</span> bottom <span style=color:#f92672>-</span> top <span style=color:#f92672>-</span> getPaddingBottomWithForeground<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> count<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> View child <span style=color:#f92672>=</span> getChildAt<span style=color:#f92672>(</span>i<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>child<span style=color:#f92672>.</span><span style=color:#a6e22e>getVisibility</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> GONE<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>final</span> LayoutParams lp <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>LayoutParams<span style=color:#f92672>)</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>getLayoutParams</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> width <span style=color:#f92672>=</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>getMeasuredWidth</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> height <span style=color:#f92672>=</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>getMeasuredHeight</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> childLeft<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> childTop<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> gravity <span style=color:#f92672>=</span> lp<span style=color:#f92672>.</span><span style=color:#a6e22e>gravity</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>gravity <span style=color:#f92672>==</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                gravity <span style=color:#f92672>=</span> DEFAULT_CHILD_GRAVITY<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> layoutDirection <span style=color:#f92672>=</span> getLayoutDirection<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> absoluteGravity <span style=color:#f92672>=</span> Gravity<span style=color:#f92672>.</span><span style=color:#a6e22e>getAbsoluteGravity</span><span style=color:#f92672>(</span>gravity<span style=color:#f92672>,</span> layoutDirection<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> verticalGravity <span style=color:#f92672>=</span> gravity <span style=color:#f92672>&amp;</span> Gravity<span style=color:#f92672>.</span><span style=color:#a6e22e>VERTICAL_GRAVITY_MASK</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>absoluteGravity <span style=color:#f92672>&amp;</span> Gravity<span style=color:#f92672>.</span><span style=color:#a6e22e>HORIZONTAL_GRAVITY_MASK</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>case</span> Gravity<span style=color:#f92672>.</span><span style=color:#a6e22e>CENTER_HORIZONTAL</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                    childLeft <span style=color:#f92672>=</span> parentLeft <span style=color:#f92672>+</span> <span style=color:#f92672>(</span>parentRight <span style=color:#f92672>-</span> parentLeft <span style=color:#f92672>-</span> width<span style=color:#f92672>)</span> <span style=color:#f92672>/</span> 2 <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                    lp<span style=color:#f92672>.</span><span style=color:#a6e22e>leftMargin</span> <span style=color:#f92672>-</span> lp<span style=color:#f92672>.</span><span style=color:#a6e22e>rightMargin</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>case</span> Gravity<span style=color:#f92672>.</span><span style=color:#a6e22e>RIGHT</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>forceLeftGravity<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        childLeft <span style=color:#f92672>=</span> parentRight <span style=color:#f92672>-</span> width <span style=color:#f92672>-</span> lp<span style=color:#f92672>.</span><span style=color:#a6e22e>rightMargin</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>case</span> Gravity<span style=color:#f92672>.</span><span style=color:#a6e22e>LEFT</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                    childLeft <span style=color:#f92672>=</span> parentLeft <span style=color:#f92672>+</span> lp<span style=color:#f92672>.</span><span style=color:#a6e22e>leftMargin</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>verticalGravity<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>case</span> Gravity<span style=color:#f92672>.</span><span style=color:#a6e22e>TOP</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                    childTop <span style=color:#f92672>=</span> parentTop <span style=color:#f92672>+</span> lp<span style=color:#f92672>.</span><span style=color:#a6e22e>topMargin</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>case</span> Gravity<span style=color:#f92672>.</span><span style=color:#a6e22e>CENTER_VERTICAL</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                    childTop <span style=color:#f92672>=</span> parentTop <span style=color:#f92672>+</span> <span style=color:#f92672>(</span>parentBottom <span style=color:#f92672>-</span> parentTop <span style=color:#f92672>-</span> height<span style=color:#f92672>)</span> <span style=color:#f92672>/</span> 2 <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                    lp<span style=color:#f92672>.</span><span style=color:#a6e22e>topMargin</span> <span style=color:#f92672>-</span> lp<span style=color:#f92672>.</span><span style=color:#a6e22e>bottomMargin</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>case</span> Gravity<span style=color:#f92672>.</span><span style=color:#a6e22e>BOTTOM</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                    childTop <span style=color:#f92672>=</span> parentBottom <span style=color:#f92672>-</span> height <span style=color:#f92672>-</span> lp<span style=color:#f92672>.</span><span style=color:#a6e22e>bottomMargin</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                    childTop <span style=color:#f92672>=</span> parentTop <span style=color:#f92672>+</span> lp<span style=color:#f92672>.</span><span style=color:#a6e22e>topMargin</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 调用每个子元素的 layout 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            child<span style=color:#f92672>.</span><span style=color:#a6e22e>layout</span><span style=color:#f92672>(</span>childLeft<span style=color:#f92672>,</span> childTop<span style=color:#f92672>,</span> childLeft <span style=color:#f92672>+</span> width<span style=color:#f92672>,</span> childTop <span style=color:#f92672>+</span> height<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>在 layoutChildren() 方法中，根据自己的布局逻辑，计算出每个子元素的 left、top、right 和 bottom 值，并调用它们的 layout() 方法。</p><p>Layout 流程的作用是 ViewGroup 用来确定它的子元素的位置， 当 ViewGroup 的位置被确定后，在它的 onLayout() 方法中就会遍历调用所有子元素的 layout() 方法，子元素的 layout() 方法被调用的时候它的 onLayout() 方法又会被调用，这样就实现了层层递归。</p><h2 id=draw-流程分析>Draw 流程分析
<a class=anchor href=#draw-%e6%b5%81%e7%a8%8b%e5%88%86%e6%9e%90>#</a></h2><p>最后，又一次回到主线中的 performTraversals() 方法，此时，经过 Measure 流程确定了每个 View 的大小并且经过 Layout 流程确定了每个 View 的摆放位置，下面将进入下一个流程确定每个 View 的具体绘制细节。查看 performDraw() 方法内容：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>performDraw</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> fullRedrawNeeded <span style=color:#f92672>=</span> mFullRedrawNeeded<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    mFullRedrawNeeded <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    mIsDrawing <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        draw<span style=color:#f92672>(</span>fullRedrawNeeded<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        mIsDrawing <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>跟踪 draw() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>draw</span><span style=color:#f92672>(</span><span style=color:#66d9ef>boolean</span> fullRedrawNeeded<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// “脏”区域，即需要重绘的区域
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>final</span> Rect dirty <span style=color:#f92672>=</span> mDirty<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>fullRedrawNeeded<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        mAttachInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>mIgnoreDirtyState</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        dirty<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span><span style=color:#f92672>)</span> <span style=color:#f92672>(</span>mWidth <span style=color:#f92672>*</span> appScale <span style=color:#f92672>+</span> 0<span style=color:#f92672>.</span><span style=color:#a6e22e>5f</span><span style=color:#f92672>),</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span><span style=color:#f92672>)</span> <span style=color:#f92672>(</span>mHeight <span style=color:#f92672>*</span> appScale <span style=color:#f92672>+</span> 0<span style=color:#f92672>.</span><span style=color:#a6e22e>5f</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>dirty<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>()</span> <span style=color:#f92672>||</span> mIsAnimating <span style=color:#f92672>||</span> accessibilityFocusDirty<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mAttachInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>mHardwareRenderer</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> mAttachInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>mHardwareRenderer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isEnabled</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 调用 drawSoftware 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>drawSoftware<span style=color:#f92672>(</span>surface<span style=color:#f92672>,</span> mAttachInfo<span style=color:#f92672>,</span> xOffset<span style=color:#f92672>,</span> yOffset<span style=color:#f92672>,</span> scalingRequired<span style=color:#f92672>,</span> dirty<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>查看 drawSoftware() 方法实现：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>drawSoftware</span><span style=color:#f92672>(</span>Surface surface<span style=color:#f92672>,</span> AttachInfo attachInfo<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> xoff<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> yoff<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>boolean</span> scalingRequired<span style=color:#f92672>,</span> Rect dirty<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Draw with software renderer.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>final</span> Canvas canvas<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> left <span style=color:#f92672>=</span> dirty<span style=color:#f92672>.</span><span style=color:#a6e22e>left</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> top <span style=color:#f92672>=</span> dirty<span style=color:#f92672>.</span><span style=color:#a6e22e>top</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> right <span style=color:#f92672>=</span> dirty<span style=color:#f92672>.</span><span style=color:#a6e22e>right</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> bottom <span style=color:#f92672>=</span> dirty<span style=color:#f92672>.</span><span style=color:#a6e22e>bottom</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 锁定canvas区域，由 dirty 区域决定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        canvas <span style=color:#f92672>=</span> mSurface<span style=color:#f92672>.</span><span style=color:#a6e22e>lockCanvas</span><span style=color:#f92672>(</span>dirty<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        canvas<span style=color:#f92672>.</span><span style=color:#a6e22e>setDensity</span><span style=color:#f92672>(</span>mDensity<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Surface<span style=color:#f92672>.</span><span style=color:#a6e22e>OutOfResourcesException</span> e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        handleOutOfResourcesException<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IllegalArgumentException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        mLayoutRequested <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>    <span style=color:#75715e>// ask wm for a new surface next time.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 调用 DecorView 的 draw 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            mView<span style=color:#f92672>.</span><span style=color:#a6e22e>draw</span><span style=color:#f92672>(</span>canvas<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        mLayoutRequested <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>    <span style=color:#75715e>// ask wm for a new surface next time.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>//noinspection ReturnInsideFinallyBlock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>继续查看 DecorView 的 draw() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>draw</span><span style=color:#f92672>(</span>Canvas canvas<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>draw</span><span style=color:#f92672>(</span>canvas<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mMenuBackground <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        mMenuBackground<span style=color:#f92672>.</span><span style=color:#a6e22e>draw</span><span style=color:#f92672>(</span>canvas<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>主要是调用了父类的 draw 方法，FrameLayout 和 ViewGroup 都没有重写 draw() 方法，所以直接看 View 的 draw() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>draw</span><span style=color:#f92672>(</span>Canvas canvas<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> privateFlags <span style=color:#f92672>=</span> mPrivateFlags<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> dirtyOpaque <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>privateFlags <span style=color:#f92672>&amp;</span> PFLAG_DIRTY_MASK<span style=color:#f92672>)</span> <span style=color:#f92672>==</span> PFLAG_DIRTY_OPAQUE <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>(</span>mAttachInfo <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>mAttachInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>mIgnoreDirtyState</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    mPrivateFlags <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>privateFlags <span style=color:#f92672>&amp;</span> <span style=color:#f92672>~</span>PFLAG_DIRTY_MASK<span style=color:#f92672>)</span> <span style=color:#f92672>|</span> PFLAG_DRAWN<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Draw traversal performs several drawing steps which must be executed
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * in the appropriate order:
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *      1. Draw the background
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *      2. If necessary, save the canvas&#39; layers to prepare for fading
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *      3. Draw view&#39;s content
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *      4. Draw children
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *      5. If necessary, draw the fading edges and restore layers
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *      6. Draw decorations (scrollbars for instance)
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Step 1, draw the background, if needed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> saveCount<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>dirtyOpaque<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        drawBackground<span style=color:#f92672>(</span>canvas<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// skip step 2 &amp; 5 if possible (common case)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> viewFlags <span style=color:#f92672>=</span> mViewFlags<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> horizontalEdges <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>viewFlags <span style=color:#f92672>&amp;</span> FADING_EDGE_HORIZONTAL<span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> verticalEdges <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>viewFlags <span style=color:#f92672>&amp;</span> FADING_EDGE_VERTICAL<span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>verticalEdges <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>horizontalEdges<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Step 3, draw the content
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>dirtyOpaque<span style=color:#f92672>)</span> onDraw<span style=color:#f92672>(</span>canvas<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Step 4, draw the children
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        dispatchDraw<span style=color:#f92672>(</span>canvas<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Overlay is part of the content and draws beneath Foreground
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mOverlay <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>mOverlay<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            mOverlay<span style=color:#f92672>.</span><span style=color:#a6e22e>getOverlayView</span><span style=color:#f92672>().</span><span style=color:#a6e22e>dispatchDraw</span><span style=color:#f92672>(</span>canvas<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Step 6, draw decorations (foreground, scrollbars)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        onDrawForeground<span style=color:#f92672>(</span>canvas<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// we&#39;re done...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Here we do the full fledged routine...
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * (this is an uncommon case where speed matters less,
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * this is why we repeat some of the tests that have been
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * done above)
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> drawTop <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> drawBottom <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> drawLeft <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> drawRight <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>float</span> topFadeStrength <span style=color:#f92672>=</span> 0<span style=color:#f92672>.</span><span style=color:#a6e22e>0f</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>float</span> bottomFadeStrength <span style=color:#f92672>=</span> 0<span style=color:#f92672>.</span><span style=color:#a6e22e>0f</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>float</span> leftFadeStrength <span style=color:#f92672>=</span> 0<span style=color:#f92672>.</span><span style=color:#a6e22e>0f</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>float</span> rightFadeStrength <span style=color:#f92672>=</span> 0<span style=color:#f92672>.</span><span style=color:#a6e22e>0f</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Step 2, save the canvas&#39; layers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> paddingLeft <span style=color:#f92672>=</span> mPaddingLeft<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> offsetRequired <span style=color:#f92672>=</span> isPaddingOffsetRequired<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>offsetRequired<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        paddingLeft <span style=color:#f92672>+=</span> getLeftPaddingOffset<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> left <span style=color:#f92672>=</span> mScrollX <span style=color:#f92672>+</span> paddingLeft<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> right <span style=color:#f92672>=</span> left <span style=color:#f92672>+</span> mRight <span style=color:#f92672>-</span> mLeft <span style=color:#f92672>-</span> mPaddingRight <span style=color:#f92672>-</span> paddingLeft<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> top <span style=color:#f92672>=</span> mScrollY <span style=color:#f92672>+</span> getFadeTop<span style=color:#f92672>(</span>offsetRequired<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> bottom <span style=color:#f92672>=</span> top <span style=color:#f92672>+</span> getFadeHeight<span style=color:#f92672>(</span>offsetRequired<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>offsetRequired<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        right <span style=color:#f92672>+=</span> getRightPaddingOffset<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        bottom <span style=color:#f92672>+=</span> getBottomPaddingOffset<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> ScrollabilityCache scrollabilityCache <span style=color:#f92672>=</span> mScrollCache<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>float</span> fadeHeight <span style=color:#f92672>=</span> scrollabilityCache<span style=color:#f92672>.</span><span style=color:#a6e22e>fadingEdgeLength</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> length <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span><span style=color:#f92672>)</span> fadeHeight<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// clip the fade length if top and bottom fades overlap
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// overlapping fades produce odd-looking artifacts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>verticalEdges <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>(</span>top <span style=color:#f92672>+</span> length <span style=color:#f92672>&gt;</span> bottom <span style=color:#f92672>-</span> length<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        length <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>bottom <span style=color:#f92672>-</span> top<span style=color:#f92672>)</span> <span style=color:#f92672>/</span> 2<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// also clip horizontal fades if necessary
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>horizontalEdges <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>(</span>left <span style=color:#f92672>+</span> length <span style=color:#f92672>&gt;</span> right <span style=color:#f92672>-</span> length<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        length <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>right <span style=color:#f92672>-</span> left<span style=color:#f92672>)</span> <span style=color:#f92672>/</span> 2<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>verticalEdges<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        topFadeStrength <span style=color:#f92672>=</span> Math<span style=color:#f92672>.</span><span style=color:#a6e22e>max</span><span style=color:#f92672>(</span>0<span style=color:#f92672>.</span><span style=color:#a6e22e>0f</span><span style=color:#f92672>,</span> Math<span style=color:#f92672>.</span><span style=color:#a6e22e>min</span><span style=color:#f92672>(</span>1<span style=color:#f92672>.</span><span style=color:#a6e22e>0f</span><span style=color:#f92672>,</span> getTopFadingEdgeStrength<span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>        drawTop <span style=color:#f92672>=</span> topFadeStrength <span style=color:#f92672>*</span> fadeHeight <span style=color:#f92672>&gt;</span> 1<span style=color:#f92672>.</span><span style=color:#a6e22e>0f</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        bottomFadeStrength <span style=color:#f92672>=</span> Math<span style=color:#f92672>.</span><span style=color:#a6e22e>max</span><span style=color:#f92672>(</span>0<span style=color:#f92672>.</span><span style=color:#a6e22e>0f</span><span style=color:#f92672>,</span> Math<span style=color:#f92672>.</span><span style=color:#a6e22e>min</span><span style=color:#f92672>(</span>1<span style=color:#f92672>.</span><span style=color:#a6e22e>0f</span><span style=color:#f92672>,</span> getBottomFadingEdgeStrength<span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>        drawBottom <span style=color:#f92672>=</span> bottomFadeStrength <span style=color:#f92672>*</span> fadeHeight <span style=color:#f92672>&gt;</span> 1<span style=color:#f92672>.</span><span style=color:#a6e22e>0f</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>horizontalEdges<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        leftFadeStrength <span style=color:#f92672>=</span> Math<span style=color:#f92672>.</span><span style=color:#a6e22e>max</span><span style=color:#f92672>(</span>0<span style=color:#f92672>.</span><span style=color:#a6e22e>0f</span><span style=color:#f92672>,</span> Math<span style=color:#f92672>.</span><span style=color:#a6e22e>min</span><span style=color:#f92672>(</span>1<span style=color:#f92672>.</span><span style=color:#a6e22e>0f</span><span style=color:#f92672>,</span> getLeftFadingEdgeStrength<span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>        drawLeft <span style=color:#f92672>=</span> leftFadeStrength <span style=color:#f92672>*</span> fadeHeight <span style=color:#f92672>&gt;</span> 1<span style=color:#f92672>.</span><span style=color:#a6e22e>0f</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        rightFadeStrength <span style=color:#f92672>=</span> Math<span style=color:#f92672>.</span><span style=color:#a6e22e>max</span><span style=color:#f92672>(</span>0<span style=color:#f92672>.</span><span style=color:#a6e22e>0f</span><span style=color:#f92672>,</span> Math<span style=color:#f92672>.</span><span style=color:#a6e22e>min</span><span style=color:#f92672>(</span>1<span style=color:#f92672>.</span><span style=color:#a6e22e>0f</span><span style=color:#f92672>,</span> getRightFadingEdgeStrength<span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>        drawRight <span style=color:#f92672>=</span> rightFadeStrength <span style=color:#f92672>*</span> fadeHeight <span style=color:#f92672>&gt;</span> 1<span style=color:#f92672>.</span><span style=color:#a6e22e>0f</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    saveCount <span style=color:#f92672>=</span> canvas<span style=color:#f92672>.</span><span style=color:#a6e22e>getSaveCount</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> solidColor <span style=color:#f92672>=</span> getSolidColor<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>solidColor <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> flags <span style=color:#f92672>=</span> Canvas<span style=color:#f92672>.</span><span style=color:#a6e22e>HAS_ALPHA_LAYER_SAVE_FLAG</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>drawTop<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            canvas<span style=color:#f92672>.</span><span style=color:#a6e22e>saveLayer</span><span style=color:#f92672>(</span>left<span style=color:#f92672>,</span> top<span style=color:#f92672>,</span> right<span style=color:#f92672>,</span> top <span style=color:#f92672>+</span> length<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> flags<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>drawBottom<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            canvas<span style=color:#f92672>.</span><span style=color:#a6e22e>saveLayer</span><span style=color:#f92672>(</span>left<span style=color:#f92672>,</span> bottom <span style=color:#f92672>-</span> length<span style=color:#f92672>,</span> right<span style=color:#f92672>,</span> bottom<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> flags<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>drawLeft<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            canvas<span style=color:#f92672>.</span><span style=color:#a6e22e>saveLayer</span><span style=color:#f92672>(</span>left<span style=color:#f92672>,</span> top<span style=color:#f92672>,</span> left <span style=color:#f92672>+</span> length<span style=color:#f92672>,</span> bottom<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> flags<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>drawRight<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            canvas<span style=color:#f92672>.</span><span style=color:#a6e22e>saveLayer</span><span style=color:#f92672>(</span>right <span style=color:#f92672>-</span> length<span style=color:#f92672>,</span> top<span style=color:#f92672>,</span> right<span style=color:#f92672>,</span> bottom<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> flags<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        scrollabilityCache<span style=color:#f92672>.</span><span style=color:#a6e22e>setFadeColor</span><span style=color:#f92672>(</span>solidColor<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Step 3, draw the content
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>dirtyOpaque<span style=color:#f92672>)</span> onDraw<span style=color:#f92672>(</span>canvas<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Step 4, draw the children
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    dispatchDraw<span style=color:#f92672>(</span>canvas<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Step 5, draw the fade effect and restore layers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>final</span> Paint p <span style=color:#f92672>=</span> scrollabilityCache<span style=color:#f92672>.</span><span style=color:#a6e22e>paint</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> Matrix matrix <span style=color:#f92672>=</span> scrollabilityCache<span style=color:#f92672>.</span><span style=color:#a6e22e>matrix</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> Shader fade <span style=color:#f92672>=</span> scrollabilityCache<span style=color:#f92672>.</span><span style=color:#a6e22e>shader</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>drawTop<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        matrix<span style=color:#f92672>.</span><span style=color:#a6e22e>setScale</span><span style=color:#f92672>(</span>1<span style=color:#f92672>,</span> fadeHeight <span style=color:#f92672>*</span> topFadeStrength<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        matrix<span style=color:#f92672>.</span><span style=color:#a6e22e>postTranslate</span><span style=color:#f92672>(</span>left<span style=color:#f92672>,</span> top<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        fade<span style=color:#f92672>.</span><span style=color:#a6e22e>setLocalMatrix</span><span style=color:#f92672>(</span>matrix<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        p<span style=color:#f92672>.</span><span style=color:#a6e22e>setShader</span><span style=color:#f92672>(</span>fade<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        canvas<span style=color:#f92672>.</span><span style=color:#a6e22e>drawRect</span><span style=color:#f92672>(</span>left<span style=color:#f92672>,</span> top<span style=color:#f92672>,</span> right<span style=color:#f92672>,</span> top <span style=color:#f92672>+</span> length<span style=color:#f92672>,</span> p<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>drawBottom<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        matrix<span style=color:#f92672>.</span><span style=color:#a6e22e>setScale</span><span style=color:#f92672>(</span>1<span style=color:#f92672>,</span> fadeHeight <span style=color:#f92672>*</span> bottomFadeStrength<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        matrix<span style=color:#f92672>.</span><span style=color:#a6e22e>postRotate</span><span style=color:#f92672>(</span>180<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        matrix<span style=color:#f92672>.</span><span style=color:#a6e22e>postTranslate</span><span style=color:#f92672>(</span>left<span style=color:#f92672>,</span> bottom<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        fade<span style=color:#f92672>.</span><span style=color:#a6e22e>setLocalMatrix</span><span style=color:#f92672>(</span>matrix<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        p<span style=color:#f92672>.</span><span style=color:#a6e22e>setShader</span><span style=color:#f92672>(</span>fade<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        canvas<span style=color:#f92672>.</span><span style=color:#a6e22e>drawRect</span><span style=color:#f92672>(</span>left<span style=color:#f92672>,</span> bottom <span style=color:#f92672>-</span> length<span style=color:#f92672>,</span> right<span style=color:#f92672>,</span> bottom<span style=color:#f92672>,</span> p<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>drawLeft<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        matrix<span style=color:#f92672>.</span><span style=color:#a6e22e>setScale</span><span style=color:#f92672>(</span>1<span style=color:#f92672>,</span> fadeHeight <span style=color:#f92672>*</span> leftFadeStrength<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        matrix<span style=color:#f92672>.</span><span style=color:#a6e22e>postRotate</span><span style=color:#f92672>(-</span>90<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        matrix<span style=color:#f92672>.</span><span style=color:#a6e22e>postTranslate</span><span style=color:#f92672>(</span>left<span style=color:#f92672>,</span> top<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        fade<span style=color:#f92672>.</span><span style=color:#a6e22e>setLocalMatrix</span><span style=color:#f92672>(</span>matrix<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        p<span style=color:#f92672>.</span><span style=color:#a6e22e>setShader</span><span style=color:#f92672>(</span>fade<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        canvas<span style=color:#f92672>.</span><span style=color:#a6e22e>drawRect</span><span style=color:#f92672>(</span>left<span style=color:#f92672>,</span> top<span style=color:#f92672>,</span> left <span style=color:#f92672>+</span> length<span style=color:#f92672>,</span> bottom<span style=color:#f92672>,</span> p<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>drawRight<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        matrix<span style=color:#f92672>.</span><span style=color:#a6e22e>setScale</span><span style=color:#f92672>(</span>1<span style=color:#f92672>,</span> fadeHeight <span style=color:#f92672>*</span> rightFadeStrength<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        matrix<span style=color:#f92672>.</span><span style=color:#a6e22e>postRotate</span><span style=color:#f92672>(</span>90<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        matrix<span style=color:#f92672>.</span><span style=color:#a6e22e>postTranslate</span><span style=color:#f92672>(</span>right<span style=color:#f92672>,</span> top<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        fade<span style=color:#f92672>.</span><span style=color:#a6e22e>setLocalMatrix</span><span style=color:#f92672>(</span>matrix<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        p<span style=color:#f92672>.</span><span style=color:#a6e22e>setShader</span><span style=color:#f92672>(</span>fade<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        canvas<span style=color:#f92672>.</span><span style=color:#a6e22e>drawRect</span><span style=color:#f92672>(</span>right <span style=color:#f92672>-</span> length<span style=color:#f92672>,</span> top<span style=color:#f92672>,</span> right<span style=color:#f92672>,</span> bottom<span style=color:#f92672>,</span> p<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    canvas<span style=color:#f92672>.</span><span style=color:#a6e22e>restoreToCount</span><span style=color:#f92672>(</span>saveCount<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Overlay is part of the content and draws beneath Foreground
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mOverlay <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>mOverlay<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        mOverlay<span style=color:#f92672>.</span><span style=color:#a6e22e>getOverlayView</span><span style=color:#f92672>().</span><span style=color:#a6e22e>dispatchDraw</span><span style=color:#f92672>(</span>canvas<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Step 6, draw decorations (foreground, scrollbars)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    onDrawForeground<span style=color:#f92672>(</span>canvas<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>从代码注释中可以看到，draw() 过程分为六个步骤，分别是：</p><ol><li>绘制 View 的背景；</li><li>保存当前 canvas 的图层；</li><li>绘制 View 的内容；</li><li>如果有子元素，则调用子元素的 draw() 方法；</li><li>绘制淡入淡出效果并恢复图层；</li><li>绘制 View 的装饰（滚动条等）。</li></ol><p>其中第二步和第五步一般情况下不会用到，我们继续看第三步，看看它是如何分配子元素的绘制的：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>dispatchDraw</span><span style=color:#f92672>(</span>Canvas canvas<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>显然，单一的 View 并没有子元素，因此，看看 ViewGroup 是怎么实现这个过程的：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>dispatchDraw</span><span style=color:#f92672>(</span>Canvas canvas<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> childrenCount<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>transientIndex <span style=color:#f92672>&gt;=</span> 0 <span style=color:#f92672>&amp;&amp;</span> mTransientIndices<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>transientIndex<span style=color:#f92672>)</span> <span style=color:#f92672>==</span> i<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>final</span> View transientChild <span style=color:#f92672>=</span> mTransientViews<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>transientIndex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>transientChild<span style=color:#f92672>.</span><span style=color:#a6e22e>mViewFlags</span> <span style=color:#f92672>&amp;</span> VISIBILITY_MASK<span style=color:#f92672>)</span> <span style=color:#f92672>==</span> VISIBLE <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>                    transientChild<span style=color:#f92672>.</span><span style=color:#a6e22e>getAnimation</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                more <span style=color:#f92672>|=</span> drawChild<span style=color:#f92672>(</span>canvas<span style=color:#f92672>,</span> transientChild<span style=color:#f92672>,</span> drawingTime<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>drawChild</span><span style=color:#f92672>(</span>Canvas canvas<span style=color:#f92672>,</span> View child<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> drawingTime<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>draw</span><span style=color:#f92672>(</span>canvas<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> drawingTime<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>在 ViewGroup 的 dispatchDraw() 中，遍历每个子元素并调用了它们的 draw() 方法，由此实现了层层递归调用，最终完成绘制。</p><h2 id=小结-4>小结
<a class=anchor href=#%e5%b0%8f%e7%bb%93-4>#</a></h2><p>纵观整个 Measure、Layout 和 Draw 过程，使用流程图表示如下：</p><p><img src=https://my-bucket-1251125515.cos.ap-guangzhou.myqcloud.com/View-Draw/clipboard_20230323_045712.png width=auto alt></p><h1 id=八显示-view>八：显示 View
<a class=anchor href=#%e5%85%ab%e6%98%be%e7%a4%ba-view>#</a></h1><p>不知道你还记不记得，上一步骤中执行的 View 的 Measure、Layout 和 Draw 流程都是前面 handleResumeActivity() 中的 wm.addView() 方法为源头的，回顾 handleResumeActivity() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handleResumeActivity</span><span style=color:#f92672>(</span>IBinder token<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>boolean</span> clearHide<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> isForward<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> reallyResume<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> seq<span style=color:#f92672>,</span> String reason<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    ActivityClientRecord r <span style=color:#f92672>=</span> mActivities<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>token<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 最终会调用 onStart() 和 onResume() 等方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    r <span style=color:#f92672>=</span> performResumeActivity<span style=color:#f92672>(</span>token<span style=color:#f92672>,</span> clearHide<span style=color:#f92672>,</span> reason<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>r <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> Activity a <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>activity</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>r<span style=color:#f92672>.</span><span style=color:#a6e22e>window</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>a<span style=color:#f92672>.</span><span style=color:#a6e22e>mFinished</span> <span style=color:#f92672>&amp;&amp;</span> willBeVisible<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            r<span style=color:#f92672>.</span><span style=color:#a6e22e>window</span> <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>activity</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getWindow</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 获取 DecorView 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            View decor <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>window</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getDecorView</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 将 DecorView 设置成不可见
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            decor<span style=color:#f92672>.</span><span style=color:#a6e22e>setVisibility</span><span style=color:#f92672>(</span>View<span style=color:#f92672>.</span><span style=color:#a6e22e>INVISIBLE</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 获取 ViewManager，这里是 WindowManagerImpl 实例
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            ViewManager wm <span style=color:#f92672>=</span> a<span style=color:#f92672>.</span><span style=color:#a6e22e>getWindowManager</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            WindowManager<span style=color:#f92672>.</span><span style=color:#a6e22e>LayoutParams</span> l <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>window</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getAttributes</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            a<span style=color:#f92672>.</span><span style=color:#a6e22e>mDecor</span> <span style=color:#f92672>=</span> decor<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            l<span style=color:#f92672>.</span><span style=color:#a6e22e>type</span> <span style=color:#f92672>=</span> WindowManager<span style=color:#f92672>.</span><span style=color:#a6e22e>LayoutParams</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TYPE_BASE_APPLICATION</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            l<span style=color:#f92672>.</span><span style=color:#a6e22e>softInputMode</span> <span style=color:#f92672>|=</span> forwardBit<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>a<span style=color:#f92672>.</span><span style=color:#a6e22e>mVisibleFromClient</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>a<span style=color:#f92672>.</span><span style=color:#a6e22e>mWindowAdded</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 标记设置为 true
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                a<span style=color:#f92672>.</span><span style=color:#a6e22e>mWindowAdded</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 调用 WindowManagerImpl 的 addView 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                wm<span style=color:#f92672>.</span><span style=color:#a6e22e>addView</span><span style=color:#f92672>(</span>decor<span style=color:#f92672>,</span> l<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> 
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>willBeVisible<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>r<span style=color:#f92672>.</span><span style=color:#a6e22e>activity</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mFinished</span> <span style=color:#f92672>&amp;&amp;</span> willBeVisible
</span></span><span style=display:flex><span>                <span style=color:#f92672>&amp;&amp;</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>activity</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mDecor</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>r<span style=color:#f92672>.</span><span style=color:#a6e22e>hideForNow</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>r<span style=color:#f92672>.</span><span style=color:#a6e22e>activity</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mVisibleFromClient</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 调用 makeVisible 方法将 DecorView 设置为可见
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                r<span style=color:#f92672>.</span><span style=color:#a6e22e>activity</span><span style=color:#f92672>.</span><span style=color:#a6e22e>makeVisible</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 在此过程出现异常，则直接杀死 Activity
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            ActivityManagerNative<span style=color:#f92672>.</span><span style=color:#a6e22e>getDefault</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>finishActivity</span><span style=color:#f92672>(</span>token<span style=color:#f92672>,</span> Activity<span style=color:#f92672>.</span><span style=color:#a6e22e>RESULT_CANCELED</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                        Activity<span style=color:#f92672>.</span><span style=color:#a6e22e>DONT_FINISH_TASK_WITH_ACTIVITY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>RemoteException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> ex<span style=color:#f92672>.</span><span style=color:#a6e22e>rethrowFromSystemServer</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到在调用 wm.addView() 方法之前，DecorView 是处于不可见的状态的，因此，即使经过了 Measure、Layout 和 Draw 流程，我们的 View 仍然没有显示在屏幕上，看看 Activity 的 makeVisible() 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>makeVisible</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>mWindowAdded<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        ViewManager wm <span style=color:#f92672>=</span> getWindowManager<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        wm<span style=color:#f92672>.</span><span style=color:#a6e22e>addView</span><span style=color:#f92672>(</span>mDecor<span style=color:#f92672>,</span> getWindow<span style=color:#f92672>().</span><span style=color:#a6e22e>getAttributes</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        mWindowAdded <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    mDecor<span style=color:#f92672>.</span><span style=color:#a6e22e>setVisibility</span><span style=color:#f92672>(</span>View<span style=color:#f92672>.</span><span style=color:#a6e22e>VISIBLE</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>执行 DecorView 的 setVisibility() 之后，我们的 View 才正式出现在屏幕上！</p><h1 id=总结>总结
<a class=anchor href=#%e6%80%bb%e7%bb%93>#</a></h1><ul><li>Window 是一个抽象类，提供了各种窗口操作的方法；</li><li>PhoneWindow 是 Window 的唯一实现类，每个 Acitvity 中都会有一个 PhoneWindw 实例；</li><li>DecorView —— 顶级视图，它继承自 FrameLayout，setContentView() 时，PhoneWindow 会创建 DecorView 并与 DecorView 建立关联；</li><li>PhoneWindow 会根据 Theme 和 Feature 等将对应的布局文件将布局解析并添加到 DecorView 中，这些布局中都包含了一个 id 为 content 的 FrameLayout；</li><li>setContentView() 方法中设置的 layout 布局文件会被 PhoneWindow 解析并压入 DecorView 中 id 为 content 的 FrameLayout 中；</li><li>View 的正式绘制是从 ViewRootImpl 的 performTraversals() 方法开始的；</li><li>单一 View 一般需要重写 onMeasure() 方法根据布局参数和父 View 的测量规格计算自己的宽高并保存；</li><li>ViewGroup 需要重写 onMeasure() 方法计算所有子元素的尺寸然后计算自己的尺寸并保存；</li><li>单一 View 一般不需要重写 onLayout() 方法；</li><li>ViewGroup 需要重写 onLayot() 方法根据测量的值确定所有子元素的位置；</li><li>单一 View 需要重写 onDraw() 方法绘制自身；</li><li>ViewGroup 需要重写 onDraw() 方法绘制自身以及遍历子元素对它们进行绘制。</li><li>在 Activity 的 onResume() 生命周期被调用后，ActivityThread 才会调用 activity.makeVisible() 让 DecorView 可见。</li></ul><p><strong>系列文章</strong></p><p><a href=https://guanpj.cn/2017/09/17/Android-System-Startup-Flow-Analyze/ rel=noopener>按下电源键后竟然发生了这一幕 —— Android 系统启动流程分析</a></p><p><a href=https://guanpj.cn/2017/10/23/Android-App-Startup-Flow-Analyze/ rel=noopener>App 竟然是这样跑起来的 —— Android App/Activity 启动流程分析</a></p><p><a href=https://guanpj.cn/2017/11/09/Android-View-Workflow/ rel=noopener>屏幕上内容究竟是怎样画出来的 —— Android View 工作原理详解</a>（本文）</p><p><strong>参考文章</strong></p><p><a href=https://blog.csdn.net/yanbober/article/details/46128379 rel=noopener>Android 应用层 View 绘制流程与源码分析</a></p><p><a href=https://www.jianshu.com/p/158736a2549d rel=noopener>（3）自定义 View Layout 过程 - 最易懂的自定义 View 原理系列</a></p><blockquote><p>如果你对文章内容有疑问或者有不同的意见，欢迎留言，我们一同探讨。</p></blockquote><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://guanpj.github.io/amethyst/quartz/js/graph.cbd78cfa87df7d3e230d16fc24f06548.js></script></div></div><div id=contact_buttons><footer><p>Made with <a href=https://github.com/64bitpandas/amethyst>Amethyst</a>, © 2023 guanpj</p><ul><li><a href=https://guanpj.github.io/amethyst/>Home</a></li><li><a href=https://bencuan.me>Website</a></li><li><a href=https://blog.bencuan.me>Blog</a></li></ul></footer></div></article><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#一初始化-phonewindow-和-windowmanager>一：初始化 PhoneWindow 和 WindowManager</a></li><li><a href=#二初始化-decorview>二：初始化 DecorView</a><ul><li><a href=#源码分析>源码分析</a></li><li><a href=#小结>小结</a></li></ul></li><li><a href=#三初始化-viewrootimpl-并关联-decorview>三：初始化 ViewRootImpl 并关联 DecorView</a><ul><li><a href=#源码分析-1>源码分析</a></li><li><a href=#小结-1>小结</a></li></ul></li><li><a href=#四建立-phonewindow-和-windowmanagerservice-之间的连接>四：建立 PhoneWindow 和 WindowManagerService 之间的连接</a><ul><li><a href=#源码分析-2>源码分析</a></li><li><a href=#小结-2>小结</a></li></ul></li><li><a href=#五建立与-surfaceflinger-的连接>五：建立与 SurfaceFlinger 的连接</a><ul><li><a href=#源码分析-3>源码分析</a></li><li><a href=#小结-3>小结</a></li></ul></li><li><a href=#六申请-surface>六：申请 Surface</a></li><li><a href=#七正式绘制-view>七：正式绘制 View</a><ul><li><a href=#理解-measurespec>理解 MeasureSpec</a></li><li><a href=#measure-流程分析>Measure 流程分析</a></li><li><a href=#layout-流程分析>Layout 流程分析</a></li><li><a href=#draw-流程分析>Draw 流程分析</a></li><li><a href=#小结-4>小结</a></li></ul></li><li><a href=#八显示-view>八：显示 View</a></li><li><a href=#总结>总结</a></li></ul></nav></div></aside></main></body></html>